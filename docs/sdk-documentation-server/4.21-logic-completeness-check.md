# 4.21 é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥

## 4.21.1 ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§

### 4.21.1.1 ä¸šåŠ¡æµç¨‹å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. éªŒè¯ä¸šåŠ¡æµç¨‹çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
b. ç¡®ä¿æ‰€æœ‰ä¸šåŠ¡åœºæ™¯éƒ½è¢«æ­£ç¡®å¤„ç†
c. æ£€æŸ¥ä¸šåŠ¡è§„åˆ™çš„ä¸€è‡´æ€§å®ç°

**2. æ£€æµ‹æ–¹æ³•**

1. ä¸šåŠ¡æµç¨‹å›¾å¯¹ç…§æ£€æŸ¥
2. çŠ¶æ€æœºéªŒè¯
3. ä¸šåŠ¡è§„åˆ™æµ‹è¯•
4. ç«¯åˆ°ç«¯æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ä¸šåŠ¡æµç¨‹ä¸å®Œæ•´ï¼Œç¼ºå°‘å…³é”®æ­¥éª¤
public class OrderProcessService {
    
    public void processOrder(Long orderId) {
        Order order = orderRepository.findById(orderId).orElse(null);
        
        // ç›´æ¥å¤„ç†è®¢å•ï¼Œç¼ºå°‘çŠ¶æ€æ£€æŸ¥
        order.setStatus(OrderStatus.PROCESSING);
        orderRepository.save(order);
        
        // ç¼ºå°‘ï¼šè®¢å•çŠ¶æ€éªŒè¯
        // ç¼ºå°‘ï¼šåº“å­˜å†æ¬¡ç¡®è®¤
        // ç¼ºå°‘ï¼šæ”¯ä»˜çŠ¶æ€æ£€æŸ¥
        // ç¼ºå°‘ï¼šä¸šåŠ¡è§„åˆ™éªŒè¯
        // ç¼ºå°‘ï¼šå¼‚å¸¸æƒ…å†µå¤„ç†
    }
    
    public void completeOrder(Long orderId) {
        Order order = orderRepository.findById(orderId).orElse(null);
        order.setStatus(OrderStatus.COMPLETED);
        orderRepository.save(order);
        
        // ç¼ºå°‘å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
        // ç¼ºå°‘ï¼šå‘è´§ç¡®è®¤
        // ç¼ºå°‘ï¼šç”¨æˆ·é€šçŸ¥
        // ç¼ºå°‘ï¼šç§¯åˆ†å¥–åŠ±
        // ç¼ºå°‘ï¼šæ•°æ®ç»Ÿè®¡æ›´æ–°
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ä¸šåŠ¡æµç¨‹å¤„ç†
public class OrderProcessService {
    
    /**
     * å¤„ç†è®¢å• - å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
     */
    @Transactional
    public void processOrder(Long orderId) {
        // 1. è·å–å¹¶éªŒè¯è®¢å•
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
            
        // 2. éªŒè¯è®¢å•çŠ¶æ€
        validateOrderCanBeProcessed(order);
        
        // 3. éªŒè¯æ”¯ä»˜çŠ¶æ€
        PaymentStatus paymentStatus = paymentService.getPaymentStatus(order.getPaymentId());
        if (paymentStatus != PaymentStatus.PAID) {
            throw new OrderProcessException("è®¢å•æœªæ”¯ä»˜ï¼Œæ— æ³•å¤„ç†");
        }
        
        // 4. å†æ¬¡ç¡®è®¤åº“å­˜
        boolean stockAvailable = inventoryService.confirmStock(order.getItems());
        if (!stockAvailable) {
            handleStockShortage(order);
            return;
        }
        
        // 5. åº”ç”¨ä¸šåŠ¡è§„åˆ™
        applyBusinessRules(order);
        
        // 6. æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.PROCESSING);
        order.setProcessedAt(Instant.now());
        orderRepository.save(order);
        
        // 7. æ‰£å‡åº“å­˜
        inventoryService.deductStock(order.getItems());
        
        // 8. å‘å¸ƒè®¢å•å¤„ç†äº‹ä»¶
        eventPublisher.publishEvent(new OrderProcessedEvent(orderId));
        
        // 9. è®°å½•æ“ä½œæ—¥å¿—
        auditService.logOrderOperation(orderId, "ORDER_PROCESSED", getCurrentUser());
    }
    
    /**
     * å®Œæˆè®¢å• - åŒ…å«æ‰€æœ‰å¿…è¦çš„ä¸šåŠ¡æ­¥éª¤
     */
    @Transactional
    public void completeOrder(Long orderId, String trackingNumber) {
        // 1. éªŒè¯è®¢å•çŠ¶æ€
        Order order = getOrderAndValidateStatus(orderId, OrderStatus.SHIPPED);
        
        // 2. éªŒè¯å‘è´§ä¿¡æ¯
        validateShippingInfo(order, trackingNumber);
        
        // 3. æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.COMPLETED);
        order.setCompletedAt(Instant.now());
        order.setTrackingNumber(trackingNumber);
        
        // 4. å¤„ç†ç”¨æˆ·ç§¯åˆ†å¥–åŠ±
        rewardService.processOrderReward(order.getUserId(), order.getTotalAmount());
        
        // 5. æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
        userStatisticsService.updateOrderStatistics(order.getUserId());
        
        // 6. å‘é€å®Œæˆé€šçŸ¥
        notificationService.sendOrderCompletionNotification(order);
        
        // 7. æ›´æ–°å•†å“é”€é‡ç»Ÿè®¡
        productStatisticsService.updateSalesStatistics(order.getItems());
        
        // 8. ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // 9. å‘å¸ƒè®¢å•å®Œæˆäº‹ä»¶
        eventPublisher.publishEvent(new OrderCompletedEvent(orderId));
    }
    
    private void validateOrderCanBeProcessed(Order order) {
        if (order.getStatus() != OrderStatus.PENDING_PAYMENT && 
            order.getStatus() != OrderStatus.PAID) {
            throw new OrderProcessException(
                String.format("è®¢å•çŠ¶æ€ä¸å…è®¸å¤„ç†: %s", order.getStatus()));
        }
    }
    
    private void applyBusinessRules(Order order) {
        // VIPç”¨æˆ·ä¼˜å…ˆå¤„ç†
        if (userService.isVipUser(order.getUserId())) {
            order.setPriority(OrderPriority.HIGH);
        }
        
        // å¤§é¢è®¢å•éœ€è¦é¢å¤–å®¡æ ¸
        if (order.getTotalAmount().compareTo(new BigDecimal("10000")) > 0) {
            order.setRequiresApproval(true);
        }
    }
}
```

### 4.21.1.2 è¾¹ç•Œæ¡ä»¶å¤„ç†æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿æ‰€æœ‰è¾“å…¥å‚æ•°çš„è¾¹ç•Œå€¼éƒ½è¢«æ­£ç¡®å¤„ç†
b. éªŒè¯æ•°ç»„ã€é›†åˆç­‰æ•°æ®ç»“æ„çš„è¾¹ç•Œè®¿é—®å®‰å…¨
c. æ£€æŸ¥æ•°å€¼è®¡ç®—ä¸­çš„è¾¹ç•Œæƒ…å†µå¤„ç†
d. ç¡®ä¿æ—¶é—´ã€æ—¥æœŸç­‰ç‰¹æ®Šç±»å‹çš„è¾¹ç•Œå¤„ç†

**2. æ£€æµ‹æ–¹æ³•**

1. è¾¹ç•Œå€¼æµ‹è¯•ï¼ˆBoundary Value Testingï¼‰
2. ç­‰ä»·ç±»åˆ’åˆ†æµ‹è¯•
3. é™æ€ä»£ç åˆ†æå·¥å…·æ£€æµ‹
4. å•å…ƒæµ‹è¯•è¦†ç›–è¾¹ç•Œæ¡ä»¶

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ç¼ºå°‘è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
public class UserService {
    
    public User getUserById(Long userId) {
        // æ²¡æœ‰æ£€æŸ¥nullå€¼
        return userRepository.findById(userId).get();
    }
    
    public List<User> getUsersByPage(int page, int size) {
        // æ²¡æœ‰æ£€æŸ¥è´Ÿæ•°å’Œé›¶å€¼
        int offset = page * size;
        return userRepository.findUsers(offset, size);
    }
    
    public String getFirstName(String fullName) {
        // æ²¡æœ‰æ£€æŸ¥ç©ºå­—ç¬¦ä¸²å’Œnull
        return fullName.split(" ")[0];
    }
    
    public BigDecimal calculateDiscount(BigDecimal amount, double rate) {
        // æ²¡æœ‰æ£€æŸ¥rateçš„èŒƒå›´ï¼ˆå¯èƒ½è¶…è¿‡100%æˆ–ä¸ºè´Ÿæ•°ï¼‰
        return amount.multiply(BigDecimal.valueOf(rate));
    }
    
    public int[] getTopScores(int[] scores, int count) {
        // æ²¡æœ‰æ£€æŸ¥æ•°ç»„é•¿åº¦å’Œcountçš„å…³ç³»
        Arrays.sort(scores);
        int[] result = new int[count];
        for (int i = 0; i < count; i++) {
            result[i] = scores[scores.length - 1 - i];
        }
        return result;
    }
    
    public LocalDate addWorkingDays(LocalDate startDate, int days) {
        // æ²¡æœ‰æ£€æŸ¥æ—¥æœŸè¾¹ç•Œå’Œå¤©æ•°èŒƒå›´
        LocalDate result = startDate;
        for (int i = 0; i < days; i++) {
            result = result.plusDays(1);
            if (result.getDayOfWeek() == DayOfWeek.SATURDAY) {
                result = result.plusDays(2);
            }
        }
        return result;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„è¾¹ç•Œæ¡ä»¶å¤„ç†
public class UserService {
    
    public User getUserById(Long userId) {
        // æ£€æŸ¥nullå€¼
        if (userId == null) {
            throw new IllegalArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // æ£€æŸ¥IDçš„æœ‰æ•ˆèŒƒå›´
        if (userId <= 0) {
            throw new IllegalArgumentException("ç”¨æˆ·IDå¿…é¡»å¤§äº0");
        }
        
        return userRepository.findById(userId)
            .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
    }
    
    public List<User> getUsersByPage(int page, int size) {
        // æ£€æŸ¥é¡µç è¾¹ç•Œ
        if (page < 0) {
            throw new IllegalArgumentException("é¡µç ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        // æ£€æŸ¥é¡µé¢å¤§å°è¾¹ç•Œ
        if (size <= 0) {
            throw new IllegalArgumentException("é¡µé¢å¤§å°å¿…é¡»å¤§äº0");
        }
        
        if (size > 1000) {
            throw new IllegalArgumentException("é¡µé¢å¤§å°ä¸èƒ½è¶…è¿‡1000");
        }
        
        // æ£€æŸ¥è®¡ç®—æº¢å‡º
        try {
            int offset = Math.multiplyExact(page, size);
            return userRepository.findUsers(offset, size);
        } catch (ArithmeticException e) {
            throw new IllegalArgumentException("é¡µç å’Œé¡µé¢å¤§å°çš„ä¹˜ç§¯è¿‡å¤§", e);
        }
    }
    
    public String getFirstName(String fullName) {
        // æ£€æŸ¥nullå’Œç©ºå­—ç¬¦ä¸²
        if (fullName == null || fullName.trim().isEmpty()) {
            throw new IllegalArgumentException("å§“åä¸èƒ½ä¸ºç©º");
        }
        
        String trimmedName = fullName.trim();
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç©ºæ ¼
        if (!trimmedName.contains(" ")) {
            return trimmedName; // åªæœ‰ä¸€ä¸ªåå­—
        }
        
        String[] parts = trimmedName.split("\\s+");
        return parts[0];
    }
    
    public BigDecimal calculateDiscount(BigDecimal amount, double rate) {
        // æ£€æŸ¥amountè¾¹ç•Œ
        if (amount == null) {
            throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºç©º");
        }
        
        if (amount.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        // æ£€æŸ¥rateè¾¹ç•Œ
        if (rate < 0) {
            throw new IllegalArgumentException("æŠ˜æ‰£ç‡ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        if (rate > 1.0) {
            throw new IllegalArgumentException("æŠ˜æ‰£ç‡ä¸èƒ½è¶…è¿‡100%");
        }
        
        // æ£€æŸ¥è®¡ç®—ç»“æœç²¾åº¦
        BigDecimal rateDecimal = BigDecimal.valueOf(rate);
        return amount.multiply(rateDecimal).setScale(2, RoundingMode.HALF_UP);
    }
    
    public int[] getTopScores(int[] scores, int count) {
        // æ£€æŸ¥æ•°ç»„è¾¹ç•Œ
        if (scores == null) {
            throw new IllegalArgumentException("åˆ†æ•°æ•°ç»„ä¸èƒ½ä¸ºç©º");
        }
        
        if (scores.length == 0) {
            return new int[0];
        }
        
        // æ£€æŸ¥countè¾¹ç•Œ
        if (count < 0) {
            throw new IllegalArgumentException("æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        if (count == 0) {
            return new int[0];
        }
        
        // è°ƒæ•´countä¸è¶…è¿‡æ•°ç»„é•¿åº¦
        int actualCount = Math.min(count, scores.length);
        
        // å¤åˆ¶æ•°ç»„é¿å…ä¿®æ”¹åŸæ•°ç»„
        int[] sortedScores = Arrays.copyOf(scores, scores.length);
        Arrays.sort(sortedScores);
        
        int[] result = new int[actualCount];
        for (int i = 0; i < actualCount; i++) {
            result[i] = sortedScores[sortedScores.length - 1 - i];
        }
        
        return result;
    }
    
    public LocalDate addWorkingDays(LocalDate startDate, int days) {
        // æ£€æŸ¥æ—¥æœŸè¾¹ç•Œ
        if (startDate == null) {
            throw new IllegalArgumentException("å¼€å§‹æ—¥æœŸä¸èƒ½ä¸ºç©º");
        }
        
        // æ£€æŸ¥å¤©æ•°è¾¹ç•Œ
        if (days < 0) {
            throw new IllegalArgumentException("å·¥ä½œæ—¥å¤©æ•°ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        if (days == 0) {
            return startDate;
        }
        
        // æ£€æŸ¥æ—¥æœŸè®¡ç®—è¾¹ç•Œï¼ˆé¿å…æº¢å‡ºï¼‰
        if (days > 10000) { // åˆç†çš„ä¸Šé™
            throw new IllegalArgumentException("å·¥ä½œæ—¥å¤©æ•°è¿‡å¤§");
        }
        
        LocalDate result = startDate;
        int addedDays = 0;
        
        while (addedDays < days) {
            result = result.plusDays(1);
            
            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦è¶…å‡ºåˆç†èŒƒå›´
            if (result.getYear() > 9999) {
                throw new IllegalArgumentException("è®¡ç®—ç»“æœæ—¥æœŸè¶…å‡ºèŒƒå›´");
            }
            
            // è·³è¿‡å‘¨æœ«
            if (result.getDayOfWeek() != DayOfWeek.SATURDAY && 
                result.getDayOfWeek() != DayOfWeek.SUNDAY) {
                addedDays++;
            }
        }
        
        return result;
    }
    
    /**
     * å®‰å…¨çš„å­—ç¬¦ä¸²æˆªå–ï¼Œå¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
     */
    public String safeSubstring(String str, int start, int end) {
        if (str == null) {
            return null;
        }
        
        if (str.isEmpty()) {
            return "";
        }
        
        int length = str.length();
        
        // è°ƒæ•´startè¾¹ç•Œ
        int safeStart = Math.max(0, Math.min(start, length));
        
        // è°ƒæ•´endè¾¹ç•Œ
        int safeEnd = Math.max(safeStart, Math.min(end, length));
        
        return str.substring(safeStart, safeEnd);
    }
    
    /**
     * å®‰å…¨çš„é™¤æ³•è¿ç®—ï¼Œå¤„ç†é™¤é›¶å’Œæº¢å‡º
     */
    public BigDecimal safeDivide(BigDecimal dividend, BigDecimal divisor, int scale) {
        if (dividend == null || divisor == null) {
            throw new IllegalArgumentException("è¢«é™¤æ•°å’Œé™¤æ•°éƒ½ä¸èƒ½ä¸ºç©º");
        }
        
        if (divisor.compareTo(BigDecimal.ZERO) == 0) {
            throw new ArithmeticException("é™¤æ•°ä¸èƒ½ä¸ºé›¶");
        }
        
        if (scale < 0) {
            throw new IllegalArgumentException("ç²¾åº¦ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        return dividend.divide(divisor, scale, RoundingMode.HALF_UP);
    }
}
```

### 4.21.1.3 å¹¶å‘å®‰å…¨ä¸šåŠ¡é€»è¾‘æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿å…±äº«èµ„æºçš„çº¿ç¨‹å®‰å…¨è®¿é—®
b. æ£€æµ‹å’Œé˜²æ­¢ä¸šåŠ¡é€»è¾‘ä¸­çš„ç«æ€æ¡ä»¶
c. éªŒè¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å¹¶å‘æ§åˆ¶
d. æ£€æŸ¥äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹ä¸šåŠ¡é€»è¾‘çš„å½±å“

**2. æ£€æµ‹æ–¹æ³•**

1. å¹¶å‘æµ‹è¯•å·¥å…·ï¼ˆJMeterã€Gatlingï¼‰
2. é™æ€ä»£ç åˆ†æï¼ˆFindBugsã€SpotBugsï¼‰
3. çº¿ç¨‹å®‰å…¨æ€§åˆ†æå·¥å…·
4. åˆ†å¸ƒå¼é”æµ‹è¯•
5. æ•°æ®åº“å¹¶å‘æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜
public class OrderService {
    
    private int orderCounter = 0; // éçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨
    private Map<String, Order> orderCache = new HashMap<>(); // éçº¿ç¨‹å®‰å…¨çš„ç¼“å­˜
    
    // âŒ ç«æ€æ¡ä»¶ï¼šæ£€æŸ¥å’Œæ›´æ–°ä¸æ˜¯åŸå­æ“ä½œ
    public boolean reserveInventory(String productId, int quantity) {
        Product product = productRepository.findById(productId);
        if (product.getStock() >= quantity) {
            // åœ¨è¿™é‡Œå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹
            product.setStock(product.getStock() - quantity);
            productRepository.save(product);
            return true;
        }
        return false;
    }
    
    // âŒ éçº¿ç¨‹å®‰å…¨çš„è®¢å•å·ç”Ÿæˆ
    public String generateOrderNumber() {
        orderCounter++; // å¯èƒ½å¯¼è‡´é‡å¤è®¢å•å·
        return "ORDER_" + orderCounter;
    }
    
    // âŒ ç¼“å­˜æ“ä½œéçº¿ç¨‹å®‰å…¨
    public Order getOrderFromCache(String orderId) {
        if (!orderCache.containsKey(orderId)) {
            Order order = orderRepository.findById(orderId);
            orderCache.put(orderId, order); // å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
        }
        return orderCache.get(orderId);
    }
    
    // âŒ åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼å®ç°é”™è¯¯
    private static OrderService instance;
    
    public static OrderService getInstance() {
        if (instance == null) {
            synchronized (OrderService.class) {
                if (instance == null) {
                    instance = new OrderService(); // å¯èƒ½å­˜åœ¨æŒ‡ä»¤é‡æ’åºé—®é¢˜
                }
            }
        }
        return instance;
    }
    
    // âŒ ä¸å®‰å…¨çš„ä½™é¢æ‰£å‡
    public boolean deductBalance(String userId, BigDecimal amount) {
        User user = userRepository.findById(userId);
        BigDecimal currentBalance = user.getBalance();
        
        if (currentBalance.compareTo(amount) >= 0) {
            // åœ¨è¿™é‡Œå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ä½™é¢
            user.setBalance(currentBalance.subtract(amount));
            userRepository.save(user);
            return true;
        }
        return false;
    }
    
    // âŒ æ‰¹é‡æ“ä½œä¸­çš„å¹¶å‘é—®é¢˜
    public void processBatchOrders(List<Order> orders) {
        for (Order order : orders) {
            // æ¯ä¸ªè®¢å•çš„å¤„ç†å¯èƒ½å½±å“å…¶ä»–è®¢å•
            if (reserveInventory(order.getProductId(), order.getQuantity())) {
                order.setStatus(OrderStatus.CONFIRMED);
                orderRepository.save(order);
            }
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šçº¿ç¨‹å®‰å…¨çš„ä¸šåŠ¡é€»è¾‘å®ç°
@Service
public class OrderService {
    
    private final AtomicLong orderCounter = new AtomicLong(0);
    private final ConcurrentHashMap<String, Order> orderCache = new ConcurrentHashMap<>();
    private final RedisTemplate<String, String> redisTemplate;
    
    @Autowired
    public OrderService(RedisTemplate<String, String> redisTemplate) {
        this.redisTemplate = redisTemplate;
    }
    
    // âœ… ä½¿ç”¨æ•°æ®åº“ä¹è§‚é”é˜²æ­¢ç«æ€æ¡ä»¶
    @Transactional
    public boolean reserveInventory(String productId, int quantity) {
        try {
            Product product = productRepository.findByIdWithLock(productId);
            
            if (product.getStock() >= quantity) {
                product.setStock(product.getStock() - quantity);
                product.setVersion(product.getVersion() + 1); // ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶
                productRepository.save(product);
                return true;
            }
            return false;
            
        } catch (OptimisticLockingFailureException e) {
            // é‡è¯•æœºåˆ¶
            return retryReserveInventory(productId, quantity, 3);
        }
    }
    
    // âœ… ä½¿ç”¨åˆ†å¸ƒå¼é”ç¡®ä¿åº“å­˜æ‰£å‡çš„åŸå­æ€§
    public boolean reserveInventoryWithDistributedLock(String productId, int quantity) {
        String lockKey = "inventory_lock_" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–åˆ†å¸ƒå¼é”
            Boolean lockAcquired = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(10));
                
            if (Boolean.TRUE.equals(lockAcquired)) {
                return reserveInventory(productId, quantity);
            } else {
                throw new ConcurrentModificationException("åº“å­˜æ­£åœ¨è¢«å…¶ä»–æ“ä½œä¿®æ”¹");
            }
            
        } finally {
            // é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    }
    
    // âœ… çº¿ç¨‹å®‰å…¨çš„è®¢å•å·ç”Ÿæˆ
    public String generateOrderNumber() {
        long counter = orderCounter.incrementAndGet();
        return "ORDER_" + System.currentTimeMillis() + "_" + counter;
    }
    
    // âœ… ä½¿ç”¨åˆ†å¸ƒå¼IDç”Ÿæˆå™¨
    public String generateDistributedOrderNumber() {
        // ä½¿ç”¨é›ªèŠ±ç®—æ³•æˆ–å…¶ä»–åˆ†å¸ƒå¼IDç”Ÿæˆç­–ç•¥
        return snowflakeIdGenerator.nextId();
    }
    
    // âœ… çº¿ç¨‹å®‰å…¨çš„ç¼“å­˜æ“ä½œ
    public Order getOrderFromCache(String orderId) {
        return orderCache.computeIfAbsent(orderId, id -> {
            return orderRepository.findById(id)
                .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + id));
        });
    }
    
    // âœ… æ­£ç¡®çš„åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼
    private static volatile OrderService instance;
    
    public static OrderService getInstance() {
        if (instance == null) {
            synchronized (OrderService.class) {
                if (instance == null) {
                    instance = new OrderService();
                }
            }
        }
        return instance;
    }
    
    // âœ… ä½¿ç”¨æ•°æ®åº“è¡Œé”ç¡®ä¿ä½™é¢æ‰£å‡å®‰å…¨
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public boolean deductBalance(String userId, BigDecimal amount) {
        try {
            // ä½¿ç”¨SELECT FOR UPDATEè·å–è¡Œé”
            User user = userRepository.findByIdForUpdate(userId);
            
            if (user.getBalance().compareTo(amount) >= 0) {
                user.setBalance(user.getBalance().subtract(amount));
                userRepository.save(user);
                
                // è®°å½•ä½™é¢å˜åŠ¨æ—¥å¿—
                balanceLogService.recordDeduction(userId, amount);
                return true;
            }
            return false;
            
        } catch (Exception e) {
            // äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
            log.error("ä½™é¢æ‰£å‡å¤±è´¥: userId={}, amount={}", userId, amount, e);
            throw new BalanceDeductionException("ä½™é¢æ‰£å‡å¤±è´¥", e);
        }
    }
    
    // âœ… ä½¿ç”¨åˆ†å¸ƒå¼é”å¤„ç†æ‰¹é‡æ“ä½œ
    public void processBatchOrders(List<Order> orders) {
        // æŒ‰äº§å“IDåˆ†ç»„ï¼Œå‡å°‘é”ç«äº‰
        Map<String, List<Order>> ordersByProduct = orders.stream()
            .collect(Collectors.groupingBy(Order::getProductId));
            
        // å¹¶è¡Œå¤„ç†ä¸åŒäº§å“çš„è®¢å•
        ordersByProduct.entrySet().parallelStream().forEach(entry -> {
            String productId = entry.getKey();
            List<Order> productOrders = entry.getValue();
            
            String lockKey = "batch_process_" + productId;
            String lockValue = UUID.randomUUID().toString();
            
            try {
                if (acquireDistributedLock(lockKey, lockValue, Duration.ofMinutes(5))) {
                    processOrdersForProduct(productOrders);
                }
            } finally {
                releaseLock(lockKey, lockValue);
            }
        });
    }
    
    // âœ… ä½¿ç”¨CompletableFutureå¤„ç†å¼‚æ­¥å¹¶å‘
    public CompletableFuture<OrderResult> processOrderAsync(Order order) {
        return CompletableFuture
            .supplyAsync(() -> validateOrder(order))
            .thenCompose(validOrder -> 
                CompletableFuture.supplyAsync(() -> reserveInventory(validOrder.getProductId(), validOrder.getQuantity()))
                    .thenApply(reserved -> new OrderProcessContext(validOrder, reserved))
            )
            .thenCompose(context -> {
                if (context.isInventoryReserved()) {
                    return CompletableFuture.supplyAsync(() -> processPayment(context.getOrder()))
                        .thenApply(paymentResult -> new OrderResult(context.getOrder(), paymentResult));
                } else {
                    return CompletableFuture.completedFuture(
                        new OrderResult(context.getOrder(), PaymentResult.failed("åº“å­˜ä¸è¶³"))
                    );
                }
            })
            .exceptionally(throwable -> {
                log.error("è®¢å•å¤„ç†å¼‚å¸¸", throwable);
                return new OrderResult(order, PaymentResult.failed("ç³»ç»Ÿå¼‚å¸¸"));
            });
    }
    
    // âœ… é‡è¯•æœºåˆ¶å¤„ç†å¹¶å‘å†²çª
    private boolean retryReserveInventory(String productId, int quantity, int maxRetries) {
        for (int i = 0; i < maxRetries; i++) {
            try {
                Thread.sleep(100 * (i + 1)); // æŒ‡æ•°é€€é¿
                return reserveInventory(productId, quantity);
            } catch (OptimisticLockingFailureException e) {
                if (i == maxRetries - 1) {
                    throw new ConcurrentModificationException("åº“å­˜é¢„ç•™å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", e);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("æ“ä½œè¢«ä¸­æ–­", e);
            }
        }
        return false;
    }
    
    // âœ… åˆ†å¸ƒå¼é”çš„è·å–å’Œé‡Šæ”¾
    private boolean acquireDistributedLock(String lockKey, String lockValue, Duration timeout) {
        return Boolean.TRUE.equals(
            redisTemplate.opsForValue().setIfAbsent(lockKey, lockValue, timeout)
        );
    }
    
    private void releaseLock(String lockKey, String lockValue) {
        String script = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
            
        redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(lockKey),
            lockValue
        );
    }
    
    // âœ… ä½¿ç”¨çº¿ç¨‹æ± æ§åˆ¶å¹¶å‘åº¦
    private final ThreadPoolExecutor orderProcessingExecutor = new ThreadPoolExecutor(
        10, // æ ¸å¿ƒçº¿ç¨‹æ•°
        50, // æœ€å¤§çº¿ç¨‹æ•°
        60L, TimeUnit.SECONDS, // ç©ºé—²æ—¶é—´
        new LinkedBlockingQueue<>(1000), // é˜Ÿåˆ—å¤§å°
        new ThreadFactoryBuilder().setNameFormat("order-processing-%d").build(),
        new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
    );
    
    public void submitOrderProcessing(Order order) {
        orderProcessingExecutor.submit(() -> {
            try {
                processOrder(order);
            } catch (Exception e) {
                log.error("è®¢å•å¤„ç†å¤±è´¥: orderId={}", order.getId(), e);
            }
        });
    }
}
```

## 4.21.2 å¼‚å¸¸å¤„ç†å®Œæ•´æ€§

### 4.21.2.1 å¼‚å¸¸æ•è·å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸éƒ½è¢«é€‚å½“çš„try-catchå—å¤„ç†
b. éªŒè¯å¼‚å¸¸ç±»å‹æ•è·çš„ç²¾ç¡®æ€§å’Œå®Œæ•´æ€§
c. æ£€æŸ¥ç¬¬ä¸‰æ–¹åº“è°ƒç”¨çš„å¼‚å¸¸å¤„ç†
d. ç¡®ä¿å¼‚æ­¥æ“ä½œä¸­çš„å¼‚å¸¸å¤„ç†

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æå·¥å…·ï¼ˆSonarQubeã€CheckStyleï¼‰
2. å¼‚å¸¸è·¯å¾„è¦†ç›–æµ‹è¯•
3. ä»£ç å®¡æŸ¥æ£€æŸ¥å¼‚å¸¸å¤„ç†è¦†ç›–ç‡
4. è¿è¡Œæ—¶å¼‚å¸¸ç›‘æ§å’Œæ—¥å¿—åˆ†æ

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å¼‚å¸¸æ•è·ä¸å®Œæ•´
public class FileProcessService {
    
    // âŒ æ²¡æœ‰å¤„ç†æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸
    public String readFileContent(String filePath) {
        try {
            return Files.readString(Paths.get(filePath));
        } catch (IOException e) {
            // åªæ•è·äº†IOExceptionï¼Œå¿½ç•¥äº†å…¶ä»–å¯èƒ½çš„å¼‚å¸¸
            return "";
        }
        // æ²¡æœ‰å¤„ç†InvalidPathExceptionã€SecurityExceptionç­‰
    }
    
    // âŒ å¼‚å¸¸ç±»å‹è¿‡äºå®½æ³›
    public void processData(String data) {
        try {
            parseJson(data);
            validateData(data);
            saveToDatabase(data);
        } catch (Exception e) {
            // æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œæ— æ³•åŒºåˆ†å…·ä½“é—®é¢˜
            log.error("å¤„ç†å¤±è´¥", e);
        }
    }
    
    // âŒ å¿½ç•¥äº†ç¬¬ä¸‰æ–¹åº“çš„å¼‚å¸¸
    public void sendEmail(String to, String subject, String body) {
        EmailSender sender = new EmailSender();
        sender.send(to, subject, body); // å¯èƒ½æŠ›å‡ºå¤šç§å¼‚å¸¸ä½†æœªå¤„ç†
    }
    
    // âŒ å¼‚æ­¥æ“ä½œå¼‚å¸¸å¤„ç†ç¼ºå¤±
    public void processAsync(List<String> items) {
        CompletableFuture.runAsync(() -> {
            for (String item : items) {
                processItem(item); // å¼‚å¸¸ä¼šè¢«å¿½ç•¥
            }
        });
    }
    
    // âŒ èµ„æºæ³„æ¼é£é™©
    public String readFromDatabase(String query) {
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        
        try {
            conn = dataSource.getConnection();
            stmt = conn.prepareStatement(query);
            rs = stmt.executeQuery();
            
            if (rs.next()) {
                return rs.getString(1);
            }
        } catch (SQLException e) {
            log.error("æ•°æ®åº“æŸ¥è¯¢å¤±è´¥", e);
        }
        // æ²¡æœ‰åœ¨finallyå—ä¸­å…³é—­èµ„æº
        return null;
    }
    
    // âŒ åµŒå¥—å¼‚å¸¸å¤„ç†ä¸å½“
    public void complexOperation(String input) {
        try {
            String processed = preProcess(input);
            try {
                String validated = validate(processed);
                save(validated);
            } catch (ValidationException e) {
                // å†…å±‚å¼‚å¸¸å¤„ç†å¯èƒ½æ©ç›–å¤–å±‚é—®é¢˜
                throw new ProcessingException("éªŒè¯å¤±è´¥");
            }
        } catch (PreProcessException e) {
            log.error("é¢„å¤„ç†å¤±è´¥", e);
        }
    }
    
    // âŒ å¼‚å¸¸ä¿¡æ¯ä¸¢å¤±
    public void handleRequest(HttpServletRequest request) {
        try {
            String data = extractData(request);
            processBusinessLogic(data);
        } catch (DataExtractionException | BusinessLogicException e) {
            // åªè®°å½•äº†å¼‚å¸¸ç±»å‹ï¼Œä¸¢å¤±äº†å…·ä½“é”™è¯¯ä¿¡æ¯
            throw new RuntimeException("è¯·æ±‚å¤„ç†å¤±è´¥");
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å¼‚å¸¸æ•è·å¤„ç†
public class FileProcessService {
    
    private static final Logger log = LoggerFactory.getLogger(FileProcessService.class);
    
    // âœ… å¤„ç†æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸
    public String readFileContent(String filePath) {
        if (filePath == null || filePath.trim().isEmpty()) {
            throw new IllegalArgumentException("æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º");
        }
        
        try {
            Path path = Paths.get(filePath);
            return Files.readString(path, StandardCharsets.UTF_8);
            
        } catch (InvalidPathException e) {
            log.error("æ— æ•ˆçš„æ–‡ä»¶è·¯å¾„: {}", filePath, e);
            throw new FileProcessException("æ–‡ä»¶è·¯å¾„æ ¼å¼é”™è¯¯: " + filePath, e);
            
        } catch (NoSuchFileException e) {
            log.error("æ–‡ä»¶ä¸å­˜åœ¨: {}", filePath, e);
            throw new FileProcessException("æ–‡ä»¶ä¸å­˜åœ¨: " + filePath, e);
            
        } catch (AccessDeniedException e) {
            log.error("æ–‡ä»¶è®¿é—®è¢«æ‹’ç»: {}", filePath, e);
            throw new FileProcessException("æ²¡æœ‰æƒé™è®¿é—®æ–‡ä»¶: " + filePath, e);
            
        } catch (IOException e) {
            log.error("æ–‡ä»¶è¯»å–IOå¼‚å¸¸: {}", filePath, e);
            throw new FileProcessException("æ–‡ä»¶è¯»å–å¤±è´¥: " + filePath, e);
            
        } catch (OutOfMemoryError e) {
            log.error("æ–‡ä»¶è¿‡å¤§å¯¼è‡´å†…å­˜ä¸è¶³: {}", filePath, e);
            throw new FileProcessException("æ–‡ä»¶è¿‡å¤§ï¼Œæ— æ³•è¯»å–: " + filePath, e);
            
        } catch (SecurityException e) {
            log.error("å®‰å…¨ç®¡ç†å™¨ç¦æ­¢æ–‡ä»¶è®¿é—®: {}", filePath, e);
            throw new FileProcessException("å®‰å…¨é™åˆ¶ï¼Œæ— æ³•è®¿é—®æ–‡ä»¶: " + filePath, e);
        }
    }
    
    // âœ… ç²¾ç¡®çš„å¼‚å¸¸ç±»å‹æ•è·
    public ProcessResult processData(String data) {
        if (data == null) {
            throw new IllegalArgumentException("æ•°æ®ä¸èƒ½ä¸ºç©º");
        }
        
        try {
            // è§£æJSON
            JsonNode jsonNode = parseJson(data);
            log.debug("JSONè§£ææˆåŠŸ");
            
            // éªŒè¯æ•°æ®
            ValidationResult validationResult = validateData(jsonNode);
            if (!validationResult.isValid()) {
                return ProcessResult.validationFailed(validationResult.getErrors());
            }
            log.debug("æ•°æ®éªŒè¯é€šè¿‡");
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            String recordId = saveToDatabase(jsonNode);
            log.info("æ•°æ®ä¿å­˜æˆåŠŸï¼Œè®°å½•ID: {}", recordId);
            
            return ProcessResult.success(recordId);
            
        } catch (JsonParseException e) {
            log.error("JSONæ ¼å¼é”™è¯¯: {}", data, e);
            return ProcessResult.jsonParseError("JSONæ ¼å¼é”™è¯¯: " + e.getMessage());
            
        } catch (JsonMappingException e) {
            log.error("JSONæ˜ å°„é”™è¯¯: {}", data, e);
            return ProcessResult.jsonMappingError("JSONç»“æ„é”™è¯¯: " + e.getMessage());
            
        } catch (ValidationException e) {
            log.warn("æ•°æ®éªŒè¯å¤±è´¥: {}", e.getMessage());
            return ProcessResult.validationFailed(e.getValidationErrors());
            
        } catch (DataAccessException e) {
            log.error("æ•°æ®åº“è®¿é—®å¼‚å¸¸", e);
            return ProcessResult.databaseError("æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            
        } catch (DataIntegrityViolationException e) {
            log.error("æ•°æ®å®Œæ•´æ€§çº¦æŸè¿å", e);
            return ProcessResult.dataIntegrityError("æ•°æ®è¿åå®Œæ•´æ€§çº¦æŸ");
            
        } catch (Exception e) {
            // æ•è·æœªé¢„æœŸçš„å¼‚å¸¸
            log.error("å¤„ç†æ•°æ®æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: {}", data, e);
            return ProcessResult.unexpectedError("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
        }
    }
    
    // âœ… ç¬¬ä¸‰æ–¹åº“å¼‚å¸¸çš„å®Œæ•´å¤„ç†
    public EmailResult sendEmail(String to, String subject, String body) {
        if (to == null || to.trim().isEmpty()) {
            throw new IllegalArgumentException("æ”¶ä»¶äººåœ°å€ä¸èƒ½ä¸ºç©º");
        }
        
        EmailSender sender = null;
        try {
            sender = emailSenderFactory.createSender();
            
            EmailMessage message = EmailMessage.builder()
                .to(to)
                .subject(subject)
                .body(body)
                .build();
                
            String messageId = sender.send(message);
            log.info("é‚®ä»¶å‘é€æˆåŠŸ: to={}, messageId={}", to, messageId);
            
            return EmailResult.success(messageId);
            
        } catch (EmailAddressException e) {
            log.error("é‚®ä»¶åœ°å€æ ¼å¼é”™è¯¯: {}", to, e);
            return EmailResult.addressError("é‚®ä»¶åœ°å€æ ¼å¼é”™è¯¯: " + to);
            
        } catch (EmailAuthenticationException e) {
            log.error("é‚®ä»¶æœåŠ¡å™¨è®¤è¯å¤±è´¥", e);
            return EmailResult.authError("é‚®ä»¶æœåŠ¡å™¨è®¤è¯å¤±è´¥");
            
        } catch (EmailConnectionException e) {
            log.error("é‚®ä»¶æœåŠ¡å™¨è¿æ¥å¤±è´¥", e);
            return EmailResult.connectionError("æ— æ³•è¿æ¥åˆ°é‚®ä»¶æœåŠ¡å™¨");
            
        } catch (EmailQuotaExceededException e) {
            log.error("é‚®ä»¶å‘é€é…é¢è¶…é™", e);
            return EmailResult.quotaError("é‚®ä»¶å‘é€é…é¢å·²ç”¨å®Œ");
            
        } catch (EmailContentException e) {
            log.error("é‚®ä»¶å†…å®¹æ ¼å¼é”™è¯¯", e);
            return EmailResult.contentError("é‚®ä»¶å†…å®¹æ ¼å¼é”™è¯¯: " + e.getMessage());
            
        } catch (EmailTimeoutException e) {
            log.error("é‚®ä»¶å‘é€è¶…æ—¶", e);
            return EmailResult.timeoutError("é‚®ä»¶å‘é€è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
            
        } catch (Exception e) {
            log.error("é‚®ä»¶å‘é€æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸: to={}", to, e);
            return EmailResult.unknownError("é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
            
        } finally {
            // ç¡®ä¿èµ„æºæ¸…ç†
            if (sender != null) {
                try {
                    sender.close();
                } catch (Exception e) {
                    log.warn("å…³é—­é‚®ä»¶å‘é€å™¨æ—¶å‘ç”Ÿå¼‚å¸¸", e);
                }
            }
        }
    }
    
    // âœ… å¼‚æ­¥æ“ä½œçš„å¼‚å¸¸å¤„ç†
    public CompletableFuture<List<ProcessResult>> processAsync(List<String> items) {
        if (items == null || items.isEmpty()) {
            return CompletableFuture.completedFuture(Collections.emptyList());
        }
        
        List<CompletableFuture<ProcessResult>> futures = items.stream()
            .map(item -> CompletableFuture
                .supplyAsync(() -> {
                    try {
                        return processItem(item);
                    } catch (ProcessingException e) {
                        log.error("å¤„ç†é¡¹ç›®å¤±è´¥: {}", item, e);
                        return ProcessResult.failed(item, e.getMessage());
                    } catch (Exception e) {
                        log.error("å¤„ç†é¡¹ç›®æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: {}", item, e);
                        return ProcessResult.failed(item, "ç³»ç»Ÿå¼‚å¸¸");
                    }
                }, asyncExecutor)
                .exceptionally(throwable -> {
                    log.error("å¼‚æ­¥å¤„ç†é¡¹ç›®æ—¶å‘ç”Ÿå¼‚å¸¸: {}", item, throwable);
                    return ProcessResult.failed(item, "å¼‚æ­¥å¤„ç†å¼‚å¸¸");
                })
            )
            .collect(Collectors.toList());
            
        return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .thenApply(v -> futures.stream()
                .map(CompletableFuture::join)
                .collect(Collectors.toList())
            )
            .exceptionally(throwable -> {
                log.error("æ‰¹é‡å¼‚æ­¥å¤„ç†æ—¶å‘ç”Ÿå¼‚å¸¸", throwable);
                return items.stream()
                    .map(item -> ProcessResult.failed(item, "æ‰¹é‡å¤„ç†å¼‚å¸¸"))
                    .collect(Collectors.toList());
            });
    }
    
    // âœ… ä½¿ç”¨try-with-resourcesç¡®ä¿èµ„æºæ¸…ç†
    public String readFromDatabase(String query) {
        if (query == null || query.trim().isEmpty()) {
            throw new IllegalArgumentException("æŸ¥è¯¢è¯­å¥ä¸èƒ½ä¸ºç©º");
        }
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement stmt = conn.prepareStatement(query);
             ResultSet rs = stmt.executeQuery()) {
             
            if (rs.next()) {
                return rs.getString(1);
            }
            return null;
            
        } catch (SQLTimeoutException e) {
            log.error("æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶: {}", query, e);
            throw new DatabaseException("æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•", e);
            
        } catch (SQLSyntaxErrorException e) {
            log.error("SQLè¯­æ³•é”™è¯¯: {}", query, e);
            throw new DatabaseException("æŸ¥è¯¢è¯­å¥è¯­æ³•é”™è¯¯", e);
            
        } catch (SQLException e) {
            log.error("æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸: {}", query, e);
            throw new DatabaseException("æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: " + e.getMessage(), e);
            
        } catch (Exception e) {
            log.error("æŸ¥è¯¢æ•°æ®åº“æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: {}", query, e);
            throw new DatabaseException("æ•°æ®åº“æ“ä½œå¼‚å¸¸", e);
        }
    }
    
    // âœ… åˆç†çš„å¼‚å¸¸é“¾å¤„ç†
    public void complexOperation(String input) {
        if (input == null) {
            throw new IllegalArgumentException("è¾“å…¥ä¸èƒ½ä¸ºç©º");
        }
        
        String processed = null;
        String validated = null;
        
        try {
            // é¢„å¤„ç†é˜¶æ®µ
            try {
                processed = preProcess(input);
                log.debug("é¢„å¤„ç†å®Œæˆ: {}", processed);
                
            } catch (PreProcessException e) {
                log.error("é¢„å¤„ç†å¤±è´¥: input={}", input, e);
                throw new ComplexOperationException("é¢„å¤„ç†é˜¶æ®µå¤±è´¥", e);
            }
            
            // éªŒè¯é˜¶æ®µ
            try {
                validated = validate(processed);
                log.debug("éªŒè¯å®Œæˆ: {}", validated);
                
            } catch (ValidationException e) {
                log.error("éªŒè¯å¤±è´¥: processed={}", processed, e);
                throw new ComplexOperationException("éªŒè¯é˜¶æ®µå¤±è´¥", e);
            }
            
            // ä¿å­˜é˜¶æ®µ
            try {
                save(validated);
                log.info("å¤æ‚æ“ä½œå®Œæˆ: input={}", input);
                
            } catch (SaveException e) {
                log.error("ä¿å­˜å¤±è´¥: validated={}", validated, e);
                throw new ComplexOperationException("ä¿å­˜é˜¶æ®µå¤±è´¥", e);
            }
            
        } catch (ComplexOperationException e) {
            // é‡æ–°æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
            throw e;
            
        } catch (Exception e) {
            log.error("å¤æ‚æ“ä½œæ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: input={}", input, e);
            throw new ComplexOperationException("æ“ä½œå¤±è´¥ï¼Œå‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸", e);
        }
    }
    
    // âœ… ä¿ç•™å¼‚å¸¸ä¿¡æ¯çš„å¤„ç†
    public ResponseEntity<String> handleRequest(HttpServletRequest request) {
        try {
            String data = extractData(request);
            ProcessResult result = processBusinessLogic(data);
            
            return ResponseEntity.ok(result.toJson());
            
        } catch (DataExtractionException e) {
            log.error("æ•°æ®æå–å¤±è´¥: uri={}", request.getRequestURI(), e);
            return ResponseEntity.badRequest()
                .body(createErrorResponse("DATA_EXTRACTION_ERROR", e.getMessage(), e.getErrorCode()));
                
        } catch (BusinessLogicException e) {
            log.error("ä¸šåŠ¡é€»è¾‘å¤„ç†å¤±è´¥: uri={}", request.getRequestURI(), e);
            return ResponseEntity.status(HttpStatus.UNPROCESSABLE_ENTITY)
                .body(createErrorResponse("BUSINESS_LOGIC_ERROR", e.getMessage(), e.getErrorCode()));
                
        } catch (ValidationException e) {
            log.warn("è¯·æ±‚æ•°æ®éªŒè¯å¤±è´¥: uri={}", request.getRequestURI(), e);
            return ResponseEntity.badRequest()
                .body(createErrorResponse("VALIDATION_ERROR", e.getMessage(), e.getValidationErrors()));
                
        } catch (Exception e) {
            log.error("å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: uri={}", request.getRequestURI(), e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(createErrorResponse("INTERNAL_ERROR", "ç³»ç»Ÿå†…éƒ¨é”™è¯¯", null));
        }
    }
    
    // âœ… å¼‚å¸¸é‡è¯•æœºåˆ¶
    @Retryable(value = {TransientException.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
    public String callExternalService(String request) {
        try {
            return externalServiceClient.call(request);
            
        } catch (ConnectionTimeoutException e) {
            log.warn("å¤–éƒ¨æœåŠ¡è¿æ¥è¶…æ—¶ï¼Œå°†é‡è¯•: {}", e.getMessage());
            throw new TransientException("è¿æ¥è¶…æ—¶", e);
            
        } catch (ServiceUnavailableException e) {
            log.warn("å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨ï¼Œå°†é‡è¯•: {}", e.getMessage());
            throw new TransientException("æœåŠ¡ä¸å¯ç”¨", e);
            
        } catch (AuthenticationException e) {
            log.error("å¤–éƒ¨æœåŠ¡è®¤è¯å¤±è´¥ï¼Œä¸ä¼šé‡è¯•: {}", e.getMessage());
            throw new PermanentException("è®¤è¯å¤±è´¥", e);
            
        } catch (Exception e) {
            log.error("è°ƒç”¨å¤–éƒ¨æœåŠ¡æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸: {}", e.getMessage(), e);
            throw new PermanentException("å¤–éƒ¨æœåŠ¡è°ƒç”¨å¤±è´¥", e);
        }
    }
    
    @Recover
    public String recoverFromExternalServiceFailure(TransientException e, String request) {
        log.error("å¤–éƒ¨æœåŠ¡è°ƒç”¨æœ€ç»ˆå¤±è´¥ï¼Œå¯ç”¨é™çº§æ–¹æ¡ˆ: request={}", request, e);
        return fallbackService.getDefaultResponse(request);
    }
}
```

### 4.21.2.2 å¼‚å¸¸å¤„ç†ç­–ç•¥æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. éªŒè¯å¼‚å¸¸å¤„ç†ç­–ç•¥çš„é€‰æ‹©æ˜¯å¦åˆé€‚
b. æ£€æŸ¥å¼‚å¸¸ä¿¡æ¯çš„è®°å½•å’Œä¼ æ’­æœºåˆ¶
c. ç¡®ä¿ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯å±•ç¤º
d. åŒºåˆ†ç³»ç»Ÿå¼‚å¸¸å’Œä¸šåŠ¡å¼‚å¸¸çš„å¤„ç†æ–¹å¼

**2. æ£€æµ‹æ–¹æ³•**

1. å¼‚å¸¸å¤„ç†ç­–ç•¥å®¡æŸ¥
2. æ—¥å¿—è®°å½•å®Œæ•´æ€§æ£€æŸ¥
3. ç”¨æˆ·ä½“éªŒæµ‹è¯•
4. å¼‚å¸¸ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶éªŒè¯

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å¼‚å¸¸å¤„ç†ç­–ç•¥ä¸å½“
public class UserService {
    
    // âŒ åæ‰å¼‚å¸¸ï¼Œä¸è®°å½•ä¸å¤„ç†
    public User createUser(UserRequest request) {
        try {
            return userRepository.save(convertToUser(request));
        } catch (Exception e) {
            // é™é»˜å¿½ç•¥å¼‚å¸¸
            return null;
        }
    }
    
    // âŒ å¼‚å¸¸ä¿¡æ¯æš´éœ²ç»™ç”¨æˆ·
    public ResponseEntity<String> getUserById(Long id) {
        try {
            User user = userRepository.findById(id);
            return ResponseEntity.ok(user.toJson());
        } catch (SQLException e) {
            // ç›´æ¥æš´éœ²æ•°æ®åº“å¼‚å¸¸ä¿¡æ¯
            return ResponseEntity.status(500)
                .body("Database error: " + e.getMessage());
        }
    }
    
    // âŒ å¼‚å¸¸å¤„ç†è¿‡äºç²—ç³™
    public void processUserData(List<UserData> dataList) {
        for (UserData data : dataList) {
            try {
                processData(data);
            } catch (Exception e) {
                // è®°å½•å¼‚å¸¸ä½†ç»§ç»­å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
                log.error("å¤„ç†å¤±è´¥", e);
            }
        }
    }
    
    // âŒ å¼‚å¸¸è½¬æ¢ä¸¢å¤±ä¿¡æ¯
    public void updateUser(Long id, UserRequest request) {
        try {
            User user = userRepository.findById(id);
            user.update(request);
            userRepository.save(user);
        } catch (DataIntegrityViolationException e) {
            // ä¸¢å¤±äº†å…·ä½“çš„çº¦æŸè¿åä¿¡æ¯
            throw new RuntimeException("æ›´æ–°å¤±è´¥");
        }
    }
    
    // âŒ æ²¡æœ‰åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
    public void transferMoney(String fromAccount, String toAccount, BigDecimal amount) {
        try {
            accountService.debit(fromAccount, amount);
            accountService.credit(toAccount, amount);
        } catch (Exception e) {
            // æ‰€æœ‰å¼‚å¸¸éƒ½æŒ‰ç³»ç»Ÿå¼‚å¸¸å¤„ç†
            log.error("è½¬è´¦å¤±è´¥", e);
            throw new SystemException("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
    
    // âŒ å¼‚å¸¸é‡è¯•ç­–ç•¥ä¸å½“
    public String callExternalAPI(String request) {
        for (int i = 0; i < 5; i++) {
            try {
                return externalClient.call(request);
            } catch (Exception e) {
                // å¯¹æ‰€æœ‰å¼‚å¸¸éƒ½é‡è¯•ï¼ŒåŒ…æ‹¬ä¸åº”è¯¥é‡è¯•çš„
                if (i == 4) {
                    throw e;
                }
            }
        }
        return null;
    }
    
    // âŒ å¼‚å¸¸æ—¥å¿—è®°å½•ä¸å……åˆ†
    public void importUsers(InputStream inputStream) {
        try {
            List<User> users = parseUsers(inputStream);
            userRepository.saveAll(users);
        } catch (Exception e) {
            // æ—¥å¿—ä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•å®šä½é—®é¢˜
            log.error("å¯¼å…¥å¤±è´¥");
            throw new ImportException("å¯¼å…¥å¤±è´¥");
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šåˆç†çš„å¼‚å¸¸å¤„ç†ç­–ç•¥
@Service
public class UserService {
    
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    private final UserRepository userRepository;
    private final NotificationService notificationService;
    private final AuditService auditService;
    
    // âœ… å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œè®°å½•
    public CreateUserResult createUser(UserRequest request) {
        // å‚æ•°éªŒè¯
        if (request == null) {
            throw new IllegalArgumentException("ç”¨æˆ·è¯·æ±‚ä¸èƒ½ä¸ºç©º");
        }
        
        try {
            // ä¸šåŠ¡éªŒè¯
            validateUserRequest(request);
            
            // è½¬æ¢å’Œä¿å­˜
            User user = convertToUser(request);
            User savedUser = userRepository.save(user);
            
            // è®°å½•å®¡è®¡æ—¥å¿—
            auditService.recordUserCreation(savedUser.getId(), request.getOperatorId());
            
            log.info("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: userId={}, email={}", savedUser.getId(), savedUser.getEmail());
            
            return CreateUserResult.success(savedUser);
            
        } catch (ValidationException e) {
            log.warn("ç”¨æˆ·åˆ›å»ºéªŒè¯å¤±è´¥: email={}, errors={}", request.getEmail(), e.getErrors());
            return CreateUserResult.validationFailed(e.getErrors());
            
        } catch (DuplicateEmailException e) {
            log.warn("é‚®ç®±å·²å­˜åœ¨: email={}", request.getEmail());
            return CreateUserResult.emailExists("è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ");
            
        } catch (DataIntegrityViolationException e) {
            log.error("æ•°æ®å®Œæ•´æ€§çº¦æŸè¿å: email={}", request.getEmail(), e);
            return CreateUserResult.dataIntegrityError("æ•°æ®çº¦æŸå†²çªï¼Œè¯·æ£€æŸ¥è¾“å…¥");
            
        } catch (DataAccessException e) {
            log.error("æ•°æ®åº“è®¿é—®å¼‚å¸¸: email={}", request.getEmail(), e);
            return CreateUserResult.systemError("ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
            
        } catch (Exception e) {
            log.error("åˆ›å»ºç”¨æˆ·æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: email={}", request.getEmail(), e);
            return CreateUserResult.systemError("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
        }
    }
    
    // âœ… ç”¨æˆ·å‹å¥½çš„å¼‚å¸¸ä¿¡æ¯
    public ResponseEntity<ApiResponse<User>> getUserById(Long id) {
        try {
            if (id == null || id <= 0) {
                return ResponseEntity.badRequest()
                    .body(ApiResponse.error("INVALID_PARAMETER", "ç”¨æˆ·IDæ— æ•ˆ"));
            }
            
            User user = userRepository.findById(id)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));
                
            return ResponseEntity.ok(ApiResponse.success(user));
            
        } catch (UserNotFoundException e) {
            log.warn("ç”¨æˆ·ä¸å­˜åœ¨: id={}", id);
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body(ApiResponse.error("USER_NOT_FOUND", "ç”¨æˆ·ä¸å­˜åœ¨"));
                
        } catch (DataAccessException e) {
            log.error("æŸ¥è¯¢ç”¨æˆ·æ—¶æ•°æ®åº“å¼‚å¸¸: id={}", id, e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(ApiResponse.error("DATABASE_ERROR", "ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨"));
                
        } catch (Exception e) {
            log.error("æŸ¥è¯¢ç”¨æˆ·æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: id={}", id, e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(ApiResponse.error("INTERNAL_ERROR", "ç³»ç»Ÿå†…éƒ¨é”™è¯¯"));
        }
    }
    
    // âœ… æ‰¹é‡å¤„ç†çš„å¼‚å¸¸ç­–ç•¥
    public BatchProcessResult processUserData(List<UserData> dataList) {
        if (dataList == null || dataList.isEmpty()) {
            return BatchProcessResult.empty();
        }
        
        List<ProcessResult> results = new ArrayList<>();
        List<String> criticalErrors = new ArrayList<>();
        int successCount = 0;
        int failureCount = 0;
        
        for (int i = 0; i < dataList.size(); i++) {
            UserData data = dataList.get(i);
            try {
                ProcessResult result = processData(data);
                results.add(result);
                
                if (result.isSuccess()) {
                    successCount++;
                } else {
                    failureCount++;
                }
                
            } catch (CriticalSystemException e) {
                // å…³é”®ç³»ç»Ÿå¼‚å¸¸ï¼Œåœæ­¢å¤„ç†
                log.error("å¤„ç†ç”¨æˆ·æ•°æ®æ—¶å‘ç”Ÿå…³é”®ç³»ç»Ÿå¼‚å¸¸ï¼Œåœæ­¢æ‰¹é‡å¤„ç†: index={}", i, e);
                criticalErrors.add("å…³é”®ç³»ç»Ÿå¼‚å¸¸ï¼Œæ‰¹é‡å¤„ç†å·²åœæ­¢");
                break;
                
            } catch (BusinessException e) {
                // ä¸šåŠ¡å¼‚å¸¸ï¼Œè®°å½•ä½†ç»§ç»­å¤„ç†
                log.warn("å¤„ç†ç”¨æˆ·æ•°æ®ä¸šåŠ¡å¼‚å¸¸: index={}, data={}", i, data.getId(), e);
                results.add(ProcessResult.businessError(data.getId(), e.getMessage()));
                failureCount++;
                
            } catch (Exception e) {
                // å…¶ä»–å¼‚å¸¸ï¼Œè®°å½•å¹¶ç»§ç»­
                log.error("å¤„ç†ç”¨æˆ·æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: index={}, data={}", i, data.getId(), e);
                results.add(ProcessResult.systemError(data.getId(), "ç³»ç»Ÿå¼‚å¸¸"));
                failureCount++;
            }
        }
        
        log.info("æ‰¹é‡å¤„ç†å®Œæˆ: total={}, success={}, failure={}", 
                dataList.size(), successCount, failureCount);
                
        return BatchProcessResult.builder()
            .results(results)
            .successCount(successCount)
            .failureCount(failureCount)
            .criticalErrors(criticalErrors)
            .build();
    }
    
    // âœ… ä¿ç•™å¼‚å¸¸ä¿¡æ¯çš„è½¬æ¢
    public void updateUser(Long id, UserRequest request) {
        try {
            User user = userRepository.findById(id)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));
                
            // è®°å½•æ›´æ–°å‰çš„çŠ¶æ€
            String oldState = user.toAuditString();
            
            user.update(request);
            User updatedUser = userRepository.save(user);
            
            // è®°å½•å®¡è®¡æ—¥å¿—
            auditService.recordUserUpdate(id, oldState, updatedUser.toAuditString(), request.getOperatorId());
            
            log.info("ç”¨æˆ·æ›´æ–°æˆåŠŸ: userId={}", id);
            
        } catch (UserNotFoundException e) {
            log.warn("æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ä¸å­˜åœ¨: id={}", id);
            throw e;
            
        } catch (DataIntegrityViolationException e) {
            log.error("æ›´æ–°ç”¨æˆ·æ—¶æ•°æ®å®Œæ•´æ€§çº¦æŸè¿å: id={}", id, e);
            
            // åˆ†æå…·ä½“çš„çº¦æŸè¿åç±»å‹
            String constraintName = extractConstraintName(e);
            String userMessage = mapConstraintToUserMessage(constraintName);
            
            throw new UserUpdateException(userMessage, e);
            
        } catch (OptimisticLockingFailureException e) {
            log.warn("æ›´æ–°ç”¨æˆ·æ—¶å‘ç”Ÿä¹è§‚é”å†²çª: id={}", id, e);
            throw new ConcurrentUpdateException("ç”¨æˆ·ä¿¡æ¯å·²è¢«å…¶ä»–æ“ä½œä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•", e);
            
        } catch (DataAccessException e) {
            log.error("æ›´æ–°ç”¨æˆ·æ—¶æ•°æ®åº“å¼‚å¸¸: id={}", id, e);
            throw new SystemException("ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•", e);
            
        } catch (Exception e) {
            log.error("æ›´æ–°ç”¨æˆ·æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: id={}", id, e);
            throw new SystemException("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜", e);
        }
    }
    
    // âœ… åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
    @Transactional
    public TransferResult transferMoney(String fromAccount, String toAccount, BigDecimal amount) {
        try {
            // ä¸šåŠ¡éªŒè¯
            validateTransferRequest(fromAccount, toAccount, amount);
            
            // æ£€æŸ¥ä½™é¢ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
            if (!accountService.hasSufficientBalance(fromAccount, amount)) {
                log.warn("è½¬è´¦å¤±è´¥ï¼Œä½™é¢ä¸è¶³: from={}, amount={}", fromAccount, amount);
                return TransferResult.insufficientBalance("è´¦æˆ·ä½™é¢ä¸è¶³");
            }
            
            // æ£€æŸ¥è´¦æˆ·çŠ¶æ€ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
            if (!accountService.isAccountActive(fromAccount) || !accountService.isAccountActive(toAccount)) {
                log.warn("è½¬è´¦å¤±è´¥ï¼Œè´¦æˆ·çŠ¶æ€å¼‚å¸¸: from={}, to={}", fromAccount, toAccount);
                return TransferResult.accountInactive("è´¦æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•è½¬è´¦");
            }
            
            // æ‰§è¡Œè½¬è´¦
            String transactionId = UUID.randomUUID().toString();
            accountService.debit(fromAccount, amount, transactionId);
            accountService.credit(toAccount, amount, transactionId);
            
            // è®°å½•è½¬è´¦æ—¥å¿—
            auditService.recordTransfer(fromAccount, toAccount, amount, transactionId);
            
            log.info("è½¬è´¦æˆåŠŸ: from={}, to={}, amount={}, transactionId={}", 
                    fromAccount, toAccount, amount, transactionId);
                    
            return TransferResult.success(transactionId);
            
        } catch (InsufficientBalanceException e) {
            // ä¸šåŠ¡å¼‚å¸¸
            log.warn("è½¬è´¦å¤±è´¥ï¼Œä½™é¢ä¸è¶³: from={}, to={}, amount={}", fromAccount, toAccount, amount);
            return TransferResult.insufficientBalance("è´¦æˆ·ä½™é¢ä¸è¶³");
            
        } catch (AccountNotFoundException e) {
            // ä¸šåŠ¡å¼‚å¸¸
            log.warn("è½¬è´¦å¤±è´¥ï¼Œè´¦æˆ·ä¸å­˜åœ¨: from={}, to={}", fromAccount, toAccount);
            return TransferResult.accountNotFound("è´¦æˆ·ä¸å­˜åœ¨");
            
        } catch (AccountFrozenException e) {
            // ä¸šåŠ¡å¼‚å¸¸
            log.warn("è½¬è´¦å¤±è´¥ï¼Œè´¦æˆ·è¢«å†»ç»“: account={}", e.getAccountId());
            return TransferResult.accountFrozen("è´¦æˆ·å·²è¢«å†»ç»“");
            
        } catch (TransferLimitExceededException e) {
            // ä¸šåŠ¡å¼‚å¸¸
            log.warn("è½¬è´¦å¤±è´¥ï¼Œè¶…å‡ºé™é¢: from={}, amount={}, limit={}", 
                    fromAccount, amount, e.getLimit());
            return TransferResult.limitExceeded("è½¬è´¦é‡‘é¢è¶…å‡ºé™é¢");
            
        } catch (DataAccessException e) {
            // ç³»ç»Ÿå¼‚å¸¸
            log.error("è½¬è´¦æ—¶æ•°æ®åº“å¼‚å¸¸: from={}, to={}, amount={}", fromAccount, toAccount, amount, e);
            return TransferResult.systemError("ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
            
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸
            log.error("è½¬è´¦æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: from={}, to={}, amount={}", fromAccount, toAccount, amount, e);
            return TransferResult.systemError("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
        }
    }
    
    // âœ… æ™ºèƒ½é‡è¯•ç­–ç•¥
    @Retryable(
        value = {TransientException.class, ConnectTimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public ApiResponse<String> callExternalAPI(String request) {
        try {
            String response = externalClient.call(request);
            log.debug("å¤–éƒ¨APIè°ƒç”¨æˆåŠŸ: request={}", request);
            return ApiResponse.success(response);
            
        } catch (AuthenticationException e) {
            // è®¤è¯å¼‚å¸¸ï¼Œä¸é‡è¯•
            log.error("å¤–éƒ¨APIè®¤è¯å¤±è´¥: {}", e.getMessage());
            throw new PermanentException("APIè®¤è¯å¤±è´¥", e);
            
        } catch (BadRequestException e) {
            // è¯·æ±‚æ ¼å¼é”™è¯¯ï¼Œä¸é‡è¯•
            log.error("å¤–éƒ¨APIè¯·æ±‚æ ¼å¼é”™è¯¯: request={}", request, e);
            throw new PermanentException("è¯·æ±‚æ ¼å¼é”™è¯¯", e);
            
        } catch (ConnectTimeoutException e) {
            // è¿æ¥è¶…æ—¶ï¼Œå¯é‡è¯•
            log.warn("å¤–éƒ¨APIè¿æ¥è¶…æ—¶ï¼Œå°†é‡è¯•: attempt={}", getCurrentAttempt());
            throw new TransientException("è¿æ¥è¶…æ—¶", e);
            
        } catch (ServiceUnavailableException e) {
            // æœåŠ¡ä¸å¯ç”¨ï¼Œå¯é‡è¯•
            log.warn("å¤–éƒ¨APIæœåŠ¡ä¸å¯ç”¨ï¼Œå°†é‡è¯•: attempt={}", getCurrentAttempt());
            throw new TransientException("æœåŠ¡ä¸å¯ç”¨", e);
            
        } catch (Exception e) {
            log.error("è°ƒç”¨å¤–éƒ¨APIæ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸: request={}", request, e);
            throw new PermanentException("å¤–éƒ¨APIè°ƒç”¨å¤±è´¥", e);
        }
    }
    
    @Recover
    public ApiResponse<String> recoverFromExternalAPIFailure(TransientException e, String request) {
        log.error("å¤–éƒ¨APIè°ƒç”¨æœ€ç»ˆå¤±è´¥ï¼Œå¯ç”¨é™çº§æ–¹æ¡ˆ: request={}", request, e);
        
        // å°è¯•ä»ç¼“å­˜è·å–
        String cachedResponse = cacheService.getCachedResponse(request);
        if (cachedResponse != null) {
            log.info("ä½¿ç”¨ç¼“å­˜å“åº”ä½œä¸ºé™çº§æ–¹æ¡ˆ: request={}", request);
            return ApiResponse.success(cachedResponse);
        }
        
        // è¿”å›é»˜è®¤å“åº”
        return ApiResponse.error("EXTERNAL_SERVICE_UNAVAILABLE", "å¤–éƒ¨æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
    }
    
    // âœ… è¯¦ç»†çš„å¼‚å¸¸æ—¥å¿—è®°å½•
    public ImportResult importUsers(InputStream inputStream, String fileName, String operatorId) {
        if (inputStream == null) {
            throw new IllegalArgumentException("è¾“å…¥æµä¸èƒ½ä¸ºç©º");
        }
        
        ImportContext context = ImportContext.builder()
            .fileName(fileName)
            .operatorId(operatorId)
            .startTime(Instant.now())
            .build();
            
        try {
            log.info("å¼€å§‹å¯¼å…¥ç”¨æˆ·: fileName={}, operatorId={}", fileName, operatorId);
            
            List<User> users = parseUsers(inputStream, context);
            log.info("è§£æç”¨æˆ·å®Œæˆ: count={}, fileName={}", users.size(), fileName);
            
            List<User> savedUsers = userRepository.saveAll(users);
            
            // è®°å½•å®¡è®¡æ—¥å¿—
            auditService.recordUserImport(savedUsers.size(), fileName, operatorId);
            
            log.info("ç”¨æˆ·å¯¼å…¥æˆåŠŸ: count={}, fileName={}, duration={}ms", 
                    savedUsers.size(), fileName, 
                    Duration.between(context.getStartTime(), Instant.now()).toMillis());
                    
            return ImportResult.success(savedUsers.size());
            
        } catch (InvalidFileFormatException e) {
            log.error("å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼æ— æ•ˆ: fileName={}, error={}", fileName, e.getMessage());
            return ImportResult.formatError("æ–‡ä»¶æ ¼å¼æ— æ•ˆ: " + e.getMessage());
            
        } catch (DataValidationException e) {
            log.error("å¯¼å…¥å¤±è´¥ï¼Œæ•°æ®éªŒè¯é”™è¯¯: fileName={}, errors={}", fileName, e.getErrors());
            return ImportResult.validationError(e.getErrors());
            
        } catch (DuplicateDataException e) {
            log.error("å¯¼å…¥å¤±è´¥ï¼Œå­˜åœ¨é‡å¤æ•°æ®: fileName={}, duplicates={}", fileName, e.getDuplicates());
            return ImportResult.duplicateError(e.getDuplicates());
            
        } catch (DataAccessException e) {
            log.error("å¯¼å…¥å¤±è´¥ï¼Œæ•°æ®åº“å¼‚å¸¸: fileName={}, operatorId={}", fileName, operatorId, e);
            return ImportResult.systemError("æ•°æ®åº“å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
            
        } catch (Exception e) {
            log.error("å¯¼å…¥å¤±è´¥ï¼Œå‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: fileName={}, operatorId={}", fileName, operatorId, e);
            return ImportResult.systemError("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
            
        } finally {
            // æ¸…ç†èµ„æº
            try {
                inputStream.close();
            } catch (IOException e) {
                log.warn("å…³é—­è¾“å…¥æµæ—¶å‘ç”Ÿå¼‚å¸¸: fileName={}", fileName, e);
            }
        }
    }
    
    // âœ… å¼‚å¸¸ä¿¡æ¯æ˜ å°„
    private String mapConstraintToUserMessage(String constraintName) {
        switch (constraintName) {
            case "uk_user_email":
                return "é‚®ç®±åœ°å€å·²å­˜åœ¨";
            case "uk_user_phone":
                return "æ‰‹æœºå·ç å·²å­˜åœ¨";
            case "chk_user_age":
                return "å¹´é¾„å¿…é¡»åœ¨åˆç†èŒƒå›´å†…";
            default:
                return "æ•°æ®çº¦æŸå†²çª";
        }
    }
    
    // âœ… å¼‚å¸¸ç›‘æ§å’Œå‘Šè­¦
    @EventListener
    public void handleCriticalException(CriticalExceptionEvent event) {
        log.error("æ£€æµ‹åˆ°å…³é”®å¼‚å¸¸: type={}, message={}", 
                event.getExceptionType(), event.getMessage());
                
        // å‘é€å‘Šè­¦
        alertService.sendCriticalAlert(
            "å…³é”®å¼‚å¸¸å‘Šè­¦",
            String.format("å¼‚å¸¸ç±»å‹: %s, æ¶ˆæ¯: %s, æ—¶é—´: %s", 
                event.getExceptionType(), 
                event.getMessage(), 
                event.getTimestamp())
        );
        
        // è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
        metricsService.incrementCounter("critical.exception", 
            "type", event.getExceptionType());
    }
}
```

### 4.21.2.3 èµ„æºæ¸…ç†å®Œæ•´æ€§æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿æ‰€æœ‰èµ„æºï¼ˆæ–‡ä»¶ã€ç½‘ç»œè¿æ¥ã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰æ­£ç¡®å…³é—­
b. éªŒè¯try-with-resourcesè¯­å¥çš„æ­£ç¡®ä½¿ç”¨
c. æ£€æŸ¥finallyå—ä¸­çš„èµ„æºæ¸…ç†é€»è¾‘
d. ç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹çš„èµ„æºé‡Šæ”¾

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æå·¥å…·ï¼ˆSpotBugsã€SonarQubeï¼‰
2. èµ„æºæ³„æ¼æ£€æµ‹å·¥å…·
3. å†…å­˜åˆ†æå·¥å…·ï¼ˆMATã€JProfilerï¼‰
4. å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ èµ„æºæ¸…ç†ä¸å®Œæ•´
public class FileService {
    
    // âŒ æ²¡æœ‰å…³é—­æ–‡ä»¶æµ
    public String readFile(String fileName) {
        try {
            FileInputStream fis = new FileInputStream(fileName);
            BufferedReader reader = new BufferedReader(new InputStreamReader(fis));
            StringBuilder content = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                content.append(line).append("\n");
            }
            return content.toString();
        } catch (IOException e) {
            throw new RuntimeException("è¯»å–æ–‡ä»¶å¤±è´¥", e);
        }
        // æ–‡ä»¶æµæ²¡æœ‰å…³é—­ï¼Œé€ æˆèµ„æºæ³„æ¼
    }
    
    // âŒ finallyå—ä¸­çš„èµ„æºæ¸…ç†ä¸å®‰å…¨
    public void writeFile(String fileName, String content) {
        FileOutputStream fos = null;
        BufferedWriter writer = null;
        try {
            fos = new FileOutputStream(fileName);
            writer = new BufferedWriter(new OutputStreamWriter(fos));
            writer.write(content);
        } catch (IOException e) {
            throw new RuntimeException("å†™å…¥æ–‡ä»¶å¤±è´¥", e);
        } finally {
            // âŒ æ²¡æœ‰æ£€æŸ¥nullï¼Œå¯èƒ½æŠ›å‡ºNullPointerException
            writer.close();
            fos.close();
        }
    }
    
    // âŒ æ•°æ®åº“è¿æ¥æ²¡æœ‰æ­£ç¡®å…³é—­
    public List<User> getUsers() {
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        List<User> users = new ArrayList<>();
        
        try {
            conn = dataSource.getConnection();
            stmt = conn.prepareStatement("SELECT * FROM users");
            rs = stmt.executeQuery();
            
            while (rs.next()) {
                users.add(mapToUser(rs));
            }
            
            return users;
        } catch (SQLException e) {
            throw new DataAccessException("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
        }
        // âŒ æ²¡æœ‰åœ¨finallyå—ä¸­å…³é—­èµ„æº
    }
    
    // âŒ ç½‘ç»œè¿æ¥èµ„æºæ³„æ¼
    public String callAPI(String url) {
        try {
            URL apiUrl = new URL(url);
            HttpURLConnection connection = (HttpURLConnection) apiUrl.openConnection();
            connection.setRequestMethod("GET");
            connection.setConnectTimeout(5000);
            connection.setReadTimeout(10000);
            
            BufferedReader reader = new BufferedReader(
                new InputStreamReader(connection.getInputStream()));
            StringBuilder response = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            
            return response.toString();
        } catch (IOException e) {
            throw new RuntimeException("APIè°ƒç”¨å¤±è´¥", e);
        }
        // âŒ è¿æ¥å’Œæµæ²¡æœ‰å…³é—­
    }
    
    // âŒ çº¿ç¨‹æ± æ²¡æœ‰æ­£ç¡®å…³é—­
    public void processDataAsync(List<Data> dataList) {
        ExecutorService executor = Executors.newFixedThreadPool(10);
        
        for (Data data : dataList) {
            executor.submit(() -> {
                processData(data);
            });
        }
        
        // âŒ æ²¡æœ‰å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹ä¼šä¸€ç›´å­˜åœ¨
    }
    
    // âŒ ç¼“å­˜èµ„æºæ²¡æœ‰æ¸…ç†
    public class CacheManager {
        private Map<String, Object> cache = new HashMap<>();
        private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
        
        public void startCleanupTask() {
            scheduler.scheduleAtFixedRate(() -> {
                cleanExpiredEntries();
            }, 0, 1, TimeUnit.HOURS);
        }
        
        // âŒ æ²¡æœ‰æä¾›å…³é—­æ–¹æ³•ï¼Œè°ƒåº¦å™¨ä¼šä¸€ç›´è¿è¡Œ
    }
    
    // âŒ ä¸´æ—¶æ–‡ä»¶æ²¡æœ‰æ¸…ç†
    public String processLargeData(byte[] data) {
        try {
            File tempFile = File.createTempFile("process", ".tmp");
            FileOutputStream fos = new FileOutputStream(tempFile);
            fos.write(data);
            fos.close();
            
            // å¤„ç†æ–‡ä»¶
            String result = processFile(tempFile);
            
            return result;
        } catch (IOException e) {
            throw new RuntimeException("å¤„ç†æ•°æ®å¤±è´¥", e);
        }
        // âŒ ä¸´æ—¶æ–‡ä»¶æ²¡æœ‰åˆ é™¤
    }
    
    // âŒ é”èµ„æºæ²¡æœ‰é‡Šæ”¾
    private final ReentrantLock lock = new ReentrantLock();
    
    public void updateSharedResource() {
        lock.lock();
        try {
            // æ›´æ–°å…±äº«èµ„æº
            updateResource();
            
            if (someCondition()) {
                // âŒ æå‰è¿”å›ï¼Œé”æ²¡æœ‰é‡Šæ”¾
                return;
            }
            
            // å…¶ä»–æ“ä½œ
        } catch (Exception e) {
            // âŒ å¼‚å¸¸æƒ…å†µä¸‹é”æ²¡æœ‰é‡Šæ”¾
            throw new RuntimeException("æ›´æ–°å¤±è´¥", e);
        }
        lock.unlock();
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„èµ„æºæ¸…ç†
@Service
public class FileService {
    
    private static final Logger log = LoggerFactory.getLogger(FileService.class);
    
    // âœ… ä½¿ç”¨try-with-resourcesè‡ªåŠ¨å…³é—­èµ„æº
    public String readFile(String fileName) {
        if (fileName == null || fileName.trim().isEmpty()) {
            throw new IllegalArgumentException("æ–‡ä»¶åä¸èƒ½ä¸ºç©º");
        }
        
        try (FileInputStream fis = new FileInputStream(fileName);
             BufferedReader reader = new BufferedReader(new InputStreamReader(fis, StandardCharsets.UTF_8))) {
            
            StringBuilder content = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                content.append(line).append(System.lineSeparator());
            }
            
            log.debug("æ–‡ä»¶è¯»å–æˆåŠŸ: fileName={}, size={}", fileName, content.length());
            return content.toString();
            
        } catch (FileNotFoundException e) {
            log.error("æ–‡ä»¶ä¸å­˜åœ¨: fileName={}", fileName, e);
            throw new FileProcessException("æ–‡ä»¶ä¸å­˜åœ¨: " + fileName, e);
            
        } catch (IOException e) {
            log.error("è¯»å–æ–‡ä»¶å¤±è´¥: fileName={}", fileName, e);
            throw new FileProcessException("è¯»å–æ–‡ä»¶å¤±è´¥: " + fileName, e);
        }
    }
    
    // âœ… å¤šä¸ªèµ„æºçš„æ­£ç¡®ç®¡ç†
    public void writeFile(String fileName, String content) {
        if (fileName == null || content == null) {
            throw new IllegalArgumentException("æ–‡ä»¶åå’Œå†…å®¹ä¸èƒ½ä¸ºç©º");
        }
        
        try (FileOutputStream fos = new FileOutputStream(fileName);
             BufferedWriter writer = new BufferedWriter(
                 new OutputStreamWriter(fos, StandardCharsets.UTF_8))) {
            
            writer.write(content);
            writer.flush(); // ç¡®ä¿æ•°æ®å†™å…¥
            
            log.debug("æ–‡ä»¶å†™å…¥æˆåŠŸ: fileName={}, size={}", fileName, content.length());
            
        } catch (IOException e) {
            log.error("å†™å…¥æ–‡ä»¶å¤±è´¥: fileName={}", fileName, e);
            throw new FileProcessException("å†™å…¥æ–‡ä»¶å¤±è´¥: " + fileName, e);
        }
    }
    
    // âœ… ä¼ ç»Ÿæ–¹å¼çš„å®‰å…¨èµ„æºæ¸…ç†
    public void copyFile(String sourcePath, String targetPath) {
        FileInputStream fis = null;
        FileOutputStream fos = null;
        FileChannel sourceChannel = null;
        FileChannel targetChannel = null;
        
        try {
            fis = new FileInputStream(sourcePath);
            fos = new FileOutputStream(targetPath);
            sourceChannel = fis.getChannel();
            targetChannel = fos.getChannel();
            
            long size = sourceChannel.size();
            long transferred = 0;
            
            while (transferred < size) {
                transferred += targetChannel.transferFrom(sourceChannel, transferred, size - transferred);
            }
            
            log.info("æ–‡ä»¶å¤åˆ¶æˆåŠŸ: from={}, to={}, size={}", sourcePath, targetPath, size);
            
        } catch (IOException e) {
            log.error("æ–‡ä»¶å¤åˆ¶å¤±è´¥: from={}, to={}", sourcePath, targetPath, e);
            throw new FileProcessException("æ–‡ä»¶å¤åˆ¶å¤±è´¥", e);
            
        } finally {
            // âœ… å®‰å…¨åœ°å…³é—­æ‰€æœ‰èµ„æº
            closeQuietly(targetChannel, "target channel");
            closeQuietly(sourceChannel, "source channel");
            closeQuietly(fos, "file output stream");
            closeQuietly(fis, "file input stream");
        }
    }
    
    // âœ… å®‰å…¨çš„èµ„æºå…³é—­å·¥å…·æ–¹æ³•
    private void closeQuietly(Closeable resource, String resourceName) {
        if (resource != null) {
            try {
                resource.close();
                log.debug("èµ„æºå…³é—­æˆåŠŸ: {}", resourceName);
            } catch (IOException e) {
                log.warn("å…³é—­èµ„æºæ—¶å‘ç”Ÿå¼‚å¸¸: {}", resourceName, e);
            }
        }
    }
    
    // âœ… æ•°æ®åº“èµ„æºçš„æ­£ç¡®ç®¡ç†
    @Repository
    public class UserRepository {
        
        private final DataSource dataSource;
        
        public List<User> findUsers(String namePattern) {
            String sql = "SELECT id, name, email, created_at FROM users WHERE name LIKE ? ORDER BY created_at DESC";
            
            try (Connection conn = dataSource.getConnection();
                 PreparedStatement stmt = conn.prepareStatement(sql)) {
                
                stmt.setString(1, "%" + namePattern + "%");
                
                try (ResultSet rs = stmt.executeQuery()) {
                    List<User> users = new ArrayList<>();
                    
                    while (rs.next()) {
                        User user = User.builder()
                            .id(rs.getLong("id"))
                            .name(rs.getString("name"))
                            .email(rs.getString("email"))
                            .createdAt(rs.getTimestamp("created_at").toLocalDateTime())
                            .build();
                        users.add(user);
                    }
                    
                    log.debug("æŸ¥è¯¢ç”¨æˆ·æˆåŠŸ: pattern={}, count={}", namePattern, users.size());
                    return users;
                }
                
            } catch (SQLException e) {
                log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: pattern={}", namePattern, e);
                throw new DataAccessException("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
            }
        }
        
        // âœ… æ‰¹é‡æ“ä½œçš„èµ„æºç®¡ç†
        @Transactional
        public int batchUpdateUsers(List<UserUpdateRequest> requests) {
            String sql = "UPDATE users SET name = ?, email = ?, updated_at = ? WHERE id = ?";
            
            try (Connection conn = dataSource.getConnection();
                 PreparedStatement stmt = conn.prepareStatement(sql)) {
                
                conn.setAutoCommit(false);
                
                for (UserUpdateRequest request : requests) {
                    stmt.setString(1, request.getName());
                    stmt.setString(2, request.getEmail());
                    stmt.setTimestamp(3, Timestamp.valueOf(LocalDateTime.now()));
                    stmt.setLong(4, request.getId());
                    stmt.addBatch();
                }
                
                int[] results = stmt.executeBatch();
                conn.commit();
                
                int totalUpdated = Arrays.stream(results).sum();
                log.info("æ‰¹é‡æ›´æ–°ç”¨æˆ·æˆåŠŸ: count={}", totalUpdated);
                
                return totalUpdated;
                
            } catch (SQLException e) {
                log.error("æ‰¹é‡æ›´æ–°ç”¨æˆ·å¤±è´¥: count={}", requests.size(), e);
                throw new DataAccessException("æ‰¹é‡æ›´æ–°ç”¨æˆ·å¤±è´¥", e);
            }
        }
    }
    
    // âœ… HTTPè¿æ¥çš„æ­£ç¡®ç®¡ç†
    @Component
    public class ApiClient {
        
        private final ObjectMapper objectMapper;
        private final int connectTimeout = 5000;
        private final int readTimeout = 10000;
        
        public <T> ApiResponse<T> callAPI(String url, Object request, Class<T> responseType) {
            HttpURLConnection connection = null;
            
            try {
                URL apiUrl = new URL(url);
                connection = (HttpURLConnection) apiUrl.openConnection();
                
                // é…ç½®è¿æ¥
                connection.setRequestMethod("POST");
                connection.setRequestProperty("Content-Type", "application/json");
                connection.setRequestProperty("Accept", "application/json");
                connection.setConnectTimeout(connectTimeout);
                connection.setReadTimeout(readTimeout);
                connection.setDoOutput(true);
                
                // å‘é€è¯·æ±‚
                try (OutputStream os = connection.getOutputStream();
                     BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(os, StandardCharsets.UTF_8))) {
                    
                    String requestJson = objectMapper.writeValueAsString(request);
                    writer.write(requestJson);
                    writer.flush();
                }
                
                // è¯»å–å“åº”
                int responseCode = connection.getResponseCode();
                
                try (InputStream is = (responseCode >= 200 && responseCode < 300) 
                        ? connection.getInputStream() 
                        : connection.getErrorStream();
                     BufferedReader reader = new BufferedReader(new InputStreamReader(is, StandardCharsets.UTF_8))) {
                    
                    StringBuilder response = new StringBuilder();
                    String line;
                    while ((line = reader.readLine()) != null) {
                        response.append(line);
                    }
                    
                    if (responseCode >= 200 && responseCode < 300) {
                        T responseData = objectMapper.readValue(response.toString(), responseType);
                        log.debug("APIè°ƒç”¨æˆåŠŸ: url={}, responseCode={}", url, responseCode);
                        return ApiResponse.success(responseData);
                    } else {
                        log.warn("APIè°ƒç”¨å¤±è´¥: url={}, responseCode={}, response={}", 
                                url, responseCode, response.toString());
                        return ApiResponse.error("API_ERROR", "APIè°ƒç”¨å¤±è´¥: " + responseCode);
                    }
                }
                
            } catch (MalformedURLException e) {
                log.error("æ— æ•ˆçš„URL: {}", url, e);
                return ApiResponse.error("INVALID_URL", "æ— æ•ˆçš„URL");
                
            } catch (SocketTimeoutException e) {
                log.error("APIè°ƒç”¨è¶…æ—¶: url={}", url, e);
                return ApiResponse.error("TIMEOUT", "APIè°ƒç”¨è¶…æ—¶");
                
            } catch (IOException e) {
                log.error("APIè°ƒç”¨IOå¼‚å¸¸: url={}", url, e);
                return ApiResponse.error("IO_ERROR", "ç½‘ç»œå¼‚å¸¸");
                
            } catch (Exception e) {
                log.error("APIè°ƒç”¨å¼‚å¸¸: url={}", url, e);
                return ApiResponse.error("UNKNOWN_ERROR", "æœªçŸ¥å¼‚å¸¸");
                
            } finally {
                // âœ… ç¡®ä¿è¿æ¥è¢«å…³é—­
                if (connection != null) {
                    try {
                        connection.disconnect();
                        log.debug("HTTPè¿æ¥å·²å…³é—­: url={}", url);
                    } catch (Exception e) {
                        log.warn("å…³é—­HTTPè¿æ¥æ—¶å‘ç”Ÿå¼‚å¸¸: url={}", url, e);
                    }
                }
            }
        }
    }
    
    // âœ… çº¿ç¨‹æ± çš„æ­£ç¡®ç®¡ç†
    @Component
    public class AsyncTaskProcessor {
        
        private final ExecutorService executor;
        private final ScheduledExecutorService scheduler;
        
        public AsyncTaskProcessor() {
            this.executor = Executors.newFixedThreadPool(10, 
                new ThreadFactoryBuilder()
                    .setNameFormat("async-task-%d")
                    .setDaemon(true)
                    .build());
                    
            this.scheduler = Executors.newScheduledThreadPool(2,
                new ThreadFactoryBuilder()
                    .setNameFormat("scheduler-%d")
                    .setDaemon(true)
                    .build());
        }
        
        public CompletableFuture<Void> processDataAsync(List<Data> dataList) {
            List<CompletableFuture<Void>> futures = dataList.stream()
                .map(data -> CompletableFuture.runAsync(() -> {
                    try {
                        processData(data);
                        log.debug("æ•°æ®å¤„ç†å®Œæˆ: id={}", data.getId());
                    } catch (Exception e) {
                        log.error("æ•°æ®å¤„ç†å¤±è´¥: id={}", data.getId(), e);
                        throw new RuntimeException(e);
                    }
                }, executor))
                .collect(Collectors.toList());
                
            return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]));
        }
        
        public void scheduleCleanupTask() {
            scheduler.scheduleAtFixedRate(() -> {
                try {
                    cleanupExpiredData();
                    log.debug("å®šæœŸæ¸…ç†ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
                } catch (Exception e) {
                    log.error("å®šæœŸæ¸…ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
                }
            }, 0, 1, TimeUnit.HOURS);
        }
        
        // âœ… æä¾›å…³é—­æ–¹æ³•
        @PreDestroy
        public void shutdown() {
            log.info("å¼€å§‹å…³é—­å¼‚æ­¥ä»»åŠ¡å¤„ç†å™¨");
            
            // å…³é—­è°ƒåº¦å™¨
            scheduler.shutdown();
            try {
                if (!scheduler.awaitTermination(30, TimeUnit.SECONDS)) {
                    log.warn("è°ƒåº¦å™¨æœªèƒ½åœ¨30ç§’å†…æ­£å¸¸å…³é—­ï¼Œå¼ºåˆ¶å…³é—­");
                    scheduler.shutdownNow();
                }
            } catch (InterruptedException e) {
                log.warn("ç­‰å¾…è°ƒåº¦å™¨å…³é—­æ—¶è¢«ä¸­æ–­");
                scheduler.shutdownNow();
                Thread.currentThread().interrupt();
            }
            
            // å…³é—­æ‰§è¡Œå™¨
            executor.shutdown();
            try {
                if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                    log.warn("æ‰§è¡Œå™¨æœªèƒ½åœ¨60ç§’å†…æ­£å¸¸å…³é—­ï¼Œå¼ºåˆ¶å…³é—­");
                    executor.shutdownNow();
                }
            } catch (InterruptedException e) {
                log.warn("ç­‰å¾…æ‰§è¡Œå™¨å…³é—­æ—¶è¢«ä¸­æ–­");
                executor.shutdownNow();
                Thread.currentThread().interrupt();
            }
            
            log.info("å¼‚æ­¥ä»»åŠ¡å¤„ç†å™¨å…³é—­å®Œæˆ");
        }
    }
    
    // âœ… ä¸´æ—¶æ–‡ä»¶çš„æ­£ç¡®ç®¡ç†
    public String processLargeData(byte[] data) {
        if (data == null || data.length == 0) {
            throw new IllegalArgumentException("æ•°æ®ä¸èƒ½ä¸ºç©º");
        }
        
        Path tempFile = null;
        try {
            // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            tempFile = Files.createTempFile("process", ".tmp");
            log.debug("åˆ›å»ºä¸´æ—¶æ–‡ä»¶: {}", tempFile);
            
            // å†™å…¥æ•°æ®
            Files.write(tempFile, data, StandardOpenOption.WRITE);
            
            // å¤„ç†æ–‡ä»¶
            String result = processFile(tempFile.toFile());
            
            log.debug("æ•°æ®å¤„ç†å®Œæˆ: size={}, result={}", data.length, result.length());
            return result;
            
        } catch (IOException e) {
            log.error("å¤„ç†å¤§æ•°æ®æ—¶IOå¼‚å¸¸: size={}", data.length, e);
            throw new DataProcessException("å¤„ç†æ•°æ®å¤±è´¥", e);
            
        } catch (Exception e) {
            log.error("å¤„ç†å¤§æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: size={}", data.length, e);
            throw new DataProcessException("å¤„ç†æ•°æ®å¤±è´¥", e);
            
        } finally {
            // âœ… ç¡®ä¿ä¸´æ—¶æ–‡ä»¶è¢«åˆ é™¤
            if (tempFile != null) {
                try {
                    Files.deleteIfExists(tempFile);
                    log.debug("ä¸´æ—¶æ–‡ä»¶å·²åˆ é™¤: {}", tempFile);
                } catch (IOException e) {
                    log.warn("åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {}", tempFile, e);
                }
            }
        }
    }
    
    // âœ… é”èµ„æºçš„æ­£ç¡®ç®¡ç†
    @Component
    public class SharedResourceManager {
        
        private final ReentrantLock lock = new ReentrantLock();
        private final ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock();
        private volatile String sharedData;
        
        public void updateSharedResource(String newData) {
            lock.lock();
            try {
                log.debug("å¼€å§‹æ›´æ–°å…±äº«èµ„æº");
                
                // éªŒè¯æ•°æ®
                if (newData == null) {
                    throw new IllegalArgumentException("æ•°æ®ä¸èƒ½ä¸ºç©º");
                }
                
                // æ›´æ–°èµ„æº
                String oldData = this.sharedData;
                this.sharedData = newData;
                
                log.info("å…±äº«èµ„æºæ›´æ–°æˆåŠŸ: old={}, new={}", oldData, newData);
                
            } catch (Exception e) {
                log.error("æ›´æ–°å…±äº«èµ„æºå¤±è´¥: data={}", newData, e);
                throw e;
            } finally {
                // âœ… ç¡®ä¿é”è¢«é‡Šæ”¾
                lock.unlock();
                log.debug("å…±äº«èµ„æºé”å·²é‡Šæ”¾");
            }
        }
        
        public String readSharedResource() {
            rwLock.readLock().lock();
            try {
                log.debug("è¯»å–å…±äº«èµ„æº");
                return this.sharedData;
            } finally {
                // âœ… ç¡®ä¿è¯»é”è¢«é‡Šæ”¾
                rwLock.readLock().unlock();
                log.debug("å…±äº«èµ„æºè¯»é”å·²é‡Šæ”¾");
            }
        }
        
        // âœ… å¸¦è¶…æ—¶çš„é”è·å–
        public boolean tryUpdateWithTimeout(String newData, long timeoutMs) {
            try {
                if (lock.tryLock(timeoutMs, TimeUnit.MILLISECONDS)) {
                    try {
                        this.sharedData = newData;
                        log.info("å¸¦è¶…æ—¶çš„å…±äº«èµ„æºæ›´æ–°æˆåŠŸ: data={}", newData);
                        return true;
                    } finally {
                        lock.unlock();
                    }
                } else {
                    log.warn("è·å–é”è¶…æ—¶: timeout={}ms", timeoutMs);
                    return false;
                }
            } catch (InterruptedException e) {
                log.warn("ç­‰å¾…é”æ—¶è¢«ä¸­æ–­");
                Thread.currentThread().interrupt();
                return false;
            }
        }
    }
    
    // âœ… ç¼“å­˜èµ„æºçš„æ­£ç¡®ç®¡ç†
    @Component
    public class CacheManager {
        
        private final Map<String, CacheEntry> cache = new ConcurrentHashMap<>();
        private final ScheduledExecutorService cleanupScheduler;
        private volatile boolean shutdown = false;
        
        public CacheManager() {
            this.cleanupScheduler = Executors.newSingleThreadScheduledExecutor(
                new ThreadFactoryBuilder()
                    .setNameFormat("cache-cleanup-%d")
                    .setDaemon(true)
                    .build());
                    
            startCleanupTask();
        }
        
        public void put(String key, Object value, Duration ttl) {
            if (shutdown) {
                throw new IllegalStateException("ç¼“å­˜ç®¡ç†å™¨å·²å…³é—­");
            }
            
            CacheEntry entry = new CacheEntry(value, Instant.now().plus(ttl));
            cache.put(key, entry);
            log.debug("ç¼“å­˜é¡¹å·²æ·»åŠ : key={}, ttl={}", key, ttl);
        }
        
        public Optional<Object> get(String key) {
            if (shutdown) {
                return Optional.empty();
            }
            
            CacheEntry entry = cache.get(key);
            if (entry == null || entry.isExpired()) {
                cache.remove(key);
                return Optional.empty();
            }
            
            return Optional.of(entry.getValue());
        }
        
        private void startCleanupTask() {
            cleanupScheduler.scheduleAtFixedRate(() -> {
                if (shutdown) {
                    return;
                }
                
                try {
                    cleanExpiredEntries();
                } catch (Exception e) {
                    log.error("æ¸…ç†è¿‡æœŸç¼“å­˜é¡¹æ—¶å‘ç”Ÿå¼‚å¸¸", e);
                }
            }, 1, 1, TimeUnit.MINUTES);
        }
        
        private void cleanExpiredEntries() {
            int removedCount = 0;
            Iterator<Map.Entry<String, CacheEntry>> iterator = cache.entrySet().iterator();
            
            while (iterator.hasNext()) {
                Map.Entry<String, CacheEntry> entry = iterator.next();
                if (entry.getValue().isExpired()) {
                    iterator.remove();
                    removedCount++;
                }
            }
            
            if (removedCount > 0) {
                log.debug("æ¸…ç†è¿‡æœŸç¼“å­˜é¡¹: count={}, remaining={}", removedCount, cache.size());
            }
        }
        
        // âœ… æä¾›å…³é—­æ–¹æ³•
        @PreDestroy
        public void shutdown() {
            log.info("å¼€å§‹å…³é—­ç¼“å­˜ç®¡ç†å™¨");
            
            shutdown = true;
            
            // å…³é—­æ¸…ç†è°ƒåº¦å™¨
            cleanupScheduler.shutdown();
            try {
                if (!cleanupScheduler.awaitTermination(10, TimeUnit.SECONDS)) {
                    log.warn("æ¸…ç†è°ƒåº¦å™¨æœªèƒ½åœ¨10ç§’å†…æ­£å¸¸å…³é—­ï¼Œå¼ºåˆ¶å…³é—­");
                    cleanupScheduler.shutdownNow();
                }
            } catch (InterruptedException e) {
                log.warn("ç­‰å¾…æ¸…ç†è°ƒåº¦å™¨å…³é—­æ—¶è¢«ä¸­æ–­");
                cleanupScheduler.shutdownNow();
                Thread.currentThread().interrupt();
            }
            
            // æ¸…ç©ºç¼“å­˜
            int cacheSize = cache.size();
            cache.clear();
            
            log.info("ç¼“å­˜ç®¡ç†å™¨å…³é—­å®Œæˆ: æ¸…ç†äº†{}ä¸ªç¼“å­˜é¡¹", cacheSize);
        }
        
        private static class CacheEntry {
            private final Object value;
            private final Instant expireTime;
            
            public CacheEntry(Object value, Instant expireTime) {
                this.value = value;
                this.expireTime = expireTime;
            }
            
            public Object getValue() {
                return value;
            }
            
            public boolean isExpired() {
                return Instant.now().isAfter(expireTime);
            }
        }
    }
}
```

## 4.21.3 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

### 4.21.3.1 äº‹åŠ¡ä¸€è‡´æ€§æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿äº‹åŠ¡è¾¹ç•Œæ­£ç¡®å®šä¹‰ï¼Œé¿å…äº‹åŠ¡èŒƒå›´è¿‡å¤§æˆ–è¿‡å°
b. éªŒè¯äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®åˆç†ï¼Œé˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»
c. æ£€æŸ¥åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§ä¿è¯
d. ç¡®ä¿äº‹åŠ¡å›æ»šæœºåˆ¶æ­£ç¡®å®ç°

**2. æ£€æµ‹æ–¹æ³•**

1. äº‹åŠ¡è¾¹ç•Œåˆ†æå·¥å…·
2. æ•°æ®åº“äº‹åŠ¡æ—¥å¿—åˆ†æ
3. åˆ†å¸ƒå¼äº‹åŠ¡ç›‘æ§å·¥å…·
4. å¹¶å‘æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private NotificationService notificationService;
    
    // âŒ äº‹åŠ¡è¾¹ç•Œè¿‡å¤§ï¼ŒåŒ…å«ä¸å¿…è¦çš„æ“ä½œ
    @Transactional
    public void processOrder(OrderRequest request) {
        // éªŒè¯è®¢å•ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
        validateOrder(request);
        
        // åˆ›å»ºè®¢å•
        Order order = createOrder(request);
        
        // æ‰£å‡åº“å­˜
        inventoryService.reduceStock(request.getProductId(), request.getQuantity());
        
        // å¤„ç†æ”¯ä»˜
        paymentService.processPayment(order.getId(), request.getPaymentInfo());
        
        // âŒ å‘é€é€šçŸ¥ä¸åº”è¯¥åœ¨äº‹åŠ¡ä¸­ï¼Œå¯èƒ½å¯¼è‡´äº‹åŠ¡é•¿æ—¶é—´å ç”¨
        notificationService.sendOrderConfirmation(order.getId());
        
        // âŒ å¤–éƒ¨APIè°ƒç”¨åœ¨äº‹åŠ¡ä¸­ï¼Œå¯èƒ½å¯¼è‡´è¶…æ—¶
        externalApiService.syncOrderToThirdParty(order);
    }
    
    // âŒ äº‹åŠ¡è¾¹ç•Œè¿‡å°ï¼Œæ•°æ®ä¸€è‡´æ€§æ— æ³•ä¿è¯
    public void transferMoney(Long fromAccountId, Long toAccountId, BigDecimal amount) {
        // âŒ ä¸¤ä¸ªæ“ä½œåˆ†åˆ«åœ¨ä¸åŒäº‹åŠ¡ä¸­ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
        debitAccount(fromAccountId, amount);
        creditAccount(toAccountId, amount);
    }
    
    @Transactional
    private void debitAccount(Long accountId, BigDecimal amount) {
        Account account = accountRepository.findById(accountId);
        account.setBalance(account.getBalance().subtract(amount));
        accountRepository.save(account);
    }
    
    @Transactional
    private void creditAccount(Long accountId, BigDecimal amount) {
        Account account = accountRepository.findById(accountId);
        account.setBalance(account.getBalance().add(amount));
        accountRepository.save(account);
    }
    
    // âŒ äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸å½“
    @Transactional(isolation = Isolation.READ_UNCOMMITTED)
    public OrderSummary getOrderSummary(Long orderId) {
        // âŒ å¯èƒ½è¯»å–åˆ°æœªæäº¤çš„æ•°æ®ï¼Œå¯¼è‡´è„è¯»
        Order order = orderRepository.findById(orderId);
        List<OrderItem> items = orderItemRepository.findByOrderId(orderId);
        
        return buildOrderSummary(order, items);
    }
    
    // âŒ æ²¡æœ‰æ­£ç¡®å¤„ç†äº‹åŠ¡å›æ»š
    @Transactional
    public void processPayment(Long orderId, PaymentInfo paymentInfo) {
        try {
            Order order = orderRepository.findById(orderId);
            
            // å¤„ç†æ”¯ä»˜
            PaymentResult result = paymentGateway.charge(paymentInfo, order.getAmount());
            
            if (result.isSuccess()) {
                order.setStatus(OrderStatus.PAID);
                orderRepository.save(order);
            } else {
                // âŒ æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
                order.setStatus(OrderStatus.PAYMENT_FAILED);
                orderRepository.save(order);
            }
            
        } catch (PaymentException e) {
            // âŒ æ•è·å¼‚å¸¸ä½†æ²¡æœ‰é‡æ–°æŠ›å‡ºï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
            log.error("æ”¯ä»˜å¤±è´¥", e);
        }
    }
    
    // âŒ åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜
    @Transactional
    public void createOrderWithInventory(OrderRequest request) {
        // æœ¬åœ°äº‹åŠ¡ï¼šåˆ›å»ºè®¢å•
        Order order = createOrder(request);
        
        // âŒ è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Œä¸åœ¨åŒä¸€äº‹åŠ¡ä¸­
        try {
            inventoryService.reserveStock(request.getProductId(), request.getQuantity());
        } catch (Exception e) {
            // âŒ è¿œç¨‹è°ƒç”¨å¤±è´¥ï¼Œä½†æœ¬åœ°äº‹åŠ¡å·²æäº¤ï¼Œæ•°æ®ä¸ä¸€è‡´
            throw new OrderProcessException("åº“å­˜é¢„ç•™å¤±è´¥", e);
        }
    }
    
    // âŒ åµŒå¥—äº‹åŠ¡å¤„ç†ä¸å½“
    @Transactional
    public void processComplexOrder(OrderRequest request) {
        Order order = createOrder(request);
        
        for (OrderItem item : request.getItems()) {
            // âŒ åµŒå¥—äº‹åŠ¡å¯èƒ½å¯¼è‡´éƒ¨åˆ†æäº¤
            processOrderItem(order.getId(), item);
        }
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    private void processOrderItem(Long orderId, OrderItem item) {
        // âŒ æ¯ä¸ªitemåœ¨ç‹¬ç«‹äº‹åŠ¡ä¸­ï¼Œå¦‚æœåç»­itemå¤±è´¥ï¼Œå‰é¢çš„itemå·²æäº¤
        orderItemRepository.save(item);
        inventoryService.reduceStock(item.getProductId(), item.getQuantity());
    }
    
    // âŒ åªè¯»äº‹åŠ¡ä¸­è¿›è¡Œå†™æ“ä½œ
    @Transactional(readOnly = true)
    public OrderStatistics calculateOrderStatistics(Date startDate, Date endDate) {
        List<Order> orders = orderRepository.findByDateRange(startDate, endDate);
        
        OrderStatistics stats = new OrderStatistics();
        stats.setTotalOrders(orders.size());
        stats.setTotalAmount(orders.stream()
            .map(Order::getAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add));
        
        // âŒ åœ¨åªè¯»äº‹åŠ¡ä¸­ä¿å­˜ç»Ÿè®¡ç»“æœ
        statisticsRepository.save(stats);
        
        return stats;
    }
    
    // âŒ äº‹åŠ¡è¶…æ—¶è®¾ç½®ä¸åˆç†
    @Transactional(timeout = 1) // 1ç§’è¶…æ—¶å¤ªçŸ­
    public void batchProcessOrders(List<OrderRequest> requests) {
        for (OrderRequest request : requests) {
            // âŒ æ‰¹é‡å¤„ç†å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œ1ç§’è¶…æ—¶ä¸åˆç†
            processOrder(request);
        }
    }
    
    // âŒ å¼‚æ­¥æ“ä½œåœ¨äº‹åŠ¡ä¸­
    @Transactional
    public void processOrderAsync(OrderRequest request) {
        Order order = createOrder(request);
        
        // âŒ å¼‚æ­¥æ“ä½œä¸åœ¨äº‹åŠ¡èŒƒå›´å†…
        CompletableFuture.runAsync(() -> {
            inventoryService.reduceStock(request.getProductId(), request.getQuantity());
        });
    }
    
    // âŒ äº‹åŠ¡ä¼ æ’­è¡Œä¸ºä¸å½“
    @Transactional(propagation = Propagation.NOT_SUPPORTED)
    public void updateOrderStatus(Long orderId, OrderStatus status) {
        // âŒ ä¸æ”¯æŒäº‹åŠ¡ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
        Order order = orderRepository.findById(orderId);
        order.setStatus(status);
        order.setUpdatedAt(LocalDateTime.now());
        orderRepository.save(order);
        
        // åŒæ—¶æ›´æ–°ç›¸å…³è¡¨
        orderHistoryRepository.save(new OrderHistory(orderId, status, LocalDateTime.now()));
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šäº‹åŠ¡ä¸€è‡´æ€§ä¿è¯
@Service
@Slf4j
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private NotificationService notificationService;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    // âœ… åˆç†çš„äº‹åŠ¡è¾¹ç•Œ
    @Transactional(rollbackFor = Exception.class)
    public OrderResult processOrder(OrderRequest request) {
        try {
            // 1. éªŒè¯è®¢å•ï¼ˆåœ¨äº‹åŠ¡å¤–è¿›è¡Œï¼‰
            validateOrderRequest(request);
            
            // 2. åˆ›å»ºè®¢å•
            Order order = createOrder(request);
            
            // 3. æ‰£å‡åº“å­˜
            inventoryService.reduceStock(request.getProductId(), request.getQuantity());
            
            // 4. å¤„ç†æ”¯ä»˜
            PaymentResult paymentResult = paymentService.processPayment(
                order.getId(), request.getPaymentInfo());
            
            if (!paymentResult.isSuccess()) {
                throw new PaymentException("æ”¯ä»˜å¤±è´¥: " + paymentResult.getErrorMessage());
            }
            
            // 5. æ›´æ–°è®¢å•çŠ¶æ€
            order.setStatus(OrderStatus.PAID);
            order.setPaymentId(paymentResult.getPaymentId());
            orderRepository.save(order);
            
            log.info("è®¢å•å¤„ç†æˆåŠŸ: orderId={}, amount={}", order.getId(), order.getAmount());
            
            // 6. å‘å¸ƒäº‹ä»¶ï¼ˆäº‹åŠ¡æäº¤åå¼‚æ­¥å¤„ç†é€šçŸ¥ï¼‰
            eventPublisher.publishEvent(new OrderProcessedEvent(order.getId()));
            
            return OrderResult.success(order.getId());
            
        } catch (ValidationException e) {
            log.warn("è®¢å•éªŒè¯å¤±è´¥: {}", e.getMessage());
            throw e;
        } catch (InsufficientStockException e) {
            log.warn("åº“å­˜ä¸è¶³: productId={}, requested={}", 
                    request.getProductId(), request.getQuantity());
            throw e;
        } catch (PaymentException e) {
            log.error("æ”¯ä»˜å¤„ç†å¤±è´¥: orderId={}", request.getProductId(), e);
            throw e;
        } catch (Exception e) {
            log.error("è®¢å•å¤„ç†å¼‚å¸¸: request={}", request, e);
            throw new OrderProcessException("è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }
    
    // âœ… åŸå­æ€§è½¬è´¦æ“ä½œ
    @Transactional(rollbackFor = Exception.class, isolation = Isolation.READ_COMMITTED)
    public TransferResult transferMoney(TransferRequest request) {
        validateTransferRequest(request);
        
        try {
            // 1. åŠ é”é˜²æ­¢å¹¶å‘é—®é¢˜
            Account fromAccount = accountRepository.findByIdForUpdate(request.getFromAccountId());
            Account toAccount = accountRepository.findByIdForUpdate(request.getToAccountId());
            
            if (fromAccount == null || toAccount == null) {
                throw new AccountNotFoundException("è´¦æˆ·ä¸å­˜åœ¨");
            }
            
            // 2. æ£€æŸ¥ä½™é¢
            if (fromAccount.getBalance().compareTo(request.getAmount()) < 0) {
                throw new InsufficientBalanceException("ä½™é¢ä¸è¶³");
            }
            
            // 3. æ‰§è¡Œè½¬è´¦
            fromAccount.setBalance(fromAccount.getBalance().subtract(request.getAmount()));
            toAccount.setBalance(toAccount.getBalance().add(request.getAmount()));
            
            // 4. ä¿å­˜è´¦æˆ·çŠ¶æ€
            accountRepository.save(fromAccount);
            accountRepository.save(toAccount);
            
            // 5. è®°å½•è½¬è´¦å†å²
            TransferHistory history = TransferHistory.builder()
                .fromAccountId(request.getFromAccountId())
                .toAccountId(request.getToAccountId())
                .amount(request.getAmount())
                .status(TransferStatus.SUCCESS)
                .createdAt(LocalDateTime.now())
                .build();
            transferHistoryRepository.save(history);
            
            log.info("è½¬è´¦æˆåŠŸ: from={}, to={}, amount={}", 
                    request.getFromAccountId(), request.getToAccountId(), request.getAmount());
            
            return TransferResult.success(history.getId());
            
        } catch (Exception e) {
            log.error("è½¬è´¦å¤±è´¥: request={}", request, e);
            throw e;
        }
    }
    
    // âœ… åˆé€‚çš„äº‹åŠ¡éš”ç¦»çº§åˆ«
    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)
    public OrderSummary getOrderSummary(Long orderId) {
        try {
            Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
            
            List<OrderItem> items = orderItemRepository.findByOrderId(orderId);
            
            PaymentInfo paymentInfo = null;
            if (order.getPaymentId() != null) {
                paymentInfo = paymentService.getPaymentInfo(order.getPaymentId());
            }
            
            return OrderSummary.builder()
                .order(order)
                .items(items)
                .paymentInfo(paymentInfo)
                .build();
                
        } catch (Exception e) {
            log.error("è·å–è®¢å•æ‘˜è¦å¤±è´¥: orderId={}", orderId, e);
            throw new OrderQueryException("è·å–è®¢å•æ‘˜è¦å¤±è´¥", e);
        }
    }
    
    // âœ… æ­£ç¡®çš„äº‹åŠ¡å›æ»šå¤„ç†
    @Transactional(rollbackFor = Exception.class)
    public PaymentResult processPayment(Long orderId, PaymentInfo paymentInfo) {
        try {
            Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
            
            if (order.getStatus() != OrderStatus.PENDING) {
                throw new InvalidOrderStatusException(
                    "è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜: " + order.getStatus());
            }
            
            // å¤„ç†æ”¯ä»˜
            PaymentResult result = paymentGateway.charge(paymentInfo, order.getAmount());
            
            if (result.isSuccess()) {
                order.setStatus(OrderStatus.PAID);
                order.setPaymentId(result.getPaymentId());
                order.setPaidAt(LocalDateTime.now());
                orderRepository.save(order);
                
                log.info("æ”¯ä»˜æˆåŠŸ: orderId={}, paymentId={}", orderId, result.getPaymentId());
                return result;
            } else {
                // âœ… æ”¯ä»˜å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘äº‹åŠ¡å›æ»š
                throw new PaymentFailedException(
                    "æ”¯ä»˜å¤±è´¥: " + result.getErrorMessage(), result.getErrorCode());
            }
            
        } catch (PaymentException e) {
            log.error("æ”¯ä»˜å¤„ç†å¼‚å¸¸: orderId={}", orderId, e);
            // âœ… é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œç¡®ä¿äº‹åŠ¡å›æ»š
            throw e;
        } catch (Exception e) {
            log.error("æ”¯ä»˜å¤„ç†æœªçŸ¥å¼‚å¸¸: orderId={}", orderId, e);
            throw new PaymentProcessException("æ”¯ä»˜å¤„ç†å¤±è´¥", e);
        }
    }
    
    // âœ… åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ï¼ˆä½¿ç”¨Sagaæ¨¡å¼ï¼‰
    @Transactional(rollbackFor = Exception.class)
    public OrderResult createOrderWithSaga(OrderRequest request) {
        try {
            // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
            Order order = createOrder(request);
            
            // 2. åˆ›å»ºSagaäº‹åŠ¡
            SagaTransaction saga = sagaManager.begin("CREATE_ORDER_" + order.getId());
            
            try {
                // 3. é¢„ç•™åº“å­˜ï¼ˆè¡¥å¿æ“ä½œï¼šé‡Šæ”¾åº“å­˜ï¼‰
                InventoryReservation reservation = inventoryService.reserveStock(
                    request.getProductId(), request.getQuantity());
                saga.addCompensation(() -> 
                    inventoryService.releaseReservation(reservation.getId()));
                
                // 4. é¢„æˆæƒæ”¯ä»˜ï¼ˆè¡¥å¿æ“ä½œï¼šå–æ¶ˆé¢„æˆæƒï¼‰
                PaymentPreAuth preAuth = paymentService.preAuthorize(
                    request.getPaymentInfo(), order.getAmount());
                saga.addCompensation(() -> 
                    paymentService.cancelPreAuth(preAuth.getId()));
                
                // 5. ç¡®è®¤è®¢å•
                order.setStatus(OrderStatus.CONFIRMED);
                order.setInventoryReservationId(reservation.getId());
                order.setPaymentPreAuthId(preAuth.getId());
                orderRepository.save(order);
                
                // 6. æäº¤Sagaäº‹åŠ¡
                saga.commit();
                
                log.info("è®¢å•åˆ›å»ºæˆåŠŸï¼ˆSagaï¼‰: orderId={}", order.getId());
                return OrderResult.success(order.getId());
                
            } catch (Exception e) {
                // âœ… Sagaäº‹åŠ¡å›æ»šï¼Œæ‰§è¡Œè¡¥å¿æ“ä½œ
                saga.rollback();
                throw e;
            }
            
        } catch (Exception e) {
            log.error("è®¢å•åˆ›å»ºå¤±è´¥ï¼ˆSagaï¼‰: request={}", request, e);
            throw new OrderProcessException("è®¢å•åˆ›å»ºå¤±è´¥", e);
        }
    }
    
    // âœ… æ­£ç¡®çš„åµŒå¥—äº‹åŠ¡å¤„ç†
    @Transactional(rollbackFor = Exception.class)
    public void processComplexOrder(OrderRequest request) {
        try {
            Order order = createOrder(request);
            
            List<OrderItemResult> itemResults = new ArrayList<>();;
            
            // âœ… æ‰€æœ‰itemåœ¨åŒä¸€äº‹åŠ¡ä¸­å¤„ç†
            for (OrderItem item : request.getItems()) {
                OrderItemResult result = processOrderItemInSameTransaction(order.getId(), item);
                itemResults.add(result);
            }
            
            // éªŒè¯æ‰€æœ‰itemå¤„ç†ç»“æœ
            boolean allSuccess = itemResults.stream().allMatch(OrderItemResult::isSuccess);
            if (!allSuccess) {
                throw new OrderItemProcessException("éƒ¨åˆ†è®¢å•é¡¹å¤„ç†å¤±è´¥");
            }
            
            order.setStatus(OrderStatus.PROCESSED);
            orderRepository.save(order);
            
            log.info("å¤æ‚è®¢å•å¤„ç†æˆåŠŸ: orderId={}, itemCount={}", 
                    order.getId(), itemResults.size());
                    
        } catch (Exception e) {
            log.error("å¤æ‚è®¢å•å¤„ç†å¤±è´¥: request={}", request, e);
            throw e;
        }
    }
    
    // âœ… åœ¨åŒä¸€äº‹åŠ¡ä¸­å¤„ç†è®¢å•é¡¹
    private OrderItemResult processOrderItemInSameTransaction(Long orderId, OrderItem item) {
        try {
            // ä¿å­˜è®¢å•é¡¹
            item.setOrderId(orderId);
            orderItemRepository.save(item);
            
            // æ‰£å‡åº“å­˜
            inventoryService.reduceStock(item.getProductId(), item.getQuantity());
            
            return OrderItemResult.success(item.getId());
            
        } catch (Exception e) {
            log.error("è®¢å•é¡¹å¤„ç†å¤±è´¥: orderId={}, item={}", orderId, item, e);
            return OrderItemResult.failure(e.getMessage());
        }
    }
    
    // âœ… åˆ†ç¦»è¯»å†™æ“ä½œ
    @Transactional(readOnly = true)
    public OrderStatistics calculateOrderStatistics(Date startDate, Date endDate) {
        try {
            List<Order> orders = orderRepository.findByDateRange(startDate, endDate);
            
            OrderStatistics stats = OrderStatistics.builder()
                .totalOrders(orders.size())
                .totalAmount(orders.stream()
                    .map(Order::getAmount)
                    .reduce(BigDecimal.ZERO, BigDecimal::add))
                .averageAmount(calculateAverageAmount(orders))
                .startDate(startDate)
                .endDate(endDate)
                .calculatedAt(LocalDateTime.now())
                .build();
            
            log.debug("è®¢å•ç»Ÿè®¡è®¡ç®—å®Œæˆ: period={} to {}, totalOrders={}", 
                    startDate, endDate, stats.getTotalOrders());
            
            return stats;
            
        } catch (Exception e) {
            log.error("è®¡ç®—è®¢å•ç»Ÿè®¡å¤±è´¥: startDate={}, endDate={}", startDate, endDate, e);
            throw new StatisticsCalculationException("è®¡ç®—è®¢å•ç»Ÿè®¡å¤±è´¥", e);
        }
    }
    
    // âœ… å•ç‹¬çš„å†™æ“ä½œ
    @Transactional(rollbackFor = Exception.class)
    public void saveOrderStatistics(OrderStatistics statistics) {
        try {
            statisticsRepository.save(statistics);
            log.info("è®¢å•ç»Ÿè®¡ä¿å­˜æˆåŠŸ: period={} to {}", 
                    statistics.getStartDate(), statistics.getEndDate());
        } catch (Exception e) {
            log.error("ä¿å­˜è®¢å•ç»Ÿè®¡å¤±è´¥: statistics={}", statistics, e);
            throw new StatisticsSaveException("ä¿å­˜è®¢å•ç»Ÿè®¡å¤±è´¥", e);
        }
    }
    
    // âœ… åˆç†çš„äº‹åŠ¡è¶…æ—¶è®¾ç½®
    @Transactional(rollbackFor = Exception.class, timeout = 300) // 5åˆ†é’Ÿ
    public BatchProcessResult batchProcessOrders(List<OrderRequest> requests) {
        if (requests.size() > 1000) {
            throw new IllegalArgumentException("æ‰¹é‡å¤„ç†è®¢å•æ•°é‡ä¸èƒ½è¶…è¿‡1000");
        }
        
        try {
            List<OrderResult> results = new ArrayList<>();
            int successCount = 0;
            int failureCount = 0;
            
            for (OrderRequest request : requests) {
                try {
                    OrderResult result = processOrderInBatch(request);
                    results.add(result);
                    if (result.isSuccess()) {
                        successCount++;
                    } else {
                        failureCount++;
                    }
                } catch (Exception e) {
                    log.warn("æ‰¹é‡å¤„ç†ä¸­å•ä¸ªè®¢å•å¤±è´¥: request={}", request, e);
                    results.add(OrderResult.failure(e.getMessage()));
                    failureCount++;
                }
            }
            
            log.info("æ‰¹é‡è®¢å•å¤„ç†å®Œæˆ: total={}, success={}, failure={}", 
                    requests.size(), successCount, failureCount);
            
            return BatchProcessResult.builder()
                .totalCount(requests.size())
                .successCount(successCount)
                .failureCount(failureCount)
                .results(results)
                .build();
                
        } catch (Exception e) {
            log.error("æ‰¹é‡è®¢å•å¤„ç†å¼‚å¸¸: count={}", requests.size(), e);
            throw new BatchProcessException("æ‰¹é‡è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }
    
    // âœ… äº‹åŠ¡å¤–å¼‚æ­¥å¤„ç†
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handleOrderProcessedEvent(OrderProcessedEvent event) {
        // âœ… äº‹åŠ¡æäº¤åå¼‚æ­¥å¤„ç†é€šçŸ¥
        CompletableFuture.runAsync(() -> {
            try {
                notificationService.sendOrderConfirmation(event.getOrderId());
                externalApiService.syncOrderToThirdParty(event.getOrderId());
                log.info("è®¢å•åç»­å¤„ç†å®Œæˆ: orderId={}", event.getOrderId());
            } catch (Exception e) {
                log.error("è®¢å•åç»­å¤„ç†å¤±è´¥: orderId={}", event.getOrderId(), e);
            }
        });
    }
    
    // âœ… æ­£ç¡®çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸º
    @Transactional(rollbackFor = Exception.class, propagation = Propagation.REQUIRED)
    public void updateOrderStatus(Long orderId, OrderStatus status, String reason) {
        try {
            Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
            
            OrderStatus oldStatus = order.getStatus();
            
            // éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
            if (!isValidStatusTransition(oldStatus, status)) {
                throw new InvalidStatusTransitionException(
                    String.format("æ— æ•ˆçš„çŠ¶æ€è½¬æ¢: %s -> %s", oldStatus, status));
            }
            
            // æ›´æ–°è®¢å•çŠ¶æ€
            order.setStatus(status);
            order.setUpdatedAt(LocalDateTime.now());
            orderRepository.save(order);
            
            // è®°å½•çŠ¶æ€å˜æ›´å†å²
            OrderStatusHistory history = OrderStatusHistory.builder()
                .orderId(orderId)
                .fromStatus(oldStatus)
                .toStatus(status)
                .reason(reason)
                .createdAt(LocalDateTime.now())
                .build();
            orderStatusHistoryRepository.save(history);
            
            log.info("è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ: orderId={}, {} -> {}, reason={}", 
                    orderId, oldStatus, status, reason);
                    
        } catch (Exception e) {
            log.error("è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥: orderId={}, status={}", orderId, status, e);
            throw e;
        }
    }
    
    // âœ… ä¹è§‚é”å¤„ç†å¹¶å‘æ›´æ–°
    @Transactional(rollbackFor = Exception.class)
    public void updateOrderWithOptimisticLock(Long orderId, OrderUpdateRequest request) {
        int maxRetries = 3;
        int retryCount = 0;
        
        while (retryCount < maxRetries) {
            try {
                Order order = orderRepository.findById(orderId)
                    .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
                
                // æ›´æ–°è®¢å•ä¿¡æ¯
                order.setDeliveryAddress(request.getDeliveryAddress());
                order.setRemark(request.getRemark());
                order.setUpdatedAt(LocalDateTime.now());
                
                orderRepository.save(order);
                
                log.info("è®¢å•æ›´æ–°æˆåŠŸ: orderId={}, version={}", orderId, order.getVersion());
                return;
                
            } catch (OptimisticLockingFailureException e) {
                retryCount++;
                if (retryCount >= maxRetries) {
                    log.error("è®¢å•æ›´æ–°å¤±è´¥ï¼Œè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°: orderId={}, retries={}", 
                            orderId, retryCount);
                    throw new ConcurrentUpdateException("è®¢å•æ­£åœ¨è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·ç¨åé‡è¯•");
                }
                
                log.warn("è®¢å•æ›´æ–°å†²çªï¼Œå‡†å¤‡é‡è¯•: orderId={}, retry={}", orderId, retryCount);
                
                try {
                    Thread.sleep(100 * retryCount); // é€€é¿é‡è¯•
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new RuntimeException("é‡è¯•è¢«ä¸­æ–­", ie);
                }
            }
        }
    }
    
    // è¾…åŠ©æ–¹æ³•
    private void validateOrderRequest(OrderRequest request) {
        if (request == null) {
            throw new ValidationException("è®¢å•è¯·æ±‚ä¸èƒ½ä¸ºç©º");
        }
        if (request.getProductId() == null) {
            throw new ValidationException("äº§å“IDä¸èƒ½ä¸ºç©º");
        }
        if (request.getQuantity() <= 0) {
            throw new ValidationException("æ•°é‡å¿…é¡»å¤§äº0");
        }
        if (request.getPaymentInfo() == null) {
            throw new ValidationException("æ”¯ä»˜ä¿¡æ¯ä¸èƒ½ä¸ºç©º");
        }
    }
    
    private boolean isValidStatusTransition(OrderStatus from, OrderStatus to) {
        // å®šä¹‰åˆæ³•çš„çŠ¶æ€è½¬æ¢è§„åˆ™
        Map<OrderStatus, Set<OrderStatus>> validTransitions = Map.of(
            OrderStatus.PENDING, Set.of(OrderStatus.CONFIRMED, OrderStatus.CANCELLED),
            OrderStatus.CONFIRMED, Set.of(OrderStatus.PAID, OrderStatus.CANCELLED),
            OrderStatus.PAID, Set.of(OrderStatus.SHIPPED, OrderStatus.REFUNDED),
            OrderStatus.SHIPPED, Set.of(OrderStatus.DELIVERED, OrderStatus.RETURNED),
            OrderStatus.DELIVERED, Set.of(OrderStatus.COMPLETED, OrderStatus.RETURNED)
        );
        
        return validTransitions.getOrDefault(from, Set.of()).contains(to);
    }
}
```

### 4.21.3.2 æ•°æ®æ ¡éªŒå®Œæ•´æ€§æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿è¾“å…¥æ•°æ®çš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§éªŒè¯
b. éªŒè¯ä¸šåŠ¡è§„åˆ™çº¦æŸçš„æ­£ç¡®å®ç°
c. æ£€æŸ¥æ•°æ®åº“å±‚é¢çš„ä¸€è‡´æ€§çº¦æŸ
d. ç¡®ä¿è·¨ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§éªŒè¯

**2. æ£€æµ‹æ–¹æ³•**

1. æ•°æ®éªŒè¯æ¡†æ¶æ£€æŸ¥ï¼ˆBean Validationï¼‰
2. ä¸šåŠ¡è§„åˆ™æµ‹è¯•
3. æ•°æ®åº“çº¦æŸéªŒè¯
4. é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æ•°æ®æ ¡éªŒå®Œæ•´æ€§é—®é¢˜
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    // âŒ ç¼ºå°‘è¾“å…¥éªŒè¯
    @PostMapping
    public ResponseEntity<User> createUser(@RequestBody UserCreateRequest request) {
        // âŒ æ²¡æœ‰éªŒè¯è¯·æ±‚å‚æ•°
        User user = userService.createUser(request);
        return ResponseEntity.ok(user);
    }
    
    // âŒ éªŒè¯ä¸å®Œæ•´
    @PutMapping("/{id}")
    public ResponseEntity<User> updateUser(
            @PathVariable Long id, 
            @RequestBody UserUpdateRequest request) {
        // âŒ åªéªŒè¯äº†éƒ¨åˆ†å­—æ®µ
        if (request.getEmail() == null) {
            throw new ValidationException("é‚®ç®±ä¸èƒ½ä¸ºç©º");
        }
        
        User user = userService.updateUser(id, request);
        return ResponseEntity.ok(user);
    }
}

@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private EmailService emailService;
    
    // âŒ ä¸šåŠ¡è§„åˆ™éªŒè¯ä¸å®Œæ•´
    public User createUser(UserCreateRequest request) {
        // âŒ æ²¡æœ‰éªŒè¯é‚®ç®±æ ¼å¼
        // âŒ æ²¡æœ‰éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
        // âŒ æ²¡æœ‰éªŒè¯å¯†ç å¼ºåº¦
        
        User user = new User();
        user.setUsername(request.getUsername());
        user.setEmail(request.getEmail());
        user.setPassword(request.getPassword()); // âŒ æ˜æ–‡å¯†ç 
        user.setAge(request.getAge());
        
        return userRepository.save(user);
    }
    
    // âŒ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ç¼ºå¤±
    public void transferUserData(Long fromUserId, Long toUserId) {
        User fromUser = userRepository.findById(fromUserId);
        User toUser = userRepository.findById(toUserId);
        
        // âŒ æ²¡æœ‰éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        // âŒ æ²¡æœ‰éªŒè¯ä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚ç”¨æˆ·çŠ¶æ€ï¼‰
        
        fromUser.setStatus(UserStatus.INACTIVE);
        toUser.setPoints(toUser.getPoints() + fromUser.getPoints());
        fromUser.setPoints(0);
        
        userRepository.save(fromUser);
        userRepository.save(toUser);
    }
    
    // âŒ æ‰¹é‡æ“ä½œç¼ºå°‘éªŒè¯
    public void batchUpdateUsers(List<UserUpdateRequest> requests) {
        for (UserUpdateRequest request : requests) {
            // âŒ æ²¡æœ‰éªŒè¯æ¯ä¸ªè¯·æ±‚çš„æœ‰æ•ˆæ€§
            User user = userRepository.findById(request.getId());
            user.setEmail(request.getEmail());
            user.setPhone(request.getPhone());
            userRepository.save(user);
        }
    }
    
    // âŒ è·¨ç³»ç»Ÿæ•°æ®åŒæ­¥ç¼ºå°‘éªŒè¯
    public void syncUserToExternalSystem(Long userId) {
        User user = userRepository.findById(userId);
        
        // âŒ æ²¡æœ‰éªŒè¯ç”¨æˆ·æ•°æ®å®Œæ•´æ€§
        // âŒ æ²¡æœ‰éªŒè¯å¤–éƒ¨ç³»ç»Ÿçš„å“åº”
        
        ExternalUserDto externalUser = new ExternalUserDto();
        externalUser.setId(user.getId());
        externalUser.setName(user.getUsername());
        externalUser.setEmail(user.getEmail());
        
        externalSystemClient.createUser(externalUser);
    }
    
    // âŒ æ•°æ®åˆ é™¤ç¼ºå°‘å®Œæ•´æ€§æ£€æŸ¥
    public void deleteUser(Long userId) {
        // âŒ æ²¡æœ‰æ£€æŸ¥å…³è”æ•°æ®
        // âŒ æ²¡æœ‰éªŒè¯åˆ é™¤æƒé™
        userRepository.deleteById(userId);
    }
    
    // âŒ æ•°æ®æŸ¥è¯¢ç¼ºå°‘è¾¹ç•Œæ£€æŸ¥
    public List<User> getUsersByAge(int minAge, int maxAge) {
        // âŒ æ²¡æœ‰éªŒè¯å¹´é¾„èŒƒå›´çš„åˆç†æ€§
        return userRepository.findByAgeBetween(minAge, maxAge);
    }
    
    // âŒ æ–‡ä»¶ä¸Šä¼ ç¼ºå°‘éªŒè¯
    public String uploadUserAvatar(Long userId, MultipartFile file) {
        // âŒ æ²¡æœ‰éªŒè¯æ–‡ä»¶ç±»å‹
        // âŒ æ²¡æœ‰éªŒè¯æ–‡ä»¶å¤§å°
        // âŒ æ²¡æœ‰éªŒè¯æ–‡ä»¶å†…å®¹
        
        String fileName = file.getOriginalFilename();
        String filePath = "/uploads/" + fileName;
        
        try {
            file.transferTo(new File(filePath));
        } catch (IOException e) {
            throw new RuntimeException("æ–‡ä»¶ä¸Šä¼ å¤±è´¥", e);
        }
        
        User user = userRepository.findById(userId);
        user.setAvatarUrl(filePath);
        userRepository.save(user);
        
        return filePath;
    }
    
    // âŒ é‡‘é¢è®¡ç®—ç¼ºå°‘ç²¾åº¦éªŒè¯
    public void updateUserBalance(Long userId, BigDecimal amount) {
        User user = userRepository.findById(userId);
        
        // âŒ æ²¡æœ‰éªŒè¯é‡‘é¢ç²¾åº¦
        // âŒ æ²¡æœ‰éªŒè¯ä½™é¢ä¸èƒ½ä¸ºè´Ÿ
        
        BigDecimal newBalance = user.getBalance().add(amount);
        user.setBalance(newBalance);
        userRepository.save(user);
    }
    
    // âŒ æ—¥æœŸå¤„ç†ç¼ºå°‘éªŒè¯
    public void updateUserBirthday(Long userId, String birthday) {
        User user = userRepository.findById(userId);
        
        // âŒ æ²¡æœ‰éªŒè¯æ—¥æœŸæ ¼å¼
        // âŒ æ²¡æœ‰éªŒè¯æ—¥æœŸåˆç†æ€§ï¼ˆå¦‚æœªæ¥æ—¥æœŸï¼‰
        
        try {
            LocalDate birthDate = LocalDate.parse(birthday);
            user.setBirthday(birthDate);
            userRepository.save(user);
        } catch (DateTimeParseException e) {
            // âŒ å¼‚å¸¸å¤„ç†ä¸å½“
            user.setBirthday(null);
            userRepository.save(user);
        }
    }
    
    // âŒ æšä¸¾å€¼ç¼ºå°‘éªŒè¯
    public void updateUserRole(Long userId, String roleName) {
        User user = userRepository.findById(userId);
        
        // âŒ æ²¡æœ‰éªŒè¯è§’è‰²åç§°æ˜¯å¦æœ‰æ•ˆ
        user.setRole(UserRole.valueOf(roleName)); // å¯èƒ½æŠ›å‡ºIllegalArgumentException
        userRepository.save(user);
    }
    
    // âŒ é›†åˆæ•°æ®ç¼ºå°‘éªŒè¯
    public void updateUserTags(Long userId, List<String> tags) {
        User user = userRepository.findById(userId);
        
        // âŒ æ²¡æœ‰éªŒè¯æ ‡ç­¾æ•°é‡é™åˆ¶
        // âŒ æ²¡æœ‰éªŒè¯æ ‡ç­¾å†…å®¹
        // âŒ æ²¡æœ‰å»é‡å¤„ç†
        
        user.setTags(tags);
        userRepository.save(user);
    }
    
    // âŒ å…³è”æ•°æ®ç¼ºå°‘éªŒè¯
    public void assignUserToGroup(Long userId, Long groupId) {
        User user = userRepository.findById(userId);
        Group group = groupRepository.findById(groupId);
        
        // âŒ æ²¡æœ‰éªŒè¯ç”¨æˆ·å’Œç»„æ˜¯å¦å­˜åœ¨
        // âŒ æ²¡æœ‰éªŒè¯ç”¨æˆ·æ˜¯å¦å·²åœ¨ç»„ä¸­
        // âŒ æ²¡æœ‰éªŒè¯ç»„çš„å®¹é‡é™åˆ¶
        
        user.setGroupId(groupId);
        userRepository.save(user);
    }
}

// âŒ å®ä½“ç±»ç¼ºå°‘éªŒè¯æ³¨è§£
@Entity
@Table(name = "users")
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    // âŒ ç¼ºå°‘éªŒè¯æ³¨è§£
    private String username;
    
    // âŒ ç¼ºå°‘é‚®ç®±æ ¼å¼éªŒè¯
    private String email;
    
    // âŒ ç¼ºå°‘å¯†ç å¼ºåº¦éªŒè¯
    private String password;
    
    // âŒ ç¼ºå°‘å¹´é¾„èŒƒå›´éªŒè¯
    private Integer age;
    
    // âŒ ç¼ºå°‘ä½™é¢ç²¾åº¦éªŒè¯
    private BigDecimal balance;
    
    // âŒ ç¼ºå°‘ç”µè¯å·ç æ ¼å¼éªŒè¯
    private String phone;
    
    // âŒ ç¼ºå°‘URLæ ¼å¼éªŒè¯
    private String avatarUrl;
    
    // âŒ ç¼ºå°‘æ—¥æœŸéªŒè¯
    private LocalDate birthday;
    
    // âŒ ç¼ºå°‘æšä¸¾éªŒè¯
    private UserRole role;
    
    // âŒ ç¼ºå°‘é›†åˆå¤§å°éªŒè¯
    private List<String> tags;
    
    // getterå’Œsetterçœç•¥
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æ•°æ®æ ¡éªŒ
@RestController
@RequestMapping("/api/users")
@Validated
@Slf4j
public class UserController {
    
    @Autowired
    private UserService userService;
    
    // âœ… å®Œæ•´çš„è¾“å…¥éªŒè¯
    @PostMapping
    public ResponseEntity<UserResponse> createUser(
            @Valid @RequestBody UserCreateRequest request) {
        try {
            User user = userService.createUser(request);
            UserResponse response = UserResponse.from(user);
            
            log.info("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: userId={}, username={}", user.getId(), user.getUsername());
            return ResponseEntity.status(HttpStatus.CREATED).body(response);
            
        } catch (ValidationException e) {
            log.warn("ç”¨æˆ·åˆ›å»ºéªŒè¯å¤±è´¥: {}", e.getMessage());
            throw e;
        } catch (Exception e) {
            log.error("ç”¨æˆ·åˆ›å»ºå¤±è´¥: request={}", request, e);
            throw new UserCreationException("ç”¨æˆ·åˆ›å»ºå¤±è´¥", e);
        }
    }
    
    // âœ… è·¯å¾„å‚æ•°å’Œè¯·æ±‚ä½“éªŒè¯
    @PutMapping("/{id}")
    public ResponseEntity<UserResponse> updateUser(
            @PathVariable @Positive Long id,
            @Valid @RequestBody UserUpdateRequest request) {
        try {
            User user = userService.updateUser(id, request);
            UserResponse response = UserResponse.from(user);
            
            log.info("ç”¨æˆ·æ›´æ–°æˆåŠŸ: userId={}", id);
            return ResponseEntity.ok(response);
            
        } catch (UserNotFoundException e) {
            log.warn("ç”¨æˆ·ä¸å­˜åœ¨: userId={}", id);
            throw e;
        } catch (ValidationException e) {
            log.warn("ç”¨æˆ·æ›´æ–°éªŒè¯å¤±è´¥: userId={}, error={}", id, e.getMessage());
            throw e;
        } catch (Exception e) {
            log.error("ç”¨æˆ·æ›´æ–°å¤±è´¥: userId={}, request={}", id, request, e);
            throw new UserUpdateException("ç”¨æˆ·æ›´æ–°å¤±è´¥", e);
        }
    }
    
    // âœ… æŸ¥è¯¢å‚æ•°éªŒè¯
    @GetMapping
    public ResponseEntity<PageResponse<UserResponse>> getUsers(
            @RequestParam(defaultValue = "0") @Min(0) int page,
            @RequestParam(defaultValue = "20") @Min(1) @Max(100) int size,
            @RequestParam(required = false) @Min(0) @Max(150) Integer minAge,
            @RequestParam(required = false) @Min(0) @Max(150) Integer maxAge) {
        try {
            PageRequest pageRequest = PageRequest.of(page, size);
            Page<User> users = userService.getUsers(pageRequest, minAge, maxAge);
            
            List<UserResponse> userResponses = users.getContent().stream()
                .map(UserResponse::from)
                .collect(Collectors.toList());
            
            PageResponse<UserResponse> response = PageResponse.<UserResponse>builder()
                .content(userResponses)
                .page(page)
                .size(size)
                .totalElements(users.getTotalElements())
                .totalPages(users.getTotalPages())
                .build();
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: page={}, size={}, minAge={}, maxAge={}", 
                    page, size, minAge, maxAge, e);
            throw new UserQueryException("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
        }
    }
    
    // âœ… æ–‡ä»¶ä¸Šä¼ éªŒè¯
    @PostMapping("/{id}/avatar")
    public ResponseEntity<String> uploadAvatar(
            @PathVariable @Positive Long id,
            @RequestParam("file") @NotNull MultipartFile file) {
        try {
            String avatarUrl = userService.uploadUserAvatar(id, file);
            
            log.info("å¤´åƒä¸Šä¼ æˆåŠŸ: userId={}, avatarUrl={}", id, avatarUrl);
            return ResponseEntity.ok(avatarUrl);
            
        } catch (InvalidFileException e) {
            log.warn("æ— æ•ˆæ–‡ä»¶: userId={}, fileName={}, error={}", 
                    id, file.getOriginalFilename(), e.getMessage());
            throw e;
        } catch (Exception e) {
            log.error("å¤´åƒä¸Šä¼ å¤±è´¥: userId={}, fileName={}", 
                    id, file.getOriginalFilename(), e);
            throw new FileUploadException("å¤´åƒä¸Šä¼ å¤±è´¥", e);
        }
    }
}

@Service
@Transactional
@Slf4j
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private GroupRepository groupRepository;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private FileStorageService fileStorageService;
    
    @Autowired
    private ExternalSystemClient externalSystemClient;
    
    @Autowired
    private Validator validator;
    
    // âœ… å®Œæ•´çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
    public User createUser(UserCreateRequest request) {
        try {
            // 1. åŸºç¡€éªŒè¯ï¼ˆé€šè¿‡@Validå·²å®Œæˆï¼‰
            
            // 2. ä¸šåŠ¡è§„åˆ™éªŒè¯
            validateUserCreationRules(request);
            
            // 3. åˆ›å»ºç”¨æˆ·
            User user = User.builder()
                .username(request.getUsername().trim())
                .email(request.getEmail().toLowerCase().trim())
                .password(passwordEncoder.encode(request.getPassword()))
                .age(request.getAge())
                .phone(request.getPhone())
                .role(UserRole.USER)
                .status(UserStatus.ACTIVE)
                .balance(BigDecimal.ZERO)
                .createdAt(LocalDateTime.now())
                .updatedAt(LocalDateTime.now())
                .build();
            
            // 4. ä¿å­˜ç”¨æˆ·
            User savedUser = userRepository.save(user);
            
            // 5. å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆå¼‚æ­¥ï¼‰
            emailService.sendWelcomeEmailAsync(savedUser.getEmail(), savedUser.getUsername());
            
            log.info("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: userId={}, username={}, email={}", 
                    savedUser.getId(), savedUser.getUsername(), savedUser.getEmail());
            
            return savedUser;
            
        } catch (ValidationException e) {
            log.warn("ç”¨æˆ·åˆ›å»ºéªŒè¯å¤±è´¥: {}", e.getMessage());
            throw e;
        } catch (Exception e) {
            log.error("ç”¨æˆ·åˆ›å»ºå¼‚å¸¸: request={}", request, e);
            throw new UserCreationException("ç”¨æˆ·åˆ›å»ºå¤±è´¥", e);
        }
    }
    
    // âœ… ä¸šåŠ¡è§„åˆ™éªŒè¯æ–¹æ³•
    private void validateUserCreationRules(UserCreateRequest request) {
        // éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
        if (userRepository.existsByUsername(request.getUsername())) {
            throw new ValidationException("ç”¨æˆ·åå·²å­˜åœ¨: " + request.getUsername());
        }
        
        // éªŒè¯é‚®ç®±å”¯ä¸€æ€§
        if (userRepository.existsByEmail(request.getEmail())) {
            throw new ValidationException("é‚®ç®±å·²è¢«æ³¨å†Œ: " + request.getEmail());
        }
        
        // éªŒè¯æ‰‹æœºå·å”¯ä¸€æ€§ï¼ˆå¦‚æœæä¾›ï¼‰
        if (request.getPhone() != null && userRepository.existsByPhone(request.getPhone())) {
            throw new ValidationException("æ‰‹æœºå·å·²è¢«æ³¨å†Œ: " + request.getPhone());
        }
        
        // éªŒè¯å¯†ç å¼ºåº¦
        validatePasswordStrength(request.getPassword());
        
        // éªŒè¯å¹´é¾„åˆç†æ€§
        if (request.getAge() != null) {
            LocalDate birthDate = LocalDate.now().minusYears(request.getAge());
            if (birthDate.isAfter(LocalDate.now()) || birthDate.isBefore(LocalDate.of(1900, 1, 1))) {
                throw new ValidationException("å¹´é¾„ä¸åˆç†: " + request.getAge());
            }
        }
    }
    
    // âœ… å¯†ç å¼ºåº¦éªŒè¯
    private void validatePasswordStrength(String password) {
        if (password.length() < 8) {
            throw new ValidationException("å¯†ç é•¿åº¦è‡³å°‘8ä½");
        }
        
        boolean hasUpper = password.chars().anyMatch(Character::isUpperCase);
        boolean hasLower = password.chars().anyMatch(Character::isLowerCase);
        boolean hasDigit = password.chars().anyMatch(Character::isDigit);
        boolean hasSpecial = password.chars().anyMatch(ch -> "!@#$%^&*()_+-=[]{}|;:,.<>?".indexOf(ch) >= 0);
        
        int strengthScore = (hasUpper ? 1 : 0) + (hasLower ? 1 : 0) + (hasDigit ? 1 : 0) + (hasSpecial ? 1 : 0);
        
        if (strengthScore < 3) {
            throw new ValidationException("å¯†ç å¼ºåº¦ä¸è¶³ï¼Œéœ€è¦åŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ä¸­çš„è‡³å°‘3ç§");
        }
    }
    
    // âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
    @Transactional(rollbackFor = Exception.class)
    public void transferUserData(TransferUserDataRequest request) {
        try {
            // 1. éªŒè¯è¯·æ±‚å‚æ•°
            validateTransferRequest(request);
            
            // 2. è·å–ç”¨æˆ·ï¼ˆåŠ é”é˜²æ­¢å¹¶å‘ï¼‰
            User fromUser = userRepository.findByIdForUpdate(request.getFromUserId())
                .orElseThrow(() -> new UserNotFoundException("æºç”¨æˆ·ä¸å­˜åœ¨: " + request.getFromUserId()));
            
            User toUser = userRepository.findByIdForUpdate(request.getToUserId())
                .orElseThrow(() -> new UserNotFoundException("ç›®æ ‡ç”¨æˆ·ä¸å­˜åœ¨: " + request.getToUserId()));
            
            // 3. éªŒè¯ä¸šåŠ¡è§„åˆ™
            validateTransferBusinessRules(fromUser, toUser, request);
            
            // 4. æ‰§è¡Œæ•°æ®è½¬ç§»
            BigDecimal transferAmount = request.getAmount();
            
            if (fromUser.getBalance().compareTo(transferAmount) < 0) {
                throw new InsufficientBalanceException("ä½™é¢ä¸è¶³");
            }
            
            fromUser.setBalance(fromUser.getBalance().subtract(transferAmount));
            toUser.setBalance(toUser.getBalance().add(transferAmount));
            
            // 5. è½¬ç§»ç§¯åˆ†
            if (request.isTransferPoints()) {
                toUser.setPoints(toUser.getPoints() + fromUser.getPoints());
                fromUser.setPoints(0);
            }
            
            // 6. æ›´æ–°çŠ¶æ€
            fromUser.setStatus(UserStatus.INACTIVE);
            fromUser.setUpdatedAt(LocalDateTime.now());
            toUser.setUpdatedAt(LocalDateTime.now());
            
            // 7. ä¿å­˜æ›´æ”¹
            userRepository.save(fromUser);
            userRepository.save(toUser);
            
            // 8. è®°å½•è½¬ç§»å†å²
            UserTransferHistory history = UserTransferHistory.builder()
                .fromUserId(request.getFromUserId())
                .toUserId(request.getToUserId())
                .amount(transferAmount)
                .pointsTransferred(request.isTransferPoints() ? fromUser.getPoints() : 0)
                .reason(request.getReason())
                .createdAt(LocalDateTime.now())
                .build();
            
            userTransferHistoryRepository.save(history);
            
            log.info("ç”¨æˆ·æ•°æ®è½¬ç§»æˆåŠŸ: from={}, to={}, amount={}, points={}", 
                    request.getFromUserId(), request.getToUserId(), 
                    transferAmount, request.isTransferPoints());
                    
        } catch (Exception e) {
            log.error("ç”¨æˆ·æ•°æ®è½¬ç§»å¤±è´¥: request={}", request, e);
            throw e;
        }
    }
    
    // âœ… æ‰¹é‡æ“ä½œéªŒè¯
    @Transactional(rollbackFor = Exception.class)
    public BatchUpdateResult batchUpdateUsers(List<UserUpdateRequest> requests) {
        if (requests == null || requests.isEmpty()) {
            throw new ValidationException("æ‰¹é‡æ›´æ–°è¯·æ±‚ä¸èƒ½ä¸ºç©º");
        }
        
        if (requests.size() > 1000) {
            throw new ValidationException("æ‰¹é‡æ›´æ–°æ•°é‡ä¸èƒ½è¶…è¿‡1000");
        }
        
        try {
            List<BatchUpdateResult.Item> results = new ArrayList<>();
            int successCount = 0;
            int failureCount = 0;
            
            for (UserUpdateRequest request : requests) {
                try {
                    // éªŒè¯å•ä¸ªè¯·æ±‚
                    validateSingleUpdateRequest(request);
                    
                    // æ‰§è¡Œæ›´æ–°
                    User user = updateUserInternal(request);
                    
                    results.add(BatchUpdateResult.Item.success(request.getId(), user.getVersion()));
                    successCount++;
                    
                } catch (Exception e) {
                    log.warn("æ‰¹é‡æ›´æ–°ä¸­å•ä¸ªç”¨æˆ·å¤±è´¥: userId={}, error={}", 
                            request.getId(), e.getMessage());
                    
                    results.add(BatchUpdateResult.Item.failure(request.getId(), e.getMessage()));
                    failureCount++;
                }
            }
            
            log.info("æ‰¹é‡ç”¨æˆ·æ›´æ–°å®Œæˆ: total={}, success={}, failure={}", 
                    requests.size(), successCount, failureCount);
            
            return BatchUpdateResult.builder()
                .totalCount(requests.size())
                .successCount(successCount)
                .failureCount(failureCount)
                .items(results)
                .build();
                
        } catch (Exception e) {
            log.error("æ‰¹é‡ç”¨æˆ·æ›´æ–°å¼‚å¸¸: count={}", requests.size(), e);
            throw new BatchUpdateException("æ‰¹é‡ç”¨æˆ·æ›´æ–°å¤±è´¥", e);
        }
    }
    
    // âœ… è·¨ç³»ç»Ÿæ•°æ®åŒæ­¥éªŒè¯
    public void syncUserToExternalSystem(Long userId) {
        try {
            // 1. è·å–ç”¨æˆ·
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
            
            // 2. éªŒè¯ç”¨æˆ·æ•°æ®å®Œæ•´æ€§
            validateUserDataIntegrity(user);
            
            // 3. æ„å»ºå¤–éƒ¨ç³»ç»Ÿæ•°æ®
            ExternalUserDto externalUser = ExternalUserDto.builder()
                .id(user.getId())
                .username(user.getUsername())
                .email(user.getEmail())
                .phone(user.getPhone())
                .status(mapUserStatus(user.getStatus()))
                .createdAt(user.getCreatedAt())
                .updatedAt(user.getUpdatedAt())
                .build();
            
            // 4. éªŒè¯å¤–éƒ¨æ•°æ®
            validateExternalUserData(externalUser);
            
            // 5. åŒæ­¥åˆ°å¤–éƒ¨ç³»ç»Ÿ
            ExternalSyncResult result = externalSystemClient.syncUser(externalUser);
            
            // 6. éªŒè¯åŒæ­¥ç»“æœ
            if (!result.isSuccess()) {
                throw new ExternalSyncException("å¤–éƒ¨ç³»ç»ŸåŒæ­¥å¤±è´¥: " + result.getErrorMessage());
            }
            
            // 7. æ›´æ–°åŒæ­¥çŠ¶æ€
            user.setLastSyncAt(LocalDateTime.now());
            user.setExternalSystemId(result.getExternalId());
            userRepository.save(user);
            
            log.info("ç”¨æˆ·åŒæ­¥åˆ°å¤–éƒ¨ç³»ç»ŸæˆåŠŸ: userId={}, externalId={}", 
                    userId, result.getExternalId());
                    
        } catch (Exception e) {
            log.error("ç”¨æˆ·åŒæ­¥åˆ°å¤–éƒ¨ç³»ç»Ÿå¤±è´¥: userId={}", userId, e);
            throw new ExternalSyncException("ç”¨æˆ·åŒæ­¥å¤±è´¥", e);
        }
    }
    
    // âœ… æ•°æ®åˆ é™¤å®Œæ•´æ€§æ£€æŸ¥
    @Transactional(rollbackFor = Exception.class)
    public void deleteUser(Long userId, String reason) {
        try {
            // 1. è·å–ç”¨æˆ·
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
            
            // 2. éªŒè¯åˆ é™¤æƒé™
            validateDeletePermission(user);
            
            // 3. æ£€æŸ¥å…³è”æ•°æ®
            validateUserDeletionConstraints(userId);
            
            // 4. è½¯åˆ é™¤ç”¨æˆ·
            user.setStatus(UserStatus.DELETED);
            user.setDeletedAt(LocalDateTime.now());
            user.setDeleteReason(reason);
            user.setUpdatedAt(LocalDateTime.now());
            
            userRepository.save(user);
            
            // 5. å¤„ç†å…³è”æ•°æ®
            handleUserDeletionCleanup(userId);
            
            log.info("ç”¨æˆ·åˆ é™¤æˆåŠŸ: userId={}, reason={}", userId, reason);
            
        } catch (Exception e) {
            log.error("ç”¨æˆ·åˆ é™¤å¤±è´¥: userId={}, reason={}", userId, reason, e);
            throw e;
        }
    }
    
    // âœ… æ–‡ä»¶ä¸Šä¼ å®Œæ•´éªŒè¯
    public String uploadUserAvatar(Long userId, MultipartFile file) {
        try {
            // 1. éªŒè¯ç”¨æˆ·å­˜åœ¨
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
            
            // 2. éªŒè¯æ–‡ä»¶
            validateUploadFile(file);
            
            // 3. ä¸Šä¼ æ–‡ä»¶
            String fileName = generateAvatarFileName(userId, file.getOriginalFilename());
            String avatarUrl = fileStorageService.uploadFile(file, "avatars", fileName);
            
            // 4. æ›´æ–°ç”¨æˆ·å¤´åƒ
            String oldAvatarUrl = user.getAvatarUrl();
            user.setAvatarUrl(avatarUrl);
            user.setUpdatedAt(LocalDateTime.now());
            userRepository.save(user);
            
            // 5. åˆ é™¤æ—§å¤´åƒï¼ˆå¼‚æ­¥ï¼‰
            if (oldAvatarUrl != null && !oldAvatarUrl.isEmpty()) {
                fileStorageService.deleteFileAsync(oldAvatarUrl);
            }
            
            log.info("ç”¨æˆ·å¤´åƒä¸Šä¼ æˆåŠŸ: userId={}, avatarUrl={}", userId, avatarUrl);
            return avatarUrl;
            
        } catch (Exception e) {
            log.error("ç”¨æˆ·å¤´åƒä¸Šä¼ å¤±è´¥: userId={}, fileName={}", 
                    userId, file.getOriginalFilename(), e);
            throw e;
        }
    }
    
    // âœ… é‡‘é¢è®¡ç®—ç²¾åº¦éªŒè¯
    @Transactional(rollbackFor = Exception.class)
    public void updateUserBalance(Long userId, BigDecimal amount, String reason) {
        try {
            // 1. éªŒè¯å‚æ•°
            if (amount == null) {
                throw new ValidationException("é‡‘é¢ä¸èƒ½ä¸ºç©º");
            }
            
            // éªŒè¯é‡‘é¢ç²¾åº¦ï¼ˆæœ€å¤š2ä½å°æ•°ï¼‰
            if (amount.scale() > 2) {
                throw new ValidationException("é‡‘é¢ç²¾åº¦ä¸èƒ½è¶…è¿‡2ä½å°æ•°");
            }
            
            // éªŒè¯é‡‘é¢èŒƒå›´
            if (amount.abs().compareTo(new BigDecimal("999999999.99")) > 0) {
                throw new ValidationException("é‡‘é¢è¶…å‡ºå…è®¸èŒƒå›´");
            }
            
            // 2. è·å–ç”¨æˆ·ï¼ˆåŠ é”ï¼‰
            User user = userRepository.findByIdForUpdate(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
            
            // 3. è®¡ç®—æ–°ä½™é¢
            BigDecimal oldBalance = user.getBalance();
            BigDecimal newBalance = oldBalance.add(amount);
            
            // 4. éªŒè¯ä½™é¢ä¸èƒ½ä¸ºè´Ÿ
            if (newBalance.compareTo(BigDecimal.ZERO) < 0) {
                throw new InsufficientBalanceException(
                    String.format("ä½™é¢ä¸è¶³: å½“å‰ä½™é¢=%s, å˜åŠ¨é‡‘é¢=%s", oldBalance, amount));
            }
            
            // 5. æ›´æ–°ä½™é¢
            user.setBalance(newBalance);
            user.setUpdatedAt(LocalDateTime.now());
            userRepository.save(user);
            
            // 6. è®°å½•ä½™é¢å˜åŠ¨å†å²
            BalanceHistory history = BalanceHistory.builder()
                .userId(userId)
                .oldBalance(oldBalance)
                .newBalance(newBalance)
                .amount(amount)
                .reason(reason)
                .createdAt(LocalDateTime.now())
                .build();
            
            balanceHistoryRepository.save(history);
            
            log.info("ç”¨æˆ·ä½™é¢æ›´æ–°æˆåŠŸ: userId={}, oldBalance={}, newBalance={}, amount={}, reason={}", 
                    userId, oldBalance, newBalance, amount, reason);
                    
        } catch (Exception e) {
            log.error("ç”¨æˆ·ä½™é¢æ›´æ–°å¤±è´¥: userId={}, amount={}, reason={}", 
                    userId, amount, reason, e);
            throw e;
        }
    }
    
    // âœ… æ—¥æœŸå¤„ç†éªŒè¯
    public void updateUserBirthday(Long userId, String birthday) {
        try {
            // 1. è·å–ç”¨æˆ·
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
            
            // 2. éªŒè¯æ—¥æœŸæ ¼å¼å’Œåˆç†æ€§
            LocalDate birthDate = validateAndParseBirthday(birthday);
            
            // 3. æ›´æ–°ç”Ÿæ—¥
            user.setBirthday(birthDate);
            user.setAge(calculateAge(birthDate));
            user.setUpdatedAt(LocalDateTime.now());
            
            userRepository.save(user);
            
            log.info("ç”¨æˆ·ç”Ÿæ—¥æ›´æ–°æˆåŠŸ: userId={}, birthday={}, age={}", 
                    userId, birthDate, user.getAge());
                    
        } catch (Exception e) {
            log.error("ç”¨æˆ·ç”Ÿæ—¥æ›´æ–°å¤±è´¥: userId={}, birthday={}", userId, birthday, e);
            throw e;
        }
    }
    
    // âœ… æšä¸¾å€¼éªŒè¯
    public void updateUserRole(Long userId, String roleName) {
        try {
            // 1. éªŒè¯è§’è‰²åç§°
            UserRole role = validateAndParseUserRole(roleName);
            
            // 2. è·å–ç”¨æˆ·
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
            
            // 3. éªŒè¯è§’è‰²å˜æ›´æƒé™
            validateRoleChangePermission(user.getRole(), role);
            
            // 4. æ›´æ–°è§’è‰²
            UserRole oldRole = user.getRole();
            user.setRole(role);
            user.setUpdatedAt(LocalDateTime.now());
            
            userRepository.save(user);
            
            // 5. è®°å½•è§’è‰²å˜æ›´å†å²
            RoleChangeHistory history = RoleChangeHistory.builder()
                .userId(userId)
                .oldRole(oldRole)
                .newRole(role)
                .createdAt(LocalDateTime.now())
                .build();
            
            roleChangeHistoryRepository.save(history);
            
            log.info("ç”¨æˆ·è§’è‰²æ›´æ–°æˆåŠŸ: userId={}, oldRole={}, newRole={}", 
                    userId, oldRole, role);
                    
        } catch (Exception e) {
            log.error("ç”¨æˆ·è§’è‰²æ›´æ–°å¤±è´¥: userId={}, roleName={}", userId, roleName, e);
            throw e;
        }
    }
    
    // âœ… é›†åˆæ•°æ®éªŒè¯
    public void updateUserTags(Long userId, List<String> tags) {
        try {
            // 1. è·å–ç”¨æˆ·
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
            
            // 2. éªŒè¯å’Œå¤„ç†æ ‡ç­¾
            List<String> validatedTags = validateAndProcessTags(tags);
            
            // 3. æ›´æ–°æ ‡ç­¾
            user.setTags(validatedTags);
            user.setUpdatedAt(LocalDateTime.now());
            
            userRepository.save(user);
            
            log.info("ç”¨æˆ·æ ‡ç­¾æ›´æ–°æˆåŠŸ: userId={}, tagCount={}", userId, validatedTags.size());
            
        } catch (Exception e) {
            log.error("ç”¨æˆ·æ ‡ç­¾æ›´æ–°å¤±è´¥: userId={}, tags={}", userId, tags, e);
            throw e;
        }
    }
    
    // âœ… å…³è”æ•°æ®éªŒè¯
    @Transactional(rollbackFor = Exception.class)
    public void assignUserToGroup(Long userId, Long groupId) {
        try {
            // 1. è·å–ç”¨æˆ·å’Œç»„
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
            
            Group group = groupRepository.findById(groupId)
                .orElseThrow(() -> new GroupNotFoundException("ç»„ä¸å­˜åœ¨: " + groupId));
            
            // 2. éªŒè¯åˆ†é…è§„åˆ™
            validateUserGroupAssignment(user, group);
            
            // 3. æ£€æŸ¥ç»„å®¹é‡
            int currentMemberCount = userRepository.countByGroupId(groupId);
            if (currentMemberCount >= group.getMaxMembers()) {
                throw new GroupCapacityExceededException(
                    String.format("ç»„å®¹é‡å·²æ»¡: å½“å‰æˆå‘˜=%d, æœ€å¤§å®¹é‡=%d", 
                            currentMemberCount, group.getMaxMembers()));
            }
            
            // 4. åˆ†é…ç”¨æˆ·åˆ°ç»„
            Long oldGroupId = user.getGroupId();
            user.setGroupId(groupId);
            user.setUpdatedAt(LocalDateTime.now());
            
            userRepository.save(user);
            
            // 5. è®°å½•åˆ†é…å†å²
            GroupAssignmentHistory history = GroupAssignmentHistory.builder()
                .userId(userId)
                .oldGroupId(oldGroupId)
                .newGroupId(groupId)
                .createdAt(LocalDateTime.now())
                .build();
            
            groupAssignmentHistoryRepository.save(history);
            
            log.info("ç”¨æˆ·åˆ†é…åˆ°ç»„æˆåŠŸ: userId={}, oldGroupId={}, newGroupId={}", 
                    userId, oldGroupId, groupId);
                    
        } catch (Exception e) {
            log.error("ç”¨æˆ·åˆ†é…åˆ°ç»„å¤±è´¥: userId={}, groupId={}", userId, groupId, e);
            throw e;
        }
    }
    
    // è¾…åŠ©éªŒè¯æ–¹æ³•
    private void validateUploadFile(MultipartFile file) {
        if (file == null || file.isEmpty()) {
            throw new InvalidFileException("æ–‡ä»¶ä¸èƒ½ä¸ºç©º");
        }
        
        // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
        long maxSize = 5 * 1024 * 1024;
        if (file.getSize() > maxSize) {
            throw new InvalidFileException("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB");
        }
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        String contentType = file.getContentType();
        List<String> allowedTypes = Arrays.asList("image/jpeg", "image/png", "image/gif");
        if (!allowedTypes.contains(contentType)) {
            throw new InvalidFileException("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: " + contentType);
        }
        
        // éªŒè¯æ–‡ä»¶æ‰©å±•å
        String fileName = file.getOriginalFilename();
        if (fileName == null || fileName.isEmpty()) {
            throw new InvalidFileException("æ–‡ä»¶åä¸èƒ½ä¸ºç©º");
        }
        
        String extension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();
        List<String> allowedExtensions = Arrays.asList("jpg", "jpeg", "png", "gif");
        if (!allowedExtensions.contains(extension)) {
            throw new InvalidFileException("ä¸æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å: " + extension);
        }
    }
    
    private LocalDate validateAndParseBirthday(String birthday) {
        if (birthday == null || birthday.trim().isEmpty()) {
            throw new ValidationException("ç”Ÿæ—¥ä¸èƒ½ä¸ºç©º");
        }
        
        try {
            LocalDate birthDate = LocalDate.parse(birthday.trim());
            
            // éªŒè¯æ—¥æœŸä¸èƒ½æ˜¯æœªæ¥
            if (birthDate.isAfter(LocalDate.now())) {
                throw new ValidationException("ç”Ÿæ—¥ä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸ");
            }
            
            // éªŒè¯å¹´é¾„åˆç†æ€§ï¼ˆ0-150å²ï¼‰
            int age = Period.between(birthDate, LocalDate.now()).getYears();
            if (age < 0 || age > 150) {
                throw new ValidationException("å¹´é¾„ä¸åˆç†: " + age);
            }
            
            return birthDate;
            
        } catch (DateTimeParseException e) {
            throw new ValidationException("æ—¥æœŸæ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨YYYY-MM-DDæ ¼å¼: " + birthday);
        }
    }
    
    private UserRole validateAndParseUserRole(String roleName) {
        if (roleName == null || roleName.trim().isEmpty()) {
            throw new ValidationException("è§’è‰²åç§°ä¸èƒ½ä¸ºç©º");
        }
        
        try {
            return UserRole.valueOf(roleName.trim().toUpperCase());
        } catch (IllegalArgumentException e) {
            List<String> validRoles = Arrays.stream(UserRole.values())
                .map(Enum::name)
                .collect(Collectors.toList());
            throw new ValidationException(
                String.format("æ— æ•ˆçš„è§’è‰²åç§°: %s, æœ‰æ•ˆå€¼: %s", roleName, validRoles));
        }
    }
    
    private List<String> validateAndProcessTags(List<String> tags) {
        if (tags == null) {
            return new ArrayList<>();
        }
        
        // éªŒè¯æ ‡ç­¾æ•°é‡
        if (tags.size() > 10) {
            throw new ValidationException("æ ‡ç­¾æ•°é‡ä¸èƒ½è¶…è¿‡10ä¸ª");
        }
        
        List<String> processedTags = new ArrayList<>();
        Set<String> uniqueTags = new HashSet<>();
        
        for (String tag : tags) {
            if (tag == null || tag.trim().isEmpty()) {
                continue; // è·³è¿‡ç©ºæ ‡ç­¾
            }
            
            String processedTag = tag.trim();
            
            // éªŒè¯æ ‡ç­¾é•¿åº¦
            if (processedTag.length() > 20) {
                throw new ValidationException("æ ‡ç­¾é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦: " + processedTag);
            }
            
            // éªŒè¯æ ‡ç­¾å†…å®¹ï¼ˆåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸­æ–‡ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ï¼‰
            if (!processedTag.matches("^[\\w\\u4e00-\\u9fa5-]+$")) {
                throw new ValidationException("æ ‡ç­¾åŒ…å«æ— æ•ˆå­—ç¬¦: " + processedTag);
            }
            
            // å»é‡
            if (uniqueTags.add(processedTag.toLowerCase())) {
                processedTags.add(processedTag);
            }
        }
        
        return processedTags;
    }
    
    private int calculateAge(LocalDate birthDate) {
        return Period.between(birthDate, LocalDate.now()).getYears();
    }
    
    // å…¶ä»–è¾…åŠ©æ–¹æ³•çœç•¥...
}

// âœ… å®Œæ•´çš„å®ä½“éªŒè¯
@Entity
@Table(name = "users")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    @Column(unique = true, nullable = false)
    private String username;
    
    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 100, message = "é‚®ç®±é•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦")
    @Column(unique = true, nullable = false)
    private String email;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 60, max = 60, message = "å¯†ç å“ˆå¸Œé•¿åº¦å¿…é¡»ä¸º60")
    @Column(nullable = false)
    private String password;
    
    @Min(value = 0, message = "å¹´é¾„ä¸èƒ½å°äº0")
    @Max(value = 150, message = "å¹´é¾„ä¸èƒ½å¤§äº150")
    private Integer age;
    
    @DecimalMin(value = "0.00", message = "ä½™é¢ä¸èƒ½ä¸ºè´Ÿæ•°")
    @DecimalMax(value = "999999999.99", message = "ä½™é¢è¶…å‡ºå…è®¸èŒƒå›´")
    @Digits(integer = 9, fraction = 2, message = "ä½™é¢æ ¼å¼ä¸æ­£ç¡®")
    @Column(precision = 11, scale = 2, nullable = false)
    private BigDecimal balance = BigDecimal.ZERO;
    
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    @Column(unique = true)
    private String phone;
    
    @URL(message = "å¤´åƒURLæ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 500, message = "å¤´åƒURLé•¿åº¦ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦")
    private String avatarUrl;
    
    @Past(message = "ç”Ÿæ—¥ä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸ")
    private LocalDate birthday;
    
    @NotNull(message = "ç”¨æˆ·è§’è‰²ä¸èƒ½ä¸ºç©º")
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserRole role;
    
    @NotNull(message = "ç”¨æˆ·çŠ¶æ€ä¸èƒ½ä¸ºç©º")
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserStatus status;
    
    @Size(max = 10, message = "æ ‡ç­¾æ•°é‡ä¸èƒ½è¶…è¿‡10ä¸ª")
    @ElementCollection
    @CollectionTable(name = "user_tags", joinColumns = @JoinColumn(name = "user_id"))
    @Column(name = "tag")
    private List<@NotBlank @Size(max = 20) String> tags = new ArrayList<>();
    
    @Min(value = 0, message = "ç§¯åˆ†ä¸èƒ½ä¸ºè´Ÿæ•°")
    @Column(nullable = false)
    private Integer points = 0;
    
    @Positive(message = "ç»„IDå¿…é¡»ä¸ºæ­£æ•°")
    private Long groupId;
    
    @Size(max = 200, message = "åˆ é™¤åŸå› é•¿åº¦ä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦")
    private String deleteReason;
    
    @PastOrPresent(message = "åˆ›å»ºæ—¶é—´ä¸èƒ½æ˜¯æœªæ¥")
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @PastOrPresent(message = "æ›´æ–°æ—¶é—´ä¸èƒ½æ˜¯æœªæ¥")
    @Column(nullable = false)
    private LocalDateTime updatedAt;
    
    private LocalDateTime deletedAt;
    
    private LocalDateTime lastSyncAt;
    
    private String externalSystemId;
    
    @Version
    private Long version;
    
    // ä¸šåŠ¡æ–¹æ³•
    public boolean isActive() {
        return UserStatus.ACTIVE.equals(this.status);
    }
    
    public boolean isDeleted() {
        return UserStatus.DELETED.equals(this.status);
    }
    
    public boolean hasRole(UserRole role) {
        return this.role.equals(role);
    }
    
    public boolean hasTag(String tag) {
        return this.tags != null && this.tags.contains(tag);
    }
}

// âœ… è¯·æ±‚DTOéªŒè¯
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserCreateRequest {
    
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;
    
    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 100, message = "é‚®ç®±é•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦")
    private String email;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 8, max = 50, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨8-50ä¸ªå­—ç¬¦ä¹‹é—´")
    @Pattern(regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]+$", 
             message = "å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦")
    private String password;
    
    @Min(value = 0, message = "å¹´é¾„ä¸èƒ½å°äº0")
    @Max(value = 150, message = "å¹´é¾„ä¸èƒ½å¤§äº150")
    private Integer age;
    
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    private String phone;
    
    @Size(max = 10, message = "æ ‡ç­¾æ•°é‡ä¸èƒ½è¶…è¿‡10ä¸ª")
    private List<@NotBlank @Size(max = 20) String> tags;
}
```

### 4.21.3.3 ç¼“å­˜ä¸€è‡´æ€§æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. ç¼“å­˜ä¸æ•°æ®åº“æ•°æ®ä¸€è‡´æ€§
b. ç¼“å­˜æ›´æ–°ç­–ç•¥çš„æ­£ç¡®æ€§
c. åˆ†å¸ƒå¼ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜
d. ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é˜²æŠ¤

**2. æ£€æµ‹æ–¹æ³•**

1. ç¼“å­˜ç›‘æ§å·¥å…·ï¼ˆRedis Monitorã€Memcached Statsï¼‰
2. ä¸€è‡´æ€§æµ‹è¯•ï¼ˆå¹¶å‘è¯»å†™æµ‹è¯•ï¼‰
3. æ€§èƒ½æµ‹è¯•ï¼ˆå‹åŠ›æµ‹è¯•ã€ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§ï¼‰
4. åˆ†å¸ƒå¼ç¼“å­˜åŒæ­¥æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ç¼“å­˜æ›´æ–°ä¸åŠæ—¶ï¼Œå¯¼è‡´è„è¯»
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void updateUser(User user) {
        // åªæ›´æ–°æ•°æ®åº“ï¼Œå¿˜è®°æ›´æ–°ç¼“å­˜
        userRepository.save(user);
        // ç¼“å­˜ä¸­ä»æ˜¯æ—§æ•°æ®
    }
    
    public User getUser(Long userId) {
        String key = "user:" + userId;
        User user = (User) redisTemplate.opsForValue().get(key);
        if (user == null) {
            user = userRepository.findById(userId).orElse(null);
            redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
        }
        return user;
    }
}

// âŒ ç¼“å­˜åˆ é™¤å¤±è´¥ï¼Œæ•°æ®ä¸ä¸€è‡´
public class ProductService {
    public void updateProduct(Product product) {
        productRepository.save(product);
        try {
            redisTemplate.delete("product:" + product.getId());
        } catch (Exception e) {
            // åˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œä½†æ²¡æœ‰å¤„ç†
            log.error("Cache delete failed", e);
        }
    }
}

// âŒ å¹¶å‘æ›´æ–°ç¼“å­˜æ—¶çš„ç«æ€æ¡ä»¶
public class CounterService {
    public void incrementCounter(String key) {
        Integer count = (Integer) redisTemplate.opsForValue().get(key);
        if (count == null) {
            count = 0;
        }
        // ç«æ€æ¡ä»¶ï¼šå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¯»å–åˆ°ç›¸åŒå€¼
        count++;
        redisTemplate.opsForValue().set(key, count);
    }
}

// âŒ ç¼“å­˜ç©¿é€æ”»å‡»
public class ArticleService {
    public Article getArticle(Long articleId) {
        String key = "article:" + articleId;
        Article article = (Article) redisTemplate.opsForValue().get(key);
        if (article == null) {
            article = articleRepository.findById(articleId).orElse(null);
            // æ²¡æœ‰é˜²æŠ¤æªæ–½ï¼Œæ¶æ„è¯·æ±‚ä¸å­˜åœ¨çš„IDä¼šç›´æ¥æ‰“åˆ°æ•°æ®åº“
            if (article != null) {
                redisTemplate.opsForValue().set(key, article, 1, TimeUnit.HOURS);
            }
        }
        return article;
    }
}

// âŒ ç¼“å­˜é›ªå´©é—®é¢˜
public class CategoryService {
    public List<Category> getAllCategories() {
        String key = "categories:all";
        List<Category> categories = (List<Category>) redisTemplate.opsForValue().get(key);
        if (categories == null) {
            categories = categoryRepository.findAll();
            // æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯èƒ½åŒæ—¶å¤±æ•ˆ
            redisTemplate.opsForValue().set(key, categories, 1, TimeUnit.HOURS);
        }
        return categories;
    }
}

// âŒ åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ç¼“å­˜åŒæ­¥é—®é¢˜
public class ConfigService {
    private Map<String, String> localCache = new ConcurrentHashMap<>();
    
    public String getConfig(String key) {
        // åªä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œå¤šå®ä¾‹é—´æ•°æ®ä¸ä¸€è‡´
        return localCache.computeIfAbsent(key, k -> {
            return configRepository.findByKey(k).getValue();
        });
    }
    
    public void updateConfig(String key, String value) {
        configRepository.updateByKey(key, value);
        localCache.put(key, value); // åªæ›´æ–°å½“å‰å®ä¾‹çš„ç¼“å­˜
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨Cache-Asideæ¨¡å¼ç¡®ä¿ç¼“å­˜ä¸€è‡´æ€§
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RedissonClient redissonClient;
    
    public User getUser(Long userId) {
        String key = "user:" + userId;
        User user = (User) redisTemplate.opsForValue().get(key);
        if (user == null) {
            // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿
            RLock lock = redissonClient.getLock("lock:user:" + userId);
            try {
                if (lock.tryLock(5, 10, TimeUnit.SECONDS)) {
                    // åŒé‡æ£€æŸ¥
                    user = (User) redisTemplate.opsForValue().get(key);
                    if (user == null) {
                        user = userRepository.findById(userId).orElse(null);
                        if (user != null) {
                            redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
                        } else {
                            // é˜²æ­¢ç¼“å­˜ç©¿é€ï¼šç¼“å­˜ç©ºå€¼
                            redisTemplate.opsForValue().set(key, new NullUser(), 5, TimeUnit.MINUTES);
                        }
                    }
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            } finally {
                if (lock.isHeldByCurrentThread()) {
                    lock.unlock();
                }
            }
        }
        return user instanceof NullUser ? null : user;
    }
    
    @Transactional
    public void updateUser(User user) {
        userRepository.save(user);
        // åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ï¼Œé¿å…å¹¶å‘é—®é¢˜
        String key = "user:" + user.getId();
        redisTemplate.delete(key);
        
        // å‘é€ç¼“å­˜å¤±æ•ˆé€šçŸ¥ç»™å…¶ä»–å®ä¾‹
        redisTemplate.convertAndSend("cache:invalidate", key);
    }
    
    // ç©ºå¯¹è±¡æ¨¡å¼é˜²æ­¢ç¼“å­˜ç©¿é€
    private static class NullUser extends User {
        // æ ‡è®°å¯¹è±¡
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸå­æ“ä½œå¤„ç†å¹¶å‘æ›´æ–°
@Service
public class CounterService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public Long incrementCounter(String key) {
        // ä½¿ç”¨RedisåŸå­æ“ä½œ
        return redisTemplate.opsForValue().increment(key);
    }
    
    public Long incrementCounterWithExpire(String key, long timeout, TimeUnit unit) {
        Long result = redisTemplate.opsForValue().increment(key);
        if (result == 1) {
            // ç¬¬ä¸€æ¬¡è®¾ç½®æ—¶æ·»åŠ è¿‡æœŸæ—¶é—´
            redisTemplate.expire(key, timeout, unit);
        }
        return result;
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€
@Service
public class ArticleService {
    @Autowired
    private ArticleRepository articleRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private BloomFilter<Long> bloomFilter;
    
    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨
        bloomFilter = BloomFilter.create(Funnels.longFunnel(), 1000000, 0.01);
        // å°†æ‰€æœ‰å­˜åœ¨çš„æ–‡ç« IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨
        List<Long> existingIds = articleRepository.findAllIds();
        existingIds.forEach(bloomFilter::put);
    }
    
    public Article getArticle(Long articleId) {
        // å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨
        if (!bloomFilter.mightContain(articleId)) {
            return null; // è‚¯å®šä¸å­˜åœ¨
        }
        
        String key = "article:" + articleId;
        Article article = (Article) redisTemplate.opsForValue().get(key);
        if (article == null) {
            article = articleRepository.findById(articleId).orElse(null);
            if (article != null) {
                // éšæœºè¿‡æœŸæ—¶é—´é˜²æ­¢ç¼“å­˜é›ªå´©
                int randomExpire = 3600 + new Random().nextInt(1800); // 1-2.5å°æ—¶
                redisTemplate.opsForValue().set(key, article, randomExpire, TimeUnit.SECONDS);
            } else {
                // ç¼“å­˜ç©ºå€¼ï¼Œè¾ƒçŸ­è¿‡æœŸæ—¶é—´
                redisTemplate.opsForValue().set(key, new NullArticle(), 300, TimeUnit.SECONDS);
            }
        }
        return article instanceof NullArticle ? null : article;
    }
    
    private static class NullArticle extends Article {
        // ç©ºå¯¹è±¡æ ‡è®°
    }
}

// âœ… æ­£ç¡®ï¼šå®ç°ç¼“å­˜é¢„çƒ­å’Œé™çº§ç­–ç•¥
@Service
public class CategoryService {
    @Autowired
    private CategoryRepository categoryRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RedissonClient redissonClient;
    
    private volatile List<Category> fallbackCache = new ArrayList<>();
    
    @PostConstruct
    public void warmUpCache() {
        // åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­ç¼“å­˜
        List<Category> categories = categoryRepository.findAll();
        fallbackCache = new ArrayList<>(categories);
        
        String key = "categories:all";
        // è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´é˜²æ­¢é›ªå´©
        int randomExpire = 3600 + new Random().nextInt(1800);
        redisTemplate.opsForValue().set(key, categories, randomExpire, TimeUnit.SECONDS);
    }
    
    public List<Category> getAllCategories() {
        String key = "categories:all";
        try {
            List<Category> categories = (List<Category>) redisTemplate.opsForValue().get(key);
            if (categories == null) {
                // ç¼“å­˜å¤±æ•ˆæ—¶ä½¿ç”¨åˆ†å¸ƒå¼é”
                RLock lock = redissonClient.getLock("lock:categories");
                try {
                    if (lock.tryLock(2, 10, TimeUnit.SECONDS)) {
                        categories = (List<Category>) redisTemplate.opsForValue().get(key);
                        if (categories == null) {
                            categories = categoryRepository.findAll();
                            fallbackCache = new ArrayList<>(categories);
                            
                            int randomExpire = 3600 + new Random().nextInt(1800);
                            redisTemplate.opsForValue().set(key, categories, randomExpire, TimeUnit.SECONDS);
                        }
                    } else {
                        // è·å–é”å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ•°æ®
                        return new ArrayList<>(fallbackCache);
                    }
                } finally {
                    if (lock.isHeldByCurrentThread()) {
                        lock.unlock();
                    }
                }
            }
            return categories;
        } catch (Exception e) {
            log.error("Cache error, using fallback", e);
            // ç¼“å­˜å¼‚å¸¸æ—¶ä½¿ç”¨é™çº§æ•°æ®
            return new ArrayList<>(fallbackCache);
        }
    }
}

// âœ… æ­£ç¡®ï¼šåˆ†å¸ƒå¼ç¼“å­˜åŒæ­¥æœºåˆ¶
@Service
public class ConfigService {
    @Autowired
    private ConfigRepository configRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private final Map<String, String> localCache = new ConcurrentHashMap<>();
    
    @EventListener
    public void handleCacheInvalidation(String key) {
        localCache.remove(key);
    }
    
    public String getConfig(String key) {
        // å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        String value = localCache.get(key);
        if (value != null) {
            return value;
        }
        
        // å†æŸ¥Redisç¼“å­˜
        value = (String) redisTemplate.opsForValue().get("config:" + key);
        if (value != null) {
            localCache.put(key, value);
            return value;
        }
        
        // æœ€åæŸ¥æ•°æ®åº“
        Config config = configRepository.findByKey(key);
        if (config != null) {
            value = config.getValue();
            localCache.put(key, value);
            redisTemplate.opsForValue().set("config:" + key, value, 1, TimeUnit.HOURS);
            return value;
        }
        
        return null;
    }
    
    @Transactional
    public void updateConfig(String key, String value) {
        configRepository.updateByKey(key, value);
        
        // åˆ é™¤æ‰€æœ‰å±‚çº§çš„ç¼“å­˜
        localCache.remove(key);
        redisTemplate.delete("config:" + key);
        
        // é€šçŸ¥å…¶ä»–å®ä¾‹æ¸…é™¤æœ¬åœ°ç¼“å­˜
        redisTemplate.convertAndSend("config:invalidate", key);
    }
    
    @RedisMessageListener("config:invalidate")
    public void onConfigInvalidate(String key) {
        localCache.remove(key);
        log.info("Local cache invalidated for key: {}", key);
    }
}

// âœ… æ­£ç¡®ï¼šç¼“å­˜ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
@Service
public class VersionedCacheService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void setWithVersion(String key, Object value, long version) {
        String versionKey = key + ":version";
        String dataKey = key + ":data";
        
        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String script = 
            "local currentVersion = redis.call('get', KEYS[1]) " +
            "if currentVersion == false or tonumber(currentVersion) < tonumber(ARGV[1]) then " +
            "  redis.call('set', KEYS[1], ARGV[1]) " +
            "  redis.call('set', KEYS[2], ARGV[2]) " +
            "  return 1 " +
            "else " +
            "  return 0 " +
            "end";
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
        redisScript.setScriptText(script);
        redisScript.setResultType(Long.class);
        
        Long result = redisTemplate.execute(redisScript, 
            Arrays.asList(versionKey, dataKey), 
            String.valueOf(version), 
            JSON.toJSONString(value));
        
        if (result == 0) {
            log.warn("Version conflict for key: {}, current version is newer", key);
        }
    }
    
    public <T> T getWithVersion(String key, Class<T> clazz) {
        String dataKey = key + ":data";
        String data = (String) redisTemplate.opsForValue().get(dataKey);
        if (data != null) {
            return JSON.parseObject(data, clazz);
        }
        return null;
    }
}
```