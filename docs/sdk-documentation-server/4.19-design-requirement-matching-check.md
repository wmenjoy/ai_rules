å’Œ# 4.19 è®¾è®¡ä¸éœ€æ±‚åŒ¹é…æ£€æŸ¥

## 4.19.1 ä¸šåŠ¡éœ€æ±‚å®ç°æ£€æŸ¥ ğŸ”´

### 4.19.1.1 ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æŸ¥æ˜¯å¦å®Œæ•´å®ç°äº†ä¸šåŠ¡éœ€æ±‚ä¸­çš„æ‰€æœ‰é€»è¾‘åˆ†æ”¯

b. éªŒè¯ä¸šåŠ¡æµç¨‹çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§

c. ç¡®ä¿å¼‚å¸¸æƒ…å†µå’Œè¾¹ç•Œæ¡ä»¶éƒ½æœ‰ç›¸åº”å¤„ç†

**2. æ£€æµ‹æ–¹æ³•**

1. å¯¹ç…§éœ€æ±‚æ–‡æ¡£æ£€æŸ¥ä»£ç å®ç°

2. ä½¿ç”¨ä¸šåŠ¡æµç¨‹å›¾éªŒè¯ä»£ç é€»è¾‘

3. é™æ€ä»£ç åˆ†æå·¥å…·æ£€æµ‹é€»è¾‘ç¼ºå¤±

4. å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰ä¸šåŠ¡åœºæ™¯

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ä¸šåŠ¡é€»è¾‘ä¸å®Œæ•´ï¼Œç¼ºå°‘é‡è¦çš„ä¸šåŠ¡è§„åˆ™
public class OrderService {
    public void processOrder(Order order) {
        // åªå¤„ç†äº†åŸºæœ¬æƒ…å†µï¼Œç¼ºå°‘åº“å­˜æ£€æŸ¥ã€ä¼˜æƒ åˆ¸éªŒè¯ç­‰
        order.setStatus("PROCESSED");
        orderRepository.save(order);
    }
    
    // âŒ ç¼ºå°‘é€€æ¬¾ä¸šåŠ¡é€»è¾‘
    public void cancelOrder(Long orderId) {
        Order order = orderRepository.findById(orderId);
        order.setStatus("CANCELLED");
        // ç¼ºå°‘é€€æ¬¾å¤„ç†ã€åº“å­˜å›æ»šç­‰ä¸šåŠ¡é€»è¾‘
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ä¸šåŠ¡é€»è¾‘å®ç°
public class OrderService {
    public void processOrder(Order order) {
        // å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘
        validateOrder(order);
        checkInventory(order);
        applyCoupons(order);
        calculateTotalPrice(order);
        processPayment(order);
        updateInventory(order);
        order.setStatus("PROCESSED");
        orderRepository.save(order);
        sendConfirmationEmail(order);
    }
    
    // âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å–æ¶ˆè®¢å•ä¸šåŠ¡é€»è¾‘
    public void cancelOrder(Long orderId) {
        Order order = orderRepository.findById(orderId);
        validateCancellation(order);
        
        if (order.getStatus().equals("PAID")) {
            processRefund(order);
        }
        
        restoreInventory(order);
        order.setStatus("CANCELLED");
        orderRepository.save(order);
        sendCancellationNotification(order);
    }
}
```

### 4.19.1.2 éœ€æ±‚è¦†ç›–åº¦æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. éªŒè¯ä»£ç æ˜¯å¦è¦†ç›–äº†éœ€æ±‚æ–‡æ¡£ä¸­çš„æ‰€æœ‰åŠŸèƒ½ç‚¹

b. æ£€æŸ¥æ˜¯å¦æœ‰é—æ¼çš„éœ€æ±‚å®ç°

c. ç¡®ä¿æ‰€æœ‰ç”¨æˆ·æ•…äº‹éƒ½æœ‰å¯¹åº”çš„ä»£ç å®ç°

**2. æ£€æµ‹æ–¹æ³•**

1. éœ€æ±‚è¿½è¸ªçŸ©é˜µå¯¹æ¯”

2. åŠŸèƒ½ç‚¹æ¸…å•æ£€æŸ¥

3. ç”¨æˆ·æ•…äº‹éªŒæ”¶æ ‡å‡†éªŒè¯

4. è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹è¦†ç›–åº¦åˆ†æ

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ éœ€æ±‚è¦†ç›–ä¸å®Œæ•´ï¼Œç¼ºå°‘é‡è¦åŠŸèƒ½
public class UserController {
    // åªå®ç°äº†åŸºæœ¬çš„CRUDï¼Œç¼ºå°‘éœ€æ±‚ä¸­çš„é«˜çº§åŠŸèƒ½
    
    @PostMapping("/users")
    public User createUser(@RequestBody User user) {
        return userService.save(user);
    }
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    // âŒ ç¼ºå°‘éœ€æ±‚ä¸­è¦æ±‚çš„åŠŸèƒ½ï¼š
    // - ç”¨æˆ·å¯†ç é‡ç½®
    // - ç”¨æˆ·æƒé™ç®¡ç†
    // - ç”¨æˆ·æ´»åŠ¨æ—¥å¿—
    // - æ‰¹é‡ç”¨æˆ·æ“ä½œ
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´è¦†ç›–æ‰€æœ‰éœ€æ±‚åŠŸèƒ½ç‚¹
public class UserController {
    
    @PostMapping("/users")
    public User createUser(@RequestBody User user) {
        return userService.save(user);
    }
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    // âœ… å®ç°éœ€æ±‚ä¸­çš„å¯†ç é‡ç½®åŠŸèƒ½
    @PostMapping("/users/{id}/reset-password")
    public void resetPassword(@PathVariable Long id) {
        userService.resetPassword(id);
    }
    
    // âœ… å®ç°éœ€æ±‚ä¸­çš„æƒé™ç®¡ç†åŠŸèƒ½
    @PostMapping("/users/{id}/roles")
    public void assignRole(@PathVariable Long id, @RequestBody Role role) {
        userService.assignRole(id, role);
    }
    
    // âœ… å®ç°éœ€æ±‚ä¸­çš„æ´»åŠ¨æ—¥å¿—åŠŸèƒ½
    @GetMapping("/users/{id}/activities")
    public List<Activity> getUserActivities(@PathVariable Long id) {
        return userService.getUserActivities(id);
    }
    
    // âœ… å®ç°éœ€æ±‚ä¸­çš„æ‰¹é‡æ“ä½œåŠŸèƒ½
    @PostMapping("/users/batch")
    public void batchUpdateUsers(@RequestBody List<User> users) {
        userService.batchUpdate(users);
    }
}
```

### 4.19.1.3 ä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. éªŒè¯ä»£ç å®ç°çš„ä¸šåŠ¡è§„åˆ™ä¸éœ€æ±‚æ–‡æ¡£ä¸€è‡´

b. æ£€æŸ¥ä¸šåŠ¡çº¦æŸæ¡ä»¶çš„æ­£ç¡®å®ç°

c. ç¡®ä¿ä¸šåŠ¡è®¡ç®—é€»è¾‘çš„å‡†ç¡®æ€§

**2. æ£€æµ‹æ–¹æ³•**

1. ä¸šåŠ¡è§„åˆ™æ–‡æ¡£å¯¹æ¯”éªŒè¯

2. ä¸šåŠ¡ä¸“å®¶ä»£ç å®¡æŸ¥

3. ä¸šåŠ¡è§„åˆ™å¼•æ“éªŒè¯

4. ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯ä¸šåŠ¡åœºæ™¯

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ä¸šåŠ¡è§„åˆ™å®ç°é”™è¯¯ï¼Œä¸éœ€æ±‚ä¸ä¸€è‡´
public class DiscountService {
    // âŒ é”™è¯¯ï¼šæŠ˜æ‰£è®¡ç®—è§„åˆ™ä¸éœ€æ±‚ä¸ç¬¦
    // éœ€æ±‚ï¼šVIPç”¨æˆ·äº«å—10%æŠ˜æ‰£ï¼Œæ™®é€šç”¨æˆ·äº«å—5%æŠ˜æ‰£
    public BigDecimal calculateDiscount(User user, BigDecimal amount) {
        if (user.isVip()) {
            return amount.multiply(new BigDecimal("0.15")); // é”™è¯¯ï¼šåº”è¯¥æ˜¯0.10
        }
        return amount.multiply(new BigDecimal("0.03")); // é”™è¯¯ï¼šåº”è¯¥æ˜¯0.05
    }
    
    // âŒ é”™è¯¯ï¼šç¼ºå°‘ä¸šåŠ¡çº¦æŸæ£€æŸ¥
    public void applyDiscount(Order order) {
        // éœ€æ±‚ï¼šå•ç¬”è®¢å•æŠ˜æ‰£ä¸èƒ½è¶…è¿‡1000å…ƒ
        BigDecimal discount = calculateDiscount(order.getUser(), order.getAmount());
        order.setDiscount(discount); // ç¼ºå°‘ä¸Šé™æ£€æŸ¥
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¸šåŠ¡è§„åˆ™å®ç°ä¸éœ€æ±‚å®Œå…¨ä¸€è‡´
public class DiscountService {
    private static final BigDecimal VIP_DISCOUNT_RATE = new BigDecimal("0.10");
    private static final BigDecimal REGULAR_DISCOUNT_RATE = new BigDecimal("0.05");
    private static final BigDecimal MAX_DISCOUNT_AMOUNT = new BigDecimal("1000");
    
    // âœ… æ­£ç¡®ï¼šæŒ‰ç…§éœ€æ±‚å®ç°æŠ˜æ‰£è®¡ç®—
    public BigDecimal calculateDiscount(User user, BigDecimal amount) {
        BigDecimal discountRate = user.isVip() ? VIP_DISCOUNT_RATE : REGULAR_DISCOUNT_RATE;
        return amount.multiply(discountRate);
    }
    
    // âœ… æ­£ç¡®ï¼šå®ç°ä¸šåŠ¡çº¦æŸæ£€æŸ¥
    public void applyDiscount(Order order) {
        BigDecimal discount = calculateDiscount(order.getUser(), order.getAmount());
        
        // åº”ç”¨ä¸šåŠ¡çº¦æŸï¼šå•ç¬”è®¢å•æŠ˜æ‰£ä¸èƒ½è¶…è¿‡1000å…ƒ
        if (discount.compareTo(MAX_DISCOUNT_AMOUNT) > 0) {
            discount = MAX_DISCOUNT_AMOUNT;
        }
        
        order.setDiscount(discount);
    }
    
    // âœ… æ­£ç¡®ï¼šå®ç°å¤æ‚ä¸šåŠ¡è§„åˆ™
    public boolean isEligibleForDiscount(User user, Order order) {
        // éœ€æ±‚ï¼šæ–°ç”¨æˆ·é¦–å•å…è´¹ï¼Œè€ç”¨æˆ·æ»¡100å…ƒæ‰èƒ½äº«å—æŠ˜æ‰£
        if (user.isNewUser() && order.isFirstOrder()) {
            return true;
        }
        
        return !user.isNewUser() && 
               order.getAmount().compareTo(new BigDecimal("100")) >= 0;
    }
}
```

## 4.19.2 æ¶æ„è®¾è®¡ä¸€è‡´æ€§æ£€æŸ¥ ğŸ”´

### 4.19.2.1 åˆ†å±‚æ¶æ„éµå¾ªæ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æŸ¥ä»£ç æ˜¯å¦éµå¾ªé¢„å®šä¹‰çš„åˆ†å±‚æ¶æ„

b. éªŒè¯å±‚é—´ä¾èµ–å…³ç³»çš„æ­£ç¡®æ€§

c. ç¡®ä¿æ²¡æœ‰è·¨å±‚è°ƒç”¨å’Œå¾ªç¯ä¾èµ–

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æå·¥å…·æ£€æµ‹ä¾èµ–å…³ç³»

2. æ¶æ„åˆè§„æ€§æ£€æŸ¥å·¥å…·

3. åŒ…ç»“æ„å’Œç±»èŒè´£å®¡æŸ¥

4. ä¾èµ–å›¾åˆ†æ

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ è¿ååˆ†å±‚æ¶æ„ï¼ŒControllerç›´æ¥è°ƒç”¨Repository
@RestController
public class UserController {
    @Autowired
    private UserRepository userRepository; // é”™è¯¯ï¼šControllerä¸åº”ç›´æ¥ä¾èµ–Repository
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        // é”™è¯¯ï¼šè·³è¿‡Serviceå±‚ç›´æ¥è°ƒç”¨Repository
        return userRepository.findById(id).orElse(null);
    }
}

// âŒ Repositoryå±‚åŒ…å«ä¸šåŠ¡é€»è¾‘
@Repository
public class UserRepository {
    public User findActiveUser(Long id) {
        User user = findById(id);
        // é”™è¯¯ï¼šRepositoryå±‚ä¸åº”åŒ…å«ä¸šåŠ¡é€»è¾‘
        if (user != null && user.getLastLoginTime().isAfter(LocalDateTime.now().minusDays(30))) {
            user.setStatus("ACTIVE");
        }
        return user;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šéµå¾ªåˆ†å±‚æ¶æ„
@RestController
public class UserController {
    @Autowired
    private UserService userService; // æ­£ç¡®ï¼šControlleråªä¾èµ–Service
    
    @GetMapping("/users/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }
}

@Service
public class UserService {
    @Autowired
    private UserRepository userRepository; // æ­£ç¡®ï¼šServiceä¾èµ–Repository
    
    public User findById(Long id) {
        return userRepository.findById(id)
            .orElseThrow(() -> new UserNotFoundException("User not found: " + id));
    }
    
    public User findActiveUser(Long id) {
        User user = findById(id);
        // æ­£ç¡®ï¼šä¸šåŠ¡é€»è¾‘åœ¨Serviceå±‚
        if (user.getLastLoginTime().isAfter(LocalDateTime.now().minusDays(30))) {
            user.setStatus("ACTIVE");
            userRepository.save(user);
        }
        return user;
    }
}

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    // æ­£ç¡®ï¼šRepositoryåªè´Ÿè´£æ•°æ®è®¿é—®
    List<User> findByStatus(String status);
    List<User> findByLastLoginTimeAfter(LocalDateTime time);
}
```

### 4.19.2.2 è®¾è®¡æ¨¡å¼åº”ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æŸ¥è®¾è®¡æ¨¡å¼çš„æ­£ç¡®åº”ç”¨

b. éªŒè¯æ¨¡å¼å®ç°çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§

c. ç¡®ä¿æ¨¡å¼ä½¿ç”¨åœºæ™¯çš„åˆç†æ€§

**2. æ£€æµ‹æ–¹æ³•**

1. è®¾è®¡æ¨¡å¼è¯†åˆ«å·¥å…·

2. ä»£ç ç»“æ„åˆ†æ

3. è®¾è®¡æ–‡æ¡£å¯¹æ¯”éªŒè¯

4. æ¶æ„å¸ˆä»£ç å®¡æŸ¥

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯çš„å•ä¾‹æ¨¡å¼å®ç°ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰
public class ConfigManager {
    private static ConfigManager instance;
    
    private ConfigManager() {}
    
    // é”™è¯¯ï¼šçº¿ç¨‹ä¸å®‰å…¨çš„å•ä¾‹å®ç°
    public static ConfigManager getInstance() {
        if (instance == null) {
            instance = new ConfigManager(); // å¯èƒ½åˆ›å»ºå¤šä¸ªå®ä¾‹
        }
        return instance;
    }
}

// âŒ é”™è¯¯çš„å·¥å‚æ¨¡å¼å®ç°
public class PaymentFactory {
    // é”™è¯¯ï¼šè¿åå¼€é—­åŸåˆ™ï¼Œæ·»åŠ æ–°æ”¯ä»˜æ–¹å¼éœ€è¦ä¿®æ”¹å·¥å‚ç±»
    public Payment createPayment(String type) {
        if ("ALIPAY".equals(type)) {
            return new AlipayPayment();
        } else if ("WECHAT".equals(type)) {
            return new WechatPayment();
        }
        throw new IllegalArgumentException("Unknown payment type: " + type);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šçº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼å®ç°
public class ConfigManager {
    private static volatile ConfigManager instance;
    
    private ConfigManager() {}
    
    // æ­£ç¡®ï¼šåŒé‡æ£€æŸ¥é”å®šçš„çº¿ç¨‹å®‰å…¨å•ä¾‹
    public static ConfigManager getInstance() {
        if (instance == null) {
            synchronized (ConfigManager.class) {
                if (instance == null) {
                    instance = new ConfigManager();
                }
            }
        }
        return instance;
    }
}

// âœ… æ­£ç¡®ï¼šå¯æ‰©å±•çš„å·¥å‚æ¨¡å¼å®ç°
public class PaymentFactory {
    private final Map<String, Supplier<Payment>> paymentCreators = new HashMap<>();
    
    public PaymentFactory() {
        // æ­£ç¡®ï¼šé€šè¿‡æ³¨å†Œæœºåˆ¶æ”¯æŒæ‰©å±•
        registerPayment("ALIPAY", AlipayPayment::new);
        registerPayment("WECHAT", WechatPayment::new);
    }
    
    public void registerPayment(String type, Supplier<Payment> creator) {
        paymentCreators.put(type, creator);
    }
    
    public Payment createPayment(String type) {
        Supplier<Payment> creator = paymentCreators.get(type);
        if (creator == null) {
            throw new IllegalArgumentException("Unknown payment type: " + type);
        }
        return creator.get();
    }
}

// âœ… æ­£ç¡®ï¼šç­–ç•¥æ¨¡å¼å®ç°
public class DiscountStrategy {
    public interface Strategy {
        BigDecimal calculate(BigDecimal amount);
    }
    
    public static class VipStrategy implements Strategy {
        public BigDecimal calculate(BigDecimal amount) {
            return amount.multiply(new BigDecimal("0.8"));
        }
    }
    
    public static class RegularStrategy implements Strategy {
        public BigDecimal calculate(BigDecimal amount) {
            return amount.multiply(new BigDecimal("0.95"));
        }
    }
}
```

### 4.19.2.3 æ¥å£è®¾è®¡ä¸€è‡´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æŸ¥æ¥å£è®¾è®¡æ˜¯å¦ä¸æ¶æ„æ–‡æ¡£ä¸€è‡´

b. éªŒè¯æ¥å£å¥‘çº¦çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§

c. ç¡®ä¿æ¥å£ç‰ˆæœ¬ç®¡ç†çš„è§„èŒƒæ€§

**2. æ£€æµ‹æ–¹æ³•**

1. APIæ–‡æ¡£ä¸ä»£ç å¯¹æ¯”

2. æ¥å£å¥‘çº¦æµ‹è¯•

3. OpenAPIè§„èŒƒéªŒè¯

4. æ¥å£ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æ¥å£è®¾è®¡ä¸ä¸€è‡´ï¼Œç¼ºå°‘å¿…è¦çš„å…ƒæ•°æ®
@RestController
public class ProductController {
    
    // é”™è¯¯ï¼šç¼ºå°‘APIæ–‡æ¡£æ³¨è§£ï¼Œä¸è®¾è®¡æ–‡æ¡£ä¸ç¬¦
    @GetMapping("/products")
    public List<Product> getProducts() {
        return productService.findAll();
    }
    
    // é”™è¯¯ï¼šè¿”å›ç±»å‹ä¸è®¾è®¡æ–‡æ¡£ä¸ä¸€è‡´
    @PostMapping("/products")
    public Product createProduct(@RequestBody Product product) {
        // è®¾è®¡æ–‡æ¡£è¦æ±‚è¿”å›åŒ…å«IDçš„å®Œæ•´å¯¹è±¡ï¼Œä½†å¯èƒ½è¿”å›null
        return productService.save(product);
    }
    
    // é”™è¯¯ï¼šç¼ºå°‘é”™è¯¯å¤„ç†ï¼Œä¸æ¥å£å¥‘çº¦ä¸ç¬¦
    @GetMapping("/products/{id}")
    public Product getProduct(@PathVariable Long id) {
        return productService.findById(id); // å¯èƒ½è¿”å›nullï¼Œä½†æ¥å£æ–‡æ¡£è¯´è¿”å›404
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ¥å£è®¾è®¡ä¸æ–‡æ¡£å®Œå…¨ä¸€è‡´
@RestController
@RequestMapping("/api/v1/products")
@Api(tags = "Product Management", description = "äº§å“ç®¡ç†æ¥å£")
public class ProductController {
    
    @Autowired
    private ProductService productService;
    
    // âœ… æ­£ç¡®ï¼šå®Œæ•´çš„APIæ–‡æ¡£å’Œå“åº”æ ¼å¼
    @GetMapping
    @ApiOperation(value = "è·å–äº§å“åˆ—è¡¨", notes = "æ”¯æŒåˆ†é¡µå’Œæ’åº")
    @ApiResponses({
        @ApiResponse(code = 200, message = "æˆåŠŸ"),
        @ApiResponse(code = 400, message = "å‚æ•°é”™è¯¯")
    })
    public ResponseEntity<PageResult<Product>> getProducts(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        
        PageResult<Product> result = productService.findAll(page, size);
        return ResponseEntity.ok(result);
    }
    
    // âœ… æ­£ç¡®ï¼šè¿”å›ç±»å‹ä¸è®¾è®¡æ–‡æ¡£ä¸€è‡´
    @PostMapping
    @ApiOperation(value = "åˆ›å»ºäº§å“", notes = "åˆ›å»ºæ–°äº§å“å¹¶è¿”å›å®Œæ•´ä¿¡æ¯")
    public ResponseEntity<ApiResponse<Product>> createProduct(
            @Valid @RequestBody CreateProductRequest request) {
        
        Product product = productService.create(request);
        ApiResponse<Product> response = ApiResponse.success(product);
        return ResponseEntity.status(HttpStatus.CREATED).body(response);
    }
    
    // âœ… æ­£ç¡®ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†ï¼Œç¬¦åˆæ¥å£å¥‘çº¦
    @GetMapping("/{id}")
    @ApiOperation(value = "è·å–äº§å“è¯¦æƒ…", notes = "æ ¹æ®IDè·å–äº§å“ä¿¡æ¯")
    public ResponseEntity<ApiResponse<Product>> getProduct(
            @PathVariable @ApiParam("äº§å“ID") Long id) {
        
        try {
            Product product = productService.findById(id);
            return ResponseEntity.ok(ApiResponse.success(product));
        } catch (ProductNotFoundException e) {
            return ResponseEntity.notFound().build();
        }
    }
    
    // âœ… æ­£ç¡®ï¼šç‰ˆæœ¬åŒ–çš„æ¥å£è®¾è®¡
    @PutMapping("/{id}")
    @ApiOperation(value = "æ›´æ–°äº§å“", notes = "æ›´æ–°äº§å“ä¿¡æ¯")
    public ResponseEntity<ApiResponse<Product>> updateProduct(
            @PathVariable Long id,
            @Valid @RequestBody UpdateProductRequest request,
            @RequestHeader("API-Version") String apiVersion) {
        
        if (!"v1".equals(apiVersion)) {
            return ResponseEntity.badRequest()
                .body(ApiResponse.error("Unsupported API version"));
        }
        
        Product product = productService.update(id, request);
        return ResponseEntity.ok(ApiResponse.success(product));
    }
}

// âœ… æ­£ç¡®ï¼šæ ‡å‡†åŒ–çš„å“åº”æ ¼å¼
public class ApiResponse<T> {
    private boolean success;
    private String message;
    private T data;
    private String timestamp;
    
    public static <T> ApiResponse<T> success(T data) {
        ApiResponse<T> response = new ApiResponse<>();
        response.success = true;
        response.data = data;
        response.timestamp = LocalDateTime.now().toString();
        return response;
    }
    
    public static <T> ApiResponse<T> error(String message) {
        ApiResponse<T> response = new ApiResponse<>();
        response.success = false;
        response.message = message;
        response.timestamp = LocalDateTime.now().toString();
        return response;
    }
}
```

## 4.19.3 éåŠŸèƒ½æ€§éœ€æ±‚æ£€æŸ¥ ğŸ”´

### 4.19.3.1 æ€§èƒ½éœ€æ±‚å®ç°æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æŸ¥ä»£ç æ˜¯å¦æ»¡è¶³æ€§èƒ½éœ€æ±‚æŒ‡æ ‡

b. éªŒè¯æ€§èƒ½ä¼˜åŒ–æªæ–½çš„æ­£ç¡®å®ç°

c. ç¡®ä¿æ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆ

**2. æ£€æµ‹æ–¹æ³•**

1. æ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•

2. ä»£ç æ€§èƒ½åˆ†æå·¥å…·

3. æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½åˆ†æ

4. å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æ€§èƒ½é—®é¢˜ï¼šN+1æŸ¥è¯¢é—®é¢˜
@Service
public class OrderService {
    
    // é”™è¯¯ï¼šä¼šäº§ç”ŸN+1æŸ¥è¯¢é—®é¢˜
    public List<OrderDTO> getAllOrdersWithItems() {
        List<Order> orders = orderRepository.findAll();
        return orders.stream()
            .map(order -> {
                // æ¯ä¸ªè®¢å•éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œæ€§èƒ½å¾ˆå·®
                List<OrderItem> items = orderItemRepository.findByOrderId(order.getId());
                return new OrderDTO(order, items);
            })
            .collect(Collectors.toList());
    }
    
    // é”™è¯¯ï¼šæ²¡æœ‰åˆ†é¡µï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
    public List<Order> getAllOrders() {
        return orderRepository.findAll(); // å¯èƒ½è¿”å›æ•°ç™¾ä¸‡æ¡è®°å½•
    }
}

// âŒ æ€§èƒ½é—®é¢˜ï¼šä½æ•ˆçš„ç®—æ³•å®ç°
public class ReportService {
    
    // é”™è¯¯ï¼šO(nÂ²)æ—¶é—´å¤æ‚åº¦
    public List<User> findDuplicateUsers(List<User> users) {
        List<User> duplicates = new ArrayList<>();
        for (int i = 0; i < users.size(); i++) {
            for (int j = i + 1; j < users.size(); j++) {
                if (users.get(i).getEmail().equals(users.get(j).getEmail())) {
                    duplicates.add(users.get(j));
                }
            }
        }
        return duplicates;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨JOINé¿å…N+1æŸ¥è¯¢é—®é¢˜
@Service
public class OrderService {
    
    // æ­£ç¡®ï¼šä½¿ç”¨JOINä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®
    public List<OrderDTO> getAllOrdersWithItems(Pageable pageable) {
        Page<Order> orders = orderRepository.findAllWithItems(pageable);
        return orders.getContent().stream()
            .map(order -> new OrderDTO(order, order.getItems()))
            .collect(Collectors.toList());
    }
    
    // æ­£ç¡®ï¼šä½¿ç”¨åˆ†é¡µé¿å…å†…å­˜é—®é¢˜
    public Page<Order> getAllOrders(Pageable pageable) {
        return orderRepository.findAll(pageable);
    }
    
    // æ­£ç¡®ï¼šä½¿ç”¨ç¼“å­˜æé«˜æ€§èƒ½
    @Cacheable(value = "orders", key = "#orderId")
    public Order getOrderById(Long orderId) {
        return orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException("Order not found: " + orderId));
    }
}

@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    // æ­£ç¡®ï¼šä½¿ç”¨JOIN FETCHä¼˜åŒ–æŸ¥è¯¢
    @Query("SELECT o FROM Order o JOIN FETCH o.items WHERE o.status = :status")
    Page<Order> findAllWithItems(@Param("status") String status, Pageable pageable);
    
    // æ­£ç¡®ï¼šä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
    @Query("SELECT o FROM Order o WHERE o.createTime BETWEEN :start AND :end")
    List<Order> findByCreateTimeBetween(@Param("start") LocalDateTime start, 
                                       @Param("end") LocalDateTime end);
}

// âœ… æ­£ç¡®ï¼šé«˜æ•ˆçš„ç®—æ³•å®ç°
public class ReportService {
    
    // æ­£ç¡®ï¼šO(n)æ—¶é—´å¤æ‚åº¦
    public List<User> findDuplicateUsers(List<User> users) {
        Map<String, User> emailMap = new HashMap<>();
        List<User> duplicates = new ArrayList<>();
        
        for (User user : users) {
            String email = user.getEmail();
            if (emailMap.containsKey(email)) {
                duplicates.add(user);
            } else {
                emailMap.put(email, user);
            }
        }
        
        return duplicates;
    }
    
    // æ­£ç¡®ï¼šä½¿ç”¨å¹¶è¡Œæµå¤„ç†å¤§æ•°æ®é‡
    public Map<String, Long> generateUserStatistics(List<User> users) {
        return users.parallelStream()
            .collect(Collectors.groupingBy(
                User::getStatus,
                Collectors.counting()
            ));
    }
}
```

### 4.19.3.2 å®‰å…¨éœ€æ±‚å®ç°æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æŸ¥å®‰å…¨æ§åˆ¶æªæ–½çš„æ­£ç¡®å®ç°

b. éªŒè¯è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç çš„å®Œæ•´æ€§

c. ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨å¤„ç†

**2. æ£€æµ‹æ–¹æ³•**

1. å®‰å…¨ä»£ç å®¡æŸ¥å·¥å…·

2. æ¸—é€æµ‹è¯•å’Œå®‰å…¨æ‰«æ

3. ä¾èµ–æ¼æ´æ‰«æ

4. å®‰å…¨ä¸“å®¶ä»£ç å®¡æŸ¥

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å®‰å…¨é—®é¢˜ï¼šSQLæ³¨å…¥æ¼æ´
@Repository
public class UserRepository {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    // é”™è¯¯ï¼šç›´æ¥æ‹¼æ¥SQLï¼Œå­˜åœ¨SQLæ³¨å…¥é£é™©
    public List<User> findByName(String name) {
        String sql = "SELECT * FROM users WHERE name = '" + name + "'";
        return jdbcTemplate.query(sql, new UserRowMapper());
    }
}

// âŒ å®‰å…¨é—®é¢˜ï¼šå¯†ç æ˜æ–‡å­˜å‚¨
@Service
public class UserService {
    
    // é”™è¯¯ï¼šå¯†ç æ˜æ–‡å­˜å‚¨
    public User createUser(String username, String password) {
        User user = new User();
        user.setUsername(username);
        user.setPassword(password); // æ˜æ–‡å¯†ç ï¼Œå®‰å…¨é£é™©æé«˜
        return userRepository.save(user);
    }
    
    // é”™è¯¯ï¼šæ•æ„Ÿä¿¡æ¯è®°å½•åˆ°æ—¥å¿—
    public boolean authenticate(String username, String password) {
        log.info("User {} attempting login with password {}", username, password);
        // ...
    }
}

// âŒ å®‰å…¨é—®é¢˜ï¼šç¼ºå°‘æƒé™éªŒè¯
@RestController
public class AdminController {
    
    // é”™è¯¯ï¼šç¼ºå°‘æƒé™éªŒè¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®
    @DeleteMapping("/users/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.deleteUser(id);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
@Repository
public class UserRepository {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    // æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    public List<User> findByName(String name) {
        String sql = "SELECT * FROM users WHERE name = ?";
        return jdbcTemplate.query(sql, new UserRowMapper(), name);
    }
    
    // æ­£ç¡®ï¼šä½¿ç”¨JPAæŸ¥è¯¢æ–¹æ³•
    @Query("SELECT u FROM User u WHERE u.name = :name")
    List<User> findByNameSafe(@Param("name") String name);
}

// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„å¯†ç å¤„ç†
@Service
public class UserService {
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    // æ­£ç¡®ï¼šå¯†ç åŠ å¯†å­˜å‚¨
    public User createUser(String username, String password) {
        User user = new User();
        user.setUsername(username);
        // ä½¿ç”¨BCryptç­‰å¼ºåŠ å¯†ç®—æ³•
        user.setPassword(passwordEncoder.encode(password));
        return userRepository.save(user);
    }
    
    // æ­£ç¡®ï¼šå®‰å…¨çš„è®¤è¯å®ç°
    public boolean authenticate(String username, String password) {
        log.info("User {} attempting login", username); // ä¸è®°å½•å¯†ç 
        
        User user = userRepository.findByUsername(username);
        if (user == null) {
            return false;
        }
        
        return passwordEncoder.matches(password, user.getPassword());
    }
    
    // æ­£ç¡®ï¼šæ•æ„Ÿæ•°æ®è„±æ•
    public UserDTO getUserInfo(Long userId) {
        User user = userRepository.findById(userId);
        UserDTO dto = new UserDTO();
        dto.setUsername(user.getUsername());
        // æ•æ„Ÿä¿¡æ¯è„±æ•
        dto.setEmail(maskEmail(user.getEmail()));
        dto.setPhone(maskPhone(user.getPhone()));
        return dto;
    }
    
    private String maskEmail(String email) {
        if (email == null || email.length() < 3) {
            return "***";
        }
        int atIndex = email.indexOf('@');
        if (atIndex > 0) {
            return email.substring(0, 1) + "***" + email.substring(atIndex);
        }
        return "***";
    }
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æƒé™éªŒè¯
@RestController
@RequestMapping("/api/admin")
public class AdminController {
    
    // æ­£ç¡®ï¼šä½¿ç”¨Spring Securityè¿›è¡Œæƒé™éªŒè¯
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/users/{id}")
    public ResponseEntity<Void> deleteUser(@PathVariable Long id) {
        // é¢å¤–çš„ä¸šåŠ¡æƒé™æ£€æŸ¥
        if (!userService.canDeleteUser(id)) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).build();
        }
        
        userService.deleteUser(id);
        return ResponseEntity.ok().build();
    }
    
    // æ­£ç¡®ï¼šè¾“å…¥éªŒè¯å’ŒXSSé˜²æŠ¤
    @PostMapping("/announcements")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Announcement> createAnnouncement(
            @Valid @RequestBody CreateAnnouncementRequest request) {
        
        // è¾“å…¥éªŒè¯
        if (request.getContent().length() > 1000) {
            throw new ValidationException("Content too long");
        }
        
        // XSSé˜²æŠ¤ï¼šHTMLç¼–ç 
        String safeContent = HtmlUtils.htmlEscape(request.getContent());
        
        Announcement announcement = announcementService.create(safeContent);
        return ResponseEntity.ok(announcement);
    }
}

// âœ… æ­£ç¡®ï¼šå®‰å…¨é…ç½®
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12); // å¼ºåŠ å¯†å¼ºåº¦
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/api/public/**").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            .csrf(csrf -> csrf.disable()) // ä»…åœ¨ä½¿ç”¨JWTæ—¶ç¦ç”¨
            .headers(headers -> headers
                .frameOptions().deny()
                .contentTypeOptions().and()
                .httpStrictTransportSecurity(hstsConfig -> hstsConfig
                    .maxAgeInSeconds(31536000)
                    .includeSubdomains(true)
                )
            );
        
        return http.build();
    }
}
```

### 4.19.3.3 å¯ç»´æŠ¤æ€§éœ€æ±‚æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æŸ¥ä»£ç çš„å¯è¯»æ€§å’Œå¯ç†è§£æ€§

b. éªŒè¯ä»£ç çš„æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§

c. ç¡®ä¿ä»£ç çš„å¯æµ‹è¯•æ€§å’Œå¯è°ƒè¯•æ€§

**2. æ£€æµ‹æ–¹æ³•**

1. ä»£ç å¤æ‚åº¦åˆ†æå·¥å…·

2. ä»£ç é‡å¤åº¦æ£€æµ‹

3. ä¾èµ–å…³ç³»åˆ†æ

4. ä»£ç è¦†ç›–ç‡æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å¯ç»´æŠ¤æ€§é—®é¢˜ï¼šæ–¹æ³•è¿‡é•¿ï¼Œé€»è¾‘å¤æ‚
public class OrderProcessor {
    
    // é”™è¯¯ï¼šæ–¹æ³•è¿‡é•¿ï¼ŒèŒè´£ä¸æ¸…æ™°ï¼Œéš¾ä»¥ç»´æŠ¤
    public void processOrder(Order order) {
        // éªŒè¯è®¢å•
        if (order == null || order.getItems() == null || order.getItems().isEmpty()) {
            throw new IllegalArgumentException("Invalid order");
        }
        
        // è®¡ç®—ä»·æ ¼
        BigDecimal total = BigDecimal.ZERO;
        for (OrderItem item : order.getItems()) {
            if (item.getQuantity() <= 0) {
                throw new IllegalArgumentException("Invalid quantity");
            }
            BigDecimal itemTotal = item.getPrice().multiply(new BigDecimal(item.getQuantity()));
            total = total.add(itemTotal);
        }
        
        // åº”ç”¨æŠ˜æ‰£
        if (order.getUser().isVip()) {
            total = total.multiply(new BigDecimal("0.9"));
        }
        
        // æ£€æŸ¥åº“å­˜
        for (OrderItem item : order.getItems()) {
            Product product = productRepository.findById(item.getProductId());
            if (product.getStock() < item.getQuantity()) {
                throw new RuntimeException("Insufficient stock for product: " + product.getName());
            }
        }
        
        // æ›´æ–°åº“å­˜
        for (OrderItem item : order.getItems()) {
            Product product = productRepository.findById(item.getProductId());
            product.setStock(product.getStock() - item.getQuantity());
            productRepository.save(product);
        }
        
        // å¤„ç†æ”¯ä»˜
        PaymentRequest paymentRequest = new PaymentRequest();
        paymentRequest.setAmount(total);
        paymentRequest.setUserId(order.getUserId());
        PaymentResult result = paymentService.processPayment(paymentRequest);
        
        if (!result.isSuccess()) {
            // å›æ»šåº“å­˜
            for (OrderItem item : order.getItems()) {
                Product product = productRepository.findById(item.getProductId());
                product.setStock(product.getStock() + item.getQuantity());
                productRepository.save(product);
            }
            throw new RuntimeException("Payment failed");
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus("PAID");
        order.setTotal(total);
        orderRepository.save(order);
        
        // å‘é€é€šçŸ¥
        emailService.sendOrderConfirmation(order);
        smsService.sendOrderNotification(order);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šè‰¯å¥½çš„å¯ç»´æŠ¤æ€§è®¾è®¡
@Service
public class OrderProcessor {
    
    private final OrderValidator orderValidator;
    private final PriceCalculator priceCalculator;
    private final InventoryService inventoryService;
    private final PaymentService paymentService;
    private final NotificationService notificationService;
    private final OrderRepository orderRepository;
    
    // æ­£ç¡®ï¼šä¸»æ–¹æ³•ç®€æ´æ¸…æ™°ï¼ŒèŒè´£æ˜ç¡®
    @Transactional
    public void processOrder(Order order) {
        // 1. éªŒè¯è®¢å•
        orderValidator.validate(order);
        
        // 2. è®¡ç®—ä»·æ ¼
        BigDecimal total = priceCalculator.calculateTotal(order);
        
        // 3. æ£€æŸ¥å’Œé¢„ç•™åº“å­˜
        inventoryService.reserveInventory(order);
        
        try {
            // 4. å¤„ç†æ”¯ä»˜
            PaymentResult result = paymentService.processPayment(order, total);
            
            // 5. ç¡®è®¤è®¢å•
            confirmOrder(order, total);
            
            // 6. å‘é€é€šçŸ¥
            notificationService.sendOrderConfirmation(order);
            
        } catch (PaymentException e) {
            // æ”¯ä»˜å¤±è´¥æ—¶å›æ»šåº“å­˜
            inventoryService.releaseReservation(order);
            throw new OrderProcessingException("Payment failed", e);
        }
    }
    
    private void confirmOrder(Order order, BigDecimal total) {
        order.setStatus(OrderStatus.PAID);
        order.setTotal(total);
        order.setProcessedAt(LocalDateTime.now());
        orderRepository.save(order);
    }
}

// âœ… æ­£ç¡®ï¼šå•ä¸€èŒè´£çš„éªŒè¯å™¨
@Component
public class OrderValidator {
    
    public void validate(Order order) {
        validateOrderBasics(order);
        validateOrderItems(order.getItems());
        validateUser(order.getUser());
    }
    
    private void validateOrderBasics(Order order) {
        if (order == null) {
            throw new ValidationException("Order cannot be null");
        }
        if (order.getItems() == null || order.getItems().isEmpty()) {
            throw new ValidationException("Order must contain at least one item");
        }
    }
    
    private void validateOrderItems(List<OrderItem> items) {
        for (OrderItem item : items) {
            if (item.getQuantity() <= 0) {
                throw new ValidationException(
                    String.format("Invalid quantity %d for item %s", 
                                 item.getQuantity(), item.getProductId()));
            }
            if (item.getPrice() == null || item.getPrice().compareTo(BigDecimal.ZERO) <= 0) {
                throw new ValidationException(
                    String.format("Invalid price for item %s", item.getProductId()));
            }
        }
    }
    
    private void validateUser(User user) {
        if (user == null || user.getId() == null) {
            throw new ValidationException("Valid user is required");
        }
    }
}

// âœ… æ­£ç¡®ï¼šå¯æ‰©å±•çš„ä»·æ ¼è®¡ç®—å™¨
@Component
public class PriceCalculator {
    
    private final List<DiscountStrategy> discountStrategies;
    
    public PriceCalculator(List<DiscountStrategy> discountStrategies) {
        this.discountStrategies = discountStrategies;
    }
    
    public BigDecimal calculateTotal(Order order) {
        BigDecimal subtotal = calculateSubtotal(order.getItems());
        BigDecimal discount = calculateDiscount(order, subtotal);
        return subtotal.subtract(discount);
    }
    
    private BigDecimal calculateSubtotal(List<OrderItem> items) {
        return items.stream()
            .map(item -> item.getPrice().multiply(new BigDecimal(item.getQuantity())))
            .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
    
    private BigDecimal calculateDiscount(Order order, BigDecimal subtotal) {
        return discountStrategies.stream()
            .filter(strategy -> strategy.isApplicable(order))
            .map(strategy -> strategy.calculateDiscount(order, subtotal))
            .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}

// âœ… æ­£ç¡®ï¼šå¯æ‰©å±•çš„æŠ˜æ‰£ç­–ç•¥
public interface DiscountStrategy {
    boolean isApplicable(Order order);
    BigDecimal calculateDiscount(Order order, BigDecimal subtotal);
}

@Component
public class VipDiscountStrategy implements DiscountStrategy {
    
    private static final BigDecimal VIP_DISCOUNT_RATE = new BigDecimal("0.1");
    
    @Override
    public boolean isApplicable(Order order) {
        return order.getUser().isVip();
    }
    
    @Override
    public BigDecimal calculateDiscount(Order order, BigDecimal subtotal) {
        return subtotal.multiply(VIP_DISCOUNT_RATE);
    }
}

// âœ… æ­£ç¡®ï¼šç»Ÿä¸€çš„é€šçŸ¥æœåŠ¡
@Service
public class NotificationService {
    
    private final List<NotificationChannel> channels;
    
    public NotificationService(List<NotificationChannel> channels) {
        this.channels = channels;
    }
    
    public void sendOrderConfirmation(Order order) {
        OrderNotification notification = OrderNotification.builder()
            .orderId(order.getId())
            .userId(order.getUserId())
            .type(NotificationType.ORDER_CONFIRMATION)
            .build();
            
        channels.forEach(channel -> {
            try {
                channel.send(notification);
            } catch (Exception e) {
                log.warn("Failed to send notification via {}: {}", 
                        channel.getClass().getSimpleName(), e.getMessage());
            }
        });
    }
}

// âœ… æ­£ç¡®ï¼šå¯æµ‹è¯•çš„è®¾è®¡
@ExtendWith(MockitoExtension.class)
class OrderProcessorTest {
    
    @Mock private OrderValidator orderValidator;
    @Mock private PriceCalculator priceCalculator;
    @Mock private InventoryService inventoryService;
    @Mock private PaymentService paymentService;
    @Mock private NotificationService notificationService;
    @Mock private OrderRepository orderRepository;
    
    @InjectMocks
    private OrderProcessor orderProcessor;
    
    @Test
    void shouldProcessOrderSuccessfully() {
        // Given
        Order order = createTestOrder();
        BigDecimal total = new BigDecimal("100.00");
        
        when(priceCalculator.calculateTotal(order)).thenReturn(total);
        when(paymentService.processPayment(order, total))
            .thenReturn(PaymentResult.success());
        
        // When
        orderProcessor.processOrder(order);
        
        // Then
        verify(orderValidator).validate(order);
        verify(inventoryService).reserveInventory(order);
        verify(paymentService).processPayment(order, total);
        verify(notificationService).sendOrderConfirmation(order);
        verify(orderRepository).save(order);
    }
    
    @Test
    void shouldReleaseInventoryWhenPaymentFails() {
        // Given
        Order order = createTestOrder();
        BigDecimal total = new BigDecimal("100.00");
        
        when(priceCalculator.calculateTotal(order)).thenReturn(total);
        when(paymentService.processPayment(order, total))
            .thenThrow(new PaymentException("Payment failed"));
        
        // When & Then
        assertThrows(OrderProcessingException.class, 
                    () -> orderProcessor.processOrder(order));
        
        verify(inventoryService).releaseReservation(order);
    }
    
    private Order createTestOrder() {
        // åˆ›å»ºæµ‹è¯•è®¢å•çš„è¾…åŠ©æ–¹æ³•
        return Order.builder()
            .id(1L)
            .userId(1L)
            .items(List.of(createTestOrderItem()))
            .build();
    }
}
```