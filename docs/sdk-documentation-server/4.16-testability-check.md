# ç¬¬4.16ç«  å¯æµ‹è¯•æ€§æ£€æŸ¥

## 4.16.1 æŒç»­é›†æˆæ£€æŸ¥

### 4.16.1.1 æ„å»ºè„šæœ¬å¯é‡å¤æ€§æ£€æŸ¥ ğŸ”´

#### 1. æ£€æµ‹ç›®æ ‡

a. æ„å»ºè„šæœ¬å¿…é¡»åœ¨ä¸åŒç¯å¢ƒä¸‹äº§ç”Ÿä¸€è‡´çš„ç»“æœ
b. æ„å»ºè¿‡ç¨‹ä¸ä¾èµ–æœ¬åœ°ç¯å¢ƒç‰¹å®šé…ç½®
c. æ„å»ºè„šæœ¬æ”¯æŒå¤šç¯å¢ƒå‚æ•°åŒ–é…ç½®
d. æ„å»ºäº§ç‰©å…·æœ‰ç¡®å®šæ€§å’Œå¯è¿½æº¯æ€§

#### 2. æ£€æµ‹æ–¹æ³•

1. å¤šç¯å¢ƒæ„å»ºæµ‹è¯•ï¼ˆæœ¬åœ°ã€CIã€Dockerå®¹å™¨ï¼‰
2. æ„å»ºäº§ç‰©ä¸€è‡´æ€§éªŒè¯ï¼ˆchecksumå¯¹æ¯”ï¼‰
3. ä¾èµ–ç‰ˆæœ¬é”å®šæ£€æŸ¥
4. ç¯å¢ƒå˜é‡ä¾èµ–åˆ†æ

#### 3. é”™è¯¯ç¤ºä¾‹

```yaml
# âŒ é”™è¯¯ï¼šä¾èµ–æœ¬åœ°ç¯å¢ƒçš„æ„å»ºè„šæœ¬
name: Build
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    # å±é™©ï¼šæ²¡æœ‰æŒ‡å®šJavaç‰ˆæœ¬
    - name: Set up JDK
      uses: actions/setup-java@v2
    # å±é™©ï¼šä¾èµ–æœ¬åœ°Mavené…ç½®
    - name: Build
      run: mvn clean package
    # å±é™©ï¼šä½¿ç”¨latestæ ‡ç­¾ï¼Œä¸ç¡®å®šæ€§
    - name: Build Docker
      run: docker build -t myapp:latest .
```

#### 4. æ­£ç¡®ç¤ºä¾‹

```yaml
# âœ… æ­£ç¡®ï¼šå¯é‡å¤çš„æ„å»ºè„šæœ¬
name: Reproducible Build
env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.8.6'
  NODE_VERSION: '18.17.0'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
    
    - name: Build with locked dependencies
      run: |
        mvn clean package \
          -Dmaven.test.skip=false \
          -Drevision=${{ github.sha }} \
          -Dbuild.timestamp=$(date -u +%Y%m%d%H%M%S)
    
    - name: Verify build reproducibility
      run: |
        sha256sum target/*.jar > build-checksums.txt
        cat build-checksums.txt
```

### 4.16.1.2 è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥ ğŸ”´

#### 1. æ£€æµ‹ç›®æ ‡

a. å•å…ƒæµ‹è¯•è¦†ç›–ç‡ä¸ä½äº80%
b. é›†æˆæµ‹è¯•è¦†ç›–å…³é”®ä¸šåŠ¡æµç¨‹
c. æµ‹è¯•ç”¨ä¾‹è¦†ç›–æ­£å¸¸å’Œå¼‚å¸¸åœºæ™¯
d. æµ‹è¯•æ‰§è¡Œæ—¶é—´æ§åˆ¶åœ¨åˆç†èŒƒå›´å†…

#### 2. æ£€æµ‹æ–¹æ³•

1. JaCoCoä»£ç è¦†ç›–ç‡åˆ†æ
2. SonarQubeè´¨é‡é—¨ç¦æ£€æŸ¥
3. æµ‹è¯•ç”¨ä¾‹æœ‰æ•ˆæ€§éªŒè¯
4. æµ‹è¯•æ‰§è¡Œæ—¶é—´ç›‘æ§

#### 3. é”™è¯¯ç¤ºä¾‹

```java
// âŒ é”™è¯¯ï¼šæµ‹è¯•è¦†ç›–ç‡ä¸è¶³
@Test
void testCreateUser() {
    // åªæµ‹è¯•æ­£å¸¸åœºæ™¯ï¼Œæ²¡æœ‰å¼‚å¸¸åœºæ™¯
    User user = userService.createUser("john", "john@example.com");
    assertNotNull(user);
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰é›†æˆæµ‹è¯•
public class UserService {
    public User createUser(String name, String email) {
        // å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ²¡æœ‰é›†æˆæµ‹è¯•
        validateUser(name, email);
        User user = new User(name, email);
        userRepository.save(user);
        emailService.sendWelcomeEmail(user);
        return user;
    }
}
```

#### 4. æ­£ç¡®ç¤ºä¾‹

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æµ‹è¯•è¦†ç›–
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock private UserRepository userRepository;
    @Mock private EmailService emailService;
    @InjectMocks private UserService userService;
    
    @Test
    void shouldCreateUserSuccessfully() {
        // Given
        String name = "John Doe";
        String email = "john@example.com";
        User savedUser = new User(1L, name, email);
        
        when(userRepository.save(any(User.class))).thenReturn(savedUser);
        
        // When
        User result = userService.createUser(name, email);
        
        // Then
        assertThat(result.getName()).isEqualTo(name);
        assertThat(result.getEmail()).isEqualTo(email);
        verify(emailService).sendWelcomeEmail(result);
    }
    
    @Test
    void shouldThrowExceptionWhenEmailInvalid() {
        // Given
        String name = "John Doe";
        String invalidEmail = "invalid-email";
        
        // When & Then
        assertThatThrownBy(() -> userService.createUser(name, invalidEmail))
            .isInstanceOf(InvalidEmailException.class)
            .hasMessage("Invalid email format: " + invalidEmail);
        
        verify(userRepository, never()).save(any());
        verify(emailService, never()).sendWelcomeEmail(any());
    }
}

// âœ… æ­£ç¡®ï¼šé›†æˆæµ‹è¯•
@SpringBootTest
@Testcontainers
class UserServiceIntegrationTest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:14")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    @Autowired private UserService userService;
    @Autowired private UserRepository userRepository;
    
    @Test
    void shouldCreateUserEndToEnd() {
        // Given
        String name = "Integration Test User";
        String email = "integration@test.com";
        
        // When
        User createdUser = userService.createUser(name, email);
        
        // Then
        assertThat(createdUser.getId()).isNotNull();
        
        User foundUser = userRepository.findById(createdUser.getId()).orElse(null);
        assertThat(foundUser).isNotNull();
        assertThat(foundUser.getName()).isEqualTo(name);
        assertThat(foundUser.getEmail()).isEqualTo(email);
    }
}
```

### 4.16.1.3 ä»£ç è´¨é‡é—¨ç¦æ£€æŸ¥ ğŸŸ¡

#### 1. æ£€æµ‹ç›®æ ‡

a. ä»£ç è´¨é‡æŒ‡æ ‡è¾¾åˆ°é¢„è®¾é˜ˆå€¼
b. å®‰å…¨æ¼æ´æ£€æµ‹é€šè¿‡
c. ä»£ç é‡å¤ç‡æ§åˆ¶åœ¨åˆç†èŒƒå›´
d. æŠ€æœ¯å€ºåŠ¡å¢é‡æ§åˆ¶

#### 2. æ£€æµ‹æ–¹æ³•

1. SonarQubeè´¨é‡é—¨ç¦é…ç½®
2. é™æ€ä»£ç åˆ†æå·¥å…·é›†æˆ
3. å®‰å…¨æ‰«æå·¥å…·æ£€æŸ¥
4. ä»£ç å®¡æŸ¥æµç¨‹éªŒè¯

#### 3. é”™è¯¯ç¤ºä¾‹

```yaml
# âŒ é”™è¯¯ï¼šç¼ºå°‘è´¨é‡é—¨ç¦çš„CIé…ç½®
name: Build
jobs:
  build:
    steps:
    - name: Build
      run: mvn clean package
    # å±é™©ï¼šæ²¡æœ‰ä»£ç è´¨é‡æ£€æŸ¥
    # å±é™©ï¼šæ²¡æœ‰å®‰å…¨æ‰«æ
    # å±é™©ï¼šæ²¡æœ‰è´¨é‡é—¨ç¦
```

#### 4. æ­£ç¡®ç¤ºä¾‹

```yaml
# âœ… æ­£ç¡®ï¼šå®Œæ•´çš„è´¨é‡é—¨ç¦é…ç½®
name: Quality Gate
jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Run tests with coverage
      run: mvn clean verify jacoco:report
    
    - name: SonarQube analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        mvn sonar:sonar \
          -Dsonar.projectKey=my-project \
          -Dsonar.organization=my-org \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
          -Dsonar.qualitygate.wait=true
    
    - name: Security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
    
    - name: Dependency check
      run: |
        mvn org.owasp:dependency-check-maven:check \
          -DfailBuildOnCVSS=7
```

### é”™è¯¯ç¤ºä¾‹

```yaml
# âŒ é”™è¯¯ï¼šä¸å®Œæ•´çš„CIé…ç½®
name: Build
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    # å±é™©ï¼šæ²¡æœ‰æŒ‡å®šJavaç‰ˆæœ¬
    - name: Set up JDK
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'temurin'
    
    # å±é™©ï¼šæ²¡æœ‰ç¼“å­˜ä¾èµ–
    - name: Build with Maven
      run: mvn clean compile
    
    # å±é™©ï¼šæ²¡æœ‰è¿è¡Œæµ‹è¯•
    # å±é™©ï¼šæ²¡æœ‰ä»£ç è´¨é‡æ£€æŸ¥
    # å±é™©ï¼šæ²¡æœ‰æ„å»ºäº§ç‰©ä¸Šä¼ 
```

**é—®é¢˜åˆ†æï¼š**
- æ²¡æœ‰æŒ‡å®šæ˜ç¡®çš„Javaç‰ˆæœ¬å’Œå‘è¡Œç‰ˆ
- ç¼ºå°‘ä¾èµ–ç¼“å­˜ï¼Œå¯¼è‡´æ„å»ºæ—¶é—´è¿‡é•¿
- æ²¡æœ‰è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
- ç¼ºå°‘ä»£ç è´¨é‡æ£€æŸ¥æ­¥éª¤
- æ²¡æœ‰ä¸Šä¼ æ„å»ºäº§ç‰©

### æ­£ç¡®ç¤ºä¾‹

```yaml
# âœ… æ­£ç¡®ï¼šå®Œæ•´çš„CIé…ç½®
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  MAVEN_OPTS: -Dmaven.repo.local=${{ github.workspace }}/.m2/repository

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºSonarQubeåˆ†æ
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: Run tests
      run: |
        mvn clean test \
          -Dspring.profiles.active=test \
          -Dspring.datasource.url=jdbc:mysql://localhost:3306/testdb \
          -Dspring.datasource.username=root \
          -Dspring.datasource.password=root
    
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
    
    - name: Code coverage
      run: mvn jacoco:report
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: target/site/jacoco/jacoco.xml
    
    - name: SonarQube analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        mvn sonar:sonar \
          -Dsonar.projectKey=my-project \
          -Dsonar.organization=my-org \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
    
    - name: Build application
      run: mvn clean package -DskipTests
    
    - name: Build Docker image
      run: |
        docker build -t my-app:${{ github.sha }} .
        docker tag my-app:${{ github.sha }} my-app:latest
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: jar-artifact
        path: target/*.jar
        retention-days: 30
```

**ä¼˜åŠ¿åˆ†æï¼š**
- æ˜ç¡®æŒ‡å®šJavaç‰ˆæœ¬å’Œå‘è¡Œç‰ˆ
- ä½¿ç”¨ä¾èµ–ç¼“å­˜æé«˜æ„å»ºæ•ˆç‡
- åŒ…å«å®Œæ•´çš„æµ‹è¯•å’Œä»£ç è¦†ç›–ç‡æ£€æŸ¥
- é›†æˆSonarQubeè¿›è¡Œä»£ç è´¨é‡åˆ†æ
- æ„å»ºDockeré•œåƒå¹¶ä¸Šä¼ æ„å»ºäº§ç‰©
- æ”¯æŒå¤šåˆ†æ”¯å’ŒPull Requestè§¦å‘

## 4.16.2 éƒ¨ç½²ç­–ç•¥æ£€æŸ¥

### æ£€æµ‹ç›®æ ‡

- ç¡®ä¿éƒ¨ç½²ç­–ç•¥å®‰å…¨å¯é 
- æ”¯æŒè“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°ç­–ç•¥
- éƒ¨ç½²è¿‡ç¨‹ä¸­æœåŠ¡å¯ç”¨æ€§ä¸ä½äº99%
- å…·å¤‡å¿«é€Ÿå›æ»šæœºåˆ¶ï¼ˆ5åˆ†é’Ÿå†…å®Œæˆï¼‰
- éƒ¨ç½²åè‡ªåŠ¨è¿›è¡Œå¥åº·æ£€æŸ¥
- æ”¯æŒé‡‘ä¸é›€å‘å¸ƒå’Œæµé‡æ§åˆ¶
- éƒ¨ç½²è¿‡ç¨‹æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•

### æ£€æµ‹æ–¹æ³•

- éƒ¨ç½²æµ‹è¯•ï¼šéªŒè¯ä¸åŒéƒ¨ç½²ç­–ç•¥çš„æœ‰æ•ˆæ€§
- å¯ç”¨æ€§æµ‹è¯•ï¼šæµ‹è¯•éƒ¨ç½²è¿‡ç¨‹ä¸­çš„æœåŠ¡å¯ç”¨æ€§
- å›æ»šæµ‹è¯•ï¼šéªŒè¯å›æ»šæœºåˆ¶çš„é€Ÿåº¦å’Œå¯é æ€§
- å¥åº·æ£€æŸ¥ï¼šéªŒè¯éƒ¨ç½²åçš„å¥åº·æ£€æŸ¥æœºåˆ¶

### é”™è¯¯ç¤ºä¾‹

```yaml
# âŒ é”™è¯¯ï¼šç®€å•ç²—æš´çš„éƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-app
        image: my-app:latest
        ports:
        - containerPort: 8080
        # å±é™©ï¼šæ²¡æœ‰å¥åº·æ£€æŸ¥
        # å±é™©ï¼šæ²¡æœ‰èµ„æºé™åˆ¶
        # å±é™©ï¼šæ²¡æœ‰ä¼˜é›…å…³é—­é…ç½®
  # å±é™©ï¼šæ²¡æœ‰éƒ¨ç½²ç­–ç•¥é…ç½®
```

**é—®é¢˜åˆ†æï¼š**
- ä½¿ç”¨latestæ ‡ç­¾ï¼Œæ— æ³•ç¡®ä¿ç‰ˆæœ¬ä¸€è‡´æ€§
- ç¼ºå°‘å¥åº·æ£€æŸ¥é…ç½®
- æ²¡æœ‰èµ„æºé™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´èµ„æºäº‰ç”¨
- ç¼ºå°‘ä¼˜é›…å…³é—­é…ç½®
- æ²¡æœ‰éƒ¨ç½²ç­–ç•¥ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­

### æ­£ç¡®ç¤ºä¾‹

```yaml
# âœ… æ­£ç¡®ï¼šå®Œæ•´çš„éƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
  labels:
    app: my-app
    version: v1.0.0
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # ç¡®ä¿æœåŠ¡å¯ç”¨æ€§
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
        version: v1.0.0
    spec:
      containers:
      - name: my-app
        image: my-app:v1.0.0
        ports:
        - containerPort: 8080
          name: http
        
        # å¥åº·æ£€æŸ¥é…ç½®
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: JVM_OPTS
          value: "-Xms512m -Xmx1g -XX:+UseG1GC"
        
        # ä¼˜é›…å…³é—­
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]
      
      # ä¼˜é›…å…³é—­æ—¶é—´
      terminationGracePeriodSeconds: 30
      
      # é•œåƒæ‹‰å–ç­–ç•¥
      imagePullSecrets:
      - name: registry-secret

---
# æœåŠ¡é…ç½®
apiVersion: v1
kind: Service
metadata:
  name: my-app-service
spec:
  selector:
    app: my-app
  ports:
  - port: 80
    targetPort: 8080
    name: http
  type: ClusterIP

---
# HPAé…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: my-app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-app
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

**ä¼˜åŠ¿åˆ†æï¼š**
- ä½¿ç”¨æ˜ç¡®çš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œç¡®ä¿éƒ¨ç½²ä¸€è‡´æ€§
- é…ç½®å®Œæ•´çš„å¥åº·æ£€æŸ¥æœºåˆ¶
- è®¾ç½®åˆç†çš„èµ„æºé™åˆ¶å’Œè¯·æ±‚
- æ”¯æŒæ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼Œç¡®ä¿æœåŠ¡å¯ç”¨æ€§
- åŒ…å«HPAè‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®
- é…ç½®ä¼˜é›…å…³é—­æœºåˆ¶ï¼Œé¿å…è¯·æ±‚ä¸¢å¤±

## 4.16.3 ç›‘æ§å‘Šè­¦æ£€æŸ¥

### æ£€æµ‹ç›®æ ‡

- ç¡®ä¿ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦æœºåˆ¶å®Œå–„
- ä¸šåŠ¡å…³é”®æŒ‡æ ‡ç›‘æ§è¦†ç›–ç‡è¾¾åˆ°100%
- ç³»ç»Ÿèµ„æºç›‘æ§åŒ…å«CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰å…³é”®æŒ‡æ ‡
- å‘Šè­¦å“åº”æ—¶é—´ä¸è¶…è¿‡5åˆ†é’Ÿ
- æ—¥å¿—èšåˆå’Œåˆ†æç³»ç»Ÿå®Œæ•´
- ç›‘æ§æ•°æ®ä¿ç•™æœŸä¸å°‘äº30å¤©
- å‘Šè­¦è§„åˆ™é¿å…è¯¯æŠ¥å’Œæ¼æŠ¥

### æ£€æµ‹æ–¹æ³•

- ç›‘æ§æŒ‡æ ‡æ£€æŸ¥ï¼šéªŒè¯ä¸šåŠ¡å…³é”®æŒ‡æ ‡å’Œç³»ç»Ÿèµ„æºæŒ‡æ ‡çš„ç›‘æ§è¦†ç›–ç‡
- å‘Šè­¦æœºåˆ¶æµ‹è¯•ï¼šæ¨¡æ‹Ÿæ•…éšœåœºæ™¯éªŒè¯å‘Šè­¦è§¦å‘å’Œé€šçŸ¥æœºåˆ¶
- æ€§èƒ½å½±å“è¯„ä¼°ï¼šæµ‹è¯•ç›‘æ§ç³»ç»Ÿå¯¹åº”ç”¨æ€§èƒ½çš„å½±å“ç¨‹åº¦
- æ—¥å¿—ç³»ç»ŸéªŒè¯ï¼šæ£€æŸ¥æ—¥å¿—èšåˆã€å­˜å‚¨å’ŒæŸ¥è¯¢åŠŸèƒ½çš„å®Œæ•´æ€§
- æ•°æ®ä¿ç•™ç­–ç•¥ï¼šç¡®è®¤ç›‘æ§æ•°æ®å’Œæ—¥å¿—çš„ä¿ç•™æœŸç¬¦åˆè¦æ±‚

### é”™è¯¯ç¤ºä¾‹

```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘ç›‘æ§çš„æœåŠ¡
@RestController
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping("/orders")
    public ResponseEntity<Order> createOrder(@RequestBody OrderRequest request) {
        // å±é™©ï¼šæ²¡æœ‰ç›‘æ§æŒ‡æ ‡
        // å±é™©ï¼šæ²¡æœ‰æ—¥å¿—è®°å½•
        Order order = orderService.createOrder(request);
        return ResponseEntity.ok(order);
    }
    
    @GetMapping("/orders/{id}")
    public ResponseEntity<Order> getOrder(@PathVariable String id) {
        // å±é™©ï¼šæ²¡æœ‰æ€§èƒ½ç›‘æ§
        // å±é™©ï¼šæ²¡æœ‰é”™è¯¯å¤„ç†ç›‘æ§
        Order order = orderService.getOrder(id);
        return ResponseEntity.ok(order);
    }
}
```

**é—®é¢˜åˆ†æï¼š**
- ç¼ºå°‘ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡ï¼šæ— æ³•ç»Ÿè®¡è®¢å•åˆ›å»ºæˆåŠŸç‡ã€å“åº”æ—¶é—´ç­‰å…³é”®ä¸šåŠ¡æŒ‡æ ‡
- ç¼ºå°‘æ—¥å¿—è®°å½•ï¼šæ— æ³•è¿½è¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹ï¼Œéš¾ä»¥æ’æŸ¥é—®é¢˜
- ç¼ºå°‘æ€§èƒ½ç›‘æ§ï¼šæ— æ³•ç›‘æ§æ¥å£å“åº”æ—¶é—´å’Œååé‡
- ç¼ºå°‘é”™è¯¯ç›‘æ§ï¼šå¼‚å¸¸æƒ…å†µæ— æ³•åŠæ—¶å‘ç°å’Œå‘Šè­¦
- ç¼ºå°‘é“¾è·¯è¿½è¸ªï¼šæ— æ³•è·Ÿè¸ªè¯·æ±‚åœ¨å¾®æœåŠ¡é—´çš„è°ƒç”¨é“¾è·¯

### æ­£ç¡®ç¤ºä¾‹

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ç›‘æ§é…ç½®
@RestController
@Slf4j
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    @Autowired
    private MeterRegistry meterRegistry;
    
    private final Counter orderCreatedCounter;
    private final Timer orderCreationTimer;
    private final Gauge activeOrdersGauge;
    
    public OrderController(MeterRegistry meterRegistry, OrderService orderService) {
        this.meterRegistry = meterRegistry;
        this.orderService = orderService;
        
        // åˆå§‹åŒ–ç›‘æ§æŒ‡æ ‡
        this.orderCreatedCounter = Counter.builder("orders.created")
            .description("Total number of orders created")
            .register(meterRegistry);
        
        this.orderCreationTimer = Timer.builder("orders.creation.time")
            .description("Time taken to create an order")
            .register(meterRegistry);
        
        this.activeOrdersGauge = Gauge.builder("orders.active")
            .description("Number of active orders")
            .register(meterRegistry, this, OrderController::getActiveOrderCount);
    }
    
    @PostMapping("/orders")
    @Timed(value = "orders.creation.time", description = "Time taken to create an order")
    public ResponseEntity<OrderResponse> createOrder(@RequestBody OrderRequest request) {
        String traceId = MDC.get("traceId");
        
        log.info("Creating order for user: {}, traceId: {}", request.getUserId(), traceId);
        
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            Order order = orderService.createOrder(request);
            
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            orderCreatedCounter.increment(
                Tags.of(
                    "status", "success",
                    "user_type", request.getUserType()
                )
            );
            
            log.info("Order created successfully: {}, traceId: {}", order.getId(), traceId);
            
            return ResponseEntity.ok(OrderResponse.from(order));
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥æŒ‡æ ‡
            orderCreatedCounter.increment(
                Tags.of(
                    "status", "error",
                    "error_type", e.getClass().getSimpleName()
                )
            );
            
            log.error("Failed to create order for user: {}, traceId: {}", 
                request.getUserId(), traceId, e);
            
            throw e;
        } finally {
            sample.stop(orderCreationTimer);
        }
    }
    
    @GetMapping("/orders/{id}")
    @Timed(value = "orders.retrieval.time", description = "Time taken to retrieve an order")
    public ResponseEntity<OrderResponse> getOrder(@PathVariable String id) {
        String traceId = MDC.get("traceId");
        
        log.debug("Retrieving order: {}, traceId: {}", id, traceId);
        
        try {
            Order order = orderService.getOrder(id);
            
            // è®°å½•ç¼“å­˜å‘½ä¸­ç‡
            meterRegistry.counter("orders.cache.hit").increment();
            
            return ResponseEntity.ok(OrderResponse.from(order));
            
        } catch (OrderNotFoundException e) {
            log.warn("Order not found: {}, traceId: {}", id, traceId);
            
            meterRegistry.counter("orders.not_found").increment();
            
            throw e;
        }
    }
    
    private double getActiveOrderCount() {
        return orderService.getActiveOrderCount();
    }
}

// âœ… æ­£ç¡®ï¼šç›‘æ§é…ç½®
@Configuration
@EnableConfigurationProperties(MonitoringProperties.class)
public class MonitoringConfig {
    
    @Bean
    public MeterRegistry meterRegistry() {
        return new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);
    }
    
    @Bean
    public TimedAspect timedAspect(MeterRegistry registry) {
        return new TimedAspect(registry);
    }
    
    @Bean
    public CountedAspect countedAspect(MeterRegistry registry) {
        return new CountedAspect(registry);
    }
}

// âœ… æ­£ç¡®ï¼šå‘Šè­¦è§„åˆ™é…ç½®
@Component
public class AlertingRules {
    
    @EventListener
    public void handleOrderCreationFailure(OrderCreationFailedEvent event) {
        // ä¸šåŠ¡å‘Šè­¦ï¼šè®¢å•åˆ›å»ºå¤±è´¥ç‡è¿‡é«˜
        if (event.getFailureRate() > 0.05) { // 5%
            alertService.sendAlert(
                AlertLevel.CRITICAL,
                "Order creation failure rate exceeded threshold",
                String.format("Current failure rate: %.2f%%", event.getFailureRate() * 100)
            );
        }
    }
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkSystemHealth() {
        // ç³»ç»Ÿèµ„æºå‘Šè­¦
        double cpuUsage = systemMetrics.getCpuUsage();
        double memoryUsage = systemMetrics.getMemoryUsage();
        
        if (cpuUsage > 0.8) {
            alertService.sendAlert(
                AlertLevel.WARNING,
                "High CPU usage detected",
                String.format("CPU usage: %.2f%%", cpuUsage * 100)
            );
        }
        
        if (memoryUsage > 0.85) {
            alertService.sendAlert(
                AlertLevel.CRITICAL,
                "High memory usage detected",
                String.format("Memory usage: %.2f%%", memoryUsage * 100)
            );
        }
    }
}
```

**ä¼˜åŠ¿åˆ†æï¼š**
- å…¨é¢çš„ç›‘æ§æŒ‡æ ‡ï¼šåŒ…å«ä¸šåŠ¡æŒ‡æ ‡ï¼ˆè®¢å•åˆ›å»ºæ•°é‡ã€å“åº”æ—¶é—´ï¼‰å’Œç³»ç»ŸæŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ä½¿ç”¨ç‡ï¼‰
- å®Œæ•´çš„é“¾è·¯è¿½è¸ªï¼šé€šè¿‡traceIdå®ç°è¯·æ±‚å…¨é“¾è·¯è·Ÿè¸ªï¼Œä¾¿äºé—®é¢˜å®šä½
- è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼šè®°å½•å…³é”®æ“ä½œçš„æˆåŠŸå’Œå¤±è´¥ä¿¡æ¯ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
- æ™ºèƒ½å‘Šè­¦æœºåˆ¶ï¼šåŸºäºä¸šåŠ¡é˜ˆå€¼å’Œç³»ç»Ÿèµ„æºä½¿ç”¨ç‡è¿›è¡Œåˆ†çº§å‘Šè­¦
- æ ‡å‡†åŒ–é…ç½®ï¼šä½¿ç”¨Spring Boot Actuatorå’ŒMicrometerå®ç°æ ‡å‡†åŒ–ç›‘æ§

### æ¨èå·¥å…·

**CI/CDå·¥å…·ï¼š**
- Jenkinsã€GitLab CIã€GitHub Actionsã€Azure DevOps
- Dockerã€Kubernetesã€Helm
- SonarQubeã€Checkmarxã€Veracode

**å®¹å™¨åŒ–å·¥å…·ï¼š**
- Dockerã€Podmanã€Buildah
- Kubernetesã€OpenShiftã€Rancher
- Helmã€Kustomizeã€Skaffold

**ç›‘æ§å·¥å…·ï¼š**
- Prometheus + Grafanaã€DataDogã€New Relic
- ELK Stack (Elasticsearch + Logstash + Kibana)
- Jaegerã€Zipkinã€SkyWalking

**æ—¥å¿—å·¥å…·ï¼š**
- Logbackã€Log4j2ã€SLF4J
- Fluentdã€Filebeatã€Logstash
- Splunkã€Sumo Logicã€Papertrail

**å‘Šè­¦å·¥å…·ï¼š**
- PagerDutyã€OpsGenieã€VictorOps
- Slackã€Microsoft Teamsã€é’‰é’‰
- Webhookã€Emailã€SMS