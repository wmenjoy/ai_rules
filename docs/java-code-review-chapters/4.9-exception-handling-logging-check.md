### 4.9 å¼‚å¸¸å¤„ç†ä¸æ—¥å¿—æ£€æŸ¥

#### 4.9.1 å¼‚å¸¸å¤„ç†è§„èŒƒ ğŸ”´

##### 4.9.1.1 å¼‚å¸¸å®šä¹‰å’Œåˆ†ç±»æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»å®šä¹‰æ¸…æ™°çš„å¼‚å¸¸å±‚æ¬¡ç»“æ„
b. ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸å¿…é¡»åˆ†ç¦»
c. å¼‚å¸¸å¿…é¡»åŒ…å«é”™è¯¯ç å’Œè¯¦ç»†ä¿¡æ¯
d. é¿å…ä½¿ç”¨é€šç”¨å¼‚å¸¸ç±»å‹
e. å¼‚å¸¸ä¿¡æ¯å¿…é¡»å¯¹ç”¨æˆ·å‹å¥½

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¼‚å¸¸ç±»å®šä¹‰å’Œä½¿ç”¨
b. é™æ€åˆ†æï¼šæ£€æµ‹å¼‚å¸¸å¤„ç†æ¨¡å¼
c. å•å…ƒæµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸åœºæ™¯è¦†ç›–
d. é›†æˆæµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸ä¼ æ’­æ­£ç¡®æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨é€šç”¨å¼‚å¸¸ï¼Œä¿¡æ¯ä¸æ˜ç¡®
public class UserService {
    public User findUser(String id) throws Exception {
        if (StringUtils.isEmpty(id)) {
            throw new Exception("å‚æ•°é”™è¯¯"); // ä¿¡æ¯ä¸å…·ä½“
        }
        
        User user = userRepository.findById(id);
        if (user == null) {
            throw new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"); // ä½¿ç”¨é€šç”¨å¼‚å¸¸
        }
        return user;
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸ä¿¡æ¯æš´éœ²å†…éƒ¨å®ç°
public class OrderService {
    public void createOrder(OrderRequest request) {
        try {
            orderRepository.save(request);
        } catch (SQLException e) {
            // ç›´æ¥æš´éœ²æ•°æ®åº“å¼‚å¸¸
            throw new RuntimeException("SQLæ‰§è¡Œå¤±è´¥: " + e.getMessage());
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®šä¹‰æ¸…æ™°çš„å¼‚å¸¸å±‚æ¬¡
public abstract class BaseException extends RuntimeException {
    private final String errorCode;
    private final String userMessage;
    
    protected BaseException(String errorCode, String userMessage, String systemMessage) {
        super(systemMessage);
        this.errorCode = errorCode;
        this.userMessage = userMessage;
    }
    
    protected BaseException(String errorCode, String userMessage, String systemMessage, Throwable cause) {
        super(systemMessage, cause);
        this.errorCode = errorCode;
        this.userMessage = userMessage;
    }
    
    public String getErrorCode() { return errorCode; }
    public String getUserMessage() { return userMessage; }
}

// ä¸šåŠ¡å¼‚å¸¸
public class BusinessException extends BaseException {
    public BusinessException(String errorCode, String userMessage) {
        super(errorCode, userMessage, userMessage);
    }
    
    public BusinessException(String errorCode, String userMessage, String systemMessage) {
        super(errorCode, userMessage, systemMessage);
    }
}

// ç³»ç»Ÿå¼‚å¸¸
public class SystemException extends BaseException {
    public SystemException(String errorCode, String userMessage, String systemMessage, Throwable cause) {
        super(errorCode, userMessage, systemMessage, cause);
    }
}

// å…·ä½“ä¸šåŠ¡å¼‚å¸¸
public class UserNotFoundException extends BusinessException {
    public UserNotFoundException(String userId) {
        super("USER_NOT_FOUND", "ç”¨æˆ·ä¸å­˜åœ¨", "User not found with id: " + userId);
    }
}

public class InvalidParameterException extends BusinessException {
    public InvalidParameterException(String parameter, String reason) {
        super("INVALID_PARAMETER", 
              String.format("å‚æ•° %s ä¸æ­£ç¡®: %s", parameter, reason),
              String.format("Invalid parameter %s: %s", parameter, reason));
    }
}

// âœ… æ­£ç¡®ï¼šæœåŠ¡å±‚å¼‚å¸¸å¤„ç†
@Service
public class UserService {
    
    public User findUser(String id) {
        if (StringUtils.isEmpty(id)) {
            throw new InvalidParameterException("id", "ä¸èƒ½ä¸ºç©º");
        }
        
        try {
            User user = userRepository.findById(id);
            if (user == null) {
                throw new UserNotFoundException(id);
            }
            return user;
            
        } catch (DataAccessException e) {
            throw new SystemException("DATABASE_ERROR", 
                "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•", 
                "Database access failed for user query: " + id, e);
        }
    }
}
```

##### 4.9.1.2 å¼‚å¸¸å¤„ç†ç­–ç•¥æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¼‚å¸¸å¤„ç†ç­–ç•¥å¿…é¡»æ˜ç¡®ï¼ˆé‡è¯•ã€é™çº§ã€ç†”æ–­ï¼‰
b. ä¸åŒç±»å‹å¼‚å¸¸é‡‡ç”¨ä¸åŒå¤„ç†ç­–ç•¥
c. å¼‚å¸¸å¤„ç†ä¸èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§
d. å¿…é¡»æœ‰å¼‚å¸¸æ¢å¤æœºåˆ¶
e. å¼‚å¸¸å¤„ç†è¦è€ƒè™‘æ€§èƒ½å½±å“

**2. æ£€æµ‹æ–¹æ³•**

a. æ¶æ„å®¡æŸ¥ï¼šæ£€æŸ¥å¼‚å¸¸å¤„ç†ç­–ç•¥è®¾è®¡
b. ä»£ç å®¡æŸ¥ï¼šéªŒè¯å¼‚å¸¸å¤„ç†å®ç°
c. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸æƒ…å†µä¸‹ç³»ç»Ÿç¨³å®šæ€§
d. æ•…éšœæ¼”ç»ƒï¼šéªŒè¯å¼‚å¸¸æ¢å¤èƒ½åŠ›

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ˜ç¡®çš„å¼‚å¸¸å¤„ç†ç­–ç•¥
@Service
public class OrderService {
    public void processOrder(Order order) {
        try {
            paymentService.charge(order);
            inventoryService.reserve(order);
            shippingService.arrange(order);
        } catch (Exception e) {
            // æ²¡æœ‰æ˜ç¡®çš„å¤„ç†ç­–ç•¥ï¼Œç›´æ¥æŠ›å‡º
            throw new RuntimeException("è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸å¤„ç†å½±å“ç³»ç»Ÿæ€§èƒ½
public class DataProcessor {
    public void processData(List<Data> dataList) {
        for (Data data : dataList) {
            try {
                expensiveOperation(data);
            } catch (Exception e) {
                // æ¯æ¬¡å¼‚å¸¸éƒ½è¿›è¡Œæ˜‚è´µçš„æ“ä½œ
                sendAlertEmail(e);
                writeToDatabase(e);
                callExternalService(e);
            }
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ˜ç¡®çš„å¼‚å¸¸å¤„ç†ç­–ç•¥
@Service
public class OrderService {
    private static final Logger log = LoggerFactory.getLogger(OrderService.class);
    
    @Retryable(value = {TransientException.class}, maxAttempts = 3)
    public OrderResult processOrder(Order order) {
        try {
            // æ”¯ä»˜å¤±è´¥ - ç›´æ¥è¿”å›ï¼Œä¸é‡è¯•
            PaymentResult payment = paymentService.charge(order);
            
            // åº“å­˜ä¸è¶³ - ç›´æ¥è¿”å›ï¼Œä¸é‡è¯•
            InventoryResult inventory = inventoryService.reserve(order);
            
            // é…é€å®‰æ’å¤±è´¥ - å¯é‡è¯•
            ShippingResult shipping = shippingService.arrange(order);
            
            return OrderResult.success(payment, inventory, shipping);
            
        } catch (PaymentException e) {
            log.warn("Payment failed for order: {}", order.getId());
            return OrderResult.paymentFailed(e.getMessage());
            
        } catch (InsufficientInventoryException e) {
            log.warn("Insufficient inventory for order: {}", order.getId());
            return OrderResult.inventoryInsufficient(e.getMessage());
            
        } catch (ShippingException e) {
            log.warn("Shipping arrangement failed for order: {}", order.getId());
            throw new TransientException("é…é€å®‰æ’å¤±è´¥", e); // è§¦å‘é‡è¯•
            
        } catch (Exception e) {
            log.error("Unexpected error processing order: {}", order.getId(), e);
            return OrderResult.systemError("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}

// âœ… æ­£ç¡®ï¼šé«˜æ€§èƒ½å¼‚å¸¸å¤„ç†
@Component
public class DataProcessor {
    private static final Logger log = LoggerFactory.getLogger(DataProcessor.class);
    private final AtomicLong errorCount = new AtomicLong(0);
    private final RateLimiter alertLimiter = RateLimiter.create(1.0/60); // æ¯åˆ†é’Ÿæœ€å¤š1æ¬¡å‘Šè­¦
    
    public ProcessResult processData(List<Data> dataList) {
        List<Data> successList = new ArrayList<>();
        List<ProcessError> errorList = new ArrayList<>();
        
        for (Data data : dataList) {
            try {
                Data processed = expensiveOperation(data);
                successList.add(processed);
                
            } catch (ValidationException e) {
                // ä¸šåŠ¡å¼‚å¸¸ï¼Œè®°å½•ä½†ä¸å‘Šè­¦
                errorList.add(new ProcessError(data.getId(), e.getMessage()));
                
            } catch (Exception e) {
                // ç³»ç»Ÿå¼‚å¸¸ï¼Œé™æµå‘Šè­¦
                long currentErrors = errorCount.incrementAndGet();
                log.error("Data processing error: dataId={}, errorCount={}", 
                    data.getId(), currentErrors, e);
                
                if (alertLimiter.tryAcquire()) {
                    alertService.sendAlert("æ•°æ®å¤„ç†å¼‚å¸¸", e);
                }
                
                errorList.add(new ProcessError(data.getId(), "ç³»ç»Ÿå¼‚å¸¸"));
            }
        }
        
        return new ProcessResult(successList, errorList);
    }
}
```

##### 4.9.1.3 å¼‚å¸¸ä¿¡æ¯å®‰å…¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¼‚å¸¸ä¿¡æ¯ä¸èƒ½æ³„éœ²æ•æ„Ÿæ•°æ®
b. å¼‚å¸¸ä¿¡æ¯ä¸èƒ½æš´éœ²ç³»ç»Ÿå†…éƒ¨ç»“æ„
c. ç”¨æˆ·çœ‹åˆ°çš„å¼‚å¸¸ä¿¡æ¯å¿…é¡»å‹å¥½
d. ç³»ç»Ÿæ—¥å¿—å¯ä»¥åŒ…å«è¯¦ç»†ä¿¡æ¯
e. å¼‚å¸¸å †æ ˆä¸èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯

**2. æ£€æµ‹æ–¹æ³•**

a. å®‰å…¨å®¡æŸ¥ï¼šæ£€æŸ¥å¼‚å¸¸ä¿¡æ¯å†…å®¹
b. ä»£ç å®¡æŸ¥ï¼šéªŒè¯å¼‚å¸¸ä¿¡æ¯å¤„ç†
c. æ¸—é€æµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸ä¿¡æ¯ä¸æ³„éœ²
d. æ—¥å¿—å®¡æŸ¥ï¼šç¡®è®¤æ•æ„Ÿä¿¡æ¯ä¸åœ¨æ—¥å¿—ä¸­

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå¼‚å¸¸ä¿¡æ¯æ³„éœ²æ•æ„Ÿæ•°æ®
@RestController
public class UserController {
    public ResponseEntity<User> getUser(@PathVariable String id) {
        try {
            User user = userService.findById(id);
            return ResponseEntity.ok(user);
        } catch (Exception e) {
            // ç›´æ¥è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼Œå¯èƒ½åŒ…å«SQLã€å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
            return ResponseEntity.status(500)
                .body(new ErrorResponse(e.getMessage()));
        }
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸ä¿¡æ¯æš´éœ²ç³»ç»Ÿç»“æ„
public class DatabaseService {
    public User findUser(String id) {
        try {
            return jdbcTemplate.queryForObject(
                "SELECT * FROM users WHERE id = ?", 
                new Object[]{id}, 
                User.class);
        } catch (SQLException e) {
            // æš´éœ²äº†æ•°æ®åº“è¡¨ç»“æ„å’ŒSQLè¯­å¥
            throw new RuntimeException("SQLæ‰§è¡Œå¤±è´¥: " + e.getMessage() + 
                ", SQL: SELECT * FROM users WHERE id = " + id);
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„å¼‚å¸¸ä¿¡æ¯å¤„ç†
@RestController
public class UserController {
    private static final Logger log = LoggerFactory.getLogger(UserController.class);
    
    @GetMapping("/users/{id}")
    public ResponseEntity<ApiResponse<User>> getUser(@PathVariable String id) {
        try {
            User user = userService.findById(id);
            return ResponseEntity.ok(ApiResponse.success(user));
            
        } catch (UserNotFoundException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼šè¿”å›å‹å¥½ä¿¡æ¯
            return ResponseEntity.status(404)
                .body(ApiResponse.error("USER_NOT_FOUND", "ç”¨æˆ·ä¸å­˜åœ¨"));
                
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼šè®°å½•è¯¦ç»†æ—¥å¿—ï¼Œè¿”å›é€šç”¨ä¿¡æ¯
            log.error("System error getting user: id={}", id, e);
            return ResponseEntity.status(500)
                .body(ApiResponse.error("SYSTEM_ERROR", "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"));
        }
    }
}

// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„æ•°æ®åº“å¼‚å¸¸å¤„ç†
@Repository
public class UserRepository {
    private static final Logger log = LoggerFactory.getLogger(UserRepository.class);
    
    public User findById(String id) {
        try {
            return jdbcTemplate.queryForObject(
                "SELECT id, username, email, created_at FROM users WHERE id = ?", 
                new Object[]{id}, 
                (rs, rowNum) -> {
                    User user = new User();
                    user.setId(rs.getString("id"));
                    user.setUsername(rs.getString("username"));
                    user.setEmail(rs.getString("email"));
                    user.setCreatedAt(rs.getTimestamp("created_at").toLocalDateTime());
                    return user;
                });
                
        } catch (EmptyResultDataAccessException e) {
            throw new UserNotFoundException(id);
            
        } catch (DataAccessException e) {
            // è®°å½•è¯¦ç»†çš„ç³»ç»Ÿæ—¥å¿—ï¼Œä½†ä¸æš´éœ²ç»™ä¸Šå±‚
            log.error("Database error finding user: id={}, error={}", id, e.getMessage());
            throw new SystemException("DATABASE_ERROR", 
                "æ•°æ®åº“è®¿é—®å¼‚å¸¸", 
                "Database error finding user: " + id, e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå…¨å±€å¼‚å¸¸å¤„ç†å™¨
@ControllerAdvice
public class GlobalExceptionHandler {
    private static final Logger log = LoggerFactory.getLogger(GlobalExceptionHandler.class);
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(BusinessException e) {
        log.warn("Business exception: code={}, message={}", e.getErrorCode(), e.getMessage());
        return ResponseEntity.status(400)
            .body(ApiResponse.error(e.getErrorCode(), e.getUserMessage()));
    }
    
    @ExceptionHandler(SystemException.class)
    public ResponseEntity<ApiResponse<Void>> handleSystemException(SystemException e) {
        log.error("System exception: code={}, message={}", e.getErrorCode(), e.getMessage(), e);
        return ResponseEntity.status(500)
            .body(ApiResponse.error(e.getErrorCode(), e.getUserMessage()));
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Void>> handleUnexpectedException(Exception e) {
        String errorId = UUID.randomUUID().toString();
        log.error("Unexpected exception: errorId={}", errorId, e);
        return ResponseEntity.status(500)
            .body(ApiResponse.error("SYSTEM_ERROR", 
                "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚é”™è¯¯ID: " + errorId));
    }
}
```

#### 4.9.2 å¼‚å¸¸æ•è·ä¸å¤„ç† ğŸŸ¡

##### 4.9.2.1 try-catchä½¿ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é¿å…æ•è·è¿‡äºå®½æ³›çš„å¼‚å¸¸
b. ä¸èƒ½å¿½ç•¥æˆ–åæ‰å¼‚å¸¸
c. å¼‚å¸¸å¤„ç†å¿…é¡»æœ‰æ˜ç¡®çš„ä¸šåŠ¡é€»è¾‘
d. å¿…é¡»è®°å½•å¼‚å¸¸æ—¥å¿—
e. å¼‚å¸¸é‡æ–°æŠ›å‡ºå¿…é¡»ä¿ç•™åŸå§‹ä¿¡æ¯

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥ try-catch å—
b. é™æ€åˆ†æï¼šæ£€æµ‹ç©º catch å—å’Œå¼‚å¸¸åæ²¡
c. æ—¥å¿—æ£€æŸ¥ï¼šéªŒè¯å¼‚å¸¸æ—¥å¿—è®°å½•
d. æµ‹è¯•éªŒè¯ï¼šç¡®è®¤å¼‚å¸¸å¤„ç†é€»è¾‘æ­£ç¡®

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ•è·è¿‡äºå®½æ³›çš„å¼‚å¸¸
public class FileProcessor {
    public void processFile(String path) {
        try {
            // æ–‡ä»¶å¤„ç†é€»è¾‘
            Files.readAllLines(Paths.get(path));
        } catch (Exception e) { // è¿‡äºå®½æ³›
            // å¿½ç•¥æ‰€æœ‰å¼‚å¸¸
        }
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸ä¿¡æ¯ä¸¢å¤±
public class DataService {
    public void saveData(Data data) {
        try {
            dataRepository.save(data);
        } catch (DataAccessException e) {
            // é‡æ–°æŠ›å‡ºæ—¶ä¸¢å¤±åŸå§‹å¼‚å¸¸ä¿¡æ¯
            throw new RuntimeException("ä¿å­˜å¤±è´¥");
        }
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸å¤„ç†ä¸å½“
public class ApiService {
    public String callExternalApi(String url) {
        try {
            return restTemplate.getForObject(url, String.class);
        } catch (RestClientException e) {
            // è¿”å›nullè€Œä¸æ˜¯å¤„ç†å¼‚å¸¸
            return null;
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šç²¾ç¡®çš„å¼‚å¸¸æ•è·å’Œå¤„ç†
@Service
public class FileProcessor {
    private static final Logger log = LoggerFactory.getLogger(FileProcessor.class);
    
    public List<String> processFile(String path) {
        try {
            return Files.readAllLines(Paths.get(path));
            
        } catch (NoSuchFileException e) {
            log.warn("File not found: {}", path);
            throw new BusinessException("FILE_NOT_FOUND", "æ–‡ä»¶ä¸å­˜åœ¨");
            
        } catch (AccessDeniedException e) {
            log.warn("Access denied to file: {}", path);
            throw new BusinessException("FILE_ACCESS_DENIED", "æ–‡ä»¶è®¿é—®è¢«æ‹’ç»");
            
        } catch (IOException e) {
            log.error("IO error reading file: {}", path, e);
            throw new SystemException("FILE_IO_ERROR", 
                "æ–‡ä»¶è¯»å–å¤±è´¥", 
                "IO error reading file: " + path, e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šä¿ç•™å¼‚å¸¸ä¿¡æ¯çš„é‡æ–°æŠ›å‡º
@Service
public class DataService {
    private static final Logger log = LoggerFactory.getLogger(DataService.class);
    
    @Transactional
    public void saveData(Data data) {
        try {
            validateData(data);
            dataRepository.save(data);
            log.info("Data saved successfully: id={}", data.getId());
            
        } catch (ValidationException e) {
            log.warn("Data validation failed: {}", e.getMessage());
            throw e; // ä¸šåŠ¡å¼‚å¸¸ç›´æ¥é‡æ–°æŠ›å‡º
            
        } catch (DataIntegrityViolationException e) {
            log.error("Data integrity violation: {}", e.getMessage());
            throw new BusinessException("DATA_DUPLICATE", 
                "æ•°æ®å·²å­˜åœ¨", 
                "Data integrity violation for: " + data.getId());
                
        } catch (DataAccessException e) {
            log.error("Database error saving data: id={}", data.getId(), e);
            throw new SystemException("DATABASE_ERROR", 
                "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•", 
                "Database error saving data: " + data.getId(), e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå¤–éƒ¨æœåŠ¡è°ƒç”¨å¼‚å¸¸å¤„ç†
@Service
public class ApiService {
    private static final Logger log = LoggerFactory.getLogger(ApiService.class);
    
    @Retryable(value = {ResourceAccessException.class}, maxAttempts = 3)
    public ApiResponse callExternalApi(String url, Object request) {
        try {
            log.debug("Calling external API: {}", url);
            ResponseEntity<ApiResponse> response = restTemplate.postForEntity(
                url, request, ApiResponse.class);
            
            if (response.getStatusCode().is2xxSuccessful()) {
                return response.getBody();
            } else {
                throw new BusinessException("API_ERROR", 
                    "å¤–éƒ¨æœåŠ¡è°ƒç”¨å¤±è´¥", 
                    "API returned non-success status: " + response.getStatusCode());
            }
            
        } catch (ResourceAccessException e) {
            log.warn("API call timeout or connection error: {}", url, e);
            throw e; // è®©é‡è¯•æœºåˆ¶å¤„ç†
            
        } catch (HttpClientErrorException e) {
            log.error("API client error: {} - {}", url, e.getStatusCode(), e);
            throw new BusinessException("API_CLIENT_ERROR", 
                "è¯·æ±‚å‚æ•°é”™è¯¯", 
                "API client error: " + e.getStatusCode());
                
        } catch (HttpServerErrorException e) {
            log.error("API server error: {} - {}", url, e.getStatusCode(), e);
            throw new SystemException("API_SERVER_ERROR", 
                "å¤–éƒ¨æœåŠ¡æš‚æ—¶ä¸å¯ç”¨", 
                "API server error: " + e.getStatusCode(), e);
                
        } catch (RestClientException e) {
            log.error("Unexpected API error: {}", url, e);
            throw new SystemException("API_UNKNOWN_ERROR", 
                "å¤–éƒ¨æœåŠ¡è°ƒç”¨å¼‚å¸¸", 
                "Unexpected API error: " + url, e);
        }
    }
}
```

##### 4.9.2.2 å¼‚å¸¸é“¾ä¿æŒæ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é‡æ–°æŠ›å‡ºå¼‚å¸¸æ—¶å¿…é¡»ä¿æŒåŸå§‹å¼‚å¸¸é“¾
b. å¼‚å¸¸åŒ…è£…ä¸èƒ½ä¸¢å¤±æ ¹æœ¬åŸå› 
c. å¼‚å¸¸å †æ ˆä¿¡æ¯å¿…é¡»å®Œæ•´
d. å¼‚å¸¸ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸èƒ½ä¸¢å¤±
e. å¼‚å¸¸è½¬æ¢è¦ä¿æŒè¯­ä¹‰ä¸€è‡´æ€§

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¼‚å¸¸é‡æ–°æŠ›å‡ºé€»è¾‘
b. é™æ€åˆ†æï¼šæ£€æµ‹å¼‚å¸¸é“¾æ–­è£‚
c. å•å…ƒæµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸é“¾å®Œæ•´æ€§
d. æ—¥å¿—åˆ†æï¼šç¡®è®¤å¼‚å¸¸å †æ ˆå®Œæ•´

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå¼‚å¸¸é“¾æ–­è£‚
@Service
public class UserService {
    public User createUser(UserRequest request) {
        try {
            return userRepository.save(request.toUser());
        } catch (DataAccessException e) {
            // ä¸¢å¤±äº†åŸå§‹å¼‚å¸¸ä¿¡æ¯
            throw new BusinessException("ç”¨æˆ·åˆ›å»ºå¤±è´¥");
        }
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸ä¿¡æ¯ä¸å®Œæ•´
public class FileProcessor {
    public void processFile(String path) {
        try {
            Files.readAllLines(Paths.get(path));
        } catch (IOException e) {
            // åªä¿ç•™äº†å¼‚å¸¸æ¶ˆæ¯ï¼Œä¸¢å¤±äº†å †æ ˆä¿¡æ¯
            throw new ProcessException("æ–‡ä»¶å¤„ç†å¤±è´¥: " + e.getMessage());
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¿æŒå®Œæ•´å¼‚å¸¸é“¾
@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    public User createUser(UserRequest request) {
        try {
            User user = request.toUser();
            return userRepository.save(user);
            
        } catch (DataIntegrityViolationException e) {
            // ä¿æŒåŸå§‹å¼‚å¸¸é“¾ï¼Œæ·»åŠ ä¸šåŠ¡ä¸Šä¸‹æ–‡
            log.warn("User creation failed - data integrity violation: username={}", 
                request.getUsername(), e);
            throw new BusinessException("USERNAME_EXISTS", 
                "ç”¨æˆ·åå·²å­˜åœ¨", 
                "User creation failed for username: " + request.getUsername(), e);
                
        } catch (DataAccessException e) {
            // ä¿æŒåŸå§‹å¼‚å¸¸é“¾ï¼Œè½¬æ¢ä¸ºç³»ç»Ÿå¼‚å¸¸
            log.error("Database error creating user: username={}", 
                request.getUsername(), e);
            throw new SystemException("DATABASE_ERROR", 
                "ç”¨æˆ·åˆ›å»ºå¤±è´¥", 
                "Database error creating user: " + request.getUsername(), e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå¼‚å¸¸åŒ…è£…ä¿æŒä¸Šä¸‹æ–‡
@Component
public class FileProcessor {
    private static final Logger log = LoggerFactory.getLogger(FileProcessor.class);
    
    public ProcessResult processFile(String path) {
        try {
            List<String> lines = Files.readAllLines(Paths.get(path));
            return processLines(lines);
            
        } catch (NoSuchFileException e) {
            // ç‰¹å®šå¼‚å¸¸ç±»å‹ï¼Œä¿æŒå¼‚å¸¸é“¾
            throw new FileNotFoundException("æ–‡ä»¶ä¸å­˜åœ¨: " + path, e);
            
        } catch (AccessDeniedException e) {
            // ç‰¹å®šå¼‚å¸¸ç±»å‹ï¼Œä¿æŒå¼‚å¸¸é“¾
            throw new FileAccessException("æ–‡ä»¶è®¿é—®è¢«æ‹’ç»: " + path, e);
            
        } catch (IOException e) {
            // é€šç”¨IOå¼‚å¸¸ï¼Œä¿æŒå®Œæ•´å¼‚å¸¸é“¾å’Œä¸Šä¸‹æ–‡
            log.error("IO error processing file: {}", path, e);
            throw new FileProcessException(
                "æ–‡ä»¶å¤„ç†å¤±è´¥", 
                "IO error processing file: " + path, 
                e); // ä¿æŒåŸå§‹å¼‚å¸¸ä½œä¸ºcause
        }
    }
}

// âœ… æ­£ç¡®ï¼šå¼‚å¸¸è½¬æ¢ä¿æŒè¯­ä¹‰
@Service
public class PaymentService {
    private static final Logger log = LoggerFactory.getLogger(PaymentService.class);
    
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            return paymentGateway.charge(request);
            
        } catch (PaymentGatewayTimeoutException e) {
            // è¶…æ—¶å¼‚å¸¸è½¬æ¢ä¸ºå¯é‡è¯•å¼‚å¸¸ï¼Œä¿æŒå¼‚å¸¸é“¾
            log.warn("Payment gateway timeout: orderId={}", request.getOrderId(), e);
            throw new RetryableException(
                "æ”¯ä»˜ç½‘å…³è¶…æ—¶", 
                "Payment gateway timeout for order: " + request.getOrderId(), 
                e);
                
        } catch (InsufficientFundsException e) {
            // ä¸šåŠ¡å¼‚å¸¸ç›´æ¥è½¬æ¢ï¼Œä¿æŒå¼‚å¸¸é“¾
            log.info("Insufficient funds: orderId={}, amount={}", 
                request.getOrderId(), request.getAmount());
            throw new BusinessException("INSUFFICIENT_FUNDS", 
                "ä½™é¢ä¸è¶³", 
                "Insufficient funds for order: " + request.getOrderId(), e);
                
        } catch (PaymentGatewayException e) {
            // ç½‘å…³å¼‚å¸¸è½¬æ¢ä¸ºç³»ç»Ÿå¼‚å¸¸ï¼Œä¿æŒå¼‚å¸¸é“¾
            log.error("Payment gateway error: orderId={}, errorCode={}", 
                request.getOrderId(), e.getErrorCode(), e);
            throw new SystemException("PAYMENT_GATEWAY_ERROR", 
                "æ”¯ä»˜ç³»ç»Ÿå¼‚å¸¸", 
                "Payment gateway error: " + e.getErrorCode(), e);
        }
    }
}
```

##### 4.9.2.3 èµ„æºæ¸…ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¼‚å¸¸å‘ç”Ÿæ—¶å¿…é¡»æ­£ç¡®æ¸…ç†èµ„æº
b. ä½¿ç”¨try-with-resourcesè‡ªåŠ¨ç®¡ç†èµ„æº
c. finallyå—ä¸­çš„æ¸…ç†ä»£ç ä¸èƒ½æŠ›å‡ºå¼‚å¸¸
d. èµ„æºæ¸…ç†è¦è€ƒè™‘å¼‚å¸¸æƒ…å†µ
e. é¿å…èµ„æºæ³„æ¼

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥èµ„æºç®¡ç†ä»£ç 
b. é™æ€åˆ†æï¼šæ£€æµ‹èµ„æºæ³„æ¼é£é™©
c. å†…å­˜åˆ†æï¼šç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
d. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸æƒ…å†µä¸‹èµ„æºæ¸…ç†

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šèµ„æºæ²¡æœ‰æ­£ç¡®æ¸…ç†
public class FileService {
    public String readFile(String path) throws IOException {
        FileInputStream fis = new FileInputStream(path);
        BufferedReader reader = new BufferedReader(new InputStreamReader(fis));
        
        // å¦‚æœè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œèµ„æºä¸ä¼šè¢«æ¸…ç†
        return reader.lines().collect(Collectors.joining("\n"));
    }
}

// âŒ é”™è¯¯ï¼šfinallyå—ä¸­æŠ›å‡ºå¼‚å¸¸
public class DatabaseService {
    public void executeQuery(String sql) {
        Connection conn = null;
        Statement stmt = null;
        try {
            conn = dataSource.getConnection();
            stmt = conn.createStatement();
            stmt.execute(sql);
        } catch (SQLException e) {
            throw new RuntimeException("SQLæ‰§è¡Œå¤±è´¥", e);
        } finally {
            try {
                if (stmt != null) stmt.close();
                if (conn != null) conn.close();
            } catch (SQLException e) {
                // finallyå—ä¸­æŠ›å‡ºå¼‚å¸¸ä¼šæ©ç›–åŸå§‹å¼‚å¸¸
                throw new RuntimeException("èµ„æºæ¸…ç†å¤±è´¥", e);
            }
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨try-with-resources
@Service
public class FileService {
    private static final Logger log = LoggerFactory.getLogger(FileService.class);
    
    public String readFile(String path) {
        try (FileInputStream fis = new FileInputStream(path);
             BufferedReader reader = new BufferedReader(new InputStreamReader(fis))) {
            
            return reader.lines().collect(Collectors.joining("\n"));
            
        } catch (FileNotFoundException e) {
            log.warn("File not found: {}", path);
            throw new BusinessException("FILE_NOT_FOUND", "æ–‡ä»¶ä¸å­˜åœ¨");
            
        } catch (IOException e) {
            log.error("IO error reading file: {}", path, e);
            throw new SystemException("FILE_IO_ERROR", 
                "æ–‡ä»¶è¯»å–å¤±è´¥", 
                "IO error reading file: " + path, e);
        }
    }
    
    public void processLargeFile(String inputPath, String outputPath) {
        try (FileInputStream fis = new FileInputStream(inputPath);
             FileOutputStream fos = new FileOutputStream(outputPath);
             BufferedInputStream bis = new BufferedInputStream(fis);
             BufferedOutputStream bos = new BufferedOutputStream(fos)) {
            
            byte[] buffer = new byte[8192];
            int bytesRead;
            while ((bytesRead = bis.read(buffer)) != -1) {
                bos.write(buffer, 0, bytesRead);
            }
            
        } catch (IOException e) {
            log.error("Error processing file: input={}, output={}", inputPath, outputPath, e);
            throw new SystemException("FILE_PROCESS_ERROR", 
                "æ–‡ä»¶å¤„ç†å¤±è´¥", 
                "Error processing file: " + inputPath, e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„èµ„æºæ¸…ç†
@Repository
public class DatabaseService {
    private static final Logger log = LoggerFactory.getLogger(DatabaseService.class);
    
    public List<Map<String, Object>> executeQuery(String sql, Object... params) {
        try (Connection conn = dataSource.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            // è®¾ç½®å‚æ•°
            for (int i = 0; i < params.length; i++) {
                stmt.setObject(i + 1, params[i]);
            }
            
            try (ResultSet rs = stmt.executeQuery()) {
                List<Map<String, Object>> results = new ArrayList<>();
                ResultSetMetaData metaData = rs.getMetaData();
                int columnCount = metaData.getColumnCount();
                
                while (rs.next()) {
                    Map<String, Object> row = new HashMap<>();
                    for (int i = 1; i <= columnCount; i++) {
                        row.put(metaData.getColumnName(i), rs.getObject(i));
                    }
                    results.add(row);
                }
                
                return results;
            }
            
        } catch (SQLException e) {
            log.error("Database error executing query: sql={}", sql, e);
            throw new SystemException("DATABASE_ERROR", 
                "æ•°æ®åº“æŸ¥è¯¢å¤±è´¥", 
                "Database error executing query: " + sql, e);
        }
    }
    
    // æ‰‹åŠ¨èµ„æºç®¡ç†çš„å®‰å…¨æ–¹å¼
    public void executeWithManualCleanup(String sql) {
        Connection conn = null;
        PreparedStatement stmt = null;
        
        try {
            conn = dataSource.getConnection();
            stmt = conn.prepareStatement(sql);
            stmt.execute();
            
        } catch (SQLException e) {
            log.error("Database error: sql={}", sql, e);
            throw new SystemException("DATABASE_ERROR", 
                "æ•°æ®åº“æ“ä½œå¤±è´¥", 
                "Database error: " + sql, e);
        } finally {
            // å®‰å…¨çš„èµ„æºæ¸…ç†ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
            closeQuietly(stmt);
            closeQuietly(conn);
        }
    }
    
    private void closeQuietly(AutoCloseable resource) {
        if (resource != null) {
            try {
                resource.close();
            } catch (Exception e) {
                // è®°å½•æ—¥å¿—ä½†ä¸æŠ›å‡ºå¼‚å¸¸
                log.warn("Error closing resource: {}", resource.getClass().getSimpleName(), e);
            }
        }
    }
}
```

#### 4.9.3 å¼‚å¸¸ä¼ æ’­ä¸è½¬æ¢ ğŸŸ¡

##### 4.9.3.1 å¼‚å¸¸è½¬æ¢è§„èŒƒæ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¼‚å¸¸è½¬æ¢å¿…é¡»ä¿æŒè¯­ä¹‰ä¸€è‡´æ€§
b. ä¸åŒå±‚æ¬¡é—´å¼‚å¸¸è½¬æ¢è¦åˆç†
c. é¿å…æ— æ„ä¹‰çš„å¼‚å¸¸åŒ…è£…
d. å¼‚å¸¸è½¬æ¢è¦ä¿æŒåŸå§‹å¼‚å¸¸ä¿¡æ¯
e. è½¬æ¢åçš„å¼‚å¸¸è¦ä¾¿äºä¸Šå±‚å¤„ç†

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¼‚å¸¸è½¬æ¢é€»è¾‘
b. æ¶æ„å®¡æŸ¥ï¼šéªŒè¯åˆ†å±‚å¼‚å¸¸è®¾è®¡
c. å•å…ƒæµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸è½¬æ¢æ­£ç¡®æ€§
d. é›†æˆæµ‹è¯•ï¼šéªŒè¯ç«¯åˆ°ç«¯å¼‚å¸¸å¤„ç†

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ— æ„ä¹‰çš„å¼‚å¸¸åŒ…è£…
@Service
public class UserService {
    public User findUser(Long id) {
        try {
            return userRepository.findById(id);
        } catch (RuntimeException e) {
            // æ— æ„ä¹‰çš„åŒ…è£…ï¼Œæ²¡æœ‰æ·»åŠ ä»»ä½•ä»·å€¼
            throw new RuntimeException(e);
        }
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸è½¬æ¢ä¸¢å¤±è¯­ä¹‰
@Controller
public class UserController {
    public ResponseEntity<User> getUser(Long id) {
        try {
            User user = userService.findUser(id);
            return ResponseEntity.ok(user);
        } catch (UserNotFoundException e) {
            // å°†ä¸šåŠ¡å¼‚å¸¸è½¬æ¢ä¸ºæŠ€æœ¯å¼‚å¸¸ï¼Œä¸¢å¤±äº†ä¸šåŠ¡è¯­ä¹‰
            throw new RuntimeException("ç³»ç»Ÿé”™è¯¯");
        }
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸è½¬æ¢å±‚æ¬¡æ··ä¹±
@Repository
public class UserRepository {
    public User save(User user) {
        try {
            return entityManager.persist(user);
        } catch (PersistenceException e) {
            // Repositoryå±‚æŠ›å‡ºControllerå±‚å¼‚å¸¸ï¼Œå±‚æ¬¡æ··ä¹±
            throw new HttpClientErrorException(HttpStatus.BAD_REQUEST, "ç”¨æˆ·ä¿å­˜å¤±è´¥");
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šåˆç†çš„å¼‚å¸¸è½¬æ¢
@Repository
public class UserRepository {
    private static final Logger log = LoggerFactory.getLogger(UserRepository.class);
    
    public User findById(Long id) {
        try {
            return entityManager.find(User.class, id);
        } catch (PersistenceException e) {
            // Repositoryå±‚ï¼šå°†JPAå¼‚å¸¸è½¬æ¢ä¸ºæ•°æ®è®¿é—®å¼‚å¸¸
            log.error("Database error finding user: id={}", id, e);
            throw new DataAccessException("USER_FIND_ERROR", 
                "ç”¨æˆ·æŸ¥è¯¢å¤±è´¥", 
                "Database error finding user: " + id, e);
        }
    }
    
    public User save(User user) {
        try {
            return entityManager.merge(user);
        } catch (ConstraintViolationException e) {
            // çº¦æŸè¿åè½¬æ¢ä¸ºæ•°æ®å®Œæ•´æ€§å¼‚å¸¸
            log.warn("Data integrity violation saving user: username={}", 
                user.getUsername(), e);
            throw new DataIntegrityException("USER_CONSTRAINT_VIOLATION", 
                "ç”¨æˆ·æ•°æ®çº¦æŸè¿å", 
                "Constraint violation for user: " + user.getUsername(), e);
        } catch (PersistenceException e) {
            // å…¶ä»–æŒä¹…åŒ–å¼‚å¸¸è½¬æ¢ä¸ºæ•°æ®è®¿é—®å¼‚å¸¸
            log.error("Database error saving user: username={}", 
                user.getUsername(), e);
            throw new DataAccessException("USER_SAVE_ERROR", 
                "ç”¨æˆ·ä¿å­˜å¤±è´¥", 
                "Database error saving user: " + user.getUsername(), e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šServiceå±‚å¼‚å¸¸è½¬æ¢
@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    @Autowired
    private UserRepository userRepository;
    
    public User findUser(Long id) {
        try {
            User user = userRepository.findById(id);
            if (user == null) {
                throw new BusinessException("USER_NOT_FOUND", 
                    "ç”¨æˆ·ä¸å­˜åœ¨", 
                    "User not found: " + id);
            }
            return user;
        } catch (DataAccessException e) {
            // æ•°æ®è®¿é—®å¼‚å¸¸è½¬æ¢ä¸ºç³»ç»Ÿå¼‚å¸¸
            log.error("System error finding user: id={}", id, e);
            throw new SystemException("USER_SYSTEM_ERROR", 
                "ç”¨æˆ·æŸ¥è¯¢ç³»ç»Ÿå¼‚å¸¸", 
                "System error finding user: " + id, e);
        }
    }
    
    public User createUser(UserCreateRequest request) {
        try {
            // ä¸šåŠ¡éªŒè¯
            validateUserRequest(request);
            
            User user = new User();
            user.setUsername(request.getUsername());
            user.setEmail(request.getEmail());
            
            return userRepository.save(user);
            
        } catch (DataIntegrityException e) {
            // æ•°æ®å®Œæ•´æ€§å¼‚å¸¸è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸
            if (e.getMessage().contains("username")) {
                throw new BusinessException("USERNAME_EXISTS", 
                    "ç”¨æˆ·åå·²å­˜åœ¨", 
                    "Username already exists: " + request.getUsername(), e);
            } else if (e.getMessage().contains("email")) {
                throw new BusinessException("EMAIL_EXISTS", 
                    "é‚®ç®±å·²å­˜åœ¨", 
                    "Email already exists: " + request.getEmail(), e);
            } else {
                throw new BusinessException("USER_DATA_CONFLICT", 
                    "ç”¨æˆ·æ•°æ®å†²çª", 
                    "Data conflict creating user: " + request.getUsername(), e);
            }
        } catch (DataAccessException e) {
            // æ•°æ®è®¿é—®å¼‚å¸¸è½¬æ¢ä¸ºç³»ç»Ÿå¼‚å¸¸
            log.error("System error creating user: username={}", 
                request.getUsername(), e);
            throw new SystemException("USER_CREATE_SYSTEM_ERROR", 
                "ç”¨æˆ·åˆ›å»ºç³»ç»Ÿå¼‚å¸¸", 
                "System error creating user: " + request.getUsername(), e);
        }
    }
    
    private void validateUserRequest(UserCreateRequest request) {
        if (StringUtils.isBlank(request.getUsername())) {
            throw new BusinessException("INVALID_USERNAME", 
                "ç”¨æˆ·åä¸èƒ½ä¸ºç©º", 
                "Username is required");
        }
        if (!EmailValidator.isValid(request.getEmail())) {
            throw new BusinessException("INVALID_EMAIL", 
                "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®", 
                "Invalid email format: " + request.getEmail());
        }
    }
}

// âœ… æ­£ç¡®ï¼šControllerå±‚å¼‚å¸¸è½¬æ¢
@RestController
@RequestMapping("/api/users")
public class UserController {
    private static final Logger log = LoggerFactory.getLogger(UserController.class);
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public ResponseEntity<UserResponse> getUser(@PathVariable Long id) {
        try {
            User user = userService.findUser(id);
            UserResponse response = UserResponse.from(user);
            return ResponseEntity.ok(response);
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸è½¬æ¢ä¸ºHTTPå¼‚å¸¸ï¼Œä¿æŒä¸šåŠ¡è¯­ä¹‰
            log.info("Business error getting user: id={}, code={}", 
                id, e.getErrorCode());
            
            if ("USER_NOT_FOUND".equals(e.getErrorCode())) {
                throw new HttpNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨", 
                    "User not found: " + id, e);
            } else {
                throw new HttpBadRequestException(e.getUserMessage(), 
                    e.getDetailMessage(), e);
            }
            
        } catch (SystemException e) {
            // ç³»ç»Ÿå¼‚å¸¸è½¬æ¢ä¸ºHTTPæœåŠ¡å™¨é”™è¯¯
            log.error("System error getting user: id={}", id, e);
            throw new HttpInternalServerErrorException("ç³»ç»Ÿå¼‚å¸¸", 
                "System error getting user: " + id, e);
        }
    }
    
    @PostMapping
    public ResponseEntity<UserResponse> createUser(@RequestBody @Valid UserCreateRequest request) {
        try {
            User user = userService.createUser(request);
            UserResponse response = UserResponse.from(user);
            return ResponseEntity.status(HttpStatus.CREATED).body(response);
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸è½¬æ¢ä¸ºç›¸åº”çš„HTTPçŠ¶æ€ç 
            log.info("Business error creating user: username={}, code={}", 
                request.getUsername(), e.getErrorCode());
            
            switch (e.getErrorCode()) {
                case "USERNAME_EXISTS":
                case "EMAIL_EXISTS":
                case "USER_DATA_CONFLICT":
                    throw new HttpConflictException(e.getUserMessage(), 
                        e.getDetailMessage(), e);
                case "INVALID_USERNAME":
                case "INVALID_EMAIL":
                    throw new HttpBadRequestException(e.getUserMessage(), 
                        e.getDetailMessage(), e);
                default:
                    throw new HttpBadRequestException(e.getUserMessage(), 
                        e.getDetailMessage(), e);
            }
            
        } catch (SystemException e) {
            // ç³»ç»Ÿå¼‚å¸¸è½¬æ¢ä¸ºHTTPæœåŠ¡å™¨é”™è¯¯
            log.error("System error creating user: username={}", 
                request.getUsername(), e);
            throw new HttpInternalServerErrorException("ç³»ç»Ÿå¼‚å¸¸", 
                "System error creating user: " + request.getUsername(), e);
        }
    }
}
```

##### 4.9.3.2 è¾¹ç•Œå¼‚å¸¸å¤„ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç³»ç»Ÿè¾¹ç•Œå¤„å¿…é¡»æœ‰å¼‚å¸¸å¤„ç†
b. å¤–éƒ¨è°ƒç”¨å¼‚å¸¸è¦æ­£ç¡®è½¬æ¢
c. å¼‚æ­¥å¤„ç†å¼‚å¸¸è¦å¦¥å–„å¤„ç†
d. è¾¹ç•Œå¼‚å¸¸è¦æœ‰é™çº§ç­–ç•¥
e. å¼‚å¸¸å¤„ç†è¦è€ƒè™‘äº‹åŠ¡è¾¹ç•Œ

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥è¾¹ç•Œå¼‚å¸¸å¤„ç†
b. é›†æˆæµ‹è¯•ï¼šéªŒè¯å¤–éƒ¨è°ƒç”¨å¼‚å¸¸
c. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸æƒ…å†µä¸‹ç³»ç»Ÿç¨³å®šæ€§
d. ç›‘æ§éªŒè¯ï¼šç¡®è®¤å¼‚å¸¸ç›‘æ§è¦†ç›–

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå¤–éƒ¨è°ƒç”¨å¼‚å¸¸æœªå¤„ç†
@Service
public class PaymentService {
    @Autowired
    private PaymentGatewayClient paymentGateway;
    
    public PaymentResult processPayment(PaymentRequest request) {
        // ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡ï¼Œæ²¡æœ‰å¼‚å¸¸å¤„ç†
        return paymentGateway.charge(request);
    }
}

// âŒ é”™è¯¯ï¼šå¼‚æ­¥å¼‚å¸¸å¤„ç†ä¸å½“
@Service
public class NotificationService {
    @Async
    public void sendNotification(String message) {
        try {
            emailService.send(message);
        } catch (Exception e) {
            // å¼‚æ­¥æ–¹æ³•ä¸­çš„å¼‚å¸¸è¢«åæ‰ï¼Œæ²¡æœ‰è®°å½•
            // è°ƒç”¨æ–¹æ— æ³•çŸ¥é“å¼‚å¸¸å‘ç”Ÿ
        }
    }
}

// âŒ é”™è¯¯ï¼šäº‹åŠ¡è¾¹ç•Œå¼‚å¸¸å¤„ç†ä¸å½“
@Service
@Transactional
public class OrderService {
    public Order createOrder(OrderRequest request) {
        try {
            Order order = new Order(request);
            orderRepository.save(order);
            
            // å¤–éƒ¨è°ƒç”¨å¯èƒ½å¤±è´¥ï¼Œä½†äº‹åŠ¡å·²ç»æäº¤
            inventoryService.reserveItems(order.getItems());
            
            return order;
        } catch (Exception e) {
            // å¼‚å¸¸å¤„ç†ä¸å½“ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
            throw new RuntimeException("è®¢å•åˆ›å»ºå¤±è´¥");
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå¤–éƒ¨è°ƒç”¨å¼‚å¸¸å¤„ç†
@Service
public class PaymentService {
    private static final Logger log = LoggerFactory.getLogger(PaymentService.class);
    
    @Autowired
    private PaymentGatewayClient paymentGateway;
    
    @Autowired
    private CircuitBreaker circuitBreaker;
    
    public PaymentResult processPayment(PaymentRequest request) {
        return circuitBreaker.executeSupplier(() -> {
            try {
                // å¤–éƒ¨è°ƒç”¨å¼‚å¸¸å¤„ç†
                PaymentResult result = paymentGateway.charge(request);
                log.info("Payment processed successfully: orderId={}, amount={}", 
                    request.getOrderId(), request.getAmount());
                return result;
                
            } catch (PaymentGatewayTimeoutException e) {
                // è¶…æ—¶å¼‚å¸¸ - å¯é‡è¯•
                log.warn("Payment gateway timeout: orderId={}", request.getOrderId(), e);
                throw new RetryableException("æ”¯ä»˜ç½‘å…³è¶…æ—¶", 
                    "Payment gateway timeout for order: " + request.getOrderId(), e);
                    
            } catch (PaymentGatewayUnavailableException e) {
                // æœåŠ¡ä¸å¯ç”¨ - ç†”æ–­
                log.error("Payment gateway unavailable: orderId={}", request.getOrderId(), e);
                throw new CircuitBreakerException("æ”¯ä»˜ç½‘å…³ä¸å¯ç”¨", 
                    "Payment gateway unavailable for order: " + request.getOrderId(), e);
                    
            } catch (InsufficientFundsException e) {
                // ä¸šåŠ¡å¼‚å¸¸ - ä¸é‡è¯•
                log.info("Insufficient funds: orderId={}, amount={}", 
                    request.getOrderId(), request.getAmount());
                throw new BusinessException("INSUFFICIENT_FUNDS", 
                    "ä½™é¢ä¸è¶³", 
                    "Insufficient funds for order: " + request.getOrderId(), e);
                    
            } catch (PaymentGatewayException e) {
                // å…¶ä»–ç½‘å…³å¼‚å¸¸
                log.error("Payment gateway error: orderId={}, errorCode={}", 
                    request.getOrderId(), e.getErrorCode(), e);
                throw new SystemException("PAYMENT_GATEWAY_ERROR", 
                    "æ”¯ä»˜ç³»ç»Ÿå¼‚å¸¸", 
                    "Payment gateway error: " + e.getErrorCode(), e);
                    
            } catch (Exception e) {
                // æœªçŸ¥å¼‚å¸¸
                log.error("Unexpected error processing payment: orderId={}", 
                    request.getOrderId(), e);
                throw new SystemException("PAYMENT_UNEXPECTED_ERROR", 
                    "æ”¯ä»˜å¤„ç†å¼‚å¸¸", 
                    "Unexpected error processing payment for order: " + request.getOrderId(), e);
            }
        });
    }
}

// âœ… æ­£ç¡®ï¼šå¼‚æ­¥å¼‚å¸¸å¤„ç†
@Service
public class NotificationService {
    private static final Logger log = LoggerFactory.getLogger(NotificationService.class);
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @Async
    @Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
    public CompletableFuture<Void> sendNotificationAsync(NotificationRequest request) {
        try {
            emailService.send(request.getEmail(), request.getSubject(), request.getContent());
            log.info("Notification sent successfully: email={}, subject={}", 
                request.getEmail(), request.getSubject());
            
            // å‘å¸ƒæˆåŠŸäº‹ä»¶
            eventPublisher.publishEvent(new NotificationSentEvent(request));
            
            return CompletableFuture.completedFuture(null);
            
        } catch (EmailServiceException e) {
            log.error("Email service error: email={}, subject={}", 
                request.getEmail(), request.getSubject(), e);
            
            // å‘å¸ƒå¤±è´¥äº‹ä»¶
            eventPublisher.publishEvent(new NotificationFailedEvent(request, e));
            
            // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•
            throw new SystemException("EMAIL_SEND_ERROR", 
                "é‚®ä»¶å‘é€å¤±è´¥", 
                "Email send error: " + request.getEmail(), e);
                
        } catch (Exception e) {
            log.error("Unexpected error sending notification: email={}", 
                request.getEmail(), e);
            
            // å‘å¸ƒå¤±è´¥äº‹ä»¶
            eventPublisher.publishEvent(new NotificationFailedEvent(request, e));
            
            throw new SystemException("NOTIFICATION_UNEXPECTED_ERROR", 
                "é€šçŸ¥å‘é€å¼‚å¸¸", 
                "Unexpected error sending notification: " + request.getEmail(), e);
        }
    }
    
    @Recover
    public CompletableFuture<Void> recoverNotification(Exception e, NotificationRequest request) {
        log.error("All retry attempts failed for notification: email={}", 
            request.getEmail(), e);
        
        // å‘å¸ƒæœ€ç»ˆå¤±è´¥äº‹ä»¶
        eventPublisher.publishEvent(new NotificationFinallyFailedEvent(request, e));
        
        return CompletableFuture.completedFuture(null);
    }
}

// âœ… æ­£ç¡®ï¼šäº‹åŠ¡è¾¹ç•Œå¼‚å¸¸å¤„ç†
@Service
public class OrderService {
    private static final Logger log = LoggerFactory.getLogger(OrderService.class);
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Transactional(rollbackFor = Exception.class)
    public Order createOrder(OrderRequest request) {
        try {
            // 1. åˆ›å»ºè®¢å•ï¼ˆäº‹åŠ¡å†…ï¼‰
            Order order = new Order(request);
            order.setStatus(OrderStatus.PENDING);
            order = orderRepository.save(order);
            
            log.info("Order created: orderId={}, customerId={}", 
                order.getId(), request.getCustomerId());
            
            return order;
            
        } catch (DataIntegrityViolationException e) {
            log.warn("Data integrity violation creating order: customerId={}", 
                request.getCustomerId(), e);
            throw new BusinessException("ORDER_DATA_CONFLICT", 
                "è®¢å•æ•°æ®å†²çª", 
                "Data conflict creating order for customer: " + request.getCustomerId(), e);
                
        } catch (Exception e) {
            log.error("Error creating order: customerId={}", 
                request.getCustomerId(), e);
            throw new SystemException("ORDER_CREATE_ERROR", 
                "è®¢å•åˆ›å»ºå¤±è´¥", 
                "Error creating order for customer: " + request.getCustomerId(), e);
        }
    }
    
    // åˆ†ç¦»å¤–éƒ¨è°ƒç”¨ï¼Œé¿å…äº‹åŠ¡è¾¹ç•Œé—®é¢˜
    public OrderResult processOrder(OrderRequest request) {
        Order order = null;
        try {
            // 1. åˆ›å»ºè®¢å•ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
            order = createOrder(request);
            
            // 2. åº“å­˜é¢„ç•™ï¼ˆå¤–éƒ¨è°ƒç”¨ï¼‰
            InventoryReservation reservation = inventoryService.reserveItems(order.getItems());
            
            // 3. å¤„ç†æ”¯ä»˜ï¼ˆå¤–éƒ¨è°ƒç”¨ï¼‰
            PaymentResult paymentResult = paymentService.processPayment(
                new PaymentRequest(order.getId(), order.getTotalAmount()));
            
            // 4. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
            updateOrderStatus(order.getId(), OrderStatus.CONFIRMED);
            
            log.info("Order processed successfully: orderId={}", order.getId());
            
            return new OrderResult(order, reservation, paymentResult);
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œå›æ»šè®¢å•
            if (order != null) {
                handleOrderFailure(order.getId(), e);
            }
            throw e;
            
        } catch (SystemException e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼Œå›æ»šè®¢å•
            if (order != null) {
                handleOrderFailure(order.getId(), e);
            }
            throw e;
            
        } catch (Exception e) {
            // æœªçŸ¥å¼‚å¸¸ï¼Œå›æ»šè®¢å•
            if (order != null) {
                handleOrderFailure(order.getId(), e);
            }
            log.error("Unexpected error processing order: customerId={}", 
                request.getCustomerId(), e);
            throw new SystemException("ORDER_PROCESS_ERROR", 
                "è®¢å•å¤„ç†å¼‚å¸¸", 
                "Unexpected error processing order for customer: " + request.getCustomerId(), e);
        }
    }
    
    @Transactional(rollbackFor = Exception.class)
    public void updateOrderStatus(Long orderId, OrderStatus status) {
        try {
            Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new BusinessException("ORDER_NOT_FOUND", 
                    "è®¢å•ä¸å­˜åœ¨", "Order not found: " + orderId));
            
            order.setStatus(status);
            order.setUpdatedAt(LocalDateTime.now());
            orderRepository.save(order);
            
            log.info("Order status updated: orderId={}, status={}", orderId, status);
            
        } catch (Exception e) {
            log.error("Error updating order status: orderId={}, status={}", 
                orderId, status, e);
            throw new SystemException("ORDER_STATUS_UPDATE_ERROR", 
                "è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥", 
                "Error updating order status: " + orderId, e);
        }
    }
    
    @Transactional(rollbackFor = Exception.class)
    public void handleOrderFailure(Long orderId, Exception cause) {
        try {
            updateOrderStatus(orderId, OrderStatus.FAILED);
            log.warn("Order marked as failed: orderId={}", orderId, cause);
        } catch (Exception e) {
            log.error("Error handling order failure: orderId={}", orderId, e);
        }
    }
}
```

##### 4.9.3.3 å…¨å±€å¼‚å¸¸å¤„ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»æœ‰å…¨å±€å¼‚å¸¸å¤„ç†å™¨
b. å¼‚å¸¸å“åº”æ ¼å¼è¦ç»Ÿä¸€
c. æ•æ„Ÿä¿¡æ¯ä¸èƒ½æš´éœ²ç»™å®¢æˆ·ç«¯
d. å¼‚å¸¸è¦è®°å½•å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
e. ä¸åŒç±»å‹å¼‚å¸¸è¦æœ‰ä¸åŒå¤„ç†ç­–ç•¥

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å…¨å±€å¼‚å¸¸å¤„ç†å™¨
b. æ¥å£æµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸å“åº”æ ¼å¼
c. å®‰å…¨æµ‹è¯•ï¼šç¡®è®¤æ•æ„Ÿä¿¡æ¯ä¸æ³„éœ²
d. æ—¥å¿—åˆ†æï¼šéªŒè¯å¼‚å¸¸è®°å½•å®Œæ•´æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰å…¨å±€å¼‚å¸¸å¤„ç†
@RestController
public class UserController {
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        // å¼‚å¸¸ç›´æ¥æŠ›å‡ºï¼Œæ²¡æœ‰ç»Ÿä¸€å¤„ç†
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸ä¿¡æ¯æš´éœ²è¿‡å¤š
@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(Exception.class)
    public ResponseEntity<String> handleException(Exception e) {
        // ç›´æ¥è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼Œå¯èƒ½æš´éœ²æ•æ„Ÿä¿¡æ¯
        return ResponseEntity.status(500).body(e.getMessage());
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸å¤„ç†ä¸å®Œæ•´
@ControllerAdvice
public class SimpleExceptionHandler {
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(BusinessException e) {
        // æ²¡æœ‰è®°å½•æ—¥å¿—ï¼Œæ²¡æœ‰traceId
        return ResponseEntity.badRequest()
            .body(new ErrorResponse(e.getMessage()));
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å…¨å±€å¼‚å¸¸å¤„ç†
@ControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(
            BusinessException e, HttpServletRequest request) {
        
        String traceId = MDC.get("traceId");
        String requestId = UUID.randomUUID().toString();
        
        // è®°å½•ä¸šåŠ¡å¼‚å¸¸ï¼ˆINFOçº§åˆ«ï¼‰
        log.info("Business exception: code={}, message={}, path={}, traceId={}, requestId={}", 
            e.getErrorCode(), e.getUserMessage(), request.getRequestURI(), traceId, requestId);
        
        ErrorResponse response = ErrorResponse.builder()
            .code(e.getErrorCode())
            .message(e.getUserMessage())
            .traceId(traceId)
            .requestId(requestId)
            .timestamp(LocalDateTime.now())
            .path(request.getRequestURI())
            .build();
            
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }
    
    @ExceptionHandler(SystemException.class)
    public ResponseEntity<ErrorResponse> handleSystemException(
            SystemException e, HttpServletRequest request) {
        
        String traceId = MDC.get("traceId");
        String requestId = UUID.randomUUID().toString();
        
        // è®°å½•ç³»ç»Ÿå¼‚å¸¸ï¼ˆERRORçº§åˆ«ï¼‰
        log.error("System exception: code={}, message={}, path={}, traceId={}, requestId={}", 
            e.getErrorCode(), e.getUserMessage(), request.getRequestURI(), traceId, requestId, e);
        
        ErrorResponse response = ErrorResponse.builder()
            .code("SYSTEM_ERROR")
            .message("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•")
            .traceId(traceId)
            .requestId(requestId)
            .timestamp(LocalDateTime.now())
            .path(request.getRequestURI())
            .build();
            
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }
    
    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(
            ValidationException e, HttpServletRequest request) {
        
        String traceId = MDC.get("traceId");
        String requestId = UUID.randomUUID().toString();
        
        // è®°å½•å‚æ•°éªŒè¯å¼‚å¸¸ï¼ˆWARNçº§åˆ«ï¼‰
        log.warn("Validation exception: message={}, path={}, traceId={}, requestId={}", 
            e.getMessage(), request.getRequestURI(), traceId, requestId);
        
        ErrorResponse response = ErrorResponse.builder()
            .code("VALIDATION_ERROR")
            .message("å‚æ•°éªŒè¯å¤±è´¥")
            .details(e.getValidationErrors())
            .traceId(traceId)
            .requestId(requestId)
            .timestamp(LocalDateTime.now())
            .path(request.getRequestURI())
            .build();
            
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }
    
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ErrorResponse> handleAccessDeniedException(
            AccessDeniedException e, HttpServletRequest request) {
        
        String traceId = MDC.get("traceId");
        String requestId = UUID.randomUUID().toString();
        
        // è®°å½•è®¿é—®æ‹’ç»å¼‚å¸¸ï¼ˆWARNçº§åˆ«ï¼‰
        log.warn("Access denied: path={}, user={}, traceId={}, requestId={}", 
            request.getRequestURI(), getCurrentUser(), traceId, requestId);
        
        ErrorResponse response = ErrorResponse.builder()
            .code("ACCESS_DENIED")
            .message("è®¿é—®è¢«æ‹’ç»")
            .traceId(traceId)
            .requestId(requestId)
            .timestamp(LocalDateTime.now())
            .path(request.getRequestURI())
            .build();
            
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(response);
    }
    
    @ExceptionHandler(HttpRequestMethodNotSupportedException.class)
    public ResponseEntity<ErrorResponse> handleMethodNotSupported(
            HttpRequestMethodNotSupportedException e, HttpServletRequest request) {
        
        String traceId = MDC.get("traceId");
        String requestId = UUID.randomUUID().toString();
        
        log.warn("Method not supported: method={}, path={}, traceId={}, requestId={}", 
            request.getMethod(), request.getRequestURI(), traceId, requestId);
        
        ErrorResponse response = ErrorResponse.builder()
            .code("METHOD_NOT_SUPPORTED")
            .message("è¯·æ±‚æ–¹æ³•ä¸æ”¯æŒ")
            .traceId(traceId)
            .requestId(requestId)
            .timestamp(LocalDateTime.now())
            .path(request.getRequestURI())
            .build();
            
        return ResponseEntity.status(HttpStatus.METHOD_NOT_ALLOWED).body(response);
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleUnexpectedException(
            Exception e, HttpServletRequest request) {
        
        String traceId = MDC.get("traceId");
        String requestId = UUID.randomUUID().toString();
        
        // è®°å½•æœªçŸ¥å¼‚å¸¸ï¼ˆERRORçº§åˆ«ï¼‰
        log.error("Unexpected exception: type={}, message={}, path={}, traceId={}, requestId={}", 
            e.getClass().getSimpleName(), e.getMessage(), request.getRequestURI(), 
            traceId, requestId, e);
        
        ErrorResponse response = ErrorResponse.builder()
            .code("UNEXPECTED_ERROR")
            .message("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•")
            .traceId(traceId)
            .requestId(requestId)
            .timestamp(LocalDateTime.now())
            .path(request.getRequestURI())
            .build();
            
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }
    
    private String getCurrentUser() {
        try {
            Authentication auth = SecurityContextHolder.getContext().getAuthentication();
            return auth != null ? auth.getName() : "anonymous";
        } catch (Exception e) {
            return "unknown";
        }
    }
}

// âœ… æ­£ç¡®ï¼šç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ErrorResponse {
    private String code;
    private String message;
    private Object details;
    private String traceId;
    private String requestId;
    private LocalDateTime timestamp;
    private String path;
    
    public static ErrorResponseBuilder builder() {
        return new ErrorResponseBuilder();
    }
}

// âœ… æ­£ç¡®ï¼šå¼‚å¸¸ç›‘æ§å’Œå‘Šè­¦
@Component
@Slf4j
public class ExceptionMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter businessExceptionCounter;
    private final Counter systemExceptionCounter;
    private final Timer exceptionProcessingTimer;
    
    public ExceptionMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.businessExceptionCounter = Counter.builder("exception.business")
            .description("Business exception count")
            .register(meterRegistry);
        this.systemExceptionCounter = Counter.builder("exception.system")
            .description("System exception count")
            .register(meterRegistry);
        this.exceptionProcessingTimer = Timer.builder("exception.processing.time")
            .description("Exception processing time")
            .register(meterRegistry);
    }
    
    @EventListener
    public void handleBusinessException(BusinessExceptionEvent event) {
        businessExceptionCounter.increment(
            Tags.of(
                "code", event.getErrorCode(),
                "service", event.getServiceName()
            )
        );
        
        // é«˜é¢‘ä¸šåŠ¡å¼‚å¸¸å‘Šè­¦
        if (isHighFrequencyException(event.getErrorCode())) {
            sendAlert("High frequency business exception: " + event.getErrorCode());
        }
    }
    
    @EventListener
    public void handleSystemException(SystemExceptionEvent event) {
        systemExceptionCounter.increment(
            Tags.of(
                "code", event.getErrorCode(),
                "service", event.getServiceName()
            )
        );
        
        // ç³»ç»Ÿå¼‚å¸¸ç«‹å³å‘Šè­¦
        sendAlert("System exception occurred: " + event.getErrorCode());
    }
    
    private boolean isHighFrequencyException(String errorCode) {
        // æ£€æŸ¥å¼‚å¸¸é¢‘ç‡é€»è¾‘
        return businessExceptionCounter.count() > 100; // ç¤ºä¾‹é˜ˆå€¼
    }
    
    private void sendAlert(String message) {
        // å‘é€å‘Šè­¦é€»è¾‘
        log.warn("ALERT: {}", message);
    }
}
```
e. å¼‚å¸¸ç»Ÿè®¡å’Œå‘Šè­¦æœºåˆ¶å®Œå–„

**2. æ£€æµ‹æ–¹æ³•**

a. æ—¥å¿—å®¡æŸ¥ï¼šæ£€æŸ¥å¼‚å¸¸æ—¥å¿—æ ¼å¼å’Œå†…å®¹
b. å®‰å…¨æ£€æŸ¥ï¼šç¡®è®¤æ•æ„Ÿä¿¡æ¯ä¸æ³„éœ²
c. ç›‘æ§éªŒè¯ï¼šç¡®è®¤å¼‚å¸¸ç›‘æ§å’Œå‘Šè­¦æœ‰æ•ˆ
d. é“¾è·¯è¿½è¸ªï¼šéªŒè¯å¼‚å¸¸åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è¿½è¸ª

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ—¥å¿—ä¿¡æ¯ä¸å®Œæ•´
@Service
public class PaymentService {
    private static final Logger log = LoggerFactory.getLogger(PaymentService.class);
    
    public void processPayment(PaymentRequest request) {
        try {
            paymentGateway.charge(request);
        } catch (Exception e) {
            log.error("Payment failed"); // ç¼ºå°‘ä¸Šä¸‹æ–‡ä¿¡æ¯
            throw e;
        }
    }
}

// âŒ é”™è¯¯ï¼šæ•æ„Ÿä¿¡æ¯æ³„éœ²
public class UserService {
    public void login(String username, String password) {
        try {
            authenticate(username, password);
        } catch (AuthenticationException e) {
            // è®°å½•äº†æ•æ„Ÿçš„å¯†ç ä¿¡æ¯
            log.error("Login failed: username={}, password={}", username, password);
            throw e;
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å¼‚å¸¸æ—¥å¿—è®°å½•
@Service
public class PaymentService {
    private static final Logger log = LoggerFactory.getLogger(PaymentService.class);
    
    public PaymentResult processPayment(PaymentRequest request) {
        String traceId = MDC.get("traceId");
        
        try {
            log.info("Processing payment: orderId={}, amount={}, traceId={}", 
                request.getOrderId(), request.getAmount(), traceId);
                
            PaymentResult result = paymentGateway.charge(request);
            
            log.info("Payment processed successfully: orderId={}, transactionId={}, traceId={}", 
                request.getOrderId(), result.getTransactionId(), traceId);
                
            return result;
            
        } catch (PaymentGatewayException e) {
            // ä¸šåŠ¡å¼‚å¸¸ä½¿ç”¨WARNçº§åˆ«
            log.warn("Payment gateway error: orderId={}, errorCode={}, message={}, traceId={}", 
                request.getOrderId(), e.getErrorCode(), e.getMessage(), traceId);
            throw new BusinessException("PAYMENT_FAILED", 
                "æ”¯ä»˜å¤±è´¥: " + e.getMessage());
                
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ä½¿ç”¨ERRORçº§åˆ«ï¼Œè®°å½•å®Œæ•´å †æ ˆ
            log.error("System error during payment: orderId={}, traceId={}", 
                request.getOrderId(), traceId, e);
            throw new SystemException("PAYMENT_SYSTEM_ERROR", 
                "æ”¯ä»˜ç³»ç»Ÿå¼‚å¸¸", 
                "Payment system error for order: " + request.getOrderId(), e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„æ—¥å¿—è®°å½•
@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    public LoginResult login(String username, String password) {
        String traceId = MDC.get("traceId");
        
        try {
            log.debug("User login attempt: username={}, traceId={}", username, traceId);
            
            LoginResult result = authenticationService.authenticate(username, password);
            
            log.info("User login successful: username={}, userId={}, traceId={}", 
                username, result.getUserId(), traceId);
                
            return result;
            
        } catch (InvalidCredentialsException e) {
            // æ­£ç¡®ï¼šä¸è®°å½•å¯†ç ï¼Œè®°å½•å¤±è´¥åŸå› 
            log.warn("User login failed: username={}, reason={}, traceId={}", 
                username, e.getMessage(), traceId);
            throw e;
            
        } catch (Exception e) {
            // æ­£ç¡®ï¼šç³»ç»Ÿå¼‚å¸¸ä½¿ç”¨ERRORçº§åˆ«ï¼Œè®°å½•å®Œæ•´å †æ ˆ
            log.error("System error during login: username={}, traceId={}", 
                username, traceId, e);
            throw new SystemException("Login system error", e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—é…ç½®
// logback-spring.xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/application.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>logs/application.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
            </rollingPolicy>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <logLevel/>
                    <loggerName/>
                    <mdc/>
                    <message/>
                    <stackTrace/>
                </providers>
            </encoder>
        </appender>
        
        <appender name="ASYNC" class="ch.qos.logback.classic.AsyncAppender">
            <appender-ref ref="FILE"/>
            <queueSize>1024</queueSize>
            <discardingThreshold>0</discardingThreshold>
        </appender>
        
        <root level="INFO">
            <appender-ref ref="ASYNC"/>
        </root>
    </springProfile>
</configuration>
```