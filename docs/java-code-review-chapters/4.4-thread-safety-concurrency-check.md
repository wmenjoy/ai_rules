# 4.4 çº¿ç¨‹å®‰å…¨ä¸å¹¶å‘å¤„ç†æ£€æŸ¥

## 4.4.1 çº¿ç¨‹æ± é…ç½®æ£€æŸ¥ ğŸ”´

### 4.4.1.1 çº¿ç¨‹æ± å‚æ•°é…ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. çº¿ç¨‹æ± é…ç½®æ˜¯å¦ç¬¦åˆæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ã€‚
b. æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯å¦åˆç†è®¾ç½®ã€‚
c. é˜Ÿåˆ—å¤§å°æ˜¯å¦æœ‰åˆç†ä¸Šé™ã€‚
d. æ‹’ç»ç­–ç•¥æ˜¯å¦é€‚å½“é…ç½®ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æï¼ˆä½¿ç”¨SonarQubeè§„åˆ™java:S2142ï¼‰ã€‚
2. ä»£ç å®¡æŸ¥ï¼ˆæ£€æŸ¥æ‰€æœ‰ThreadPoolExecutoråˆ›å»ºä»£ç ï¼‰ã€‚
3. è¿è¡Œæ—¶ç›‘æ§ï¼ˆJVMçº¿ç¨‹ç›‘æ§ã€çº¿ç¨‹æ± çŠ¶æ€ç›‘æ§ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨å·¥å‚æ–¹æ³•ï¼Œæ— æ³•æ§åˆ¶å‚æ•°
public class TaskProcessor {
    // ä½¿ç”¨Executorså·¥å‚æ–¹æ³•ï¼Œæ— æ³•ç²¾ç¡®æ§åˆ¶çº¿ç¨‹æ± å‚æ•°
    private ExecutorService executor = Executors.newFixedThreadPool(10);
    
    public void processTask(Runnable task) {
        executor.submit(task);
    }
}

// âŒ é”™è¯¯ï¼šæ— ç•Œé˜Ÿåˆ—å¯èƒ½å¯¼è‡´OOM
public class DataProcessor {
    private ThreadPoolExecutor executor = new ThreadPoolExecutor(
        5, 10, 60L, TimeUnit.SECONDS,
        new LinkedBlockingQueue<>() // æ— ç•Œé˜Ÿåˆ—ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
    );
    
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰è®¾ç½®çº¿ç¨‹åç§°å’Œæ‹’ç»ç­–ç•¥
    public void processData(List<Data> dataList) {
        for (Data data : dataList) {
            executor.submit(() -> handleData(data));
        }
    }
}

// âŒ é”™è¯¯ï¼šçº¿ç¨‹æ•°é…ç½®ä¸åˆç†
public class ReportGenerator {
    // CPUå¯†é›†å‹ä»»åŠ¡ä½¿ç”¨è¿‡å¤šçº¿ç¨‹
    private ThreadPoolExecutor cpuIntensiveExecutor = new ThreadPoolExecutor(
        50, 100, 60L, TimeUnit.SECONDS, // çº¿ç¨‹æ•°è¿‡å¤š
        new ArrayBlockingQueue<>(10)
    );
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ˜ç¡®é…ç½®æ‰€æœ‰å‚æ•°
public class TaskProcessor {
    private final ThreadPoolExecutor executor;
    
    public TaskProcessor() {
        int corePoolSize = Runtime.getRuntime().availableProcessors();
        int maximumPoolSize = corePoolSize * 2;
        
        this.executor = new ThreadPoolExecutor(
            corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•°
            maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•°
            60L, TimeUnit.SECONDS, // ç©ºé—²æ—¶é—´
            new ArrayBlockingQueue<>(500), // æœ‰ç•Œé˜Ÿåˆ—
            new ThreadFactoryBuilder()
                .setNameFormat("task-processor-%d")
                .setDaemon(true)
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
        );
    }
    
    public Future<?> processTask(Runnable task) {
        return executor.submit(task);
    }
    
    @PreDestroy
    public void shutdown() {
        executor.shutdown();
        try {
            if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                executor.shutdownNow();
            }
        } catch (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}

// âœ… æ­£ç¡®ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹é…ç½®ä¸åŒçš„çº¿ç¨‹æ± 
@Configuration
public class ThreadPoolConfig {
    
    @Bean("cpuIntensiveExecutor")
    public ThreadPoolExecutor cpuIntensiveExecutor() {
        int processors = Runtime.getRuntime().availableProcessors();
        return new ThreadPoolExecutor(
            processors + 1, // CPUå¯†é›†å‹ï¼šCPUæ ¸æ•°+1
            processors + 1,
            60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder()
                .setNameFormat("cpu-intensive-%d")
                .build(),
            new ThreadPoolExecutor.AbortPolicy()
        );
    }
    
    @Bean("ioIntensiveExecutor")
    public ThreadPoolExecutor ioIntensiveExecutor() {
        int processors = Runtime.getRuntime().availableProcessors();
        return new ThreadPoolExecutor(
            processors * 2, // IOå¯†é›†å‹ï¼šCPUæ ¸æ•°*2
            processors * 4,
            60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(200),
            new ThreadFactoryBuilder()
                .setNameFormat("io-intensive-%d")
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }
}
```

### 4.4.1.2 çº¿ç¨‹æ± ç›‘æ§å’Œç®¡ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. çº¿ç¨‹æ± æ˜¯å¦æœ‰é€‚å½“çš„ç›‘æ§æœºåˆ¶ã€‚
b. çº¿ç¨‹æ± å…³é—­æ˜¯å¦ä¼˜é›…å¤„ç†ã€‚
c. çº¿ç¨‹æ± å¼‚å¸¸æ˜¯å¦æœ‰åˆç†çš„å¤„ç†æœºåˆ¶ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ç›‘æ§ä»£ç å®¡æŸ¥ã€‚
2. å¼‚å¸¸å¤„ç†æœºåˆ¶æ£€æŸ¥ã€‚
3. èµ„æºæ¸…ç†éªŒè¯ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç›‘æ§å’Œå¼‚å¸¸å¤„ç†
@Service
public class EmailService {
    private ThreadPoolExecutor emailExecutor = new ThreadPoolExecutor(
        5, 10, 60L, TimeUnit.SECONDS,
        new ArrayBlockingQueue<>(100)
    );
    
    public void sendEmail(String to, String subject, String content) {
        // æ²¡æœ‰å¼‚å¸¸å¤„ç†ï¼Œä»»åŠ¡å¤±è´¥æ—¶æ— æ³•æ„ŸçŸ¥
        emailExecutor.submit(() -> {
            // å‘é€é‚®ä»¶é€»è¾‘
            smtpClient.send(to, subject, content);
        });
    }
    
    // æ²¡æœ‰ä¼˜é›…å…³é—­æœºåˆ¶
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ç›‘æ§å’Œå¼‚å¸¸å¤„ç†
@Service
public class EmailService {
    private static final Logger logger = LoggerFactory.getLogger(EmailService.class);
    private final ThreadPoolExecutor emailExecutor;
    private final MeterRegistry meterRegistry;
    
    public EmailService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.emailExecutor = new ThreadPoolExecutor(
            5, 10, 60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder()
                .setNameFormat("email-sender-%d")
                .setUncaughtExceptionHandler((t, e) -> {
                    logger.error("é‚®ä»¶å‘é€çº¿ç¨‹å¼‚å¸¸", e);
                    meterRegistry.counter("email.thread.error").increment();
                })
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
        
        // æ³¨å†Œç›‘æ§æŒ‡æ ‡
        Gauge.builder("email.thread.pool.active")
            .register(meterRegistry, emailExecutor, ThreadPoolExecutor::getActiveCount);
        Gauge.builder("email.thread.pool.queue.size")
            .register(meterRegistry, emailExecutor, e -> e.getQueue().size());
    }
    
    public CompletableFuture<Void> sendEmail(String to, String subject, String content) {
        return CompletableFuture.runAsync(() -> {
            try {
                smtpClient.send(to, subject, content);
                meterRegistry.counter("email.sent.success").increment();
                logger.info("é‚®ä»¶å‘é€æˆåŠŸ: {}", to);
            } catch (Exception e) {
                meterRegistry.counter("email.sent.failure").increment();
                logger.error("é‚®ä»¶å‘é€å¤±è´¥: {}", to, e);
                throw new RuntimeException("é‚®ä»¶å‘é€å¤±è´¥", e);
            }
        }, emailExecutor);
    }
    
    @PreDestroy
    public void shutdown() {
        logger.info("å¼€å§‹å…³é—­é‚®ä»¶å‘é€çº¿ç¨‹æ± ");
        emailExecutor.shutdown();
        try {
            if (!emailExecutor.awaitTermination(30, TimeUnit.SECONDS)) {
                logger.warn("é‚®ä»¶å‘é€çº¿ç¨‹æ± æœªèƒ½åœ¨30ç§’å†…å…³é—­ï¼Œå¼ºåˆ¶å…³é—­");
                emailExecutor.shutdownNow();
                if (!emailExecutor.awaitTermination(10, TimeUnit.SECONDS)) {
                    logger.error("é‚®ä»¶å‘é€çº¿ç¨‹æ± å¼ºåˆ¶å…³é—­å¤±è´¥");
                }
            }
        } catch (InterruptedException e) {
            logger.error("ç­‰å¾…çº¿ç¨‹æ± å…³é—­æ—¶è¢«ä¸­æ–­", e);
            emailExecutor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
```

## 4.4.2 Springå¹¶å‘é—®é¢˜æ£€æŸ¥ ğŸ”´

### 4.4.2.1 å•ä¾‹Beançº¿ç¨‹å®‰å…¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å•ä¾‹Beanä¸­æ˜¯å¦å­˜åœ¨éçº¿ç¨‹å®‰å…¨çš„å®ä¾‹å˜é‡ã€‚
b. å…±äº«çŠ¶æ€æ˜¯å¦æœ‰é€‚å½“çš„åŒæ­¥ä¿æŠ¤ã€‚
c. æ— çŠ¶æ€è®¾è®¡æ˜¯å¦å¾—åˆ°æ­£ç¡®å®ç°ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€åˆ†æï¼ˆæ£€æŸ¥@Componentã€@Serviceç­‰æ³¨è§£çš„ç±»ä¸­çš„å®ä¾‹å˜é‡ï¼‰ã€‚
2. ä»£ç å®¡æŸ¥ï¼ˆé‡ç‚¹æ£€æŸ¥å…±äº«çŠ¶æ€çš„è®¿é—®ï¼‰ã€‚
3. å¹¶å‘æµ‹è¯•ï¼ˆéªŒè¯çº¿ç¨‹å®‰å…¨æ€§ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå•ä¾‹Beanä¸­çš„éçº¿ç¨‹å®‰å…¨å˜é‡
@Service
public class UserService {
    private int requestCount = 0; // çº¿ç¨‹ä¸å®‰å…¨çš„å®ä¾‹å˜é‡
    private User currentUser; // å…±äº«çŠ¶æ€ï¼Œçº¿ç¨‹ä¸å®‰å…¨
    private final List<String> processingUsers = new ArrayList<>(); // éçº¿ç¨‹å®‰å…¨é›†åˆ
    
    public void processUser(User user) {
        requestCount++; // å¹¶å‘é—®é¢˜ï¼šå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹
        currentUser = user; // å¹¶å‘é—®é¢˜ï¼šçŠ¶æ€è¢«å…¶ä»–çº¿ç¨‹è¦†ç›–
        processingUsers.add(user.getName()); // å¹¶å‘é—®é¢˜ï¼šArrayListéçº¿ç¨‹å®‰å…¨
        
        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        doProcessUser(user);
        
        processingUsers.remove(user.getName());
    }
    
    public int getRequestCount() {
        return requestCount; // å¯èƒ½è¯»å–åˆ°ä¸ä¸€è‡´çš„å€¼
    }
}

// âŒ é”™è¯¯ï¼šç¼“å­˜å®ç°çº¿ç¨‹ä¸å®‰å…¨
@Component
public class CacheService {
    private final Map<String, Object> cache = new HashMap<>(); // éçº¿ç¨‹å®‰å…¨
    
    public Object get(String key) {
        return cache.get(key); // å¹¶å‘è¯»å†™å¯èƒ½å¯¼è‡´æ­»å¾ªç¯
    }
    
    public void put(String key, Object value) {
        cache.put(key, value); // å¹¶å‘ä¿®æ”¹å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ–¹å¼
@Service
public class UserService {
    private final AtomicInteger requestCount = new AtomicInteger(0);
    private final Set<String> processingUsers = ConcurrentHashMap.newKeySet();
    
    // ä½¿ç”¨ThreadLocalå­˜å‚¨çº¿ç¨‹ç‰¹å®šçš„çŠ¶æ€
    private final ThreadLocal<User> currentUserThreadLocal = new ThreadLocal<>();
    
    public void processUser(User user) {
        requestCount.incrementAndGet(); // çº¿ç¨‹å®‰å…¨çš„è®¡æ•°
        currentUserThreadLocal.set(user); // çº¿ç¨‹æœ¬åœ°å­˜å‚¨
        processingUsers.add(user.getName()); // çº¿ç¨‹å®‰å…¨çš„é›†åˆ
        
        try {
            // ä¸šåŠ¡é€»è¾‘å¤„ç†
            doProcessUser(user);
        } finally {
            processingUsers.remove(user.getName());
            currentUserThreadLocal.remove(); // æ¸…ç†ThreadLocal
        }
    }
    
    public int getRequestCount() {
        return requestCount.get(); // çº¿ç¨‹å®‰å…¨çš„è¯»å–
    }
    
    public User getCurrentUser() {
        return currentUserThreadLocal.get();
    }
}

// âœ… æ­£ç¡®ï¼šæ— çŠ¶æ€è®¾è®¡
@Service
public class OrderCalculationService {
    private final TaxService taxService;
    private final DiscountService discountService;
    
    // æ— çŠ¶æ€æœåŠ¡ï¼Œæ‰€æœ‰æ•°æ®é€šè¿‡å‚æ•°ä¼ é€’
    public OrderTotal calculateTotal(Order order, Customer customer) {
        BigDecimal subtotal = calculateSubtotal(order.getItems());
        BigDecimal tax = taxService.calculateTax(subtotal, customer.getAddress());
        BigDecimal discount = discountService.calculateDiscount(order, customer);
        
        return OrderTotal.builder()
            .subtotal(subtotal)
            .tax(tax)
            .discount(discount)
            .total(subtotal.add(tax).subtract(discount))
            .build();
    }
    
    private BigDecimal calculateSubtotal(List<OrderItem> items) {
        return items.stream()
            .map(item -> item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity())))
            .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}

// âœ… æ­£ç¡®ï¼šçº¿ç¨‹å®‰å…¨çš„ç¼“å­˜å®ç°
@Component
public class CacheService {
    private final ConcurrentHashMap<String, Object> cache = new ConcurrentHashMap<>();
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    
    public Object get(String key) {
        return cache.get(key); // ConcurrentHashMapçº¿ç¨‹å®‰å…¨
    }
    
    public void put(String key, Object value) {
        cache.put(key, value);
    }
    
    // å¯¹äºå¤æ‚æ“ä½œï¼Œä½¿ç”¨é”ä¿æŠ¤
    public Object computeIfAbsent(String key, Function<String, Object> mappingFunction) {
        return cache.computeIfAbsent(key, mappingFunction);
    }
    
    public void evictExpired() {
        lock.writeLock().lock();
        try {
            // æ‰¹é‡æ¸…ç†è¿‡æœŸç¼“å­˜
            cache.entrySet().removeIf(entry -> isExpired(entry));
        } finally {
            lock.writeLock().unlock();
        }
    }
}
```

### 4.4.2.2 å¼‚æ­¥æ–¹æ³•ä½¿ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. @Asyncæ–¹æ³•æ˜¯å¦æ­£ç¡®è¿”å›Futureæˆ–CompletableFutureã€‚
b. å¼‚æ­¥æ–¹æ³•è°ƒç”¨æ˜¯å¦é¿å…äº†è‡ªè°ƒç”¨é—®é¢˜ã€‚
c. å¼‚æ­¥æ–¹æ³•ä¸äº‹åŠ¡çš„é…åˆæ˜¯å¦æ­£ç¡®ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä»£ç å®¡æŸ¥ï¼ˆé‡ç‚¹æ£€æŸ¥@Asyncæ³¨è§£çš„ä½¿ç”¨ï¼‰ã€‚
2. å¼‚æ­¥æ‰§è¡ŒéªŒè¯æµ‹è¯•ã€‚
3. äº‹åŠ¡è¾¹ç•Œæ£€æŸ¥ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šåŒç±»è°ƒç”¨å¼‚æ­¥æ–¹æ³•
@Service
public class OrderService {
    
    @Async
    public void processOrderAsync(Order order) {
        // å¼‚æ­¥å¤„ç†è®¢å•
        processOrder(order);
    }
    
    public void handleOrder(Order order) {
        // åŒç±»è°ƒç”¨ï¼Œä¸ä¼šå¼‚æ­¥æ‰§è¡Œ
        this.processOrderAsync(order); // è¿™é‡Œä¸ä¼šå¼‚æ­¥æ‰§è¡Œ
    }
    
    // âŒ é”™è¯¯ï¼šå¼‚æ­¥æ–¹æ³•æ²¡æœ‰è¿”å›Future
    @Async
    public void sendNotification(String message) {
        // æ— æ³•è·å–æ‰§è¡Œç»“æœæˆ–å¼‚å¸¸
        emailService.send(message);
    }
    
    // âŒ é”™è¯¯ï¼šäº‹åŠ¡æ–¹æ³•æ ‡è®°ä¸ºå¼‚æ­¥
    @Async
    @Transactional
    public void updateOrderStatus(Long orderId, OrderStatus status) {
        // å¼‚æ­¥æ‰§è¡Œä¼šå¯¼è‡´äº‹åŠ¡åœ¨ä¸åŒçº¿ç¨‹ä¸­ï¼Œå¯èƒ½å¤±æ•ˆ
        Order order = orderRepository.findById(orderId);
        order.setStatus(status);
        orderRepository.save(order);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šé€šè¿‡æ³¨å…¥è°ƒç”¨å¼‚æ­¥æ–¹æ³•
@Service
public class OrderService {
    private final OrderAsyncService orderAsyncService;
    private final NotificationAsyncService notificationAsyncService;
    
    public void handleOrder(Order order) {
        // é€šè¿‡æ³¨å…¥çš„æœåŠ¡è°ƒç”¨å¼‚æ­¥æ–¹æ³•
        CompletableFuture<Void> processFuture = orderAsyncService.processOrderAsync(order);
        CompletableFuture<Void> notifyFuture = notificationAsyncService.sendNotificationAsync(
            "è®¢å•å¤„ç†ä¸­: " + order.getId());
        
        // å¯ä»¥ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆæˆ–å¤„ç†å¼‚å¸¸
        CompletableFuture.allOf(processFuture, notifyFuture)
            .exceptionally(throwable -> {
                log.error("å¼‚æ­¥å¤„ç†è®¢å•å¤±è´¥", throwable);
                return null;
            });
    }
}

@Service
public class OrderAsyncService {
    
    @Async("orderProcessExecutor")
    public CompletableFuture<Void> processOrderAsync(Order order) {
        try {
            // å¼‚æ­¥å¤„ç†è®¢å•é€»è¾‘
            processOrder(order);
            return CompletableFuture.completedFuture(null);
        } catch (Exception e) {
            log.error("å¤„ç†è®¢å•å¼‚å¸¸: {}", order.getId(), e);
            return CompletableFuture.failedFuture(e);
        }
    }
    
    @Async("orderProcessExecutor")
    public CompletableFuture<OrderResult> calculateOrderTotalAsync(Order order) {
        return CompletableFuture.supplyAsync(() -> {
            // å¤æ‚çš„è®¡ç®—é€»è¾‘
            return calculateTotal(order);
        });
    }
}

@Service
public class NotificationAsyncService {
    
    @Async("notificationExecutor")
    public CompletableFuture<Void> sendNotificationAsync(String message) {
        return CompletableFuture.runAsync(() -> {
            try {
                emailService.send(message);
                log.info("é€šçŸ¥å‘é€æˆåŠŸ: {}", message);
            } catch (Exception e) {
                log.error("é€šçŸ¥å‘é€å¤±è´¥: {}", message, e);
                throw new RuntimeException("é€šçŸ¥å‘é€å¤±è´¥", e);
            }
        });
    }
}

// âœ… æ­£ç¡®ï¼šåˆ†ç¦»äº‹åŠ¡å’Œå¼‚æ­¥æ“ä½œ
@Service
public class OrderTransactionService {
    private final OrderAsyncService orderAsyncService;
    
    @Transactional
    public void updateOrderStatus(Long orderId, OrderStatus status) {
        // åœ¨äº‹åŠ¡ä¸­å®Œæˆæ•°æ®åº“æ“ä½œ
        Order order = orderRepository.findById(orderId);
        order.setStatus(status);
        orderRepository.save(order);
        
        // äº‹åŠ¡æäº¤åè§¦å‘å¼‚æ­¥æ“ä½œ
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    orderAsyncService.handleOrderStatusChange(order);
                }
            }
        );
    }
}
```

## 4.4.3 å¹¶å‘æ§åˆ¶æ£€æŸ¥ ğŸ”´

### 4.4.3.1 åŒæ­¥æœºåˆ¶ä½¿ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å…±äº«èµ„æºè®¿é—®æ˜¯å¦æœ‰é€‚å½“çš„åŒæ­¥ä¿æŠ¤ã€‚
b. åŒæ­¥æœºåˆ¶çš„é€‰æ‹©æ˜¯å¦åˆç†ã€‚
c. é”çš„ç²’åº¦æ˜¯å¦é€‚å½“ã€‚
d. æ˜¯å¦é¿å…äº†æ­»é”é£é™©ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€åˆ†æï¼ˆä½¿ç”¨SpotBugsæ£€æµ‹å¹¶å‘é—®é¢˜ï¼‰ã€‚
2. ä»£ç å®¡æŸ¥ï¼ˆæ£€æŸ¥æ‰€æœ‰åŒæ­¥ä»£ç å—å’Œæ–¹æ³•ï¼‰ã€‚
3. å‹åŠ›æµ‹è¯•ï¼ˆå¹¶å‘è´Ÿè½½æµ‹è¯•ï¼‰ã€‚
4. æ­»é”æ£€æµ‹ï¼ˆJConsoleã€VisualVMç›‘æ§ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šsynchronizedæ–¹æ³•è¿‡å¤§ï¼Œé”ç²’åº¦è¿‡ç²—
@Service
public class DataService {
    private final Map<String, Object> cache = new HashMap<>();
    
    public synchronized void processData(String key, Object data) {
        // 30+è¡Œä»£ç ï¼Œé”ç²’åº¦è¿‡å¤§ï¼Œå½±å“å¹¶å‘æ€§èƒ½
        validateData(data); // éªŒè¯é€»è¾‘ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        transformData(data); // è½¬æ¢é€»è¾‘ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        
        // åªæœ‰è¿™éƒ¨åˆ†éœ€è¦é”ä¿æŠ¤
        cache.put(key, data);
        
        notifyListeners(data); // é€šçŸ¥é€»è¾‘ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        logOperation(key, data); // æ—¥å¿—è®°å½•ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        sendMetrics(data); // æŒ‡æ ‡å‘é€ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        updateStatistics(); // ç»Ÿè®¡æ›´æ–°ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        // ... æ›´å¤šä¸éœ€è¦é”ä¿æŠ¤çš„æ“ä½œ
    }
}

// âŒ é”™è¯¯ï¼šå¯èƒ½å¯¼è‡´æ­»é”çš„é”é¡ºåº
public class AccountService {
    public void transfer(Account from, Account to, BigDecimal amount) {
        synchronized(from) {
            synchronized(to) { // é”é¡ºåºä¸ä¸€è‡´ï¼Œå¯èƒ½æ­»é”
                if (from.getBalance().compareTo(amount) >= 0) {
                    from.debit(amount);
                    to.credit(amount);
                }
            }
        }
    }
    
    public void reverseTransfer(Account to, Account from, BigDecimal amount) {
        synchronized(to) {
            synchronized(from) { // ä¸transferæ–¹æ³•é”é¡ºåºç›¸åï¼Œå¿…ç„¶æ­»é”
                if (from.getBalance().compareTo(amount) >= 0) {
                    from.debit(amount);
                    to.credit(amount);
                }
            }
        }
    }
}

// âŒ é”™è¯¯ï¼švolatileç”¨äºå¤åˆæ“ä½œ
public class CounterService {
    private volatile int counter = 0;
    
    public void increment() {
        counter++; // å¤åˆæ“ä½œï¼Œvolatileæ— æ³•ä¿è¯åŸå­æ€§
    }
    
    public void addValue(int value) {
        counter += value; // å¤åˆæ“ä½œï¼Œçº¿ç¨‹ä¸å®‰å…¨
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¹¶å‘é›†åˆå’Œç»†ç²’åº¦é”
@Service
public class DataService {
    private final ConcurrentHashMap<String, Object> cache = new ConcurrentHashMap<>();
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    private final Object statisticsLock = new Object();
    
    public void processData(String key, Object data) {
        // ä¸éœ€è¦é”ä¿æŠ¤çš„æ“ä½œ
        validateData(data);
        transformData(data);
        
        // åªåœ¨å¿…è¦æ—¶åŠ é”ï¼Œä½¿ç”¨å¹¶å‘é›†åˆ
        cache.put(key, data);
        
        // ä¸éœ€è¦é”ä¿æŠ¤çš„æ“ä½œ
        notifyListeners(data);
        logOperation(key, data);
        sendMetrics(data);
        
        // ç»Ÿè®¡æ›´æ–°ä½¿ç”¨å•ç‹¬çš„é”
        synchronized(statisticsLock) {
            updateStatistics();
        }
    }
    
    public Object getData(String key) {
        return cache.get(key); // ConcurrentHashMapçº¿ç¨‹å®‰å…¨
    }
    
    public void batchUpdate(Map<String, Object> updates) {
        // æ‰¹é‡æ“ä½œä½¿ç”¨å†™é”
        lock.writeLock().lock();
        try {
            updates.forEach(cache::put);
        } finally {
            lock.writeLock().unlock();
        }
    }
    
    public Set<String> getAllKeys() {
        // è¯»æ“ä½œä½¿ç”¨è¯»é”
        lock.readLock().lock();
        try {
            return new HashSet<>(cache.keySet());
        } finally {
            lock.readLock().unlock();
        }
    }
}

// âœ… æ­£ç¡®ï¼šé¿å…æ­»é”çš„é”æ’åº
public class AccountService {
    
    public void transfer(Account from, Account to, BigDecimal amount) {
        // ä½¿ç”¨è´¦æˆ·IDæ’åºæ¥é¿å…æ­»é”
        Account firstLock = from.getId() < to.getId() ? from : to;
        Account secondLock = from.getId() < to.getId() ? to : from;
        
        synchronized(firstLock) {
            synchronized(secondLock) {
                validateTransfer(from, to, amount);
                from.debit(amount);
                to.credit(amount);
                logTransfer(from, to, amount);
            }
        }
    }
    
    // æˆ–è€…ä½¿ç”¨æ›´é«˜çº§çš„å¹¶å‘å·¥å…·
    private final StripedLock stripedLock = new StripedLock(16);
    
    public void transferWithStripedLock(Account from, Account to, BigDecimal amount) {
        // ä½¿ç”¨åˆ†æ®µé”å‡å°‘é”ç«äº‰
        Lock lock1 = stripedLock.get(from.getId());
        Lock lock2 = stripedLock.get(to.getId());
        
        if (from.getId() < to.getId()) {
            lock1.lock();
            try {
                lock2.lock();
                try {
                    performTransfer(from, to, amount);
                } finally {
                    lock2.unlock();
                }
            } finally {
                lock1.unlock();
            }
        } else {
            lock2.lock();
            try {
                lock1.lock();
                try {
                    performTransfer(from, to, amount);
                } finally {
                    lock1.unlock();
                }
            } finally {
                lock2.unlock();
            }
        }
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸå­ç±»å’Œé€‚å½“çš„volatile
public class CounterService {
    private final AtomicInteger counter = new AtomicInteger(0);
    private volatile boolean enabled = true; // ç®€å•çŠ¶æ€æ ‡è®°ï¼Œé€‚åˆä½¿ç”¨volatile
    
    public void increment() {
        if (enabled) {
            counter.incrementAndGet(); // åŸå­æ“ä½œ
        }
    }
    
    public void addValue(int value) {
        if (enabled) {
            counter.addAndGet(value); // åŸå­æ“ä½œ
        }
    }
    
    public int getValue() {
        return counter.get();
    }
    
    public void setEnabled(boolean enabled) {
        this.enabled = enabled; // ç®€å•èµ‹å€¼ï¼Œvolatileä¿è¯å¯è§æ€§
    }
    
    public boolean isEnabled() {
        return enabled;
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨CompletableFutureå¤„ç†å¤æ‚å¹¶å‘åœºæ™¯
@Service
public class OrderProcessingService {
    private final PaymentService paymentService;
    private final InventoryService inventoryService;
    private final ShippingService shippingService;
    
    public CompletableFuture<OrderResult> processOrder(Order order) {
        // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªç‹¬ç«‹çš„æ“ä½œ
        CompletableFuture<PaymentResult> paymentFuture = 
            CompletableFuture.supplyAsync(() -> paymentService.processPayment(order));
            
        CompletableFuture<InventoryResult> inventoryFuture = 
            CompletableFuture.supplyAsync(() -> inventoryService.reserveItems(order));
            
        // ç­‰å¾…å‰ä¸¤ä¸ªæ“ä½œå®Œæˆåæ‰§è¡Œå‘è´§
        return paymentFuture.thenCombine(inventoryFuture, (payment, inventory) -> {
            if (payment.isSuccess() && inventory.isSuccess()) {
                ShippingResult shipping = shippingService.arrangeShipping(order);
                return OrderResult.success(order, payment, inventory, shipping);
            } else {
                // å›æ»šæ“ä½œ
                rollbackOperations(order, payment, inventory);
                return OrderResult.failure(order, "æ”¯ä»˜æˆ–åº“å­˜é¢„ç•™å¤±è´¥");
            }
        }).exceptionally(throwable -> {
            log.error("è®¢å•å¤„ç†å¼‚å¸¸", throwable);
            return OrderResult.failure(order, "ç³»ç»Ÿå¼‚å¸¸: " + throwable.getMessage());
        });
    }
}
```