# 4.8 èµ„æºç®¡ç†æ£€æŸ¥

##### 4.8.1 å†…å­˜èµ„æºç®¡ç†æ£€æŸ¥

###### 4.8.1.1 å†…å­˜æ³„æ¼æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é¿å…æ— é™åˆ¶çš„ç¼“å­˜å’Œé›†åˆå¢é•¿
b. é˜²æ­¢é™æ€é›†åˆæŒæœ‰å¯¹è±¡å¼•ç”¨
c. åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’Œå›è°ƒ
d. é¿å…ThreadLocalä½¿ç”¨åä¸æ¸…ç†

**2. æ£€æµ‹æ–¹æ³•**

a. é™æ€åˆ†æï¼šä½¿ç”¨ SpotBugsã€FindBugs æ£€æµ‹å†…å­˜æ³„æ¼æ¨¡å¼
b. å†…å­˜åˆ†æï¼šä½¿ç”¨ JProfilerã€MAT åˆ†æå †å†…å­˜
c. å‹åŠ›æµ‹è¯•ï¼šé•¿æ—¶é—´è¿è¡ŒéªŒè¯å†…å­˜ç¨³å®šæ€§
d. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥é›†åˆä½¿ç”¨å’Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ— é™åˆ¶çš„ç¼“å­˜å¯¼è‡´å†…å­˜æ³„æ¼
public class UserCache {
    private static final Map<String, User> cache = new HashMap<>();
    
    public User getUser(String id) {
        if (!cache.containsKey(id)) {
            User user = userService.findById(id);
            cache.put(id, user); // æ— é™åˆ¶æ·»åŠ ï¼Œå¯èƒ½å¯¼è‡´OOM
        }
        return cache.get(id);
    }
}

// âŒ é”™è¯¯ï¼šé™æ€é›†åˆæŒæœ‰å¯¹è±¡å¼•ç”¨
public class EventManager {
    private static final List<EventListener> listeners = new ArrayList<>();
    
    public static void addListener(EventListener listener) {
        listeners.add(listener); // æ°¸è¿œä¸æ¸…ç†ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
    }
}

// âŒ é”™è¯¯ï¼šThreadLocalä½¿ç”¨åä¸æ¸…ç†
public class UserContext {
    private static final ThreadLocal<User> currentUser = new ThreadLocal<>();
    
    public static void setCurrentUser(User user) {
        currentUser.set(user); // ä½¿ç”¨åä¸æ¸…ç†
    }
    
    public static User getCurrentUser() {
        return currentUser.get();
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æœ‰é™åˆ¶çš„ç¼“å­˜
@Component
public class UserCache {
    private final Cache<String, User> cache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(30, TimeUnit.MINUTES)
        .removalListener((key, value, cause) -> {
            log.debug("Cache entry removed: key={}, cause={}", key, cause);
        })
        .build();
    
    public User getUser(String id) {
        return cache.get(id, key -> userService.findById(key));
    }
    
    @PreDestroy
    public void cleanup() {
        cache.invalidateAll();
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼
public class EventManager {
    private final Set<WeakReference<EventListener>> listeners = 
        Collections.synchronizedSet(new HashSet<>());
    
    public void addListener(EventListener listener) {
        listeners.add(new WeakReference<>(listener));
        cleanupStaleReferences();
    }
    
    public void removeListener(EventListener listener) {
        listeners.removeIf(ref -> ref.get() == listener || ref.get() == null);
    }
    
    private void cleanupStaleReferences() {
        listeners.removeIf(ref -> ref.get() == null);
    }
}

// âœ… æ­£ç¡®ï¼šThreadLocalæ­£ç¡®ä½¿ç”¨å’Œæ¸…ç†
public class UserContext {
    private static final ThreadLocal<User> currentUser = new ThreadLocal<>();
    
    public static void setCurrentUser(User user) {
        currentUser.set(user);
    }
    
    public static User getCurrentUser() {
        return currentUser.get();
    }
    
    public static void clear() {
        currentUser.remove(); // ä½¿ç”¨åå¿…é¡»æ¸…ç†
    }
}

// åœ¨Filteræˆ–Interceptorä¸­ç¡®ä¿æ¸…ç†
@Component
public class UserContextFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        try {
            chain.doFilter(request, response);
        } finally {
            UserContext.clear(); // ç¡®ä¿æ¸…ç†
        }
    }
}
```

###### 4.8.1.2 å¯¹è±¡åˆ›å»ºä¼˜åŒ–æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é¿å…åœ¨å¾ªç¯ä¸­åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡
b. åˆç†ä½¿ç”¨å¯¹è±¡æ± å’Œå¤ç”¨æœºåˆ¶
c. é¿å…ä¸å¿…è¦çš„è£…ç®±æ‹†ç®±æ“ä½œ
d. ä¼˜åŒ–å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ

**2. æ£€æµ‹æ–¹æ³•**

a. æ€§èƒ½åˆ†æï¼šä½¿ç”¨ JProfiler åˆ†æå¯¹è±¡åˆ›å»ºçƒ­ç‚¹
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¾ªç¯å’Œé¢‘ç¹è°ƒç”¨çš„æ–¹æ³•
c. é™æ€åˆ†æï¼šæ£€æµ‹å­—ç¬¦ä¸²æ‹¼æ¥å’Œè£…ç®±æ“ä½œ
d. åŸºå‡†æµ‹è¯•ï¼šå¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå¾ªç¯ä¸­åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡
public class DataProcessor {
    public List<String> processData(List<Integer> numbers) {
        List<String> result = new ArrayList<>();
        for (Integer num : numbers) {
            // æ¯æ¬¡å¾ªç¯éƒ½åˆ›å»ºæ–°çš„StringBuilder
            StringBuilder sb = new StringBuilder();
            sb.append("Number: ").append(num);
            result.add(sb.toString());
        }
        return result;
    }
    
    // âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½å·®
    public String buildMessage(List<String> items) {
        String message = "";
        for (String item : items) {
            message += item + ", "; // æ¯æ¬¡éƒ½åˆ›å»ºæ–°å­—ç¬¦ä¸²
        }
        return message;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå¤ç”¨å¯¹è±¡ï¼Œå‡å°‘åˆ›å»ºå¼€é”€
public class DataProcessor {
    private static final ThreadLocal<StringBuilder> STRING_BUILDER = 
        ThreadLocal.withInitial(() -> new StringBuilder(256));
    
    public List<String> processData(List<Integer> numbers) {
        List<String> result = new ArrayList<>(numbers.size());
        StringBuilder sb = STRING_BUILDER.get();
        
        for (Integer num : numbers) {
            sb.setLength(0); // é‡ç½®è€Œä¸æ˜¯åˆ›å»ºæ–°å¯¹è±¡
            sb.append("Number: ").append(num);
            result.add(sb.toString());
        }
        return result;
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨StringBuilderè¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥
    public String buildMessage(List<String> items) {
        StringBuilder sb = new StringBuilder(items.size() * 20);
        for (int i = 0; i < items.size(); i++) {
            if (i > 0) sb.append(", ");
            sb.append(items.get(i));
        }
        return sb.toString();
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨å¯¹è±¡æ± å¤ç”¨æ˜‚è´µå¯¹è±¡
    @Component
    public class ConnectionPoolManager {
        private final ObjectPool<ExpensiveObject> objectPool;
        
        public ConnectionPoolManager() {
            this.objectPool = new GenericObjectPool<>(
                new ExpensiveObjectFactory(), 
                new GenericObjectPoolConfig<>());
        }
        
        public void processWithPooledObject() {
            ExpensiveObject obj = null;
            try {
                obj = objectPool.borrowObject();
                obj.doWork();
            } catch (Exception e) {
                log.error("Error processing with pooled object", e);
            } finally {
                if (obj != null) {
                    try {
                        objectPool.returnObject(obj);
                    } catch (Exception e) {
                        log.error("Error returning object to pool", e);
                    }
                }
            }
        }
    }
}
```

###### 4.8.1.3 å¤§å¯¹è±¡å¤„ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜
b. åˆç†ä½¿ç”¨æµå¼å¤„ç†å’Œåˆ†é¡µæœºåˆ¶
c. åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡å¼•ç”¨
d. é¿å…å¤§å¯¹è±¡åœ¨å †ä¸­é•¿æ—¶é—´é©»ç•™

**2. æ£€æµ‹æ–¹æ³•**

a. å†…å­˜ç›‘æ§ï¼šç›‘æ§å †å†…å­˜ä½¿ç”¨å’ŒGCé¢‘ç‡
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¤§æ•°æ®é›†å¤„ç†é€»è¾‘
c. æ€§èƒ½æµ‹è¯•ï¼šæ¨¡æ‹Ÿå¤§æ•°æ®é‡åœºæ™¯
d. é™æ€åˆ†æï¼šæ£€æµ‹å¯èƒ½çš„å¤§å¯¹è±¡åˆ›å»º

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
@Service
public class DataExportService {
    public void exportAllUsers() {
        List<User> allUsers = userRepository.findAll(); // å¯èƒ½æœ‰ç™¾ä¸‡æ¡è®°å½•
        for (User user : allUsers) {
            processUser(user);
        }
    }
    
    // âŒ é”™è¯¯ï¼šåˆ›å»ºå¤§æ•°ç»„å ç”¨å†…å­˜
    public byte[] processLargeFile(String filePath) {
        File file = new File(filePath);
        byte[] data = new byte[(int) file.length()]; // å¯èƒ½å‡ GBå¤§å°
        // å¤„ç†é€»è¾‘...
        return data;
    }
    
    // âŒ é”™è¯¯ï¼šå¤§å¯¹è±¡é•¿æ—¶é—´æŒæœ‰å¼•ç”¨
    public class ReportGenerator {
        private List<BigData> cachedData; // å¤§å¯¹è±¡ç¼“å­˜
        
        public void generateReport() {
            cachedData = loadBigData(); // åŠ è½½å¤§é‡æ•°æ®
            // å¤„ç†å®Œåæ²¡æœ‰æ¸…ç†å¼•ç”¨
            processData(cachedData);
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨åˆ†é¡µå’Œæµå¼å¤„ç†
@Service
public class DataExportService {
    private static final int BATCH_SIZE = 1000;
    
    public void exportAllUsers() {
        int page = 0;
        Page<User> userPage;
        
        do {
            Pageable pageable = PageRequest.of(page, BATCH_SIZE);
            userPage = userRepository.findAll(pageable);
            
            userPage.getContent().forEach(this::processUser);
            
            // åŠæ—¶æ¸…ç†å¼•ç”¨ï¼Œå¸®åŠ©GC
            userPage = null;
            page++;
            
            // é€‚å½“çš„å†…å­˜å‹åŠ›æ£€æŸ¥
            if (page % 10 == 0) {
                System.gc(); // å»ºè®®GCï¼ˆå¯é€‰ï¼‰
            }
        } while (userPage != null && userPage.hasNext());
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨æµå¼å¤„ç†å¤§æ–‡ä»¶
    public void processLargeFile(String filePath) {
        try (BufferedInputStream bis = new BufferedInputStream(
                new FileInputStream(filePath), 8192)) {
            
            byte[] buffer = new byte[8192];
            int bytesRead;
            
            while ((bytesRead = bis.read(buffer)) != -1) {
                processChunk(buffer, bytesRead);
                // bufferä¼šè¢«é‡ç”¨ï¼Œä¸ä¼šåˆ›å»ºå¤§é‡å¯¹è±¡
            }
        } catch (IOException e) {
            log.error("Error processing large file: {}", filePath, e);
        }
    }
    
    // âœ… æ­£ç¡®ï¼šåŠæ—¶æ¸…ç†å¤§å¯¹è±¡å¼•ç”¨
    @Component
    public class ReportGenerator {
        
        public void generateReport() {
            List<BigData> data = null;
            try {
                data = loadBigData();
                processData(data);
            } finally {
                // åŠæ—¶æ¸…ç†å¤§å¯¹è±¡å¼•ç”¨
                if (data != null) {
                    data.clear();
                    data = null;
                }
                // å»ºè®®è¿›è¡Œåƒåœ¾å›æ”¶
                Runtime.getRuntime().gc();
            }
        }
        
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨WeakReferenceæŒæœ‰å¤§å¯¹è±¡
        private WeakReference<List<BigData>> cachedDataRef;
        
        public List<BigData> getCachedData() {
            List<BigData> data = cachedDataRef != null ? cachedDataRef.get() : null;
            if (data == null) {
                data = loadBigData();
                cachedDataRef = new WeakReference<>(data);
            }
            return data;
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨NIOå¤„ç†å¤§æ–‡ä»¶
    public void processLargeFileWithNIO(String filePath) {
        try (RandomAccessFile file = new RandomAccessFile(filePath, "r");
             FileChannel channel = file.getChannel()) {
            
            long fileSize = channel.size();
            long position = 0;
            int bufferSize = 1024 * 1024; // 1MB buffer
            
            while (position < fileSize) {
                MappedByteBuffer buffer = channel.map(
                    FileChannel.MapMode.READ_ONLY, 
                    position, 
                    Math.min(bufferSize, fileSize - position));
                
                processBuffer(buffer);
                position += buffer.capacity();
                
                // æ˜¾å¼æ¸…ç†MappedByteBuffer
                if (buffer instanceof DirectBuffer) {
                    ((DirectBuffer) buffer).cleaner().clean();
                }
            }
        } catch (IOException e) {
            log.error("Error processing large file with NIO: {}", filePath, e);
        }
    }
    
    private void processChunk(byte[] buffer, int length) {
        // å¤„ç†æ•°æ®å—
    }
    
    private void processBuffer(ByteBuffer buffer) {
        // å¤„ç†ç¼“å†²åŒºæ•°æ®
    }
    
    private void processUser(User user) {
        // å¤„ç†ç”¨æˆ·æ•°æ®
    }
    
    private List<BigData> loadBigData() {
        // åŠ è½½å¤§æ•°æ®
        return new ArrayList<>(); 
    }
    
    private void processData(List<BigData> data) {
        // å¤„ç†æ•°æ®
    }
}
```

###### 4.8.1.3 å¤§å¯¹è±¡å¤„ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡å¼•ç”¨
b. é¿å…é•¿æ—¶é—´æŒæœ‰å¤§å¯¹è±¡
c. åˆç†å¤„ç†å¤§æ–‡ä»¶å’Œå¤§æ•°æ®é›†
d. å®ç°æµå¼å¤„ç†é¿å…å†…å­˜æº¢å‡º

**2. æ£€æµ‹æ–¹æ³•**

a. å†…å­˜ç›‘æ§ï¼šç›‘æ§å¤§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¤§å¯¹è±¡çš„ä½¿ç”¨æ¨¡å¼
c. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯å¤§æ•°æ®å¤„ç†çš„ç¨³å®šæ€§
d. æ€§èƒ½åˆ†æï¼šåˆ†æå†…å­˜ä½¿ç”¨å³°å€¼

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä¸€æ¬¡æ€§åŠ è½½å¤§æ–‡ä»¶åˆ°å†…å­˜
public class FileProcessor {
    public void processLargeFile(String filePath) {
        try {
            // ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶ï¼Œå¯èƒ½å¯¼è‡´OOM
            List<String> lines = Files.readAllLines(Paths.get(filePath));
            for (String line : lines) {
                processLine(line);
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
    
    // âŒ é”™è¯¯ï¼šé•¿æ—¶é—´æŒæœ‰å¤§å¯¹è±¡å¼•ç”¨
    private List<byte[]> largeDataCache = new ArrayList<>();
    
    public void processData(byte[] data) {
        largeDataCache.add(data); // æŒç»­ç´¯ç§¯ï¼Œä¸é‡Šæ”¾
        // å¤„ç†é€»è¾‘
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæµå¼å¤„ç†å¤§æ–‡ä»¶
public class FileProcessor {
    
    public void processLargeFile(String filePath) {
        try (Stream<String> lines = Files.lines(Paths.get(filePath))) {
            lines.forEach(this::processLine); // é€è¡Œå¤„ç†ï¼Œä¸å ç”¨å¤§é‡å†…å­˜
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
    
    // âœ… æ­£ç¡®ï¼šæ‰¹é‡å¤„ç†å¤§æ•°æ®é›†
    public void processBatchData(List<DataRecord> records) {
        final int batchSize = 1000;
        
        for (int i = 0; i < records.size(); i += batchSize) {
            int endIndex = Math.min(i + batchSize, records.size());
            List<DataRecord> batch = records.subList(i, endIndex);
            
            processBatch(batch);
            
            // å¤„ç†å®Œæ‰¹æ¬¡åï¼Œå»ºè®®è¿›è¡Œåƒåœ¾å›æ”¶
            if (i % (batchSize * 10) == 0) {
                System.gc(); // ä»…åœ¨å¿…è¦æ—¶å»ºè®®GC
            }
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—å¤„ç†å¤§æ•°æ®æµ
    @Service
    public class DataStreamProcessor {
        private final BlockingQueue<DataRecord> queue = 
            new ArrayBlockingQueue<>(1000); // æœ‰ç•Œé˜Ÿåˆ—
        
        @Async
        public void processDataStream(Stream<DataRecord> dataStream) {
            dataStream.forEach(record -> {
                try {
                    queue.put(record); // èƒŒå‹æ§åˆ¶
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    throw new RuntimeException(e);
                }
            });
        }
        
        @EventListener
        public void processQueuedData() {
            while (!Thread.currentThread().isInterrupted()) {
                try {
                    DataRecord record = queue.take();
                    processRecord(record);
                    record = null; // æ˜¾å¼é‡Šæ”¾å¼•ç”¨
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
    }
}
```

##### 4.8.2 æ–‡ä»¶èµ„æºç®¡ç†æ£€æŸ¥

###### 4.8.2.1 æ–‡ä»¶æµå…³é—­æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ä½¿ç”¨ try-with-resources å¤„ç†æ–‡ä»¶èµ„æº
b. ç¡®ä¿æ–‡ä»¶æµã€Readerã€Writer æ­£ç¡®å…³é—­
c. é¿å…æ–‡ä»¶å¥æŸ„æ³„æ¼
d. æ­£ç¡®å¤„ç†æ–‡ä»¶æ“ä½œå¼‚å¸¸

**2. æ£€æµ‹æ–¹æ³•**

a. é™æ€åˆ†æï¼šä½¿ç”¨ SpotBugs æ£€æµ‹èµ„æºæ³„æ¼
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶ I/O æ“ä½œ
c. è¿è¡Œæ—¶ç›‘æ§ï¼šç›‘æ§æ–‡ä»¶å¥æŸ„æ•°é‡
d. å•å…ƒæµ‹è¯•ï¼šéªŒè¯èµ„æºæ­£ç¡®é‡Šæ”¾

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨ç®¡ç†æ–‡ä»¶èµ„æºï¼Œå®¹æ˜“æ³„æ¼
public class FileProcessor {
    public String readFile(String path) {
        FileInputStream fis = null;
        BufferedReader reader = null;
        try {
            fis = new FileInputStream(path);
            reader = new BufferedReader(new InputStreamReader(fis));
            return reader.readLine();
        } catch (IOException e) {
            throw new RuntimeException(e);
        } finally {
            // âŒ å¤æ‚çš„æ‰‹åŠ¨å…³é—­é€»è¾‘ï¼Œå®¹æ˜“å‡ºé”™
            if (reader != null) {
                try {
                    reader.close();
                } catch (IOException e) {
                    // å¿½ç•¥å¼‚å¸¸
                }
            }
        }
    }
    
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰å…³é—­æ–‡ä»¶æµ
    public void copyFile(String source, String target) {
        try {
            FileInputStream input = new FileInputStream(source);
            FileOutputStream output = new FileOutputStream(target);
            
            byte[] buffer = new byte[1024];
            int length;
            while ((length = input.read(buffer)) > 0) {
                output.write(buffer, 0, length);
            }
            // âŒ æ²¡æœ‰å…³é—­æµï¼Œå¯¼è‡´èµ„æºæ³„æ¼
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ try-with-resources è‡ªåŠ¨ç®¡ç†èµ„æº
public class FileProcessor {
    public String readFile(String path) throws IOException {
        try (BufferedReader reader = Files.newBufferedReader(Paths.get(path))) {
            return reader.readLine();
        }
    }
    
    public void writeFile(String path, String content) throws IOException {
        try (BufferedWriter writer = Files.newBufferedWriter(Paths.get(path))) {
            writer.write(content);
        }
    }
    
    // âœ… æ­£ç¡®ï¼šå¤šä¸ªèµ„æºçš„æ­£ç¡®ç®¡ç†
    public void copyFile(String source, String target) throws IOException {
        try (FileInputStream input = new FileInputStream(source);
             FileOutputStream output = new FileOutputStream(target)) {
            
            byte[] buffer = new byte[1024];
            int length;
            while ((length = input.read(buffer)) > 0) {
                output.write(buffer, 0, length);
            }
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ Files å·¥å…·ç±»ç®€åŒ–æ“ä½œ
    public List<String> readAllLines(String path) throws IOException {
        return Files.readAllLines(Paths.get(path), StandardCharsets.UTF_8);
    }
    
    public void writeAllLines(String path, List<String> lines) throws IOException {
        Files.write(Paths.get(path), lines, StandardCharsets.UTF_8);
    }
}
```

###### 4.8.2.2 æ–‡ä»¶é”ç®¡ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ­£ç¡®ä½¿ç”¨æ–‡ä»¶é”é¿å…å¹¶å‘å†²çª
b. åŠæ—¶é‡Šæ”¾æ–‡ä»¶é”èµ„æº
c. å¤„ç†æ–‡ä»¶é”è·å–å¤±è´¥çš„æƒ…å†µ
d. é¿å…æ­»é”å’Œé”ç«äº‰

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ–‡ä»¶é”çš„ä½¿ç”¨æ¨¡å¼
b. å¹¶å‘æµ‹è¯•ï¼šéªŒè¯å¤šçº¿ç¨‹æ–‡ä»¶è®¿é—®
c. é™æ€åˆ†æï¼šæ£€æµ‹é”èµ„æºæ³„æ¼
d. æ€§èƒ½æµ‹è¯•ï¼šè¯„ä¼°é”ç«äº‰å½±å“

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ–‡ä»¶é”ä½¿ç”¨ä¸å½“
public class FileLocker {
    public void writeWithLock(String path, String content) {
        try {
            RandomAccessFile file = new RandomAccessFile(path, "rw");
            FileChannel channel = file.getChannel();
            FileLock lock = channel.lock(); // å¯èƒ½é˜»å¡å¾ˆä¹…
            
            // å†™å…¥æ•°æ®
            file.writeUTF(content);
            
            // âŒ æ²¡æœ‰é‡Šæ”¾é”å’Œæ–‡ä»¶èµ„æº
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
    
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰å¤„ç†é”è·å–å¤±è´¥
    public void processFile(String path) {
        try (RandomAccessFile file = new RandomAccessFile(path, "rw");
             FileChannel channel = file.getChannel()) {
            
            FileLock lock = channel.tryLock(); // å¯èƒ½è¿”å›null
            // âŒ æ²¡æœ‰æ£€æŸ¥lockæ˜¯å¦ä¸ºnull
            processFileContent(file);
            lock.release();
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ­£ç¡®ä½¿ç”¨æ–‡ä»¶é”
public class FileLocker {
    
    public void writeWithLock(String path, String content) throws IOException {
        try (RandomAccessFile file = new RandomAccessFile(path, "rw");
             FileChannel channel = file.getChannel()) {
            
            // ä½¿ç”¨try-with-resourcesç®¡ç†é”èµ„æº
            try (FileLock lock = channel.lock()) {
                file.writeUTF(content);
                file.getFD().sync(); // å¼ºåˆ¶åŒæ­¥åˆ°ç£ç›˜
            }
        }
    }
    
    // âœ… æ­£ç¡®ï¼šå¤„ç†é”è·å–å¤±è´¥
    public boolean processFileWithTimeout(String path, long timeoutMs) {
        try (RandomAccessFile file = new RandomAccessFile(path, "rw");
             FileChannel channel = file.getChannel()) {
            
            FileLock lock = null;
            long startTime = System.currentTimeMillis();
            
            // é‡è¯•è·å–é”ï¼Œç›´åˆ°è¶…æ—¶
            while (lock == null && 
                   (System.currentTimeMillis() - startTime) < timeoutMs) {
                try {
                    lock = channel.tryLock();
                    if (lock == null) {
                        Thread.sleep(100); // çŸ­æš‚ç­‰å¾…åé‡è¯•
                    }
                } catch (OverlappingFileLockException e) {
                    Thread.sleep(100);
                }
            }
            
            if (lock != null) {
                try {
                    processFileContent(file);
                    return true;
                } finally {
                    lock.release();
                }
            }
            return false; // è·å–é”å¤±è´¥
            
        } catch (IOException | InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException(e);
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨å…±äº«é”è¿›è¡Œè¯»æ“ä½œ
    public String readWithSharedLock(String path) throws IOException {
        try (RandomAccessFile file = new RandomAccessFile(path, "r");
             FileChannel channel = file.getChannel();
             FileLock lock = channel.lock(0, Long.MAX_VALUE, true)) { // å…±äº«é”
            
            return file.readUTF();
        }
    }
    
    private void processFileContent(RandomAccessFile file) throws IOException {
        // å¤„ç†æ–‡ä»¶å†…å®¹
    }
}
```

###### 4.8.2.3 ä¸´æ—¶æ–‡ä»¶æ¸…ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. åŠæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•
b. ä½¿ç”¨ deleteOnExit æˆ–æ˜¾å¼åˆ é™¤
c. é¿å…ä¸´æ—¶æ–‡ä»¶ç´¯ç§¯å ç”¨ç£ç›˜ç©ºé—´
d. å¤„ç†ä¸´æ—¶æ–‡ä»¶åˆ é™¤å¤±è´¥çš„æƒ…å†µ

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥ä¸´æ—¶æ–‡ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
b. ç£ç›˜ç›‘æ§ï¼šç›‘æ§ä¸´æ—¶ç›®å½•ç©ºé—´ä½¿ç”¨
c. å•å…ƒæµ‹è¯•ï¼šéªŒè¯ä¸´æ—¶æ–‡ä»¶æ­£ç¡®æ¸…ç†
d. é›†æˆæµ‹è¯•ï¼šé•¿æ—¶é—´è¿è¡ŒéªŒè¯æ¸…ç†æ•ˆæœ

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä¸´æ—¶æ–‡ä»¶æ²¡æœ‰æ¸…ç†
public class TempFileProcessor {
    public void processData(byte[] data) {
        try {
            // åˆ›å»ºä¸´æ—¶æ–‡ä»¶ä½†ä¸æ¸…ç†
            File tempFile = File.createTempFile("data", ".tmp");
            Files.write(tempFile.toPath(), data);
            
            // å¤„ç†æ–‡ä»¶
            processFile(tempFile);
            
            // âŒ æ²¡æœ‰åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
    
    // âŒ é”™è¯¯ï¼šä¸´æ—¶ç›®å½•æ²¡æœ‰æ¸…ç†
    public void createWorkspace() {
        try {
            Path tempDir = Files.createTempDirectory("workspace");
            // åœ¨ä¸´æ—¶ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶
            Files.createFile(tempDir.resolve("work.txt"));
            
            // âŒ å¤„ç†å®Œåæ²¡æœ‰æ¸…ç†æ•´ä¸ªç›®å½•
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ­£ç¡®ç®¡ç†ä¸´æ—¶æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸ
public class TempFileProcessor {
    
    public void processData(byte[] data) throws IOException {
        Path tempFile = null;
        try {
            tempFile = Files.createTempFile("data", ".tmp");
            Files.write(tempFile, data);
            
            processFile(tempFile.toFile());
            
        } finally {
            // ç¡®ä¿ä¸´æ—¶æ–‡ä»¶è¢«åˆ é™¤
            if (tempFile != null) {
                try {
                    Files.deleteIfExists(tempFile);
                } catch (IOException e) {
                    log.warn("Failed to delete temp file: {}", tempFile, e);
                }
            }
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ deleteOnExit ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
    public File createTempFileWithBackup(String prefix, String suffix) throws IOException {
        File tempFile = File.createTempFile(prefix, suffix);
        tempFile.deleteOnExit(); // JVMé€€å‡ºæ—¶åˆ é™¤
        return tempFile;
    }
    
    // âœ… æ­£ç¡®ï¼šé€’å½’æ¸…ç†ä¸´æ—¶ç›®å½•
    public void createAndCleanWorkspace() throws IOException {
        Path tempDir = null;
        try {
            tempDir = Files.createTempDirectory("workspace");
            
            // åœ¨ä¸´æ—¶ç›®å½•ä¸­å·¥ä½œ
            Path workFile = tempDir.resolve("work.txt");
            Files.createFile(workFile);
            Files.write(workFile, "test data".getBytes());
            
            // å¤„ç†å·¥ä½œæ–‡ä»¶
            processWorkFile(workFile);
            
        } finally {
            // é€’å½’åˆ é™¤æ•´ä¸ªä¸´æ—¶ç›®å½•
            if (tempDir != null) {
                deleteDirectoryRecursively(tempDir);
            }
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ try-with-resources ç®¡ç†ä¸´æ—¶èµ„æº
    public void processWithAutoCleanup(byte[] data) throws IOException {
        try (TempFileResource tempResource = new TempFileResource("data", ".tmp")) {
            Files.write(tempResource.getPath(), data);
            processFile(tempResource.getPath().toFile());
            // èµ„æºä¼šè‡ªåŠ¨æ¸…ç†
        }
    }
    
    private void deleteDirectoryRecursively(Path directory) {
        try {
            Files.walk(directory)
                .sorted(Comparator.reverseOrder())
                .map(Path::toFile)
                .forEach(file -> {
                    if (!file.delete()) {
                        log.warn("Failed to delete: {}", file.getAbsolutePath());
                    }
                });
        } catch (IOException e) {
            log.error("Error deleting directory: {}", directory, e);
        }
    }
    
    private void processFile(File file) {
        // å¤„ç†æ–‡ä»¶
    }
    
    private void processWorkFile(Path file) {
        // å¤„ç†å·¥ä½œæ–‡ä»¶
    }
    
    // è‡ªå®šä¹‰èµ„æºç®¡ç†ç±»
    private static class TempFileResource implements AutoCloseable {
        private final Path tempFile;
        
        public TempFileResource(String prefix, String suffix) throws IOException {
            this.tempFile = Files.createTempFile(prefix, suffix);
        }
        
        public Path getPath() {
            return tempFile;
        }
        
        @Override
        public void close() {
            try {
                Files.deleteIfExists(tempFile);
            } catch (IOException e) {
                log.warn("Failed to delete temp file: {}", tempFile, e);
            }
        }
    }
    
    // å¤„ç†å¤šä¸ªèµ„æº
    public void copyFile(String source, String target) throws IOException {
        try (InputStream in = Files.newInputStream(Paths.get(source));
             OutputStream out = Files.newOutputStream(Paths.get(target))) {
            in.transferTo(out);
        }
    }
}
```

##### 4.8.3 ç½‘ç»œèµ„æºç®¡ç†æ£€æŸ¥

###### 4.8.3.1 è¿æ¥æ± é…ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ­£ç¡®é…ç½®HTTPè¿æ¥æ± å‚æ•°
b. è®¾ç½®åˆç†çš„æœ€å¤§è¿æ¥æ•°å’Œæ¯è·¯ç”±è¿æ¥æ•°
c. é…ç½®è¿æ¥æ± çš„ç©ºé—²è¿æ¥ç®¡ç†
d. é¿å…è¿æ¥æ± èµ„æºè€—å°½

**2. æ£€æµ‹æ–¹æ³•**

a. é…ç½®å®¡æŸ¥ï¼šæ£€æŸ¥è¿æ¥æ± é…ç½®å‚æ•°
b. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯è¿æ¥æ± åœ¨é«˜å¹¶å‘ä¸‹çš„è¡¨ç°
c. ç›‘æ§åˆ†æï¼šç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
d. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥è¿æ¥æ± çš„åˆ›å»ºå’Œä½¿ç”¨

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ¯æ¬¡åˆ›å»ºæ–°è¿æ¥ï¼Œæ²¡æœ‰è¿æ¥æ± 
@Service
public class ApiService {
    public String callApi(String url) {
        RestTemplate restTemplate = new RestTemplate(); // æ¯æ¬¡æ–°å»º
        return restTemplate.getForObject(url, String.class);
    }
    
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰é…ç½®è¿æ¥æ± å‚æ•°
    public String callExternalApi(String url) {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        // ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œæ²¡æœ‰è®¾ç½®è¿æ¥æ± 
        RestTemplate restTemplate = new RestTemplate(factory);
        return restTemplate.getForObject(url, String.class);
    }
}

// âŒ é”™è¯¯ï¼šè¿æ¥æ± é…ç½®ä¸åˆç†
@Configuration
public class BadHttpClientConfig {
    @Bean
    public RestTemplate restTemplate() {
        PoolingHttpClientConnectionManager connectionManager = 
            new PoolingHttpClientConnectionManager();
        connectionManager.setMaxTotal(1); // å¤ªå°
        connectionManager.setDefaultMaxPerRoute(1); // å¤ªå°
        // æ²¡æœ‰è®¾ç½®ç©ºé—²è¿æ¥æ¸…ç†
        
        CloseableHttpClient httpClient = HttpClients.custom()
            .setConnectionManager(connectionManager)
            .build();
        
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory(httpClient);
        return new RestTemplate(factory);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šåˆç†é…ç½®è¿æ¥æ± 
@Configuration
public class HttpClientConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        // é…ç½®è¿æ¥æ± 
        PoolingHttpClientConnectionManager connectionManager = 
            new PoolingHttpClientConnectionManager();
        connectionManager.setMaxTotal(200); // æ€»è¿æ¥æ•°
        connectionManager.setDefaultMaxPerRoute(50); // æ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•°
        connectionManager.setValidateAfterInactivity(2000); // éªŒè¯ç©ºé—²è¿æ¥
        
        // é…ç½®ç©ºé—²è¿æ¥æ¸…ç†
        connectionManager.closeExpiredConnections();
        connectionManager.closeIdleConnections(30, TimeUnit.SECONDS);
        
        CloseableHttpClient httpClient = HttpClients.custom()
            .setConnectionManager(connectionManager)
            .setDefaultRequestConfig(RequestConfig.custom()
                .setConnectTimeout(5000)
                .setSocketTimeout(30000)
                .setConnectionRequestTimeout(3000) // ä»è¿æ¥æ± è·å–è¿æ¥çš„è¶…æ—¶
                .build())
            .setRetryHandler(new DefaultHttpRequestRetryHandler(3, true))
            .build();
        
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory(httpClient);
        return new RestTemplate(factory);
    }
    
    // âœ… æ­£ç¡®ï¼šå®šæœŸæ¸…ç†ç©ºé—²è¿æ¥
    @Bean
    public IdleConnectionEvictor idleConnectionEvictor(
            PoolingHttpClientConnectionManager connectionManager) {
        return new IdleConnectionEvictor(connectionManager, 30, TimeUnit.SECONDS);
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨è¿æ¥æ± çš„æœåŠ¡
@Service
public class ApiService {
    private final RestTemplate restTemplate;
    
    public ApiService(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }
    
    public String callApi(String url) {
        return restTemplate.getForObject(url, String.class);
    }
    
    // âœ… æ­£ç¡®ï¼šæ‰¹é‡è°ƒç”¨æ—¶å¤ç”¨è¿æ¥
    public List<String> batchCallApi(List<String> urls) {
        return urls.parallelStream()
            .map(this::callApi)
            .collect(Collectors.toList());
    }
}
```

###### 4.8.3.2 è¶…æ—¶è®¾ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. è®¾ç½®åˆç†çš„è¿æ¥è¶…æ—¶æ—¶é—´
b. é…ç½®é€‚å½“çš„è¯»å–è¶…æ—¶æ—¶é—´
c. è®¾ç½®è¿æ¥è¯·æ±‚è¶…æ—¶æ—¶é—´
d. æ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´è¶…æ—¶å‚æ•°

**2. æ£€æµ‹æ–¹æ³•**

a. é…ç½®å®¡æŸ¥ï¼šæ£€æŸ¥å„ç§è¶…æ—¶é…ç½®
b. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯è¶…æ—¶è®¾ç½®çš„æœ‰æ•ˆæ€§
c. ç½‘ç»œæµ‹è¯•ï¼šæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿå’Œä¸­æ–­
d. æ—¥å¿—åˆ†æï¼šåˆ†æè¶…æ—¶å¼‚å¸¸çš„é¢‘ç‡å’ŒåŸå› 

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´
public class HttpClient {
    public String get(String url) throws IOException {
        URL urlObj = new URL(url);
        HttpURLConnection conn = (HttpURLConnection) urlObj.openConnection();
        // æ²¡æœ‰è®¾ç½®ä»»ä½•è¶…æ—¶ï¼Œå¯èƒ½æ— é™ç­‰å¾…
        try (InputStream in = conn.getInputStream()) {
            return new String(in.readAllBytes());
        }
    }
    
    // âŒ é”™è¯¯ï¼šè¶…æ—¶æ—¶é—´è®¾ç½®ä¸åˆç†
    public String getWithBadTimeout(String url) throws IOException {
        URL urlObj = new URL(url);
        HttpURLConnection conn = (HttpURLConnection) urlObj.openConnection();
        conn.setConnectTimeout(1); // å¤ªçŸ­ï¼Œå®¹æ˜“å¤±è´¥
        conn.setReadTimeout(300000); // 5åˆ†é’Ÿå¤ªé•¿
        
        try (InputStream in = conn.getInputStream()) {
            return new String(in.readAllBytes());
        }
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰å¤„ç†è¶…æ—¶å¼‚å¸¸
@Service
public class BadApiService {
    @Autowired
    private RestTemplate restTemplate;
    
    public String callApi(String url) {
        // æ²¡æœ‰æ•è·å’Œå¤„ç†è¶…æ—¶å¼‚å¸¸
        return restTemplate.getForObject(url, String.class);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šåˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
public class HttpClient {
    
    public String get(String url) throws IOException {
        URL urlObj = new URL(url);
        HttpURLConnection conn = (HttpURLConnection) urlObj.openConnection();
        
        // è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
        conn.setConnectTimeout(5000); // è¿æ¥è¶…æ—¶5ç§’
        conn.setReadTimeout(30000); // è¯»å–è¶…æ—¶30ç§’
        
        try (InputStream in = conn.getInputStream()) {
            return new String(in.readAllBytes());
        } finally {
            conn.disconnect(); // ç¡®ä¿è¿æ¥å…³é—­
        }
    }
    
    // âœ… æ­£ç¡®ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯è®¾ç½®ä¸åŒè¶…æ—¶
    public String getWithCustomTimeout(String url, int connectTimeout, int readTimeout) 
            throws IOException {
        URL urlObj = new URL(url);
        HttpURLConnection conn = (HttpURLConnection) urlObj.openConnection();
        
        conn.setConnectTimeout(connectTimeout);
        conn.setReadTimeout(readTimeout);
        
        try (InputStream in = conn.getInputStream()) {
            return new String(in.readAllBytes());
        } finally {
            conn.disconnect();
        }
    }
}

// âœ… æ­£ç¡®ï¼šå¤„ç†è¶…æ—¶å¼‚å¸¸
@Service
public class ApiService {
    private final RestTemplate restTemplate;
    
    public ApiService(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }
    
    public String callApi(String url) {
        try {
            return restTemplate.getForObject(url, String.class);
        } catch (ResourceAccessException e) {
            if (e.getCause() instanceof SocketTimeoutException) {
                log.warn("APIè°ƒç”¨è¶…æ—¶: {}", url);
                throw new ApiTimeoutException("APIè°ƒç”¨è¶…æ—¶", e);
            } else if (e.getCause() instanceof ConnectTimeoutException) {
                log.warn("è¿æ¥è¶…æ—¶: {}", url);
                throw new ApiConnectionException("è¿æ¥è¶…æ—¶", e);
            }
            throw e;
        }
    }
    
    // âœ… æ­£ç¡®ï¼šå¸¦é‡è¯•çš„è¶…æ—¶å¤„ç†
    @Retryable(
        value = {ApiTimeoutException.class, ApiConnectionException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public String callApiWithRetry(String url) {
        return callApi(url);
    }
}

// âœ… æ­£ç¡®ï¼šå¼‚æ­¥è°ƒç”¨çš„è¶…æ—¶å¤„ç†
@Service
public class AsyncApiService {
    
    @Async
    public CompletableFuture<String> callApiAsync(String url) {
        return CompletableFuture.supplyAsync(() -> {
            // å®ç°APIè°ƒç”¨é€»è¾‘
            return callApi(url);
        }).orTimeout(10, TimeUnit.SECONDS) // è®¾ç½®å¼‚æ­¥è¶…æ—¶
          .exceptionally(throwable -> {
              if (throwable instanceof TimeoutException) {
                  log.warn("å¼‚æ­¥APIè°ƒç”¨è¶…æ—¶: {}", url);
                  return "TIMEOUT";
              }
              throw new RuntimeException(throwable);
          });
    }
    
    private String callApi(String url) {
        // å…·ä½“çš„APIè°ƒç”¨å®ç°
        return "result";
    }
}
```

###### 4.8.3.3 è¿æ¥æ³„æ¼æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿ç½‘ç»œè¿æ¥æ­£ç¡®å…³é—­
b. é¿å…è¿æ¥æ± è¿æ¥æ³„æ¼
c. å¤„ç†å¼‚å¸¸æƒ…å†µä¸‹çš„è¿æ¥é‡Šæ”¾
d. ç›‘æ§è¿æ¥ä½¿ç”¨æƒ…å†µ

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
b. è¿è¡Œæ—¶ç›‘æ§ï¼šç›‘æ§æ´»è·ƒè¿æ¥æ•°
c. å‹åŠ›æµ‹è¯•ï¼šé•¿æ—¶é—´è¿è¡ŒéªŒè¯è¿æ¥æ³„æ¼
d. å·¥å…·æ£€æµ‹ï¼šä½¿ç”¨è¿æ¥æ± ç›‘æ§å·¥å…·

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨ç®¡ç†è¿æ¥ä½†æ²¡æœ‰æ­£ç¡®å…³é—­
public class LeakyHttpClient {
    
    public String getData(String url) {
        try {
            URL urlObj = new URL(url);
            HttpURLConnection conn = (HttpURLConnection) urlObj.openConnection();
            
            if (conn.getResponseCode() != 200) {
                return null; // âŒ æ²¡æœ‰å…³é—­è¿æ¥å°±è¿”å›
            }
            
            try (InputStream in = conn.getInputStream()) {
                return new String(in.readAllBytes());
            }
            // âŒ æ²¡æœ‰åœ¨finallyä¸­å…³é—­è¿æ¥
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
    
    // âŒ é”™è¯¯ï¼šä½¿ç”¨å®ŒRestTemplateåæ²¡æœ‰æ¸…ç†
    public void batchProcess(List<String> urls) {
        for (String url : urls) {
            RestTemplate restTemplate = new RestTemplate();
            try {
                String result = restTemplate.getForObject(url, String.class);
                processResult(result);
            } catch (Exception e) {
                // âŒ å¼‚å¸¸æ—¶æ²¡æœ‰æ¸…ç†èµ„æº
                log.error("å¤„ç†å¤±è´¥: {}", url, e);
            }
            // âŒ æ²¡æœ‰æ¸…ç†RestTemplateçš„è¿æ¥
        }
    }
    
    private void processResult(String result) {
        // å¤„ç†ç»“æœ
    }
}

// âŒ é”™è¯¯ï¼šæ•°æ®åº“è¿æ¥æ³„æ¼
@Repository
public class LeakyDataAccess {
    
    @Autowired
    private DataSource dataSource;
    
    public List<User> getUsers() {
        try {
            Connection conn = dataSource.getConnection();
            PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users");
            ResultSet rs = stmt.executeQuery();
            
            List<User> users = new ArrayList<>();
            while (rs.next()) {
                users.add(mapUser(rs));
            }
            return users;
            // âŒ æ²¡æœ‰å…³é—­Connectionã€PreparedStatementã€ResultSet
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }
    
    private User mapUser(ResultSet rs) throws SQLException {
        // æ˜ å°„ç”¨æˆ·å¯¹è±¡
        return new User();
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šç¡®ä¿è¿æ¥æ­£ç¡®å…³é—­
public class ProperHttpClient {
    
    public String getData(String url) throws IOException {
        URL urlObj = new URL(url);
        HttpURLConnection conn = null;
        
        try {
            conn = (HttpURLConnection) urlObj.openConnection();
            conn.setConnectTimeout(5000);
            conn.setReadTimeout(30000);
            
            if (conn.getResponseCode() != 200) {
                throw new IOException("HTTPé”™è¯¯: " + conn.getResponseCode());
            }
            
            try (InputStream in = conn.getInputStream()) {
                return new String(in.readAllBytes());
            }
        } finally {
            // ç¡®ä¿è¿æ¥è¢«å…³é—­
            if (conn != null) {
                conn.disconnect();
            }
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨try-with-resourcesç®¡ç†èµ„æº
    public String getDataWithAutoClose(String url) throws IOException {
        URL urlObj = new URL(url);
        HttpURLConnection conn = (HttpURLConnection) urlObj.openConnection();
        conn.setConnectTimeout(5000);
        conn.setReadTimeout(30000);
        
        try (AutoCloseableConnection autoConn = new AutoCloseableConnection(conn)) {
            if (conn.getResponseCode() != 200) {
                throw new IOException("HTTPé”™è¯¯: " + conn.getResponseCode());
            }
            
            try (InputStream in = conn.getInputStream()) {
                return new String(in.readAllBytes());
            }
        }
    }
    
    // è‡ªå®šä¹‰AutoCloseableåŒ…è£…å™¨
    private static class AutoCloseableConnection implements AutoCloseable {
        private final HttpURLConnection connection;
        
        public AutoCloseableConnection(HttpURLConnection connection) {
            this.connection = connection;
        }
        
        @Override
        public void close() {
            if (connection != null) {
                connection.disconnect();
            }
        }
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨è¿æ¥æ± å¹¶ç›‘æ§è¿æ¥
@Service
public class ManagedApiService {
    private final RestTemplate restTemplate;
    private final MeterRegistry meterRegistry;
    
    public ManagedApiService(RestTemplate restTemplate, MeterRegistry meterRegistry) {
        this.restTemplate = restTemplate;
        this.meterRegistry = meterRegistry;
    }
    
    public String callApi(String url) {
        Timer.Sample sample = Timer.start(meterRegistry);
        try {
            String result = restTemplate.getForObject(url, String.class);
            meterRegistry.counter("api.calls", "status", "success").increment();
            return result;
        } catch (Exception e) {
            meterRegistry.counter("api.calls", "status", "error").increment();
            throw e;
        } finally {
            sample.stop(Timer.builder("api.call.duration")
                .description("APIè°ƒç”¨è€—æ—¶")
                .register(meterRegistry));
        }
    }
    
    // âœ… æ­£ç¡®ï¼šæ‰¹é‡å¤„ç†æ—¶å¤ç”¨è¿æ¥
    public List<String> batchCallApi(List<String> urls) {
        return urls.stream()
            .map(url -> {
                try {
                    return callApi(url);
                } catch (Exception e) {
                    log.warn("APIè°ƒç”¨å¤±è´¥: {}", url, e);
                    return null;
                }
            })
            .filter(Objects::nonNull)
            .collect(Collectors.toList());
    }
}

// âœ… æ­£ç¡®ï¼šæ•°æ®åº“è¿æ¥æ­£ç¡®ç®¡ç†
@Repository
public class ProperDataAccess {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    // ä½¿ç”¨JdbcTemplateè‡ªåŠ¨ç®¡ç†è¿æ¥
    public List<User> getUsers() {
        return jdbcTemplate.query(
            "SELECT * FROM users",
            (rs, rowNum) -> mapUser(rs)
        );
    }
    
    // å¦‚æœå¿…é¡»æ‰‹åŠ¨ç®¡ç†è¿æ¥ï¼Œä½¿ç”¨try-with-resources
    public List<User> getUsersWithManualConnection() {
        String sql = "SELECT * FROM users";
        
        try (Connection conn = jdbcTemplate.getDataSource().getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql);
             ResultSet rs = stmt.executeQuery()) {
            
            List<User> users = new ArrayList<>();
            while (rs.next()) {
                users.add(mapUser(rs));
            }
            return users;
        } catch (SQLException e) {
            throw new RuntimeException("æ•°æ®åº“æŸ¥è¯¢å¤±è´¥", e);
        }
    }
    
    private User mapUser(ResultSet rs) throws SQLException {
        User user = new User();
        user.setId(rs.getLong("id"));
        user.setName(rs.getString("name"));
        return user;
    }
}

// âœ… æ­£ç¡®ï¼šè¿æ¥æ± å¥åº·æ£€æŸ¥
@Component
public class ConnectionPoolHealthIndicator implements HealthIndicator {
    
    private final PoolingHttpClientConnectionManager connectionManager;
    
    public ConnectionPoolHealthIndicator(PoolingHttpClientConnectionManager connectionManager) {
        this.connectionManager = connectionManager;
    }
    
    @Override
    public Health health() {
        try {
            PoolStats totalStats = connectionManager.getTotalStats();
            
            Health.Builder builder = Health.up()
                .withDetail("maxTotal", totalStats.getMax())
                .withDetail("available", totalStats.getAvailable())
                .withDetail("leased", totalStats.getLeased())
                .withDetail("pending", totalStats.getPending());
            
            // æ£€æŸ¥è¿æ¥æ± æ˜¯å¦å¥åº·
            if (totalStats.getLeased() > totalStats.getMax() * 0.8) {
                builder.status(Status.DOWN)
                    .withDetail("reason", "è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜");
            }
            
            return builder.build();
        } catch (Exception e) {
            return Health.down(e).build();
        }
    }
}
```

**ç¬¬ä¸‰åäºŒæ¡** Redisè¿æ¥æ± æ£€æŸ¥ ğŸŸ¡ï¼š

##### 4.8.4 Redisèµ„æºç®¡ç†æ£€æŸ¥

#### 4.8.4.1 Redisè¿æ¥æ± é…ç½® ğŸŸ¡:

##### 4.8.4.1.1 Redisè¿æ¥æ± å‚æ•°é…ç½®

**1. æ£€æµ‹ç›®æ ‡**

a. æœ€å¤§è¿æ¥æ•°è®¾ç½®æ˜¯å¦åˆç†ï¼ˆæ ¹æ® Redis æœåŠ¡å™¨é…ç½®ï¼Œé€šå¸¸ 8-32ï¼‰
b. æœ€å¤§ç©ºé—²è¿æ¥è®¾ç½®æ˜¯å¦åˆç†ï¼ˆæœ€å¤§è¿æ¥æ•°çš„ 50%-80%ï¼‰
c. è¿æ¥è¶…æ—¶è®¾ç½®æ˜¯å¦åˆç†ï¼ˆ3-10 ç§’ï¼‰
d. è¿æ¥æ± é…ç½®æ˜¯å¦åŒ…å«é‡è¯•æœºåˆ¶
e. æ˜¯å¦æœ‰è¿æ¥æ± ç›‘æ§å’Œå¥åº·æ£€æŸ¥

**2. æ£€æµ‹æ–¹æ³•**

a. é…ç½®æ–‡ä»¶å®¡æŸ¥ï¼šæ£€æŸ¥ Redis è¿æ¥æ± ç›¸å…³é…ç½®
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥ Redis è¿æ¥æ± åˆ›å»ºå’Œä½¿ç”¨çš„ä»£ç 
c. è¿è¡Œæ—¶ç›‘æ§ï¼šç›‘æ§ Redis è¿æ¥æ•°å’Œä½¿ç”¨æƒ…å†µ
d. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯è¿æ¥æ± åœ¨é«˜è´Ÿè½½ä¸‹çš„è¡¨ç°

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šè¿æ¥æ± é…ç½®ä¸åˆç†
@Configuration
public class BadRedisConfig {
    @Bean
    public JedisConnectionFactory redisConnectionFactory() {
        JedisConnectionFactory factory = new JedisConnectionFactory();
        
        // è¿æ¥æ•°è®¾ç½®è¿‡å°ï¼Œå¯èƒ½å¯¼è‡´èµ„æºä¸è¶³
        JedisPoolConfig poolConfig = new JedisPoolConfig();
        poolConfig.setMaxTotal(3);  // å¤ªå°
        poolConfig.setMaxIdle(1);   // å¤ªå°
        poolConfig.setMinIdle(0);   // æ²¡æœ‰ä¿æŒæœ€å°è¿æ¥æ•°
        
        // è¶…æ—¶è®¾ç½®ä¸åˆç†
        poolConfig.setMaxWaitMillis(500); // ç­‰å¾…æ—¶é—´å¤ªçŸ­
        
        factory.setPoolConfig(poolConfig);
        return factory;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šè¿æ¥æ± å‚æ•°é…ç½®åˆç†
@Configuration
public class RedisConfig {
    @Bean
    public JedisConnectionFactory redisConnectionFactory() {
        JedisConnectionFactory factory = new JedisConnectionFactory();
        
        // åˆç†è®¾ç½®è¿æ¥æ± å‚æ•°
        JedisPoolConfig poolConfig = new JedisPoolConfig();
        poolConfig.setMaxTotal(16);  // åˆç†çš„è¿æ¥æ•°
        poolConfig.setMaxIdle(12);   // æœ€å¤§è¿æ¥æ•°çš„75%
        poolConfig.setMinIdle(4);    // ä¿æŒæœ€å°è¿æ¥æ•°
        
        // åˆç†çš„è¶…æ—¶è®¾ç½®
        poolConfig.setMaxWaitMillis(5000);  // 5ç§’ç­‰å¾…æ—¶é—´
        poolConfig.setTestOnBorrow(true);   // è·å–è¿æ¥å‰æµ‹è¯•
        poolConfig.setTestWhileIdle(true);  // ç©ºé—²æ—¶æµ‹è¯•è¿æ¥
        
        factory.setPoolConfig(poolConfig);
        return factory;
    }
    
    // æ·»åŠ è¿æ¥æ± ç›‘æ§
    @Bean
    public HealthIndicator redisHealthIndicator(RedisConnectionFactory connectionFactory) {
        return new RedisHealthIndicator(connectionFactory);
    }
}
```

#### 4.8.4.2 Redisé”®å€¼æ“ä½œè§„èŒƒ ğŸŸ¡:

##### 4.8.4.2.1 é”®å€¼è¿‡æœŸè®¾ç½®

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰ key æ˜¯å¦è®¾ç½®äº†åˆç†çš„è¿‡æœŸæ—¶é—´
b. æ˜¯å¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚åŒºåˆ†ä¸åŒçš„è¿‡æœŸç­–ç•¥
c. æ˜¯å¦æœ‰é˜²æ­¢ç¼“å­˜ç©¿é€çš„æœºåˆ¶
d. æ˜¯å¦æœ‰ç¼“å­˜æ›´æ–°å’Œå¤±æ•ˆç­–ç•¥

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥ Redis æ“ä½œç›¸å…³ä»£ç ä¸­çš„è¿‡æœŸæ—¶é—´è®¾ç½®
b. è¿è¡Œæ—¶æ£€æŸ¥ï¼šä½¿ç”¨ TTL å‘½ä»¤æ£€æŸ¥ key çš„è¿‡æœŸæ—¶é—´
c. æ—¥å¿—åˆ†æï¼šåˆ†æç¼“å­˜å‘½ä¸­ç‡å’Œå¤±æ•ˆæƒ…å†µ
d. ç›‘æ§å®¡æŸ¥ï¼šç›‘æ§æ— è¿‡æœŸæ—¶é—´çš„ key æ•°é‡

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´
@Service
public class BadCacheService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void cacheUser(String userId, User user) {
        redisTemplate.opsForValue().set("user:" + userId, user); // æ²¡æœ‰è¿‡æœŸæ—¶é—´
    }
    
    // ç¼“å­˜ç»“æœæ²¡æœ‰è¿‡æœŸç­–ç•¥
    public List<Product> getProducts(String category) {
        String key = "products:" + category;
        if (redisTemplate.hasKey(key)) {
            return (List<Product>) redisTemplate.opsForValue().get(key);
        }
        
        List<Product> products = productService.findByCategory(category);
        // æ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œæ•°æ®å¯èƒ½æ°¸è¿œä¸æ›´æ–°
        redisTemplate.opsForValue().set(key, products);
        return products;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
@Service
public class CacheService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // å®šä¹‰ä¸åŒç±»å‹æ•°æ®çš„è¿‡æœŸæ—¶é—´å¸¸é‡
    private static final Duration USER_CACHE_TTL = Duration.ofHours(1);
    private static final Duration PRODUCT_CACHE_TTL = Duration.ofMinutes(30);
    private static final Duration NULL_VALUE_TTL = Duration.ofMinutes(5);
    
    public void cacheUser(String userId, User user) {
        // è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
        redisTemplate.opsForValue().set(
            "user:" + userId, 
            user, 
            USER_CACHE_TTL
        );
    }
    
    // å¤„ç†ç¼“å­˜ç©¿é€å’Œè¿‡æœŸç­–ç•¥
    public List<Product> getProducts(String category) {
        String key = "products:" + category;
        if (redisTemplate.hasKey(key)) {
            return (List<Product>) redisTemplate.opsForValue().get(key);
        }
        
        List<Product> products = productService.findByCategory(category);
        
        // å³ä½¿æŸ¥è¯¢ç»“æœä¸ºç©ºä¹Ÿç¼“å­˜ï¼Œä½†è¿‡æœŸæ—¶é—´è¾ƒçŸ­ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€
        if (products == null || products.isEmpty()) {
            redisTemplate.opsForValue().set(key, Collections.emptyList(), NULL_VALUE_TTL);
        } else {
            redisTemplate.opsForValue().set(key, products, PRODUCT_CACHE_TTL);
        }
        
        return products;
    }
    
    // ç¼“å­˜æ›´æ–°ç­–ç•¥
    public void updateProduct(Product product) {
        // å…ˆæ›´æ–°æ•°æ®åº“
        productService.update(product);
        
        // å†æ›´æ–°æˆ–åˆ é™¤ç¼“å­˜
        String key = "products:" + product.getCategory();
        // æ–¹æ¡ˆ1: ç›´æ¥åˆ é™¤ç¼“å­˜ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡å»º
        redisTemplate.delete(key);
        
        // æ–¹æ¡ˆ2: æ›´æ–°ç¼“å­˜ï¼ˆé€‚ç”¨äºé¢‘ç¹è¯»å–çš„åœºæ™¯ï¼‰
        // List<Product> products = getProductsFromCache(product.getCategory());
        // updateProductInList(products, product);
        // redisTemplate.opsForValue().set(key, products, PRODUCT_CACHE_TTL);
    }
}
```

#### 4.8.4.3 Rediså‘½ä»¤ä½¿ç”¨å®‰å…¨ ğŸŸ¡:

##### 4.8.4.3.1 é¿å…å±é™©å‘½ä»¤

**1. æ£€æµ‹ç›®æ ‡**

a. æ˜¯å¦ä½¿ç”¨äº†é«˜é£é™©å‘½ä»¤ï¼ˆKEYSã€FLUSHALLã€FLUSHDBç­‰ï¼‰
b. æ˜¯å¦é™åˆ¶äº† Redis å‘½ä»¤æ‰§è¡Œæƒé™
c. æ˜¯å¦æœ‰å‘½ä»¤å®¡è®¡å’Œç›‘æ§
d. ç”Ÿäº§ç¯å¢ƒæ˜¯å¦ç¦ç”¨äº†å±é™©å‘½ä»¤

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ˜¯å¦ç›´æ¥è°ƒç”¨å±é™©å‘½ä»¤
b. é…ç½®å®¡æŸ¥ï¼šæ£€æŸ¥ Redis å‘½ä»¤ç¦ç”¨é…ç½®
c. æ—¥å¿—åˆ†æï¼šåˆ†æ Redis å‘½ä»¤æ‰§è¡Œè®°å½•
d. å®‰å…¨æ‰«æï¼šä½¿ç”¨å·¥å…·æ‰«æå±é™©å‘½ä»¤ä½¿ç”¨

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨å±é™©å‘½ä»¤
@Service
public class DangerousRedisService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ä½¿ç”¨ KEYS å‘½ä»¤ï¼Œåœ¨æ•°æ®é‡å¤§æ—¶ä¼šé˜»å¡Redis
    public Set<String> getAllUserKeys() {
        return redisTemplate.keys("user:*");
    }
    
    // æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Œéå¸¸å±é™©
    public void clearAllData() {
        redisTemplate.execute((RedisCallback<Object>) connection -> {
            connection.flushAll();
            return null;
        });
    }
    
    // ç›´æ¥æ‰§è¡Œè„šæœ¬ï¼Œæ²¡æœ‰å®‰å…¨æ£€æŸ¥
    public void executeArbitraryCommand(String command) {
        redisTemplate.execute((RedisCallback<Object>) connection -> {
            connection.execute(command);
            return null;
        });
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨ä½¿ç”¨ Redis å‘½ä»¤
@Service
public class SafeRedisService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    private final MeterRegistry meterRegistry;
    
    // ä½¿ç”¨ SCAN ä»£æ›¿ KEYS
    public Set<String> getUserKeys(String pattern) {
        Set<String> keys = new HashSet<>();
        ScanOptions options = ScanOptions.scanOptions()
            .match(pattern)
            .count(100)
            .build();
        
        // è®°å½•å‘½ä»¤æ‰§è¡Œ
        Timer.Sample sample = Timer.start(meterRegistry);
        try {
            Cursor<String> cursor = redisTemplate.scan(options);
            while (cursor.hasNext()) {
                keys.add(cursor.next());
            }
            return keys;
        } finally {
            sample.stop(Timer.builder("redis.command.scan")
                .description("Redis SCAN command execution time")
                .register(meterRegistry));
        }
    }
    
    // å®‰å…¨çš„æ•°æ®æ¸…ç†æ–¹æ³•ï¼Œé™åˆ¶èŒƒå›´
    public void clearUserData(String userId) {
        String keyPattern = "user:" + userId + ":*";
        Set<String> keys = getUserKeys(keyPattern);
        if (!keys.isEmpty()) {
            redisTemplate.delete(keys);
            log.info("Cleared {} keys for user: {}", keys.size(), userId);
        }
    }
    
    // ä½¿ç”¨æƒé™æ£€æŸ¥å’Œå®¡è®¡æ—¥å¿—
    @PreAuthorize("hasRole('ADMIN')")
    public void executeAdminCommand(String command, String params) {
        if (isCommandBlacklisted(command)) {
            log.warn("Attempted to execute blacklisted command: {}", command);
            throw new SecurityException("Command not allowed: " + command);
        }
        
        log.info("Admin executing Redis command: {} with params: {}", command, params);
        // æ‰§è¡Œå®‰å…¨æ£€æŸ¥è¿‡çš„å‘½ä»¤...
    }
    
    private boolean isCommandBlacklisted(String command) {
        List<String> blacklist = Arrays.asList("FLUSHALL", "FLUSHDB", "KEYS", "CONFIG");
        return blacklist.contains(command.toUpperCase());
    }
}
```

#### 4.8.4.4 Redisæ€§èƒ½ä¼˜åŒ– ğŸŸ¡:

##### 4.8.4.4.1 æ‰¹é‡æ“ä½œä¼˜åŒ–

**1. æ£€æµ‹ç›®æ ‡**

a. å¤§æ‰¹é‡æ“ä½œæ˜¯å¦ä½¿ç”¨ pipeline æˆ–æ‰¹é‡å‘½ä»¤
b. æ˜¯å¦é¿å…å¾ªç¯ä¸­å•ä¸ªæ‰§è¡Œ Redis å‘½ä»¤
c. æ˜¯å¦åˆç†ä½¿ç”¨ Redis äº‹åŠ¡
d. æ‰¹é‡æ“ä½œæ˜¯å¦è€ƒè™‘å†…å­˜å’Œç½‘ç»œå½±å“

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ‰¹é‡æ“ä½œå®ç°æ–¹å¼
b. æ€§èƒ½æµ‹è¯•ï¼šå¯¹æ¯”ä¸åŒå®ç°çš„æ€§èƒ½å·®å¼‚
c. ç›‘æ§åˆ†æï¼šç›‘æ§ Redis å‘½ä»¤æ‰§è¡Œé¢‘ç‡å’Œè€—æ—¶
d. è´Ÿè½½æµ‹è¯•ï¼šéªŒè¯é«˜è´Ÿè½½ä¸‹çš„æ‰¹é‡æ“ä½œæ•ˆç‡

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå¾ªç¯ä¸­å•ä¸ªæ‰§è¡Œå‘½ä»¤ï¼Œæ€§èƒ½å·®
@Service
public class InefficientBatchService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // åœ¨å¾ªç¯ä¸­å•ä¸ªæ‰§è¡Œå‘½ä»¤
    public void cacheUserList(List<User> users) {
        for (User user : users) {
            String key = "user:" + user.getId();
            // æ¯ä¸ªç”¨æˆ·å•ç‹¬å‘é€ä¸€æ¬¡ç½‘ç»œè¯·æ±‚
            redisTemplate.opsForValue().set(key, user, Duration.ofHours(1));
        }
    }
    
    // å¾ªç¯è·å–å¤šä¸ªé”®å€¼
    public List<User> getMultipleUsers(List<String> userIds) {
        List<User> result = new ArrayList<>();
        for (String userId : userIds) {
            // æ¯æ¬¡æŸ¥è¯¢å‘é€ä¸€æ¬¡ç½‘ç»œè¯·æ±‚
            User user = (User) redisTemplate.opsForValue().get("user:" + userId);
            if (user != null) {
                result.add(user);
            }
        }
        return result;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ pipeline å’Œæ‰¹é‡å‘½ä»¤ä¼˜åŒ–æ€§èƒ½
@Service
public class EfficientBatchService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ä½¿ç”¨ pipeline æ‰¹é‡ç¼“å­˜
    public void cacheUserList(List<User> users) {
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (User user : users) {
                byte[] key = redisTemplate.getStringSerializer()
                    .serialize("user:" + user.getId());
                byte[] value = redisTemplate.getValueSerializer().serialize(user);
                
                // åœ¨ä¸€æ¬¡ç½‘ç»œå¾€è¿”ä¸­æ‰§è¡Œå¤šä¸ªå‘½ä»¤
                connection.set(key, value, Expiration.from(1, TimeUnit.HOURS), null);
            }
            return null;
        });
    }
    
    // ä½¿ç”¨ MGET æ‰¹é‡è·å–
    public List<User> getMultipleUsers(List<String> userIds) {
        List<String> keys = userIds.stream()
            .map(id -> "user:" + id)
            .collect(Collectors.toList());
        
        // ä¸€æ¬¡ç½‘ç»œè¯·æ±‚è·å–å¤šä¸ªé”®å€¼
        List<Object> values = redisTemplate.opsForValue().multiGet(keys);
        
        List<User> result = new ArrayList<>();
        if (values != null) {
            for (Object value : values) {
                if (value != null) {
                    result.add((User) value);
                }
            }
        }
        return result;
    }
    
    // ä½¿ç”¨ Redis äº‹åŠ¡
    public void updateUserDataInTransaction(String userId, User user, List<String> roles) {
        redisTemplate.execute(new SessionCallback<Object>() {
            @Override
            public Object execute(RedisOperations operations) {
                operations.multi();
                
                operations.opsForValue().set("user:" + userId, user, Duration.ofHours(1));
                operations.opsForList().rightPushAll("user:" + userId + ":roles", roles);
                
                return operations.exec();
            }
        });
    }
    
    // åˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®ï¼Œé¿å…å†…å­˜å‹åŠ›
    public void processBulkData(List<String> allItems) {
        int batchSize = 1000;
        
        for (int i = 0; i < allItems.size(); i += batchSize) {
            int endIndex = Math.min(i + batchSize, allItems.size());
            List<String> batch = allItems.subList(i, endIndex);
            
            // å¤„ç†å½“å‰æ‰¹æ¬¡
            processBatch(batch);
        }
    }
    
    private void processBatch(List<String> items) {
        // ä½¿ç”¨pipelineå¤„ç†æ‰¹æ¬¡æ•°æ®
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (String item : items) {
                // æ‰¹é‡å¤„ç†é€»è¾‘
            }
            return null;
        });
    }
}
```