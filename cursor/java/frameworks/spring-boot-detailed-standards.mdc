# Spring Boot è¯¦ç»†å¼€å‘è§„èŒƒ
> Spring Boot 2.2.0+ ä¼ä¸šçº§å¼€å‘æ ‡å‡†

## ğŸ¯ æ¶æ„åˆ†å±‚è§„èŒƒ

### åˆ†å±‚èŒè´£å®šä¹‰ [MUST - L1]
- **Controllerå±‚**ï¼šè¯·æ±‚è·¯ç”±ã€å‚æ•°éªŒè¯ã€å“åº”å°è£…
- **Serviceå±‚**ï¼šä¸šåŠ¡é€»è¾‘ã€äº‹åŠ¡ç®¡ç†ã€å¼‚å¸¸å¤„ç†
- **Repositoryå±‚**ï¼šæ•°æ®è®¿é—®ã€æŸ¥è¯¢ä¼˜åŒ–ã€æ•°æ®è½¬æ¢
- **Entityå±‚**ï¼šæ•°æ®æ¨¡å‹ã€å­—æ®µæ˜ å°„ã€å…³ç³»å®šä¹‰

## ğŸ”§ Controllerå±‚è§„èŒƒ

### RESTful APIè®¾è®¡ [MUST - L1]
```java
// [AI-BLOCK-START] - ç”Ÿæˆå·¥å…·: Spring Bootè§„èŒƒ v1.0
@RestController
@RequestMapping("/api/v1/users")
@Validated
@Slf4j
public class UserController {
    
    private final UserService userService;
    
    // æ„é€ å™¨æ³¨å…¥ï¼Œé¿å…@Autowired
    public UserController(UserService userService) {
        this.userService = userService;
    }
    
    /**
     * åˆ›å»ºç”¨æˆ·
     * POST /api/v1/users
     */
    @PostMapping
    public ResponseEntity<ApiResponse<UserResponse>> createUser(
            @Valid @RequestBody CreateUserRequest request) {
        
        log.info("Creating user with email: {}", request.getEmail());
        
        UserResponse user = userService.createUser(request);
        return ResponseEntity.status(HttpStatus.CREATED)
            .body(ApiResponse.success(user));
    }
    
    /**
     * è·å–ç”¨æˆ·è¯¦æƒ…
     * GET /api/v1/users/{id}
     */
    @GetMapping("/{id}")
    public ResponseEntity<ApiResponse<UserResponse>> getUserById(
            @PathVariable @Min(1) Long id) {
        
        UserResponse user = userService.findUserById(id);
        return ResponseEntity.ok(ApiResponse.success(user));
    }
    
    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·
     * GET /api/v1/users?page=0&size=20&status=ACTIVE
     */
    @GetMapping
    public ResponseEntity<ApiResponse<PageResponse<UserResponse>>> getUsers(
            @RequestParam(defaultValue = "0") @Min(0) Integer page,
            @RequestParam(defaultValue = "20") @Range(min = 1, max = 100) Integer size,
            @RequestParam(required = false) UserStatus status) {
        
        PageRequest pageRequest = PageRequest.of(page, size);
        PageResponse<UserResponse> users = userService.findUsers(pageRequest, status);
        return ResponseEntity.ok(ApiResponse.success(users));
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·
     * PUT /api/v1/users/{id}
     */
    @PutMapping("/{id}")
    public ResponseEntity<ApiResponse<UserResponse>> updateUser(
            @PathVariable @Min(1) Long id,
            @Valid @RequestBody UpdateUserRequest request) {
        
        log.info("Updating user: {}", id);
        
        UserResponse user = userService.updateUser(id, request);
        return ResponseEntity.ok(ApiResponse.success(user));
    }
    
    /**
     * åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
     * DELETE /api/v1/users/{id}
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<ApiResponse<Void>> deleteUser(@PathVariable @Min(1) Long id) {
        log.info("Deleting user: {}", id);
        
        userService.deleteUser(id);
        return ResponseEntity.ok(ApiResponse.success(null));
    }
}
// [AI-BLOCK-END]
```

### ç»Ÿä¸€å“åº”æ ¼å¼ [MUST - L1]
```java
// [AI-BLOCK-START] - ç”Ÿæˆå·¥å…·: Spring Bootè§„èŒƒ v1.0
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ApiResponse<T> {
    
    /**
     * å“åº”çŠ¶æ€ç 
     * 200: æˆåŠŸ
     * 400: å‚æ•°é”™è¯¯
     * 500: ç³»ç»Ÿé”™è¯¯
     */
    private Integer code;
    
    /**
     * å“åº”æ¶ˆæ¯
     */
    private String message;
    
    /**
     * å“åº”æ•°æ®
     */
    private T data;
    
    /**
     * æ—¶é—´æˆ³
     */
    private Long timestamp;
    
    /**
     * è¯·æ±‚IDï¼Œç”¨äºé“¾è·¯è¿½è¸ª
     */
    private String requestId;
    
    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
            .code(200)
            .message("Success")
            .data(data)
            .timestamp(System.currentTimeMillis())
            .requestId(MDC.get("requestId"))
            .build();
    }
    
    public static <T> ApiResponse<T> error(Integer code, String message) {
        return ApiResponse.<T>builder()
            .code(code)
            .message(message)
            .timestamp(System.currentTimeMillis())
            .requestId(MDC.get("requestId"))
            .build();
    }
}

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PageResponse<T> {
    
    /**
     * æ•°æ®åˆ—è¡¨
     */
    private List<T> content;
    
    /**
     * å½“å‰é¡µç ï¼ˆä»0å¼€å§‹ï¼‰
     */
    private Integer page;
    
    /**
     * æ¯é¡µå¤§å°
     */
    private Integer size;
    
    /**
     * æ€»å…ƒç´ æ•°
     */
    private Long total;
    
    /**
     * æ€»é¡µæ•°
     */
    private Integer totalPages;
    
    /**
     * æ˜¯å¦ä¸ºç¬¬ä¸€é¡µ
     */
    private Boolean first;
    
    /**
     * æ˜¯å¦ä¸ºæœ€åä¸€é¡µ
     */
    private Boolean last;
}
// [AI-BLOCK-END]
```

### å…¨å±€å¼‚å¸¸å¤„ç† [MUST - L1]
```java
// [AI-BLOCK-START] - ç”Ÿæˆå·¥å…·: Spring Bootè§„èŒƒ v1.0
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    /**
     * å‚æ•°éªŒè¯å¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Void>> handleValidationException(
            MethodArgumentNotValidException e) {
        
        String message = e.getBindingResult().getFieldErrors().stream()
            .map(error -> error.getField() + ": " + error.getDefaultMessage())
            .collect(Collectors.joining(", "));
            
        log.warn("Validation error: {}", message);
        
        return ResponseEntity.badRequest()
            .body(ApiResponse.error(400, "å‚æ•°éªŒè¯å¤±è´¥: " + message));
    }
    
    /**
     * ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(BusinessException e) {
        log.warn("Business error: {} - {}", e.getErrorCode(), e.getMessage());
        
        return ResponseEntity.badRequest()
            .body(ApiResponse.error(e.getErrorCode(), e.getMessage()));
    }
    
    /**
     * èµ„æºä¸å­˜åœ¨å¼‚å¸¸
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ApiResponse<Void>> handleResourceNotFoundException(
            ResourceNotFoundException e) {
        
        log.warn("Resource not found: {}", e.getMessage());
        
        return ResponseEntity.status(HttpStatus.NOT_FOUND)
            .body(ApiResponse.error(404, e.getMessage()));
    }
    
    /**
     * ç³»ç»Ÿå¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Void>> handleSystemException(Exception e) {
        log.error("System error", e);
        
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(ApiResponse.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯"));
    }
}
// [AI-BLOCK-END]
```

## ğŸ”§ Serviceå±‚è§„èŒƒ

### äº‹åŠ¡ç®¡ç†è§„èŒƒ [MUST - L1]
```java
// [AI-BLOCK-START] - ç”Ÿæˆå·¥å…·: Spring Bootè§„èŒƒ v1.0
@Service
@Transactional(readOnly = true)
@Slf4j
public class UserServiceImpl implements UserService {
    
    private final UserRepository userRepository;
    private final UserConverter userConverter;
    private final EmailService emailService;
    
    public UserServiceImpl(UserRepository userRepository, 
                          UserConverter userConverter,
                          EmailService emailService) {
        this.userRepository = userRepository;
        this.userConverter = userConverter;
        this.emailService = emailService;
    }
    
    /**
     * åˆ›å»ºç”¨æˆ· - å†™æ“ä½œéœ€è¦æ˜¾å¼å£°æ˜äº‹åŠ¡
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public UserResponse createUser(CreateUserRequest request) {
        // å‚æ•°éªŒè¯
        validateCreateUserRequest(request);
        
        // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
        if (userRepository.existsByEmail(request.getEmail())) {
            throw new BusinessException(ErrorCode.USER_EMAIL_EXISTS, "é‚®ç®±å·²å­˜åœ¨");
        }
        
        try {
            // åˆ›å»ºç”¨æˆ·å®ä½“
            User user = userConverter.toEntity(request);
            user.setStatus(UserStatus.ACTIVE);
            user.setCreateTime(LocalDateTime.now());
            
            // ä¿å­˜ç”¨æˆ·
            User savedUser = userRepository.save(user);
            
            // å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆå¼‚æ­¥å¤„ç†ï¼Œä¸å½±å“ä¸»äº‹åŠ¡ï¼‰
            sendWelcomeEmailAsync(savedUser);
            
            return userConverter.toResponse(savedUser);
            
        } catch (Exception e) {
            log.error("Failed to create user: {}", request.getEmail(), e);
            throw new BusinessException(ErrorCode.USER_CREATE_FAILED, "ç”¨æˆ·åˆ›å»ºå¤±è´¥");
        }
    }
    
    /**
     * æŸ¥è¯¢ç”¨æˆ· - åªè¯»äº‹åŠ¡
     */
    @Override
    public UserResponse findUserById(Long id) {
        User user = userRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));
            
        return userConverter.toResponse(user);
    }
    
    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·
     */
    @Override
    public PageResponse<UserResponse> findUsers(Pageable pageable, UserStatus status) {
        Page<User> userPage;
        
        if (status != null) {
            userPage = userRepository.findByStatus(status, pageable);
        } else {
            userPage = userRepository.findAll(pageable);
        }
        
        List<UserResponse> userResponses = userPage.getContent().stream()
            .map(userConverter::toResponse)
            .collect(Collectors.toList());
            
        return PageResponse.<UserResponse>builder()
            .content(userResponses)
            .page(userPage.getNumber())
            .size(userPage.getSize())
            .total(userPage.getTotalElements())
            .totalPages(userPage.getTotalPages())
            .first(userPage.isFirst())
            .last(userPage.isLast())
            .build();
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public UserResponse updateUser(Long id, UpdateUserRequest request) {
        User user = userRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));
            
        // æ›´æ–°å­—æ®µ
        if (StringUtils.hasText(request.getName())) {
            user.setName(request.getName());
        }
        if (StringUtils.hasText(request.getPhone())) {
            user.setPhone(request.getPhone());
        }
        user.setUpdateTime(LocalDateTime.now());
        
        User updatedUser = userRepository.save(user);
        return userConverter.toResponse(updatedUser);
    }
    
    /**
     * è½¯åˆ é™¤ç”¨æˆ·
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void deleteUser(Long id) {
        User user = userRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));
            
        user.setStatus(UserStatus.DELETED);
        user.setUpdateTime(LocalDateTime.now());
        
        userRepository.save(user);
        
        log.info("User deleted: {}", id);
    }
    
    /**
     * å¼‚æ­¥å‘é€æ¬¢è¿é‚®ä»¶
     */
    @Async
    public void sendWelcomeEmailAsync(User user) {
        try {
            emailService.sendWelcomeEmail(user.getEmail(), user.getName());
        } catch (Exception e) {
            log.error("Failed to send welcome email to: {}", user.getEmail(), e);
        }
    }
    
    private void validateCreateUserRequest(CreateUserRequest request) {
        if (!EmailValidator.isValid(request.getEmail())) {
            throw new BusinessException(ErrorCode.INVALID_EMAIL, "é‚®ç®±æ ¼å¼æ— æ•ˆ");
        }
        
        if (request.getName().length() < 2 || request.getName().length() > 50) {
            throw new BusinessException(ErrorCode.INVALID_NAME, "å§“åé•¿åº¦å¿…é¡»åœ¨2-50å­—ç¬¦ä¹‹é—´");
        }
    }
}
// [AI-BLOCK-END]
```

## ğŸ”§ Repositoryå±‚è§„èŒƒ

### JPA Repositoryè§„èŒƒ [MUST - L1]
```java
// [AI-BLOCK-START] - ç”Ÿæˆå·¥å…·: Spring Bootè§„èŒƒ v1.0
@Repository
public interface UserRepository extends JpaRepository<User, Long>, JpaSpecificationExecutor<User> {
    
    /**
     * æ–¹æ³•å‘½åæŸ¥è¯¢ - ç®€å•æŸ¥è¯¢æ¨èä½¿ç”¨
     */
    Optional<User> findByEmail(String email);
    
    List<User> findByStatus(UserStatus status);
    
    Page<User> findByStatus(UserStatus status, Pageable pageable);
    
    List<User> findByCreateTimeBetween(LocalDateTime start, LocalDateTime end);
    
    boolean existsByEmail(String email);
    
    long countByStatus(UserStatus status);
    
    /**
     * @Queryæ³¨è§£ - å¤æ‚æŸ¥è¯¢ä½¿ç”¨JPQL
     */
    @Query("SELECT u FROM User u WHERE u.status = :status AND u.createTime >= :since")
    List<User> findActiveUsersSince(@Param("status") UserStatus status, 
                                  @Param("since") LocalDateTime since);
    
    @Query("SELECT u FROM User u WHERE u.name LIKE %:keyword% OR u.email LIKE %:keyword%")
    Page<User> searchUsers(@Param("keyword") String keyword, Pageable pageable);
    
    /**
     * åŸç”ŸSQLæŸ¥è¯¢ - æ€§èƒ½æ•æ„Ÿæˆ–å¤æ‚ç»Ÿè®¡æŸ¥è¯¢
     */
    @Query(value = "SELECT DATE(create_time) as date, COUNT(*) as count " +
                   "FROM users WHERE create_time >= :since " +
                   "GROUP BY DATE(create_time) ORDER BY date", 
           nativeQuery = true)
    List<Object[]> getUserRegistrationStatistics(@Param("since") LocalDateTime since);
    
    /**
     * æ›´æ–°æŸ¥è¯¢ - æ‰¹é‡æ›´æ–°æ“ä½œ
     */
    @Modifying
    @Query("UPDATE User u SET u.status = :status, u.updateTime = :updateTime WHERE u.id IN :ids")
    int updateUserStatus(@Param("ids") List<Long> ids, 
                        @Param("status") UserStatus status,
                        @Param("updateTime") LocalDateTime updateTime);
    
    /**
     * è‡ªå®šä¹‰Repositoryå®ç° - å¤æ‚åŠ¨æ€æŸ¥è¯¢
     */
    interface UserRepositoryCustom {
        Page<User> findUsersWithDynamicCriteria(UserSearchCriteria criteria, Pageable pageable);
    }
}

@Repository
public class UserRepositoryImpl implements UserRepository.UserRepositoryCustom {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @Override
    public Page<User> findUsersWithDynamicCriteria(UserSearchCriteria criteria, Pageable pageable) {
        CriteriaBuilder cb = entityManager.getCriteriaBuilder();
        CriteriaQuery<User> query = cb.createQuery(User.class);
        Root<User> root = query.from(User.class);
        
        List<Predicate> predicates = buildPredicates(cb, root, criteria);
        
        if (!predicates.isEmpty()) {
            query.where(cb.and(predicates.toArray(new Predicate[0])));
        }
        
        // æ’åº
        if (pageable.getSort().isSorted()) {
            List<Order> orders = pageable.getSort().stream()
                .map(order -> order.isAscending() 
                    ? cb.asc(root.get(order.getProperty()))
                    : cb.desc(root.get(order.getProperty())))
                .collect(Collectors.toList());
            query.orderBy(orders);
        }
        
        // åˆ†é¡µæŸ¥è¯¢
        TypedQuery<User> typedQuery = entityManager.createQuery(query);
        typedQuery.setFirstResult((int) pageable.getOffset());
        typedQuery.setMaxResults(pageable.getPageSize());
        
        List<User> users = typedQuery.getResultList();
        
        // è®¡ç®—æ€»æ•°
        long total = countUsersWithCriteria(criteria);
        
        return new PageImpl<>(users, pageable, total);
    }
    
    private List<Predicate> buildPredicates(CriteriaBuilder cb, Root<User> root, 
                                          UserSearchCriteria criteria) {
        List<Predicate> predicates = new ArrayList<>();
        
        if (StringUtils.hasText(criteria.getName())) {
            predicates.add(cb.like(cb.lower(root.get("name")), 
                "%" + criteria.getName().toLowerCase() + "%"));
        }
        
        if (StringUtils.hasText(criteria.getEmail())) {
            predicates.add(cb.like(cb.lower(root.get("email")), 
                "%" + criteria.getEmail().toLowerCase() + "%"));
        }
        
        if (criteria.getStatus() != null) {
            predicates.add(cb.equal(root.get("status"), criteria.getStatus()));
        }
        
        if (criteria.getCreateTimeFrom() != null) {
            predicates.add(cb.greaterThanOrEqualTo(root.get("createTime"), 
                criteria.getCreateTimeFrom()));
        }
        
        if (criteria.getCreateTimeTo() != null) {
            predicates.add(cb.lessThanOrEqualTo(root.get("createTime"), 
                criteria.getCreateTimeTo()));
        }
        
        return predicates;
    }
    
    private long countUsersWithCriteria(UserSearchCriteria criteria) {
        CriteriaBuilder cb = entityManager.getCriteriaBuilder();
        CriteriaQuery<Long> countQuery = cb.createQuery(Long.class);
        Root<User> root = countQuery.from(User.class);
        
        List<Predicate> predicates = buildPredicates(cb, root, criteria);
        
        countQuery.select(cb.count(root));
        if (!predicates.isEmpty()) {
            countQuery.where(cb.and(predicates.toArray(new Predicate[0])));
        }
        
        return entityManager.createQuery(countQuery).getSingleResult();
    }
}
// [AI-BLOCK-END]
```

## ğŸ”§ é…ç½®ç±»è§„èŒƒ

### åº”ç”¨é…ç½® [MUST - L1]
```java
// [AI-BLOCK-START] - ç”Ÿæˆå·¥å…·: Spring Bootè§„èŒƒ v1.0
@Configuration
@EnableJpaAuditing
@EnableAsync
@EnableScheduling
@Slf4j
public class ApplicationConfig {
    
    /**
     * å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± é…ç½®
     */
    @Bean(name = "taskExecutor")
    public ThreadPoolTaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        
        // æ ¸å¿ƒçº¿ç¨‹æ•°
        executor.setCorePoolSize(5);
        // æœ€å¤§çº¿ç¨‹æ•°
        executor.setMaxPoolSize(10);
        // é˜Ÿåˆ—å®¹é‡
        executor.setQueueCapacity(100);
        // çº¿ç¨‹åå‰ç¼€
        executor.setThreadNamePrefix("Async-");
        // æ‹’ç»ç­–ç•¥
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        // å…³é—­æ—¶ç­‰å¾…ä»»åŠ¡å®Œæˆ
        executor.setWaitForTasksToCompleteOnShutdown(true);
        // ç­‰å¾…æ—¶é—´
        executor.setAwaitTerminationSeconds(60);
        
        executor.initialize();
        return executor;
    }
    
    /**
     * RestTemplateé…ç½®
     */
    @Bean
    public RestTemplate restTemplate() {
        HttpComponentsClientHttpRequestFactory factory = new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(5000);
        factory.setReadTimeout(10000);
        
        RestTemplate restTemplate = new RestTemplate(factory);
        
        // æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨
        restTemplate.getInterceptors().add((request, body, execution) -> {
            String requestId = UUID.randomUUID().toString();
            request.getHeaders().add("X-Request-ID", requestId);
            
            log.info("RestTemplate request: {} {}", request.getMethod(), request.getURI());
            
            ClientHttpResponse response = execution.execute(request, body);
            
            log.info("RestTemplate response: {}", response.getStatusCode());
            
            return response;
        });
        
        return restTemplate;
    }
    
    /**
     * å¯¹è±¡è½¬æ¢å™¨é…ç½®
     */
    @Bean
    public ModelMapper modelMapper() {
        ModelMapper mapper = new ModelMapper();
        
        // ä¸¥æ ¼åŒ¹é…ç­–ç•¥
        mapper.getConfiguration()
            .setMatchingStrategy(MatchingStrategies.STRICT)
            .setFieldMatchingEnabled(true)
            .setFieldAccessLevel(org.modelmapper.config.Configuration.AccessLevel.PRIVATE);
            
        return mapper;
    }
    
    /**
     * å®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……
     */
    @Bean
    public AuditorAware<String> auditorProvider() {
        return () -> {
            // ä»Spring Securityä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·
            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            if (authentication != null && authentication.isAuthenticated() 
                && !authentication.getPrincipal().equals("anonymousUser")) {
                return Optional.of(authentication.getName());
            }
            return Optional.of("system");
        };
    }
}
// [AI-BLOCK-END]
```

---

*æ­¤Spring Bootè¯¦ç»†è§„èŒƒä¸ºä¼ä¸šçº§å¼€å‘æä¾›å®Œæ•´çš„å®æ–½æ ‡å‡†å’Œæœ€ä½³å®è·µ*
description:
globs:
alwaysApply: false
---
