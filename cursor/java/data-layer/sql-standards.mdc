# SQLç¼–ç¨‹è§„èŒƒ

## ğŸ¯ è§„èŒƒç›®æ ‡
- ç¡®ä¿SQLä»£ç çš„å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å’Œé«˜æ€§èƒ½
- é˜²æ­¢SQLæ³¨å…¥å’Œå…¶ä»–å®‰å…¨é£é™©
- å»ºç«‹ç»Ÿä¸€çš„SQLç¼–å†™æ ‡å‡†
- ä¼˜åŒ–æ•°æ®åº“æ“ä½œæ€§èƒ½

## ğŸ“‹ DDLè§„èŒƒ (æ•°æ®å®šä¹‰è¯­è¨€)

### è¡¨è®¾è®¡è§„èŒƒ

#### MUST - å¿…é¡»éµå®ˆ
```sql
-- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šæ ‡å‡†è¡¨ç»“æ„
CREATE TABLE `user_info` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    `username` VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·å',
    `email` VARCHAR(100) NOT NULL COMMENT 'é‚®ç®±',
    `phone` VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æ­£å¸¸ï¼Œ0-ç¦ç”¨',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `create_by` VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    `update_by` VARCHAR(50) COMMENT 'æ›´æ–°äºº',
    `is_deleted` TINYINT DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤ï¼š1-å·²åˆ é™¤ï¼Œ0-æœªåˆ é™¤',
    INDEX `idx_username` (`username`),
    INDEX `idx_email` (`email`),
    INDEX `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·ä¿¡æ¯è¡¨';
```

#### è¡¨å‘½åè§„èŒƒ
- **MUST**: ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
- **MUST**: è¡¨ååº”è¯¥æ˜¯å¤æ•°å½¢å¼æˆ–åŒ…å«æè¿°æ€§åç¼€
- **MUST**: é¿å…ä½¿ç”¨MySQLä¿ç•™å­—

```sql
-- âœ… æ­£ç¡®ç¤ºä¾‹
user_info, order_details, product_categories

-- âŒ é”™è¯¯ç¤ºä¾‹  
UserInfo, orderDetail, user, order
```

### å­—æ®µè®¾è®¡è§„èŒƒ

#### åŸºç¡€å­—æ®µè§„èŒƒ
```sql
-- MUST: æ¯ä¸ªè¡¨éƒ½å¿…é¡»åŒ…å«ä»¥ä¸‹æ ‡å‡†å­—æ®µ
`id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
`create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
`update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
`is_deleted` TINYINT DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤ï¼š1-å·²åˆ é™¤ï¼Œ0-æœªåˆ é™¤'
```

#### å­—æ®µç±»å‹é€‰æ‹©
```sql
-- âœ… æ•°å€¼ç±»å‹é€‰æ‹©
TINYINT     -- çŠ¶æ€æ ‡å¿—ä½ (0-255)
INT         -- ä¸€èˆ¬æ•´æ•° (Â±21äº¿)
BIGINT      -- å¤§æ•´æ•°ã€IDä¸»é”®
DECIMAL     -- ç²¾ç¡®å°æ•° (é‡‘é¢ç­‰)

-- âœ… å­—ç¬¦ç±»å‹é€‰æ‹©  
CHAR(n)     -- å›ºå®šé•¿åº¦å­—ç¬¦ä¸² (å¦‚æ‰‹æœºå·)
VARCHAR(n)  -- å¯å˜é•¿åº¦å­—ç¬¦ä¸² (å¦‚å§“åã€åœ°å€)
TEXT        -- é•¿æ–‡æœ¬å†…å®¹

-- âœ… æ—¶é—´ç±»å‹é€‰æ‹©
DATETIME    -- å®Œæ•´æ—¥æœŸæ—¶é—´
DATE        -- ä»…æ—¥æœŸ
TIMESTAMP   -- æ—¶é—´æˆ³ (æœ‰æ—¶åŒºæ¦‚å¿µ)
```

### ç´¢å¼•è®¾è®¡è§„èŒƒ

#### ç´¢å¼•å‘½åè§„èŒƒ
```sql
-- MUST: ç´¢å¼•å‘½åè§„åˆ™
PRIMARY KEY: pk_è¡¨å
UNIQUE INDEX: uk_è¡¨å_å­—æ®µå
NORMAL INDEX: idx_è¡¨å_å­—æ®µå  
FOREIGN KEY: fk_è¡¨å_å¼•ç”¨è¡¨å

-- âœ… æ­£ç¡®ç¤ºä¾‹
ALTER TABLE user_info ADD INDEX idx_user_info_email (email);
ALTER TABLE user_info ADD UNIQUE INDEX uk_user_info_username (username);
```

#### ç´¢å¼•è®¾è®¡åŸåˆ™
```sql
-- MUST: é«˜é¢‘æŸ¥è¯¢å­—æ®µå¿…é¡»å»ºç´¢å¼•
-- æŸ¥è¯¢æ¡ä»¶å­—æ®µ
ALTER TABLE orders ADD INDEX idx_orders_user_id (user_id);
ALTER TABLE orders ADD INDEX idx_orders_status (status);

-- æ’åºå­—æ®µ
ALTER TABLE orders ADD INDEX idx_orders_create_time (create_time);

-- è”åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™
ALTER TABLE orders ADD INDEX idx_orders_user_status_time (user_id, status, create_time);

-- SHOULD: è¦†ç›–ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
ALTER TABLE orders ADD INDEX idx_orders_user_cover (user_id, status, total_amount);
```

## ğŸ“‹ DMLè§„èŒƒ (æ•°æ®æ“ä½œè¯­è¨€)

### æŸ¥è¯¢è§„èŒƒ

#### SELECTè¯­å¥è§„èŒƒ
```sql
-- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šå®Œæ•´çš„æŸ¥è¯¢è§„èŒƒ
SELECT 
    u.id,
    u.username,
    u.email,
    u.create_time
FROM user_info u
WHERE u.is_deleted = 0
    AND u.status = 1
    AND u.create_time >= '2024-01-01'
ORDER BY u.create_time DESC
LIMIT 0, 20;

-- MUST: é¿å…ä½¿ç”¨ SELECT *
-- âŒ é”™è¯¯ç¤ºä¾‹
SELECT * FROM user_info;

-- âœ… æ­£ç¡®ç¤ºä¾‹
SELECT id, username, email FROM user_info;
```

#### JOINæ“ä½œè§„èŒƒ
```sql
-- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šæ˜ç¡®æŒ‡å®šJOINç±»å‹å’Œæ¡ä»¶
SELECT 
    u.username,
    o.order_no,
    o.total_amount
FROM user_info u
INNER JOIN orders o ON u.id = o.user_id
WHERE u.is_deleted = 0 
    AND o.is_deleted = 0
    AND o.status = 'completed'
ORDER BY o.create_time DESC;

-- MUST: å¤§è¡¨JOINä½¿ç”¨ç´¢å¼•å­—æ®µ
-- MUST: é¿å…éšå¼ç±»å‹è½¬æ¢
-- WHERE u.id = o.user_id  -- ç¡®ä¿å­—æ®µç±»å‹ä¸€è‡´
```

#### åˆ†é¡µæŸ¥è¯¢è§„èŒƒ
```sql
-- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨LIMITåˆ†é¡µ
SELECT id, username, email 
FROM user_info 
WHERE is_deleted = 0
ORDER BY id DESC
LIMIT 20 OFFSET 100;

-- SHOULD: å¤§æ•°æ®é‡åˆ†é¡µä¼˜åŒ–
SELECT id, username, email 
FROM user_info 
WHERE is_deleted = 0 
    AND id < 10000  -- ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
ORDER BY id DESC
LIMIT 20;
```

### æ’å…¥è§„èŒƒ

```sql
-- âœ… å•æ¡æ’å…¥
INSERT INTO user_info (username, email, phone, create_by) 
VALUES ('john_doe', 'john@example.com', '13800138000', 'admin');

-- âœ… æ‰¹é‡æ’å…¥ (æ¨è)
INSERT INTO user_info (username, email, phone, create_by) 
VALUES 
    ('user1', 'user1@example.com', '13800138001', 'admin'),
    ('user2', 'user2@example.com', '13800138002', 'admin'),
    ('user3', 'user3@example.com', '13800138003', 'admin');

-- MUST: æ˜ç¡®æŒ‡å®šå­—æ®µåˆ—è¡¨
-- MUST: æ‰¹é‡æ’å…¥æ¯æ‰¹ä¸è¶…è¿‡1000æ¡
```

### æ›´æ–°è§„èŒƒ

```sql
-- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šå®‰å…¨çš„æ›´æ–°æ“ä½œ
UPDATE user_info 
SET 
    email = 'newemail@example.com',
    update_time = NOW(),
    update_by = 'admin'
WHERE id = 123 
    AND is_deleted = 0;

-- MUST: æ›´æ–°å¿…é¡»æœ‰WHEREæ¡ä»¶
-- MUST: æ›´æ–°é€»è¾‘åˆ é™¤æ ‡å¿—è€Œéç‰©ç†åˆ é™¤
UPDATE user_info 
SET 
    is_deleted = 1,
    update_time = NOW(),
    update_by = 'admin'
WHERE id = 123;
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### æŸ¥è¯¢ä¼˜åŒ–
```sql
-- âœ… ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–
-- ç¡®ä¿WHEREæ¡ä»¶ä½¿ç”¨ç´¢å¼•å­—æ®µ
EXPLAIN SELECT * FROM orders WHERE user_id = 123 AND status = 'pending';

-- âœ… é¿å…å‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
-- âŒ é”™è¯¯ç¤ºä¾‹
SELECT * FROM orders WHERE DATE(create_time) = '2024-01-01';
-- âœ… æ­£ç¡®ç¤ºä¾‹  
SELECT * FROM orders WHERE create_time >= '2024-01-01' AND create_time < '2024-01-02';

-- âœ… ä½¿ç”¨è¦†ç›–ç´¢å¼•
SELECT user_id, status, total_amount 
FROM orders 
WHERE user_id = 123;  -- éœ€è¦å»ºç«‹è¦†ç›–ç´¢å¼•: (user_id, status, total_amount)
```

### å¤§æ•°æ®é‡å¤„ç†è§„èŒƒ
```sql
-- âœ… åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡æ“ä½œ
-- åˆ†æ‰¹åˆ é™¤
DELETE FROM log_table 
WHERE create_time < '2023-01-01' 
    AND is_deleted = 0
LIMIT 1000;

-- âœ… ä½¿ç”¨ä¸´æ—¶è¡¨ä¼˜åŒ–å¤æ‚æŸ¥è¯¢
CREATE TEMPORARY TABLE temp_user_stats AS
SELECT user_id, COUNT(*) as order_count
FROM orders 
WHERE create_time >= '2024-01-01'
GROUP BY user_id;

-- ç„¶åä½¿ç”¨ä¸´æ—¶è¡¨JOIN
SELECT u.username, t.order_count
FROM user_info u
INNER JOIN temp_user_stats t ON u.id = t.user_id;
```

## ğŸ”’ å®‰å…¨è§„èŒƒ

### SQLæ³¨å…¥é˜²æŠ¤
```sql
-- MUST: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ (åœ¨MyBatisä¸­)
<!-- âœ… æ­£ç¡®ç¤ºä¾‹ -->
<select id="findByUsername" parameterType="string" resultType="User">
    SELECT id, username, email 
    FROM user_info 
    WHERE username = #{username} 
        AND is_deleted = 0
</select>

<!-- âŒ é”™è¯¯ç¤ºä¾‹ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ -->
<select id="findByUsername" parameterType="string" resultType="User">
    SELECT id, username, email 
    FROM user_info 
    WHERE username = '${username}'
</select>
```

### æƒé™æ§åˆ¶
```sql
-- MUST: åº”ç”¨å±‚æƒé™æ§åˆ¶
-- æ¯ä¸ªæŸ¥è¯¢éƒ½åº”è¯¥åŒ…å«æƒé™è¿‡æ»¤æ¡ä»¶
SELECT o.* 
FROM orders o
INNER JOIN user_info u ON o.user_id = u.id
WHERE u.tenant_id = #{currentUserTenantId}  -- ç§Ÿæˆ·éš”ç¦»
    AND o.is_deleted = 0;
```

### æ•æ„Ÿæ•°æ®å¤„ç†
```sql
-- SHOULD: æ•æ„Ÿæ•°æ®è„±æ•æŸ¥è¯¢
SELECT 
    id,
    username,
    CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) AS phone_masked,
    CONCAT(LEFT(email, 2), '***', SUBSTRING(email, LOCATE('@', email))) AS email_masked
FROM user_info
WHERE id = #{userId};
```

## ğŸ“Š äº‹åŠ¡å¤„ç†è§„èŒƒ

### äº‹åŠ¡ä½¿ç”¨åŸåˆ™
```sql
-- âœ… æ­£ç¡®çš„äº‹åŠ¡ä½¿ç”¨
START TRANSACTION;

-- ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥åº“å­˜
SELECT stock_quantity 
FROM product_inventory 
WHERE product_id = 123 
    AND warehouse_id = 1
FOR UPDATE;

-- ç¬¬äºŒæ­¥ï¼šæ‰£å‡åº“å­˜
UPDATE product_inventory 
SET stock_quantity = stock_quantity - 5,
    update_time = NOW()
WHERE product_id = 123 
    AND warehouse_id = 1
    AND stock_quantity >= 5;

-- ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºè®¢å•
INSERT INTO orders (user_id, product_id, quantity, status, create_time)
VALUES (456, 123, 5, 'pending', NOW());

COMMIT;
```

### æ­»é”é¿å…
```sql
-- MUST: æŒ‰å›ºå®šé¡ºåºè®¿é—®èµ„æºé¿å…æ­»é”
-- æ€»æ˜¯æŒ‰ç…§ id é¡ºåºé”å®šè®°å½•
UPDATE accounts 
SET balance = balance - 100 
WHERE id = LEAST(#{fromAccountId}, #{toAccountId});

UPDATE accounts 
SET balance = balance + 100 
WHERE id = GREATEST(#{fromAccountId}, #{toAccountId});
```

## ğŸ” MyBatisé›†æˆè§„èŒƒ

### XMLæ˜ å°„æ–‡ä»¶è§„èŒƒ
```xml
<!-- âœ… æ ‡å‡†çš„MyBatisæ˜ å°„æ–‡ä»¶ç»“æ„ -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.org.bjca.footstone.mapper.UserMapper">
    
    <!-- ç»“æœæ˜ å°„ -->
    <resultMap id="UserResultMap" type="cn.org.bjca.footstone.entity.User">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="username" property="username" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    </resultMap>
    
    <!-- åŸºç¡€æŸ¥è¯¢ -->
    <select id="findById" parameterType="long" resultMap="UserResultMap">
        SELECT id, username, email, create_time
        FROM user_info
        WHERE id = #{id} 
            AND is_deleted = 0
    </select>
    
    <!-- åŠ¨æ€æŸ¥è¯¢ -->
    <select id="findByCondition" parameterType="UserQuery" resultMap="UserResultMap">
        SELECT id, username, email, create_time
        FROM user_info
        WHERE is_deleted = 0
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
</mapper>
```

## ğŸ“ˆ ç›‘æ§å’Œè°ƒè¯•

### SQLæ‰§è¡Œç›‘æ§
```sql
-- MUST: ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
-- åœ¨MySQLé…ç½®ä¸­è®¾ç½®
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

-- SHOULD: ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN FORMAT=JSON 
SELECT u.username, COUNT(o.id) as order_count
FROM user_info u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.create_time >= '2024-01-01'
GROUP BY u.id
ORDER BY order_count DESC;
```

## ğŸ·ï¸ ä»£ç æ³¨é‡Šè§„èŒƒ

```sql
-- [AI-BLOCK-START] - ç”Ÿæˆå·¥å…·: Claude 3.5 Sonnet
/**
 * ç”¨æˆ·è®¢å•ç»Ÿè®¡æŸ¥è¯¢
 * åŠŸèƒ½ï¼šæŸ¥è¯¢æŒ‡å®šæ—¶é—´æ®µå†…ç”¨æˆ·çš„è®¢å•ç»Ÿè®¡ä¿¡æ¯
 * æ€§èƒ½ï¼šä½¿ç”¨ç´¢å¼• idx_orders_user_create_time
 * æ³¨æ„ï¼šç»“æœæŒ‰è®¢å•æ•°é‡é™åºæ’åˆ—
 */
SELECT 
    u.id,
    u.username,
    COUNT(o.id) as order_count,
    SUM(o.total_amount) as total_amount
FROM user_info u
LEFT JOIN orders o ON u.id = o.user_id 
    AND o.create_time >= #{startTime}
    AND o.create_time <= #{endTime}
    AND o.is_deleted = 0
WHERE u.is_deleted = 0
GROUP BY u.id, u.username
HAVING order_count > 0
ORDER BY order_count DESC
LIMIT #{limit};
-- [AI-BLOCK-END]
```

## âœ… æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µæ£€æŸ¥
- [ ] SQLè¯­å¥ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- [ ] æŸ¥è¯¢æ¡ä»¶åŒ…å«å¿…è¦çš„ç´¢å¼•å­—æ®µ
- [ ] é¿å…ä½¿ç”¨SELECT *
- [ ] æ›´æ–°/åˆ é™¤æ“ä½œåŒ…å«WHEREæ¡ä»¶
- [ ] äº‹åŠ¡èŒƒå›´æœ€å°åŒ–

### ä¸Šçº¿å‰æ£€æŸ¥
- [ ] æ‰§è¡ŒEXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
- [ ] æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—
- [ ] éªŒè¯ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- [ ] æµ‹è¯•å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½
- [ ] ç¡®è®¤æ•°æ®å®‰å…¨å’Œæƒé™æ§åˆ¶

---
*éµå¾ªä»¥ä¸ŠSQLè§„èŒƒï¼Œç¡®ä¿æ•°æ®åº“æ“ä½œçš„å®‰å…¨æ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§*
description:
globs:
alwaysApply: false
---
