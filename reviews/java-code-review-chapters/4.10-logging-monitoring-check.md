### 4.10 æ—¥å¿—ç›‘æ§æ£€æŸ¥

#### 4.10.1 æ—¥å¿—è§„èŒƒ ğŸ”´

##### 4.10.1.1 æ—¥å¿—æ¡†æ¶é…ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ¡†æ¶ï¼ˆSLF4J + Logbackï¼‰
b. æ—¥å¿—çº§åˆ«ä½¿ç”¨å¿…é¡»åˆç†ï¼ˆDEBUG/INFO/WARN/ERRORï¼‰
c. æ—¥å¿—æ ¼å¼å¿…é¡»ç»“æ„åŒ–ï¼Œæ”¯æŒæ£€ç´¢å’Œåˆ†æ
d. æ•æ„Ÿä¿¡æ¯ä¸èƒ½å‡ºç°åœ¨æ—¥å¿—ä¸­
e. å¿…é¡»åŒ…å«é“¾è·¯è¿½è¸ªä¿¡æ¯ï¼ˆtraceIdï¼‰
f. æ—¥å¿—æ–‡ä»¶å¿…é¡»æ”¯æŒæ»šåŠ¨å’Œå½’æ¡£

**2. æ£€æµ‹æ–¹æ³•**

a. é…ç½®å®¡æŸ¥ï¼šæ£€æŸ¥æ—¥å¿—é…ç½®æ–‡ä»¶
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ—¥å¿—ä½¿ç”¨è§„èŒƒ
c. å®‰å…¨æ£€æŸ¥ï¼šç¡®è®¤æ•æ„Ÿä¿¡æ¯ä¸æ³„éœ²
d. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯æ—¥å¿—å¯¹æ€§èƒ½çš„å½±å“

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨System.outè¾“å‡ºæ—¥å¿—
public class UserService {
    public User createUser(UserRequest request) {
        System.out.println("Creating user: " + request.getUsername()); // é”™è¯¯
        
        User user = new User();
        user.setUsername(request.getUsername());
        user.setPassword(request.getPassword()); // æ•æ„Ÿä¿¡æ¯
        
        System.out.println("User created: " + user); // å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯
        return userRepository.save(user);
    }
}

// âŒ é”™è¯¯ï¼šæ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸å½“
@Service
public class OrderService {
    private static final Logger log = LoggerFactory.getLogger(OrderService.class);
    
    public void processOrder(Order order) {
        log.error("Processing order: {}", order.getId()); // æ­£å¸¸æµç¨‹ä¸åº”è¯¥ç”¨ERROR
        
        if (order.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            log.info("Invalid order amount"); // é”™è¯¯æƒ…å†µåº”è¯¥ç”¨WARNæˆ–ERROR
        }
        
        log.debug("Order processed successfully"); // é‡è¦ä¿¡æ¯åº”è¯¥ç”¨INFO
    }
}

// âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²æ‹¼æ¥å’Œæ€§èƒ½é—®é¢˜
public class PaymentService {
    private static final Logger log = LoggerFactory.getLogger(PaymentService.class);
    
    public void processPayment(PaymentRequest request) {
        // å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæ€§èƒ½å·®
        log.info("Processing payment for order: " + request.getOrderId() + 
                 ", amount: " + request.getAmount());
        
        // æ²¡æœ‰æ£€æŸ¥æ—¥å¿—çº§åˆ«ï¼Œå¯èƒ½æœ‰æ€§èƒ½é—®é¢˜
        log.debug("Payment details: " + expensiveToStringMethod(request));
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šè§„èŒƒçš„æ—¥å¿—ä½¿ç”¨
@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    public User createUser(UserRequest request) {
        String traceId = MDC.get("traceId");
        
        log.info("Creating user: username={}, traceId={}", 
            request.getUsername(), traceId);
        
        try {
            User user = new User();
            user.setUsername(request.getUsername());
            user.setPasswordHash(passwordEncoder.encode(request.getPassword()));
            
            User savedUser = userRepository.save(user);
            
            // æ­£ç¡®ï¼šä¸è®°å½•æ•æ„Ÿä¿¡æ¯ï¼Œä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
            log.info("User created successfully: userId={}, username={}, traceId={}", 
                savedUser.getId(), savedUser.getUsername(), traceId);
                
            return savedUser;
            
        } catch (DataIntegrityViolationException e) {
            log.warn("User creation failed - duplicate username: username={}, traceId={}", 
                request.getUsername(), traceId);
            throw new BusinessException("USERNAME_EXISTS", "ç”¨æˆ·åå·²å­˜åœ¨");
            
        } catch (Exception e) {
            log.error("System error creating user: username={}, traceId={}", 
                request.getUsername(), traceId, e);
            throw new SystemException("USER_CREATION_ERROR", 
                "ç”¨æˆ·åˆ›å»ºå¤±è´¥", "System error creating user", e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šåˆç†çš„æ—¥å¿—çº§åˆ«ä½¿ç”¨
@Service
public class OrderService {
    private static final Logger log = LoggerFactory.getLogger(OrderService.class);
    
    public OrderResult processOrder(Order order) {
        String traceId = MDC.get("traceId");
        
        // INFOï¼šé‡è¦çš„ä¸šåŠ¡æµç¨‹
        log.info("Processing order: orderId={}, amount={}, traceId={}", 
            order.getId(), order.getAmount(), traceId);
        
        // å‚æ•°éªŒè¯
        if (order.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            // WARNï¼šä¸šåŠ¡è§„åˆ™è¿å
            log.warn("Invalid order amount: orderId={}, amount={}, traceId={}", 
                order.getId(), order.getAmount(), traceId);
            throw new BusinessException("INVALID_AMOUNT", "è®¢å•é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        try {
            // DEBUGï¼šè¯¦ç»†çš„å¤„ç†æ­¥éª¤ï¼ˆä»…åœ¨éœ€è¦æ—¶å¯ç”¨ï¼‰
            if (log.isDebugEnabled()) {
                log.debug("Validating order details: orderId={}, traceId={}", 
                    order.getId(), traceId);
            }
            
            OrderResult result = doProcessOrder(order);
            
            // INFOï¼šæˆåŠŸå®Œæˆçš„é‡è¦æ“ä½œ
            log.info("Order processed successfully: orderId={}, resultId={}, traceId={}", 
                order.getId(), result.getId(), traceId);
                
            return result;
            
        } catch (InsufficientInventoryException e) {
            // WARNï¼šé¢„æœŸçš„ä¸šåŠ¡å¼‚å¸¸
            log.warn("Order processing failed - insufficient inventory: orderId={}, productId={}, traceId={}", 
                order.getId(), e.getProductId(), traceId);
            throw e;
            
        } catch (Exception e) {
            // ERRORï¼šæ„å¤–çš„ç³»ç»Ÿå¼‚å¸¸
            log.error("System error processing order: orderId={}, traceId={}", 
                order.getId(), traceId, e);
            throw new SystemException("ORDER_PROCESSING_ERROR", 
                "è®¢å•å¤„ç†å¤±è´¥", "System error processing order", e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šæ€§èƒ½ä¼˜åŒ–çš„æ—¥å¿—è®°å½•
@Service
public class PaymentService {
    private static final Logger log = LoggerFactory.getLogger(PaymentService.class);
    
    public PaymentResult processPayment(PaymentRequest request) {
        String traceId = MDC.get("traceId");
        
        // æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æ—¥å¿—ï¼Œé¿å…å­—ç¬¦ä¸²æ‹¼æ¥
        log.info("Processing payment: orderId={}, amount={}, gateway={}, traceId={}", 
            request.getOrderId(), request.getAmount(), request.getGateway(), traceId);
        
        // æ­£ç¡®ï¼šæ£€æŸ¥æ—¥å¿—çº§åˆ«ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—
        if (log.isDebugEnabled()) {
            log.debug("Payment request details: {}, traceId={}", 
                toSafeString(request), traceId);
        }
        
        try {
            PaymentResult result = paymentGateway.charge(request);
            
            log.info("Payment processed successfully: orderId={}, transactionId={}, traceId={}", 
                request.getOrderId(), result.getTransactionId(), traceId);
                
            return result;
            
        } catch (PaymentGatewayException e) {
            log.warn("Payment failed: orderId={}, errorCode={}, message={}, traceId={}", 
                request.getOrderId(), e.getErrorCode(), e.getMessage(), traceId);
            throw e;
            
        } catch (Exception e) {
            log.error("System error during payment: orderId={}, traceId={}", 
                request.getOrderId(), traceId, e);
            throw new SystemException("PAYMENT_SYSTEM_ERROR", 
                "æ”¯ä»˜ç³»ç»Ÿå¼‚å¸¸", "Payment system error", e);
        }
    }
    
    private String toSafeString(PaymentRequest request) {
        // å®‰å…¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
        return String.format("PaymentRequest{orderId=%s, amount=%s, gateway=%s}", 
            request.getOrderId(), request.getAmount(), request.getGateway());
    }
}
```

##### 4.10.1.2 æ—¥å¿—å†…å®¹è§„èŒƒæ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼
b. æ•æ„Ÿä¿¡æ¯ä¸èƒ½å‡ºç°åœ¨æ—¥å¿—ä¸­
c. å¿…é¡»åŒ…å«é“¾è·¯è¿½è¸ªä¿¡æ¯
d. æ—¥å¿—å†…å®¹è¦æœ‰æ˜ç¡®çš„ä¸šåŠ¡å«ä¹‰
e. å¼‚å¸¸æ—¥å¿—è¦åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ—¥å¿—å†…å®¹æ ¼å¼
b. å®‰å…¨å®¡æŸ¥ï¼šç¡®è®¤æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
c. é“¾è·¯è¿½è¸ªéªŒè¯ï¼šç¡®è®¤traceIdå­˜åœ¨
d. æ—¥å¿—åˆ†æï¼šéªŒè¯æ—¥å¿—å¯è¯»æ€§å’Œæœ‰ç”¨æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ—¥å¿—å†…å®¹ä¸è§„èŒƒ
@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    public User createUser(CreateUserRequest request) {
        // é”™è¯¯ï¼šåŒ…å«æ•æ„Ÿä¿¡æ¯
        log.info("Creating user with password: {}", request.getPassword());
        
        // é”™è¯¯ï¼šæ²¡æœ‰traceIdï¼Œä¿¡æ¯ä¸å®Œæ•´
        log.info("User created");
        
        // é”™è¯¯ï¼šå¼‚å¸¸æ—¥å¿—ç¼ºå°‘ä¸Šä¸‹æ–‡
        try {
            return userRepository.save(user);
        } catch (Exception e) {
            log.error("Error: {}", e.getMessage());
            throw e;
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šè§„èŒƒçš„æ—¥å¿—å†…å®¹
@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    public User createUser(CreateUserRequest request) {
        String traceId = MDC.get("traceId");
        
        // æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—ï¼Œä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
        log.info("Creating user: username={}, email={}, traceId={}", 
            request.getUsername(), 
            maskEmail(request.getEmail()), 
            traceId);
        
        try {
            User user = buildUser(request);
            User savedUser = userRepository.save(user);
            
            // æ­£ç¡®ï¼šåŒ…å«ä¸šåŠ¡å…³é”®ä¿¡æ¯å’ŒtraceId
            log.info("User created successfully: userId={}, username={}, traceId={}", 
                savedUser.getId(), savedUser.getUsername(), traceId);
                
            return savedUser;
            
        } catch (DataIntegrityViolationException e) {
            // æ­£ç¡®ï¼šä¸šåŠ¡å¼‚å¸¸ï¼ŒåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
            log.warn("User creation failed - duplicate username: username={}, traceId={}", 
                request.getUsername(), traceId);
            throw new BusinessException("USERNAME_EXISTS", "ç”¨æˆ·åå·²å­˜åœ¨");
            
        } catch (Exception e) {
            // æ­£ç¡®ï¼šç³»ç»Ÿå¼‚å¸¸ï¼ŒåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡å’Œå¼‚å¸¸å †æ ˆ
            log.error("System error creating user: username={}, traceId={}", 
                request.getUsername(), traceId, e);
            throw new SystemException("USER_CREATION_ERROR", 
                "ç”¨æˆ·åˆ›å»ºå¤±è´¥", "System error creating user", e);
        }
    }
    
    private String maskEmail(String email) {
        if (email == null || !email.contains("@")) {
            return "***";
        }
        String[] parts = email.split("@");
        return parts[0].substring(0, 1) + "***@" + parts[1];
    }
}
```

##### 4.10.1.3 æ—¥å¿—çº§åˆ«ä½¿ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»åˆç†ä½¿ç”¨ä¸åŒæ—¥å¿—çº§åˆ«
b. é¿å…æ—¥å¿—çº§åˆ«æ»¥ç”¨å½±å“æ€§èƒ½
c. ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«é…ç½®åˆç†
d. è°ƒè¯•æ—¥å¿—è¦æœ‰çº§åˆ«æ£€æŸ¥
e. æ—¥å¿—è¾“å‡ºè¦è€ƒè™‘æ€§èƒ½å½±å“

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ—¥å¿—çº§åˆ«ä½¿ç”¨
b. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯æ—¥å¿—å¯¹æ€§èƒ½å½±å“
c. é…ç½®æ£€æŸ¥ï¼šç¡®è®¤ç”Ÿäº§ç¯å¢ƒé…ç½®
d. é™æ€åˆ†æï¼šæ£€æŸ¥æ—¥å¿—çº§åˆ«åˆ¤æ–­

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸å½“
@Service
public class OrderService {
    private static final Logger log = LoggerFactory.getLogger(OrderService.class);
    
    public OrderResult processOrder(Order order) {
        // é”™è¯¯ï¼šæ™®é€šä¸šåŠ¡æµç¨‹ä½¿ç”¨ERRORçº§åˆ«
        log.error("Processing order: {}", order.getId());
        
        // é”™è¯¯ï¼šDEBUGä¿¡æ¯ä½¿ç”¨INFOçº§åˆ«ï¼Œç”Ÿäº§ç¯å¢ƒä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—
        log.info("Order validation step 1: checking amount");
        log.info("Order validation step 2: checking inventory");
        log.info("Order validation step 3: checking user status");
        
        // é”™è¯¯ï¼šæ²¡æœ‰çº§åˆ«æ£€æŸ¥ï¼Œå­—ç¬¦ä¸²æ‹¼æ¥å½±å“æ€§èƒ½
        log.debug("Order details: " + order.toString() + ", complex calculation: " + 
            complexCalculation(order));
        
        // é”™è¯¯ï¼šä¸šåŠ¡å¼‚å¸¸ä½¿ç”¨ERRORçº§åˆ«
        if (order.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            log.error("Invalid order amount: {}", order.getAmount());
        }
        
        return processOrderInternal(order);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šåˆç†çš„æ—¥å¿—çº§åˆ«ä½¿ç”¨
@Service
public class OrderService {
    private static final Logger log = LoggerFactory.getLogger(OrderService.class);
    
    public OrderResult processOrder(Order order) {
        String traceId = MDC.get("traceId");
        
        // æ­£ç¡®ï¼šé‡è¦ä¸šåŠ¡æµç¨‹ä½¿ç”¨INFOçº§åˆ«
        log.info("Processing order: orderId={}, amount={}, traceId={}", 
            order.getId(), order.getAmount(), traceId);
        
        // æ­£ç¡®ï¼šè¯¦ç»†è°ƒè¯•ä¿¡æ¯ä½¿ç”¨DEBUGçº§åˆ«ï¼Œå¹¶æ£€æŸ¥çº§åˆ«
        if (log.isDebugEnabled()) {
            log.debug("Order validation details: orderId={}, traceId={}", 
                order.getId(), traceId);
        }
        
        // æ­£ç¡®ï¼šå‚æ•°éªŒè¯å¤±è´¥ä½¿ç”¨WARNçº§åˆ«
        if (order.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            log.warn("Invalid order amount: orderId={}, amount={}, traceId={}", 
                order.getId(), order.getAmount(), traceId);
            throw new BusinessException("INVALID_AMOUNT", "è®¢å•é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        try {
            // æ­£ç¡®ï¼šæ€§èƒ½æ•æ„Ÿçš„è°ƒè¯•æ—¥å¿—è¦æ£€æŸ¥çº§åˆ«
            if (log.isDebugEnabled()) {
                log.debug("Starting order processing: orderId={}, details={}, traceId={}", 
                    order.getId(), toSafeString(order), traceId);
            }
            
            OrderResult result = processOrderInternal(order);
            
            // æ­£ç¡®ï¼šæˆåŠŸå®Œæˆçš„é‡è¦æ“ä½œä½¿ç”¨INFOçº§åˆ«
            log.info("Order processed successfully: orderId={}, resultId={}, traceId={}", 
                order.getId(), result.getId(), traceId);
                
            return result;
            
        } catch (InsufficientInventoryException e) {
            // æ­£ç¡®ï¼šé¢„æœŸçš„ä¸šåŠ¡å¼‚å¸¸ä½¿ç”¨WARNçº§åˆ«
            log.warn("Order processing failed - insufficient inventory: orderId={}, productId={}, traceId={}", 
                order.getId(), e.getProductId(), traceId);
            throw e;
            
        } catch (Exception e) {
            // æ­£ç¡®ï¼šæ„å¤–çš„ç³»ç»Ÿå¼‚å¸¸ä½¿ç”¨ERRORçº§åˆ«
            log.error("System error processing order: orderId={}, traceId={}", 
                order.getId(), traceId, e);
            throw new SystemException("ORDER_PROCESSING_ERROR", 
                "è®¢å•å¤„ç†å¤±è´¥", "System error processing order", e);
        }
    }
    
    private String toSafeString(Order order) {
        // å®‰å…¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œé¿å…æ•æ„Ÿä¿¡æ¯
        return String.format("Order{id=%s, amount=%s, status=%s}", 
            order.getId(), order.getAmount(), order.getStatus());
    }
}

// âœ… æ­£ç¡®ï¼šæ—¥å¿—é…ç½®ä¼˜åŒ–
// logback-spring.xml
<configuration>
    <springProfile name="prod">
        <!-- ç”Ÿäº§ç¯å¢ƒï¼šåªè®°å½•INFOåŠä»¥ä¸Šçº§åˆ« -->
        <root level="INFO">
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>
    
    <springProfile name="dev">
        <!-- å¼€å‘ç¯å¢ƒï¼šè®°å½•DEBUGåŠä»¥ä¸Šçº§åˆ« -->
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
    
    <!-- å¼‚æ­¥æ—¥å¿—é…ç½®ï¼Œæé«˜æ€§èƒ½ -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="FILE"/>
        <queueSize>1024</queueSize>
        <discardingThreshold>0</discardingThreshold>
    </appender>
</configuration>
```

#### 4.10.2 ç›‘æ§æŒ‡æ ‡è®¾ç½® ğŸŸ¡

##### 4.10.2.1 åº”ç”¨æ€§èƒ½ç›‘æ§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ç›‘æ§æ¥å£å“åº”æ—¶é—´å’Œååé‡
b. å¿…é¡»ç›‘æ§åº”ç”¨é”™è¯¯ç‡å’Œå¼‚å¸¸ç»Ÿè®¡
c. å¿…é¡»é›†æˆAPMå·¥å…·è¿›è¡Œé“¾è·¯è¿½è¸ª
d. å…³é”®ä¸šåŠ¡æµç¨‹å¿…é¡»æœ‰æ€§èƒ½åŸ‹ç‚¹
e. å¿…é¡»ç›‘æ§JVMæ€§èƒ½æŒ‡æ ‡

**2. æ£€æµ‹æ–¹æ³•**

a. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯ç›‘æ§æŒ‡æ ‡å‡†ç¡®æ€§
b. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯é«˜è´Ÿè½½ä¸‹ç›‘æ§æœ‰æ•ˆæ€§
c. é“¾è·¯è¿½è¸ªï¼šæ£€æŸ¥åˆ†å¸ƒå¼è°ƒç”¨é“¾å®Œæ•´æ€§
d. æŒ‡æ ‡éªŒè¯ï¼šç¡®è®¤å…³é”®æŒ‡æ ‡æ­£å¸¸æ”¶é›†

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ€§èƒ½ç›‘æ§
@RestController
public class OrderController {
    @PostMapping("/orders")
    public OrderResult createOrder(@RequestBody OrderRequest request) {
        // æ²¡æœ‰ä»»ä½•æ€§èƒ½ç›‘æ§æŒ‡æ ‡
        return orderService.createOrder(request);
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰å¼‚å¸¸ç»Ÿè®¡
@Service
public class PaymentService {
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            return paymentGateway.charge(request);
        } catch (Exception e) {
            // æ²¡æœ‰å¼‚å¸¸ç›‘æ§ç»Ÿè®¡
            throw e;
        }
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰JVMç›‘æ§
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        // æ²¡æœ‰é…ç½®JVMç›‘æ§
        SpringApplication.run(Application.class, args);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„åº”ç”¨æ€§èƒ½ç›‘æ§
@RestController
public class OrderController {
    private final MeterRegistry meterRegistry;
    private final Counter orderCreateCounter;
    private final Timer orderCreateTimer;
    private final Counter errorCounter;
    
    public OrderController(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.orderCreateCounter = Counter.builder("order.create.total")
            .description("Total order creation attempts")
            .register(meterRegistry);
        this.orderCreateTimer = Timer.builder("order.create.duration")
            .description("Order creation duration")
            .register(meterRegistry);
        this.errorCounter = Counter.builder("order.create.errors")
            .description("Order creation errors")
            .register(meterRegistry);
    }
    
    @PostMapping("/orders")
    @Timed(value = "order.create", description = "Order creation time")
    public ResponseEntity<OrderResult> createOrder(@RequestBody OrderRequest request) {
        Timer.Sample sample = Timer.Sample.start(meterRegistry);
        
        try {
            OrderResult result = orderService.createOrder(request);
            
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            orderCreateCounter.increment(Tags.of("status", "success"));
            meterRegistry.gauge("order.amount", result.getAmount().doubleValue());
            
            // è®°å½•å“åº”æ—¶é—´
            sample.stop(orderCreateTimer);
            
            return ResponseEntity.ok(result);
            
        } catch (BusinessException e) {
            // è®°å½•ä¸šåŠ¡å¼‚å¸¸
            orderCreateCounter.increment(Tags.of(
                "status", "business_error",
                "error_code", e.getErrorCode()
            ));
            errorCounter.increment(Tags.of(
                "type", "business",
                "code", e.getErrorCode()
            ));
            sample.stop(orderCreateTimer);
            throw e;
            
        } catch (Exception e) {
            // è®°å½•ç³»ç»Ÿå¼‚å¸¸
            orderCreateCounter.increment(Tags.of(
                "status", "system_error",
                "exception", e.getClass().getSimpleName()
            ));
            errorCounter.increment(Tags.of(
                "type", "system",
                "exception", e.getClass().getSimpleName()
            ));
            sample.stop(orderCreateTimer);
            throw e;
        }
    }
    
    @GetMapping("/orders/{id}")
    @Timed(value = "order.query", description = "Order query time")
    public ResponseEntity<Order> getOrder(@PathVariable Long id) {
        Timer.Sample sample = Timer.Sample.start(meterRegistry);
        
        try {
            Order order = orderService.getOrder(id);
            
            // è®°å½•æŸ¥è¯¢æˆåŠŸ
            meterRegistry.counter("order.query.total", 
                "status", "success").increment();
            sample.stop(meterRegistry.timer("order.query.duration"));
            
            return ResponseEntity.ok(order);
            
        } catch (Exception e) {
            // è®°å½•æŸ¥è¯¢å¤±è´¥
            meterRegistry.counter("order.query.total", 
                "status", "error",
                "exception", e.getClass().getSimpleName()).increment();
            sample.stop(meterRegistry.timer("order.query.duration"));
            throw e;
        }
    }
}

// âœ… æ­£ç¡®ï¼šJVMå’Œåº”ç”¨ç›‘æ§é…ç½®
@Configuration
@EnableConfigurationProperties
public class MonitoringConfiguration {
    
    @Bean
    public MeterRegistry meterRegistry() {
        return new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);
    }
    
    @Bean
    public JvmMetrics jvmMetrics() {
        return new JvmMetrics();
    }
    
    @Bean
    public ProcessorMetrics processorMetrics() {
        return new ProcessorMetrics();
    }
    
    @Bean
    public UptimeMetrics uptimeMetrics() {
        return new UptimeMetrics();
    }
    
    @Bean
    @ConditionalOnMissingBean
    public TimedAspect timedAspect(MeterRegistry registry) {
        return new TimedAspect(registry);
    }
    
    @EventListener
    public void bindMetrics(ApplicationReadyEvent event) {
        MeterRegistry registry = event.getApplicationContext()
            .getBean(MeterRegistry.class);
            
        // ç»‘å®šJVMæŒ‡æ ‡
        new JvmGcMetrics().bindTo(registry);
        new JvmMemoryMetrics().bindTo(registry);
        new JvmThreadMetrics().bindTo(registry);
        new ClassLoaderMetrics().bindTo(registry);
        
        // ç»‘å®šç³»ç»ŸæŒ‡æ ‡
        new ProcessorMetrics().bindTo(registry);
        new UptimeMetrics().bindTo(registry);
        new FileDescriptorMetrics().bindTo(registry);
        
        // ç»‘å®šæ•°æ®åº“è¿æ¥æ± æŒ‡æ ‡
        DataSource dataSource = event.getApplicationContext()
            .getBean(DataSource.class);
        new DataSourcePoolMetrics(dataSource, "hikari", 
            Collections.emptyList()).bindTo(registry);
    }
}

// âœ… æ­£ç¡®ï¼šå¼‚å¸¸ç»Ÿè®¡å’Œæ€§èƒ½ç›‘æ§
@Service
public class PaymentService {
    private final MeterRegistry meterRegistry;
    private final Timer paymentTimer;
    private final Counter paymentCounter;
    private final Counter paymentErrorCounter;
    private final Gauge activePayments;
    
    public PaymentService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.paymentTimer = Timer.builder("payment.gateway.duration")
            .description("Payment gateway call duration")
            .register(meterRegistry);
        this.paymentCounter = Counter.builder("payment.gateway.total")
            .description("Payment gateway call total")
            .register(meterRegistry);
        this.paymentErrorCounter = Counter.builder("payment.errors.total")
            .description("Payment errors count")
            .register(meterRegistry);
        this.activePayments = Gauge.builder("payment.active.count")
            .description("Active payment processes")
            .register(meterRegistry, this, PaymentService::getActivePaymentCount);
    }
    
    @NewSpan("payment-process")
    public PaymentResult processPayment(PaymentRequest request) {
        Timer.Sample sample = Timer.Sample.start(meterRegistry);
        
        try {
            // å¢åŠ æ´»è·ƒæ”¯ä»˜è®¡æ•°
            meterRegistry.gauge("payment.active.count", getActivePaymentCount() + 1);
            
            PaymentResult result = paymentGateway.charge(request);
            
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            paymentCounter.increment(Tags.of(
                "status", "success",
                "gateway", request.getGateway(),
                "amount_range", getAmountRange(request.getAmount())
            ));
            
            // è®°å½•é‡‘é¢æŒ‡æ ‡
            meterRegistry.gauge("payment.amount", 
                Tags.of("gateway", request.getGateway()),
                request.getAmount().doubleValue());
            
            // è®°å½•å“åº”æ—¶é—´åˆ†å¸ƒ
            sample.stop(Timer.builder("payment.duration")
                .tag("gateway", request.getGateway())
                .tag("status", "success")
                .register(meterRegistry));
            
            return result;
            
        } catch (PaymentTimeoutException e) {
            // è®°å½•è¶…æ—¶å¼‚å¸¸
            paymentCounter.increment(Tags.of(
                "status", "timeout",
                "gateway", request.getGateway()
            ));
            paymentErrorCounter.increment(Tags.of(
                "type", "timeout",
                "gateway", request.getGateway()
            ));
            sample.stop(Timer.builder("payment.duration")
                .tag("gateway", request.getGateway())
                .tag("status", "timeout")
                .register(meterRegistry));
            throw e;
            
        } catch (PaymentException e) {
            // è®°å½•æ”¯ä»˜å¤±è´¥
            paymentCounter.increment(Tags.of(
                "status", "failed",
                "gateway", request.getGateway(),
                "error_code", e.getErrorCode()
            ));
            paymentErrorCounter.increment(Tags.of(
                "type", "business",
                "gateway", request.getGateway(),
                "error_code", e.getErrorCode()
            ));
            sample.stop(Timer.builder("payment.duration")
                .tag("gateway", request.getGateway())
                .tag("status", "failed")
                .register(meterRegistry));
            throw e;
            
        } catch (Exception e) {
            // è®°å½•ç³»ç»Ÿå¼‚å¸¸
            paymentCounter.increment(Tags.of(
                "status", "error",
                "gateway", request.getGateway(),
                "exception", e.getClass().getSimpleName()
            ));
            paymentErrorCounter.increment(Tags.of(
                "type", "system",
                "gateway", request.getGateway(),
                "exception", e.getClass().getSimpleName()
            ));
            sample.stop(Timer.builder("payment.duration")
                .tag("gateway", request.getGateway())
                .tag("status", "error")
                .register(meterRegistry));
            throw e;
            
        } finally {
            // å‡å°‘æ´»è·ƒæ”¯ä»˜è®¡æ•°
            meterRegistry.gauge("payment.active.count", getActivePaymentCount() - 1);
        }
    }
    
    private String getAmountRange(BigDecimal amount) {
        if (amount.compareTo(BigDecimal.valueOf(100)) <= 0) {
            return "small";
        } else if (amount.compareTo(BigDecimal.valueOf(1000)) <= 0) {
            return "medium";
        } else {
            return "large";
        }
    }
    
    private double getActivePaymentCount() {
        // å®é™…å®ç°ä¸­åº”è¯¥è¿”å›çœŸå®çš„æ´»è·ƒæ”¯ä»˜æ•°é‡
        return 0.0;
    }
}
```

##### 4.10.2.2 ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ç›‘æ§æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡ï¼ˆè®¢å•é‡ã€æ”¯ä»˜æˆåŠŸç‡ã€ç”¨æˆ·æ´»è·ƒåº¦ï¼‰
b. å¿…é¡»ç›‘æ§ä¸šåŠ¡æµç¨‹å…³é”®èŠ‚ç‚¹çš„è½¬åŒ–ç‡
c. å¿…é¡»ç›‘æ§ä¸šåŠ¡å¼‚å¸¸å’Œé”™è¯¯åˆ†å¸ƒ
d. å¿…é¡»æ”¯æŒä¸šåŠ¡æŒ‡æ ‡çš„å®æ—¶ç»Ÿè®¡å’Œè¶‹åŠ¿åˆ†æ
e. å¿…é¡»è®¾ç½®ä¸šåŠ¡æŒ‡æ ‡çš„é˜ˆå€¼å‘Šè­¦

**2. æ£€æµ‹æ–¹æ³•**

a. ä¸šåŠ¡æµ‹è¯•ï¼šéªŒè¯ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡å‡†ç¡®æ€§
b. æµç¨‹æµ‹è¯•ï¼šéªŒè¯ä¸šåŠ¡æµç¨‹ç›‘æ§å®Œæ•´æ€§
c. å¼‚å¸¸æµ‹è¯•ï¼šéªŒè¯ä¸šåŠ¡å¼‚å¸¸ç»Ÿè®¡æ­£ç¡®æ€§
d. å‘Šè­¦æµ‹è¯•ï¼šéªŒè¯ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦åŠæ—¶æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
@Service
public class OrderService {
    public OrderResult createOrder(OrderRequest request) {
        // æ²¡æœ‰è®¢å•åˆ›å»ºæŒ‡æ ‡ç»Ÿè®¡
        Order order = new Order(request);
        orderRepository.save(order);
        return new OrderResult(order);
    }
    
    public void cancelOrder(Long orderId) {
        // æ²¡æœ‰è®¢å•å–æ¶ˆæŒ‡æ ‡ç»Ÿè®¡
        Order order = orderRepository.findById(orderId);
        order.cancel();
        orderRepository.save(order);
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç”¨æˆ·è¡Œä¸ºç›‘æ§
@Service
public class UserService {
    public void userLogin(String userId) {
        // æ²¡æœ‰ç”¨æˆ·ç™»å½•ç»Ÿè®¡
        updateLastLoginTime(userId);
    }
    
    public void userAction(String userId, String action) {
        // æ²¡æœ‰ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡
        processAction(userId, action);
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ”¯ä»˜ä¸šåŠ¡ç›‘æ§
@Service
public class PaymentService {
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            return paymentGateway.charge(request);
        } catch (Exception e) {
            // æ²¡æœ‰æ”¯ä»˜å¤±è´¥åŸå› ç»Ÿè®¡
            throw e;
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
@Service
public class OrderService {
    private final MeterRegistry meterRegistry;
    private final Counter orderCreateCounter;
    private final Counter orderCancelCounter;
    private final Timer orderProcessTimer;
    private final Gauge dailyOrderAmount;
    
    public OrderService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.orderCreateCounter = Counter.builder("order.create.total")
            .description("Total order creation count")
            .register(meterRegistry);
        this.orderCancelCounter = Counter.builder("order.cancel.total")
            .description("Total order cancellation count")
            .register(meterRegistry);
        this.orderProcessTimer = Timer.builder("order.process.duration")
            .description("Order processing duration")
            .register(meterRegistry);
    }
    
    @Timed(value = "order.create", description = "Order creation time")
    public OrderResult createOrder(OrderRequest request) {
        Timer.Sample sample = Timer.Sample.start(meterRegistry);
        
        try {
            Order order = new Order(request);
            orderRepository.save(order);
            
            // è®°å½•è®¢å•åˆ›å»ºæŒ‡æ ‡
            orderCreateCounter.increment(Tags.of(
                "status", "success",
                "product_type", request.getProductType(),
                "channel", request.getChannel(),
                "amount_range", getAmountRange(request.getAmount())
            ));
            
            // è®°å½•è®¢å•é‡‘é¢åˆ†å¸ƒ
            meterRegistry.gauge("order.amount.distribution", 
                Tags.of("range", getAmountRange(request.getAmount())),
                request.getAmount().doubleValue());
            
            // è®°å½•æ¯æ—¥è®¢å•æ€»é‡‘é¢
            meterRegistry.gauge("order.daily.amount", 
                getDailyOrderAmount());
            
            // è®°å½•è®¢å•å¤„ç†æ—¶é—´
            sample.stop(orderProcessTimer);
            
            return new OrderResult(order);
            
        } catch (BusinessException e) {
            // è®°å½•ä¸šåŠ¡å¼‚å¸¸
            orderCreateCounter.increment(Tags.of(
                "status", "business_error",
                "error_code", e.getErrorCode(),
                "product_type", request.getProductType()
            ));
            sample.stop(orderProcessTimer);
            throw e;
            
        } catch (Exception e) {
            // è®°å½•ç³»ç»Ÿå¼‚å¸¸
            orderCreateCounter.increment(Tags.of(
                "status", "system_error",
                "exception", e.getClass().getSimpleName(),
                "product_type", request.getProductType()
            ));
            sample.stop(orderProcessTimer);
            throw e;
        }
    }
    
    public void cancelOrder(Long orderId, String reason) {
        Timer.Sample sample = Timer.Sample.start(meterRegistry);
        
        try {
            Order order = orderRepository.findById(orderId);
            String originalStatus = order.getStatus();
            
            order.cancel();
            orderRepository.save(order);
            
            // è®°å½•è®¢å•å–æ¶ˆæŒ‡æ ‡
            orderCancelCounter.increment(Tags.of(
                "reason", reason,
                "original_status", originalStatus,
                "product_type", order.getProductType(),
                "time_since_create", getTimeSinceCreate(order)
            ));
            
            // è®°å½•å–æ¶ˆç‡
            double cancelRate = calculateCancelRate();
            meterRegistry.gauge("order.cancel.rate", cancelRate);
            
            sample.stop(Timer.builder("order.cancel.duration")
                .register(meterRegistry));
                
        } catch (Exception e) {
            meterRegistry.counter("order.cancel.errors",
                "exception", e.getClass().getSimpleName()).increment();
            sample.stop(Timer.builder("order.cancel.duration")
                .register(meterRegistry));
            throw e;
        }
    }
    
    private String getAmountRange(BigDecimal amount) {
        if (amount.compareTo(BigDecimal.valueOf(100)) <= 0) {
            return "small";
        } else if (amount.compareTo(BigDecimal.valueOf(1000)) <= 0) {
            return "medium";
        } else {
            return "large";
        }
    }
    
    private String getTimeSinceCreate(Order order) {
        long minutes = Duration.between(order.getCreateTime(), 
            LocalDateTime.now()).toMinutes();
        if (minutes < 30) return "immediate";
        else if (minutes < 1440) return "same_day";
        else return "delayed";
    }
    
    private double getDailyOrderAmount() {
        // å®é™…å®ç°ä¸­åº”è¯¥æŸ¥è¯¢å½“æ—¥è®¢å•æ€»é‡‘é¢
        return 0.0;
    }
    
    private double calculateCancelRate() {
        // å®é™…å®ç°ä¸­åº”è¯¥è®¡ç®—çœŸå®çš„å–æ¶ˆç‡
        return 0.0;
    }
}

// âœ… æ­£ç¡®ï¼šç”¨æˆ·è¡Œä¸ºç›‘æ§
@Service
public class UserService {
    private final MeterRegistry meterRegistry;
    private final Counter userLoginCounter;
    private final Counter userActionCounter;
    private final Gauge activeUserCount;
    
    public UserService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.userLoginCounter = Counter.builder("user.login.total")
            .description("Total user login count")
            .register(meterRegistry);
        this.userActionCounter = Counter.builder("user.action.total")
            .description("Total user action count")
            .register(meterRegistry);
    }
    
    public void userLogin(String userId, String channel, String deviceType) {
        // è®°å½•ç”¨æˆ·ç™»å½•æŒ‡æ ‡
        userLoginCounter.increment(Tags.of(
            "channel", channel,
            "device_type", deviceType,
            "user_type", getUserType(userId)
        ));
        
        // è®°å½•æ´»è·ƒç”¨æˆ·æ•°
        meterRegistry.gauge("user.active.count", getActiveUserCount());
        
        // è®°å½•ç™»å½•æ—¶é—´åˆ†å¸ƒ
        meterRegistry.gauge("user.login.hour.distribution",
            Tags.of("hour", String.valueOf(LocalDateTime.now().getHour())),
            1.0);
        
        updateLastLoginTime(userId);
    }
    
    public void userAction(String userId, String action, Map<String, Object> params) {
        // è®°å½•ç”¨æˆ·è¡Œä¸ºæŒ‡æ ‡
        userActionCounter.increment(Tags.of(
            "action", action,
            "user_type", getUserType(userId),
            "source", (String) params.getOrDefault("source", "unknown")
        ));
        
        // è®°å½•ç‰¹å®šä¸šåŠ¡è¡Œä¸º
        if ("purchase".equals(action)) {
            meterRegistry.counter("user.purchase.total",
                "amount_range", getAmountRange(params)).increment();
        } else if ("view_product".equals(action)) {
            meterRegistry.counter("user.product.view.total",
                "category", (String) params.get("category")).increment();
        }
        
        // è®°å½•ç”¨æˆ·æ´»è·ƒåº¦
        meterRegistry.gauge("user.engagement.score",
            Tags.of("user_id", userId),
            calculateEngagementScore(userId));
        
        processAction(userId, action);
    }
    
    private String getUserType(String userId) {
        // å®é™…å®ç°ä¸­åº”è¯¥è¿”å›çœŸå®çš„ç”¨æˆ·ç±»å‹
        return "regular";
    }
    
    private double getActiveUserCount() {
        // å®é™…å®ç°ä¸­åº”è¯¥è¿”å›çœŸå®çš„æ´»è·ƒç”¨æˆ·æ•°
        return 0.0;
    }
    
    private String getAmountRange(Map<String, Object> params) {
        // å®é™…å®ç°ä¸­åº”è¯¥æ ¹æ®å‚æ•°è®¡ç®—é‡‘é¢èŒƒå›´
        return "medium";
    }
    
    private double calculateEngagementScore(String userId) {
        // å®é™…å®ç°ä¸­åº”è¯¥è®¡ç®—çœŸå®çš„ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ•°
        return 0.0;
    }
}

// âœ… æ­£ç¡®ï¼šæ”¯ä»˜ä¸šåŠ¡ç›‘æ§
@Service
public class PaymentService {
    private final MeterRegistry meterRegistry;
    private final Counter paymentCounter;
    private final Timer paymentTimer;
    private final Counter paymentErrorCounter;
    
    public PaymentService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.paymentCounter = Counter.builder("payment.total")
            .description("Total payment attempts")
            .register(meterRegistry);
        this.paymentTimer = Timer.builder("payment.duration")
            .description("Payment processing duration")
            .register(meterRegistry);
        this.paymentErrorCounter = Counter.builder("payment.errors.total")
            .description("Payment errors count")
            .register(meterRegistry);
    }
    
    public PaymentResult processPayment(PaymentRequest request) {
        Timer.Sample sample = Timer.Sample.start(meterRegistry);
        
        try {
            PaymentResult result = paymentGateway.charge(request);
            
            // è®°å½•æ”¯ä»˜æˆåŠŸæŒ‡æ ‡
            paymentCounter.increment(Tags.of(
                "status", "success",
                "gateway", request.getGateway(),
                "payment_method", request.getPaymentMethod(),
                "amount_range", getAmountRange(request.getAmount()),
                "currency", request.getCurrency()
            ));
            
            // è®°å½•æ”¯ä»˜æˆåŠŸç‡
            double successRate = calculateSuccessRate(request.getGateway());
            meterRegistry.gauge("payment.success.rate",
                Tags.of("gateway", request.getGateway()),
                successRate);
            
            // è®°å½•æ”¯ä»˜é‡‘é¢åˆ†å¸ƒ
            meterRegistry.gauge("payment.amount.distribution",
                Tags.of(
                    "gateway", request.getGateway(),
                    "range", getAmountRange(request.getAmount())
                ),
                request.getAmount().doubleValue());
            
            sample.stop(paymentTimer);
            return result;
            
        } catch (PaymentTimeoutException e) {
            // è®°å½•æ”¯ä»˜è¶…æ—¶
            paymentCounter.increment(Tags.of(
                "status", "timeout",
                "gateway", request.getGateway(),
                "payment_method", request.getPaymentMethod()
            ));
            paymentErrorCounter.increment(Tags.of(
                "type", "timeout",
                "gateway", request.getGateway()
            ));
            sample.stop(paymentTimer);
            throw e;
            
        } catch (InsufficientFundsException e) {
            // è®°å½•ä½™é¢ä¸è¶³
            paymentCounter.increment(Tags.of(
                "status", "insufficient_funds",
                "gateway", request.getGateway(),
                "payment_method", request.getPaymentMethod()
            ));
            paymentErrorCounter.increment(Tags.of(
                "type", "insufficient_funds",
                "gateway", request.getGateway()
            ));
            sample.stop(paymentTimer);
            throw e;
            
        } catch (PaymentException e) {
            // è®°å½•æ”¯ä»˜ä¸šåŠ¡å¼‚å¸¸
            paymentCounter.increment(Tags.of(
                "status", "business_error",
                "gateway", request.getGateway(),
                "error_code", e.getErrorCode(),
                "payment_method", request.getPaymentMethod()
            ));
            paymentErrorCounter.increment(Tags.of(
                "type", "business",
                "gateway", request.getGateway(),
                "error_code", e.getErrorCode()
            ));
            sample.stop(paymentTimer);
            throw e;
            
        } catch (Exception e) {
            // è®°å½•ç³»ç»Ÿå¼‚å¸¸
            paymentCounter.increment(Tags.of(
                "status", "system_error",
                "gateway", request.getGateway(),
                "exception", e.getClass().getSimpleName()
            ));
            paymentErrorCounter.increment(Tags.of(
                "type", "system",
                "gateway", request.getGateway(),
                "exception", e.getClass().getSimpleName()
            ));
            sample.stop(paymentTimer);
            throw e;
        }
    }
    
    private String getAmountRange(BigDecimal amount) {
        if (amount.compareTo(BigDecimal.valueOf(100)) <= 0) {
            return "small";
        } else if (amount.compareTo(BigDecimal.valueOf(1000)) <= 0) {
            return "medium";
        } else {
            return "large";
        }
    }
    
    private double calculateSuccessRate(String gateway) {
        // å®é™…å®ç°ä¸­åº”è¯¥è®¡ç®—çœŸå®çš„æˆåŠŸç‡
        return 0.95;
    }
}
```

##### 4.10.2.3 ç³»ç»Ÿèµ„æºç›‘æ§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ç›‘æ§JVMå†…å­˜ä½¿ç”¨æƒ…å†µï¼ˆå †å†…å­˜ã€éå †å†…å­˜ã€GCæƒ…å†µï¼‰
b. å¿…é¡»ç›‘æ§CPUä½¿ç”¨ç‡å’Œè´Ÿè½½æƒ…å†µ
c. å¿…é¡»ç›‘æ§ç£ç›˜I/Oå’Œç½‘ç»œI/Oæ€§èƒ½
d. å¿…é¡»ç›‘æ§æ•°æ®åº“è¿æ¥æ± å’Œç¼“å­˜èµ„æºä½¿ç”¨
e. å¿…é¡»ç›‘æ§çº¿ç¨‹æ± çŠ¶æ€å’Œé˜Ÿåˆ—æƒ…å†µ

**2. æ£€æµ‹æ–¹æ³•**

a. èµ„æºæµ‹è¯•ï¼šéªŒè¯ç³»ç»Ÿèµ„æºç›‘æ§å‡†ç¡®æ€§
b. è´Ÿè½½æµ‹è¯•ï¼šéªŒè¯é«˜è´Ÿè½½ä¸‹èµ„æºç›‘æ§æœ‰æ•ˆæ€§
c. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯èµ„æºç“¶é¢ˆç›‘æ§åŠæ—¶æ€§
d. å®¹é‡æµ‹è¯•ï¼šéªŒè¯èµ„æºä½¿ç”¨è¶‹åŠ¿åˆ†æ

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰JVMç›‘æ§
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        // æ²¡æœ‰é…ç½®JVMç›‘æ§
        SpringApplication.run(Application.class, args);
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰çº¿ç¨‹æ± ç›‘æ§
@Configuration
public class ThreadPoolConfig {
    @Bean
    public ThreadPoolTaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        // æ²¡æœ‰ç›‘æ§é…ç½®
        return executor;
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ•°æ®åº“è¿æ¥æ± ç›‘æ§
@Configuration
public class DataSourceConfig {
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/test");
        config.setMaximumPoolSize(20);
        // æ²¡æœ‰ç›‘æ§é…ç½®
        return new HikariDataSource(config);
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç¼“å­˜ç›‘æ§
@Service
public class CacheService {
    private final Map<String, Object> cache = new ConcurrentHashMap<>();
    
    public void put(String key, Object value) {
        cache.put(key, value); // æ²¡æœ‰ç›‘æ§ç¼“å­˜å¤§å°å’Œå‘½ä¸­ç‡
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„JVMç›‘æ§é…ç½®
@Configuration
@EnableConfigurationProperties
public class JvmMonitoringConfiguration {
    
    @Bean
    public MeterRegistry meterRegistry() {
        return new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);
    }
    
    @EventListener
    public void bindJvmMetrics(ApplicationReadyEvent event) {
        MeterRegistry registry = event.getApplicationContext()
            .getBean(MeterRegistry.class);
            
        // ç»‘å®šJVMå†…å­˜æŒ‡æ ‡
        new JvmMemoryMetrics().bindTo(registry);
        new JvmGcMetrics().bindTo(registry);
        
        // ç»‘å®šJVMçº¿ç¨‹æŒ‡æ ‡
        new JvmThreadMetrics().bindTo(registry);
        
        // ç»‘å®šç±»åŠ è½½æŒ‡æ ‡
        new ClassLoaderMetrics().bindTo(registry);
        
        // ç»‘å®šç³»ç»ŸæŒ‡æ ‡
        new ProcessorMetrics().bindTo(registry);
        new UptimeMetrics().bindTo(registry);
        new FileDescriptorMetrics().bindTo(registry);
        
        // è‡ªå®šä¹‰JVMç›‘æ§
        Gauge.builder("jvm.memory.heap.usage.ratio")
            .description("JVM heap memory usage ratio")
            .register(registry, this, this::getHeapUsageRatio);
            
        Gauge.builder("jvm.memory.nonheap.usage.ratio")
            .description("JVM non-heap memory usage ratio")
            .register(registry, this, this::getNonHeapUsageRatio);
            
        // GCç›‘æ§
        Timer.builder("jvm.gc.pause")
            .description("GC pause time")
            .register(registry);
    }
    
    private double getHeapUsageRatio() {
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        return (double) heapUsage.getUsed() / heapUsage.getMax();
    }
    
    private double getNonHeapUsageRatio() {
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        MemoryUsage nonHeapUsage = memoryBean.getNonHeapMemoryUsage();
        return (double) nonHeapUsage.getUsed() / nonHeapUsage.getMax();
    }
}

// âœ… æ­£ç¡®ï¼šçº¿ç¨‹æ± ç›‘æ§
@Configuration
public class ThreadPoolMonitoringConfig {
    
    @Bean
    public ThreadPoolTaskExecutor monitoredTaskExecutor(MeterRegistry meterRegistry) {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("async-task-");
        
        // é…ç½®çº¿ç¨‹æ± ç›‘æ§
        executor.setTaskDecorator(new MonitoringTaskDecorator(meterRegistry));
        
        // æ³¨å†Œçº¿ç¨‹æ± æŒ‡æ ‡
        Gauge.builder("threadpool.active.threads")
            .description("Active threads in thread pool")
            .register(meterRegistry, executor, ThreadPoolTaskExecutor::getActiveCount);
            
        Gauge.builder("threadpool.pool.size")
            .description("Current pool size")
            .register(meterRegistry, executor, ThreadPoolTaskExecutor::getPoolSize);
            
        Gauge.builder("threadpool.queue.size")
            .description("Current queue size")
            .register(meterRegistry, executor, e -> e.getThreadPoolExecutor().getQueue().size());
            
        Gauge.builder("threadpool.completed.tasks")
            .description("Completed task count")
            .register(meterRegistry, executor, e -> e.getThreadPoolExecutor().getCompletedTaskCount());
        
        return executor;
    }
    
    private static class MonitoringTaskDecorator implements TaskDecorator {
        private final MeterRegistry meterRegistry;
        private final Counter taskCounter;
        private final Timer taskTimer;
        
        public MonitoringTaskDecorator(MeterRegistry meterRegistry) {
            this.meterRegistry = meterRegistry;
            this.taskCounter = Counter.builder("threadpool.tasks.total")
                .description("Total tasks executed")
                .register(meterRegistry);
            this.taskTimer = Timer.builder("threadpool.task.duration")
                .description("Task execution duration")
                .register(meterRegistry);
        }
        
        @Override
        public Runnable decorate(Runnable runnable) {
            return () -> {
                Timer.Sample sample = Timer.Sample.start(meterRegistry);
                try {
                    runnable.run();
                    taskCounter.increment(Tags.of("status", "success"));
                } catch (Exception e) {
                    taskCounter.increment(Tags.of("status", "error", 
                        "exception", e.getClass().getSimpleName()));
                    throw e;
                } finally {
                    sample.stop(taskTimer);
                }
            };
        }
    }
}

// âœ… æ­£ç¡®ï¼šæ•°æ®åº“è¿æ¥æ± ç›‘æ§
@Configuration
public class DataSourceMonitoringConfig {
    
    @Bean
    public DataSource monitoredDataSource(MeterRegistry meterRegistry) {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/test");
        config.setUsername("user");
        config.setPassword("password");
        config.setMaximumPoolSize(20);
        config.setMinimumIdle(5);
        config.setConnectionTimeout(30000);
        config.setIdleTimeout(600000);
        config.setMaxLifetime(1800000);
        
        // å¯ç”¨JMXç›‘æ§
        config.setRegisterMbeans(true);
        
        // é…ç½®è¿æ¥æ± åç§°ç”¨äºç›‘æ§
        config.setPoolName("HikariPool-Main");
        
        HikariDataSource dataSource = new HikariDataSource(config);
        
        // æ³¨å†Œè¿æ¥æ± ç›‘æ§æŒ‡æ ‡
        new DataSourcePoolMetrics(dataSource, "hikari", 
            Collections.emptyList()).bindTo(meterRegistry);
            
        // è‡ªå®šä¹‰è¿æ¥æ± ç›‘æ§
        Gauge.builder("datasource.connections.active")
            .description("Active database connections")
            .register(meterRegistry, dataSource.getHikariPoolMXBean(), 
                HikariPoolMXBean::getActiveConnections);
                
        Gauge.builder("datasource.connections.idle")
            .description("Idle database connections")
            .register(meterRegistry, dataSource.getHikariPoolMXBean(), 
                HikariPoolMXBean::getIdleConnections);
                
        Gauge.builder("datasource.connections.total")
            .description("Total database connections")
            .register(meterRegistry, dataSource.getHikariPoolMXBean(), 
                HikariPoolMXBean::getTotalConnections);
                
        Gauge.builder("datasource.connections.pending")
            .description("Pending connection requests")
            .register(meterRegistry, dataSource.getHikariPoolMXBean(), 
                HikariPoolMXBean::getThreadsAwaitingConnection);
        
        return dataSource;
    }
}

// âœ… æ­£ç¡®ï¼šç¼“å­˜èµ„æºç›‘æ§
@Component
public class MonitoredCacheService {
    private final Map<String, Object> cache = new ConcurrentHashMap<>();
    private final MeterRegistry meterRegistry;
    private final AtomicLong hitCount = new AtomicLong(0);
    private final AtomicLong missCount = new AtomicLong(0);
    private final AtomicLong evictionCount = new AtomicLong(0);
    private final int maxSize = 10000;
    
    public MonitoredCacheService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // æ³¨å†Œç¼“å­˜ç›‘æ§æŒ‡æ ‡
        Gauge.builder("cache.size")
            .description("Current cache size")
            .register(meterRegistry, this, c -> c.cache.size());
            
        Gauge.builder("cache.hit.ratio")
            .description("Cache hit ratio")
            .register(meterRegistry, this, this::getHitRatio);
            
        Gauge.builder("cache.memory.usage")
            .description("Cache memory usage estimation")
            .register(meterRegistry, this, this::getMemoryUsage);
            
        // æ³¨å†Œç¼“å­˜æ“ä½œè®¡æ•°å™¨
        Counter.builder("cache.operations.total")
            .description("Total cache operations")
            .register(meterRegistry);
    }
    
    public Object get(String key) {
        Object value = cache.get(key);
        
        if (value != null) {
            hitCount.incrementAndGet();
            meterRegistry.counter("cache.access", "result", "hit").increment();
        } else {
            missCount.incrementAndGet();
            meterRegistry.counter("cache.access", "result", "miss").increment();
        }
        
        return value;
    }
    
    public void put(String key, Object value) {
        // æ£€æŸ¥ç¼“å­˜å¤§å°é™åˆ¶
        if (cache.size() >= maxSize) {
            evictOldest();
            evictionCount.incrementAndGet();
            meterRegistry.counter("cache.evictions.total").increment();
        }
        
        cache.put(key, value);
        meterRegistry.counter("cache.operations.total", "type", "put").increment();
        
        // ç›‘æ§ç¼“å­˜å¤§å°å‘Šè­¦
        if (cache.size() > maxSize * 0.8) {
            meterRegistry.counter("cache.size.warning").increment();
        }
    }
    
    public void remove(String key) {
        cache.remove(key);
        meterRegistry.counter("cache.operations.total", "type", "remove").increment();
    }
    
    public void clear() {
        int size = cache.size();
        cache.clear();
        meterRegistry.counter("cache.operations.total", "type", "clear").increment();
        meterRegistry.counter("cache.clear.items").increment(size);
    }
    
    private double getHitRatio() {
        long total = hitCount.get() + missCount.get();
        return total > 0 ? (double) hitCount.get() / total : 0.0;
    }
    
    private double getMemoryUsage() {
        // ç®€å•çš„å†…å­˜ä½¿ç”¨ä¼°ç®—
        return cache.size() * 1024.0; // å‡è®¾æ¯ä¸ªæ¡ç›®1KB
    }
    
    private void evictOldest() {
        // ç®€å•çš„LRUå®ç°ï¼Œå®é™…åº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„ç­–ç•¥
        if (!cache.isEmpty()) {
            String firstKey = cache.keySet().iterator().next();
            cache.remove(firstKey);
        }
    }
}

// âœ… æ­£ç¡®ï¼šç³»ç»Ÿèµ„æºç›‘æ§
@Component
public class SystemResourceMonitor {
    private final MeterRegistry meterRegistry;
    private final OperatingSystemMXBean osBean;
    private final MemoryMXBean memoryBean;
    
    public SystemResourceMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.osBean = ManagementFactory.getOperatingSystemMXBean();
        this.memoryBean = ManagementFactory.getMemoryMXBean();
        
        // æ³¨å†Œç³»ç»Ÿèµ„æºç›‘æ§æŒ‡æ ‡
        Gauge.builder("system.cpu.usage")
            .description("System CPU usage")
            .register(meterRegistry, this, this::getSystemCpuUsage);
            
        Gauge.builder("system.load.average")
            .description("System load average")
            .register(meterRegistry, this, this::getSystemLoadAverage);
            
        Gauge.builder("system.memory.usage")
            .description("System memory usage")
            .register(meterRegistry, this, this::getSystemMemoryUsage);
            
        // å®šæœŸæ”¶é›†ç£ç›˜I/OæŒ‡æ ‡
        scheduleResourceCollection();
    }
    
    private double getSystemCpuUsage() {
        if (osBean instanceof com.sun.management.OperatingSystemMXBean) {
            return ((com.sun.management.OperatingSystemMXBean) osBean)
                .getSystemCpuLoad();
        }
        return osBean.getSystemLoadAverage();
    }
    
    private double getSystemLoadAverage() {
        return osBean.getSystemLoadAverage();
    }
    
    private double getSystemMemoryUsage() {
        if (osBean instanceof com.sun.management.OperatingSystemMXBean) {
            com.sun.management.OperatingSystemMXBean sunBean = 
                (com.sun.management.OperatingSystemMXBean) osBean;
            long totalMemory = sunBean.getTotalPhysicalMemorySize();
            long freeMemory = sunBean.getFreePhysicalMemorySize();
            return (double) (totalMemory - freeMemory) / totalMemory;
        }
        return 0.0;
    }
    
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ”¶é›†ä¸€æ¬¡
    private void scheduleResourceCollection() {
        // æ”¶é›†ç£ç›˜ä½¿ç”¨æƒ…å†µ
        File[] roots = File.listRoots();
        for (File root : roots) {
            String path = root.getAbsolutePath();
            double usageRatio = (double) (root.getTotalSpace() - root.getFreeSpace()) 
                / root.getTotalSpace();
            
            meterRegistry.gauge("system.disk.usage", 
                Tags.of("path", path), usageRatio);
        }
        
        // æ”¶é›†ç½‘ç»œè¿æ¥æ•°ï¼ˆç®€åŒ–å®ç°ï¼‰
        try {
            Process process = Runtime.getRuntime().exec("netstat -an | wc -l");
            // å®é™…å®ç°ä¸­åº”è¯¥è§£ænetstatè¾“å‡º
            meterRegistry.gauge("system.network.connections", 0.0);
        } catch (Exception e) {
            // å¿½ç•¥å¼‚å¸¸
        }
    }
}
```

##### 4.10.3 å‘Šè­¦é…ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆå“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡ï¼‰
b. å¿…é¡»ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
c. å¿…é¡»ç›‘æ§æ•°æ®åº“è¿æ¥æ± å’Œç¼“å­˜æ€§èƒ½
d. å¿…é¡»è®¾ç½®åˆç†çš„æ€§èƒ½é˜ˆå€¼å’Œå‘Šè­¦
e. å¿…é¡»æ”¯æŒæ€§èƒ½æ•°æ®çš„å¯è§†åŒ–å±•ç¤º

**2. æ£€æµ‹æ–¹æ³•**

a. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯ç›‘æ§æŒ‡æ ‡å‡†ç¡®æ€§
b. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯é«˜è´Ÿè½½ä¸‹ç›‘æ§æœ‰æ•ˆæ€§
c. å‘Šè­¦æµ‹è¯•ï¼šéªŒè¯æ€§èƒ½å‘Šè­¦åŠæ—¶æ€§
d. å¯è§†åŒ–æ£€æŸ¥ï¼šç¡®è®¤ç›‘æ§æ•°æ®å¯è§†åŒ–å®Œæ•´

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ€§èƒ½ç›‘æ§
@Service
public class DataService {
    public List<Data> queryData(QueryRequest request) {
        // æ²¡æœ‰æ€§èƒ½ç›‘æ§
        return dataRepository.findByConditions(request);
    }
    
    public void batchProcess(List<Data> dataList) {
        // æ‰¹å¤„ç†æ²¡æœ‰ç›‘æ§
        for (Data data : dataList) {
            processData(data);
        }
    }
}

// âŒ é”™è¯¯ï¼šç¼ºå°‘èµ„æºç›‘æ§
@Component
public class CacheManager {
    private final Map<String, Object> cache = new ConcurrentHashMap<>();
    
    public void put(String key, Object value) {
        cache.put(key, value); // æ²¡æœ‰ç›‘æ§ç¼“å­˜å¤§å°
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æ€§èƒ½ç›‘æ§
@Service
public class DataService {
    private final MeterRegistry meterRegistry;
    private final Timer queryTimer;
    private final Counter queryCounter;
    private final Gauge cacheHitRatio;
    
    public DataService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.queryTimer = Timer.builder("data.query.duration")
            .description("Data query duration")
            .register(meterRegistry);
        this.queryCounter = Counter.builder("data.query.total")
            .description("Data query total count")
            .register(meterRegistry);
    }
    
    @Timed(value = "data.query", description = "Data query time")
    public List<Data> queryData(QueryRequest request) {
        return Timer.Sample.start(meterRegistry)
            .stop(queryTimer)
            .recordCallable(() -> {
                try {
                    List<Data> result = dataRepository.findByConditions(request);
                    
                    // è®°å½•æŸ¥è¯¢æŒ‡æ ‡
                    queryCounter.increment(Tags.of(
                        "status", "success",
                        "type", request.getType(),
                        "size", String.valueOf(result.size())
                    ));
                    
                    // ç›‘æ§æŸ¥è¯¢ç»“æœå¤§å°
                    meterRegistry.gauge("data.query.result.size", result.size());
                    
                    return result;
                    
                } catch (Exception e) {
                    queryCounter.increment(Tags.of(
                        "status", "error",
                        "type", request.getType(),
                        "error", e.getClass().getSimpleName()
                    ));
                    throw e;
                }
            });
    }
    
    @Async
    @Timed(value = "data.batch.process", description = "Batch process time")
    public CompletableFuture<Void> batchProcess(List<Data> dataList) {
        Timer.Sample sample = Timer.Sample.start(meterRegistry);
        
        try {
            int totalCount = dataList.size();
            int processedCount = 0;
            
            for (Data data : dataList) {
                processData(data);
                processedCount++;
                
                // æ›´æ–°å¤„ç†è¿›åº¦
                meterRegistry.gauge("data.batch.progress", 
                    (double) processedCount / totalCount * 100);
            }
            
            // è®°å½•æ‰¹å¤„ç†æˆåŠŸ
            meterRegistry.counter("data.batch.total", 
                "status", "success").increment();
            
            return CompletableFuture.completedFuture(null);
            
        } catch (Exception e) {
            meterRegistry.counter("data.batch.total", 
                "status", "error", 
                "error", e.getClass().getSimpleName()).increment();
            throw e;
            
        } finally {
            sample.stop(Timer.builder("data.batch.duration")
                .register(meterRegistry));
        }
    }
}

// âœ… æ­£ç¡®ï¼šèµ„æºç›‘æ§
@Component
public class CacheManager {
    private final Map<String, Object> cache = new ConcurrentHashMap<>();
    private final MeterRegistry meterRegistry;
    private final AtomicLong hitCount = new AtomicLong(0);
    private final AtomicLong missCount = new AtomicLong(0);
    
    public CacheManager(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // æ³¨å†Œç¼“å­˜ç›‘æ§æŒ‡æ ‡
        Gauge.builder("cache.size")
            .description("Cache size")
            .register(meterRegistry, this, c -> c.cache.size());
            
        Gauge.builder("cache.hit.ratio")
            .description("Cache hit ratio")
            .register(meterRegistry, this, c -> {
                long total = c.hitCount.get() + c.missCount.get();
                return total > 0 ? (double) c.hitCount.get() / total : 0.0;
            });
    }
    
    public Object get(String key) {
        Object value = cache.get(key);
        if (value != null) {
            hitCount.incrementAndGet();
            meterRegistry.counter("cache.access", "result", "hit").increment();
        } else {
            missCount.incrementAndGet();
            meterRegistry.counter("cache.access", "result", "miss").increment();
        }
        return value;
    }
    
    public void put(String key, Object value) {
        cache.put(key, value);
        meterRegistry.counter("cache.operations", "type", "put").increment();
        
        // ç›‘æ§ç¼“å­˜å¤§å°ï¼Œè¶…è¿‡é˜ˆå€¼å‘Šè­¦
        if (cache.size() > 10000) {
            meterRegistry.counter("cache.size.warning").increment();
        }
    }
}
```

**ç¬¬ä¸‰åå…«æ¡** å¥åº·æ£€æŸ¥æ£€æŸ¥ ğŸŸ¡ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿æœåŠ¡å¥åº·çŠ¶æ€å¯ç›‘æ§ï¼Œæ”¯æŒè‡ªåŠ¨åŒ–è¿ç»´

**æ£€æµ‹æ ‡å‡†ï¼š**
- å¿…é¡»æä¾› /actuator/health å¥åº·æ£€æŸ¥ç«¯ç‚¹
- å¿…é¡»æä¾› /actuator/ready å°±ç»ªæ£€æŸ¥ç«¯ç‚¹
- å¿…é¡»æ£€æŸ¥å…³é”®ä¾èµ–çš„å¥åº·çŠ¶æ€ï¼šæ•°æ®åº“ã€Redisã€å¤–éƒ¨æœåŠ¡
- å¥åº·æ£€æŸ¥å“åº”æ—¶é—´ä¸è¶…è¿‡ 3 ç§’
- å¥åº·æ£€æŸ¥å¤±è´¥æ—¶å¿…é¡»è¿”å›å…·ä½“çš„é”™è¯¯ä¿¡æ¯
- å¿…é¡»æ”¯æŒä¼˜é›…å…³é—­

**æ£€æµ‹æ–¹æ³•ï¼š**
- æ¥å£æµ‹è¯•ï¼šéªŒè¯å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- ä¾èµ–æµ‹è¯•ï¼šæ¨¡æ‹Ÿä¾èµ–æ•…éšœï¼ŒéªŒè¯å¥åº·æ£€æŸ¥å“åº”
- æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤å¥åº·æ£€æŸ¥å“åº”æ—¶é—´
- è¿ç»´éªŒè¯ï¼šç¡®è®¤ä¸è´Ÿè½½å‡è¡¡å™¨é›†æˆæ­£å¸¸

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç®€å•çš„å¥åº·æ£€æŸ¥ï¼Œæ²¡æœ‰ä¾èµ–æ£€æŸ¥
@RestController
public class HealthController {
    @GetMapping("/health")
    public String health() {
        return "OK"; // è¿‡äºç®€å•ï¼Œæ²¡æœ‰å®é™…æ£€æŸ¥
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å¥åº·æ£€æŸ¥å®ç°
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    private final DataSource dataSource;
    
    public DatabaseHealthIndicator(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    
    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(3)) {
                return Health.up()
                    .withDetail("database", "Available")
                    .withDetail("validationQuery", "SELECT 1")
                    .build();
            } else {
                return Health.down()
                    .withDetail("database", "Connection validation failed")
                    .build();
            }
        } catch (Exception e) {
            return Health.down()
                .withDetail("database", "Connection failed")
                .withDetail("error", e.getMessage())
                .build();
        }
    }
}

// âœ… æ­£ç¡®ï¼šåº”ç”¨é…ç½®
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,ready,info,metrics
  endpoint:
    health:
      show-details: when-authorized
      probes:
        enabled: true
  health:
    db:
      enabled: true
    redis:
      enabled: true
```

#### 4.10.3 å‘Šè­¦é…ç½®æ£€æŸ¥ ğŸŸ 

##### 4.10.3.1 å‘Šè­¦è§„åˆ™è®¾ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å…³é”®æŒ‡æ ‡å¿…é¡»è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼ï¼ˆå“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€èµ„æºä½¿ç”¨ç‡ï¼‰ã€‚

b. å‘Šè­¦è§„åˆ™å¿…é¡»åˆ†çº§ï¼ˆCriticalã€Warningã€Infoï¼‰ã€‚

c. å‘Šè­¦æ¡ä»¶å¿…é¡»è€ƒè™‘æ—¶é—´çª—å£å’ŒæŒç»­æ—¶é—´ã€‚

d. å¿…é¡»é¿å…å‘Šè­¦é£æš´å’Œè¯¯æŠ¥ã€‚

e. å‘Šè­¦è§„åˆ™å¿…é¡»å®šæœŸè¯„ä¼°å’Œè°ƒæ•´ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. å‘Šè­¦é…ç½®å®¡æŸ¥ï¼ˆé˜ˆå€¼åˆç†æ€§ã€è§„åˆ™å®Œæ•´æ€§ï¼‰ã€‚

2. å†å²æ•°æ®åˆ†æï¼ˆåŸºäºå†å²æ•°æ®è®¾ç½®é˜ˆå€¼ï¼‰ã€‚

3. å‘Šè­¦æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿå¼‚å¸¸æƒ…å†µéªŒè¯å‘Šè­¦ï¼‰ã€‚

4. å‘Šè­¦æ•ˆæœè¯„ä¼°ï¼ˆè¯¯æŠ¥ç‡ã€æ¼æŠ¥ç‡åˆ†æï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰å‘Šè­¦é…ç½®
@Configuration
public class MonitoringConfig {
    
    @Bean
    public MeterRegistry meterRegistry() {
        // åªé…ç½®äº†æŒ‡æ ‡æ”¶é›†ï¼Œæ²¡æœ‰å‘Šè­¦è§„åˆ™
        return new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);
    }
}

// âŒ é”™è¯¯ï¼šå‘Šè­¦é˜ˆå€¼ä¸åˆç†
@Component
public class AlertConfig {
    
    public void configureAlerts() {
        // é”™è¯¯ï¼šé˜ˆå€¼è¿‡äºæ•æ„Ÿï¼Œå®¹æ˜“äº§ç”Ÿè¯¯æŠ¥
        createAlert("response_time", "> 100ms", "CRITICAL");
        
        // é”™è¯¯ï¼šé˜ˆå€¼è¿‡äºå®½æ¾ï¼Œå¯èƒ½æ¼æŠ¥
        createAlert("error_rate", "> 50%", "WARNING");
        
        // é”™è¯¯ï¼šæ²¡æœ‰è€ƒè™‘æ—¶é—´çª—å£
        createAlert("cpu_usage", "> 80%", "CRITICAL");
    }
}

// âŒ é”™è¯¯ï¼šç¼ºå°‘å‘Šè­¦æŠ‘åˆ¶æœºåˆ¶
@Service
public class AlertService {
    
    public void sendAlert(String message) {
        // æ²¡æœ‰å‘Šè­¦æŠ‘åˆ¶ï¼Œå¯èƒ½äº§ç”Ÿå‘Šè­¦é£æš´
        emailService.sendAlert(message);
        smsService.sendAlert(message);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å‘Šè­¦è§„åˆ™é…ç½®
@Configuration
@EnableConfigurationProperties(AlertProperties.class)
public class AlertConfiguration {
    
    private final AlertProperties alertProperties;
    private final MeterRegistry meterRegistry;
    
    public AlertConfiguration(AlertProperties alertProperties, 
                            MeterRegistry meterRegistry) {
        this.alertProperties = alertProperties;
        this.meterRegistry = meterRegistry;
    }
    
    @Bean
    public AlertManager alertManager() {
        AlertManager alertManager = new AlertManager();
        
        // é…ç½®å“åº”æ—¶é—´å‘Šè­¦
        configureResponseTimeAlerts(alertManager);
        
        // é…ç½®é”™è¯¯ç‡å‘Šè­¦
        configureErrorRateAlerts(alertManager);
        
        // é…ç½®èµ„æºä½¿ç”¨å‘Šè­¦
        configureResourceAlerts(alertManager);
        
        // é…ç½®ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
        configureBusinessAlerts(alertManager);
        
        return alertManager;
    }
    
    private void configureResponseTimeAlerts(AlertManager alertManager) {
        // æ¥å£å“åº”æ—¶é—´å‘Šè­¦ - åˆ†çº§è®¾ç½®
        AlertRule criticalRule = AlertRule.builder()
            .name("api_response_time_critical")
            .metric("http_request_duration_seconds")
            .condition("p95 > 2.0") // 95åˆ†ä½æ•°è¶…è¿‡2ç§’
            .duration("2m") // æŒç»­2åˆ†é’Ÿ
            .severity(AlertSeverity.CRITICAL)
            .description("APIå“åº”æ—¶é—´ä¸¥é‡è¶…æ ‡")
            .tags(Map.of("service", "order-service"))
            .build();
            
        AlertRule warningRule = AlertRule.builder()
            .name("api_response_time_warning")
            .metric("http_request_duration_seconds")
            .condition("p95 > 1.0") // 95åˆ†ä½æ•°è¶…è¿‡1ç§’
            .duration("5m") // æŒç»­5åˆ†é’Ÿ
            .severity(AlertSeverity.WARNING)
            .description("APIå“åº”æ—¶é—´è¶…æ ‡")
            .tags(Map.of("service", "order-service"))
            .build();
            
        alertManager.addRule(criticalRule);
        alertManager.addRule(warningRule);
    }
    
    private void configureErrorRateAlerts(AlertManager alertManager) {
        // é”™è¯¯ç‡å‘Šè­¦
        AlertRule errorRateRule = AlertRule.builder()
            .name("api_error_rate_high")
            .metric("http_requests_total")
            .condition("rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m]) > 0.05")
            .duration("3m")
            .severity(AlertSeverity.CRITICAL)
            .description("APIé”™è¯¯ç‡è¶…è¿‡5%")
            .build();
            
        // ä¸šåŠ¡å¼‚å¸¸å‘Šè­¦
        AlertRule businessErrorRule = AlertRule.builder()
            .name("business_error_rate_high")
            .metric("business_errors_total")
            .condition("rate(business_errors_total[5m]) > 10")
            .duration("2m")
            .severity(AlertSeverity.WARNING)
            .description("ä¸šåŠ¡å¼‚å¸¸é¢‘ç‡è¿‡é«˜")
            .build();
            
        alertManager.addRule(errorRateRule);
        alertManager.addRule(businessErrorRule);
    }
    
    private void configureResourceAlerts(AlertManager alertManager) {
        // JVMå†…å­˜å‘Šè­¦
        AlertRule memoryRule = AlertRule.builder()
            .name("jvm_memory_usage_high")
            .metric("jvm_memory_used_bytes")
            .condition("jvm_memory_used_bytes{area=\"heap\"} / jvm_memory_max_bytes{area=\"heap\"} > 0.85")
            .duration("5m")
            .severity(AlertSeverity.WARNING)
            .description("JVMå †å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡85%")
            .build();
            
        // CPUä½¿ç”¨ç‡å‘Šè­¦
        AlertRule cpuRule = AlertRule.builder()
            .name("cpu_usage_high")
            .metric("system_cpu_usage")
            .condition("system_cpu_usage > 0.8")
            .duration("10m") // è¾ƒé•¿æ—¶é—´çª—å£é¿å…è¯¯æŠ¥
            .severity(AlertSeverity.WARNING)
            .description("CPUä½¿ç”¨ç‡æŒç»­è¶…è¿‡80%")
            .build();
            
        // æ•°æ®åº“è¿æ¥æ± å‘Šè­¦
        AlertRule dbConnectionRule = AlertRule.builder()
            .name("db_connection_pool_exhausted")
            .metric("hikaricp_connections_active")
            .condition("hikaricp_connections_active / hikaricp_connections_max > 0.9")
            .duration("1m")
            .severity(AlertSeverity.CRITICAL)
            .description("æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡è¶…è¿‡90%")
            .build();
            
        alertManager.addRule(memoryRule);
        alertManager.addRule(cpuRule);
        alertManager.addRule(dbConnectionRule);
    }
    
    private void configureBusinessAlerts(AlertManager alertManager) {
        // è®¢å•å¤„ç†å¤±è´¥ç‡å‘Šè­¦
        AlertRule orderFailureRule = AlertRule.builder()
            .name("order_failure_rate_high")
            .metric("order_create_total")
            .condition("rate(order_create_total{status=\"failed\"}[10m]) / rate(order_create_total[10m]) > 0.1")
            .duration("5m")
            .severity(AlertSeverity.CRITICAL)
            .description("è®¢å•åˆ›å»ºå¤±è´¥ç‡è¶…è¿‡10%")
            .build();
            
        // æ”¯ä»˜æˆåŠŸç‡å‘Šè­¦
        AlertRule paymentSuccessRule = AlertRule.builder()
            .name("payment_success_rate_low")
            .metric("payment_total")
            .condition("rate(payment_total{status=\"success\"}[10m]) / rate(payment_total[10m]) < 0.95")
            .duration("3m")
            .severity(AlertSeverity.WARNING)
            .description("æ”¯ä»˜æˆåŠŸç‡ä½äº95%")
            .build();
            
        alertManager.addRule(orderFailureRule);
        alertManager.addRule(paymentSuccessRule);
    }
}

// âœ… æ­£ç¡®ï¼šå‘Šè­¦å±æ€§é…ç½®
@ConfigurationProperties(prefix = "alert")
@Data
public class AlertProperties {
    
    private ResponseTime responseTime = new ResponseTime();
    private ErrorRate errorRate = new ErrorRate();
    private Resource resource = new Resource();
    private Notification notification = new Notification();
    
    @Data
    public static class ResponseTime {
        private Duration warningThreshold = Duration.ofSeconds(1);
        private Duration criticalThreshold = Duration.ofSeconds(2);
        private Duration evaluationWindow = Duration.ofMinutes(5);
    }
    
    @Data
    public static class ErrorRate {
        private double warningThreshold = 0.02; // 2%
        private double criticalThreshold = 0.05; // 5%
        private Duration evaluationWindow = Duration.ofMinutes(5);
    }
    
    @Data
    public static class Resource {
        private double memoryWarningThreshold = 0.85; // 85%
        private double memoryCriticalThreshold = 0.95; // 95%
        private double cpuWarningThreshold = 0.8; // 80%
        private double cpuCriticalThreshold = 0.9; // 90%
    }
    
    @Data
    public static class Notification {
        private Duration suppressionWindow = Duration.ofMinutes(30);
        private int maxAlertsPerHour = 10;
        private List<String> criticalChannels = Arrays.asList("email", "sms", "slack");
        private List<String> warningChannels = Arrays.asList("email", "slack");
    }
}
```

##### 4.10.3.2 é€šçŸ¥é…ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»é…ç½®å¤šç§é€šçŸ¥æ¸ é“ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€å³æ—¶é€šè®¯ï¼‰ã€‚

b. ä¸åŒçº§åˆ«å‘Šè­¦ä½¿ç”¨ä¸åŒé€šçŸ¥æ–¹å¼ã€‚

c. å¿…é¡»é…ç½®å‘Šè­¦æŠ‘åˆ¶å’Œå»é‡æœºåˆ¶ã€‚

d. é€šçŸ¥å†…å®¹å¿…é¡»åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

e. å¿…é¡»æ”¯æŒå‘Šè­¦å‡çº§æœºåˆ¶ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é€šçŸ¥é…ç½®éªŒè¯ï¼ˆæ¸ é“å¯ç”¨æ€§ã€æ ¼å¼æ­£ç¡®æ€§ï¼‰ã€‚

2. é€šçŸ¥æµ‹è¯•ï¼ˆå‘é€æµ‹è¯•å‘Šè­¦éªŒè¯é€šçŸ¥ï¼‰ã€‚

3. å‘Šè­¦æŠ‘åˆ¶æµ‹è¯•ï¼ˆéªŒè¯é‡å¤å‘Šè­¦æŠ‘åˆ¶ï¼‰ã€‚

4. å‡çº§æœºåˆ¶æµ‹è¯•ï¼ˆéªŒè¯å‘Šè­¦å‡çº§æµç¨‹ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå•ä¸€é€šçŸ¥æ¸ é“
@Service
public class AlertNotificationService {
    
    public void sendAlert(Alert alert) {
        // åªæœ‰é‚®ä»¶é€šçŸ¥ï¼Œæ²¡æœ‰å…¶ä»–æ¸ é“
        emailService.send(alert.getMessage());
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰å‘Šè­¦æŠ‘åˆ¶
@Service
public class SimpleAlertService {
    
    public void processAlert(Alert alert) {
        // æ¯æ¬¡éƒ½å‘é€ï¼Œæ²¡æœ‰æŠ‘åˆ¶æœºåˆ¶
        notificationService.send(alert);
    }
}

// âŒ é”™è¯¯ï¼šé€šçŸ¥å†…å®¹ä¸å®Œæ•´
@Component
public class AlertFormatter {
    
    public String formatAlert(Alert alert) {
        // ä¿¡æ¯ä¸å®Œæ•´ï¼Œç¼ºå°‘ä¸Šä¸‹æ–‡
        return "Alert: " + alert.getName();
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„é€šçŸ¥é…ç½®
@Service
public class AlertNotificationService {
    
    private final EmailNotificationChannel emailChannel;
    private final SmsNotificationChannel smsChannel;
    private final SlackNotificationChannel slackChannel;
    private final WeChatNotificationChannel weChatChannel;
    private final AlertSuppressionService suppressionService;
    private final AlertEscalationService escalationService;
    
    public AlertNotificationService(
            EmailNotificationChannel emailChannel,
            SmsNotificationChannel smsChannel,
            SlackNotificationChannel slackChannel,
            WeChatNotificationChannel weChatChannel,
            AlertSuppressionService suppressionService,
            AlertEscalationService escalationService) {
        this.emailChannel = emailChannel;
        this.smsChannel = smsChannel;
        this.slackChannel = slackChannel;
        this.weChatChannel = weChatChannel;
        this.suppressionService = suppressionService;
        this.escalationService = escalationService;
    }
    
    public void processAlert(Alert alert) {
        // æ£€æŸ¥å‘Šè­¦æŠ‘åˆ¶
        if (suppressionService.isSuppressed(alert)) {
            log.info("Alert suppressed: alertId={}, rule={}", 
                alert.getId(), alert.getRuleName());
            return;
        }
        
        // è®°å½•å‘Šè­¦æŠ‘åˆ¶çŠ¶æ€
        suppressionService.recordAlert(alert);
        
        // æ ¹æ®ä¸¥é‡çº§åˆ«é€‰æ‹©é€šçŸ¥æ¸ é“
        List<NotificationChannel> channels = selectChannels(alert.getSeverity());
        
        // æ ¼å¼åŒ–å‘Šè­¦æ¶ˆæ¯
        AlertMessage message = formatAlertMessage(alert);
        
        // å‘é€é€šçŸ¥
        for (NotificationChannel channel : channels) {
            try {
                channel.send(message);
                log.info("Alert sent via {}: alertId={}, rule={}", 
                    channel.getName(), alert.getId(), alert.getRuleName());
            } catch (Exception e) {
                log.error("Failed to send alert via {}: alertId={}, rule={}", 
                    channel.getName(), alert.getId(), alert.getRuleName(), e);
            }
        }
        
        // å¯åŠ¨å‡çº§æœºåˆ¶
        if (alert.getSeverity() == AlertSeverity.CRITICAL) {
            escalationService.scheduleEscalation(alert);
        }
    }
    
    private List<NotificationChannel> selectChannels(AlertSeverity severity) {
        switch (severity) {
            case CRITICAL:
                return Arrays.asList(emailChannel, smsChannel, slackChannel, weChatChannel);
            case WARNING:
                return Arrays.asList(emailChannel, slackChannel);
            case INFO:
                return Arrays.asList(slackChannel);
            default:
                return Arrays.asList(emailChannel);
        }
    }
    
    private AlertMessage formatAlertMessage(Alert alert) {
        return AlertMessage.builder()
            .title(formatTitle(alert))
            .content(formatContent(alert))
            .severity(alert.getSeverity())
            .timestamp(alert.getTimestamp())
            .tags(alert.getTags())
            .runbookUrl(generateRunbookUrl(alert))
            .dashboardUrl(generateDashboardUrl(alert))
            .build();
    }
    
    private String formatTitle(Alert alert) {
        return String.format("[%s] %s - %s", 
            alert.getSeverity().name(),
            alert.getService(),
            alert.getDescription());
    }
    
    private String formatContent(Alert alert) {
        StringBuilder content = new StringBuilder();
        content.append("å‘Šè­¦è¯¦æƒ…:\n");
        content.append("æœåŠ¡: ").append(alert.getService()).append("\n");
        content.append("è§„åˆ™: ").append(alert.getRuleName()).append("\n");
        content.append("æè¿°: ").append(alert.getDescription()).append("\n");
        content.append("å½“å‰å€¼: ").append(alert.getCurrentValue()).append("\n");
        content.append("é˜ˆå€¼: ").append(alert.getThreshold()).append("\n");
        content.append("æŒç»­æ—¶é—´: ").append(alert.getDuration()).append("\n");
        content.append("æ—¶é—´: ").append(alert.getTimestamp()).append("\n");
        
        if (!alert.getTags().isEmpty()) {
            content.append("æ ‡ç­¾: ");
            alert.getTags().forEach((key, value) -> 
                content.append(key).append("=").append(value).append(" "));
            content.append("\n");
        }
        
        content.append("\nå¤„ç†å»ºè®®:\n");
        content.append(generateSuggestions(alert));
        
        return content.toString();
    }
    
    private String generateSuggestions(Alert alert) {
        // æ ¹æ®å‘Šè­¦ç±»å‹ç”Ÿæˆå¤„ç†å»ºè®®
        switch (alert.getType()) {
            case "response_time_high":
                return "1. æ£€æŸ¥åº”ç”¨æ€§èƒ½æŒ‡æ ‡\n2. æŸ¥çœ‹æ•°æ®åº“æ…¢æŸ¥è¯¢\n3. æ£€æŸ¥å¤–éƒ¨ä¾èµ–å“åº”æ—¶é—´";
            case "error_rate_high":
                return "1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—\n2. æ£€æŸ¥æœ€è¿‘éƒ¨ç½²\n3. éªŒè¯å¤–éƒ¨ä¾èµ–çŠ¶æ€";
            case "memory_usage_high":
                return "1. æ£€æŸ¥å†…å­˜æ³„æ¼\n2. åˆ†æGCæ—¥å¿—\n3. è€ƒè™‘æ‰©å®¹";
            default:
                return "è¯·æŸ¥çœ‹ç›‘æ§å¤§ç›˜å’Œç›¸å…³æ—¥å¿—";
        }
    }
    
    private String generateRunbookUrl(Alert alert) {
        return String.format("https://runbook.company.com/alerts/%s", alert.getType());
    }
    
    private String generateDashboardUrl(Alert alert) {
        return String.format("https://grafana.company.com/d/service-dashboard?var-service=%s", 
            alert.getService());
    }
}

// âœ… æ­£ç¡®ï¼šå‘Šè­¦æŠ‘åˆ¶æœåŠ¡
@Service
public class AlertSuppressionService {
    
    private final RedisTemplate<String, Object> redisTemplate;
    private final AlertProperties alertProperties;
    
    private static final String SUPPRESSION_KEY_PREFIX = "alert:suppression:";
    private static final String ALERT_COUNT_KEY_PREFIX = "alert:count:";
    
    public AlertSuppressionService(RedisTemplate<String, Object> redisTemplate,
                                 AlertProperties alertProperties) {
        this.redisTemplate = redisTemplate;
        this.alertProperties = alertProperties;
    }
    
    public boolean isSuppressed(Alert alert) {
        String suppressionKey = generateSuppressionKey(alert);
        String countKey = generateCountKey(alert);
        
        // æ£€æŸ¥æ˜¯å¦åœ¨æŠ‘åˆ¶çª—å£å†…
        Boolean suppressed = redisTemplate.hasKey(suppressionKey);
        if (Boolean.TRUE.equals(suppressed)) {
            return true;
        }
        
        // æ£€æŸ¥å°æ—¶å†…å‘Šè­¦æ•°é‡é™åˆ¶
        Integer hourlyCount = (Integer) redisTemplate.opsForValue().get(countKey);
        if (hourlyCount != null && hourlyCount >= alertProperties.getNotification().getMaxAlertsPerHour()) {
            log.warn("Alert rate limit exceeded: rule={}, count={}", 
                alert.getRuleName(), hourlyCount);
            return true;
        }
        
        return false;
    }
    
    public void recordAlert(Alert alert) {
        String suppressionKey = generateSuppressionKey(alert);
        String countKey = generateCountKey(alert);
        
        Duration suppressionWindow = alertProperties.getNotification().getSuppressionWindow();
        
        // è®¾ç½®æŠ‘åˆ¶çª—å£
        redisTemplate.opsForValue().set(suppressionKey, alert.getId(), suppressionWindow);
        
        // å¢åŠ å°æ—¶è®¡æ•°
        redisTemplate.opsForValue().increment(countKey);
        redisTemplate.expire(countKey, Duration.ofHours(1));
    }
    
    private String generateSuppressionKey(Alert alert) {
        return SUPPRESSION_KEY_PREFIX + alert.getRuleName() + ":" + 
               alert.getService() + ":" + alert.getFingerprint();
    }
    
    private String generateCountKey(Alert alert) {
        LocalDateTime now = LocalDateTime.now();
        String hourKey = now.format(DateTimeFormatter.ofPattern("yyyyMMddHH"));
        return ALERT_COUNT_KEY_PREFIX + alert.getRuleName() + ":" + hourKey;
    }
}
```

##### 4.10.3.3 å¤„ç†æµç¨‹æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»å»ºç«‹æ ‡å‡†åŒ–çš„å‘Šè­¦å¤„ç†æµç¨‹ã€‚

b. å‘Šè­¦å¿…é¡»æœ‰æ˜ç¡®çš„è´£ä»»äººå’Œå¤„ç†æ—¶é™ã€‚

c. å¿…é¡»è®°å½•å‘Šè­¦å¤„ç†è¿‡ç¨‹å’Œç»“æœã€‚

d. å¿…é¡»å»ºç«‹å‘Šè­¦å›é¡¾å’Œæ”¹è¿›æœºåˆ¶ã€‚

e. é‡è¦å‘Šè­¦å¿…é¡»æœ‰åº”æ€¥é¢„æ¡ˆã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æµç¨‹æ–‡æ¡£å®¡æŸ¥ï¼ˆå¤„ç†æµç¨‹å®Œæ•´æ€§ï¼‰ã€‚

2. å“åº”æ—¶é—´ç»Ÿè®¡ï¼ˆå¤„ç†æ•ˆç‡åˆ†æï¼‰ã€‚

3. å¤„ç†è´¨é‡è¯„ä¼°ï¼ˆè§£å†³æ–¹æ¡ˆæœ‰æ•ˆæ€§ï¼‰ã€‚

4. æµç¨‹æ”¹è¿›è·Ÿè¸ªï¼ˆæŒç»­ä¼˜åŒ–æ•ˆæœï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰å¤„ç†æµç¨‹è·Ÿè¸ª
@Service
public class AlertHandlingService {
    
    public void handleAlert(Alert alert) {
        // æ²¡æœ‰è®°å½•å¤„ç†è¿‡ç¨‹
        log.info("Handling alert: {}", alert.getId());
        
        // æ²¡æœ‰æŒ‡å®šè´£ä»»äºº
        // æ²¡æœ‰å¤„ç†æ—¶é™
        // æ²¡æœ‰çŠ¶æ€è·Ÿè¸ª
    }
}

// âŒ é”™è¯¯ï¼šç¼ºå°‘å¤„ç†è®°å½•
@RestController
public class AlertController {
    
    @PostMapping("/alerts/{id}/acknowledge")
    public void acknowledgeAlert(@PathVariable String id) {
        // åªæ˜¯ç®€å•ç¡®è®¤ï¼Œæ²¡æœ‰è®°å½•å¤„ç†ä¿¡æ¯
        alertService.acknowledge(id);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å‘Šè­¦å¤„ç†æµç¨‹
@Service
public class AlertHandlingService {
    
    private final AlertRepository alertRepository;
    private final AlertAssignmentService assignmentService;
    private final AlertNotificationService notificationService;
    private final AlertMetricsService metricsService;
    
    public AlertHandlingService(
            AlertRepository alertRepository,
            AlertAssignmentService assignmentService,
            AlertNotificationService notificationService,
            AlertMetricsService metricsService) {
        this.alertRepository = alertRepository;
        this.assignmentService = assignmentService;
        this.notificationService = notificationService;
        this.metricsService = metricsService;
    }
    
    @Transactional
    public AlertHandlingResult processNewAlert(Alert alert) {
        // 1. ä¿å­˜å‘Šè­¦è®°å½•
        AlertRecord record = createAlertRecord(alert);
        alertRepository.save(record);
        
        // 2. è‡ªåŠ¨åˆ†é…è´£ä»»äºº
        String assignee = assignmentService.assignAlert(alert);
        record.setAssignee(assignee);
        record.setStatus(AlertStatus.ASSIGNED);
        
        // 3. è®¾ç½®å¤„ç†æ—¶é™
        Duration sla = calculateSLA(alert.getSeverity());
        record.setSlaDeadline(LocalDateTime.now().plus(sla));
        
        // 4. è®°å½•å¤„ç†æ­¥éª¤
        addHandlingStep(record, "ASSIGNED", 
            String.format("Alert assigned to %s, SLA: %s", assignee, sla));
        
        // 5. å‘é€åˆ†é…é€šçŸ¥
        notificationService.sendAssignmentNotification(record);
        
        // 6. å¯åŠ¨SLAç›‘æ§
        scheduleSLACheck(record);
        
        // 7. æ›´æ–°æŒ‡æ ‡
        metricsService.recordAlertCreated(alert);
        
        log.info("Alert processed: alertId={}, assignee={}, sla={}", 
            record.getId(), assignee, sla);
            
        return AlertHandlingResult.builder()
            .alertId(record.getId())
            .assignee(assignee)
            .slaDeadline(record.getSlaDeadline())
            .build();
    }
    
    @Transactional
    public void acknowledgeAlert(String alertId, String userId, String comment) {
        AlertRecord record = alertRepository.findById(alertId)
            .orElseThrow(() -> new AlertNotFoundException(alertId));
            
        // éªŒè¯æƒé™
        if (!canAcknowledge(record, userId)) {
            throw new AlertAccessDeniedException("User cannot acknowledge this alert");
        }
        
        // æ›´æ–°çŠ¶æ€
        record.setStatus(AlertStatus.ACKNOWLEDGED);
        record.setAcknowledgedBy(userId);
        record.setAcknowledgedAt(LocalDateTime.now());
        
        // è®°å½•å¤„ç†æ­¥éª¤
        addHandlingStep(record, "ACKNOWLEDGED", 
            String.format("Alert acknowledged by %s: %s", userId, comment));
        
        // å–æ¶ˆSLAæ£€æŸ¥
        cancelSLACheck(alertId);
        
        // æ›´æ–°æŒ‡æ ‡
        metricsService.recordAlertAcknowledged(record);
        
        log.info("Alert acknowledged: alertId={}, user={}", alertId, userId);
    }
    
    @Transactional
    public void resolveAlert(String alertId, String userId, 
                           AlertResolution resolution) {
        AlertRecord record = alertRepository.findById(alertId)
            .orElseThrow(() -> new AlertNotFoundException(alertId));
            
        // éªŒè¯æƒé™
        if (!canResolve(record, userId)) {
            throw new AlertAccessDeniedException("User cannot resolve this alert");
        }
        
        // æ›´æ–°çŠ¶æ€
        record.setStatus(AlertStatus.RESOLVED);
        record.setResolvedBy(userId);
        record.setResolvedAt(LocalDateTime.now());
        record.setResolution(resolution);
        
        // è®°å½•å¤„ç†æ­¥éª¤
        addHandlingStep(record, "RESOLVED", 
            String.format("Alert resolved by %s: %s\nRoot cause: %s\nSolution: %s", 
                userId, resolution.getSummary(), 
                resolution.getRootCause(), resolution.getSolution()));
        
        // å‘é€è§£å†³é€šçŸ¥
        notificationService.sendResolutionNotification(record);
        
        // æ›´æ–°æŒ‡æ ‡
        metricsService.recordAlertResolved(record);
        
        // å®‰æ’å›é¡¾
        if (record.getSeverity() == AlertSeverity.CRITICAL) {
            schedulePostMortem(record);
        }
        
        log.info("Alert resolved: alertId={}, user={}, duration={}", 
            alertId, userId, 
            Duration.between(record.getCreatedAt(), record.getResolvedAt()));
    }
    
    private AlertRecord createAlertRecord(Alert alert) {
        return AlertRecord.builder()
            .id(UUID.randomUUID().toString())
            .ruleName(alert.getRuleName())
            .service(alert.getService())
            .severity(alert.getSeverity())
            .description(alert.getDescription())
            .currentValue(alert.getCurrentValue())
            .threshold(alert.getThreshold())
            .tags(alert.getTags())
            .status(AlertStatus.NEW)
            .createdAt(LocalDateTime.now())
            .handlingSteps(new ArrayList<>())
            .build();
    }
    
    private Duration calculateSLA(AlertSeverity severity) {
        switch (severity) {
            case CRITICAL:
                return Duration.ofMinutes(15);
            case WARNING:
                return Duration.ofHours(2);
            case INFO:
                return Duration.ofHours(8);
            default:
                return Duration.ofHours(24);
        }
    }
    
    private void addHandlingStep(AlertRecord record, String action, String description) {
        AlertHandlingStep step = AlertHandlingStep.builder()
            .timestamp(LocalDateTime.now())
            .action(action)
            .description(description)
            .build();
        record.getHandlingSteps().add(step);
    }
    
    private boolean canAcknowledge(AlertRecord record, String userId) {
        // æ£€æŸ¥ç”¨æˆ·æƒé™å’Œå‘Šè­¦çŠ¶æ€
        return record.getAssignee().equals(userId) || 
               hasAdminRole(userId);
    }
    
    private boolean canResolve(AlertRecord record, String userId) {
        // æ£€æŸ¥ç”¨æˆ·æƒé™å’Œå‘Šè­¦çŠ¶æ€
        return (record.getAssignee().equals(userId) || hasAdminRole(userId)) &&
               record.getStatus() == AlertStatus.ACKNOWLEDGED;
    }
    
    private boolean hasAdminRole(String userId) {
        // å®é™…å®ç°ä¸­æ£€æŸ¥ç”¨æˆ·è§’è‰²
        return false;
    }
    
    private void scheduleSLACheck(AlertRecord record) {
        // å®ç°SLAæ£€æŸ¥è°ƒåº¦
    }
    
    private void cancelSLACheck(String alertId) {
        // å–æ¶ˆSLAæ£€æŸ¥
    }
    
    private void schedulePostMortem(AlertRecord record) {
        // å®‰æ’äº‹åå›é¡¾
    }
}

// âœ… æ­£ç¡®ï¼šå‘Šè­¦æŒ‡æ ‡æœåŠ¡
@Service
public class AlertMetricsService {
    
    private final MeterRegistry meterRegistry;
    private final Counter alertCreatedCounter;
    private final Counter alertResolvedCounter;
    private final Timer alertResolutionTimer;
    private final Gauge activeAlertsGauge;
    
    public AlertMetricsService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.alertCreatedCounter = Counter.builder("alerts.created.total")
            .description("Total alerts created")
            .register(meterRegistry);
        this.alertResolvedCounter = Counter.builder("alerts.resolved.total")
            .description("Total alerts resolved")
            .register(meterRegistry);
        this.alertResolutionTimer = Timer.builder("alerts.resolution.duration")
            .description("Alert resolution time")
            .register(meterRegistry);
        this.activeAlertsGauge = Gauge.builder("alerts.active.count")
            .description("Active alerts count")
            .register(meterRegistry, this, AlertMetricsService::getActiveAlertCount);
    }
    
    public void recordAlertCreated(Alert alert) {
        alertCreatedCounter.increment(Tags.of(
            "severity", alert.getSeverity().name().toLowerCase(),
            "service", alert.getService(),
            "rule", alert.getRuleName()
        ));
    }
    
    public void recordAlertAcknowledged(AlertRecord record) {
        Duration acknowledgmentTime = Duration.between(
            record.getCreatedAt(), record.getAcknowledgedAt());
            
        Timer.builder("alerts.acknowledgment.duration")
            .tag("severity", record.getSeverity().name().toLowerCase())
            .tag("service", record.getService())
            .register(meterRegistry)
            .record(acknowledgmentTime);
    }
    
    public void recordAlertResolved(AlertRecord record) {
        alertResolvedCounter.increment(Tags.of(
            "severity", record.getSeverity().name().toLowerCase(),
            "service", record.getService(),
            "rule", record.getRuleName()
        ));
        
        Duration resolutionTime = Duration.between(
            record.getCreatedAt(), record.getResolvedAt());
            
        alertResolutionTimer.record(resolutionTime, Tags.of(
            "severity", record.getSeverity().name().toLowerCase(),
            "service", record.getService()
        ));
        
        // è®°å½•SLAè¾¾æˆæƒ…å†µ
        boolean slaViolated = record.getResolvedAt().isAfter(record.getSlaDeadline());
        meterRegistry.counter("alerts.sla.violations",
            "severity", record.getSeverity().name().toLowerCase(),
            "violated", String.valueOf(slaViolated))
            .increment();
    }
    
    private double getActiveAlertCount() {
        // å®é™…å®ç°ä¸­è¿”å›æ´»è·ƒå‘Šè­¦æ•°é‡
        return 0.0;
    }
}
```