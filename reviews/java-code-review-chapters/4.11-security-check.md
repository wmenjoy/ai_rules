# 4.11 å®‰å…¨æ€§æ£€æŸ¥

## 4.11.1 è¾“å…¥éªŒè¯æ£€æŸ¥

### 4.11.1.1 SQLæ³¨å…¥é˜²æŠ¤æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- ç¡®ä¿æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ï¼Œé˜²æ­¢SQLæ³¨å…¥æ”»å‡»
- ç¦æ­¢ç›´æ¥æ‹¼æ¥SQLè¯­å¥
- æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»ç»è¿‡ä¸¥æ ¼éªŒè¯å’Œè½¬ä¹‰
- æ•°æ®åº“æŸ¥è¯¢å‚æ•°å¿…é¡»ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢

**æ£€æµ‹æ–¹æ³•ï¼š**
1. é™æ€åˆ†æï¼šä½¿ç”¨SASTå·¥å…·æ£€æµ‹æ½œåœ¨çš„SQLæ³¨å…¥æ¼æ´
2. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰æ•°æ®åº“æ“ä½œä»£ç 
3. å®‰å…¨æµ‹è¯•ï¼šä½¿ç”¨OWASP ZAPç­‰å·¥å…·è¿›è¡ŒSQLæ³¨å…¥æµ‹è¯•
4. åŠ¨æ€æµ‹è¯•ï¼šè¾“å…¥æ¶æ„SQLè¯­å¥éªŒè¯é˜²æŠ¤æ•ˆæœ

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šSQLæ³¨å…¥é£é™©
@Service
public class UserService {
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public User findByUsername(String username) {
        // å±é™©ï¼šç›´æ¥æ‹¼æ¥SQLï¼Œå­˜åœ¨æ³¨å…¥é£é™©
        String sql = "SELECT * FROM users WHERE username = '" + username + "'";
        return jdbcTemplate.queryForObject(sql, User.class);
    }
    
    public List<User> searchUsers(String keyword) {
        // å±é™©ï¼šæœªéªŒè¯è¾“å…¥é•¿åº¦å’Œå†…å®¹
        String sql = "SELECT * FROM users WHERE name LIKE '%" + keyword + "%'";
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(User.class));
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥é˜²æ­¢SQLæ³¨å…¥
@Service
public class UserService {
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public User findByUsername(@Valid @Size(min = 1, max = 50) String username) {
        // å®‰å…¨ï¼šä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
        String sql = "SELECT * FROM users WHERE username = ?";
        try {
            return jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(User.class), username);
        } catch (EmptyResultDataAccessException e) {
            return null;
        }
    }
    
    public List<User> searchUsers(@Valid @Size(min = 1, max = 100) String keyword) {
        // å®‰å…¨ï¼šå‚æ•°éªŒè¯ + é¢„ç¼–è¯‘è¯­å¥
        if (!isValidSearchKeyword(keyword)) {
            throw new IllegalArgumentException("Invalid search keyword");
        }
        
        String sql = "SELECT * FROM users WHERE name LIKE ? LIMIT 100";
        String searchPattern = "%" + keyword.replaceAll("[%_]", "\\\\$0") + "%";
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(User.class), searchPattern);
    }
    
    private boolean isValidSearchKeyword(String keyword) {
        // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ç©ºæ ¼å’Œå¸¸è§æ ‡ç‚¹
        return keyword.matches("^[a-zA-Z0-9\\s\\-_\\.@]+$");
    }
}
```

### 4.11.1.2 XSSæ”»å‡»é˜²æŠ¤æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- é˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡»ï¼Œæ‰€æœ‰è¾“å‡ºæ•°æ®å¿…é¡»è¿›è¡ŒHTMLç¼–ç 
- ç”¨æˆ·è¾“å…¥å†…å®¹å¿…é¡»ç»è¿‡ä¸¥æ ¼è¿‡æ»¤å’ŒéªŒè¯
- ç¦æ­¢ç›´æ¥è¾“å‡ºç”¨æˆ·è¾“å…¥çš„HTMLå†…å®¹
- å®ç°å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰

**æ£€æµ‹æ–¹æ³•ï¼š**
1. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¾“å‡ºå¤„ç†é€»è¾‘
2. å®‰å…¨æ‰«æï¼šä½¿ç”¨å®‰å…¨æ‰«æå·¥å…·æ£€æµ‹XSSæ¼æ´
3. æ‰‹åŠ¨æµ‹è¯•ï¼šè¾“å…¥æ¶æ„è„šæœ¬éªŒè¯é˜²æŠ¤æ•ˆæœ
4. CSPé…ç½®æ£€æŸ¥ï¼šéªŒè¯å†…å®¹å®‰å…¨ç­–ç•¥é…ç½®

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šXSSæ”»å‡»é£é™©
@RestController
public class MessageController {
    @PostMapping("/messages")
    public String createMessage(@RequestParam String content) {
        // å±é™©ï¼šç›´æ¥è¿”å›ç”¨æˆ·è¾“å…¥ï¼Œå­˜åœ¨XSSé£é™©
        return "<div>Message: " + content + "</div>";
    }
    
    @GetMapping("/user-profile")
    public String getUserProfile(@RequestParam String userId) {
        User user = userService.findById(userId);
        // å±é™©ï¼šç›´æ¥è¾“å‡ºç”¨æˆ·æ•°æ®ï¼Œå¯èƒ½åŒ…å«æ¶æ„è„šæœ¬
        return "<h1>Welcome " + user.getName() + "</h1>";
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šé˜²æ­¢XSSæ”»å‡»
@RestController
public class MessageController {
    @PostMapping("/messages")
    public ResponseEntity<MessageResponse> createMessage(
            @Valid @RequestBody MessageRequest request) {
        
        // å®‰å…¨ï¼šHTMLç¼–ç é˜²æ­¢XSS
        String safeContent = HtmlUtils.htmlEscape(request.getContent());
        
        Message message = messageService.createMessage(safeContent);
        
        return ResponseEntity.ok(new MessageResponse(message.getId(), safeContent));
    }
    
    @GetMapping("/user-profile")
    public ResponseEntity<UserProfileResponse> getUserProfile(@PathVariable String userId) {
        User user = userService.findById(userId);
        
        // å®‰å…¨ï¼šä½¿ç”¨DTOè¿”å›ï¼Œé¿å…ç›´æ¥è¾“å‡ºHTML
        UserProfileResponse response = UserProfileResponse.builder()
            .id(user.getId())
            .name(HtmlUtils.htmlEscape(user.getName()))
            .email(HtmlUtils.htmlEscape(user.getEmail()))
            .build();
            
        return ResponseEntity.ok(response);
    }
}

// âœ… æ­£ç¡®ï¼šè¾“å…¥éªŒè¯æ³¨è§£
public class MessageRequest {
    @NotBlank(message = "Content cannot be blank")
    @Size(min = 1, max = 1000, message = "Content length must be between 1 and 1000 characters")
    @Pattern(regexp = "^[^<>\"'&]*$", message = "Content contains invalid characters")
    private String content;
    
    // getter/setter
}
```

### 4.11.1.3 è¾“å…¥å‚æ•°éªŒè¯æ£€æŸ¥ ğŸŸ¡

**æ£€æµ‹ç›®æ ‡ï¼š**
- æ‰€æœ‰å¤–éƒ¨è¾“å…¥å¿…é¡»è¿›è¡Œä¸¥æ ¼éªŒè¯
- å®ç°è¾“å…¥é•¿åº¦é™åˆ¶å’Œæ•°æ®ç±»å‹éªŒè¯
- ä½¿ç”¨ç™½åå•éªŒè¯è€Œéé»‘åå•
- éªŒè¯å¤±è´¥å¿…é¡»è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

**æ£€æµ‹æ–¹æ³•ï¼š**
1. æ³¨è§£æ£€æŸ¥ï¼šç¡®è®¤æ‰€æœ‰æ¥å£å‚æ•°éƒ½æœ‰éªŒè¯æ³¨è§£
2. è¾¹ç•Œæµ‹è¯•ï¼šæµ‹è¯•è¾“å…¥å‚æ•°çš„è¾¹ç•Œå€¼
3. ç±»å‹æµ‹è¯•ï¼šéªŒè¯æ•°æ®ç±»å‹è½¬æ¢çš„å®‰å…¨æ€§
4. é•¿åº¦æµ‹è¯•ï¼šéªŒè¯è¾“å…¥é•¿åº¦é™åˆ¶çš„æœ‰æ•ˆæ€§

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘è¾“å…¥éªŒè¯
@RestController
public class UserController {
    @PostMapping("/users")
    public User createUser(@RequestBody UserRequest request) {
        // å±é™©ï¼šæ²¡æœ‰è¾“å…¥éªŒè¯
        User user = new User();
        user.setUsername(request.getUsername());
        user.setEmail(request.getEmail());
        user.setAge(request.getAge());
        
        return userService.save(user);
    }
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable String id) {
        // å±é™©ï¼šæ²¡æœ‰éªŒè¯IDæ ¼å¼
        return userService.findById(Long.parseLong(id));
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®Œå–„çš„è¾“å…¥éªŒè¯
@RestController
@Validated
public class UserController {
    @PostMapping("/users")
    public ResponseEntity<UserResponse> createUser(
            @Valid @RequestBody UserRequest request) {
        
        User user = userService.createUser(request);
        UserResponse response = UserResponse.fromUser(user);
        
        return ResponseEntity.ok(response);
    }
    
    @GetMapping("/users/{id}")
    public ResponseEntity<UserResponse> getUser(
            @PathVariable @Min(1) @Max(Long.MAX_VALUE) Long id) {
        
        User user = userService.findById(id);
        if (user == null) {
            return ResponseEntity.notFound().build();
        }
        
        UserResponse response = UserResponse.fromUser(user);
        return ResponseEntity.ok(response);
    }
}

// âœ… æ­£ç¡®ï¼šè¾“å…¥éªŒè¯DTO
public class UserRequest {
    @NotBlank(message = "Username cannot be blank")
    @Size(min = 3, max = 50, message = "Username must be between 3 and 50 characters")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "Username can only contain letters, numbers and underscores")
    private String username;
    
    @NotBlank(message = "Email cannot be blank")
    @Email(message = "Invalid email format")
    @Size(max = 100, message = "Email cannot exceed 100 characters")
    private String email;
    
    @NotNull(message = "Age cannot be null")
    @Min(value = 18, message = "Age must be at least 18")
    @Max(value = 120, message = "Age cannot exceed 120")
    private Integer age;
    
    // getters and setters
}
```

## 4.11.2 è®¤è¯æˆæƒæ£€æŸ¥

### 4.11.2.1 èº«ä»½è®¤è¯æœºåˆ¶æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- ç¡®ä¿èº«ä»½è®¤è¯æœºåˆ¶å®‰å…¨å¯é 
- å®ç°å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰
- ä¼šè¯ç®¡ç†å¿…é¡»å®‰å…¨
- è®¤è¯å¤±è´¥å¿…é¡»æœ‰é€‚å½“çš„é™åˆ¶æœºåˆ¶

**æ£€æµ‹æ–¹æ³•ï¼š**
1. è®¤è¯æµç¨‹æµ‹è¯•ï¼šéªŒè¯è®¤è¯æœºåˆ¶çš„å®Œæ•´æ€§
2. ä¼šè¯æµ‹è¯•ï¼šæ£€æŸ¥ä¼šè¯ç®¡ç†çš„å®‰å…¨æ€§
3. æš´åŠ›ç ´è§£æµ‹è¯•ï¼šéªŒè¯è´¦æˆ·é”å®šæœºåˆ¶
4. ä»¤ç‰Œå®‰å…¨æµ‹è¯•ï¼šéªŒè¯JWTç­‰ä»¤ç‰Œçš„å®‰å…¨æ€§

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä¸å®‰å…¨çš„è®¤è¯æœºåˆ¶
@RestController
public class AuthController {
    @PostMapping("/login")
    public ResponseEntity<String> login(@RequestBody LoginRequest request) {
        User user = userService.findByUsername(request.getUsername());
        
        // å±é™©ï¼šæ˜æ–‡å¯†ç æ¯”è¾ƒ
        if (user != null && user.getPassword().equals(request.getPassword())) {
            // å±é™©ï¼šç®€å•çš„ä¼šè¯æ ‡è¯†
            String token = user.getId() + ":" + System.currentTimeMillis();
            return ResponseEntity.ok(token);
        }
        
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Login failed");
    }
    
    @PostMapping("/verify")
    public ResponseEntity<String> verifyToken(@RequestParam String token) {
        // å±é™©ï¼šæ²¡æœ‰ä»¤ç‰ŒéªŒè¯é€»è¾‘
        return ResponseEntity.ok("Valid");
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„è®¤è¯æœºåˆ¶
@RestController
public class AuthController {
    @Autowired
    private AuthenticationManager authenticationManager;
    @Autowired
    private JwtTokenProvider jwtTokenProvider;
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @PostMapping("/login")
    public ResponseEntity<AuthResponse> login(
            @Valid @RequestBody LoginRequest request,
            HttpServletRequest httpRequest) {
        
        try {
            // å®‰å…¨ï¼šä½¿ç”¨Spring Securityè®¤è¯
            Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                    request.getUsername(),
                    request.getPassword()
                )
            );
            
            UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();
            
            // å®‰å…¨ï¼šç”ŸæˆJWTä»¤ç‰Œ
            String accessToken = jwtTokenProvider.generateAccessToken(userPrincipal);
            String refreshToken = jwtTokenProvider.generateRefreshToken(userPrincipal);
            
            // è®°å½•ç™»å½•æ—¥å¿—
            auditService.logLoginSuccess(userPrincipal.getUsername(), 
                                       httpRequest.getRemoteAddr());
            
            return ResponseEntity.ok(new AuthResponse(accessToken, refreshToken));
            
        } catch (BadCredentialsException e) {
            // è®°å½•ç™»å½•å¤±è´¥
            auditService.logLoginFailure(request.getUsername(), 
                                       httpRequest.getRemoteAddr());
            
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                .body(new AuthResponse("Invalid credentials"));
        }
    }
    
    @PostMapping("/refresh")
    public ResponseEntity<AuthResponse> refreshToken(
            @Valid @RequestBody RefreshTokenRequest request) {
        
        if (!jwtTokenProvider.validateRefreshToken(request.getRefreshToken())) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                .body(new AuthResponse("Invalid refresh token"));
        }
        
        UserPrincipal userPrincipal = jwtTokenProvider
            .getUserPrincipalFromRefreshToken(request.getRefreshToken());
        
        String newAccessToken = jwtTokenProvider.generateAccessToken(userPrincipal);
        
        return ResponseEntity.ok(new AuthResponse(newAccessToken, request.getRefreshToken()));
    }
}
```

### 4.11.2.2 æƒé™æ§åˆ¶æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- æ•æ„Ÿæ“ä½œå¿…é¡»è¿›è¡Œæƒé™éªŒè¯
- æƒé™æ£€æŸ¥å¿…é¡»åœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‰è¿›è¡Œ
- å®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶

**æ£€æµ‹æ–¹æ³•ï¼š**
1. æƒé™æµ‹è¯•ï¼šéªŒè¯ä¸åŒè§’è‰²çš„è®¿é—®æƒé™
2. è¶Šæƒæµ‹è¯•ï¼šå°è¯•è®¿é—®æ— æƒé™çš„èµ„æº
3. æƒé™ç»•è¿‡æµ‹è¯•ï¼šå°è¯•ç»•è¿‡æƒé™æ£€æŸ¥
4. æƒé™ç»§æ‰¿æµ‹è¯•ï¼šéªŒè¯æƒé™ç»§æ‰¿æœºåˆ¶

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘æƒé™æ§åˆ¶
@RestController
public class AdminController {
    @DeleteMapping("/users/{id}")
    public ResponseEntity<String> deleteUser(@PathVariable Long id) {
        // å±é™©ï¼šæ²¡æœ‰æƒé™æ£€æŸ¥
        userService.deleteUser(id);
        return ResponseEntity.ok("User deleted");
    }
    
    @GetMapping("/system/config")
    public ResponseEntity<SystemConfig> getSystemConfig() {
        // å±é™©ï¼šæ•æ„Ÿä¿¡æ¯æ²¡æœ‰æƒé™ä¿æŠ¤
        return ResponseEntity.ok(systemConfigService.getConfig());
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®Œå–„çš„æƒé™æ§åˆ¶
@RestController
@RequestMapping("/api/admin")
public class AdminController {
    
    @DeleteMapping("/users/{id}")
    @PreAuthorize("hasRole('ADMIN') and @userService.canDeleteUser(#id, authentication.name)")
    public ResponseEntity<String> deleteUser(
            @PathVariable Long id,
            Authentication authentication) {
        
        // é¢å¤–çš„ä¸šåŠ¡æƒé™æ£€æŸ¥
        if (!userService.canDeleteUser(id, authentication.getName())) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN)
                .body("Insufficient permissions");
        }
        
        userService.deleteUser(id);
        
        // è®°å½•æ•æ„Ÿæ“ä½œ
        auditService.logUserDeletion(authentication.getName(), id);
        
        return ResponseEntity.ok("User deleted successfully");
    }
    
    @GetMapping("/system/config")
    @PreAuthorize("hasRole('SUPER_ADMIN')")
    public ResponseEntity<SystemConfigResponse> getSystemConfig(
            Authentication authentication) {
        
        SystemConfig config = systemConfigService.getConfig();
        
        // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
        SystemConfigResponse response = SystemConfigResponse.fromConfig(config);
        response.maskSensitiveData();
        
        // è®°å½•æ•æ„Ÿæ•°æ®è®¿é—®
        auditService.logSensitiveDataAccess(authentication.getName(), "system_config");
        
        return ResponseEntity.ok(response);
    }
}

// âœ… æ­£ç¡®ï¼šæƒé™æœåŠ¡
@Service
public class UserService {
    
    public boolean canDeleteUser(Long userId, String currentUsername) {
        User currentUser = findByUsername(currentUsername);
        User targetUser = findById(userId);
        
        // ä¸èƒ½åˆ é™¤è‡ªå·±
        if (currentUser.getId().equals(userId)) {
            return false;
        }
        
        // åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç®¡ç†å‘˜
        if (targetUser.hasRole("ADMIN") && !currentUser.hasRole("SUPER_ADMIN")) {
            return false;
        }
        
        return true;
    }
}
```

### 4.11.2.3 å¯†ç å®‰å…¨å­˜å‚¨æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- å¯†ç å¿…é¡»ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•å­˜å‚¨
- ç¦æ­¢æ˜æ–‡å­˜å‚¨å¯†ç 
- å®ç°å¯†ç å¼ºåº¦è¦æ±‚
- å¯†ç ä¼ è¾“å¿…é¡»åŠ å¯†

**æ£€æµ‹æ–¹æ³•ï¼š**
1. å¯†ç å­˜å‚¨æ£€æŸ¥ï¼šéªŒè¯å¯†ç åŠ å¯†æ–¹å¼
2. å¯†ç å¼ºåº¦æµ‹è¯•ï¼šéªŒè¯å¯†ç å¤æ‚åº¦è¦æ±‚
3. ä¼ è¾“å®‰å…¨æµ‹è¯•ï¼šéªŒè¯å¯†ç ä¼ è¾“åŠ å¯†
4. å¯†ç é‡ç½®æµ‹è¯•ï¼šéªŒè¯å¯†ç é‡ç½®æµç¨‹å®‰å…¨æ€§

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä¸å®‰å…¨çš„å¯†ç å¤„ç†
@Service
public class UserService {
    public User createUser(UserRequest request) {
        User user = new User();
        user.setUsername(request.getUsername());
        // å±é™©ï¼šæ˜æ–‡å­˜å‚¨å¯†ç 
        user.setPassword(request.getPassword());
        
        return userRepository.save(user);
    }
    
    public boolean validatePassword(String username, String password) {
        User user = userRepository.findByUsername(username);
        // å±é™©ï¼šæ˜æ–‡å¯†ç æ¯”è¾ƒ
        return user != null && user.getPassword().equals(password);
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„å¯†ç å¤„ç†
@Service
public class UserService {
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    public User createUser(UserRequest request) {
        // éªŒè¯å¯†ç å¼ºåº¦
        if (!isStrongPassword(request.getPassword())) {
            throw new WeakPasswordException("Password does not meet security requirements");
        }
        
        User user = new User();
        user.setUsername(request.getUsername());
        // å®‰å…¨ï¼šä½¿ç”¨BCryptåŠ å¯†å­˜å‚¨å¯†ç 
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user.setPasswordCreatedAt(Instant.now());
        
        return userRepository.save(user);
    }
    
    public boolean validatePassword(String username, String rawPassword) {
        User user = userRepository.findByUsername(username);
        if (user == null) {
            return false;
        }
        
        // å®‰å…¨ï¼šä½¿ç”¨åŠ å¯†æ¯”è¾ƒ
        return passwordEncoder.matches(rawPassword, user.getPassword());
    }
    
    private boolean isStrongPassword(String password) {
        // å¯†ç å¼ºåº¦è¦æ±‚ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
        String pattern = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$";
        return password.matches(pattern);
    }
}

// âœ… æ­£ç¡®ï¼šå¯†ç é…ç½®
@Configuration
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        // ä½¿ç”¨BCryptï¼Œå¼ºåº¦ä¸º12
        return new BCryptPasswordEncoder(12);
    }
}
```

## 4.11.3 å¯†ç å­¦å®è·µæ£€æŸ¥

### 4.11.3.1 åŠ å¯†ç®—æ³•é€‰æ‹©æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- å¿…é¡»ä½¿ç”¨å®‰å…¨çš„åŠ å¯†ç®—æ³•ï¼šAES-256ã€RSA-2048+ã€SHA-256+
- ç¦æ­¢ä½¿ç”¨å¼±åŠ å¯†ç®—æ³•ï¼šDESã€MD5ã€SHA-1
- æ”¯æŒå›½å¯†ç®—æ³•ï¼ˆSM2ã€SM3ã€SM4ï¼‰
- åŠ å¯†æ¨¡å¼å¿…é¡»å®‰å…¨ï¼ˆå¦‚AES-GCMï¼‰

**æ£€æµ‹æ–¹æ³•ï¼š**
1. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥åŠ å¯†ç®—æ³•ä½¿ç”¨
2. åŠ å¯†å¼ºåº¦æµ‹è¯•ï¼šéªŒè¯åŠ å¯†ç®—æ³•å¼ºåº¦
3. åˆè§„æ€§æ£€æŸ¥ï¼šç¡®è®¤ç¬¦åˆç›¸å…³å®‰å…¨æ ‡å‡†
4. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯åŠ å¯†æ€§èƒ½å½±å“

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨å¼±åŠ å¯†ç®—æ³•
public class CryptoService {
    public String encrypt(String data) {
        try {
            // å±é™©ï¼šä½¿ç”¨å¼±åŠ å¯†ç®—æ³•DES
            Cipher cipher = Cipher.getInstance("DES");
            SecretKeySpec keySpec = new SecretKeySpec("mySecretKey123".getBytes(), "DES");
            cipher.init(Cipher.ENCRYPT_MODE, keySpec);
            
            byte[] encrypted = cipher.doFinal(data.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
        } catch (Exception e) {
            throw new RuntimeException("Encryption failed", e);
        }
    }
    
    public String hash(String data) {
        try {
            // å±é™©ï¼šä½¿ç”¨å¼±å“ˆå¸Œç®—æ³•MD5
            MessageDigest md = MessageDigest.getInstance("MD5");
            byte[] hash = md.digest(data.getBytes());
            return Base64.getEncoder().encodeToString(hash);
        } catch (Exception e) {
            throw new RuntimeException("Hashing failed", e);
        }
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å®‰å…¨çš„åŠ å¯†ç®—æ³•
@Service
public class CryptoService {
    private static final String AES_ALGORITHM = "AES/GCM/NoPadding";
    private static final String HASH_ALGORITHM = "SHA-256";
    private static final int GCM_IV_LENGTH = 12;
    private static final int GCM_TAG_LENGTH = 16;
    
    public EncryptionResult encrypt(String data, SecretKey secretKey) {
        try {
            // å®‰å…¨ï¼šä½¿ç”¨AES-GCMæ¨¡å¼
            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);
            
            // å®‰å…¨ï¼šç”ŸæˆéšæœºIV
            byte[] iv = generateSecureRandom(GCM_IV_LENGTH);
            GCMParameterSpec gcmSpec = new GCMParameterSpec(GCM_TAG_LENGTH * 8, iv);
            cipher.init(Cipher.ENCRYPT_MODE, secretKey, gcmSpec);
            
            byte[] encrypted = cipher.doFinal(data.getBytes(StandardCharsets.UTF_8));
            
            return new EncryptionResult(encrypted, iv);
        } catch (Exception e) {
            throw new CryptoException("Encryption failed", e);
        }
    }
    
    public String hash(String data, String salt) {
        try {
            // å®‰å…¨ï¼šä½¿ç”¨SHA-256å“ˆå¸Œç®—æ³•
            MessageDigest digest = MessageDigest.getInstance(HASH_ALGORITHM);
            digest.update(salt.getBytes(StandardCharsets.UTF_8));
            byte[] hash = digest.digest(data.getBytes(StandardCharsets.UTF_8));
            
            return Base64.getEncoder().encodeToString(hash);
        } catch (Exception e) {
            throw new CryptoException("Hashing failed", e);
        }
    }
    
    private byte[] generateSecureRandom(int length) {
        // å®‰å…¨ï¼šä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
        SecureRandom secureRandom = new SecureRandom();
        byte[] randomBytes = new byte[length];
        secureRandom.nextBytes(randomBytes);
        return randomBytes;
    }
}
```

### 4.11.3.2 å¯†é’¥ç®¡ç†æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- å¯†é’¥å¿…é¡»å®‰å…¨å­˜å‚¨ï¼Œä¸èƒ½ç¡¬ç¼–ç 
- å®ç°å¯†é’¥è½®æ¢æœºåˆ¶
- å¯†é’¥è®¿é—®å¿…é¡»æœ‰ä¸¥æ ¼çš„æƒé™æ§åˆ¶
- å¯†é’¥ä¼ è¾“å¿…é¡»åŠ å¯†

**æ£€æµ‹æ–¹æ³•ï¼š**
1. å¯†é’¥å­˜å‚¨æ£€æŸ¥ï¼šéªŒè¯å¯†é’¥å­˜å‚¨æ–¹å¼
2. å¯†é’¥è½®æ¢æµ‹è¯•ï¼šéªŒè¯å¯†é’¥è½®æ¢æœºåˆ¶
3. æƒé™æµ‹è¯•ï¼šéªŒè¯å¯†é’¥è®¿é—®æƒé™
4. å®¡è®¡æ£€æŸ¥ï¼šéªŒè¯å¯†é’¥ä½¿ç”¨å®¡è®¡

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä¸å®‰å…¨çš„å¯†é’¥ç®¡ç†
public class CryptoService {
    // å±é™©ï¼šç¡¬ç¼–ç å¯†é’¥
    private static final String SECRET_KEY = "mySecretKey123";
    
    public String encrypt(String data) {
        // å±é™©ï¼šç›´æ¥ä½¿ç”¨ç¡¬ç¼–ç å¯†é’¥
        SecretKeySpec keySpec = new SecretKeySpec(SECRET_KEY.getBytes(), "AES");
        // ... åŠ å¯†é€»è¾‘
        return null;
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„å¯†é’¥ç®¡ç†
@Service
public class KeyManagementService {
    @Value("${app.encryption.key-store-path}")
    private String keyStorePath;
    
    @Value("${app.encryption.key-store-password}")
    private String keyStorePassword;
    
    public SecretKey getKey(String alias) {
        try {
            // å®‰å…¨ï¼šä»å¯†é’¥åº“è·å–å¯†é’¥
            KeyStore keyStore = KeyStore.getInstance("JCEKS");
            keyStore.load(new FileInputStream(keyStorePath), keyStorePassword.toCharArray());
            
            return (SecretKey) keyStore.getKey(alias, keyStorePassword.toCharArray());
        } catch (Exception e) {
            throw new KeyManagementException("Failed to retrieve key: " + alias, e);
        }
    }
    
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void rotateKeys() {
        // å®‰å…¨ï¼šå®šæœŸè½®æ¢å¯†é’¥
        log.info("Starting key rotation process");
        // å®ç°å¯†é’¥è½®æ¢é€»è¾‘
    }
}
```

### 4.11.3.3 éšæœºæ•°ç”Ÿæˆæ£€æŸ¥ ğŸŸ¡

**æ£€æµ‹ç›®æ ‡ï¼š**
- å¿…é¡»ä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
- éšæœºæ•°ç§å­å¿…é¡»ä¸å¯é¢„æµ‹
- å…³é”®åœºæ™¯å¿…é¡»ä½¿ç”¨åŠ å¯†å®‰å…¨çš„éšæœºæ•°
- éšæœºæ•°è´¨é‡å¿…é¡»æ»¡è¶³å®‰å…¨è¦æ±‚

**æ£€æµ‹æ–¹æ³•ï¼š**
1. éšæœºæ•°ç”Ÿæˆå™¨æ£€æŸ¥ï¼šéªŒè¯ä½¿ç”¨çš„éšæœºæ•°ç”Ÿæˆå™¨ç±»å‹
2. éšæœºæ€§æµ‹è¯•ï¼šéªŒè¯ç”Ÿæˆéšæœºæ•°çš„è´¨é‡
3. ç§å­å®‰å…¨æµ‹è¯•ï¼šéªŒè¯éšæœºæ•°ç§å­çš„å®‰å…¨æ€§
4. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯éšæœºæ•°ç”Ÿæˆæ€§èƒ½

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨ä¸å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
public class TokenService {
    private Random random = new Random();
    
    public String generateToken() {
        // å±é™©ï¼šä½¿ç”¨æ™®é€šRandomï¼Œå¯é¢„æµ‹
        StringBuilder token = new StringBuilder();
        for (int i = 0; i < 32; i++) {
            token.append(random.nextInt(10));
        }
        return token.toString();
    }
    
    public String generateSessionId() {
        // å±é™©ï¼šä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºç§å­ï¼Œå¯é¢„æµ‹
        Random r = new Random(System.currentTimeMillis());
        return String.valueOf(r.nextLong());
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
@Service
public class TokenService {
    private final SecureRandom secureRandom;
    
    public TokenService() {
        // å®‰å…¨ï¼šä½¿ç”¨SecureRandom
        this.secureRandom = new SecureRandom();
    }
    
    public String generateToken() {
        // å®‰å…¨ï¼šç”ŸæˆåŠ å¯†å®‰å…¨çš„éšæœºä»¤ç‰Œ
        byte[] randomBytes = new byte[32];
        secureRandom.nextBytes(randomBytes);
        return Base64.getUrlEncoder().withoutPadding().encodeToString(randomBytes);
    }
    
    public String generateSessionId() {
        // å®‰å…¨ï¼šç”ŸæˆåŠ å¯†å®‰å…¨çš„ä¼šè¯ID
        byte[] sessionBytes = new byte[16];
        secureRandom.nextBytes(sessionBytes);
        return bytesToHex(sessionBytes);
    }
    
    private String bytesToHex(byte[] bytes) {
        StringBuilder result = new StringBuilder();
        for (byte b : bytes) {
            result.append(String.format("%02x", b));
        }
        return result.toString();
    }
}
```

## 4.11.4 é€šä¿¡å®‰å…¨æ£€æŸ¥

### 4.11.4.1 HTTPSé…ç½®æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- å¿…é¡»ä½¿ç”¨HTTPSè¿›è¡Œå¤–éƒ¨é€šä¿¡
- SSL/TLSè¯ä¹¦å¿…é¡»æœ‰æ•ˆä¸”æ­£ç¡®é…ç½®
- å¿…é¡»éªŒè¯SSLè¯ä¹¦é“¾
- ç¦ç”¨ä¸å®‰å…¨çš„SSL/TLSç‰ˆæœ¬

**æ£€æµ‹æ–¹æ³•ï¼š**
1. SSLé…ç½®æ£€æŸ¥ï¼šéªŒè¯SSL/TLSé…ç½®
2. è¯ä¹¦éªŒè¯ï¼šæ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæ€§
3. åè®®ç‰ˆæœ¬æ£€æŸ¥ï¼šç¡®è®¤ä½¿ç”¨å®‰å…¨çš„TLSç‰ˆæœ¬
4. åŠ å¯†å¥—ä»¶æ£€æŸ¥ï¼šéªŒè¯åŠ å¯†å¥—ä»¶é…ç½®

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä¸å®‰å…¨çš„HTTPå®¢æˆ·ç«¯é…ç½®
@Service
public class ExternalApiService {
    private final RestTemplate restTemplate;
    
    public ExternalApiService() {
        // å±é™©ï¼šç¦ç”¨SSLéªŒè¯
        TrustManager[] trustAllCerts = new TrustManager[] {
            new X509TrustManager() {
                public X509Certificate[] getAcceptedIssuers() { return null; }
                public void checkClientTrusted(X509Certificate[] certs, String authType) {}
                public void checkServerTrusted(X509Certificate[] certs, String authType) {}
            }
        };
        
        try {
            SSLContext sc = SSLContext.getInstance("SSL");
            sc.init(null, trustAllCerts, new java.security.SecureRandom());
            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());
            HttpsURLConnection.setDefaultHostnameVerifier((hostname, session) -> true);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
        
        this.restTemplate = new RestTemplate();
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„HTTPå®¢æˆ·ç«¯é…ç½®
@Configuration
public class HttpClientConfig {
    
    @Bean
    public RestTemplate secureRestTemplate() throws Exception {
        // å®‰å…¨ï¼šé…ç½®SSLä¸Šä¸‹æ–‡
        SSLContext sslContext = SSLContextBuilder.create()
            .loadTrustMaterial(null, (certificate, authType) -> false) // ä¸¥æ ¼éªŒè¯è¯ä¹¦
            .build();
        
        // å®‰å…¨ï¼šé…ç½®ä¸»æœºåéªŒè¯
        HostnameVerifier hostnameVerifier = new DefaultHostnameVerifier();
        
        SSLConnectionSocketFactory sslSocketFactory = new SSLConnectionSocketFactory(
            sslContext, hostnameVerifier);
        
        HttpClient httpClient = HttpClients.custom()
            .setSSLSocketFactory(sslSocketFactory)
            .setDefaultRequestConfig(RequestConfig.custom()
                .setConnectTimeout(5000)
                .setSocketTimeout(10000)
                .build())
            .build();
        
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory(httpClient);
        
        RestTemplate restTemplate = new RestTemplate(factory);
        
        // å®‰å…¨ï¼šæ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨è®°å½•æ—¥å¿—
        restTemplate.getInterceptors().add(new LoggingClientHttpRequestInterceptor());
        
        return restTemplate;
    }
}
```

### 4.11.4.2 CSRFé˜²æŠ¤æ£€æŸ¥ ğŸ”´

**æ£€æµ‹ç›®æ ‡ï¼š**
- å¿…é¡»å®ç°CSRFé˜²æŠ¤æœºåˆ¶
- çŠ¶æ€æ”¹å˜æ“ä½œå¿…é¡»éªŒè¯CSRFä»¤ç‰Œ
- CSRFä»¤ç‰Œå¿…é¡»ä¸å¯é¢„æµ‹
- å®ç°åŒæºç­–ç•¥æ£€æŸ¥

**æ£€æµ‹æ–¹æ³•ï¼š**
1. CSRFæµ‹è¯•ï¼šéªŒè¯CSRFé˜²æŠ¤æœºåˆ¶
2. ä»¤ç‰ŒéªŒè¯æµ‹è¯•ï¼šéªŒè¯CSRFä»¤ç‰Œæœ‰æ•ˆæ€§
3. è·¨åŸŸæµ‹è¯•ï¼šéªŒè¯è·¨åŸŸè¯·æ±‚å¤„ç†
4. çŠ¶æ€æ”¹å˜æ“ä½œæµ‹è¯•ï¼šéªŒè¯å…³é”®æ“ä½œçš„CSRFä¿æŠ¤

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰CSRFé˜²æŠ¤
@RestController
public class ApiController {
    @PostMapping("/api/transfer")
    public ResponseEntity<String> transfer(@RequestBody TransferRequest request) {
        // å±é™©ï¼šæ²¡æœ‰CSRFé˜²æŠ¤
        // å±é™©ï¼šæ•æ„Ÿæ“ä½œæ²¡æœ‰é¢å¤–éªŒè¯
        transferService.transfer(request.getFromAccount(), 
                               request.getToAccount(), 
                               request.getAmount());
        return ResponseEntity.ok("Transfer completed");
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®Œå–„çš„CSRFé˜²æŠ¤
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
            .csrf(csrf -> csrf
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
                .ignoringRequestMatchers("/api/public/**")
            )
            .build();
    }
}

// âœ… æ­£ç¡®ï¼šéªŒè¯CSRFä»¤ç‰Œçš„API
@RestController
@RequestMapping("/api")
public class SecureApiController {
    
    @PostMapping("/transfer")
    @PreAuthorize("hasRole('USER')")
    public ResponseEntity<TransferResponse> transfer(
            @Valid @RequestBody TransferRequest request,
            @RequestHeader("X-CSRF-TOKEN") String csrfToken,
            Authentication authentication) {
        
        // å®‰å…¨ï¼šéªŒè¯CSRFä»¤ç‰Œ
        if (!csrfTokenService.isValidToken(csrfToken)) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).build();
        }
        
        // å®‰å…¨ï¼šéªŒè¯ç”¨æˆ·æƒé™
        if (!transferService.hasTransferPermission(authentication.getName(), 
                                                  request.getFromAccount())) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).build();
        }
        
        // å®‰å…¨ï¼šæ•æ„Ÿæ“ä½œå®¡è®¡æ—¥å¿—
        auditService.logTransferAttempt(authentication.getName(), request);
        
        TransferResult result = transferService.transfer(request);
        
        return ResponseEntity.ok(new TransferResponse(result.getTransactionId()));
    }
}
```

### 4.11.4.3 å®‰å…¨å¤´éƒ¨æ£€æŸ¥ ğŸŸ¡

**æ£€æµ‹ç›®æ ‡ï¼š**
- å¿…é¡»è®¾ç½®å®‰å…¨çš„HTTPå¤´éƒ¨
- å®ç°å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰
- è®¾ç½®é€‚å½“çš„ç¼“å­˜æ§åˆ¶å¤´éƒ¨
- é˜²æ­¢ç‚¹å‡»åŠ«æŒæ”»å‡»

**æ£€æµ‹æ–¹æ³•ï¼š**
1. å®‰å…¨å¤´éƒ¨æ£€æŸ¥ï¼šç¡®è®¤å®‰å…¨HTTPå¤´éƒ¨è®¾ç½®
2. CSPæµ‹è¯•ï¼šéªŒè¯å†…å®¹å®‰å…¨ç­–ç•¥é…ç½®
3. ç¼“å­˜æµ‹è¯•ï¼šéªŒè¯ç¼“å­˜æ§åˆ¶å¤´éƒ¨
4. ç‚¹å‡»åŠ«æŒæµ‹è¯•ï¼šéªŒè¯X-Frame-Optionsè®¾ç½®

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘å®‰å…¨å¤´éƒ¨
@RestController
public class ApiController {
    @GetMapping("/api/data")
    public ResponseEntity<String> getData() {
        // å±é™©ï¼šæ²¡æœ‰è®¾ç½®å®‰å…¨å¤´éƒ¨
        return ResponseEntity.ok("sensitive data");
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šè®¾ç½®å®‰å…¨å¤´éƒ¨
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
            .headers(headers -> headers
                .frameOptions().deny()
                .contentTypeOptions().and()
                .httpStrictTransportSecurity(hstsConfig -> hstsConfig
                    .maxAgeInSeconds(31536000)
                    .includeSubdomains(true)
                    .preload(true))
                .contentSecurityPolicy("default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'")
            )
            .build();
    }
}

// âœ… æ­£ç¡®ï¼šæ·»åŠ å®‰å…¨å¤´éƒ¨çš„æ‹¦æˆªå™¨
@Component
public class SecurityHeadersInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // è®¾ç½®å®‰å…¨å¤´éƒ¨
        response.setHeader("X-Content-Type-Options", "nosniff");
        response.setHeader("X-Frame-Options", "DENY");
        response.setHeader("X-XSS-Protection", "1; mode=block");
        response.setHeader("Referrer-Policy", "strict-origin-when-cross-origin");
        response.setHeader("Permissions-Policy", "geolocation=(), microphone=(), camera=()");
        
        // ç¼“å­˜æ§åˆ¶
        if (request.getRequestURI().contains("/api/")) {
            response.setHeader("Cache-Control", "no-cache, no-store, must-revalidate");
            response.setHeader("Pragma", "no-cache");
            response.setHeader("Expires", "0");
        }
        
        return true;
    }
}
```