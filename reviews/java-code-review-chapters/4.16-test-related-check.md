# 4.16 æµ‹è¯•ç›¸å…³æ£€æŸ¥

## 4.16.1 å•å…ƒæµ‹è¯•æ£€æŸ¥

### 4.16.1.1 æµ‹è¯•æ–¹æ³•å‘½åè§„èŒƒæ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. æµ‹è¯•æ–¹æ³•åç§°åº”è¯¥æ¸…æ™°è¡¨è¾¾æµ‹è¯•æ„å›¾
b. éµå¾ªç»Ÿä¸€çš„å‘½åçº¦å®šï¼ˆå¦‚ï¼šshould_ReturnExpectedResult_When_GivenConditionï¼‰
c. é¿å…ä½¿ç”¨æ¨¡ç³Šæˆ–æ— æ„ä¹‰çš„æµ‹è¯•æ–¹æ³•å

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æå·¥å…·æ£€æµ‹å‘½åè§„èŒƒ
2. äººå·¥Reviewæµ‹è¯•æ–¹æ³•å‘½å
3. AIè‡ªåŠ¨è¯†åˆ«ä¸è§„èŒƒçš„æµ‹è¯•æ–¹æ³•å

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æµ‹è¯•æ–¹æ³•åä¸æ¸…æ™°
@Test
public void test1() {
    // æ— æ³•ä»æ–¹æ³•åäº†è§£æµ‹è¯•æ„å›¾
}

@Test
public void testUser() {
    // è¿‡äºæ¨¡ç³Šï¼Œä¸çŸ¥é“æµ‹è¯•ä»€ä¹ˆ
}

@Test
public void abc() {
    // å®Œå…¨æ— æ„ä¹‰çš„å‘½å
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ¸…æ™°çš„æµ‹è¯•æ–¹æ³•å‘½å
@Test
public void should_ReturnUser_When_ValidIdProvided() {
    // æ¸…æ™°è¡¨è¾¾ï¼šç»™å®šæœ‰æ•ˆIDæ—¶åº”è¯¥è¿”å›ç”¨æˆ·
    User user = userService.findById(1L);
    assertNotNull(user);
}

@Test
public void should_ThrowException_When_UserNotFound() {
    // æ¸…æ™°è¡¨è¾¾ï¼šç”¨æˆ·ä¸å­˜åœ¨æ—¶åº”è¯¥æŠ›å‡ºå¼‚å¸¸
    assertThrows(UserNotFoundException.class, 
        () -> userService.findById(999L));
}

@Test
public void should_ReturnEmptyList_When_NoUsersExist() {
    // æ¸…æ™°è¡¨è¾¾ï¼šæ²¡æœ‰ç”¨æˆ·æ—¶åº”è¯¥è¿”å›ç©ºåˆ—è¡¨
    List<User> users = userService.findAll();
    assertTrue(users.isEmpty());
}
```

### 4.16.1.2 æµ‹è¯•æ–­è¨€å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. æ¯ä¸ªæµ‹è¯•æ–¹æ³•éƒ½åº”è¯¥æœ‰æ˜ç¡®çš„æ–­è¨€
b. æ–­è¨€åº”è¯¥éªŒè¯é¢„æœŸçš„ç»“æœå’Œè¡Œä¸º
c. é¿å…ç©ºæµ‹è¯•æˆ–åªæœ‰æ‰§è¡Œæ²¡æœ‰éªŒè¯çš„æµ‹è¯•

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†ææ£€æµ‹ç¼ºå°‘æ–­è¨€çš„æµ‹è¯•æ–¹æ³•
2. äººå·¥Reviewæµ‹è¯•çš„éªŒè¯é€»è¾‘
3. æµ‹è¯•è¦†ç›–ç‡å·¥å…·æ£€æµ‹æµ‹è¯•è´¨é‡

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æ²¡æœ‰ä»»ä½•æ–­è¨€
@Test
public void testCreateUser() {
    User user = new User("test@example.com");
    userService.save(user);
    // æ²¡æœ‰éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
}

// âŒ æ–­è¨€ä¸å……åˆ†
@Test
public void testGetUser() {
    User user = userService.findById(1L);
    assertNotNull(user); // åªéªŒè¯ä¸ä¸ºç©ºï¼Œæ²¡æœ‰éªŒè¯å…·ä½“å†…å®¹
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æ–­è¨€éªŒè¯
@Test
public void should_SaveUser_When_ValidUserProvided() {
    User user = new User("test@example.com");
    user.setName("Test User");
    
    User savedUser = userService.save(user);
    
    assertNotNull(savedUser);
    assertNotNull(savedUser.getId());
    assertEquals("test@example.com", savedUser.getEmail());
    assertEquals("Test User", savedUser.getName());
    assertTrue(savedUser.getCreatedAt() != null);
}

@Test
public void should_ReturnCorrectUser_When_ValidIdProvided() {
    User user = userService.findById(1L);
    
    assertNotNull(user);
    assertEquals(1L, user.getId());
    assertEquals("john@example.com", user.getEmail());
    assertEquals("John Doe", user.getName());
}
```

### 4.16.1.3 æµ‹è¯•æ•°æ®éš”ç¦»æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. æµ‹è¯•ä¹‹é—´åº”è¯¥ç›¸äº’ç‹¬ç«‹ï¼Œä¸å—æ‰§è¡Œé¡ºåºå½±å“
b. æ¯ä¸ªæµ‹è¯•åº”è¯¥å‡†å¤‡è‡ªå·±çš„æµ‹è¯•æ•°æ®
c. æµ‹è¯•å®Œæˆååº”è¯¥æ¸…ç†æµ‹è¯•æ•°æ®

**2. æ£€æµ‹æ–¹æ³•**

1. æµ‹è¯•æ¡†æ¶æ£€æµ‹æµ‹è¯•é—´çš„æ•°æ®ä¾èµ–
2. äººå·¥Reviewæµ‹è¯•æ•°æ®çš„å‡†å¤‡å’Œæ¸…ç†
3. éšæœºæ‰§è¡Œæµ‹è¯•é¡ºåºéªŒè¯ç‹¬ç«‹æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æµ‹è¯•é—´å­˜åœ¨æ•°æ®ä¾èµ–
public class UserServiceTest {
    private static Long userId;
    
    @Test
    public void test1_CreateUser() {
        User user = userService.save(new User("test@example.com"));
        userId = user.getId(); // ä¾èµ–é™æ€å˜é‡ä¼ é€’æ•°æ®
    }
    
    @Test
    public void test2_UpdateUser() {
        User user = userService.findById(userId); // ä¾èµ–å‰ä¸€ä¸ªæµ‹è¯•çš„ç»“æœ
        user.setName("Updated Name");
        userService.save(user);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæµ‹è¯•æ•°æ®ç‹¬ç«‹
public class UserServiceTest {
    
    @BeforeEach
    public void setUp() {
        // æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†æ•°æ®
        userRepository.deleteAll();
    }
    
    @Test
    public void should_CreateUser_When_ValidDataProvided() {
        User user = new User("test@example.com");
        
        User savedUser = userService.save(user);
        
        assertNotNull(savedUser.getId());
        assertEquals("test@example.com", savedUser.getEmail());
    }
    
    @Test
    public void should_UpdateUser_When_UserExists() {
        // æ¯ä¸ªæµ‹è¯•å‡†å¤‡è‡ªå·±çš„æ•°æ®
        User user = userRepository.save(new User("original@example.com"));
        
        user.setEmail("updated@example.com");
        User updatedUser = userService.save(user);
        
        assertEquals("updated@example.com", updatedUser.getEmail());
    }
}
```

## 4.16.2 é›†æˆæµ‹è¯•æ£€æŸ¥

### 4.16.2.1 æ¥å£æµ‹è¯•å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰å¯¹å¤–æ¥å£éƒ½åº”è¯¥æœ‰é›†æˆæµ‹è¯•
b. æµ‹è¯•åº”è¯¥è¦†ç›–ä¸åŒçš„HTTPçŠ¶æ€ç å’Œå“åº”æ ¼å¼
c. éªŒè¯æ¥å£çš„è¾“å…¥è¾“å‡ºæ•°æ®æ ¼å¼å’Œä¸šåŠ¡é€»è¾‘

**2. æ£€æµ‹æ–¹æ³•**

1. APIæµ‹è¯•å·¥å…·ï¼ˆå¦‚Postmanã€RestAssuredï¼‰è‡ªåŠ¨åŒ–æµ‹è¯•
2. äººå·¥Reviewæ¥å£æµ‹è¯•è¦†ç›–æƒ…å†µ
3. é›†æˆæµ‹è¯•æ¡†æ¶æ£€æµ‹æ¥å£æµ‹è¯•å®Œæ•´æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ åªæµ‹è¯•æˆåŠŸåœºæ™¯ï¼Œç¼ºå°‘é”™è¯¯åœºæ™¯æµ‹è¯•
@Test
public void testGetUser() {
    ResponseEntity<User> response = restTemplate.getForEntity(
        "/api/users/1", User.class);
    assertEquals(HttpStatus.OK, response.getStatusCode());
    // ç¼ºå°‘404ã€500ç­‰é”™è¯¯åœºæ™¯æµ‹è¯•
}

// âŒ æ²¡æœ‰éªŒè¯å“åº”æ•°æ®æ ¼å¼
@Test
public void testCreateUser() {
    User user = new User("test@example.com");
    ResponseEntity<String> response = restTemplate.postForEntity(
        "/api/users", user, String.class);
    assertEquals(HttpStatus.CREATED, response.getStatusCode());
    // æ²¡æœ‰éªŒè¯è¿”å›çš„ç”¨æˆ·æ•°æ®æ˜¯å¦æ­£ç¡®
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æ¥å£æµ‹è¯•è¦†ç›–
@Test
public void should_ReturnUser_When_UserExists() {
    User testUser = userRepository.save(new User("test@example.com"));
    
    ResponseEntity<User> response = restTemplate.getForEntity(
        "/api/users/" + testUser.getId(), User.class);
    
    assertEquals(HttpStatus.OK, response.getStatusCode());
    assertNotNull(response.getBody());
    assertEquals(testUser.getEmail(), response.getBody().getEmail());
}

@Test
public void should_Return404_When_UserNotExists() {
    ResponseEntity<ErrorResponse> response = restTemplate.getForEntity(
        "/api/users/999999", ErrorResponse.class);
    
    assertEquals(HttpStatus.NOT_FOUND, response.getStatusCode());
    assertEquals("USER_NOT_FOUND", response.getBody().getErrorCode());
}

@Test
public void should_Return400_When_InvalidEmailFormat() {
    User user = new User("invalid-email");
    
    ResponseEntity<ErrorResponse> response = restTemplate.postForEntity(
        "/api/users", user, ErrorResponse.class);
    
    assertEquals(HttpStatus.BAD_REQUEST, response.getStatusCode());
    assertEquals("INVALID_EMAIL_FORMAT", response.getBody().getErrorCode());
}
```

### 4.16.2.2 æ•°æ®åº“äº‹åŠ¡æµ‹è¯•æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. éªŒè¯äº‹åŠ¡çš„ACIDç‰¹æ€§ï¼ˆåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼‰
b. æµ‹è¯•äº‹åŠ¡å›æ»šæœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
c. éªŒè¯å¹¶å‘è®¿é—®æ—¶çš„æ•°æ®ä¸€è‡´æ€§

**2. æ£€æµ‹æ–¹æ³•**

1. æ•°æ®åº“äº‹åŠ¡æµ‹è¯•æ¡†æ¶éªŒè¯äº‹åŠ¡è¡Œä¸º
2. äººå·¥Reviewäº‹åŠ¡è¾¹ç•Œå’Œå›æ»šé€»è¾‘
3. å¹¶å‘æµ‹è¯•å·¥å…·æ£€æµ‹æ•°æ®ç«äº‰é—®é¢˜

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æ²¡æœ‰æµ‹è¯•äº‹åŠ¡å›æ»š
@Test
public void testTransferMoney() {
    transferService.transfer("A001", "A002", 200.0);
    // åªæµ‹è¯•æˆåŠŸåœºæ™¯ï¼Œæ²¡æœ‰æµ‹è¯•å¤±è´¥æ—¶çš„å›æ»š
}

// âŒ æ²¡æœ‰éªŒè¯äº‹åŠ¡çš„åŸå­æ€§
@Test
public void testBatchUpdate() {
    List<User> users = Arrays.asList(
        new User("user1@example.com"),
        new User("user2@example.com")
    );
    userService.batchUpdate(users);
    // æ²¡æœ‰æµ‹è¯•éƒ¨åˆ†æ›´æ–°å¤±è´¥æ—¶çš„å›æ»š
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæµ‹è¯•äº‹åŠ¡å›æ»š
@Test
@Transactional
@Rollback
public void should_RollbackTransaction_When_TransferFails() {
    Account from = new Account("A001", 1000.0);
    Account to = new Account("A002", 500.0);
    accountRepository.saveAll(Arrays.asList(from, to));
    
    assertThrows(InsufficientFundsException.class, 
        () -> transferService.transfer("A001", "A002", 1500.0));
    
    // éªŒè¯äº‹åŠ¡å›æ»šï¼Œä½™é¢æœªå‘ç”Ÿå˜åŒ–
    assertEquals(1000.0, accountRepository.findByNumber("A001").getBalance());
    assertEquals(500.0, accountRepository.findByNumber("A002").getBalance());
}

@Test
public void should_MaintainAtomicity_When_BatchOperationFails() {
    List<User> users = Arrays.asList(
        new User("valid@example.com"),
        new User("invalid-email") // è¿™ä¸ªä¼šå¯¼è‡´å¤±è´¥
    );
    
    assertThrows(ValidationException.class,
        () -> userService.batchSave(users));
    
    // éªŒè¯åŸå­æ€§ï¼šæ‰€æœ‰æ“ä½œéƒ½åº”è¯¥å›æ»š
    assertEquals(0, userRepository.count());
}
```

### 4.16.2.3 å¤–éƒ¨ä¾èµ–æ¨¡æ‹Ÿæ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰å¤–éƒ¨ä¾èµ–éƒ½åº”è¯¥æœ‰å¯¹åº”çš„Mockæˆ–Stub
b. æ¨¡æ‹Ÿä¸åŒçš„å¤–éƒ¨æœåŠ¡å“åº”åœºæ™¯ï¼ˆæˆåŠŸã€å¤±è´¥ã€è¶…æ—¶ï¼‰
c. éªŒè¯ç³»ç»Ÿåœ¨å¤–éƒ¨ä¾èµ–ä¸å¯ç”¨æ—¶çš„é™çº§å¤„ç†

**2. æ£€æµ‹æ–¹æ³•**

1. Mockæ¡†æ¶ï¼ˆå¦‚Mockitoã€WireMockï¼‰æ£€æµ‹æ¨¡æ‹Ÿè¦†ç›–åº¦
2. äººå·¥Reviewå¤–éƒ¨ä¾èµ–çš„æµ‹è¯•ç­–ç•¥
3. é›†æˆæµ‹è¯•éªŒè¯é™çº§å’Œå®¹é”™æœºåˆ¶

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ç›´æ¥è°ƒç”¨çœŸå®çš„å¤–éƒ¨æœåŠ¡
@Test
public void testSendEmail() {
    EmailService emailService = new EmailService(); // çœŸå®æœåŠ¡
    // ä¾èµ–çœŸå®çš„é‚®ä»¶æœåŠ¡ï¼Œæµ‹è¯•ä¸ç¨³å®š
    boolean result = notificationService.sendWelcomeEmail("test@example.com");
    assertTrue(result);
}

// âŒ æ²¡æœ‰æµ‹è¯•å¤–éƒ¨æœåŠ¡å¤±è´¥çš„åœºæ™¯
@Test
public void testPayment() {
    PaymentService paymentService = mock(PaymentService.class);
    when(paymentService.charge(any())).thenReturn(new PaymentResult(true));
    // åªæµ‹è¯•æˆåŠŸåœºæ™¯ï¼Œæ²¡æœ‰æµ‹è¯•å¤±è´¥ã€è¶…æ—¶ç­‰åœºæ™¯
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨Mockæ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–
@Test
public void should_SendEmail_When_EmailServiceAvailable() {
    EmailService mockEmailService = mock(EmailService.class);
    when(mockEmailService.send(any(EmailRequest.class)))
        .thenReturn(new EmailResponse(true, "SUCCESS"));
    
    NotificationService notificationService = 
        new NotificationService(mockEmailService);
    
    boolean result = notificationService.sendWelcomeEmail("test@example.com");
    
    assertTrue(result);
    verify(mockEmailService).send(argThat(request -> 
        "test@example.com".equals(request.getTo())));
}

@Test
public void should_HandleGracefully_When_EmailServiceFails() {
    EmailService mockEmailService = mock(EmailService.class);
    when(mockEmailService.send(any(EmailRequest.class)))
        .thenThrow(new EmailServiceException("Service unavailable"));
    
    NotificationService notificationService = 
        new NotificationService(mockEmailService);
    
    // éªŒè¯é™çº§å¤„ç†ï¼šä¸åº”è¯¥æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯è¿”å›false
    boolean result = notificationService.sendWelcomeEmail("test@example.com");
    
    assertFalse(result);
}

@Test
public void should_Timeout_When_EmailServiceSlow() {
    EmailService mockEmailService = mock(EmailService.class);
    when(mockEmailService.send(any(EmailRequest.class)))
        .thenAnswer(invocation -> {
            Thread.sleep(5000); // æ¨¡æ‹Ÿè¶…æ—¶
            return new EmailResponse(true, "SUCCESS");
        });
    
    NotificationService notificationService = 
        new NotificationService(mockEmailService);
    
    assertThrows(TimeoutException.class,
        () -> notificationService.sendWelcomeEmail("test@example.com"));
}
```

## 4.16.3 æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥

### 4.16.3.1 ä»£ç è¦†ç›–ç‡è¾¾æ ‡æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. ä»£ç è¦†ç›–ç‡åº”è¾¾åˆ°é¡¹ç›®è¦æ±‚çš„æœ€ä½æ ‡å‡†ï¼ˆé€šå¸¸80%ä»¥ä¸Šï¼‰
b. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡åº”è¾¾åˆ°90%ä»¥ä¸Š
c. æ–°å¢ä»£ç çš„è¦†ç›–ç‡åº”è¾¾åˆ°100%

**2. æ£€æµ‹æ–¹æ³•**

1. JaCoCoç­‰è¦†ç›–ç‡å·¥å…·è‡ªåŠ¨æ£€æµ‹
2. CI/CDæµæ°´çº¿é›†æˆè¦†ç›–ç‡æ£€æŸ¥
3. SonarQubeç­‰è´¨é‡ç®¡ç†å·¥å…·ç›‘æ§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ä¸šåŠ¡é€»è¾‘æ²¡æœ‰æµ‹è¯•è¦†ç›–
public class OrderService {
    public Order processOrder(OrderRequest request) {
        if (request.getAmount() <= 0) {
            throw new IllegalArgumentException("é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        if (request.getItems().isEmpty()) {
            throw new IllegalArgumentException("è®¢å•é¡¹ä¸èƒ½ä¸ºç©º");
        }
        
        // è¿™äº›ä¸šåŠ¡é€»è¾‘åˆ†æ”¯æ²¡æœ‰å¯¹åº”çš„æµ‹è¯•
        Order order = new Order();
        order.setAmount(calculateTotal(request));
        order.setStatus(OrderStatus.PENDING);
        
        return orderRepository.save(order);
    }
    
    private double calculateTotal(OrderRequest request) {
        // å¤æ‚çš„è®¡ç®—é€»è¾‘ï¼Œä½†æ²¡æœ‰å•ç‹¬æµ‹è¯•
        return request.getItems().stream()
            .mapToDouble(item -> item.getPrice() * item.getQuantity())
            .sum();
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æµ‹è¯•è¦†ç›–
@Test
public void should_ProcessOrder_When_ValidRequest() {
    OrderRequest request = new OrderRequest();
    request.setAmount(100.0);
    request.setItems(Arrays.asList(new OrderItem("item1", 50.0, 2)));
    
    Order result = orderService.processOrder(request);
    
    assertNotNull(result);
    assertEquals(100.0, result.getAmount());
    assertEquals(OrderStatus.PENDING, result.getStatus());
}

@Test
public void should_ThrowException_When_AmountIsZero() {
    OrderRequest request = new OrderRequest();
    request.setAmount(0.0);
    
    assertThrows(IllegalArgumentException.class,
        () -> orderService.processOrder(request));
}

@Test
public void should_ThrowException_When_ItemsEmpty() {
    OrderRequest request = new OrderRequest();
    request.setAmount(100.0);
    request.setItems(Collections.emptyList());
    
    assertThrows(IllegalArgumentException.class,
        () -> orderService.processOrder(request));
}

@Test
public void should_CalculateCorrectTotal_When_MultipleItems() {
    OrderRequest request = new OrderRequest();
    request.setItems(Arrays.asList(
        new OrderItem("item1", 10.0, 2),
        new OrderItem("item2", 15.0, 3)
    ));
    
    // é€šè¿‡åå°„æˆ–åŒ…å¯è§æ€§æµ‹è¯•ç§æœ‰æ–¹æ³•
    double total = orderService.calculateTotal(request);
    
    assertEquals(65.0, total); // 10*2 + 15*3 = 65
}
```

### 4.16.3.2 åˆ†æ”¯è¦†ç›–ç‡æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰æ¡ä»¶åˆ†æ”¯éƒ½åº”è¯¥è¢«æµ‹è¯•è¦†ç›–
b. if-elseã€switch-caseã€ä¸‰å…ƒè¿ç®—ç¬¦ç­‰åˆ†æ”¯é€»è¾‘å®Œæ•´æµ‹è¯•
c. å¼‚å¸¸å¤„ç†åˆ†æ”¯ä¹Ÿåº”è¯¥è¢«è¦†ç›–

**2. æ£€æµ‹æ–¹æ³•**

1. åˆ†æ”¯è¦†ç›–ç‡å·¥å…·æ£€æµ‹æœªè¦†ç›–çš„åˆ†æ”¯
2. äººå·¥Reviewå¤æ‚æ¡ä»¶é€»è¾‘çš„æµ‹è¯•
3. é™æ€åˆ†æå·¥å…·è¯†åˆ«åˆ†æ”¯è¦†ç›–ç›²ç‚¹

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ åªæµ‹è¯•äº†éƒ¨åˆ†åˆ†æ”¯
@Test
public void testCalculateDiscount() {
    DiscountCalculator calculator = new DiscountCalculator();
    
    // åªæµ‹è¯•äº†VIPç”¨æˆ·çš„æƒ…å†µ
    double discount = calculator.calculateDiscount(UserType.VIP, 1000.0);
    assertEquals(100.0, discount);
    
    // æ²¡æœ‰æµ‹è¯•REGULARå’ŒPREMIUMç”¨æˆ·çš„åˆ†æ”¯
    // æ²¡æœ‰æµ‹è¯•é‡‘é¢ä¸º0æˆ–è´Ÿæ•°çš„åˆ†æ”¯
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šè¦†ç›–æ‰€æœ‰åˆ†æ”¯
@Test
public void should_CalculateVipDiscount_When_VipUser() {
    DiscountCalculator calculator = new DiscountCalculator();
    
    double discount = calculator.calculateDiscount(UserType.VIP, 1000.0);
    
    assertEquals(100.0, discount); // VIPç”¨æˆ·10%æŠ˜æ‰£
}

@Test
public void should_CalculatePremiumDiscount_When_PremiumUser() {
    DiscountCalculator calculator = new DiscountCalculator();
    
    double discount = calculator.calculateDiscount(UserType.PREMIUM, 1000.0);
    
    assertEquals(50.0, discount); // Premiumç”¨æˆ·5%æŠ˜æ‰£
}

@Test
public void should_CalculateRegularDiscount_When_RegularUser() {
    DiscountCalculator calculator = new DiscountCalculator();
    
    double discount = calculator.calculateDiscount(UserType.REGULAR, 1000.0);
    
    assertEquals(0.0, discount); // æ™®é€šç”¨æˆ·æ— æŠ˜æ‰£
}

@Test
public void should_ReturnZero_When_AmountIsZero() {
    DiscountCalculator calculator = new DiscountCalculator();
    
    double discount = calculator.calculateDiscount(UserType.VIP, 0.0);
    
    assertEquals(0.0, discount);
}

@Test
public void should_ThrowException_When_AmountIsNegative() {
    DiscountCalculator calculator = new DiscountCalculator();
    
    assertThrows(IllegalArgumentException.class,
        () -> calculator.calculateDiscount(UserType.VIP, -100.0));
}
```

### 4.16.3.3 å¼‚å¸¸è·¯å¾„æµ‹è¯•æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸è·¯å¾„éƒ½åº”è¯¥è¢«æµ‹è¯•
b. éªŒè¯å¼‚å¸¸å¤„ç†çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§
c. ç¡®ä¿ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹èƒ½å¤Ÿä¼˜é›…é™çº§

**2. æ£€æµ‹æ–¹æ³•**

1. å¼‚å¸¸è·¯å¾„è¦†ç›–ç‡å·¥å…·æ£€æµ‹
2. äººå·¥Reviewå¼‚å¸¸å¤„ç†é€»è¾‘
3. æ•…éšœæ³¨å…¥æµ‹è¯•éªŒè¯å¼‚å¸¸å¤„ç†

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æ²¡æœ‰æµ‹è¯•å¼‚å¸¸è·¯å¾„
@Test
public void testFileUpload() {
    FileUploadService service = new FileUploadService();
    
    // åªæµ‹è¯•æˆåŠŸåœºæ™¯
    String result = service.uploadFile("test.txt", "content".getBytes());
    assertEquals("upload_success", result);
    
    // æ²¡æœ‰æµ‹è¯•æ–‡ä»¶è¿‡å¤§ã€æ ¼å¼ä¸æ”¯æŒã€ç£ç›˜ç©ºé—´ä¸è¶³ç­‰å¼‚å¸¸åœºæ™¯
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å¼‚å¸¸è·¯å¾„æµ‹è¯•
@Test
public void should_UploadFile_When_ValidFile() {
    FileUploadService service = new FileUploadService();
    
    String result = service.uploadFile("test.txt", "content".getBytes());
    
    assertEquals("upload_success", result);
}

@Test
public void should_ThrowException_When_FileTooLarge() {
    FileUploadService service = new FileUploadService();
    byte[] largeContent = new byte[10 * 1024 * 1024]; // 10MB
    
    assertThrows(FileSizeExceededException.class,
        () -> service.uploadFile("large.txt", largeContent));
}

@Test
public void should_ThrowException_When_UnsupportedFormat() {
    FileUploadService service = new FileUploadService();
    
    assertThrows(UnsupportedFileFormatException.class,
        () -> service.uploadFile("virus.exe", "content".getBytes()));
}

@Test
public void should_ThrowException_When_DiskSpaceInsufficient() {
    FileUploadService service = new FileUploadService();
    // æ¨¡æ‹Ÿç£ç›˜ç©ºé—´ä¸è¶³
    when(diskSpaceChecker.hasEnoughSpace(anyLong())).thenReturn(false);
    
    assertThrows(InsufficientDiskSpaceException.class,
        () -> service.uploadFile("test.txt", "content".getBytes()));
}

@Test
public void should_HandleGracefully_When_NetworkError() {
    FileUploadService service = new FileUploadService();
    // æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
    when(remoteStorageService.upload(any(), any()))
        .thenThrow(new NetworkException("Connection timeout"));
    
    // éªŒè¯é™çº§å¤„ç†ï¼šä¿å­˜åˆ°æœ¬åœ°ä¸´æ—¶ç›®å½•
    String result = service.uploadFile("test.txt", "content".getBytes());
    
    assertEquals("upload_queued", result);
    verify(localTempStorage).save(eq("test.txt"), any());
}
```