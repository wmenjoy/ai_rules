# 4.1 éœ€æ±‚è®¾è®¡ä¸æ£€æŸ¥

## 4.1.1 éœ€æ±‚å˜æ›´å½±å“ ğŸ”´

### 4.1.1.1 å˜æ›´åº”è¯¥éµå®ˆèŒè´£å•ä¸€åŸåˆ™ï¼Œé¿å…å¤§èŒƒå›´çš„ä¿®æ”¹

**1. æ£€æµ‹ç›®æ ‡**

a. æ¯æ¬¡æäº¤åªåšä¸€ä»¶äº‹ã€‚
b. å•ä¸ªç±»/æ–¹æ³•æ˜¯å¦æ‰¿æ‹…å¤šä¸ªèŒè´£ã€‚
c. å˜æ›´æ˜¯å¦åªå½±å“ä¸€å°å—åŠŸèƒ½ï¼Œå½±å“é¢å¯æ§ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. SonarQubeï¼ˆæ£€æµ‹æ–¹æ³•è¿‡é•¿ã€ç±»èŒè´£è¿‡å¤šï¼‰ã€‚
2. äººå·¥æ£€æµ‹ä»£ç çš„å˜åŠ¨æƒ…å†µ
3. AI è‡ªåŠ¨è¯†åˆ«

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ èŒè´£ä¸å•ä¸€
public void processUserRequest(Request req) {
    validateRequest(req);          // éªŒè¯
    updateUserInDatabase(req);     // æ•°æ®åº“æ“ä½œ
    sendNotification(req);         // å‘é€é€šçŸ¥
}

// âŒ å¤§èŒƒå›´ä¿®æ”¹ï¼Œå½±å“é¢è¿‡å¤§
public class UserService {
    // åŒæ—¶ä¿®æ”¹å¤šä¸ªä¸ç›¸å…³çš„æ–¹æ³•
    public void createUser() { /* ä¿®æ”¹1 */ }
    public void updateUser() { /* ä¿®æ”¹2 */ }
    public void deleteUser() { /* ä¿®æ”¹3 */ }
    public void sendEmail() { /* ä¿®æ”¹4 */ }
    public void generateReport() { /* ä¿®æ”¹5 */ }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ‹†åˆ†æˆå¤šä¸ªèŒè´£æ¸…æ™°çš„æ–¹æ³•
public void processUserRequest(Request req) {
    requestValidator.validate(req);
    userUpdater.update(req);
    notifier.send(req);
}

// âœ… æ­£ç¡®ï¼šå•ä¸€èŒè´£ï¼Œå½±å“é¢å¯æ§
public class UserService {
    public void createUser(User user) {
        // åªè´Ÿè´£ç”¨æˆ·åˆ›å»ºé€»è¾‘
        validateUser(user);
        userRepository.save(user);
    }
}

public class NotificationService {
    public void sendWelcomeEmail(User user) {
        // åªè´Ÿè´£é€šçŸ¥é€»è¾‘
        emailSender.send(user.getEmail(), welcomeTemplate);
    }
}
```

### 4.1.1.2 å˜æ›´ä¿®æ”¹åº”è¯¥å‘åå…¼å®¹ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½

**1. æ£€æµ‹ç›®æ ‡**

a. æ˜¯å¦åˆ é™¤æˆ–é‡æ„äº†å¯¹å¤–æ¥å£ã€‚
b. æ˜¯å¦ç§»é™¤æˆ–æ›´æ”¹å·²æœ‰å­—æ®µã€ç±»ã€æ¥å£ã€‚
c. æ˜¯å¦æ›´æ”¹äº†é»˜è®¤è¡Œä¸ºã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. SonarQubeï¼ˆæ£€æµ‹APIå…¼å®¹æ€§ï¼‰ã€‚
2. è¿è¡Œå›å½’æµ‹è¯•ã€‚
3. APIç‰ˆæœ¬å¯¹æ¯”å·¥å…·æ£€æµ‹ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç ´åæ€§æ¥å£å˜æ›´
@RestController
public class UserController {
    // ç›´æ¥åˆ é™¤åŸæœ‰æ¥å£ï¼Œç ´åå‘åå…¼å®¹æ€§
    // @GetMapping("/users/{id}")
    // public User getUser(@PathVariable Long id) { ... }
    
    @GetMapping("/users/{userId}")
    public User getUserInfo(@PathVariable Long userId) {
        // å‚æ•°åå˜æ›´ï¼Œç ´åå…¼å®¹æ€§
    }
}

// âŒ é”™è¯¯ï¼šç§»é™¤å·²æœ‰å­—æ®µ
public class UserResponse {
    private String name;
    // private String email; // åˆ é™¤å­—æ®µï¼Œç ´åå…¼å®¹æ€§
    private String phone;
}

// âŒ é”™è¯¯ï¼šæ›´æ”¹æ–¹æ³•ç­¾å
public class UserService {
    // åŸæ–¹æ³•ï¼špublic User findUser(Long id)
    public Optional<User> findUser(Long id, boolean includeDeleted) {
        // è¿”å›ç±»å‹å’Œå‚æ•°éƒ½å˜æ›´ï¼Œç ´åå…¼å®¹æ€§
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¿æŒå‘åå…¼å®¹
@RestController
public class UserController {
    // ä¿ç•™åŸæœ‰æ¥å£
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        return getUserInfo(id);
    }
    
    // æ–°å¢æ¥å£ï¼Œä¸å½±å“åŸæœ‰åŠŸèƒ½
    @GetMapping("/v2/users/{userId}")
    public UserDetailResponse getUserInfo(@PathVariable Long userId) {
        // æ–°ç‰ˆæœ¬æ¥å£
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨@Deprecatedæ ‡è®°è¿‡æ—¶æ–¹æ³•
public class UserService {
    @Deprecated
    public User findUser(Long id) {
        return findUser(id, false);
    }
    
    public User findUser(Long id, boolean includeDeleted) {
        // æ–°æ–¹æ³•å®ç°
    }
}

// âœ… æ­£ç¡®ï¼šå­—æ®µåªå¢åŠ ï¼Œä¸åˆ é™¤
public class UserResponse {
    private String name;
    private String email;
    private String phone;
    private String address; // æ–°å¢å­—æ®µï¼Œä¸å½±å“å…¼å®¹æ€§
}
```

### 4.1.1.3 å˜æ›´åº”è¯¥æœ‰å®Œå–„çš„å›æ»šå’Œç°åº¦æœºåˆ¶

**1. æ£€æµ‹ç›®æ ‡**

a. æ˜¯å¦æœ‰åŠŸèƒ½å¼€å…³æ§åˆ¶æ–°åŠŸèƒ½ã€‚
b. æ˜¯å¦æœ‰æ•°æ®åº“å˜æ›´çš„å›æ»šè„šæœ¬ã€‚
c. æ˜¯å¦æ”¯æŒç°åº¦å‘å¸ƒå’Œå¿«é€Ÿå›æ»šã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„åŠŸèƒ½å¼€å…³ã€‚
2. æ£€æŸ¥æ•°æ®åº“è¿ç§»è„šæœ¬çš„å›æ»šç‰ˆæœ¬ã€‚
3. æ£€æŸ¥éƒ¨ç½²è„šæœ¬çš„å›æ»šæœºåˆ¶ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰åŠŸèƒ½å¼€å…³çš„æ–°åŠŸèƒ½
@Service
public class PaymentService {
    public void processPayment(Payment payment) {
        // ç›´æ¥ä½¿ç”¨æ–°çš„æ”¯ä»˜é€»è¾‘ï¼Œæ— æ³•å›æ»š
        newPaymentProcessor.process(payment);
    }
}

// âŒ é”™è¯¯ï¼šä¸å¯é€†çš„æ•°æ®åº“å˜æ›´
-- åˆ é™¤åˆ—ï¼Œæ— æ³•å›æ»š
ALTER TABLE users DROP COLUMN old_field;
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŠŸèƒ½å¼€å…³
@Service
public class PaymentService {
    @Value("${feature.new-payment-processor.enabled:false}")
    private boolean newPaymentEnabled;
    
    public void processPayment(Payment payment) {
        if (newPaymentEnabled) {
            newPaymentProcessor.process(payment);
        } else {
            oldPaymentProcessor.process(payment);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå¯å›æ»šçš„æ•°æ®åº“å˜æ›´
-- è¿ç§»è„šæœ¬
ALTER TABLE users ADD COLUMN new_field VARCHAR(255);

-- å›æ»šè„šæœ¬
ALTER TABLE users DROP COLUMN new_field;
```

## 4.1.2 è®¾è®¡ä¸éœ€æ±‚åŒ¹é…æ£€æŸ¥ ğŸ”´

### 4.1.2.1 è®¾è®¡æ–¹æ¡ˆåº”è¯¥æ˜¯éœ€æ±‚åŒ¹é…ã€æˆæœ¬ã€å¯è¡Œæ€§çš„æœ€ä½³å¹³è¡¡

**1. æ£€æµ‹ç›®æ ‡**

a. è®¾è®¡æ˜¯å¦æ»¡è¶³åŠŸèƒ½éœ€æ±‚ã€‚
b. è®¾è®¡æ˜¯å¦æ»¡è¶³éåŠŸèƒ½éœ€æ±‚ï¼ˆæ€§èƒ½ã€å®‰å…¨ã€å¯ç”¨æ€§ï¼‰ã€‚
c. å®ç°æˆæœ¬æ˜¯å¦åˆç†ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. éœ€æ±‚è¿½æº¯çŸ©é˜µæ£€æŸ¥ã€‚
2. æ¶æ„è¯„å®¡å’ŒæŠ€æœ¯æ–¹æ¡ˆè¯„å®¡ã€‚
3. æˆæœ¬æ•ˆç›Šåˆ†æã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šè¿‡åº¦è®¾è®¡ï¼Œæˆæœ¬è¿‡é«˜
public class SimpleCalculator {
    // ä¸ºç®€å•è®¡ç®—å™¨å¼•å…¥å¤æ‚çš„è®¾è®¡æ¨¡å¼
    private CalculatorStrategyFactory strategyFactory;
    private CalculatorCommandInvoker commandInvoker;
    private CalculatorStateManager stateManager;
    
    public double add(double a, double b) {
        CalculatorStrategy strategy = strategyFactory.createAddStrategy();
        CalculatorCommand command = new AddCommand(strategy, a, b);
        return commandInvoker.execute(command);
    }
}

// âŒ é”™è¯¯ï¼šè®¾è®¡ä¸æ»¡è¶³æ€§èƒ½éœ€æ±‚
@Service
public class UserService {
    public List<User> getAllUsers() {
        // ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ç”¨æˆ·ï¼Œä¸æ”¯æŒåˆ†é¡µ
        return userRepository.findAll(); // å¯èƒ½è¿”å›ç™¾ä¸‡çº§æ•°æ®
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šç®€å•éœ€æ±‚ç”¨ç®€å•è®¾è®¡
public class SimpleCalculator {
    public double add(double a, double b) {
        return a + b;
    }
    
    public double subtract(double a, double b) {
        return a - b;
    }
}

// âœ… æ­£ç¡®ï¼šæ»¡è¶³æ€§èƒ½éœ€æ±‚çš„åˆ†é¡µè®¾è®¡
@Service
public class UserService {
    public Page<User> getUsers(Pageable pageable) {
        return userRepository.findAll(pageable);
    }
    
    public List<User> getUsersByIds(List<Long> ids) {
        if (ids.size() > 1000) {
            throw new IllegalArgumentException("æ‰¹é‡æŸ¥è¯¢ä¸èƒ½è¶…è¿‡1000ä¸ªID");
        }
        return userRepository.findAllById(ids);
    }
}
```

### 4.1.2.2 ä»£ç å˜æ›´åº”è¯¥ä¸éœ€æ±‚å£°æ˜ä¸€è‡´

**1. æ£€æµ‹ç›®æ ‡**

a. å®ç°çš„åŠŸèƒ½æ˜¯å¦ä¸éœ€æ±‚æ–‡æ¡£ä¸€è‡´ã€‚
b. æ˜¯å¦æœ‰éœ€æ±‚ä¹‹å¤–çš„é¢å¤–å®ç°ã€‚
c. æ˜¯å¦é—æ¼äº†éœ€æ±‚ä¸­çš„åŠŸèƒ½ç‚¹ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. éœ€æ±‚è¿½æº¯æ£€æŸ¥ã€‚
2. åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹éªŒè¯ã€‚
3. ä»£ç å®¡æŸ¥å¯¹æ¯”éœ€æ±‚æ–‡æ¡£ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå®ç°è¶…å‡ºéœ€æ±‚èŒƒå›´
// éœ€æ±‚ï¼šç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
@Service
public class UserRegistrationService {
    public void registerUser(UserRegistrationRequest request) {
        // éœ€æ±‚èŒƒå›´å†…
        User user = createUser(request);
        userRepository.save(user);
        
        // âŒ è¶…å‡ºéœ€æ±‚ï¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·çš„ç¤¾äº¤åª’ä½“è´¦å·
        socialMediaService.createAccounts(user);
        
        // âŒ è¶…å‡ºéœ€æ±‚ï¼šå‘é€è¥é”€é‚®ä»¶
        marketingService.sendWelcomePromotion(user);
    }
}

// âŒ é”™è¯¯ï¼šé—æ¼éœ€æ±‚åŠŸèƒ½
// éœ€æ±‚ï¼šç”¨æˆ·ç™»å½•éœ€è¦è®°å½•ç™»å½•æ—¥å¿—å’Œæ£€æŸ¥è´¦å·çŠ¶æ€
@Service
public class LoginService {
    public LoginResult login(String username, String password) {
        User user = userRepository.findByUsername(username);
        if (passwordEncoder.matches(password, user.getPassword())) {
            // âŒ é—æ¼ï¼šæ²¡æœ‰è®°å½•ç™»å½•æ—¥å¿—
            // âŒ é—æ¼ï¼šæ²¡æœ‰æ£€æŸ¥è´¦å·çŠ¶æ€ï¼ˆé”å®šã€ç¦ç”¨ç­‰ï¼‰
            return LoginResult.success(user);
        }
        return LoginResult.failure("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¸¥æ ¼æŒ‰ç…§éœ€æ±‚å®ç°
// éœ€æ±‚ï¼šç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ï¼ŒåŒ…å«é‚®ç®±éªŒè¯
@Service
public class UserRegistrationService {
    public void registerUser(UserRegistrationRequest request) {
        // æŒ‰éœ€æ±‚å®ç°ç”¨æˆ·åˆ›å»º
        User user = createUser(request);
        userRepository.save(user);
        
        // æŒ‰éœ€æ±‚å‘é€éªŒè¯é‚®ä»¶
        emailService.sendVerificationEmail(user);
    }
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´å®ç°éœ€æ±‚åŠŸèƒ½
// éœ€æ±‚ï¼šç”¨æˆ·ç™»å½•éœ€è¦è®°å½•ç™»å½•æ—¥å¿—å’Œæ£€æŸ¥è´¦å·çŠ¶æ€
@Service
public class LoginService {
    public LoginResult login(String username, String password) {
        User user = userRepository.findByUsername(username);
        
        // æ£€æŸ¥è´¦å·çŠ¶æ€
        if (!user.isActive()) {
            auditService.logLoginAttempt(username, "ACCOUNT_DISABLED");
            return LoginResult.failure("è´¦å·å·²ç¦ç”¨");
        }
        
        if (passwordEncoder.matches(password, user.getPassword())) {
            // è®°å½•æˆåŠŸç™»å½•æ—¥å¿—
            auditService.logLoginAttempt(username, "SUCCESS");
            return LoginResult.success(user);
        }
        
        // è®°å½•å¤±è´¥ç™»å½•æ—¥å¿—
        auditService.logLoginAttempt(username, "INVALID_PASSWORD");
        return LoginResult.failure("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
}
```

### 4.1.2.3 æ¶æ„è®¾è®¡ä¸€è‡´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿ä»£ç å®ç°éµå¾ªé¢„å®šä¹‰çš„åˆ†å±‚æ¶æ„
b. éªŒè¯è®¾è®¡æ¨¡å¼çš„æ­£ç¡®åº”ç”¨
c. ç¡®ä¿æ¥å£è®¾è®¡ä¸æ¶æ„æ–‡æ¡£ä¸€è‡´

**2. æ£€æµ‹æ–¹æ³•**

1. æ¶æ„åˆè§„æ€§æ£€æŸ¥å·¥å…·
2. ä¾èµ–å…³ç³»åˆ†æ
3. è®¾è®¡æ¨¡å¼è¯†åˆ«å·¥å…·
4. æ¥å£å¥‘çº¦æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ è¿ååˆ†å±‚æ¶æ„
@RestController
public class UserController {
    @Autowired
    private UserRepository userRepository; // é”™è¯¯ï¼šControllerç›´æ¥ä¾èµ–Repository
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        // è·³è¿‡Serviceå±‚ç›´æ¥è°ƒç”¨Repository
        return userRepository.findById(id).orElse(null);
    }
}

// âŒ è®¾è®¡æ¨¡å¼å®ç°é”™è¯¯
public class ConfigManager {
    private static ConfigManager instance;
    
    private ConfigManager() {}
    
    // çº¿ç¨‹ä¸å®‰å…¨çš„å•ä¾‹å®ç°
    public static ConfigManager getInstance() {
        if (instance == null) {
            instance = new ConfigManager(); // å¯èƒ½åˆ›å»ºå¤šä¸ªå®ä¾‹
        }
        return instance;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šéµå¾ªåˆ†å±‚æ¶æ„
@RestController
public class UserController {
    @Autowired
    private UserService userService; // æ­£ç¡®ï¼šControlleråªä¾èµ–Service
    
    @GetMapping("/users/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }
}

// âœ… æ­£ç¡®ï¼šçº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼
public class ConfigManager {
    private static volatile ConfigManager instance;
    
    private ConfigManager() {}
    
    public static ConfigManager getInstance() {
        if (instance == null) {
            synchronized (ConfigManager.class) {
                if (instance == null) {
                    instance = new ConfigManager();
                }
            }
        }
        return instance;
    }
}
```

### 4.1.2.4 éåŠŸèƒ½æ€§éœ€æ±‚å®ç°æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. éªŒè¯æ€§èƒ½éœ€æ±‚çš„å®ç°ï¼ˆå“åº”æ—¶é—´ã€ååé‡ï¼‰
b. æ£€æŸ¥å®‰å…¨éœ€æ±‚çš„å®ç°ï¼ˆæ•°æ®ä¿æŠ¤ã€è®¿é—®æ§åˆ¶ï¼‰
c. ç¡®ä¿å¯ç»´æŠ¤æ€§éœ€æ±‚çš„å®ç°ï¼ˆæ¨¡å—åŒ–ã€å¯æµ‹è¯•æ€§ï¼‰

**2. æ£€æµ‹æ–¹æ³•**

1. æ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•
2. å®‰å…¨ä»£ç å®¡æŸ¥å·¥å…·
3. ä»£ç å¤æ‚åº¦åˆ†æ
4. ä»£ç é‡å¤åº¦æ£€æµ‹

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æ€§èƒ½é—®é¢˜ï¼šN+1æŸ¥è¯¢
@Service
public class OrderService {
    public List<OrderDTO> getAllOrdersWithItems() {
        List<Order> orders = orderRepository.findAll();
        return orders.stream()
            .map(order -> {
                // æ¯ä¸ªè®¢å•éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œæ€§èƒ½å¾ˆå·®
                List<OrderItem> items = orderItemRepository.findByOrderId(order.getId());
                return new OrderDTO(order, items);
            })
            .collect(Collectors.toList());
    }
}

// âŒ å®‰å…¨é—®é¢˜ï¼šSQLæ³¨å…¥é£é™©
@Repository
public class UserRepository {
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public List<User> findByName(String name) {
        // ç›´æ¥æ‹¼æ¥SQLï¼Œå­˜åœ¨æ³¨å…¥é£é™©
        String sql = "SELECT * FROM users WHERE name = '" + name + "'";
        return jdbcTemplate.query(sql, new UserRowMapper());
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨JOINé¿å…N+1æŸ¥è¯¢
@Service
public class OrderService {
    public List<OrderDTO> getAllOrdersWithItems() {
        List<Order> orders = orderRepository.findAllWithItems();
        return orders.stream()
            .map(order -> new OrderDTO(order, order.getItems()))
            .collect(Collectors.toList());
    }
}

@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
    // ä½¿ç”¨JOIN FETCHä¼˜åŒ–æŸ¥è¯¢
    @Query("SELECT o FROM Order o JOIN FETCH o.items")
    List<Order> findAllWithItems();
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
@Repository
public class UserRepository {
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public List<User> findByName(String name) {
        // ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
        String sql = "SELECT * FROM users WHERE name = ?";
        return jdbcTemplate.query(sql, new UserRowMapper(), name);
    }
}
```

## 4.1.3 æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥ ğŸŸ¡

### 4.1.3.1 APIæ–‡æ¡£ä¸ä»£ç å®ç°ä¿æŒä¸€è‡´

**1. æ£€æµ‹ç›®æ ‡**

a. APIæ–‡æ¡£æ˜¯å¦ä¸å®é™…æ¥å£ä¸€è‡´ã€‚
b. å‚æ•°è¯´æ˜æ˜¯å¦å‡†ç¡®å®Œæ•´ã€‚
c. è¿”å›å€¼è¯´æ˜æ˜¯å¦æ­£ç¡®ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä½¿ç”¨Swagger/OpenAPIè‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ã€‚
2. APIæ–‡æ¡£ä¸ä»£ç çš„ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·ã€‚
3. äººå·¥å®¡æŸ¥APIæ–‡æ¡£ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ–‡æ¡£ä¸å®ç°ä¸ä¸€è‡´
/**
 * è·å–ç”¨æˆ·ä¿¡æ¯
 * @param id ç”¨æˆ·ID
 * @return ç”¨æˆ·ä¿¡æ¯
 */
@GetMapping("/users/{id}")
public UserResponse getUser(@PathVariable Long id, 
                           @RequestParam(required = false) Boolean includeDeleted) {
    // å®é™…æœ‰includeDeletedå‚æ•°ï¼Œä½†æ–‡æ¡£ä¸­æ²¡æœ‰è¯´æ˜
    return userService.findUser(id, includeDeleted);
}

// âŒ é”™è¯¯ï¼šè¿”å›å€¼æ–‡æ¡£ä¸å‡†ç¡®
/**
 * åˆ›å»ºç”¨æˆ·
 * @return åˆ›å»ºæˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯
 */
@PostMapping("/users")
public ResponseEntity<ApiResponse<User>> createUser(@RequestBody CreateUserRequest request) {
    // å®é™…è¿”å›åŒ…è£…çš„ApiResponseï¼Œä½†æ–‡æ¡£è¯´æ˜ä¸å‡†ç¡®
    User user = userService.createUser(request);
    return ResponseEntity.ok(ApiResponse.success(user));
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´å‡†ç¡®çš„APIæ–‡æ¡£
/**
 * è·å–ç”¨æˆ·ä¿¡æ¯
 * @param id ç”¨æˆ·ID
 * @param includeDeleted æ˜¯å¦åŒ…å«å·²åˆ é™¤ç”¨æˆ·ï¼Œé»˜è®¤false
 * @return ç”¨æˆ·ä¿¡æ¯
 */
@ApiOperation(value = "è·å–ç”¨æˆ·ä¿¡æ¯", notes = "æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯")
@ApiResponses({
    @ApiResponse(code = 200, message = "è·å–æˆåŠŸ"),
    @ApiResponse(code = 404, message = "ç”¨æˆ·ä¸å­˜åœ¨")
})
@GetMapping("/users/{id}")
public UserResponse getUser(
    @ApiParam(value = "ç”¨æˆ·ID", required = true) @PathVariable Long id,
    @ApiParam(value = "æ˜¯å¦åŒ…å«å·²åˆ é™¤ç”¨æˆ·", defaultValue = "false") 
    @RequestParam(required = false, defaultValue = "false") Boolean includeDeleted) {
    return userService.findUser(id, includeDeleted);
}
```

### 4.1.3.2 ä»£ç æ³¨é‡Šå®Œæ•´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰å…¬å…±ç±»å’Œæ–¹æ³•éƒ½æœ‰JavaDocæ³¨é‡Š
b. å¤æ‚é€»è¾‘æœ‰è¯¦ç»†çš„è§£é‡Šæ³¨é‡Š
c. TODOå’ŒFIXMEæ ‡è®°æœ‰æ˜ç¡®çš„ä»»åŠ¡æè¿°å’Œè´£ä»»äºº

**2. æ£€æµ‹æ–¹æ³•**

1. JavaDocæ£€æŸ¥å·¥å…·
2. ä»£ç å¤æ‚åº¦åˆ†æå·¥å…·
3. TODO/FIXMEæ ‡è®°æ‰«æå·¥å…·
4. ä»£ç å®¡æŸ¥

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ç¼ºå°‘æ³¨é‡Š
public class UserService {
    
    // æ²¡æœ‰æ–¹æ³•æ³¨é‡Š
    public User createUser(String name, String email) {
        validateInput(name, email);
        return userRepository.save(new User(name, email));
    }
    
    // å¤æ‚é€»è¾‘ç¼ºå°‘æ³¨é‡Š
    public BigDecimal calculateDiscount(Order order, Customer customer) {
        BigDecimal discount = BigDecimal.ZERO;
        if (order.getAmount().compareTo(new BigDecimal("1000")) > 0) {
            if (customer.getLevel() == CustomerLevel.VIP) {
                discount = order.getAmount().multiply(new BigDecimal("0.15"));
            } else if (customer.getLevel() == CustomerLevel.GOLD) {
                discount = order.getAmount().multiply(new BigDecimal("0.10"));
            } else {
                discount = order.getAmount().multiply(new BigDecimal("0.05"));
            }
        }
        return discount;
    }
    
    // TODOæ ‡è®°ä¸å®Œæ•´
    // TODO éªŒè¯é‚®ç®±
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
/**
 * ç”¨æˆ·æœåŠ¡ç±»ï¼Œæä¾›ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡æ“ä½œ
 */
public class UserService {
    
    /**
     * åˆ›å»ºæ–°ç”¨æˆ·
     * 
     * @param name ç”¨æˆ·åï¼Œä¸èƒ½ä¸ºç©ºä¸”é•¿åº¦åœ¨2-50å­—ç¬¦ä¹‹é—´
     * @param email ç”¨æˆ·é‚®ç®±ï¼Œå¿…é¡»æ˜¯æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼ä¸”åœ¨ç³»ç»Ÿä¸­å”¯ä¸€
     * @return åˆ›å»ºæˆåŠŸçš„ç”¨æˆ·å¯¹è±¡ï¼ŒåŒ…å«ç”Ÿæˆçš„ç”¨æˆ·ID
     * @throws IllegalArgumentException å½“è¾“å…¥å‚æ•°ä¸ç¬¦åˆè¦æ±‚æ—¶
     * @throws EmailAlreadyExistsException å½“é‚®ç®±å·²å­˜åœ¨æ—¶
     */
    public User createUser(String name, String email) {
        validateInput(name, email);
        return userRepository.save(new User(name, email));
    }
    
    /**
     * è®¡ç®—è®¢å•æŠ˜æ‰£
     * 
     * æŠ˜æ‰£è®¡ç®—è§„åˆ™ï¼š
     * 1. è®¢å•é‡‘é¢ >= 1000å…ƒï¼š
     *    - VIPå®¢æˆ·ï¼šäº«å—15%æŠ˜æ‰£
     *    - é‡‘ç‰Œå®¢æˆ·ï¼šäº«å—10%æŠ˜æ‰£
     *    - æ™®é€šå®¢æˆ·ï¼šäº«å—5%æŠ˜æ‰£
     * 2. è®¢å•é‡‘é¢ < 1000å…ƒï¼šæ— æŠ˜æ‰£
     */
    public BigDecimal calculateDiscount(Order order, Customer customer) {
        BigDecimal discount = BigDecimal.ZERO;
        
        // å¤§é¢è®¢å•æŠ˜æ‰£ç­–ç•¥ï¼ˆ>=1000å…ƒï¼‰
        if (order.getAmount().compareTo(new BigDecimal("1000")) >= 0) {
            // æ ¹æ®å®¢æˆ·ç­‰çº§ç¡®å®šæŠ˜æ‰£ç‡
            if (customer.getLevel() == CustomerLevel.VIP) {
                discount = order.getAmount().multiply(new BigDecimal("0.15"));
            } else if (customer.getLevel() == CustomerLevel.GOLD) {
                discount = order.getAmount().multiply(new BigDecimal("0.10"));
            } else {
                discount = order.getAmount().multiply(new BigDecimal("0.05"));
            }
        }
        
        return discount;
    }
    
    // TODO: æ·»åŠ é‚®ç®±æ ¼å¼éªŒè¯å’Œå”¯ä¸€æ€§æ£€æŸ¥
    // è´Ÿè´£äºº: å¼ ä¸‰ (zhangsan@company.com)
    // è®¡åˆ’å®Œæˆæ—¶é—´: 2024-02-15
}
```

### 4.1.3.3 å˜æ›´æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ¯æ¬¡ä»£ç å˜æ›´éƒ½æœ‰è¯¦ç»†çš„å˜æ›´æ—¥å¿—è®°å½•
b. ç‰ˆæœ¬å‘å¸ƒæœ‰å®Œæ•´çš„ç‰ˆæœ¬è¯´æ˜æ–‡æ¡£
c. é‡å¤§å˜æ›´æä¾›è¯¦ç»†çš„è¿ç§»æŒ‡å—

**2. æ£€æµ‹æ–¹æ³•**

1. Gitæäº¤ä¿¡æ¯è§„èŒƒæ€§æ£€æŸ¥
2. ç‰ˆæœ¬å‘å¸ƒæ–‡æ¡£å®Œæ•´æ€§éªŒè¯
3. è¿ç§»æŒ‡å—å¯æ‰§è¡Œæ€§æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```markdown
<!-- âŒ å˜æ›´æ—¥å¿—è®°å½•ä¸å®Œæ•´ -->
## [1.2.0] - 2024-01-15
### æ›´æ–°å†…å®¹
- ä¿®å¤äº†ä¸€äº›bug
- æ·»åŠ äº†æ–°åŠŸèƒ½
- æ€§èƒ½ä¼˜åŒ–

<!-- âŒ ç‰ˆæœ¬è¯´æ˜æ–‡æ¡£ä¸å®Œæ•´ -->
## v2.0.0 (2024-01-20)
- é‡å¤§æ›´æ–°
- æ–°æ¶æ„
```

**4. æ­£ç¡®ç¤ºä¾‹**

```markdown
<!-- âœ… å®Œæ•´çš„å˜æ›´æ—¥å¿—è®°å½• -->
## [1.2.0] - 2024-01-15

### æ–°å¢åŠŸèƒ½
- **ç”¨æˆ·ç®¡ç†**: æ–°å¢ç”¨æˆ·æ‰‹æœºå·éªŒè¯åŠŸèƒ½ (#123)
  - æ”¯æŒæ‰‹æœºå·æ³¨å†Œå’Œç™»å½•
  - æ·»åŠ æ‰‹æœºå·æ ¼å¼éªŒè¯ï¼ˆæ”¯æŒä¸­å›½å¤§é™†æ‰‹æœºå·ï¼‰

### æ”¹è¿›ä¼˜åŒ–
- **ç”¨æˆ·æœåŠ¡**: ä¼˜åŒ–ç”¨æˆ·æ³¨å†Œæµç¨‹ (#124)
  - é‡æ„ç”¨æˆ·è¾“å…¥éªŒè¯é€»è¾‘ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§
  - ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼

### é—®é¢˜ä¿®å¤
- **è®¢å•å¤„ç†**: ä¿®å¤å¹¶å‘åˆ›å»ºè®¢å•æ—¶çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ (#125)
  - æ·»åŠ ä¹è§‚é”æ§åˆ¶ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹å†²çª
  - ä¼˜åŒ–åº“å­˜æ‰£å‡é€»è¾‘ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### é‡è¦å˜æ›´
- **APIå˜æ›´**: ç”¨æˆ·æ³¨å†Œæ¥å£å‚æ•°è°ƒæ•´
  - åŸæ¥å£ï¼š`POST /api/users {"name": "...", "email": "..."}`
  - æ–°æ¥å£ï¼š`POST /api/users {"name": "...", "email": "...", "phone": "..."}`
  - è¿ç§»æŒ‡å—ï¼šå‚è§ docs/migration/v1.2.0.md

### å‡çº§æŒ‡å—
1. å¤‡ä»½æ•°æ®åº“
2. æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼š`migrations/v1.2.0/*.sql`
3. æ›´æ–°åº”ç”¨ç‰ˆæœ¬
4. æ›´æ–°APIå®¢æˆ·ç«¯ï¼ˆå¦‚éœ€è¦ï¼‰
```

## 4.1.4 é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´

### 4.1.4.1 ä¸šåŠ¡é€»è¾‘åˆ†æ”¯è¦†ç›–å®Œæ•´

**1. æ£€æµ‹ç›®æ ‡**

a. æ­£å¸¸æµç¨‹æ˜¯å¦å®Œæ•´å®ç°ã€‚
b. å¼‚å¸¸æƒ…å†µæ˜¯å¦æœ‰å¤„ç†æœºåˆ¶ã€‚
c. è¾¹ç•Œæ¡ä»¶æ˜¯å¦è€ƒè™‘å‘¨å…¨ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä»£ç è¦†ç›–ç‡æµ‹è¯•ã€‚
2. ä¸šåŠ¡åœºæ™¯æµ‹è¯•ç”¨ä¾‹æ£€æŸ¥ã€‚
3. å¼‚å¸¸è·¯å¾„æµ‹è¯•ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘å¼‚å¸¸å¤„ç†åˆ†æ”¯
@Service
public class OrderService {
    public void processOrder(Order order) {
        // âŒ æ²¡æœ‰æ£€æŸ¥è®¢å•çŠ¶æ€
        // âŒ æ²¡æœ‰æ£€æŸ¥åº“å­˜
        // âŒ æ²¡æœ‰å¤„ç†æ”¯ä»˜å¤±è´¥æƒ…å†µ
        
        paymentService.charge(order.getAmount());
        inventoryService.reduceStock(order.getItems());
        order.setStatus(OrderStatus.COMPLETED);
        orderRepository.save(order);
    }
}

// âŒ é”™è¯¯ï¼šè¾¹ç•Œæ¡ä»¶æœªå¤„ç†
public class DiscountCalculator {
    public BigDecimal calculateDiscount(BigDecimal amount, BigDecimal discountRate) {
        // âŒ æ²¡æœ‰æ£€æŸ¥å‚æ•°ä¸ºnull
        // âŒ æ²¡æœ‰æ£€æŸ¥æŠ˜æ‰£ç‡èŒƒå›´
        return amount.multiply(discountRate);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ä¸šåŠ¡é€»è¾‘åˆ†æ”¯
@Service
public class OrderService {
    public void processOrder(Order order) {
        // æ£€æŸ¥è®¢å•çŠ¶æ€
        if (order.getStatus() != OrderStatus.PENDING) {
            throw new IllegalStateException("è®¢å•çŠ¶æ€ä¸å…è®¸å¤„ç†");
        }
        
        // æ£€æŸ¥åº“å­˜
        if (!inventoryService.checkStock(order.getItems())) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        try {
            // å¤„ç†æ”¯ä»˜
            PaymentResult result = paymentService.charge(order.getAmount());
            if (!result.isSuccess()) {
                order.setStatus(OrderStatus.PAYMENT_FAILED);
                orderRepository.save(order);
                return;
            }
            
            // å‡å°‘åº“å­˜
            inventoryService.reduceStock(order.getItems());
            order.setStatus(OrderStatus.COMPLETED);
            
        } catch (PaymentException e) {
            order.setStatus(OrderStatus.PAYMENT_FAILED);
            log.error("è®¢å•æ”¯ä»˜å¤±è´¥: {}", order.getId(), e);
        } catch (Exception e) {
            order.setStatus(OrderStatus.FAILED);
            log.error("è®¢å•å¤„ç†å¤±è´¥: {}", order.getId(), e);
        } finally {
            orderRepository.save(order);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
public class DiscountCalculator {
    public BigDecimal calculateDiscount(BigDecimal amount, BigDecimal discountRate) {
        if (amount == null || discountRate == null) {
            throw new IllegalArgumentException("é‡‘é¢å’ŒæŠ˜æ‰£ç‡ä¸èƒ½ä¸ºç©º");
        }
        
        if (amount.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        if (discountRate.compareTo(BigDecimal.ZERO) < 0 || 
            discountRate.compareTo(BigDecimal.ONE) > 0) {
            throw new IllegalArgumentException("æŠ˜æ‰£ç‡å¿…é¡»åœ¨0-1ä¹‹é—´");
        }
        
        return amount.multiply(discountRate);
    }
}
```

### 4.1.4.2 è¾¹ç•Œæ¡ä»¶å¤„ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰è¾“å…¥å‚æ•°çš„è¾¹ç•Œå€¼éƒ½è¢«æ­£ç¡®å¤„ç†
b. æ•°ç»„ã€é›†åˆç­‰æ•°æ®ç»“æ„çš„è¾¹ç•Œè®¿é—®å®‰å…¨
c. æ•°å€¼è®¡ç®—ä¸­çš„è¾¹ç•Œæƒ…å†µå¤„ç†

**2. æ£€æµ‹æ–¹æ³•**

1. è¾¹ç•Œå€¼æµ‹è¯•
2. é™æ€ä»£ç åˆ†æå·¥å…·
3. ä»£ç å®¡æŸ¥æ£€æŸ¥è¾¹ç•Œå¤„ç†
4. å•å…ƒæµ‹è¯•è¦†ç›–è¾¹ç•Œæ¡ä»¶

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ç¼ºå°‘è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
public class UserService {
    
    public User getUserById(Long userId) {
        // æ²¡æœ‰æ£€æŸ¥nullå€¼
        return userRepository.findById(userId).get();
    }
    
    public List<User> getUsersByPage(int page, int size) {
        // æ²¡æœ‰æ£€æŸ¥è´Ÿæ•°å’Œé›¶å€¼
        int offset = page * size;
        return userRepository.findUsers(offset, size);
    }
    
    public String getFirstName(String fullName) {
        // æ²¡æœ‰æ£€æŸ¥ç©ºå­—ç¬¦ä¸²å’Œnull
        return fullName.split(" ")[0];
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„è¾¹ç•Œæ¡ä»¶å¤„ç†
public class UserService {
    
    public User getUserById(Long userId) {
        // æ£€æŸ¥nullå€¼
        if (userId == null) {
            throw new IllegalArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // æ£€æŸ¥IDçš„æœ‰æ•ˆèŒƒå›´
        if (userId <= 0) {
            throw new IllegalArgumentException("ç”¨æˆ·IDå¿…é¡»å¤§äº0");
        }
        
        return userRepository.findById(userId)
            .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
    }
    
    public List<User> getUsersByPage(int page, int size) {
        // æ£€æŸ¥é¡µç è¾¹ç•Œ
        if (page < 0) {
            throw new IllegalArgumentException("é¡µç ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        // æ£€æŸ¥é¡µé¢å¤§å°è¾¹ç•Œ
        if (size <= 0) {
            throw new IllegalArgumentException("é¡µé¢å¤§å°å¿…é¡»å¤§äº0");
        }
        
        if (size > 1000) {
            throw new IllegalArgumentException("é¡µé¢å¤§å°ä¸èƒ½è¶…è¿‡1000");
        }
        
        int offset = page * size;
        return userRepository.findUsers(offset, size);
    }
    
    public String getFirstName(String fullName) {
        // æ£€æŸ¥nullå’Œç©ºå­—ç¬¦ä¸²
        if (fullName == null || fullName.trim().isEmpty()) {
            throw new IllegalArgumentException("å§“åä¸èƒ½ä¸ºç©º");
        }
        
        String trimmedName = fullName.trim();
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç©ºæ ¼
        if (!trimmedName.contains(" ")) {
            return trimmedName; // åªæœ‰ä¸€ä¸ªåå­—
        }
        
        String[] parts = trimmedName.split("\\s+");
        return parts[0];
    }
}
```

### 4.1.4.3 å¼‚å¸¸å¤„ç†å®Œæ•´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸éƒ½è¢«é€‚å½“å¤„ç†
b. å¼‚å¸¸å¤„ç†ç­–ç•¥çš„é€‰æ‹©åˆé€‚
c. æ‰€æœ‰èµ„æºéƒ½æ­£ç¡®å…³é—­ï¼Œé¿å…æ³„æ¼

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æå·¥å…·æ£€æµ‹å¼‚å¸¸å¤„ç†
2. èµ„æºæ³„æ¼æ£€æµ‹å·¥å…·
3. å¼‚å¸¸è·¯å¾„è¦†ç›–æµ‹è¯•
4. ä»£ç å®¡æŸ¥æ£€æŸ¥å¼‚å¸¸å¤„ç†

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å¼‚å¸¸å¤„ç†ä¸å®Œæ•´
public class FileService {
    
    // æ²¡æœ‰å…³é—­æ–‡ä»¶æµ
    public String readFile(String fileName) {
        try {
            FileInputStream fis = new FileInputStream(fileName);
            BufferedReader reader = new BufferedReader(new InputStreamReader(fis));
            StringBuilder content = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                content.append(line).append("\n");
            }
            return content.toString();
        } catch (IOException e) {
            throw new RuntimeException("è¯»å–æ–‡ä»¶å¤±è´¥", e);
        }
        // æ–‡ä»¶æµæ²¡æœ‰å…³é—­ï¼Œé€ æˆèµ„æºæ³„æ¼
    }
    
    // å¼‚å¸¸ä¿¡æ¯ä¸¢å¤±
    public void handleRequest(HttpServletRequest request) {
        try {
            String data = extractData(request);
            processBusinessLogic(data);
        } catch (Exception e) {
            // åªè®°å½•äº†å¼‚å¸¸ç±»å‹ï¼Œä¸¢å¤±äº†å…·ä½“é”™è¯¯ä¿¡æ¯
            throw new RuntimeException("è¯·æ±‚å¤„ç†å¤±è´¥");
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å¼‚å¸¸å¤„ç†
public class FileService {
    
    // ä½¿ç”¨try-with-resourcesè‡ªåŠ¨å…³é—­èµ„æº
    public String readFile(String fileName) {
        if (fileName == null || fileName.trim().isEmpty()) {
            throw new IllegalArgumentException("æ–‡ä»¶åä¸èƒ½ä¸ºç©º");
        }
        
        try (FileInputStream fis = new FileInputStream(fileName);
             BufferedReader reader = new BufferedReader(new InputStreamReader(fis, StandardCharsets.UTF_8))) {
            
            StringBuilder content = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                content.append(line).append(System.lineSeparator());
            }
            
            return content.toString();
            
        } catch (FileNotFoundException e) {
            throw new FileProcessException("æ–‡ä»¶ä¸å­˜åœ¨: " + fileName, e);
        } catch (IOException e) {
            throw new FileProcessException("è¯»å–æ–‡ä»¶å¤±è´¥: " + fileName, e);
        }
    }
    
    // ä¿ç•™å¼‚å¸¸ä¿¡æ¯
    public void handleRequest(HttpServletRequest request) {
        try {
            String data = extractData(request);
            processBusinessLogic(data);
        } catch (DataExtractionException e) {
            log.error("æ•°æ®æå–å¤±è´¥: uri={}", request.getRequestURI(), e);
            throw new RequestProcessException("æ•°æ®æå–å¤±è´¥: " + e.getMessage(), e);
        } catch (BusinessLogicException e) {
            log.error("ä¸šåŠ¡é€»è¾‘å¤„ç†å¤±è´¥: uri={}", request.getRequestURI(), e);
            throw new RequestProcessException("ä¸šåŠ¡å¤„ç†å¤±è´¥: " + e.getMessage(), e);
        } catch (Exception e) {
            log.error("å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿæœªé¢„æœŸå¼‚å¸¸: uri={}", request.getRequestURI(), e);
            throw new RequestProcessException("ç³»ç»Ÿå†…éƒ¨é”™è¯¯", e);
        }
    }
}
```

### 4.1.4.4 å¹¶å‘å®‰å…¨æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å…±äº«èµ„æºçš„çº¿ç¨‹å®‰å…¨è®¿é—®
b. é˜²æ­¢ä¸šåŠ¡é€»è¾‘ä¸­çš„ç«æ€æ¡ä»¶
c. åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å¹¶å‘æ§åˆ¶

**2. æ£€æµ‹æ–¹æ³•**

1. å¹¶å‘æµ‹è¯•å·¥å…·ï¼ˆJMeterã€Gatlingï¼‰
2. é™æ€ä»£ç åˆ†æï¼ˆFindBugsã€SpotBugsï¼‰
3. æ•°æ®åº“å¹¶å‘æµ‹è¯•
4. ä»£ç å®¡æŸ¥æ£€æŸ¥å¹¶å‘å®‰å…¨æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜
public class OrderService {
    
    // ç«æ€æ¡ä»¶ï¼šæ£€æŸ¥å’Œæ›´æ–°ä¸æ˜¯åŸå­æ“ä½œ
    public boolean reserveInventory(String productId, int quantity) {
        Product product = productRepository.findById(productId);
        if (product.getStock() >= quantity) {
            // åœ¨è¿™é‡Œå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹
            product.setStock(product.getStock() - quantity);
            productRepository.save(product);
            return true;
        }
        return false;
    }
    
    // éçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨
    private int orderCounter = 0;
    
    public String generateOrderNumber() {
        orderCounter++; // å¯èƒ½å¯¼è‡´é‡å¤è®¢å•å·
        return "ORDER_" + orderCounter;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šçº¿ç¨‹å®‰å…¨çš„å®ç°
public class OrderService {
    
    // ä½¿ç”¨ä¹è§‚é”é˜²æ­¢ç«æ€æ¡ä»¶
    @Transactional
    public boolean reserveInventory(String productId, int quantity) {
        try {
            Product product = productRepository.findByIdWithLock(productId);
            
            if (product.getStock() >= quantity) {
                product.setStock(product.getStock() - quantity);
                product.setVersion(product.getVersion() + 1); // ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶
                productRepository.save(product);
                return true;
            }
            return false;
            
        } catch (OptimisticLockingFailureException e) {
            // é‡è¯•æœºåˆ¶
            return retryReserveInventory(productId, quantity, 3);
        }
    }
    
    // çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨
    private final AtomicLong orderCounter = new AtomicLong(0);
    
    public String generateOrderNumber() {
        long counter = orderCounter.incrementAndGet();
        return "ORDER_" + System.currentTimeMillis() + "_" + counter;
    }
    
    // åˆ†å¸ƒå¼é”ç¡®ä¿å¹¶å‘å®‰å…¨
    public boolean reserveInventoryWithDistributedLock(String productId, int quantity) {
        String lockKey = "inventory_lock_" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–åˆ†å¸ƒå¼é”
            Boolean lockAcquired = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(10));
                
            if (Boolean.TRUE.equals(lockAcquired)) {
                return reserveInventory(productId, quantity);
            } else {
                throw new ConcurrentModificationException("åº“å­˜æ­£åœ¨è¢«å…¶ä»–æ“ä½œä¿®æ”¹");
            }
            
        } finally {
            // é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    }
}
```

### 4.1.4.5 äº‹åŠ¡ä¸€è‡´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. äº‹åŠ¡è¾¹ç•Œæ­£ç¡®å®šä¹‰ï¼Œé¿å…äº‹åŠ¡èŒƒå›´è¿‡å¤§æˆ–è¿‡å°
b. äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®åˆç†ï¼Œé˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»
c. ç¡®ä¿äº‹åŠ¡å›æ»šæœºåˆ¶æ­£ç¡®å®ç°

**2. æ£€æµ‹æ–¹æ³•**

1. äº‹åŠ¡è¾¹ç•Œåˆ†æå·¥å…·
2. æ•°æ®åº“äº‹åŠ¡æ—¥å¿—åˆ†æ
3. å¹¶å‘æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•
4. ä»£ç å®¡æŸ¥æ£€æŸ¥äº‹åŠ¡è¾¹ç•Œ

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜
@Service
public class OrderService {
    
    // äº‹åŠ¡è¾¹ç•Œè¿‡å¤§ï¼ŒåŒ…å«ä¸å¿…è¦çš„æ“ä½œ
    @Transactional
    public void processOrder(OrderRequest request) {
        // éªŒè¯è®¢å•ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
        validateOrder(request);
        
        // åˆ›å»ºè®¢å•
        Order order = createOrder(request);
        
        // æ‰£å‡åº“å­˜
        inventoryService.reduceStock(request.getProductId(), request.getQuantity());
        
        // å¤„ç†æ”¯ä»˜
        paymentService.processPayment(order.getId(), request.getPaymentInfo());
        
        // å‘é€é€šçŸ¥ä¸åº”è¯¥åœ¨äº‹åŠ¡ä¸­ï¼Œå¯èƒ½å¯¼è‡´äº‹åŠ¡é•¿æ—¶é—´å ç”¨
        notificationService.sendOrderConfirmation(order.getId());
    }
    
    // äº‹åŠ¡è¾¹ç•Œè¿‡å°ï¼Œæ•°æ®ä¸€è‡´æ€§æ— æ³•ä¿è¯
    public void transferMoney(Long fromAccountId, Long toAccountId, BigDecimal amount) {
        // ä¸¤ä¸ªæ“ä½œåˆ†åˆ«åœ¨ä¸åŒäº‹åŠ¡ä¸­ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
        debitAccount(fromAccountId, amount);
        creditAccount(toAccountId, amount);
    }
    
    @Transactional
    private void debitAccount(Long accountId, BigDecimal amount) {
        Account account = accountRepository.findById(accountId);
        account.setBalance(account.getBalance().subtract(amount));
        accountRepository.save(account);
    }
    
    @Transactional
    private void creditAccount(Long accountId, BigDecimal amount) {
        Account account = accountRepository.findById(accountId);
        account.setBalance(account.getBalance().add(amount));
        accountRepository.save(account);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šåˆç†çš„äº‹åŠ¡è¾¹ç•Œ
@Service
public class OrderService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    // åˆç†çš„äº‹åŠ¡è¾¹ç•Œ
    @Transactional(rollbackFor = Exception.class)
    public OrderResult processOrder(OrderRequest request) {
        // éªŒè¯è®¢å•ï¼ˆåœ¨äº‹åŠ¡å¤–è¿›è¡Œï¼‰
        validateOrderRequest(request);
        
        // åˆ›å»ºè®¢å•
        Order order = createOrder(request);
        
        // æ‰£å‡åº“å­˜
        inventoryService.reduceStock(request.getProductId(), request.getQuantity());
        
        // å¤„ç†æ”¯ä»˜
        PaymentResult paymentResult = paymentService.processPayment(
            order.getId(), request.getPaymentInfo());
        
        if (!paymentResult.isSuccess()) {
            throw new PaymentException("æ”¯ä»˜å¤±è´¥: " + paymentResult.getErrorMessage());
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.PAID);
        order.setPaymentId(paymentResult.getPaymentId());
        orderRepository.save(order);
        
        // å‘å¸ƒäº‹ä»¶ï¼ˆäº‹åŠ¡æäº¤åå¼‚æ­¥å¤„ç†é€šçŸ¥ï¼‰
        eventPublisher.publishEvent(new OrderProcessedEvent(order.getId()));
        
        return OrderResult.success(order.getId());
    }
    
    // åŸå­æ€§è½¬è´¦æ“ä½œ
    @Transactional(rollbackFor = Exception.class, isolation = Isolation.READ_COMMITTED)
    public TransferResult transferMoney(TransferRequest request) {
        // åŠ é”é˜²æ­¢å¹¶å‘é—®é¢˜
        Account fromAccount = accountRepository.findByIdForUpdate(request.getFromAccountId());
        Account toAccount = accountRepository.findByIdForUpdate(request.getToAccountId());
        
        if (fromAccount == null || toAccount == null) {
            throw new AccountNotFoundException("è´¦æˆ·ä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥ä½™é¢
        if (fromAccount.getBalance().compareTo(request.getAmount()) < 0) {
            throw new InsufficientBalanceException("ä½™é¢ä¸è¶³");
        }
        
        // æ‰§è¡Œè½¬è´¦
        fromAccount.setBalance(fromAccount.getBalance().subtract(request.getAmount()));
        toAccount.setBalance(toAccount.getBalance().add(request.getAmount()));
        
        // ä¿å­˜è´¦æˆ·çŠ¶æ€
        accountRepository.save(fromAccount);
        accountRepository.save(toAccount);
        
        // è®°å½•è½¬è´¦å†å²
        TransferHistory history = TransferHistory.builder()
            .fromAccountId(request.getFromAccountId())
            .toAccountId(request.getToAccountId())
            .amount(request.getAmount())
            .status(TransferStatus.SUCCESS)
            .createdAt(LocalDateTime.now())
            .build();
        transferHistoryRepository.save(history);
        
        return TransferResult.success(history.getId());
    }
}
```