# 4.3 ä»£ç å½±å“åˆ†ææ£€æŸ¥

## 4.3.1 ä»£ç å˜æ›´å½±å“åˆ†æ

### 4.3.1.1 å˜æ›´èŒƒå›´è¯„ä¼°æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. è¯„ä¼°ä»£ç å˜æ›´çš„å½±å“èŒƒå›´
b. è¯†åˆ«æ½œåœ¨çš„å‰¯ä½œç”¨
c. ç¡®ä¿å˜æ›´ç¬¦åˆæœ€å°å½±å“åŸåˆ™

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æå·¥å…·
2. ä¾èµ–å…³ç³»å›¾åˆ†æ
3. å½±å“åˆ†æå·¥å…·
4. äººå·¥ä»£ç å®¡æŸ¥

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å˜æ›´å½±å“èŒƒå›´è¿‡å¤§ï¼Œæœªå……åˆ†è¯„ä¼°
public class UserService {
    // ä¿®æ”¹æ ¸å¿ƒæ–¹æ³•ç­¾åï¼Œå½±å“æ‰€æœ‰è°ƒç”¨æ–¹
    public void updateUser(Long id, String name, String email, String phone, 
                          String address, Date birthDate, String department) {
        // åŒæ—¶ä¿®æ”¹å¤šä¸ªä¸ç›¸å…³çš„é€»è¾‘
        validateUserData(name, email, phone); // æ–°å¢éªŒè¯é€»è¾‘
        updateUserProfile(id, name, email);   // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
        updateUserContact(id, phone, address); // ä¿®æ”¹è”ç³»æ–¹å¼
        updateUserDepartment(id, department);  // ä¿®æ”¹éƒ¨é—¨ä¿¡æ¯
        sendNotification(id, "profile_updated"); // æ–°å¢é€šçŸ¥é€»è¾‘
        auditLog(id, "user_updated");          // æ–°å¢å®¡è®¡æ—¥å¿—
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå˜æ›´èŒƒå›´å¯æ§ï¼Œå½±å“æœ€å°åŒ–
public class UserService {
    // ä¿æŒåŸæœ‰æ–¹æ³•ç­¾åä¸å˜ï¼Œå‘åå…¼å®¹
    public void updateUser(Long id, String name, String email) {
        updateUserBasicInfo(id, name, email);
    }
    
    // æ–°å¢æ–¹æ³•å¤„ç†æ‰©å±•åŠŸèƒ½ï¼Œä¸å½±å“ç°æœ‰è°ƒç”¨
    public void updateUserProfile(Long id, UserProfileDto profile) {
        validateUserProfile(profile);
        userRepository.updateProfile(id, profile);
        eventPublisher.publishEvent(new UserProfileUpdatedEvent(id));
    }
    
    // å•ç‹¬çš„æ–¹æ³•å¤„ç†è”ç³»æ–¹å¼æ›´æ–°
    public void updateUserContact(Long id, ContactInfoDto contact) {
        validateContactInfo(contact);
        userRepository.updateContact(id, contact);
    }
}
```

### 4.3.1.2 ä¾èµ–å…³ç³»å½±å“æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. è¯†åˆ«ä»£ç å˜æ›´å¯¹ä¾èµ–æ¨¡å—çš„å½±å“
b. æ£€æŸ¥æ¥å£å˜æ›´çš„ä¸‹æ¸¸å½±å“
c. ç¡®ä¿ä¾èµ–å…³ç³»çš„ç¨³å®šæ€§

**2. æ£€æµ‹æ–¹æ³•**

1. ä¾èµ–å…³ç³»å›¾åˆ†æå·¥å…·
2. æ¥å£å˜æ›´æ£€æµ‹å·¥å…·
3. æ¨¡å—é—´è°ƒç”¨é“¾åˆ†æ
4. é›†æˆæµ‹è¯•éªŒè¯

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ä¿®æ”¹æ¥å£ç­¾åï¼Œæœªè€ƒè™‘ä¸‹æ¸¸ä¾èµ–å½±å“
public interface UserService {
    // åŸæ¥å£
    // User getUserById(Long id);
    
    // ç›´æ¥ä¿®æ”¹æ¥å£ç­¾åï¼Œç ´åå‘ä¸‹å…¼å®¹
    UserDto getUserById(Long id, boolean includeDetails);
}

// âŒ ä¿®æ”¹è¿”å›å€¼ç±»å‹ï¼Œå½±å“æ‰€æœ‰è°ƒç”¨æ–¹
public class OrderService {
    // åŸæ–¹æ³•è¿”å›Orderå¯¹è±¡
    // public Order createOrder(OrderRequest request)
    
    // ç›´æ¥ä¿®æ”¹è¿”å›ç±»å‹ï¼Œç ´åç°æœ‰è°ƒç”¨
    public OrderResponse createOrder(OrderRequest request) {
        Order order = processOrder(request);
        return OrderResponse.from(order); // æ‰€æœ‰è°ƒç”¨æ–¹éƒ½éœ€è¦ä¿®æ”¹
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¿æŒæ¥å£å…¼å®¹ï¼Œæ–°å¢é‡è½½æ–¹æ³•
public interface UserService {
    // ä¿æŒåŸæ¥å£ä¸å˜
    User getUserById(Long id);
    
    // æ–°å¢é‡è½½æ–¹æ³•ï¼Œæä¾›æ‰©å±•åŠŸèƒ½
    default UserDto getUserById(Long id, boolean includeDetails) {
        User user = getUserById(id);
        return includeDetails ? 
            UserDto.withDetails(user) : 
            UserDto.basic(user);
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨é€‚é…å™¨æ¨¡å¼ä¿æŒå…¼å®¹æ€§
public class OrderService {
    // ä¿æŒåŸæ–¹æ³•ç­¾å
    public Order createOrder(OrderRequest request) {
        return createOrderWithResponse(request).getOrder();
    }
    
    // æ–°å¢æ–¹æ³•æä¾›æ‰©å±•åŠŸèƒ½
    public OrderResponse createOrderWithResponse(OrderRequest request) {
        Order order = processOrder(request);
        return OrderResponse.builder()
            .order(order)
            .processingTime(calculateProcessingTime())
            .recommendations(getRecommendations(order))
            .build();
    }
}
```

### 4.3.1.3 å‘åå…¼å®¹æ€§æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿APIå˜æ›´ä¸ç ´åç°æœ‰å®¢æˆ·ç«¯
b. éªŒè¯æ•°æ®æ ¼å¼å˜æ›´çš„å…¼å®¹æ€§
c. æ£€æŸ¥é…ç½®å˜æ›´çš„å‘åå…¼å®¹

**2. æ£€æµ‹æ–¹æ³•**

1. APIå…¼å®¹æ€§æµ‹è¯•å·¥å…·
2. ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
3. å›å½’æµ‹è¯•
4. å®¢æˆ·ç«¯å…¼å®¹æ€§éªŒè¯

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ ç›´æ¥åˆ é™¤å­—æ®µï¼Œç ´åå‘åå…¼å®¹
@Entity
public class User {
    private Long id;
    private String name;
    // private String email; // ç›´æ¥åˆ é™¤å­—æ®µï¼Œç ´ååºåˆ—åŒ–å…¼å®¹æ€§
    private String contactInfo; // æ–°å­—æ®µæ›¿æ¢email
}

// âŒ ä¿®æ”¹æšä¸¾å€¼ï¼Œç ´åç°æœ‰æ•°æ®
public enum OrderStatus {
    // PENDING, // åˆ é™¤åŸæœ‰çŠ¶æ€
    CREATED,     // é‡å‘½åçŠ¶æ€å€¼
    PROCESSING,
    COMPLETED
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¿æŒå­—æ®µå…¼å®¹ï¼Œä½¿ç”¨@Deprecatedæ ‡è®°
@Entity
public class User {
    private Long id;
    private String name;
    
    @Deprecated
    @Column(name = "email")
    private String email; // ä¿ç•™åŸå­—æ®µï¼Œæ ‡è®°ä¸ºåºŸå¼ƒ
    
    @Column(name = "contact_info")
    private String contactInfo; // æ–°å­—æ®µ
    
    // æä¾›å…¼å®¹æ€§æ–¹æ³•
    public String getEmail() {
        return email != null ? email : extractEmailFromContact();
    }
    
    public void setEmail(String email) {
        this.email = email;
        if (contactInfo == null) {
            this.contactInfo = email;
        }
    }
}

// âœ… æ­£ç¡®ï¼šä¿æŒæšä¸¾å…¼å®¹ï¼Œæ·»åŠ æ–°å€¼
public enum OrderStatus {
    PENDING,     // ä¿ç•™åŸæœ‰çŠ¶æ€
    CREATED,     // æ–°å¢çŠ¶æ€
    PROCESSING,
    COMPLETED;
    
    // æä¾›å…¼å®¹æ€§æ˜ å°„
    public static OrderStatus fromLegacyStatus(String legacyStatus) {
        switch (legacyStatus) {
            case "PENDING": return PENDING;
            case "NEW": return CREATED; // å…¼å®¹æ—§çš„çŠ¶æ€å
            default: return valueOf(legacyStatus);
        }
    }
}
```

## 4.3.2 æ€§èƒ½å½±å“åˆ†æ

### 4.3.2.1 æ€§èƒ½å›å½’æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æµ‹ä»£ç å˜æ›´æ˜¯å¦å¼•å…¥æ€§èƒ½å›å½’
b. éªŒè¯å…³é”®è·¯å¾„çš„æ€§èƒ½æŒ‡æ ‡
c. ç¡®ä¿å“åº”æ—¶é—´åœ¨å¯æ¥å—èŒƒå›´å†…

**2. æ£€æµ‹æ–¹æ³•**

1. æ€§èƒ½åŸºå‡†æµ‹è¯•
2. å‹åŠ›æµ‹è¯•å¯¹æ¯”
3. APMå·¥å…·ç›‘æ§
4. ä»£ç æ€§èƒ½åˆ†æå·¥å…·

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å¼•å…¥æ€§èƒ½é—®é¢˜çš„ä»£ç å˜æ›´
public class UserService {
    
    public List<User> getActiveUsers() {
        List<User> allUsers = userRepository.findAll(); // N+1æŸ¥è¯¢é—®é¢˜
        
        return allUsers.stream()
            .filter(user -> {
                // æ¯ä¸ªç”¨æˆ·éƒ½æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
                List<Order> orders = orderRepository.findByUserId(user.getId());
                return orders.stream().anyMatch(order -> 
                    order.getCreatedAt().isAfter(Instant.now().minus(30, ChronoUnit.DAYS)));
            })
            .collect(Collectors.toList());
    }
    
    public UserProfile getUserProfile(Long userId) {
        User user = userRepository.findById(userId).orElse(null);
        
        // åŒæ­¥è°ƒç”¨å¤šä¸ªå¤–éƒ¨æœåŠ¡ï¼Œä¸²è¡Œæ‰§è¡Œ
        UserPreferences prefs = preferencesService.getUserPreferences(userId);
        List<Order> orders = orderService.getUserOrders(userId);
        UserStatistics stats = statisticsService.getUserStatistics(userId);
        
        return UserProfile.builder()
            .user(user)
            .preferences(prefs)
            .orders(orders)
            .statistics(stats)
            .build();
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¼˜åŒ–æ€§èƒ½çš„ä»£ç å®ç°
public class UserService {
    
    public List<User> getActiveUsers() {
        // ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼Œé¿å…N+1é—®é¢˜
        Instant thirtyDaysAgo = Instant.now().minus(30, ChronoUnit.DAYS);
        return userRepository.findUsersWithRecentOrders(thirtyDaysAgo);
    }
    
    @Async
    public CompletableFuture<UserProfile> getUserProfileAsync(Long userId) {
        // å¹¶è¡Œè·å–ç”¨æˆ·æ•°æ®
        CompletableFuture<User> userFuture = 
            CompletableFuture.supplyAsync(() -> userRepository.findById(userId).orElse(null));
            
        CompletableFuture<UserPreferences> prefsFuture = 
            CompletableFuture.supplyAsync(() -> preferencesService.getUserPreferences(userId));
            
        CompletableFuture<List<Order>> ordersFuture = 
            CompletableFuture.supplyAsync(() -> orderService.getUserOrders(userId));
            
        CompletableFuture<UserStatistics> statsFuture = 
            CompletableFuture.supplyAsync(() -> statisticsService.getUserStatistics(userId));
        
        // ç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆ
        return CompletableFuture.allOf(userFuture, prefsFuture, ordersFuture, statsFuture)
            .thenApply(v -> UserProfile.builder()
                .user(userFuture.join())
                .preferences(prefsFuture.join())
                .orders(ordersFuture.join())
                .statistics(statsFuture.join())
                .build());
    }
    
    @Cacheable(value = "userProfiles", key = "#userId")
    public UserProfile getUserProfile(Long userId) {
        // ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
        return getUserProfileAsync(userId).join();
    }
}
```

### 4.3.2.2 èµ„æºæ¶ˆè€—å½±å“æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. ç›‘æ§å†…å­˜ä½¿ç”¨å˜åŒ–
b. æ£€æŸ¥CPUæ¶ˆè€—å¢é•¿
c. éªŒè¯æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨

**2. æ£€æµ‹æ–¹æ³•**

1. èµ„æºç›‘æ§å·¥å…·
2. å†…å­˜æ³„æ¼æ£€æµ‹
3. æ€§èƒ½å‰–æå·¥å…·
4. è´Ÿè½½æµ‹è¯•

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ èµ„æºæ¶ˆè€—è¿‡å¤§çš„å®ç°
public class DataProcessor {
    
    public void processLargeDataset(List<String> dataFiles) {
        List<ProcessedData> allData = new ArrayList<>();
        
        for (String file : dataFiles) {
            // ä¸€æ¬¡æ€§åŠ è½½å¤§æ–‡ä»¶åˆ°å†…å­˜
            List<String> lines = Files.readAllLines(Paths.get(file));
            
            for (String line : lines) {
                ProcessedData data = processLine(line);
                allData.add(data); // å†…å­˜æŒç»­å¢é•¿
            }
        }
        
        // æ‰¹é‡ä¿å­˜ï¼Œå ç”¨å¤§é‡å†…å­˜
        dataRepository.saveAll(allData);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šèµ„æºå‹å¥½çš„å®ç°
public class DataProcessor {
    
    private static final int BATCH_SIZE = 1000;
    
    public void processLargeDataset(List<String> dataFiles) {
        for (String file : dataFiles) {
            processFileInBatches(file);
        }
    }
    
    private void processFileInBatches(String filePath) {
        List<ProcessedData> batch = new ArrayList<>(BATCH_SIZE);
        
        try (Stream<String> lines = Files.lines(Paths.get(filePath))) {
            lines.forEach(line -> {
                ProcessedData data = processLine(line);
                batch.add(data);
                
                // è¾¾åˆ°æ‰¹æ¬¡å¤§å°æ—¶ä¿å­˜å¹¶æ¸…ç©º
                if (batch.size() >= BATCH_SIZE) {
                    dataRepository.saveAll(batch);
                    batch.clear(); // é‡Šæ”¾å†…å­˜
                }
            });
            
            // å¤„ç†å‰©ä½™æ•°æ®
            if (!batch.isEmpty()) {
                dataRepository.saveAll(batch);
            }
        } catch (IOException e) {
            throw new DataProcessingException("æ–‡ä»¶å¤„ç†å¤±è´¥: " + filePath, e);
        }
    }
}
```

### 4.3.2.3 å¹¶å‘æ€§èƒ½å½±å“æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æŸ¥å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½è¡¨ç°
b. éªŒè¯çº¿ç¨‹å®‰å…¨æ€§å¯¹æ€§èƒ½çš„å½±å“
c. ç¡®ä¿é«˜å¹¶å‘ä¸‹çš„ç¨³å®šæ€§

**2. æ£€æµ‹æ–¹æ³•**

1. å¹¶å‘å‹åŠ›æµ‹è¯•
2. çº¿ç¨‹ç«äº‰åˆ†æ
3. æ­»é”æ£€æµ‹å·¥å…·
4. å¹¶å‘æ€§èƒ½ç›‘æ§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å¹¶å‘æ€§èƒ½é—®é¢˜çš„å®ç°
public class CounterService {
    
    private Map<String, Integer> counters = new HashMap<>();
    
    // ä½¿ç”¨synchronizedå¯¼è‡´æ€§èƒ½ç“¶é¢ˆ
    public synchronized void increment(String key) {
        counters.put(key, counters.getOrDefault(key, 0) + 1);
    }
    
    public synchronized int getCount(String key) {
        return counters.getOrDefault(key, 0);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šé«˜å¹¶å‘æ€§èƒ½ä¼˜åŒ–
public class CounterService {
    
    private final ConcurrentHashMap<String, AtomicInteger> counters = new ConcurrentHashMap<>();
    
    public void increment(String key) {
        // ä½¿ç”¨ConcurrentHashMapå’ŒAtomicIntegeræé«˜å¹¶å‘æ€§èƒ½
        counters.computeIfAbsent(key, k -> new AtomicInteger(0)).incrementAndGet();
    }
    
    public int getCount(String key) {
        AtomicInteger counter = counters.get(key);
        return counter != null ? counter.get() : 0;
    }
    
    // æ‰¹é‡æ“ä½œä¼˜åŒ–
    public Map<String, Integer> getAllCounts() {
        return counters.entrySet().stream()
            .collect(Collectors.toMap(
                Map.Entry::getKey,
                entry -> entry.getValue().get()
            ));
    }
}
```

## 4.3.3 å®‰å…¨å½±å“åˆ†æ

### 4.3.3.1 å®‰å…¨æ¼æ´å¼•å…¥æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. æ£€æµ‹ä»£ç å˜æ›´æ˜¯å¦å¼•å…¥å®‰å…¨æ¼æ´
b. éªŒè¯è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç 
c. ç¡®ä¿æ•æ„Ÿæ•°æ®å¤„ç†å®‰å…¨

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€å®‰å…¨æ‰«æå·¥å…·
2. åŠ¨æ€å®‰å…¨æµ‹è¯•
3. ä¾èµ–æ¼æ´æ‰«æ
4. å®‰å…¨ä»£ç å®¡æŸ¥

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ å¼•å…¥å®‰å…¨æ¼æ´çš„ä»£ç 
@RestController
public class UserController {
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable String id) {
        // SQLæ³¨å…¥é£é™©
        String sql = "SELECT * FROM users WHERE id = " + id;
        return jdbcTemplate.queryForObject(sql, User.class);
    }
    
    @PostMapping("/users")
    public User createUser(@RequestBody String userData) {
        // XSSé£é™©ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥
        User user = parseUserData(userData);
        return userService.save(user);
    }
    
    @GetMapping("/admin/users")
    public List<User> getAllUsers(HttpServletRequest request) {
        // ç¼ºå°‘æƒé™æ£€æŸ¥
        return userService.findAll();
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„ä»£ç å®ç°
@RestController
@Validated
public class UserController {
    
    @GetMapping("/users/{id}")
    public ResponseEntity<UserDto> getUser(
            @PathVariable @Pattern(regexp = "\\d+", message = "ç”¨æˆ·IDå¿…é¡»æ˜¯æ•°å­—") String id) {
        
        Long userId = Long.parseLong(id);
        
        // ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
            
        // è¿”å›DTOï¼Œé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²
        return ResponseEntity.ok(UserDto.from(user));
    }
    
    @PostMapping("/users")
    public ResponseEntity<UserDto> createUser(
            @RequestBody @Valid CreateUserRequest request) {
        
        // è¾“å…¥éªŒè¯å’Œæ¸…ç†
        String sanitizedName = HtmlUtils.htmlEscape(request.getName());
        String sanitizedEmail = EmailValidator.validate(request.getEmail());
        
        User user = User.builder()
            .name(sanitizedName)
            .email(sanitizedEmail)
            .build();
            
        User savedUser = userService.save(user);
        return ResponseEntity.status(HttpStatus.CREATED)
            .body(UserDto.from(savedUser));
    }
    
    @GetMapping("/admin/users")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<List<UserDto>> getAllUsers(
            Authentication authentication,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        
        // è®°å½•ç®¡ç†å‘˜æ“ä½œ
        auditService.logAdminAccess(authentication.getName(), "GET_ALL_USERS");
        
        // åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…æ•°æ®é‡è¿‡å¤§
        Page<User> users = userService.findAll(PageRequest.of(page, size));
        List<UserDto> userDtos = users.getContent().stream()
            .map(UserDto::from)
            .collect(Collectors.toList());
            
        return ResponseEntity.ok(userDtos);
    }
}
```

### 4.3.3.2 æƒé™å˜æ›´å½±å“æ£€æŸ¥ ğŸ”´

**1. æ£€æµ‹ç›®æ ‡**

a. éªŒè¯æƒé™æ§åˆ¶å˜æ›´çš„æ­£ç¡®æ€§
b. ç¡®ä¿ä¸ä¼šæ„å¤–æå‡æˆ–é™ä½æƒé™
c. æ£€æŸ¥è§’è‰²å’Œæƒé™çš„ä¸€è‡´æ€§

**2. æ£€æµ‹æ–¹æ³•**

1. æƒé™çŸ©é˜µéªŒè¯
2. è§’è‰²æƒé™æµ‹è¯•
3. è®¿é—®æ§åˆ¶æµ‹è¯•
4. æƒé™å‡çº§è·¯å¾„æ£€æŸ¥

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æƒé™æ§åˆ¶ä¸å½“çš„å®ç°
@RestController
public class DocumentController {
    
    @GetMapping("/documents/{id}")
    public Document getDocument(@PathVariable Long id, Authentication auth) {
        // æƒé™æ£€æŸ¥é€»è¾‘é”™è¯¯
        if (auth != null) {
            return documentService.findById(id); // ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½èƒ½è®¿é—®
        }
        throw new UnauthorizedException("æœªç™»å½•");
    }
    
    @DeleteMapping("/documents/{id}")
    public void deleteDocument(@PathVariable Long id, Authentication auth) {
        // ç¼ºå°‘æ‰€æœ‰è€…æ£€æŸ¥
        documentService.delete(id);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¸¥æ ¼çš„æƒé™æ§åˆ¶
@RestController
public class DocumentController {
    
    @GetMapping("/documents/{id}")
    @PreAuthorize("@documentSecurityService.canRead(#id, authentication.name)")
    public ResponseEntity<DocumentDto> getDocument(
            @PathVariable Long id, 
            Authentication authentication) {
        
        Document document = documentService.findById(id)
            .orElseThrow(() -> new DocumentNotFoundException("æ–‡æ¡£ä¸å­˜åœ¨"));
            
        // è®°å½•è®¿é—®æ—¥å¿—
        auditService.logDocumentAccess(id, authentication.getName(), "READ");
        
        return ResponseEntity.ok(DocumentDto.from(document));
    }
    
    @DeleteMapping("/documents/{id}")
    @PreAuthorize("@documentSecurityService.canDelete(#id, authentication.name)")
    public ResponseEntity<Void> deleteDocument(
            @PathVariable Long id, 
            Authentication authentication) {
        
        // åŒé‡æ£€æŸ¥æƒé™
        if (!documentSecurityService.isOwnerOrAdmin(id, authentication.getName())) {
            throw new AccessDeniedException("æ— æƒåˆ é™¤æ­¤æ–‡æ¡£");
        }
        
        documentService.delete(id);
        
        // è®°å½•åˆ é™¤æ“ä½œ
        auditService.logDocumentAccess(id, authentication.getName(), "DELETE");
        
        return ResponseEntity.noContent().build();
    }
}

@Service
public class DocumentSecurityService {
    
    public boolean canRead(Long documentId, String username) {
        Document document = documentService.findById(documentId).orElse(null);
        if (document == null) return false;
        
        // æ£€æŸ¥æ–‡æ¡£å¯è§æ€§å’Œç”¨æˆ·æƒé™
        return document.isPublic() || 
               document.getOwner().equals(username) ||
               hasSharedAccess(documentId, username) ||
               hasAdminRole(username);
    }
    
    public boolean canDelete(Long documentId, String username) {
        return isOwnerOrAdmin(documentId, username);
    }
    
    public boolean isOwnerOrAdmin(Long documentId, String username) {
        Document document = documentService.findById(documentId).orElse(null);
        if (document == null) return false;
        
        return document.getOwner().equals(username) || hasAdminRole(username);
    }
}
```

### 4.3.3.3 æ•°æ®å®‰å…¨å½±å“æ£€æŸ¥ ğŸŸ¡

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
b. éªŒè¯æ•°æ®ä¼ è¾“å®‰å…¨
c. æ£€æŸ¥æ•°æ®è®¿é—®æ—¥å¿—è®°å½•

**2. æ£€æµ‹æ–¹æ³•**

1. æ•°æ®åŠ å¯†éªŒè¯
2. ä¼ è¾“å®‰å…¨æ£€æŸ¥
3. è®¿é—®æ—¥å¿—å®¡è®¡
4. æ•°æ®è„±æ•éªŒè¯

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ æ•°æ®å®‰å…¨é—®é¢˜
@Entity
public class User {
    private String password; // æ˜æ–‡å­˜å‚¨å¯†ç 
    private String creditCard; // æ˜æ–‡å­˜å‚¨ä¿¡ç”¨å¡å·
    private String ssn; // æ˜æ–‡å­˜å‚¨ç¤¾ä¼šä¿é™©å·
    
    // ç›´æ¥è¿”å›æ•æ„Ÿä¿¡æ¯
    public String getPassword() { return password; }
    public String getCreditCard() { return creditCard; }
}

@RestController
public class UserController {
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        // è¿”å›åŒ…å«æ•æ„Ÿä¿¡æ¯çš„å®Œæ•´ç”¨æˆ·å¯¹è±¡
        return userService.findById(id);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„æ•°æ®å¤„ç†
@Entity
public class User {
    @Column(name = "password_hash")
    private String passwordHash; // å­˜å‚¨å¯†ç å“ˆå¸Œ
    
    @Encrypted // è‡ªå®šä¹‰æ³¨è§£ï¼Œå­—æ®µçº§åŠ å¯†
    @Column(name = "credit_card_encrypted")
    private String creditCardEncrypted;
    
    @Encrypted
    @Column(name = "ssn_encrypted")
    private String ssnEncrypted;
    
    // ä¸æä¾›æ•æ„Ÿä¿¡æ¯çš„getter
    public void setPassword(String password) {
        this.passwordHash = passwordEncoder.encode(password);
    }
    
    public boolean checkPassword(String password) {
        return passwordEncoder.matches(password, this.passwordHash);
    }
}

@RestController
public class UserController {
    
    @GetMapping("/users/{id}")
    public ResponseEntity<UserPublicDto> getUser(@PathVariable Long id) {
        User user = userService.findById(id)
            .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
            
        // è¿”å›è„±æ•çš„å…¬å¼€ä¿¡æ¯
        UserPublicDto publicDto = UserPublicDto.builder()
            .id(user.getId())
            .name(user.getName())
            .email(maskEmail(user.getEmail()))
            .createdAt(user.getCreatedAt())
            .build();
            
        return ResponseEntity.ok(publicDto);
    }
    
    @GetMapping("/users/{id}/sensitive")
    @PreAuthorize("@userSecurityService.canAccessSensitiveData(#id, authentication.name)")
    public ResponseEntity<UserSensitiveDto> getSensitiveUserData(
            @PathVariable Long id, 
            Authentication authentication) {
        
        // è®°å½•æ•æ„Ÿæ•°æ®è®¿é—®
        auditService.logSensitiveDataAccess(
            id, authentication.getName(), "USER_SENSITIVE_DATA");
            
        User user = userService.findById(id)
            .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
            
        // è§£å¯†æ•æ„Ÿæ•°æ®ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
        UserSensitiveDto sensitiveDto = UserSensitiveDto.builder()
            .id(user.getId())
            .email(user.getEmail())
            .lastFourCreditCard(getLastFourDigits(user.getCreditCardEncrypted()))
            .build();
            
        return ResponseEntity.ok(sensitiveDto);
    }
    
    private String maskEmail(String email) {
        if (email == null || !email.contains("@")) return "***";
        String[] parts = email.split("@");
        return parts[0].charAt(0) + "***@" + parts[1];
    }
    
    private String getLastFourDigits(String encryptedCard) {
        String decrypted = encryptionService.decrypt(encryptedCard);
        return "****-****-****-" + decrypted.substring(decrypted.length() - 4);
    }
}
```