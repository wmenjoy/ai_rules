# Java ä»£ç å®¡æŸ¥è§„èŒƒæ–‡æ¡£

## Javaä»£ç å®¡æŸ¥è§„èŒƒç®¡ç†åŠæ³•

## ç¬¬ä¸€ç«  æ€»åˆ™

**ç¬¬ä¸€æ¡** ä¸ºäº†è§„èŒƒJavaé¡¹ç›®ä»£ç å®¡æŸ¥å·¥ä½œï¼Œæé«˜ä»£ç è´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§ï¼Œç¡®ä¿é¡¹ç›®äº¤ä»˜è´¨é‡ï¼Œæ ¹æ®å…¬å¸è½¯ä»¶å¼€å‘ç®¡ç†åˆ¶åº¦ï¼Œç»“åˆJavaæŠ€æœ¯æ ˆç‰¹ç‚¹ï¼Œåˆ¶å®šæœ¬ç®¡ç†åŠæ³•ã€‚

**ç¬¬äºŒæ¡** æœ¬åŠæ³•é€‚ç”¨äºå…¬å¸æ‰€æœ‰Javaé¡¹ç›®çš„ä»£ç å®¡æŸ¥å·¥ä½œï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
ï¼ˆä¸€ï¼‰Javaå¾®æœåŠ¡é¡¹ç›®ä»£ç å®¡æŸ¥
ï¼ˆäºŒï¼‰Spring Bootåº”ç”¨ä»£ç å®¡æŸ¥
ï¼ˆä¸‰ï¼‰Java Webåº”ç”¨ä»£ç å®¡æŸ¥
ï¼ˆå››ï¼‰Javaæ‰¹å¤„ç†åº”ç”¨ä»£ç å®¡æŸ¥

**ç¬¬ä¸‰æ¡** Javaä»£ç å®¡æŸ¥åº”éµå¾ªå¦‚ä¸‹åŸåˆ™ï¼š
ï¼ˆä¸€ï¼‰**è´¨é‡ä¼˜å…ˆåŸåˆ™**ï¼šä»£ç è´¨é‡æ˜¯é¡¹ç›®æˆåŠŸçš„åŸºç¡€ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œå®¡æŸ¥æ ‡å‡†
ï¼ˆäºŒï¼‰**å®‰å…¨ç¬¬ä¸€åŸåˆ™**ï¼šæ‰€æœ‰ä»£ç å¿…é¡»é€šè¿‡å®‰å…¨æ€§æ£€æŸ¥ï¼Œé˜²èŒƒå®‰å…¨æ¼æ´
ï¼ˆä¸‰ï¼‰**æ€§èƒ½å¯¼å‘åŸåˆ™**ï¼šå…³æ³¨ä»£ç æ€§èƒ½å½±å“ï¼Œç¡®ä¿ç³»ç»Ÿé«˜æ•ˆè¿è¡Œ
ï¼ˆå››ï¼‰**å¯ç»´æŠ¤æ€§åŸåˆ™**ï¼šä»£ç åº”å…·å¤‡è‰¯å¥½çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
ï¼ˆäº”ï¼‰**æ ‡å‡†åŒ–åŸåˆ™**ï¼šä¸¥æ ¼éµå¾ªç¼–ç è§„èŒƒå’Œæœ€ä½³å®è·µ

**ç¬¬å››æ¡** ä»£ç å®¡æŸ¥è´¨é‡ç­‰çº§å®šä¹‰ï¼š
ï¼ˆä¸€ï¼‰**ğŸ”´ Criticalï¼ˆä¸¥é‡ï¼‰**ï¼šå¿…é¡»ä¿®å¤ï¼Œå¯èƒ½å¯¼è‡´å®‰å…¨æ¼æ´ã€æ€§èƒ½é—®é¢˜æˆ–ç³»ç»Ÿä¸ç¨³å®š
ï¼ˆäºŒï¼‰**ğŸŸ¡ Majorï¼ˆé‡è¦ï¼‰**ï¼šåº”å½“ä¿®å¤ï¼Œå½±å“ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§
ï¼ˆä¸‰ï¼‰**ğŸŸ¢ Minorï¼ˆä¸€èˆ¬ï¼‰**ï¼šå»ºè®®ä¿®å¤ï¼Œä¸»è¦æ˜¯ä»£ç é£æ ¼å’Œæœ€ä½³å®è·µ

## ç¬¬äºŒç«  å·¥ä½œèŒè´£

**ç¬¬äº”æ¡** å¼€å‘äººå‘˜ä¸»è¦èŒè´£ï¼š
ï¼ˆä¸€ï¼‰æŒ‰ç…§æœ¬åŠæ³•è¦æ±‚ç¼–å†™ä»£ç ï¼Œç¡®ä¿ä»£ç è´¨é‡
ï¼ˆäºŒï¼‰æäº¤ä»£ç å‰è¿›è¡Œè‡ªæ£€ï¼Œç¡®ä¿åŸºæœ¬è´¨é‡è¦æ±‚
ï¼ˆä¸‰ï¼‰é…åˆå®¡æŸ¥äººå‘˜å®Œæˆä»£ç å®¡æŸ¥å·¥ä½œ
ï¼ˆå››ï¼‰æ ¹æ®å®¡æŸ¥æ„è§åŠæ—¶ä¿®æ”¹ä»£ç ç¼ºé™·
ï¼ˆäº”ï¼‰æŒç»­å­¦ä¹ å’Œæ”¹è¿›ç¼–ç æŠ€èƒ½

**ç¬¬å…­æ¡** ä»£ç å®¡æŸ¥äººå‘˜ä¸»è¦èŒè´£ï¼š
ï¼ˆä¸€ï¼‰æŒ‰ç…§æœ¬åŠæ³•æ ‡å‡†æ‰§è¡Œä»£ç å®¡æŸ¥å·¥ä½œ
ï¼ˆäºŒï¼‰è¯†åˆ«ä»£ç ä¸­çš„è´¨é‡é—®é¢˜ã€å®‰å…¨éšæ‚£å’Œæ€§èƒ½é£é™©
ï¼ˆä¸‰ï¼‰æä¾›å…·ä½“çš„ä¿®æ”¹å»ºè®®å’Œæœ€ä½³å®è·µæŒ‡å¯¼
ï¼ˆå››ï¼‰è·Ÿè¸ªå®¡æŸ¥é—®é¢˜çš„ä¿®å¤æƒ…å†µ
ï¼ˆäº”ï¼‰å‚ä¸ä»£ç å®¡æŸ¥æ ‡å‡†çš„æŒç»­æ”¹è¿›

**ç¬¬ä¸ƒæ¡** é¡¹ç›®è´Ÿè´£äººä¸»è¦èŒè´£ï¼š
ï¼ˆä¸€ï¼‰ç¡®ä¿é¡¹ç›®ä»£ç å®¡æŸ¥å·¥ä½œçš„æœ‰æ•ˆæ‰§è¡Œ
ï¼ˆäºŒï¼‰åè°ƒè§£å†³ä»£ç å®¡æŸ¥è¿‡ç¨‹ä¸­çš„äº‰è®®
ï¼ˆä¸‰ï¼‰ç›‘æ§é¡¹ç›®ä»£ç è´¨é‡æŒ‡æ ‡
ï¼ˆå››ï¼‰ç»„ç»‡ä»£ç å®¡æŸ¥åŸ¹è®­å’Œç»éªŒåˆ†äº«
ï¼ˆäº”ï¼‰å¯¹é¡¹ç›®æ•´ä½“ä»£ç è´¨é‡è´Ÿè´£

**ç¬¬å…«æ¡** è´¨é‡ç®¡ç†éƒ¨é—¨ä¸»è¦èŒè´£ï¼š
ï¼ˆä¸€ï¼‰åˆ¶å®šå’Œç»´æŠ¤ä»£ç å®¡æŸ¥æ ‡å‡†
ï¼ˆäºŒï¼‰ç›‘ç£ä»£ç å®¡æŸ¥å·¥ä½œçš„æ‰§è¡Œæƒ…å†µ
ï¼ˆä¸‰ï¼‰æ”¶é›†å’Œåˆ†æä»£ç è´¨é‡æ•°æ®
ï¼ˆå››ï¼‰ç»„ç»‡ä»£ç å®¡æŸ¥æœ€ä½³å®è·µæ¨å¹¿
ï¼ˆäº”ï¼‰å¯¹ä»£ç å®¡æŸ¥å·¥ä½œè¿›è¡Œè€ƒæ ¸è¯„ä¼°

## ç¬¬ä¸‰ç«  ä»£ç å®¡æŸ¥ç®¡ç†

**ç¬¬ä¹æ¡** ä»£ç å®¡æŸ¥æµç¨‹ï¼š
ï¼ˆä¸€ï¼‰**ä»£ç æäº¤**ï¼šå¼€å‘äººå‘˜å®Œæˆä»£ç å¼€å‘åï¼Œæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
ï¼ˆäºŒï¼‰**è‡ªæ£€ç¡®è®¤**ï¼šå¼€å‘äººå‘˜è¿›è¡Œä»£ç è‡ªæ£€ï¼Œç¡®ä¿ç¬¦åˆåŸºæœ¬è´¨é‡è¦æ±‚
ï¼ˆä¸‰ï¼‰**å®¡æŸ¥ç”³è¯·**ï¼šé€šè¿‡ä»£ç å®¡æŸ¥å¹³å°æäº¤å®¡æŸ¥ç”³è¯·
ï¼ˆå››ï¼‰**å®¡æŸ¥æ‰§è¡Œ**ï¼šå®¡æŸ¥äººå‘˜æŒ‰ç…§æœ¬åŠæ³•æ ‡å‡†è¿›è¡Œä»£ç å®¡æŸ¥
ï¼ˆäº”ï¼‰**é—®é¢˜åé¦ˆ**ï¼šå®¡æŸ¥äººå‘˜åé¦ˆå‘ç°çš„é—®é¢˜å’Œæ”¹è¿›å»ºè®®
ï¼ˆå…­ï¼‰**é—®é¢˜ä¿®å¤**ï¼šå¼€å‘äººå‘˜æ ¹æ®åé¦ˆä¿®å¤ä»£ç é—®é¢˜
ï¼ˆä¸ƒï¼‰**å®¡æŸ¥é€šè¿‡**ï¼šæ‰€æœ‰Criticalå’ŒMajoré—®é¢˜ä¿®å¤åï¼Œå®¡æŸ¥é€šè¿‡

**ç¬¬åæ¡** ä»£ç å®¡æŸ¥èŒƒå›´ï¼š
ï¼ˆä¸€ï¼‰æ–°å¢åŠŸèƒ½ä»£ç å¿…é¡»è¿›è¡Œå®Œæ•´å®¡æŸ¥
ï¼ˆäºŒï¼‰Bugä¿®å¤ä»£ç å¿…é¡»è¿›è¡Œå®¡æŸ¥
ï¼ˆä¸‰ï¼‰é‡æ„ä»£ç å¿…é¡»è¿›è¡Œå®¡æŸ¥
ï¼ˆå››ï¼‰é…ç½®æ–‡ä»¶å˜æ›´éœ€è¦è¿›è¡Œå®¡æŸ¥
ï¼ˆäº”ï¼‰ç¬¬ä¸‰æ–¹ä¾èµ–å˜æ›´éœ€è¦è¿›è¡Œå®‰å…¨å®¡æŸ¥

**ç¬¬åä¸€æ¡** ä»£ç å®¡æŸ¥æ—¶é™è¦æ±‚ï¼š
ï¼ˆä¸€ï¼‰æ™®é€šåŠŸèƒ½ä»£ç å®¡æŸ¥åº”åœ¨2ä¸ªå·¥ä½œæ—¥å†…å®Œæˆ
ï¼ˆäºŒï¼‰ç´§æ€¥Bugä¿®å¤ä»£ç å®¡æŸ¥åº”åœ¨4å°æ—¶å†…å®Œæˆ
ï¼ˆä¸‰ï¼‰é‡å¤§åŠŸèƒ½æˆ–æ¶æ„å˜æ›´ä»£ç å®¡æŸ¥åº”åœ¨3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆ
ï¼ˆå››ï¼‰å®¡æŸ¥äººå‘˜åº”åŠæ—¶å“åº”å®¡æŸ¥è¯·æ±‚ï¼Œé¿å…å½±å“å¼€å‘è¿›åº¦

## ç¬¬å››ç«  è´¨é‡æ§åˆ¶æ ‡å‡†

**ç¬¬åäºŒæ¡** ä»£ç å®¡æŸ¥åº”æŒ‰ç…§ä»¥ä¸‹æŠ€æœ¯æ ‡å‡†æ‰§è¡Œï¼Œç¡®ä¿ä»£ç è´¨é‡ç¬¦åˆè¦æ±‚ï¼š

### 4.1 éœ€æ±‚è®¾è®¡ä¸æ£€æŸ¥

#### 4.1.1 éœ€æ±‚å˜æ›´å½±å“ ğŸ”´:

##### 4.1.1.1 å˜æ›´åº”è¯¥éµå®ˆèŒè´£å•ä¸€åŸåˆ™ï¼Œé¿å…å¤§èŒƒå›´çš„ä¿®æ”¹

**1. æ£€æµ‹ç›®æ ‡**

a. æ¯æ¬¡æäº¤åªåšä¸€ä»¶äº‹ã€‚
b. å•ä¸ªç±»/æ–¹æ³•æ˜¯å¦æ‰¿æ‹…å¤šä¸ªèŒè´£ã€‚
c. å˜æ›´æ˜¯å¦åªå½±å“ä¸€å°å—åŠŸèƒ½ï¼Œå½±å“é¢å¯æ§ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. SonarQubeï¼ˆæ£€æµ‹æ–¹æ³•è¿‡é•¿ã€ç±»èŒè´£è¿‡å¤šï¼‰ã€‚
2. äººå·¥æ£€æµ‹ä»£ç çš„å˜åŠ¨æƒ…å†µ
3. AI è‡ªåŠ¨è¯†åˆ«

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ èŒè´£ä¸å•ä¸€
public void processUserRequest(Request req) {
    validateRequest(req);          // éªŒè¯
    updateUserInDatabase(req);     // æ•°æ®åº“æ“ä½œ
    sendNotification(req);         // å‘é€é€šçŸ¥
}

// âŒ å¤§èŒƒå›´ä¿®æ”¹ï¼Œå½±å“é¢è¿‡å¤§
public class UserService {
    // åŒæ—¶ä¿®æ”¹å¤šä¸ªä¸ç›¸å…³çš„æ–¹æ³•
    public void createUser() { /* ä¿®æ”¹1 */ }
    public void updateUser() { /* ä¿®æ”¹2 */ }
    public void deleteUser() { /* ä¿®æ”¹3 */ }
    public void sendEmail() { /* ä¿®æ”¹4 */ }
    public void generateReport() { /* ä¿®æ”¹5 */ }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ‹†åˆ†æˆå¤šä¸ªèŒè´£æ¸…æ™°çš„æ–¹æ³•
public void processUserRequest(Request req) {
    requestValidator.validate(req);
    userUpdater.update(req);
    notifier.send(req);
}

// âœ… æ­£ç¡®ï¼šå•ä¸€èŒè´£ï¼Œå½±å“é¢å¯æ§
public class UserService {
    public void createUser(User user) {
        // åªè´Ÿè´£ç”¨æˆ·åˆ›å»ºé€»è¾‘
        validateUser(user);
        userRepository.save(user);
    }
}

public class NotificationService {
    public void sendWelcomeEmail(User user) {
        // åªè´Ÿè´£é€šçŸ¥é€»è¾‘
        emailSender.send(user.getEmail(), welcomeTemplate);
    }
}
```

##### 4.1.1.2 å˜æ›´ä¿®æ”¹åº”è¯¥å‘åå…¼å®¹ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½

**1. æ£€æµ‹ç›®æ ‡**

a. æ˜¯å¦åˆ é™¤æˆ–é‡æ„äº†å¯¹å¤–æ¥å£ã€‚
b. æ˜¯å¦ç§»é™¤æˆ–æ›´æ”¹å·²æœ‰å­—æ®µã€ç±»ã€æ¥å£ã€‚
c. æ˜¯å¦æ›´æ”¹äº†é»˜è®¤è¡Œä¸ºã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. SonarQubeï¼ˆæ£€æµ‹APIå…¼å®¹æ€§ï¼‰ã€‚
2. è¿è¡Œå›å½’æµ‹è¯•ã€‚
3. APIç‰ˆæœ¬å¯¹æ¯”å·¥å…·æ£€æµ‹ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç ´åæ€§æ¥å£å˜æ›´
@RestController
public class UserController {
    // ç›´æ¥åˆ é™¤åŸæœ‰æ¥å£ï¼Œç ´åå‘åå…¼å®¹æ€§
    // @GetMapping("/users/{id}")
    // public User getUser(@PathVariable Long id) { ... }
    
    @GetMapping("/users/{userId}")
    public User getUserInfo(@PathVariable Long userId) {
        // å‚æ•°åå˜æ›´ï¼Œç ´åå…¼å®¹æ€§
    }
}

// âŒ é”™è¯¯ï¼šç§»é™¤å·²æœ‰å­—æ®µ
public class UserResponse {
    private String name;
    // private String email; // åˆ é™¤å­—æ®µï¼Œç ´åå…¼å®¹æ€§
    private String phone;
}

// âŒ é”™è¯¯ï¼šæ›´æ”¹æ–¹æ³•ç­¾å
public class UserService {
    // åŸæ–¹æ³•ï¼špublic User findUser(Long id)
    public Optional<User> findUser(Long id, boolean includeDeleted) {
        // è¿”å›ç±»å‹å’Œå‚æ•°éƒ½å˜æ›´ï¼Œç ´åå…¼å®¹æ€§
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¿æŒå‘åå…¼å®¹
@RestController
public class UserController {
    // ä¿ç•™åŸæœ‰æ¥å£
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        return getUserInfo(id);
    }
    
    // æ–°å¢æ¥å£ï¼Œä¸å½±å“åŸæœ‰åŠŸèƒ½
    @GetMapping("/v2/users/{userId}")
    public UserDetailResponse getUserInfo(@PathVariable Long userId) {
        // æ–°ç‰ˆæœ¬æ¥å£
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨@Deprecatedæ ‡è®°è¿‡æ—¶æ–¹æ³•
public class UserService {
    @Deprecated
    public User findUser(Long id) {
        return findUser(id, false);
    }
    
    public User findUser(Long id, boolean includeDeleted) {
        // æ–°æ–¹æ³•å®ç°
    }
}

// âœ… æ­£ç¡®ï¼šå­—æ®µåªå¢åŠ ï¼Œä¸åˆ é™¤
public class UserResponse {
    private String name;
    private String email;
    private String phone;
    private String address; // æ–°å¢å­—æ®µï¼Œä¸å½±å“å…¼å®¹æ€§
}
```

##### 4.1.1.3 å˜æ›´åº”è¯¥æœ‰å®Œå–„çš„å›æ»šå’Œç°åº¦æœºåˆ¶

**1. æ£€æµ‹ç›®æ ‡**

a. æ˜¯å¦æœ‰åŠŸèƒ½å¼€å…³æ§åˆ¶æ–°åŠŸèƒ½ã€‚
b. æ˜¯å¦æœ‰æ•°æ®åº“å˜æ›´çš„å›æ»šè„šæœ¬ã€‚
c. æ˜¯å¦æ”¯æŒç°åº¦å‘å¸ƒå’Œå¿«é€Ÿå›æ»šã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„åŠŸèƒ½å¼€å…³ã€‚
2. æ£€æŸ¥æ•°æ®åº“è¿ç§»è„šæœ¬çš„å›æ»šç‰ˆæœ¬ã€‚
3. æ£€æŸ¥éƒ¨ç½²è„šæœ¬çš„å›æ»šæœºåˆ¶ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰åŠŸèƒ½å¼€å…³çš„æ–°åŠŸèƒ½
@Service
public class PaymentService {
    public void processPayment(Payment payment) {
        // ç›´æ¥ä½¿ç”¨æ–°çš„æ”¯ä»˜é€»è¾‘ï¼Œæ— æ³•å›æ»š
        newPaymentProcessor.process(payment);
    }
}

// âŒ é”™è¯¯ï¼šä¸å¯é€†çš„æ•°æ®åº“å˜æ›´
-- åˆ é™¤åˆ—ï¼Œæ— æ³•å›æ»š
ALTER TABLE users DROP COLUMN old_field;
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŠŸèƒ½å¼€å…³
@Service
public class PaymentService {
    @Value("${feature.new-payment-processor.enabled:false}")
    private boolean newPaymentEnabled;
    
    public void processPayment(Payment payment) {
        if (newPaymentEnabled) {
            newPaymentProcessor.process(payment);
        } else {
            oldPaymentProcessor.process(payment);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå¯å›æ»šçš„æ•°æ®åº“å˜æ›´
-- è¿ç§»è„šæœ¬
ALTER TABLE users ADD COLUMN new_field VARCHAR(255);

-- å›æ»šè„šæœ¬
ALTER TABLE users DROP COLUMN new_field;
```

#### 4.1.2 è®¾è®¡ä¸éœ€æ±‚åŒ¹é…æ£€æŸ¥ ğŸ”´:

##### 4.1.2.1 è®¾è®¡æ–¹æ¡ˆåº”è¯¥æ˜¯éœ€æ±‚åŒ¹é…ã€æˆæœ¬ã€å¯è¡Œæ€§çš„æœ€ä½³å¹³è¡¡

**1. æ£€æµ‹ç›®æ ‡**

a. è®¾è®¡æ˜¯å¦æ»¡è¶³åŠŸèƒ½éœ€æ±‚ã€‚
b. è®¾è®¡æ˜¯å¦æ»¡è¶³éåŠŸèƒ½éœ€æ±‚ï¼ˆæ€§èƒ½ã€å®‰å…¨ã€å¯ç”¨æ€§ï¼‰ã€‚
c. å®ç°æˆæœ¬æ˜¯å¦åˆç†ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. éœ€æ±‚è¿½æº¯çŸ©é˜µæ£€æŸ¥ã€‚
2. æ¶æ„è¯„å®¡å’ŒæŠ€æœ¯æ–¹æ¡ˆè¯„å®¡ã€‚
3. æˆæœ¬æ•ˆç›Šåˆ†æã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šè¿‡åº¦è®¾è®¡ï¼Œæˆæœ¬è¿‡é«˜
public class SimpleCalculator {
    // ä¸ºç®€å•è®¡ç®—å™¨å¼•å…¥å¤æ‚çš„è®¾è®¡æ¨¡å¼
    private CalculatorStrategyFactory strategyFactory;
    private CalculatorCommandInvoker commandInvoker;
    private CalculatorStateManager stateManager;
    
    public double add(double a, double b) {
        CalculatorStrategy strategy = strategyFactory.createAddStrategy();
        CalculatorCommand command = new AddCommand(strategy, a, b);
        return commandInvoker.execute(command);
    }
}

// âŒ é”™è¯¯ï¼šè®¾è®¡ä¸æ»¡è¶³æ€§èƒ½éœ€æ±‚
@Service
public class UserService {
    public List<User> getAllUsers() {
        // ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ç”¨æˆ·ï¼Œä¸æ”¯æŒåˆ†é¡µ
        return userRepository.findAll(); // å¯èƒ½è¿”å›ç™¾ä¸‡çº§æ•°æ®
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šç®€å•éœ€æ±‚ç”¨ç®€å•è®¾è®¡
public class SimpleCalculator {
    public double add(double a, double b) {
        return a + b;
    }
    
    public double subtract(double a, double b) {
        return a - b;
    }
}

// âœ… æ­£ç¡®ï¼šæ»¡è¶³æ€§èƒ½éœ€æ±‚çš„åˆ†é¡µè®¾è®¡
@Service
public class UserService {
    public Page<User> getUsers(Pageable pageable) {
        return userRepository.findAll(pageable);
    }
    
    public List<User> getUsersByIds(List<Long> ids) {
        if (ids.size() > 1000) {
            throw new IllegalArgumentException("æ‰¹é‡æŸ¥è¯¢ä¸èƒ½è¶…è¿‡1000ä¸ªID");
        }
        return userRepository.findAllById(ids);
    }
}
```

##### 4.1.2.2 ä»£ç å˜æ›´åº”è¯¥ä¸éœ€æ±‚å£°æ˜ä¸€è‡´

**1. æ£€æµ‹ç›®æ ‡**

a. å®ç°çš„åŠŸèƒ½æ˜¯å¦ä¸éœ€æ±‚æ–‡æ¡£ä¸€è‡´ã€‚
b. æ˜¯å¦æœ‰éœ€æ±‚ä¹‹å¤–çš„é¢å¤–å®ç°ã€‚
c. æ˜¯å¦é—æ¼äº†éœ€æ±‚ä¸­çš„åŠŸèƒ½ç‚¹ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. éœ€æ±‚è¿½æº¯æ£€æŸ¥ã€‚
2. åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹éªŒè¯ã€‚
3. ä»£ç å®¡æŸ¥å¯¹æ¯”éœ€æ±‚æ–‡æ¡£ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå®ç°è¶…å‡ºéœ€æ±‚èŒƒå›´
// éœ€æ±‚ï¼šç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
@Service
public class UserRegistrationService {
    public void registerUser(UserRegistrationRequest request) {
        // éœ€æ±‚èŒƒå›´å†…
        User user = createUser(request);
        userRepository.save(user);
        
        // âŒ è¶…å‡ºéœ€æ±‚ï¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·çš„ç¤¾äº¤åª’ä½“è´¦å·
        socialMediaService.createAccounts(user);
        
        // âŒ è¶…å‡ºéœ€æ±‚ï¼šå‘é€è¥é”€é‚®ä»¶
        marketingService.sendWelcomePromotion(user);
    }
}

// âŒ é”™è¯¯ï¼šé—æ¼éœ€æ±‚åŠŸèƒ½
// éœ€æ±‚ï¼šç”¨æˆ·ç™»å½•éœ€è¦è®°å½•ç™»å½•æ—¥å¿—å’Œæ£€æŸ¥è´¦å·çŠ¶æ€
@Service
public class LoginService {
    public LoginResult login(String username, String password) {
        User user = userRepository.findByUsername(username);
        if (passwordEncoder.matches(password, user.getPassword())) {
            // âŒ é—æ¼ï¼šæ²¡æœ‰è®°å½•ç™»å½•æ—¥å¿—
            // âŒ é—æ¼ï¼šæ²¡æœ‰æ£€æŸ¥è´¦å·çŠ¶æ€ï¼ˆé”å®šã€ç¦ç”¨ç­‰ï¼‰
            return LoginResult.success(user);
        }
        return LoginResult.failure("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¸¥æ ¼æŒ‰ç…§éœ€æ±‚å®ç°
// éœ€æ±‚ï¼šç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ï¼ŒåŒ…å«é‚®ç®±éªŒè¯
@Service
public class UserRegistrationService {
    public void registerUser(UserRegistrationRequest request) {
        // æŒ‰éœ€æ±‚å®ç°ç”¨æˆ·åˆ›å»º
        User user = createUser(request);
        userRepository.save(user);
        
        // æŒ‰éœ€æ±‚å‘é€éªŒè¯é‚®ä»¶
        emailService.sendVerificationEmail(user);
    }
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´å®ç°éœ€æ±‚åŠŸèƒ½
// éœ€æ±‚ï¼šç”¨æˆ·ç™»å½•éœ€è¦è®°å½•ç™»å½•æ—¥å¿—å’Œæ£€æŸ¥è´¦å·çŠ¶æ€
@Service
public class LoginService {
    public LoginResult login(String username, String password) {
        User user = userRepository.findByUsername(username);
        
        // æ£€æŸ¥è´¦å·çŠ¶æ€
        if (!user.isActive()) {
            auditService.logLoginAttempt(username, "ACCOUNT_DISABLED");
            return LoginResult.failure("è´¦å·å·²ç¦ç”¨");
        }
        
        if (passwordEncoder.matches(password, user.getPassword())) {
            // è®°å½•æˆåŠŸç™»å½•æ—¥å¿—
            auditService.logLoginAttempt(username, "SUCCESS");
            return LoginResult.success(user);
        }
        
        // è®°å½•å¤±è´¥ç™»å½•æ—¥å¿—
        auditService.logLoginAttempt(username, "INVALID_PASSWORD");
        return LoginResult.failure("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
}
```

#### 4.1.3 æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥ ğŸŸ¡:

##### 4.1.3.1 APIæ–‡æ¡£ä¸ä»£ç å®ç°ä¿æŒä¸€è‡´

**1. æ£€æµ‹ç›®æ ‡**

a. APIæ–‡æ¡£æ˜¯å¦ä¸å®é™…æ¥å£ä¸€è‡´ã€‚
b. å‚æ•°è¯´æ˜æ˜¯å¦å‡†ç¡®å®Œæ•´ã€‚
c. è¿”å›å€¼è¯´æ˜æ˜¯å¦æ­£ç¡®ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä½¿ç”¨Swagger/OpenAPIè‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ã€‚
2. APIæ–‡æ¡£ä¸ä»£ç çš„ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·ã€‚
3. äººå·¥å®¡æŸ¥APIæ–‡æ¡£ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ–‡æ¡£ä¸å®ç°ä¸ä¸€è‡´
/**
 * è·å–ç”¨æˆ·ä¿¡æ¯
 * @param id ç”¨æˆ·ID
 * @return ç”¨æˆ·ä¿¡æ¯
 */
@GetMapping("/users/{id}")
public UserResponse getUser(@PathVariable Long id, 
                           @RequestParam(required = false) Boolean includeDeleted) {
    // å®é™…æœ‰includeDeletedå‚æ•°ï¼Œä½†æ–‡æ¡£ä¸­æ²¡æœ‰è¯´æ˜
    return userService.findUser(id, includeDeleted);
}

// âŒ é”™è¯¯ï¼šè¿”å›å€¼æ–‡æ¡£ä¸å‡†ç¡®
/**
 * åˆ›å»ºç”¨æˆ·
 * @return åˆ›å»ºæˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯
 */
@PostMapping("/users")
public ResponseEntity<ApiResponse<User>> createUser(@RequestBody CreateUserRequest request) {
    // å®é™…è¿”å›åŒ…è£…çš„ApiResponseï¼Œä½†æ–‡æ¡£è¯´æ˜ä¸å‡†ç¡®
    User user = userService.createUser(request);
    return ResponseEntity.ok(ApiResponse.success(user));
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´å‡†ç¡®çš„APIæ–‡æ¡£
/**
 * è·å–ç”¨æˆ·ä¿¡æ¯
 * @param id ç”¨æˆ·ID
 * @param includeDeleted æ˜¯å¦åŒ…å«å·²åˆ é™¤ç”¨æˆ·ï¼Œé»˜è®¤false
 * @return ç”¨æˆ·ä¿¡æ¯
 */
@ApiOperation(value = "è·å–ç”¨æˆ·ä¿¡æ¯", notes = "æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯")
@ApiResponses({
    @ApiResponse(code = 200, message = "è·å–æˆåŠŸ"),
    @ApiResponse(code = 404, message = "ç”¨æˆ·ä¸å­˜åœ¨")
})
@GetMapping("/users/{id}")
public UserResponse getUser(
    @ApiParam(value = "ç”¨æˆ·ID", required = true) @PathVariable Long id,
    @ApiParam(value = "æ˜¯å¦åŒ…å«å·²åˆ é™¤ç”¨æˆ·", defaultValue = "false") 
    @RequestParam(required = false, defaultValue = "false") Boolean includeDeleted) {
    return userService.findUser(id, includeDeleted);
}
```

#### 4.1.4 é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´:

##### 4.1.4.1 ä¸šåŠ¡é€»è¾‘åˆ†æ”¯è¦†ç›–å®Œæ•´

**1. æ£€æµ‹ç›®æ ‡**

a. æ­£å¸¸æµç¨‹æ˜¯å¦å®Œæ•´å®ç°ã€‚
b. å¼‚å¸¸æƒ…å†µæ˜¯å¦æœ‰å¤„ç†æœºåˆ¶ã€‚
c. è¾¹ç•Œæ¡ä»¶æ˜¯å¦è€ƒè™‘å‘¨å…¨ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä»£ç è¦†ç›–ç‡æµ‹è¯•ã€‚
2. ä¸šåŠ¡åœºæ™¯æµ‹è¯•ç”¨ä¾‹æ£€æŸ¥ã€‚
3. å¼‚å¸¸è·¯å¾„æµ‹è¯•ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘å¼‚å¸¸å¤„ç†åˆ†æ”¯
@Service
public class OrderService {
    public void processOrder(Order order) {
        // âŒ æ²¡æœ‰æ£€æŸ¥è®¢å•çŠ¶æ€
        // âŒ æ²¡æœ‰æ£€æŸ¥åº“å­˜
        // âŒ æ²¡æœ‰å¤„ç†æ”¯ä»˜å¤±è´¥æƒ…å†µ
        
        paymentService.charge(order.getAmount());
        inventoryService.reduceStock(order.getItems());
        order.setStatus(OrderStatus.COMPLETED);
        orderRepository.save(order);
    }
}

// âŒ é”™è¯¯ï¼šè¾¹ç•Œæ¡ä»¶æœªå¤„ç†
public class DiscountCalculator {
    public BigDecimal calculateDiscount(BigDecimal amount, BigDecimal discountRate) {
        // âŒ æ²¡æœ‰æ£€æŸ¥å‚æ•°ä¸ºnull
        // âŒ æ²¡æœ‰æ£€æŸ¥æŠ˜æ‰£ç‡èŒƒå›´
        return amount.multiply(discountRate);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ä¸šåŠ¡é€»è¾‘åˆ†æ”¯
@Service
public class OrderService {
    public void processOrder(Order order) {
        // æ£€æŸ¥è®¢å•çŠ¶æ€
        if (order.getStatus() != OrderStatus.PENDING) {
            throw new IllegalStateException("è®¢å•çŠ¶æ€ä¸å…è®¸å¤„ç†");
        }
        
        // æ£€æŸ¥åº“å­˜
        if (!inventoryService.checkStock(order.getItems())) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        try {
            // å¤„ç†æ”¯ä»˜
            PaymentResult result = paymentService.charge(order.getAmount());
            if (!result.isSuccess()) {
                order.setStatus(OrderStatus.PAYMENT_FAILED);
                orderRepository.save(order);
                return;
            }
            
            // å‡å°‘åº“å­˜
            inventoryService.reduceStock(order.getItems());
            order.setStatus(OrderStatus.COMPLETED);
            
        } catch (PaymentException e) {
            order.setStatus(OrderStatus.PAYMENT_FAILED);
            log.error("è®¢å•æ”¯ä»˜å¤±è´¥: {}", order.getId(), e);
        } catch (Exception e) {
            order.setStatus(OrderStatus.FAILED);
            log.error("è®¢å•å¤„ç†å¤±è´¥: {}", order.getId(), e);
        } finally {
            orderRepository.save(order);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
public class DiscountCalculator {
    public BigDecimal calculateDiscount(BigDecimal amount, BigDecimal discountRate) {
        if (amount == null || discountRate == null) {
            throw new IllegalArgumentException("é‡‘é¢å’ŒæŠ˜æ‰£ç‡ä¸èƒ½ä¸ºç©º");
        }
        
        if (amount.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        if (discountRate.compareTo(BigDecimal.ZERO) < 0 || 
            discountRate.compareTo(BigDecimal.ONE) > 0) {
            throw new IllegalArgumentException("æŠ˜æ‰£ç‡å¿…é¡»åœ¨0-1ä¹‹é—´");
        }
        
        return amount.multiply(discountRate);
    }
}
```

### 4.2 ä»£ç ç»“æ„å’Œç»„ç»‡æ£€æŸ¥

#### 4.2.1 ä»£ç è§„èŒƒæ£€æŸ¥ ğŸŸ¡:

##### 4.2.1.1 æ³¨é‡Šå®Œæ•´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å…³é”®ä¸šåŠ¡é€»è¾‘æ˜¯å¦æœ‰æ¸…æ™°æ³¨é‡Šã€‚
b. è¾¹ç•Œå¤„ç†å’Œå¼‚å¸¸æƒ…å†µæ˜¯å¦æœ‰è¯´æ˜ã€‚
c. å¤æ‚ç®—æ³•å’Œè®¡ç®—é€»è¾‘æ˜¯å¦æœ‰æ³¨é‡Šã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. SonarQubeï¼ˆæ£€æµ‹æ³¨é‡Šè¦†ç›–ç‡ï¼‰ã€‚
2. äººå·¥ä»£ç å®¡æŸ¥ã€‚
3. æ³¨é‡Šè´¨é‡æ£€æŸ¥å·¥å…·ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘å…³é”®é€»è¾‘æ³¨é‡Š
public class OrderProcessor {
    public void processOrder(Order order) {
        if (order.getAmount().compareTo(new BigDecimal("1000")) > 0) {
            // æ²¡æœ‰è¯´æ˜ä¸ºä»€ä¹ˆ1000æ˜¯é˜ˆå€¼
            order.setStatus("REVIEW_REQUIRED");
        }
        
        // å¤æ‚çš„æŠ˜æ‰£è®¡ç®—é€»è¾‘ï¼Œæ²¡æœ‰æ³¨é‡Š
        BigDecimal discount = order.getAmount()
            .multiply(new BigDecimal("0.1"))
            .add(order.getItems().size() > 5 ? new BigDecimal("50") : BigDecimal.ZERO)
            .min(order.getAmount().multiply(new BigDecimal("0.3")));
    }
}

// âŒ é”™è¯¯ï¼šè¾¹ç•Œå¤„ç†æ— æ³¨é‡Š
public String formatPhoneNumber(String phone) {
    if (phone == null || phone.length() < 10) {
        return phone; // æ²¡æœ‰è¯´æ˜ä¸ºä»€ä¹ˆå°äº10ä½ç›´æ¥è¿”å›
    }
    return phone.substring(0, 3) + "-" + phone.substring(3, 6) + "-" + phone.substring(6);
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æ³¨é‡Šè¯´æ˜
public class OrderProcessor {
    /**
     * å¤„ç†è®¢å•
     * ä¸šåŠ¡è§„åˆ™ï¼š
     * 1. è®¢å•é‡‘é¢è¶…è¿‡1000å…ƒéœ€è¦äººå·¥å®¡æ ¸
     * 2. æŠ˜æ‰£è®¡ç®—ï¼šåŸºç¡€10% + è¶…è¿‡5ä»¶å•†å“é¢å¤–50å…ƒ + æœ€é«˜ä¸è¶…è¿‡30%
     */
    public void processOrder(Order order) {
        // å¤§é¢è®¢å•éœ€è¦äººå·¥å®¡æ ¸ï¼Œé˜²æ­¢æ¬ºè¯ˆé£é™©
        if (order.getAmount().compareTo(new BigDecimal("1000")) > 0) {
            order.setStatus("REVIEW_REQUIRED");
        }
        
        // è®¡ç®—è®¢å•æŠ˜æ‰£ï¼šåŸºç¡€10% + å¤šä»¶å•†å“å¥–åŠ± + ä¸Šé™æ§åˆ¶
        BigDecimal baseDiscount = order.getAmount().multiply(new BigDecimal("0.1"));
        BigDecimal bulkBonus = order.getItems().size() > 5 ? new BigDecimal("50") : BigDecimal.ZERO;
        BigDecimal maxDiscount = order.getAmount().multiply(new BigDecimal("0.3"));
        
        BigDecimal finalDiscount = baseDiscount.add(bulkBonus).min(maxDiscount);
    }
}

// âœ… æ­£ç¡®ï¼šè¾¹ç•Œå¤„ç†æœ‰æ¸…æ™°è¯´æ˜
/**
 * æ ¼å¼åŒ–ç”µè¯å·ç ä¸º XXX-XXX-XXXX æ ¼å¼
 * @param phone åŸå§‹ç”µè¯å·ç 
 * @return æ ¼å¼åŒ–åçš„ç”µè¯å·ç ï¼Œå¦‚æœè¾“å…¥æ— æ•ˆåˆ™è¿”å›åŸå€¼
 */
public String formatPhoneNumber(String phone) {
    // è¾“å…¥éªŒè¯ï¼šnullæˆ–é•¿åº¦ä¸è¶³10ä½çš„å·ç è§†ä¸ºæ— æ•ˆï¼Œç›´æ¥è¿”å›
    if (phone == null || phone.length() < 10) {
        return phone;
    }
    
    // æ ‡å‡†ç¾å›½ç”µè¯å·ç æ ¼å¼åŒ–ï¼šå‰3ä½-ä¸­é—´3ä½-å4ä½
    return phone.substring(0, 3) + "-" + phone.substring(3, 6) + "-" + phone.substring(6);
}
```

##### 4.2.1.2 ä»£ç åˆ†å±‚ç»“æ„æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ä»£ç ç»“æ„å±‚æ¬¡æ˜¯å¦æ¸…æ™°ã€‚
b. å•ä¸ªæ–‡ä»¶èŒè´£æ˜¯å¦å•ä¸€ã€‚
c. åŒ…ç»“æ„æ˜¯å¦åˆç†ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ¶æ„æ‰«æå·¥å…·ï¼ˆå¦‚ArchUnitï¼‰ã€‚
2. åŒ…ä¾èµ–å…³ç³»åˆ†æã€‚
3. ç±»èŒè´£åˆ†æã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå•ä¸ªç±»æ‰¿æ‹…å¤šä¸ªèŒè´£
public class UserController {
    // æ§åˆ¶å™¨èŒè´£
    @PostMapping("/users")
    public ResponseEntity<User> createUser(@RequestBody CreateUserRequest request) {
        // âŒ ç›´æ¥åœ¨Controllerä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘
        User user = new User();
        user.setName(request.getName());
        user.setEmail(request.getEmail());
        
        // âŒ ç›´æ¥åœ¨Controllerä¸­å¤„ç†æ•°æ®åº“æ“ä½œ
        Connection conn = DriverManager.getConnection("jdbc:mysql://localhost/db");
        PreparedStatement stmt = conn.prepareStatement("INSERT INTO users...");
        stmt.setString(1, user.getName());
        stmt.executeUpdate();
        
        // âŒ ç›´æ¥åœ¨Controllerä¸­å¤„ç†é‚®ä»¶å‘é€
        EmailSender.send(user.getEmail(), "Welcome!");
        
        return ResponseEntity.ok(user);
    }
}

// âŒ é”™è¯¯ï¼šåŒ…ç»“æ„æ··ä¹±
// com.example.controller.UserService.java
// com.example.service.UserController.java
// com.example.model.UserRepository.java
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ¸…æ™°çš„åˆ†å±‚ç»“æ„

// Controllerå±‚ï¼šåªè´Ÿè´£HTTPè¯·æ±‚å¤„ç†
@RestController
@RequestMapping("/api/users")
public class UserController {
    private final UserService userService;
    
    @PostMapping
    public ResponseEntity<UserResponse> createUser(@RequestBody CreateUserRequest request) {
        User user = userService.createUser(request);
        return ResponseEntity.ok(UserResponse.from(user));
    }
}

// Serviceå±‚ï¼šè´Ÿè´£ä¸šåŠ¡é€»è¾‘
@Service
public class UserService {
    private final UserRepository userRepository;
    private final EmailService emailService;
    
    @Transactional
    public User createUser(CreateUserRequest request) {
        User user = User.builder()
            .name(request.getName())
            .email(request.getEmail())
            .build();
            
        User savedUser = userRepository.save(user);
        emailService.sendWelcomeEmail(savedUser);
        
        return savedUser;
    }
}

// Repositoryå±‚ï¼šè´Ÿè´£æ•°æ®è®¿é—®
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
}

// æ­£ç¡®çš„åŒ…ç»“æ„ï¼š
// com.example.controller.UserController
// com.example.service.UserService
// com.example.repository.UserRepository
// com.example.model.User
// com.example.dto.CreateUserRequest
// com.example.dto.UserResponse
```

##### 4.2.1.3 ç¡¬ç¼–ç æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ˜¯å¦å­˜åœ¨é­”æ³•æ•°å­—å’Œå­—ç¬¦ä¸²ã€‚
b. é…ç½®ä¿¡æ¯æ˜¯å¦å¤–éƒ¨åŒ–ã€‚
c. å¸¸é‡æ˜¯å¦ç»Ÿä¸€ç®¡ç†ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. SonarQubeè§„åˆ™æ£€æµ‹ã€‚
2. é™æ€ä»£ç åˆ†æå·¥å…·ã€‚
3. äººå·¥ä»£ç å®¡æŸ¥ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç é­”æ³•æ•°å­—å’Œå­—ç¬¦ä¸²
public class OrderService {
    public void processOrder(Order order) {
        // âŒ é­”æ³•æ•°å­—
        if (order.getAmount().compareTo(new BigDecimal("1000")) > 0) {
            order.setStatus("PENDING_REVIEW");
        }
        
        // âŒ ç¡¬ç¼–ç URL
        String apiUrl = "https://api.payment.com/v1/charge";
        
        // âŒ ç¡¬ç¼–ç é…ç½®
        int maxRetries = 3;
        int timeoutMs = 5000;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸¸é‡å’Œé…ç½®
public class OrderConstants {
    public static final BigDecimal REVIEW_THRESHOLD = new BigDecimal("1000");
    public static final String STATUS_PENDING_REVIEW = "PENDING_REVIEW";
}

@Component
@ConfigurationProperties(prefix = "payment")
public class PaymentConfig {
    private String apiUrl;
    private int maxRetries = 3;
    private int timeoutMs = 5000;
    
    // getters and setters
}

@Service
public class OrderService {
    private final PaymentConfig paymentConfig;
    
    public void processOrder(Order order) {
        // ä½¿ç”¨å¸¸é‡
        if (order.getAmount().compareTo(OrderConstants.REVIEW_THRESHOLD) > 0) {
            order.setStatus(OrderConstants.STATUS_PENDING_REVIEW);
        }
        
        // ä½¿ç”¨é…ç½®
        String apiUrl = paymentConfig.getApiUrl();
        int maxRetries = paymentConfig.getMaxRetries();
    }
}
```

##### 4.2.1.4 ä»£ç æ ¼å¼åŒ–å·¥å…·æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ˜¯å¦ä½¿ç”¨ç»Ÿä¸€çš„ä»£ç æ ¼å¼åŒ–å·¥å…·ã€‚
b. ä»£ç é£æ ¼æ˜¯å¦ä¸€è‡´ã€‚
c. æ˜¯å¦æœ‰è‡ªåŠ¨åŒ–æ ¼å¼æ£€æŸ¥ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ£€æŸ¥é¡¹ç›®é…ç½®æ–‡ä»¶ï¼ˆ.editorconfigã€checkstyle.xmlç­‰ï¼‰ã€‚
2. CI/CDæµæ°´çº¿ä¸­çš„æ ¼å¼æ£€æŸ¥ã€‚
3. IDEé…ç½®æ£€æŸ¥ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä¸ä¸€è‡´çš„ä»£ç é£æ ¼
public class UserService{
    private UserRepository userRepository;
    
    public User createUser(String name,String email) {
        if(name==null||email==null){
            throw new IllegalArgumentException("å‚æ•°ä¸èƒ½ä¸ºç©º");
        }
        User user=new User();
        user.setName(name);user.setEmail(email);
        return userRepository.save(user);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šç»Ÿä¸€çš„ä»£ç æ ¼å¼
public class UserService {
    private final UserRepository userRepository;
    
    public User createUser(String name, String email) {
        if (name == null || email == null) {
            throw new IllegalArgumentException("å‚æ•°ä¸èƒ½ä¸ºç©º");
        }
        
        User user = new User();
        user.setName(name);
        user.setEmail(email);
        
        return userRepository.save(user);
    }
}

// é¡¹ç›®é…ç½®æ–‡ä»¶ç¤ºä¾‹
// checkstyle.xml
<?xml version="1.0"?>
<!DOCTYPE module PUBLIC "-//Checkstyle//DTD Checkstyle Configuration 1.3//EN"
    "https://checkstyle.org/dtds/configuration_1_3.dtd">
<module name="Checker">
    <module name="TreeWalker">
        <module name="Indentation">
            <property name="basicOffset" value="4"/>
        </module>
        <module name="WhitespaceAround"/>
        <module name="LeftCurly"/>
    </module>
</module>
```

#### 4.2.2 æ¨¡å—åŒ–ä¸ä¾èµ–ç®¡ç†æ£€æŸ¥ ğŸ”´:

##### 4.2.2.1 ä»£ç æ¨¡å—å’Œç±»çš„åˆ’åˆ†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ¨¡å—è¾¹ç•Œæ˜¯å¦æ¸…æ™°ã€‚
b. èŒè´£åˆ’åˆ†æ˜¯å¦åˆç†ã€‚
c. è€¦åˆåº¦æ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´å†…ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ¶æ„åˆ†æå·¥å…·ï¼ˆå¦‚ArchUnitã€JDependï¼‰ã€‚
2. ä¾èµ–å…³ç³»å›¾åˆ†æã€‚
3. åœˆå¤æ‚åº¦æ£€æµ‹ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ¨¡å—èŒè´£ä¸æ¸…ï¼Œé«˜è€¦åˆ
public class UserOrderService {
    // âŒ ä¸€ä¸ªç±»å¤„ç†ç”¨æˆ·å’Œè®¢å•ä¸¤ä¸ªä¸åŒé¢†åŸŸ
    public void createUser(String name, String email) {
        // ç”¨æˆ·åˆ›å»ºé€»è¾‘
    }
    
    public void createOrder(Long userId, List<Item> items) {
        // è®¢å•åˆ›å»ºé€»è¾‘
    }
    
    public void sendUserNotification(Long userId, String message) {
        // é€šçŸ¥é€»è¾‘
    }
    
    public void calculateOrderDiscount(Order order) {
        // æŠ˜æ‰£è®¡ç®—é€»è¾‘
    }
}

// âŒ é”™è¯¯ï¼šç›´æ¥ä¾èµ–å…·ä½“å®ç°
public class OrderService {
    private MySQLOrderRepository orderRepository; // ç›´æ¥ä¾èµ–MySQLå®ç°
    private SMTPEmailSender emailSender; // ç›´æ¥ä¾èµ–SMTPå®ç°
    
    public void processOrder(Order order) {
        orderRepository.save(order);
        emailSender.sendConfirmation(order.getCustomerEmail());
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ¸…æ™°çš„æ¨¡å—åˆ’åˆ†

// ç”¨æˆ·æ¨¡å—
@Service
public class UserService {
    private final UserRepository userRepository;
    
    public User createUser(CreateUserRequest request) {
        // åªè´Ÿè´£ç”¨æˆ·ç›¸å…³é€»è¾‘
    }
}

// è®¢å•æ¨¡å—
@Service
public class OrderService {
    private final OrderRepository orderRepository;
    private final NotificationService notificationService;
    
    public Order createOrder(CreateOrderRequest request) {
        // åªè´Ÿè´£è®¢å•ç›¸å…³é€»è¾‘
    }
}

// é€šçŸ¥æ¨¡å—
@Service
public class NotificationService {
    private final EmailSender emailSender;
    
    public void sendOrderConfirmation(Order order) {
        // åªè´Ÿè´£é€šçŸ¥ç›¸å…³é€»è¾‘
    }
}

// âœ… æ­£ç¡®ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
@Service
public class OrderService {
    private final OrderRepository orderRepository; // ä¾èµ–æ¥å£
    private final EmailSender emailSender; // ä¾èµ–æ¥å£
    
    public void processOrder(Order order) {
        orderRepository.save(order);
        emailSender.sendConfirmation(order.getCustomerEmail());
    }
}

// æ¥å£å®šä¹‰
public interface OrderRepository {
    Order save(Order order);
}

public interface EmailSender {
    void sendConfirmation(String email);
}
```

##### 4.2.2.2 æ¥å£å’ŒæŠ½è±¡ç±»ä½¿ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ¥å£æŠ½è±¡æ˜¯å¦åˆç†ã€‚
b. æŠ½è±¡ç±»ä½¿ç”¨æ˜¯å¦æ°å½“ã€‚
c. æ˜¯å¦éµå¾ªæ¥å£éš”ç¦»åŸåˆ™ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ¥å£è®¾è®¡å®¡æŸ¥ã€‚
2. æŠ½è±¡å±‚æ¬¡åˆ†æã€‚
3. ä¾èµ–å€’ç½®åŸåˆ™æ£€æŸ¥ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ¥å£è¿‡äºåºå¤§ï¼Œè¿åæ¥å£éš”ç¦»åŸåˆ™
public interface UserService {
    // ç”¨æˆ·ç®¡ç†
    User createUser(CreateUserRequest request);
    User updateUser(UpdateUserRequest request);
    void deleteUser(Long userId);
    
    // ç”¨æˆ·è®¤è¯
    boolean authenticate(String username, String password);
    String generateToken(User user);
    
    // ç”¨æˆ·ç»Ÿè®¡
    UserStatistics getUserStatistics(Long userId);
    List<UserReport> generateUserReports();
    
    // ç”¨æˆ·é€šçŸ¥
    void sendWelcomeEmail(User user);
    void sendPasswordResetEmail(String email);
}

// âŒ é”™è¯¯ï¼šä¸å¿…è¦çš„æŠ½è±¡ç±»
public abstract class BaseEntity {
    private Long id;
    private Date createdAt;
    
    // åªæœ‰ç®€å•çš„getter/setterï¼Œä¸éœ€è¦æŠ½è±¡ç±»
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šèŒè´£å•ä¸€çš„æ¥å£
public interface UserManagementService {
    User createUser(CreateUserRequest request);
    User updateUser(UpdateUserRequest request);
    void deleteUser(Long userId);
}

public interface UserAuthenticationService {
    boolean authenticate(String username, String password);
    String generateToken(User user);
}

public interface UserNotificationService {
    void sendWelcomeEmail(User user);
    void sendPasswordResetEmail(String email);
}

// âœ… æ­£ç¡®ï¼šæœ‰æ„ä¹‰çš„æŠ½è±¡ç±»
public abstract class PaymentProcessor {
    // æ¨¡æ¿æ–¹æ³•æ¨¡å¼
    public final PaymentResult processPayment(PaymentRequest request) {
        validateRequest(request);
        PaymentResult result = doProcessPayment(request);
        logPaymentResult(result);
        return result;
    }
    
    protected void validateRequest(PaymentRequest request) {
        // é€šç”¨éªŒè¯é€»è¾‘
    }
    
    protected abstract PaymentResult doProcessPayment(PaymentRequest request);
    
    protected void logPaymentResult(PaymentResult result) {
        // é€šç”¨æ—¥å¿—é€»è¾‘
    }
}
```

##### 4.2.2.3 ç¬¬ä¸‰æ–¹ç»„ä»¶ç®¡ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¬¬ä¸‰æ–¹ä¾èµ–æ˜¯å¦ç»è¿‡å®‰å…¨å®¡æ ¸ã€‚
b. ç‰ˆæœ¬å†²çªæ˜¯å¦è§£å†³ã€‚
c. è®¸å¯è¯æ˜¯å¦åˆè§„ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä¾èµ–æ‰«æå·¥å…·ï¼ˆå¦‚OWASP Dependency Checkï¼‰ã€‚
2. è®¸å¯è¯åˆè§„æ£€æŸ¥ã€‚
3. ç‰ˆæœ¬å†²çªåˆ†æã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```xml
<!-- âŒ é”™è¯¯ï¼šä½¿ç”¨æœ‰å®‰å…¨æ¼æ´çš„ç‰ˆæœ¬ -->
<dependency>
    <groupId>org.apache.struts</groupId>
    <artifactId>struts2-core</artifactId>
    <version>2.3.16</version> <!-- å·²çŸ¥å®‰å…¨æ¼æ´ -->
</dependency>

<!-- âŒ é”™è¯¯ï¼šç‰ˆæœ¬å†²çª -->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-core</artifactId>
    <version>2.9.8</version>
</dependency>
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
    <version>2.10.1</version> <!-- ç‰ˆæœ¬ä¸ä¸€è‡´ -->
</dependency>

<!-- âŒ é”™è¯¯ï¼šå¼•å…¥ä¸å¿…è¦çš„å¤§å‹ä¾èµ– -->
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-context</artifactId>
    <version>5.3.21</version>
</dependency>
<!-- åªæ˜¯ä¸ºäº†ä½¿ç”¨ä¸€ä¸ªå·¥å…·ç±»å°±å¼•å…¥æ•´ä¸ªSpringæ¡†æ¶ -->
```

**4. æ­£ç¡®ç¤ºä¾‹**

```xml
<!-- âœ… æ­£ç¡®ï¼šä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬ -->
<dependency>
    <groupId>org.apache.struts</groupId>
    <artifactId>struts2-core</artifactId>
    <version>2.5.30</version> <!-- æœ€æ–°ç¨³å®šç‰ˆæœ¬ -->
</dependency>

<!-- âœ… æ­£ç¡®ï¼šç»Ÿä¸€ç‰ˆæœ¬ç®¡ç† -->
<properties>
    <jackson.version>2.13.3</jackson.version>
</properties>

<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-core</artifactId>
    <version>${jackson.version}</version>
</dependency>
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
    <version>${jackson.version}</version>
</dependency>

<!-- âœ… æ­£ç¡®ï¼šæœ€å°åŒ–ä¾èµ– -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-lang3</artifactId>
    <version>3.12.0</version>
</dependency>
<!-- ä½¿ç”¨è½»é‡çº§å·¥å…·åº“è€Œä¸æ˜¯é‡å‹æ¡†æ¶ -->
```

#### 4.2.3 æ¶æ„è®¾è®¡æ£€æŸ¥ ğŸŸ¡:

##### 4.2.3.1 è®¾è®¡æ¨¡å¼æ°å½“æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. è®¾è®¡æ¨¡å¼ä½¿ç”¨æ˜¯å¦æ°å½“ã€‚
b. æ˜¯å¦å­˜åœ¨è¿‡åº¦è®¾è®¡ã€‚
c. æ˜¯å¦éµå¾ªSOLIDåŸåˆ™ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ¶æ„è¯„å®¡ã€‚
2. è®¾è®¡æ¨¡å¼ä½¿ç”¨åˆ†æã€‚
3. ä»£ç å¤æ‚åº¦è¯„ä¼°ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šè¿‡åº¦è®¾è®¡ï¼Œç®€å•åŠŸèƒ½ä½¿ç”¨å¤æ‚æ¨¡å¼
public class SimpleCalculatorFactory {
    public static Calculator createCalculator(String type) {
        switch (type) {
            case "basic":
                return new BasicCalculator();
            default:
                throw new IllegalArgumentException("Unknown calculator type");
        }
    }
}

public interface Calculator {
    double add(double a, double b);
    double subtract(double a, double b);
}

public class BasicCalculator implements Calculator {
    public double add(double a, double b) {
        return a + b;
    }
    
    public double subtract(double a, double b) {
        return a - b;
    }
}

// ä½¿ç”¨æ–¹å¼è¿‡äºå¤æ‚
Calculator calc = SimpleCalculatorFactory.createCalculator("basic");
double result = calc.add(1, 2);

// âŒ é”™è¯¯ï¼šä¸å¿…è¦çš„å•ä¾‹æ¨¡å¼
public class ConfigurationManager {
    private static ConfigurationManager instance;
    private Properties properties;
    
    private ConfigurationManager() {
        properties = new Properties();
    }
    
    public static synchronized ConfigurationManager getInstance() {
        if (instance == null) {
            instance = new ConfigurationManager();
        }
        return instance;
    }
    
    public String getProperty(String key) {
        return properties.getProperty(key);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šç®€å•åŠŸèƒ½ç”¨ç®€å•å®ç°
public class Calculator {
    public double add(double a, double b) {
        return a + b;
    }
    
    public double subtract(double a, double b) {
        return a - b;
    }
}

// ç›´æ¥ä½¿ç”¨ï¼Œç®€å•æ˜äº†
Calculator calc = new Calculator();
double result = calc.add(1, 2);

// âœ… æ­£ç¡®ï¼šåˆç†ä½¿ç”¨è®¾è®¡æ¨¡å¼
// ç­–ç•¥æ¨¡å¼ç”¨äºå¤æ‚çš„æŠ˜æ‰£è®¡ç®—
public interface DiscountStrategy {
    BigDecimal calculateDiscount(Order order);
}

@Component
public class VIPDiscountStrategy implements DiscountStrategy {
    public BigDecimal calculateDiscount(Order order) {
        return order.getAmount().multiply(new BigDecimal("0.2"));
    }
}

@Component
public class BulkDiscountStrategy implements DiscountStrategy {
    public BigDecimal calculateDiscount(Order order) {
        if (order.getItems().size() > 10) {
            return order.getAmount().multiply(new BigDecimal("0.1"));
        }
        return BigDecimal.ZERO;
    }
}

@Service
public class OrderService {
    private final Map<String, DiscountStrategy> discountStrategies;
    
    public BigDecimal calculateDiscount(Order order, String customerType) {
        DiscountStrategy strategy = discountStrategies.get(customerType);
        return strategy != null ? strategy.calculateDiscount(order) : BigDecimal.ZERO;
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨Springç®¡ç†é…ç½®ï¼Œè€Œä¸æ˜¯å•ä¾‹
@Component
@ConfigurationProperties(prefix = "app")
public class AppConfiguration {
    private String name;
    private String version;
    
    // getters and setters
}
```

#### 4.2.4 é»˜è®¤é…ç½®å®‰å…¨æ£€æŸ¥ ğŸ”´:

##### 4.2.4.1 é»˜è®¤è´¦æˆ·å’Œå¯†ç å®‰å…¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é»˜è®¤è´¦æˆ·æ˜¯å¦å·²ç¦ç”¨æˆ–æ›´æ”¹ã€‚
b. é»˜è®¤å¯†ç æ˜¯å¦å·²ä¿®æ”¹ã€‚
c. æ˜¯å¦å­˜åœ¨å¼±å¯†ç ç­–ç•¥ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é…ç½®æ–‡ä»¶æ‰«æã€‚
2. å®‰å…¨é…ç½®å®¡æŸ¥ã€‚
3. å¯†ç ç­–ç•¥æ£€æŸ¥ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```properties
# âŒ é”™è¯¯ï¼šä½¿ç”¨é»˜è®¤è´¦æˆ·å’Œå¯†ç 
spring.datasource.username=root
spring.datasource.password=password

# âŒ é”™è¯¯ï¼šç®¡ç†å‘˜è´¦æˆ·ä½¿ç”¨å¼±å¯†ç 
admin.username=admin
admin.password=123456

# âŒ é”™è¯¯ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­æ˜æ–‡å­˜å‚¨å¯†ç 
redis.password=myredispassword
```

```java
// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç é»˜è®¤å‡­æ®
@Configuration
public class DatabaseConfig {
    @Bean
    public DataSource dataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setUsername("sa"); // é»˜è®¤ç”¨æˆ·å
        dataSource.setPassword(""); // ç©ºå¯†ç 
        return dataSource;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```properties
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–åŠ å¯†é…ç½®
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}

# âœ… æ­£ç¡®ï¼šä½¿ç”¨é…ç½®åŠ å¯†
spring.datasource.password=ENC(encrypted_password_here)

# âœ… æ­£ç¡®ï¼šå¼ºå¯†ç ç­–ç•¥é…ç½®
password.policy.min-length=12
password.policy.require-uppercase=true
password.policy.require-lowercase=true
password.policy.require-numbers=true
password.policy.require-special-chars=true
```

```java
// âœ… æ­£ç¡®ï¼šä»å®‰å…¨é…ç½®ä¸­è·å–å‡­æ®
@Configuration
public class DatabaseConfig {
    @Value("${spring.datasource.username}")
    private String username;
    
    @Value("${spring.datasource.password}")
    private String password;
    
    @Bean
    public DataSource dataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setUsername(username);
        dataSource.setPassword(password);
        return dataSource;
    }
}

// âœ… æ­£ç¡®ï¼šå¯†ç ç­–ç•¥éªŒè¯
@Component
public class PasswordValidator {
    private static final String PASSWORD_PATTERN = 
        "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{12,}$";
    
    public boolean isValidPassword(String password) {
        return password != null && password.matches(PASSWORD_PATTERN);
    }
}
```

##### 4.2.4.2 å®‰å…¨åŠŸèƒ½é»˜è®¤å¯ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. HTTPSæ˜¯å¦é»˜è®¤å¯ç”¨ã€‚
b. CSRFä¿æŠ¤æ˜¯å¦å¼€å¯ã€‚
c. å®‰å…¨å¤´æ˜¯å¦é…ç½®ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. å®‰å…¨é…ç½®æ£€æŸ¥ã€‚
2. HTTPå“åº”å¤´åˆ†æã€‚
3. SSL/TLSé…ç½®éªŒè¯ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç¦ç”¨å®‰å…¨åŠŸèƒ½
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf().disable() // âŒ ç¦ç”¨CSRFä¿æŠ¤
            .headers().frameOptions().disable() // âŒ ç¦ç”¨X-Frame-Options
            .and()
            .authorizeRequests()
            .anyRequest().permitAll(); // âŒ å…è®¸æ‰€æœ‰è¯·æ±‚
        return http.build();
    }
}

// âŒ é”™è¯¯ï¼šHTTPé…ç½®
server.port=8080
# æ²¡æœ‰HTTPSé…ç½®
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå¯ç”¨å®‰å…¨åŠŸèƒ½
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            .and()
            .headers(headers -> headers
                .frameOptions().deny()
                .contentTypeOptions().and()
                .httpStrictTransportSecurity(hstsConfig -> hstsConfig
                    .maxAgeInSeconds(31536000)
                    .includeSubdomains(true)
                )
            )
            .sessionManagement()
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeRequests()
            .antMatchers("/public/**").permitAll()
            .anyRequest().authenticated();
        return http.build();
    }
}

// âœ… æ­£ç¡®ï¼šHTTPSé…ç½®
server.port=8443
server.ssl.enabled=true
server.ssl.key-store=${SSL_KEYSTORE_PATH}
server.ssl.key-store-password=${SSL_KEYSTORE_PASSWORD}
server.ssl.key-store-type=PKCS12

# HTTPé‡å®šå‘åˆ°HTTPS
server.http.port=8080
security.require-ssl=true
```

##### 4.2.4.3 æ•æ„Ÿä¿¡æ¯é…ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é…ç½®æ–‡ä»¶æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚
b. å¯†é’¥æ˜¯å¦å®‰å…¨å­˜å‚¨ã€‚
c. æ˜¯å¦æœ‰ä¿¡æ¯æ³„éœ²é£é™©ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é…ç½®æ–‡ä»¶æ‰«æã€‚
2. æ•æ„Ÿä¿¡æ¯æ£€æµ‹å·¥å…·ã€‚
3. ä»£ç å®¡æŸ¥ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```properties
# âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯
spring.datasource.password=MySecretPassword123
aws.access-key=AKIAIOSFODNN7EXAMPLE
aws.secret-key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
jwt.secret=myJwtSecretKey
api.key=sk-1234567890abcdef

# âŒ é”™è¯¯ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®
spring.profiles.active=prod
logging.level.org.springframework.security=DEBUG
management.endpoints.web.exposure.include=*
```

```java
// âŒ é”™è¯¯ï¼šä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
@Service
public class PaymentService {
    private static final String API_KEY = "sk-live_1234567890abcdef"; // âŒ ç¡¬ç¼–ç APIå¯†é’¥
    private static final String SECRET = "mySecretKey123"; // âŒ ç¡¬ç¼–ç å¯†é’¥
    
    public void processPayment(PaymentRequest request) {
        // ä½¿ç”¨ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```properties
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
spring.datasource.password=${DB_PASSWORD}
aws.access-key=${AWS_ACCESS_KEY}
aws.secret-key=${AWS_SECRET_KEY}
jwt.secret=${JWT_SECRET}
api.key=${PAYMENT_API_KEY}

# âœ… æ­£ç¡®ï¼šç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
spring.profiles.active=${SPRING_PROFILES_ACTIVE:prod}
logging.level.org.springframework.security=WARN
management.endpoints.web.exposure.include=health,info
management.endpoint.health.show-details=when-authorized
```

```java
// âœ… æ­£ç¡®ï¼šä»é…ç½®ä¸­è·å–æ•æ„Ÿä¿¡æ¯
@Service
public class PaymentService {
    @Value("${payment.api.key}")
    private String apiKey;
    
    @Value("${payment.secret}")
    private String secret;
    
    public void processPayment(PaymentRequest request) {
        // ä½¿ç”¨ä»é…ç½®ä¸­è·å–çš„æ•æ„Ÿä¿¡æ¯
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨é…ç½®ç±»ç®¡ç†æ•æ„Ÿä¿¡æ¯
@Component
@ConfigurationProperties(prefix = "payment")
public class PaymentConfig {
    private String apiKey;
    private String secret;
    private String webhookSecret;
    
    // getters and setters
    // æ³¨æ„ï¼štoString()æ–¹æ³•åº”è¯¥æ’é™¤æ•æ„Ÿå­—æ®µ
    @Override
    public String toString() {
        return "PaymentConfig{apiKey='***', secret='***', webhookSecret='***'}";
    }
}
```

### 4.3 çº¿ç¨‹å®‰å…¨ä¸å¹¶å‘å¤„ç†æ£€æŸ¥

#### 4.3.1 çº¿ç¨‹æ± é…ç½®æ£€æŸ¥ ğŸ”´:

##### 4.3.1.1 çº¿ç¨‹æ± å‚æ•°é…ç½®æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. çº¿ç¨‹æ± é…ç½®æ˜¯å¦ç¬¦åˆæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ã€‚
b. æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯å¦åˆç†è®¾ç½®ã€‚
c. é˜Ÿåˆ—å¤§å°æ˜¯å¦æœ‰åˆç†ä¸Šé™ã€‚
d. æ‹’ç»ç­–ç•¥æ˜¯å¦é€‚å½“é…ç½®ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æï¼ˆä½¿ç”¨SonarQubeè§„åˆ™java:S2142ï¼‰ã€‚
2. ä»£ç å®¡æŸ¥ï¼ˆæ£€æŸ¥æ‰€æœ‰ThreadPoolExecutoråˆ›å»ºä»£ç ï¼‰ã€‚
3. è¿è¡Œæ—¶ç›‘æ§ï¼ˆJVMçº¿ç¨‹ç›‘æ§ã€çº¿ç¨‹æ± çŠ¶æ€ç›‘æ§ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨å·¥å‚æ–¹æ³•ï¼Œæ— æ³•æ§åˆ¶å‚æ•°
public class TaskProcessor {
    // ä½¿ç”¨Executorså·¥å‚æ–¹æ³•ï¼Œæ— æ³•ç²¾ç¡®æ§åˆ¶çº¿ç¨‹æ± å‚æ•°
    private ExecutorService executor = Executors.newFixedThreadPool(10);
    
    public void processTask(Runnable task) {
        executor.submit(task);
    }
}

// âŒ é”™è¯¯ï¼šæ— ç•Œé˜Ÿåˆ—å¯èƒ½å¯¼è‡´OOM
public class DataProcessor {
    private ThreadPoolExecutor executor = new ThreadPoolExecutor(
        5, 10, 60L, TimeUnit.SECONDS,
        new LinkedBlockingQueue<>() // æ— ç•Œé˜Ÿåˆ—ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
    );
    
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰è®¾ç½®çº¿ç¨‹åç§°å’Œæ‹’ç»ç­–ç•¥
    public void processData(List<Data> dataList) {
        for (Data data : dataList) {
            executor.submit(() -> handleData(data));
        }
    }
}

// âŒ é”™è¯¯ï¼šçº¿ç¨‹æ•°é…ç½®ä¸åˆç†
public class ReportGenerator {
    // CPUå¯†é›†å‹ä»»åŠ¡ä½¿ç”¨è¿‡å¤šçº¿ç¨‹
    private ThreadPoolExecutor cpuIntensiveExecutor = new ThreadPoolExecutor(
        50, 100, 60L, TimeUnit.SECONDS, // çº¿ç¨‹æ•°è¿‡å¤š
        new ArrayBlockingQueue<>(10)
    );
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ˜ç¡®é…ç½®æ‰€æœ‰å‚æ•°
public class TaskProcessor {
    private final ThreadPoolExecutor executor;
    
    public TaskProcessor() {
        int corePoolSize = Runtime.getRuntime().availableProcessors();
        int maximumPoolSize = corePoolSize * 2;
        
        this.executor = new ThreadPoolExecutor(
            corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•°
            maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•°
            60L, TimeUnit.SECONDS, // ç©ºé—²æ—¶é—´
            new ArrayBlockingQueue<>(500), // æœ‰ç•Œé˜Ÿåˆ—
            new ThreadFactoryBuilder()
                .setNameFormat("task-processor-%d")
                .setDaemon(true)
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
        );
    }
    
    public Future<?> processTask(Runnable task) {
        return executor.submit(task);
    }
    
    @PreDestroy
    public void shutdown() {
        executor.shutdown();
        try {
            if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                executor.shutdownNow();
            }
        } catch (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}

// âœ… æ­£ç¡®ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹é…ç½®ä¸åŒçš„çº¿ç¨‹æ± 
@Configuration
public class ThreadPoolConfig {
    
    @Bean("cpuIntensiveExecutor")
    public ThreadPoolExecutor cpuIntensiveExecutor() {
        int processors = Runtime.getRuntime().availableProcessors();
        return new ThreadPoolExecutor(
            processors + 1, // CPUå¯†é›†å‹ï¼šCPUæ ¸æ•°+1
            processors + 1,
            60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder()
                .setNameFormat("cpu-intensive-%d")
                .build(),
            new ThreadPoolExecutor.AbortPolicy()
        );
    }
    
    @Bean("ioIntensiveExecutor")
    public ThreadPoolExecutor ioIntensiveExecutor() {
        int processors = Runtime.getRuntime().availableProcessors();
        return new ThreadPoolExecutor(
            processors * 2, // IOå¯†é›†å‹ï¼šCPUæ ¸æ•°*2
            processors * 4,
            60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(200),
            new ThreadFactoryBuilder()
                .setNameFormat("io-intensive-%d")
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }
}
```

##### 4.3.1.2 çº¿ç¨‹æ± ç›‘æ§å’Œç®¡ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. çº¿ç¨‹æ± æ˜¯å¦æœ‰é€‚å½“çš„ç›‘æ§æœºåˆ¶ã€‚
b. çº¿ç¨‹æ± å…³é—­æ˜¯å¦ä¼˜é›…å¤„ç†ã€‚
c. çº¿ç¨‹æ± å¼‚å¸¸æ˜¯å¦æœ‰åˆç†çš„å¤„ç†æœºåˆ¶ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ç›‘æ§ä»£ç å®¡æŸ¥ã€‚
2. å¼‚å¸¸å¤„ç†æœºåˆ¶æ£€æŸ¥ã€‚
3. èµ„æºæ¸…ç†éªŒè¯ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç›‘æ§å’Œå¼‚å¸¸å¤„ç†
@Service
public class EmailService {
    private ThreadPoolExecutor emailExecutor = new ThreadPoolExecutor(
        5, 10, 60L, TimeUnit.SECONDS,
        new ArrayBlockingQueue<>(100)
    );
    
    public void sendEmail(String to, String subject, String content) {
        // æ²¡æœ‰å¼‚å¸¸å¤„ç†ï¼Œä»»åŠ¡å¤±è´¥æ—¶æ— æ³•æ„ŸçŸ¥
        emailExecutor.submit(() -> {
            // å‘é€é‚®ä»¶é€»è¾‘
            smtpClient.send(to, subject, content);
        });
    }
    
    // æ²¡æœ‰ä¼˜é›…å…³é—­æœºåˆ¶
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ç›‘æ§å’Œå¼‚å¸¸å¤„ç†
@Service
public class EmailService {
    private static final Logger logger = LoggerFactory.getLogger(EmailService.class);
    private final ThreadPoolExecutor emailExecutor;
    private final MeterRegistry meterRegistry;
    
    public EmailService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.emailExecutor = new ThreadPoolExecutor(
            5, 10, 60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder()
                .setNameFormat("email-sender-%d")
                .setUncaughtExceptionHandler((t, e) -> {
                    logger.error("é‚®ä»¶å‘é€çº¿ç¨‹å¼‚å¸¸", e);
                    meterRegistry.counter("email.thread.error").increment();
                })
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
        
        // æ³¨å†Œç›‘æ§æŒ‡æ ‡
        Gauge.builder("email.thread.pool.active")
            .register(meterRegistry, emailExecutor, ThreadPoolExecutor::getActiveCount);
        Gauge.builder("email.thread.pool.queue.size")
            .register(meterRegistry, emailExecutor, e -> e.getQueue().size());
    }
    
    public CompletableFuture<Void> sendEmail(String to, String subject, String content) {
        return CompletableFuture.runAsync(() -> {
            try {
                smtpClient.send(to, subject, content);
                meterRegistry.counter("email.sent.success").increment();
                logger.info("é‚®ä»¶å‘é€æˆåŠŸ: {}", to);
            } catch (Exception e) {
                meterRegistry.counter("email.sent.failure").increment();
                logger.error("é‚®ä»¶å‘é€å¤±è´¥: {}", to, e);
                throw new RuntimeException("é‚®ä»¶å‘é€å¤±è´¥", e);
            }
        }, emailExecutor);
    }
    
    @PreDestroy
    public void shutdown() {
        logger.info("å¼€å§‹å…³é—­é‚®ä»¶å‘é€çº¿ç¨‹æ± ");
        emailExecutor.shutdown();
        try {
            if (!emailExecutor.awaitTermination(30, TimeUnit.SECONDS)) {
                logger.warn("é‚®ä»¶å‘é€çº¿ç¨‹æ± æœªèƒ½åœ¨30ç§’å†…å…³é—­ï¼Œå¼ºåˆ¶å…³é—­");
                emailExecutor.shutdownNow();
                if (!emailExecutor.awaitTermination(10, TimeUnit.SECONDS)) {
                    logger.error("é‚®ä»¶å‘é€çº¿ç¨‹æ± å¼ºåˆ¶å…³é—­å¤±è´¥");
                }
            }
        } catch (InterruptedException e) {
            logger.error("ç­‰å¾…çº¿ç¨‹æ± å…³é—­æ—¶è¢«ä¸­æ–­", e);
            emailExecutor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
```

#### 4.3.2 Springå¹¶å‘é—®é¢˜æ£€æŸ¥ ğŸ”´:

##### 4.3.2.1 å•ä¾‹Beançº¿ç¨‹å®‰å…¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å•ä¾‹Beanä¸­æ˜¯å¦å­˜åœ¨éçº¿ç¨‹å®‰å…¨çš„å®ä¾‹å˜é‡ã€‚
b. å…±äº«çŠ¶æ€æ˜¯å¦æœ‰é€‚å½“çš„åŒæ­¥ä¿æŠ¤ã€‚
c. æ— çŠ¶æ€è®¾è®¡æ˜¯å¦å¾—åˆ°æ­£ç¡®å®ç°ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€åˆ†æï¼ˆæ£€æŸ¥@Componentã€@Serviceç­‰æ³¨è§£çš„ç±»ä¸­çš„å®ä¾‹å˜é‡ï¼‰ã€‚
2. ä»£ç å®¡æŸ¥ï¼ˆé‡ç‚¹æ£€æŸ¥å…±äº«çŠ¶æ€çš„è®¿é—®ï¼‰ã€‚
3. å¹¶å‘æµ‹è¯•ï¼ˆéªŒè¯çº¿ç¨‹å®‰å…¨æ€§ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå•ä¾‹Beanä¸­çš„éçº¿ç¨‹å®‰å…¨å˜é‡
@Service
public class UserService {
    private int requestCount = 0; // çº¿ç¨‹ä¸å®‰å…¨çš„å®ä¾‹å˜é‡
    private User currentUser; // å…±äº«çŠ¶æ€ï¼Œçº¿ç¨‹ä¸å®‰å…¨
    private final List<String> processingUsers = new ArrayList<>(); // éçº¿ç¨‹å®‰å…¨é›†åˆ
    
    public void processUser(User user) {
        requestCount++; // å¹¶å‘é—®é¢˜ï¼šå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹
        currentUser = user; // å¹¶å‘é—®é¢˜ï¼šçŠ¶æ€è¢«å…¶ä»–çº¿ç¨‹è¦†ç›–
        processingUsers.add(user.getName()); // å¹¶å‘é—®é¢˜ï¼šArrayListéçº¿ç¨‹å®‰å…¨
        
        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        doProcessUser(user);
        
        processingUsers.remove(user.getName());
    }
    
    public int getRequestCount() {
        return requestCount; // å¯èƒ½è¯»å–åˆ°ä¸ä¸€è‡´çš„å€¼
    }
}

// âŒ é”™è¯¯ï¼šç¼“å­˜å®ç°çº¿ç¨‹ä¸å®‰å…¨
@Component
public class CacheService {
    private final Map<String, Object> cache = new HashMap<>(); // éçº¿ç¨‹å®‰å…¨
    
    public Object get(String key) {
        return cache.get(key); // å¹¶å‘è¯»å†™å¯èƒ½å¯¼è‡´æ­»å¾ªç¯
    }
    
    public void put(String key, Object value) {
        cache.put(key, value); // å¹¶å‘ä¿®æ”¹å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ–¹å¼
@Service
public class UserService {
    private final AtomicInteger requestCount = new AtomicInteger(0);
    private final Set<String> processingUsers = ConcurrentHashMap.newKeySet();
    
    // ä½¿ç”¨ThreadLocalå­˜å‚¨çº¿ç¨‹ç‰¹å®šçš„çŠ¶æ€
    private final ThreadLocal<User> currentUserThreadLocal = new ThreadLocal<>();
    
    public void processUser(User user) {
        requestCount.incrementAndGet(); // çº¿ç¨‹å®‰å…¨çš„è®¡æ•°
        currentUserThreadLocal.set(user); // çº¿ç¨‹æœ¬åœ°å­˜å‚¨
        processingUsers.add(user.getName()); // çº¿ç¨‹å®‰å…¨çš„é›†åˆ
        
        try {
            // ä¸šåŠ¡é€»è¾‘å¤„ç†
            doProcessUser(user);
        } finally {
            processingUsers.remove(user.getName());
            currentUserThreadLocal.remove(); // æ¸…ç†ThreadLocal
        }
    }
    
    public int getRequestCount() {
        return requestCount.get(); // çº¿ç¨‹å®‰å…¨çš„è¯»å–
    }
    
    public User getCurrentUser() {
        return currentUserThreadLocal.get();
    }
}

// âœ… æ­£ç¡®ï¼šæ— çŠ¶æ€è®¾è®¡
@Service
public class OrderCalculationService {
    private final TaxService taxService;
    private final DiscountService discountService;
    
    // æ— çŠ¶æ€æœåŠ¡ï¼Œæ‰€æœ‰æ•°æ®é€šè¿‡å‚æ•°ä¼ é€’
    public OrderTotal calculateTotal(Order order, Customer customer) {
        BigDecimal subtotal = calculateSubtotal(order.getItems());
        BigDecimal tax = taxService.calculateTax(subtotal, customer.getAddress());
        BigDecimal discount = discountService.calculateDiscount(order, customer);
        
        return OrderTotal.builder()
            .subtotal(subtotal)
            .tax(tax)
            .discount(discount)
            .total(subtotal.add(tax).subtract(discount))
            .build();
    }
    
    private BigDecimal calculateSubtotal(List<OrderItem> items) {
        return items.stream()
            .map(item -> item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity())))
            .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}

// âœ… æ­£ç¡®ï¼šçº¿ç¨‹å®‰å…¨çš„ç¼“å­˜å®ç°
@Component
public class CacheService {
    private final ConcurrentHashMap<String, Object> cache = new ConcurrentHashMap<>();
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    
    public Object get(String key) {
        return cache.get(key); // ConcurrentHashMapçº¿ç¨‹å®‰å…¨
    }
    
    public void put(String key, Object value) {
        cache.put(key, value);
    }
    
    // å¯¹äºå¤æ‚æ“ä½œï¼Œä½¿ç”¨é”ä¿æŠ¤
    public Object computeIfAbsent(String key, Function<String, Object> mappingFunction) {
        return cache.computeIfAbsent(key, mappingFunction);
    }
    
    public void evictExpired() {
        lock.writeLock().lock();
        try {
            // æ‰¹é‡æ¸…ç†è¿‡æœŸç¼“å­˜
            cache.entrySet().removeIf(entry -> isExpired(entry));
        } finally {
            lock.writeLock().unlock();
        }
    }
}
```

##### 4.3.2.2 å¼‚æ­¥æ–¹æ³•ä½¿ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. @Asyncæ–¹æ³•æ˜¯å¦æ­£ç¡®è¿”å›Futureæˆ–CompletableFutureã€‚
b. å¼‚æ­¥æ–¹æ³•è°ƒç”¨æ˜¯å¦é¿å…äº†è‡ªè°ƒç”¨é—®é¢˜ã€‚
c. å¼‚æ­¥æ–¹æ³•ä¸äº‹åŠ¡çš„é…åˆæ˜¯å¦æ­£ç¡®ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä»£ç å®¡æŸ¥ï¼ˆé‡ç‚¹æ£€æŸ¥@Asyncæ³¨è§£çš„ä½¿ç”¨ï¼‰ã€‚
2. å¼‚æ­¥æ‰§è¡ŒéªŒè¯æµ‹è¯•ã€‚
3. äº‹åŠ¡è¾¹ç•Œæ£€æŸ¥ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šåŒç±»è°ƒç”¨å¼‚æ­¥æ–¹æ³•
@Service
public class OrderService {
    
    @Async
    public void processOrderAsync(Order order) {
        // å¼‚æ­¥å¤„ç†è®¢å•
        processOrder(order);
    }
    
    public void handleOrder(Order order) {
        // åŒç±»è°ƒç”¨ï¼Œä¸ä¼šå¼‚æ­¥æ‰§è¡Œ
        this.processOrderAsync(order); // è¿™é‡Œä¸ä¼šå¼‚æ­¥æ‰§è¡Œ
    }
    
    // âŒ é”™è¯¯ï¼šå¼‚æ­¥æ–¹æ³•æ²¡æœ‰è¿”å›Future
    @Async
    public void sendNotification(String message) {
        // æ— æ³•è·å–æ‰§è¡Œç»“æœæˆ–å¼‚å¸¸
        emailService.send(message);
    }
    
    // âŒ é”™è¯¯ï¼šäº‹åŠ¡æ–¹æ³•æ ‡è®°ä¸ºå¼‚æ­¥
    @Async
    @Transactional
    public void updateOrderStatus(Long orderId, OrderStatus status) {
        // å¼‚æ­¥æ‰§è¡Œä¼šå¯¼è‡´äº‹åŠ¡åœ¨ä¸åŒçº¿ç¨‹ä¸­ï¼Œå¯èƒ½å¤±æ•ˆ
        Order order = orderRepository.findById(orderId);
        order.setStatus(status);
        orderRepository.save(order);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šé€šè¿‡æ³¨å…¥è°ƒç”¨å¼‚æ­¥æ–¹æ³•
@Service
public class OrderService {
    private final OrderAsyncService orderAsyncService;
    private final NotificationAsyncService notificationAsyncService;
    
    public void handleOrder(Order order) {
        // é€šè¿‡æ³¨å…¥çš„æœåŠ¡è°ƒç”¨å¼‚æ­¥æ–¹æ³•
        CompletableFuture<Void> processFuture = orderAsyncService.processOrderAsync(order);
        CompletableFuture<Void> notifyFuture = notificationAsyncService.sendNotificationAsync(
            "è®¢å•å¤„ç†ä¸­: " + order.getId());
        
        // å¯ä»¥ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆæˆ–å¤„ç†å¼‚å¸¸
        CompletableFuture.allOf(processFuture, notifyFuture)
            .exceptionally(throwable -> {
                log.error("å¼‚æ­¥å¤„ç†è®¢å•å¤±è´¥", throwable);
                return null;
            });
    }
}

@Service
public class OrderAsyncService {
    
    @Async("orderProcessExecutor")
    public CompletableFuture<Void> processOrderAsync(Order order) {
        try {
            // å¼‚æ­¥å¤„ç†è®¢å•é€»è¾‘
            processOrder(order);
            return CompletableFuture.completedFuture(null);
        } catch (Exception e) {
            log.error("å¤„ç†è®¢å•å¼‚å¸¸: {}", order.getId(), e);
            return CompletableFuture.failedFuture(e);
        }
    }
    
    @Async("orderProcessExecutor")
    public CompletableFuture<OrderResult> calculateOrderTotalAsync(Order order) {
        return CompletableFuture.supplyAsync(() -> {
            // å¤æ‚çš„è®¡ç®—é€»è¾‘
            return calculateTotal(order);
        });
    }
}

@Service
public class NotificationAsyncService {
    
    @Async("notificationExecutor")
    public CompletableFuture<Void> sendNotificationAsync(String message) {
        return CompletableFuture.runAsync(() -> {
            try {
                emailService.send(message);
                log.info("é€šçŸ¥å‘é€æˆåŠŸ: {}", message);
            } catch (Exception e) {
                log.error("é€šçŸ¥å‘é€å¤±è´¥: {}", message, e);
                throw new RuntimeException("é€šçŸ¥å‘é€å¤±è´¥", e);
            }
        });
    }
}

// âœ… æ­£ç¡®ï¼šåˆ†ç¦»äº‹åŠ¡å’Œå¼‚æ­¥æ“ä½œ
@Service
public class OrderTransactionService {
    private final OrderAsyncService orderAsyncService;
    
    @Transactional
    public void updateOrderStatus(Long orderId, OrderStatus status) {
        // åœ¨äº‹åŠ¡ä¸­å®Œæˆæ•°æ®åº“æ“ä½œ
        Order order = orderRepository.findById(orderId);
        order.setStatus(status);
        orderRepository.save(order);
        
        // äº‹åŠ¡æäº¤åè§¦å‘å¼‚æ­¥æ“ä½œ
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    orderAsyncService.handleOrderStatusChange(order);
                }
            }
        );
    }
}
```

#### 4.3.3 å¹¶å‘æ§åˆ¶æ£€æŸ¥ ğŸ”´:

##### 4.3.3.1 åŒæ­¥æœºåˆ¶ä½¿ç”¨æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å…±äº«èµ„æºè®¿é—®æ˜¯å¦æœ‰é€‚å½“çš„åŒæ­¥ä¿æŠ¤ã€‚
b. åŒæ­¥æœºåˆ¶çš„é€‰æ‹©æ˜¯å¦åˆç†ã€‚
c. é”çš„ç²’åº¦æ˜¯å¦é€‚å½“ã€‚
d. æ˜¯å¦é¿å…äº†æ­»é”é£é™©ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€åˆ†æï¼ˆä½¿ç”¨SpotBugsæ£€æµ‹å¹¶å‘é—®é¢˜ï¼‰ã€‚
2. ä»£ç å®¡æŸ¥ï¼ˆæ£€æŸ¥æ‰€æœ‰åŒæ­¥ä»£ç å—å’Œæ–¹æ³•ï¼‰ã€‚
3. å‹åŠ›æµ‹è¯•ï¼ˆå¹¶å‘è´Ÿè½½æµ‹è¯•ï¼‰ã€‚
4. æ­»é”æ£€æµ‹ï¼ˆJConsoleã€VisualVMç›‘æ§ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šsynchronizedæ–¹æ³•è¿‡å¤§ï¼Œé”ç²’åº¦è¿‡ç²—
@Service
public class DataService {
    private final Map<String, Object> cache = new HashMap<>();
    
    public synchronized void processData(String key, Object data) {
        // 30+è¡Œä»£ç ï¼Œé”ç²’åº¦è¿‡å¤§ï¼Œå½±å“å¹¶å‘æ€§èƒ½
        validateData(data); // éªŒè¯é€»è¾‘ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        transformData(data); // è½¬æ¢é€»è¾‘ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        
        // åªæœ‰è¿™éƒ¨åˆ†éœ€è¦é”ä¿æŠ¤
        cache.put(key, data);
        
        notifyListeners(data); // é€šçŸ¥é€»è¾‘ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        logOperation(key, data); // æ—¥å¿—è®°å½•ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        sendMetrics(data); // æŒ‡æ ‡å‘é€ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        updateStatistics(); // ç»Ÿè®¡æ›´æ–°ï¼Œä¸éœ€è¦é”ä¿æŠ¤
        // ... æ›´å¤šä¸éœ€è¦é”ä¿æŠ¤çš„æ“ä½œ
    }
}

// âŒ é”™è¯¯ï¼šå¯èƒ½å¯¼è‡´æ­»é”çš„é”é¡ºåº
public class AccountService {
    public void transfer(Account from, Account to, BigDecimal amount) {
        synchronized(from) {
            synchronized(to) { // é”é¡ºåºä¸ä¸€è‡´ï¼Œå¯èƒ½æ­»é”
                if (from.getBalance().compareTo(amount) >= 0) {
                    from.debit(amount);
                    to.credit(amount);
                }
            }
        }
    }
    
    public void reverseTransfer(Account to, Account from, BigDecimal amount) {
        synchronized(to) {
            synchronized(from) { // ä¸transferæ–¹æ³•é”é¡ºåºç›¸åï¼Œå¿…ç„¶æ­»é”
                if (from.getBalance().compareTo(amount) >= 0) {
                    from.debit(amount);
                    to.credit(amount);
                }
            }
        }
    }
}

// âŒ é”™è¯¯ï¼švolatileç”¨äºå¤åˆæ“ä½œ
public class CounterService {
    private volatile int counter = 0;
    
    public void increment() {
        counter++; // å¤åˆæ“ä½œï¼Œvolatileæ— æ³•ä¿è¯åŸå­æ€§
    }
    
    public void addValue(int value) {
        counter += value; // å¤åˆæ“ä½œï¼Œçº¿ç¨‹ä¸å®‰å…¨
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¹¶å‘é›†åˆå’Œç»†ç²’åº¦é”
@Service
public class DataService {
    private final ConcurrentHashMap<String, Object> cache = new ConcurrentHashMap<>();
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    private final Object statisticsLock = new Object();
    
    public void processData(String key, Object data) {
        // ä¸éœ€è¦é”ä¿æŠ¤çš„æ“ä½œ
        validateData(data);
        transformData(data);
        
        // åªåœ¨å¿…è¦æ—¶åŠ é”ï¼Œä½¿ç”¨å¹¶å‘é›†åˆ
        cache.put(key, data);
        
        // ä¸éœ€è¦é”ä¿æŠ¤çš„æ“ä½œ
        notifyListeners(data);
        logOperation(key, data);
        sendMetrics(data);
        
        // ç»Ÿè®¡æ›´æ–°ä½¿ç”¨å•ç‹¬çš„é”
        synchronized(statisticsLock) {
            updateStatistics();
        }
    }
    
    public Object getData(String key) {
        return cache.get(key); // ConcurrentHashMapçº¿ç¨‹å®‰å…¨
    }
    
    public void batchUpdate(Map<String, Object> updates) {
        // æ‰¹é‡æ“ä½œä½¿ç”¨å†™é”
        lock.writeLock().lock();
        try {
            updates.forEach(cache::put);
        } finally {
            lock.writeLock().unlock();
        }
    }
    
    public Set<String> getAllKeys() {
        // è¯»æ“ä½œä½¿ç”¨è¯»é”
        lock.readLock().lock();
        try {
            return new HashSet<>(cache.keySet());
        } finally {
            lock.readLock().unlock();
        }
    }
}

// âœ… æ­£ç¡®ï¼šé¿å…æ­»é”çš„é”æ’åº
public class AccountService {
    
    public void transfer(Account from, Account to, BigDecimal amount) {
        // ä½¿ç”¨è´¦æˆ·IDæ’åºæ¥é¿å…æ­»é”
        Account firstLock = from.getId() < to.getId() ? from : to;
        Account secondLock = from.getId() < to.getId() ? to : from;
        
        synchronized(firstLock) {
            synchronized(secondLock) {
                validateTransfer(from, to, amount);
                from.debit(amount);
                to.credit(amount);
                logTransfer(from, to, amount);
            }
        }
    }
    
    // æˆ–è€…ä½¿ç”¨æ›´é«˜çº§çš„å¹¶å‘å·¥å…·
    private final StripedLock stripedLock = new StripedLock(16);
    
    public void transferWithStripedLock(Account from, Account to, BigDecimal amount) {
        // ä½¿ç”¨åˆ†æ®µé”å‡å°‘é”ç«äº‰
        Lock lock1 = stripedLock.get(from.getId());
        Lock lock2 = stripedLock.get(to.getId());
        
        if (from.getId() < to.getId()) {
            lock1.lock();
            try {
                lock2.lock();
                try {
                    performTransfer(from, to, amount);
                } finally {
                    lock2.unlock();
                }
            } finally {
                lock1.unlock();
            }
        } else {
            lock2.lock();
            try {
                lock1.lock();
                try {
                    performTransfer(from, to, amount);
                } finally {
                    lock1.unlock();
                }
            } finally {
                lock2.unlock();
            }
        }
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸå­ç±»å’Œé€‚å½“çš„volatile
public class CounterService {
    private final AtomicInteger counter = new AtomicInteger(0);
    private volatile boolean enabled = true; // ç®€å•çŠ¶æ€æ ‡è®°ï¼Œé€‚åˆä½¿ç”¨volatile
    
    public void increment() {
        if (enabled) {
            counter.incrementAndGet(); // åŸå­æ“ä½œ
        }
    }
    
    public void addValue(int value) {
        if (enabled) {
            counter.addAndGet(value); // åŸå­æ“ä½œ
        }
    }
    
    public int getValue() {
        return counter.get();
    }
    
    public void setEnabled(boolean enabled) {
        this.enabled = enabled; // ç®€å•èµ‹å€¼ï¼Œvolatileä¿è¯å¯è§æ€§
    }
    
    public boolean isEnabled() {
        return enabled;
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨CompletableFutureå¤„ç†å¤æ‚å¹¶å‘åœºæ™¯
@Service
public class OrderProcessingService {
    private final PaymentService paymentService;
    private final InventoryService inventoryService;
    private final ShippingService shippingService;
    
    public CompletableFuture<OrderResult> processOrder(Order order) {
        // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªç‹¬ç«‹çš„æ“ä½œ
        CompletableFuture<PaymentResult> paymentFuture = 
            CompletableFuture.supplyAsync(() -> paymentService.processPayment(order));
            
        CompletableFuture<InventoryResult> inventoryFuture = 
            CompletableFuture.supplyAsync(() -> inventoryService.reserveItems(order));
            
        // ç­‰å¾…å‰ä¸¤ä¸ªæ“ä½œå®Œæˆåæ‰§è¡Œå‘è´§
        return paymentFuture.thenCombine(inventoryFuture, (payment, inventory) -> {
            if (payment.isSuccess() && inventory.isSuccess()) {
                ShippingResult shipping = shippingService.arrangeShipping(order);
                return OrderResult.success(order, payment, inventory, shipping);
            } else {
                // å›æ»šæ“ä½œ
                rollbackOperations(order, payment, inventory);
                return OrderResult.failure(order, "æ”¯ä»˜æˆ–åº“å­˜é¢„ç•™å¤±è´¥");
            }
        }).exceptionally(throwable -> {
            log.error("è®¢å•å¤„ç†å¼‚å¸¸", throwable);
            return OrderResult.failure(order, "ç³»ç»Ÿå¼‚å¸¸: " + throwable.getMessage());
        });
    }
}
```

### 4.4 æ•°æ®å¤„ç†æ£€æŸ¥

#### 4.4.1 æ•°æ®æŒä¹…åŒ–ä¸å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´:

##### 4.4.1.1 äº‹åŠ¡ç®¡ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é‡è¦æ•°æ®æ“ä½œæ˜¯å¦ä½¿ç”¨äº‹åŠ¡ä¿æŠ¤ã€‚
b. äº‹åŠ¡è¾¹ç•Œæ˜¯å¦åˆç†è®¾ç½®ã€‚
c. äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ˜¯å¦æ­£ç¡®é…ç½®ã€‚
d. åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å¦æœ‰é€‚å½“çš„å¤„ç†æœºåˆ¶ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æï¼ˆæ£€æŸ¥@Transactionalæ³¨è§£çš„ä½¿ç”¨ï¼‰ã€‚
2. ä»£ç å®¡æŸ¥ï¼ˆæ£€æŸ¥æ•°æ®æ“ä½œçš„äº‹åŠ¡å®Œæ•´æ€§ï¼‰ã€‚
3. é›†æˆæµ‹è¯•ï¼ˆéªŒè¯äº‹åŠ¡å›æ»šæœºåˆ¶ï¼‰ã€‚
4. æ•°æ®åº“æ—¥å¿—åˆ†æï¼ˆç¡®è®¤äº‹åŠ¡æ‰§è¡Œæƒ…å†µï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰äº‹åŠ¡ä¿æŠ¤çš„é‡è¦æ•°æ®æ“ä½œ
@Service
public class TransferService {
    @Autowired
    private AccountRepository accountRepository;
    @Autowired
    private TransactionLogRepository logRepository;
    
    public void transferMoney(String fromAccount, String toAccount, BigDecimal amount) {
        // æ²¡æœ‰äº‹åŠ¡ä¿æŠ¤ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
        Account from = accountRepository.findByAccountNumber(fromAccount);
        Account to = accountRepository.findByAccountNumber(toAccount);
        
        from.setBalance(from.getBalance().subtract(amount));
        accountRepository.save(from);
        
        // å¦‚æœè¿™é‡Œå‘ç”Ÿå¼‚å¸¸ï¼Œfromè´¦æˆ·å·²ç»æ‰£æ¬¾ä½†toè´¦æˆ·æ²¡æœ‰æ”¶åˆ°é’±
        to.setBalance(to.getBalance().add(amount));
        accountRepository.save(to);
        
        // æ—¥å¿—è®°å½•ä¹Ÿå¯èƒ½å¤±è´¥
        TransactionLog log = new TransactionLog(fromAccount, toAccount, amount);
        logRepository.save(log);
    }
}

// âŒ é”™è¯¯ï¼šäº‹åŠ¡è¾¹ç•Œè®¾ç½®ä¸å½“
@Service
public class OrderService {
    @Transactional
    public void processOrder(Order order) {
        // äº‹åŠ¡èŒƒå›´è¿‡å¤§ï¼ŒåŒ…å«äº†ä¸éœ€è¦äº‹åŠ¡çš„æ“ä½œ
        validateOrder(order); // éªŒè¯é€»è¾‘ï¼Œä¸éœ€è¦äº‹åŠ¡
        sendNotification(order); // å‘é€é€šçŸ¥ï¼Œä¸éœ€è¦äº‹åŠ¡
        
        // åªæœ‰è¿™éƒ¨åˆ†éœ€è¦äº‹åŠ¡
        orderRepository.save(order);
        inventoryService.updateStock(order.getItems());
    }
}

// âŒ é”™è¯¯ï¼šäº‹åŠ¡ä¼ æ’­è¡Œä¸ºé…ç½®é”™è¯¯
@Service
public class UserService {
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void updateUserProfile(User user) {
        userRepository.save(user);
        // é”™è¯¯ï¼šæ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°äº‹åŠ¡ï¼Œæ— æ³•ä¸è°ƒç”¨æ–¹äº‹åŠ¡åè°ƒ
        auditService.logUserUpdate(user); // è¿™ä¸ªè°ƒç”¨ä¹Ÿä¼šåˆ›å»ºæ–°äº‹åŠ¡
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨äº‹åŠ¡ä¿æŠ¤é‡è¦æ•°æ®æ“ä½œ
@Service
public class TransferService {
    private static final Logger logger = LoggerFactory.getLogger(TransferService.class);
    
    @Autowired
    private AccountRepository accountRepository;
    @Autowired
    private TransactionLogRepository logRepository;
    
    @Transactional(rollbackFor = Exception.class)
    public TransferResult transferMoney(String fromAccount, String toAccount, BigDecimal amount) {
        try {
            // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ‰€æœ‰ç›¸å…³æ“ä½œ
            Account from = accountRepository.findByAccountNumberForUpdate(fromAccount);
            Account to = accountRepository.findByAccountNumberForUpdate(toAccount);
            
            // ä¸šåŠ¡éªŒè¯
            validateTransfer(from, to, amount);
            
            // æ‰§è¡Œè½¬è´¦
            from.setBalance(from.getBalance().subtract(amount));
            to.setBalance(to.getBalance().add(amount));
            
            accountRepository.save(from);
            accountRepository.save(to);
            
            // è®°å½•äº¤æ˜“æ—¥å¿—
            TransactionLog log = TransactionLog.builder()
                .fromAccount(fromAccount)
                .toAccount(toAccount)
                .amount(amount)
                .timestamp(LocalDateTime.now())
                .status(TransactionStatus.SUCCESS)
                .build();
            logRepository.save(log);
            
            logger.info("è½¬è´¦æˆåŠŸ: {} -> {}, é‡‘é¢: {}", fromAccount, toAccount, amount);
            return TransferResult.success(log.getId());
            
        } catch (Exception e) {
            logger.error("è½¬è´¦å¤±è´¥: {} -> {}, é‡‘é¢: {}", fromAccount, toAccount, amount, e);
            throw new TransferException("è½¬è´¦æ“ä½œå¤±è´¥", e);
        }
    }
    
    private void validateTransfer(Account from, Account to, BigDecimal amount) {
        if (from == null) {
            throw new AccountNotFoundException("æºè´¦æˆ·ä¸å­˜åœ¨");
        }
        if (to == null) {
            throw new AccountNotFoundException("ç›®æ ‡è´¦æˆ·ä¸å­˜åœ¨");
        }
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new InvalidAmountException("è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0");
        }
        if (from.getBalance().compareTo(amount) < 0) {
            throw new InsufficientBalanceException("è´¦æˆ·ä½™é¢ä¸è¶³");
        }
    }
}

// âœ… æ­£ç¡®ï¼šåˆç†çš„äº‹åŠ¡è¾¹ç•Œ
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private InventoryService inventoryService;
    @Autowired
    private NotificationService notificationService;
    
    public OrderResult processOrder(Order order) {
        // éäº‹åŠ¡æ“ä½œ
        validateOrder(order);
        
        // äº‹åŠ¡æ“ä½œ
        Order savedOrder = saveOrderWithTransaction(order);
        
        // éäº‹åŠ¡æ“ä½œï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰
        CompletableFuture.runAsync(() -> {
            notificationService.sendOrderConfirmation(savedOrder);
        });
        
        return OrderResult.success(savedOrder);
    }
    
    @Transactional(rollbackFor = Exception.class)
    public Order saveOrderWithTransaction(Order order) {
        // åªåœ¨éœ€è¦äº‹åŠ¡çš„æ“ä½œä¸­ä½¿ç”¨äº‹åŠ¡
        Order savedOrder = orderRepository.save(order);
        inventoryService.updateStock(order.getItems());
        return savedOrder;
    }
}

// âœ… æ­£ç¡®ï¼šé€‚å½“çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸º
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    @Autowired
    private AuditService auditService;
    
    @Transactional
    public void updateUserProfile(User user) {
        User savedUser = userRepository.save(user);
        // ä½¿ç”¨é»˜è®¤ä¼ æ’­è¡Œä¸ºï¼Œä¸å½“å‰äº‹åŠ¡åè°ƒ
        auditService.logUserUpdate(savedUser);
    }
}

@Service
public class AuditService {
    @Autowired
    private AuditLogRepository auditLogRepository;
    
    @Transactional(propagation = Propagation.REQUIRED)
    public void logUserUpdate(User user) {
        // å‚ä¸è°ƒç”¨æ–¹çš„äº‹åŠ¡
        AuditLog log = AuditLog.builder()
            .userId(user.getId())
            .action("UPDATE_PROFILE")
            .timestamp(LocalDateTime.now())
            .build();
        auditLogRepository.save(log);
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void logCriticalEvent(String event, String details) {
        // ç‹¬ç«‹äº‹åŠ¡ï¼Œå³ä½¿è°ƒç”¨æ–¹äº‹åŠ¡å›æ»šä¹Ÿè¦è®°å½•
        CriticalEventLog log = CriticalEventLog.builder()
            .event(event)
            .details(details)
            .timestamp(LocalDateTime.now())
            .build();
        criticalEventLogRepository.save(log);
    }
}
```

##### 4.4.1.2 æ•°æ®éªŒè¯æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰å¤–éƒ¨è¾“å…¥æ˜¯å¦æœ‰å®Œæ•´çš„éªŒè¯æœºåˆ¶ã€‚
b. æ•°æ®éªŒè¯è§„åˆ™æ˜¯å¦è¦†ç›–ä¸šåŠ¡éœ€æ±‚ã€‚
c. éªŒè¯å¤±è´¥æ—¶æ˜¯å¦æœ‰åˆé€‚çš„é”™è¯¯å¤„ç†ã€‚
d. æ˜¯å¦æœ‰é˜²æ­¢SQLæ³¨å…¥å’ŒXSSæ”»å‡»çš„æªæ–½ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä»£ç å®¡æŸ¥ï¼ˆæ£€æŸ¥è¾“å…¥éªŒè¯çš„å®Œæ•´æ€§ï¼‰ã€‚
2. å®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æ³¨å…¥æªæ–½ï¼‰ã€‚
3. è¾¹ç•Œå€¼æµ‹è¯•ï¼ˆéªŒè¯æ•°æ®éªŒè¯è§„åˆ™ï¼‰ã€‚
4. é™æ€åˆ†æå·¥å…·æ£€æµ‹ï¼ˆå¦‚OWASPä¾èµ–æ£€æŸ¥ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰è¾“å…¥éªŒè¯
@RestController
public class UserController {
    @Autowired
    private UserService userService;
    
    @PostMapping("/users")
    public ResponseEntity<User> createUser(@RequestBody UserRequest request) {
        // æ²¡æœ‰éªŒè¯è¾“å…¥æ•°æ®çš„æœ‰æ•ˆæ€§
        User user = new User();
        user.setUsername(request.getUsername()); // å¯èƒ½ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²
        user.setEmail(request.getEmail()); // å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼
        user.setAge(request.getAge()); // å¯èƒ½æ˜¯è´Ÿæ•°æˆ–è¶…å‡ºåˆç†èŒƒå›´
        
        return ResponseEntity.ok(userService.save(user));
    }
    
    // âŒ é”™è¯¯ï¼šSQLæ³¨å…¥é£é™©
    @GetMapping("/users/search")
    public List<User> searchUsers(@RequestParam String keyword) {
        // ç›´æ¥æ‹¼æ¥SQLï¼Œå­˜åœ¨æ³¨å…¥é£é™©
        String sql = "SELECT * FROM users WHERE name LIKE '%" + keyword + "%'";
        return jdbcTemplate.query(sql, userRowMapper);
    }
}

// âŒ é”™è¯¯ï¼šéªŒè¯è§„åˆ™ä¸å®Œæ•´
public class ProductRequest {
    private String name; // æ²¡æœ‰éªŒè¯æ³¨è§£
    private BigDecimal price; // æ²¡æœ‰éªŒè¯ä»·æ ¼èŒƒå›´
    private String description; // æ²¡æœ‰é•¿åº¦é™åˆ¶
    
    // getters and setters
}

// âŒ é”™è¯¯ï¼šè‡ªå®šä¹‰éªŒè¯é€»è¾‘ä¸å®Œæ•´
@Service
public class OrderService {
    public void createOrder(OrderRequest request) {
        // éªŒè¯é€»è¾‘ä¸å®Œæ•´
        if (request.getItems() == null) {
            throw new IllegalArgumentException("è®¢å•é¡¹ä¸èƒ½ä¸ºç©º");
        }
        // æ²¡æœ‰éªŒè¯è®¢å•é¡¹çš„è¯¦ç»†å†…å®¹
        // æ²¡æœ‰éªŒè¯ç”¨æˆ·æƒé™
        // æ²¡æœ‰éªŒè¯åº“å­˜
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„è¾“å…¥éªŒè¯
@RestController
@Validated
public class UserController {
    private static final Logger logger = LoggerFactory.getLogger(UserController.class);
    
    @Autowired
    private UserService userService;
    
    @PostMapping("/users")
    public ResponseEntity<UserResponse> createUser(
            @Valid @RequestBody UserRequest request,
            BindingResult bindingResult) {
        
        // æ£€æŸ¥éªŒè¯ç»“æœ
        if (bindingResult.hasErrors()) {
            List<String> errors = bindingResult.getFieldErrors().stream()
                .map(error -> error.getField() + ": " + error.getDefaultMessage())
                .collect(Collectors.toList());
            
            logger.warn("ç”¨æˆ·åˆ›å»ºè¯·æ±‚éªŒè¯å¤±è´¥: {}", errors);
            return ResponseEntity.badRequest()
                .body(UserResponse.error("è¾“å…¥éªŒè¯å¤±è´¥", errors));
        }
        
        try {
            User user = userService.createUser(request);
            return ResponseEntity.ok(UserResponse.success(user));
        } catch (UserAlreadyExistsException e) {
            return ResponseEntity.status(HttpStatus.CONFLICT)
                .body(UserResponse.error("ç”¨æˆ·å·²å­˜åœ¨", e.getMessage()));
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
    @GetMapping("/users/search")
    public ResponseEntity<List<UserResponse>> searchUsers(
            @RequestParam @Pattern(regexp = "^[a-zA-Z0-9\\s]{1,50}$", 
                                 message = "æœç´¢å…³é”®è¯åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œç©ºæ ¼ï¼Œé•¿åº¦1-50") 
            String keyword) {
        
        List<User> users = userService.searchUsers(keyword);
        List<UserResponse> responses = users.stream()
            .map(UserResponse::from)
            .collect(Collectors.toList());
            
        return ResponseEntity.ok(responses);
    }
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„éªŒè¯æ³¨è§£
public class UserRequest {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;
    
    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 100, message = "é‚®ç®±é•¿åº¦ä¸èƒ½è¶…è¿‡100å­—ç¬¦")
    private String email;
    
    @NotNull(message = "å¹´é¾„ä¸èƒ½ä¸ºç©º")
    @Min(value = 18, message = "å¹´é¾„ä¸èƒ½å°äº18å²")
    @Max(value = 120, message = "å¹´é¾„ä¸èƒ½å¤§äº120å²")
    private Integer age;
    
    @Size(max = 500, message = "ä¸ªäººç®€ä»‹ä¸èƒ½è¶…è¿‡500å­—ç¬¦")
    private String bio;
    
    @Valid
    @NotNull(message = "åœ°å€ä¿¡æ¯ä¸èƒ½ä¸ºç©º")
    private AddressRequest address;
    
    // getters and setters
}

public class AddressRequest {
    @NotBlank(message = "çœä»½ä¸èƒ½ä¸ºç©º")
    private String province;
    
    @NotBlank(message = "åŸå¸‚ä¸èƒ½ä¸ºç©º")
    private String city;
    
    @NotBlank(message = "è¯¦ç»†åœ°å€ä¸èƒ½ä¸ºç©º")
    @Size(max = 200, message = "è¯¦ç»†åœ°å€ä¸èƒ½è¶…è¿‡200å­—ç¬¦")
    private String detail;
    
    @Pattern(regexp = "^\\d{6}$", message = "é‚®æ”¿ç¼–ç å¿…é¡»æ˜¯6ä½æ•°å­—")
    private String zipCode;
    
    // getters and setters
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢å’Œå®Œæ•´éªŒè¯
@Repository
public class UserRepository {
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public List<User> searchUsers(String keyword) {
        // ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
        String sql = "SELECT * FROM users WHERE name LIKE ? OR email LIKE ? ORDER BY created_at DESC LIMIT 100";
        String searchPattern = "%" + keyword + "%";
        
        return jdbcTemplate.query(sql, 
            new Object[]{searchPattern, searchPattern}, 
            userRowMapper);
    }
    
    public Optional<User> findByUsername(String username) {
        String sql = "SELECT * FROM users WHERE username = ?";
        try {
            User user = jdbcTemplate.queryForObject(sql, new Object[]{username}, userRowMapper);
            return Optional.of(user);
        } catch (EmptyResultDataAccessException e) {
            return Optional.empty();
        }
    }
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ä¸šåŠ¡éªŒè¯
@Service
public class OrderService {
    @Autowired
    private UserService userService;
    @Autowired
    private ProductService productService;
    @Autowired
    private InventoryService inventoryService;
    
    @Transactional
    public Order createOrder(OrderRequest request, String userId) {
        // 1. éªŒè¯ç”¨æˆ·æƒé™
        User user = userService.findById(userId)
            .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        if (!user.isActive()) {
            throw new UserNotActiveException("ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨");
        }
        
        // 2. éªŒè¯è®¢å•é¡¹
        validateOrderItems(request.getItems());
        
        // 3. éªŒè¯åº“å­˜
        validateInventory(request.getItems());
        
        // 4. éªŒè¯è®¢å•æ€»é‡‘é¢
        BigDecimal calculatedTotal = calculateOrderTotal(request.getItems());
        if (calculatedTotal.compareTo(request.getTotalAmount()) != 0) {
            throw new OrderValidationException("è®¢å•æ€»é‡‘é¢ä¸åŒ¹é…");
        }
        
        // 5. åˆ›å»ºè®¢å•
        Order order = Order.builder()
            .userId(userId)
            .items(request.getItems())
            .totalAmount(calculatedTotal)
            .status(OrderStatus.CREATED)
            .createdAt(LocalDateTime.now())
            .build();
            
        return orderRepository.save(order);
    }
    
    private void validateOrderItems(List<OrderItemRequest> items) {
        if (items == null || items.isEmpty()) {
            throw new OrderValidationException("è®¢å•é¡¹ä¸èƒ½ä¸ºç©º");
        }
        
        for (OrderItemRequest item : items) {
            if (item.getProductId() == null) {
                throw new OrderValidationException("å•†å“IDä¸èƒ½ä¸ºç©º");
            }
            
            if (item.getQuantity() == null || item.getQuantity() <= 0) {
                throw new OrderValidationException("å•†å“æ•°é‡å¿…é¡»å¤§äº0");
            }
            
            if (item.getQuantity() > 999) {
                throw new OrderValidationException("å•ä¸ªå•†å“æ•°é‡ä¸èƒ½è¶…è¿‡999");
            }
            
            // éªŒè¯å•†å“æ˜¯å¦å­˜åœ¨ä¸”å¯è´­ä¹°
            Product product = productService.findById(item.getProductId())
                .orElseThrow(() -> new ProductNotFoundException("å•†å“ä¸å­˜åœ¨: " + item.getProductId()));
                
            if (!product.isAvailable()) {
                throw new ProductNotAvailableException("å•†å“ä¸å¯è´­ä¹°: " + product.getName());
            }
        }
    }
    
    private void validateInventory(List<OrderItemRequest> items) {
        for (OrderItemRequest item : items) {
            int availableStock = inventoryService.getAvailableStock(item.getProductId());
            if (availableStock < item.getQuantity()) {
                Product product = productService.findById(item.getProductId()).get();
                throw new InsufficientStockException(
                    String.format("å•†å“ %s åº“å­˜ä¸è¶³ï¼Œå¯ç”¨åº“å­˜: %dï¼Œéœ€è¦: %d", 
                        product.getName(), availableStock, item.getQuantity()));
            }
        }
    }
}
```

##### 4.4.1.3 æ•°æ®å¤‡ä»½ä¸æ¢å¤æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å…³é”®æ•°æ®æ˜¯å¦æœ‰å®šæœŸå¤‡ä»½æœºåˆ¶ã€‚
b. å¤‡ä»½æ•°æ®çš„å®Œæ•´æ€§å’Œå¯æ¢å¤æ€§ã€‚
c. å¤‡ä»½ç­–ç•¥æ˜¯å¦ç¬¦åˆä¸šåŠ¡æ¢å¤è¦æ±‚ã€‚
d. æ˜¯å¦æœ‰ç¾éš¾æ¢å¤é¢„æ¡ˆå’Œæµ‹è¯•æœºåˆ¶ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. å¤‡ä»½ç­–ç•¥æ–‡æ¡£å®¡æŸ¥ã€‚
2. å¤‡ä»½è„šæœ¬å’Œé…ç½®æ£€æŸ¥ã€‚
3. æ¢å¤æµ‹è¯•éªŒè¯ã€‚
4. å¤‡ä»½ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶æ£€æŸ¥ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰å¤‡ä»½æœºåˆ¶çš„å…³é”®æ•°æ®æ“ä½œ
@Service
public class CriticalDataService {
    @Autowired
    private CriticalDataRepository repository;
    
    public void updateCriticalData(CriticalData data) {
        // ç›´æ¥æ›´æ–°å…³é”®æ•°æ®ï¼Œæ²¡æœ‰å¤‡ä»½
        repository.save(data);
    }
    
    public void deleteCriticalData(Long id) {
        // ç›´æ¥åˆ é™¤ï¼Œæ²¡æœ‰è½¯åˆ é™¤æˆ–å¤‡ä»½
        repository.deleteById(id);
    }
}

// âŒ é”™è¯¯ï¼šå¤‡ä»½ç­–ç•¥ä¸å®Œæ•´
@Component
public class BackupService {
    public void backupDatabase() {
        // åªå¤‡ä»½æ•°æ®åº“ï¼Œæ²¡æœ‰å¤‡ä»½æ–‡ä»¶ç³»ç»Ÿ
        // æ²¡æœ‰éªŒè¯å¤‡ä»½å®Œæ•´æ€§
        // æ²¡æœ‰å¼‚åœ°å¤‡ä»½
        String command = "mysqldump -u user -p database > backup.sql";
        Runtime.getRuntime().exec(command);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå¸¦å¤‡ä»½æœºåˆ¶çš„å…³é”®æ•°æ®æ“ä½œ
@Service
public class CriticalDataService {
    private static final Logger logger = LoggerFactory.getLogger(CriticalDataService.class);
    
    @Autowired
    private CriticalDataRepository repository;
    @Autowired
    private DataBackupService backupService;
    @Autowired
    private AuditService auditService;
    
    @Transactional
    public CriticalData updateCriticalData(CriticalData data) {
        // 1. å¤‡ä»½åŸå§‹æ•°æ®
        CriticalData originalData = repository.findById(data.getId())
            .orElseThrow(() -> new DataNotFoundException("æ•°æ®ä¸å­˜åœ¨"));
        
        backupService.backupCriticalData(originalData);
        
        // 2. æ›´æ–°æ•°æ®
        CriticalData updatedData = repository.save(data);
        
        // 3. è®°å½•å®¡è®¡æ—¥å¿—
        auditService.logDataUpdate(originalData, updatedData);
        
        logger.info("å…³é”®æ•°æ®æ›´æ–°æˆåŠŸ: id={}", data.getId());
        return updatedData;
    }
    
    @Transactional
    public void deleteCriticalData(Long id) {
        CriticalData data = repository.findById(id)
            .orElseThrow(() -> new DataNotFoundException("æ•°æ®ä¸å­˜åœ¨"));
        
        // è½¯åˆ é™¤ï¼Œä¿ç•™æ•°æ®
        data.setDeleted(true);
        data.setDeletedAt(LocalDateTime.now());
        repository.save(data);
        
        // å¤‡ä»½åˆ é™¤çš„æ•°æ®
        backupService.backupDeletedData(data);
        
        // è®°å½•åˆ é™¤æ—¥å¿—
        auditService.logDataDeletion(data);
        
        logger.info("å…³é”®æ•°æ®åˆ é™¤æˆåŠŸ: id={}", id);
    }
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å¤‡ä»½æœåŠ¡
@Service
public class DataBackupService {
    private static final Logger logger = LoggerFactory.getLogger(DataBackupService.class);
    
    @Value("${backup.local.path}")
    private String localBackupPath;
    
    @Value("${backup.remote.enabled:true}")
    private boolean remoteBackupEnabled;
    
    @Autowired
    private S3BackupClient s3Client;
    @Autowired
    private BackupRepository backupRepository;
    
    public void backupCriticalData(CriticalData data) {
        try {
            // 1. åˆ›å»ºæœ¬åœ°å¤‡ä»½
            String backupFileName = createLocalBackup(data);
            
            // 2. ä¸Šä¼ åˆ°è¿œç¨‹å­˜å‚¨
            String remoteLocation = null;
            if (remoteBackupEnabled) {
                remoteLocation = uploadToRemoteStorage(backupFileName);
            }
            
            // 3. è®°å½•å¤‡ä»½ä¿¡æ¯
            BackupRecord record = BackupRecord.builder()
                .dataId(data.getId())
                .dataType("CRITICAL_DATA")
                .localPath(backupFileName)
                .remotePath(remoteLocation)
                .backupTime(LocalDateTime.now())
                .checksum(calculateChecksum(data))
                .build();
            
            backupRepository.save(record);
            
            logger.info("æ•°æ®å¤‡ä»½æˆåŠŸ: dataId={}, backupId={}", data.getId(), record.getId());
            
        } catch (Exception e) {
            logger.error("æ•°æ®å¤‡ä»½å¤±è´¥: dataId={}", data.getId(), e);
            throw new BackupException("æ•°æ®å¤‡ä»½å¤±è´¥", e);
        }
    }
    
    public CriticalData restoreData(Long backupId) {
        try {
            BackupRecord record = backupRepository.findById(backupId)
                .orElseThrow(() -> new BackupNotFoundException("å¤‡ä»½è®°å½•ä¸å­˜åœ¨"));
            
            // 1. ä»æœ¬åœ°æˆ–è¿œç¨‹æ¢å¤æ•°æ®
            String dataContent = restoreFromStorage(record);
            
            // 2. éªŒè¯æ•°æ®å®Œæ•´æ€§
            CriticalData restoredData = deserializeData(dataContent);
            String currentChecksum = calculateChecksum(restoredData);
            
            if (!currentChecksum.equals(record.getChecksum())) {
                throw new DataCorruptionException("å¤‡ä»½æ•°æ®æ ¡éªŒå¤±è´¥");
            }
            
            logger.info("æ•°æ®æ¢å¤æˆåŠŸ: backupId={}, dataId={}", backupId, restoredData.getId());
            return restoredData;
            
        } catch (Exception e) {
            logger.error("æ•°æ®æ¢å¤å¤±è´¥: backupId={}", backupId, e);
            throw new RestoreException("æ•°æ®æ¢å¤å¤±è´¥", e);
        }
    }
    
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void performScheduledBackup() {
        logger.info("å¼€å§‹æ‰§è¡Œå®šæ—¶å¤‡ä»½ä»»åŠ¡");
        
        try {
            // 1. å¤‡ä»½æ•°æ®åº“
            backupDatabase();
            
            // 2. å¤‡ä»½æ–‡ä»¶ç³»ç»Ÿ
            backupFileSystem();
            
            // 3. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
            validateBackupIntegrity();
            
            // 4. æ¸…ç†è¿‡æœŸå¤‡ä»½
            cleanupOldBackups();
            
            logger.info("å®šæ—¶å¤‡ä»½ä»»åŠ¡å®Œæˆ");
            
        } catch (Exception e) {
            logger.error("å®šæ—¶å¤‡ä»½ä»»åŠ¡å¤±è´¥", e);
            // å‘é€å‘Šè­¦é€šçŸ¥
            alertService.sendBackupFailureAlert(e.getMessage());
        }
    }
    
    private String createLocalBackup(CriticalData data) throws IOException {
        String fileName = String.format("critical_data_%d_%s.json", 
            data.getId(), LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss")));
        
        Path backupFile = Paths.get(localBackupPath, fileName);
        Files.createDirectories(backupFile.getParent());
        
        String jsonData = objectMapper.writeValueAsString(data);
        Files.write(backupFile, jsonData.getBytes(StandardCharsets.UTF_8));
        
        return backupFile.toString();
    }
    
    private String uploadToRemoteStorage(String localFileName) {
        // ä¸Šä¼ åˆ°S3æˆ–å…¶ä»–äº‘å­˜å‚¨
        return s3Client.uploadFile(localFileName);
    }
    
    private String calculateChecksum(CriticalData data) {
        try {
            String jsonData = objectMapper.writeValueAsString(data);
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            byte[] hash = md.digest(jsonData.getBytes(StandardCharsets.UTF_8));
            return Base64.getEncoder().encodeToString(hash);
        } catch (Exception e) {
            throw new RuntimeException("è®¡ç®—æ ¡éªŒå’Œå¤±è´¥", e);
        }
    }
}
```

### 4.5 çŠ¶æ€ç®¡ç†æ£€æŸ¥

#### 4.5.1 çŠ¶æ€è½¬æ¢å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´:

##### 4.5.1.1 çŠ¶æ€è½¬æ¢è§„åˆ™æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç³»ç»ŸçŠ¶æ€è½¬æ¢å›¾å®Œæ•´ï¼Œæ‰€æœ‰çŠ¶æ€è½¬æ¢æœ‰æ˜ç¡®å®šä¹‰ã€‚
b. æ‰€æœ‰çŠ¶æ€è½¬æ¢éƒ½æœ‰å¯¹åº”çš„å¤„ç†æœºåˆ¶ã€‚
c. æ‰€æœ‰çŠ¶æ€æµç¨‹æœ€ç»ˆéƒ½èƒ½èµ°å…¥ç»ˆæ€ã€‚
d. çŠ¶æ€ä¹‹é—´çš„è½¬æ¢æ¡ä»¶æ˜ç¡®ä¸”äº’æ–¥ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. çŠ¶æ€å›¾å®¡æŸ¥ï¼ˆéªŒè¯çŠ¶æ€è½¬æ¢çš„å®Œæ•´æ€§ï¼‰ã€‚
2. ä»£ç å®¡æŸ¥ï¼ˆæ£€æŸ¥çŠ¶æ€è½¬æ¢çš„å®ç°é€»è¾‘ï¼‰ã€‚
3. è·¯å¾„æµ‹è¯•ï¼ˆæµ‹è¯•æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€è½¬æ¢è·¯å¾„ï¼‰ã€‚
4. å¼‚å¸¸çŠ¶æ€æ£€æŸ¥ï¼ˆéªŒè¯å¼‚å¸¸æƒ…å†µä¸‹çš„çŠ¶æ€å¤„ç†ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šçŠ¶æ€è½¬æ¢ä¸å®Œæ•´ï¼Œç¼ºå°‘éƒ¨åˆ†çŠ¶æ€å¤„ç†
public enum OrderStatus {
    CREATED, PAID, SHIPPED, COMPLETED, CANCELLED
}

@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    
    public void processOrder(Order order) {
        switch(order.getStatus()) {
            case CREATED:
                // å¤„ç†åˆ›å»ºçŠ¶æ€
                validateOrder(order);
                break;
            case PAID:
                // å¤„ç†æ”¯ä»˜çŠ¶æ€
                processPayment(order);
                break;
            // âŒ é”™è¯¯ï¼šé—æ¼äº†SHIPPEDã€COMPLETEDã€CANCELLEDçŠ¶æ€çš„å¤„ç†
            default:
                // æ²¡æœ‰é»˜è®¤å¤„ç†é€»è¾‘
                break;
        }
    }
    
    // âŒ é”™è¯¯ï¼šçŠ¶æ€è½¬æ¢æ²¡æœ‰éªŒè¯è§„åˆ™
    public void updateOrderStatus(Order order, OrderStatus newStatus) {
        // ç›´æ¥æ›´æ–°çŠ¶æ€ï¼Œæ²¡æœ‰éªŒè¯è½¬æ¢æ˜¯å¦åˆæ³•
        order.setStatus(newStatus);
        orderRepository.save(order);
    }
    
    // âŒ é”™è¯¯ï¼šçŠ¶æ€å¯èƒ½æ°¸è¿œæ— æ³•åˆ°è¾¾ç»ˆæ€
    public void cancelOrder(Order order) {
        if (order.getStatus() == OrderStatus.SHIPPED) {
            // å·²å‘è´§è®¢å•ä¸èƒ½å–æ¶ˆï¼Œä½†æ²¡æœ‰æä¾›å…¶ä»–è§£å†³æ–¹æ¡ˆ
            throw new IllegalStateException("å·²å‘è´§è®¢å•ä¸èƒ½å–æ¶ˆ");
        }
        order.setStatus(OrderStatus.CANCELLED);
    }
    
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰çŠ¶æ€è½¬æ¢å†å²è®°å½•
    public void shipOrder(Order order) {
        if (order.getStatus() != OrderStatus.PAID) {
            throw new IllegalStateException("åªæœ‰å·²æ”¯ä»˜è®¢å•æ‰èƒ½å‘è´§");
        }
        order.setStatus(OrderStatus.SHIPPED);
        // æ²¡æœ‰è®°å½•çŠ¶æ€å˜æ›´å†å²
        orderRepository.save(order);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„çŠ¶æ€ç®¡ç†
public enum OrderStatus {
    CREATED("å·²åˆ›å»º"),
    PAID("å·²æ”¯ä»˜"),
    PROCESSING("å¤„ç†ä¸­"),
    SHIPPED("å·²å‘è´§"),
    COMPLETED("å·²å®Œæˆ"),
    CANCELLED("å·²å–æ¶ˆ"),
    REFUND_REQUESTED("ç”³è¯·é€€æ¬¾"),
    REFUNDED("å·²é€€æ¬¾");
    
    private final String description;
    
    OrderStatus(String description) {
        this.description = description;
    }
    
    public String getDescription() {
        return description;
    }
    
    // å®šä¹‰ç»ˆæ€
    public boolean isTerminal() {
        return this == COMPLETED || this == CANCELLED || this == REFUNDED;
    }
}

@Service
public class OrderService {
    private static final Logger logger = LoggerFactory.getLogger(OrderService.class);
    
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private OrderHistoryService orderHistoryService;
    @Autowired
    private NotificationService notificationService;
    
    // å®šä¹‰å…è®¸çš„çŠ¶æ€è½¬æ¢è§„åˆ™
    private static final Map<OrderStatus, Set<OrderStatus>> ALLOWED_TRANSITIONS = Map.of(
        OrderStatus.CREATED, Set.of(OrderStatus.PAID, OrderStatus.CANCELLED),
        OrderStatus.PAID, Set.of(OrderStatus.PROCESSING, OrderStatus.CANCELLED),
        OrderStatus.PROCESSING, Set.of(OrderStatus.SHIPPED, OrderStatus.CANCELLED),
        OrderStatus.SHIPPED, Set.of(OrderStatus.COMPLETED, OrderStatus.REFUND_REQUESTED),
        OrderStatus.COMPLETED, Set.of(OrderStatus.REFUND_REQUESTED),
        OrderStatus.REFUND_REQUESTED, Set.of(OrderStatus.REFUNDED, OrderStatus.COMPLETED),
        OrderStatus.CANCELLED, Collections.emptySet(),
        OrderStatus.REFUNDED, Collections.emptySet()
    );
    
    // éªŒè¯çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§
    private void validateStatusTransition(Order order, OrderStatus newStatus) {
        OrderStatus currentStatus = order.getStatus();
        
        if (currentStatus == newStatus) {
            logger.warn("è®¢å•çŠ¶æ€æœªå‘ç”Ÿå˜åŒ–: orderId={}, status={}", order.getId(), currentStatus);
            return;
        }
        
        Set<OrderStatus> allowedStatuses = ALLOWED_TRANSITIONS.get(currentStatus);
        if (allowedStatuses == null || !allowedStatuses.contains(newStatus)) {
            throw new IllegalStateTransitionException(
                String.format("ä¸å…è®¸ä» %s(%s) çŠ¶æ€è½¬æ¢åˆ° %s(%s) çŠ¶æ€", 
                    currentStatus, currentStatus.getDescription(),
                    newStatus, newStatus.getDescription())
            );
        }
    }
    
    // å¤„ç†æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€è½¬æ¢
    @Transactional
    public OrderStatusUpdateResult updateOrderStatus(Order order, OrderStatus newStatus, String reason) {
        try {
            // 1. éªŒè¯çŠ¶æ€è½¬æ¢
            validateStatusTransition(order, newStatus);
            
            // 2. æ‰§è¡ŒçŠ¶æ€è½¬æ¢å‰çš„ä¸šåŠ¡é€»è¾‘
            executePreTransitionLogic(order, newStatus);
            
            // 3. è®°å½•åŸå§‹çŠ¶æ€
            OrderStatus oldStatus = order.getStatus();
            
            // 4. æ›´æ–°çŠ¶æ€
            order.setStatus(newStatus);
            order.setLastUpdated(LocalDateTime.now());
            Order savedOrder = orderRepository.save(order);
            
            // 5. è®°å½•çŠ¶æ€å˜æ›´å†å²
            orderHistoryService.recordStatusChange(
                order.getId(), oldStatus, newStatus, reason);
            
            // 6. æ‰§è¡ŒçŠ¶æ€è½¬æ¢åçš„ä¸šåŠ¡é€»è¾‘
            executePostTransitionLogic(savedOrder, oldStatus, newStatus);
            
            // 7. å‘é€é€šçŸ¥
            notificationService.sendStatusChangeNotification(savedOrder, oldStatus, newStatus);
            
            logger.info("è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ: orderId={}, {} -> {}, reason={}", 
                order.getId(), oldStatus, newStatus, reason);
            
            return OrderStatusUpdateResult.success(savedOrder, oldStatus, newStatus);
            
        } catch (Exception e) {
            logger.error("è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥: orderId={}, currentStatus={}, targetStatus={}", 
                order.getId(), order.getStatus(), newStatus, e);
            throw new OrderStatusUpdateException("è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥", e);
        }
    }
    
    private void executePreTransitionLogic(Order order, OrderStatus newStatus) {
        switch (newStatus) {
            case PAID:
                validatePayment(order);
                break;
            case PROCESSING:
                validateInventory(order);
                reserveInventory(order);
                break;
            case SHIPPED:
                validateShippingInfo(order);
                generateTrackingNumber(order);
                break;
            case COMPLETED:
                validateDelivery(order);
                break;
            case CANCELLED:
                releaseInventory(order);
                processRefundIfNeeded(order);
                break;
            case REFUND_REQUESTED:
                validateRefundRequest(order);
                break;
            case REFUNDED:
                processRefund(order);
                break;
        }
    }
    
    private void executePostTransitionLogic(Order order, OrderStatus oldStatus, OrderStatus newStatus) {
        // å¦‚æœè¾¾åˆ°ç»ˆæ€ï¼Œæ‰§è¡Œç»ˆæ€å¤„ç†é€»è¾‘
        if (newStatus.isTerminal()) {
            processTerminalState(order, newStatus);
        }
        
        // æ ¹æ®æ–°çŠ¶æ€æ‰§è¡Œç›¸åº”çš„åç»­é€»è¾‘
        switch (newStatus) {
            case PAID:
                scheduleProcessing(order);
                break;
            case SHIPPED:
                startDeliveryTracking(order);
                break;
            case COMPLETED:
                generateInvoice(order);
                updateCustomerLoyalty(order);
                break;
        }
    }
    
    private void processTerminalState(Order order, OrderStatus terminalStatus) {
        logger.info("è®¢å•åˆ°è¾¾ç»ˆæ€: orderId={}, terminalStatus={}", order.getId(), terminalStatus);
        
        // æ¸…ç†ä¸´æ—¶èµ„æº
        cleanupTemporaryResources(order);
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        updateOrderStatistics(order, terminalStatus);
        
        // å½’æ¡£è®¢å•æ•°æ®
        if (shouldArchiveOrder(order)) {
            scheduleOrderArchiving(order);
        }
    }
    
    // è·å–è®¢å•å¯æ‰§è¡Œçš„ä¸‹ä¸€æ­¥æ“ä½œ
    public List<OrderAction> getAvailableActions(Order order) {
        OrderStatus currentStatus = order.getStatus();
        Set<OrderStatus> allowedStatuses = ALLOWED_TRANSITIONS.getOrDefault(
            currentStatus, Collections.emptySet());
        
        return allowedStatuses.stream()
            .map(status -> OrderAction.builder()
                .targetStatus(status)
                .actionName(getActionName(currentStatus, status))
                .description(getActionDescription(currentStatus, status))
                .build())
            .collect(Collectors.toList());
    }
    
    // æ‰¹é‡çŠ¶æ€è½¬æ¢ï¼ˆç”¨äºæ‰¹é‡æ“ä½œï¼‰
    @Transactional
    public BatchStatusUpdateResult batchUpdateStatus(
            List<Long> orderIds, OrderStatus targetStatus, String reason) {
        
        List<OrderStatusUpdateResult> successResults = new ArrayList<>();
        List<OrderStatusUpdateFailure> failures = new ArrayList<>();
        
        for (Long orderId : orderIds) {
            try {
                Order order = orderRepository.findById(orderId)
                    .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
                
                OrderStatusUpdateResult result = updateOrderStatus(order, targetStatus, reason);
                successResults.add(result);
                
            } catch (Exception e) {
                logger.error("æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥: orderId={}", orderId, e);
                failures.add(new OrderStatusUpdateFailure(orderId, e.getMessage()));
            }
        }
        
        return BatchStatusUpdateResult.builder()
            .successCount(successResults.size())
            .failureCount(failures.size())
            .successResults(successResults)
            .failures(failures)
            .build();
    }
}

// çŠ¶æ€è½¬æ¢ç»“æœç±»
public class OrderStatusUpdateResult {
    private final boolean success;
    private final Order order;
    private final OrderStatus oldStatus;
    private final OrderStatus newStatus;
    private final String message;
    
    // æ„é€ å‡½æ•°ã€getteræ–¹æ³•ç­‰
    public static OrderStatusUpdateResult success(Order order, OrderStatus oldStatus, OrderStatus newStatus) {
        return new OrderStatusUpdateResult(true, order, oldStatus, newStatus, "çŠ¶æ€æ›´æ–°æˆåŠŸ");
    }
    
    public static OrderStatusUpdateResult failure(String message) {
        return new OrderStatusUpdateResult(false, null, null, null, message);
    }
}

// è‡ªå®šä¹‰å¼‚å¸¸
public class IllegalStateTransitionException extends RuntimeException {
    public IllegalStateTransitionException(String message) {
        super(message);
    }
}

public class OrderStatusUpdateException extends RuntimeException {
    public OrderStatusUpdateException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

##### 4.5.1.2 çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çŠ¶æ€çš„ä¸€è‡´æ€§ä¿è¯ã€‚
b. å¹¶å‘æ“ä½œæ—¶çŠ¶æ€æ›´æ–°çš„åŸå­æ€§ã€‚
c. çŠ¶æ€ä¸ç›¸å…³ä¸šåŠ¡æ•°æ®çš„ä¸€è‡´æ€§ã€‚
d. çŠ¶æ€æ¢å¤æœºåˆ¶çš„å®Œæ•´æ€§ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. å¹¶å‘æµ‹è¯•ï¼ˆéªŒè¯å¹¶å‘çŠ¶æ€æ›´æ–°çš„æ­£ç¡®æ€§ï¼‰ã€‚
2. åˆ†å¸ƒå¼ä¸€è‡´æ€§æµ‹è¯•ï¼ˆéªŒè¯è·¨æœåŠ¡çŠ¶æ€åŒæ­¥ï¼‰ã€‚
3. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆéªŒè¯çŠ¶æ€ä¸ä¸šåŠ¡æ•°æ®çš„ä¸€è‡´æ€§ï¼‰ã€‚
4. æ•…éšœæ¢å¤æµ‹è¯•ï¼ˆéªŒè¯å¼‚å¸¸æƒ…å†µä¸‹çš„çŠ¶æ€æ¢å¤ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰å¹¶å‘æ§åˆ¶çš„çŠ¶æ€æ›´æ–°
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    
    public void processPayment(Long orderId) {
        // æ²¡æœ‰é”æœºåˆ¶ï¼Œå¯èƒ½å¯¼è‡´å¹¶å‘é—®é¢˜
        Order order = orderRepository.findById(orderId).get();
        
        if (order.getStatus() == OrderStatus.CREATED) {
            // åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶æ‰§è¡Œè¿™é‡Œ
            order.setStatus(OrderStatus.PAID);
            orderRepository.save(order);
            
            // å¯èƒ½å¯¼è‡´é‡å¤å¤„ç†
            paymentService.processPayment(order);
        }
    }
    
    // âŒ é”™è¯¯ï¼šçŠ¶æ€ä¸ä¸šåŠ¡æ•°æ®ä¸ä¸€è‡´
    public void shipOrder(Long orderId) {
        Order order = orderRepository.findById(orderId).get();
        order.setStatus(OrderStatus.SHIPPED);
        orderRepository.save(order);
        
        // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œè®¢å•çŠ¶æ€å·²æ›´æ–°ä½†åº“å­˜æ²¡æœ‰æ‰£å‡
        inventoryService.reduceStock(order.getItems());
    }
}

// âŒ é”™è¯¯ï¼šåˆ†å¸ƒå¼çŠ¶æ€ä¸ä¸€è‡´
@Service
public class DistributedOrderService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    public void processOrder(Order order) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        order.setStatus(OrderStatus.PROCESSING);
        orderRepository.save(order);
        
        // è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œä½†æ²¡æœ‰åˆ†å¸ƒå¼äº‹åŠ¡ä¿è¯
        paymentServiceClient.createPayment(order);
        inventoryServiceClient.reserveItems(order.getItems());
        
        // å¦‚æœè¿œç¨‹è°ƒç”¨å¤±è´¥ï¼Œæœ¬åœ°çŠ¶æ€å·²ç»æ›´æ–°ï¼Œå¯¼è‡´ä¸ä¸€è‡´
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¹è§‚é”ä¿è¯å¹¶å‘å®‰å…¨
@Entity
public class Order {
    @Id
    private Long id;
    
    @Enumerated(EnumType.STRING)
    private OrderStatus status;
    
    @Version
    private Long version; // ä¹è§‚é”ç‰ˆæœ¬å·
    
    private LocalDateTime lastUpdated;
    
    // å…¶ä»–å­—æ®µå’Œæ–¹æ³•
}

@Service
public class OrderService {
    private static final Logger logger = LoggerFactory.getLogger(OrderService.class);
    
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private PaymentService paymentService;
    
    @Transactional
    @Retryable(value = {OptimisticLockingFailureException.class}, maxAttempts = 3)
    public void processPayment(Long orderId) {
        try {
            // ä½¿ç”¨æ‚²è§‚é”é˜²æ­¢å¹¶å‘ä¿®æ”¹
            Order order = orderRepository.findByIdForUpdate(orderId)
                .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
            
            if (order.getStatus() != OrderStatus.CREATED) {
                logger.warn("è®¢å•çŠ¶æ€ä¸æ­£ç¡®ï¼Œæ— æ³•å¤„ç†æ”¯ä»˜: orderId={}, currentStatus={}", 
                    orderId, order.getStatus());
                return;
            }
            
            // åŸå­æ€§æ›´æ–°çŠ¶æ€å’Œå¤„ç†æ”¯ä»˜
            order.setStatus(OrderStatus.PAID);
            order.setLastUpdated(LocalDateTime.now());
            orderRepository.save(order);
            
            // åœ¨åŒä¸€äº‹åŠ¡ä¸­å¤„ç†æ”¯ä»˜
            paymentService.processPayment(order);
            
            logger.info("è®¢å•æ”¯ä»˜å¤„ç†æˆåŠŸ: orderId={}", orderId);
            
        } catch (OptimisticLockingFailureException e) {
            logger.warn("è®¢å•å¹¶å‘æ›´æ–°å†²çªï¼Œé‡è¯•ä¸­: orderId={}", orderId);
            throw e; // è§¦å‘é‡è¯•
        }
    }
    
    // ä½¿ç”¨åˆ†å¸ƒå¼é”ä¿è¯è·¨å®ä¾‹çš„ä¸€è‡´æ€§
    @Transactional
    public void shipOrder(Long orderId) {
        String lockKey = "order:ship:" + orderId;
        
        try (DistributedLock lock = distributedLockService.acquireLock(lockKey, 30, TimeUnit.SECONDS)) {
            if (!lock.isLocked()) {
                throw new LockAcquisitionException("æ— æ³•è·å–è®¢å•é”: " + orderId);
            }
            
            Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
            
            if (order.getStatus() != OrderStatus.PAID) {
                throw new IllegalStateException("åªæœ‰å·²æ”¯ä»˜è®¢å•æ‰èƒ½å‘è´§");
            }
            
            // åœ¨äº‹åŠ¡ä¸­åŒæ—¶æ›´æ–°çŠ¶æ€å’Œæ‰£å‡åº“å­˜
            order.setStatus(OrderStatus.SHIPPED);
            order.setShippedAt(LocalDateTime.now());
            orderRepository.save(order);
            
            // æ‰£å‡åº“å­˜
            inventoryService.reduceStock(order.getItems());
            
            // ç”Ÿæˆç‰©æµä¿¡æ¯
            shippingService.createShipment(order);
            
            logger.info("è®¢å•å‘è´§æˆåŠŸ: orderId={}", orderId);
            
        } catch (Exception e) {
            logger.error("è®¢å•å‘è´§å¤±è´¥: orderId={}", orderId, e);
            throw new OrderShipmentException("è®¢å•å‘è´§å¤±è´¥", e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šåˆ†å¸ƒå¼çŠ¶æ€ä¸€è‡´æ€§ä¿è¯
@Service
public class DistributedOrderService {
    private static final Logger logger = LoggerFactory.getLogger(DistributedOrderService.class);
    
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private SagaManager sagaManager;
    @Autowired
    private EventPublisher eventPublisher;
    
    // ä½¿ç”¨Sagaæ¨¡å¼ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§
    @Transactional
    public void processOrder(Order order) {
        try {
            // 1. åˆ›å»ºSagaäº‹åŠ¡
            SagaTransaction saga = sagaManager.beginSaga("process-order-" + order.getId());
            
            // 2. æ›´æ–°æœ¬åœ°çŠ¶æ€
            order.setStatus(OrderStatus.PROCESSING);
            order.setSagaId(saga.getId());
            orderRepository.save(order);
            
            // 3. æ·»åŠ è¡¥å¿æ“ä½œ
            saga.addCompensation(() -> {
                order.setStatus(OrderStatus.CREATED);
                order.setSagaId(null);
                orderRepository.save(order);
            });
            
            // 4. æ‰§è¡Œåˆ†å¸ƒå¼æ“ä½œ
            saga.addStep("create-payment", 
                () -> paymentServiceClient.createPayment(order),
                () -> paymentServiceClient.cancelPayment(order.getId()));
                
            saga.addStep("reserve-inventory",
                () -> inventoryServiceClient.reserveItems(order.getItems()),
                () -> inventoryServiceClient.releaseItems(order.getItems()));
            
            // 5. æ‰§è¡ŒSaga
            SagaResult result = saga.execute();
            
            if (result.isSuccess()) {
                order.setStatus(OrderStatus.CONFIRMED);
                orderRepository.save(order);
                
                // å‘å¸ƒè®¢å•ç¡®è®¤äº‹ä»¶
                eventPublisher.publishEvent(new OrderConfirmedEvent(order));
                
                logger.info("è®¢å•å¤„ç†æˆåŠŸ: orderId={}", order.getId());
            } else {
                logger.error("è®¢å•å¤„ç†å¤±è´¥ï¼Œå·²å›æ»š: orderId={}, error={}", 
                    order.getId(), result.getError());
                throw new OrderProcessingException("è®¢å•å¤„ç†å¤±è´¥: " + result.getError());
            }
            
        } catch (Exception e) {
            logger.error("è®¢å•å¤„ç†å¼‚å¸¸: orderId={}", order.getId(), e);
            throw new OrderProcessingException("è®¢å•å¤„ç†å¼‚å¸¸", e);
        }
    }
    
    // çŠ¶æ€æ¢å¤æœºåˆ¶
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void recoverInconsistentStates() {
        logger.debug("å¼€å§‹æ£€æŸ¥ä¸ä¸€è‡´çš„è®¢å•çŠ¶æ€");
        
        try {
            // æŸ¥æ‰¾å¤„ç†ä¸­ä½†è¶…æ—¶çš„è®¢å•
            List<Order> timeoutOrders = orderRepository.findProcessingOrdersOlderThan(
                LocalDateTime.now().minusMinutes(30));
            
            for (Order order : timeoutOrders) {
                try {
                    recoverOrderState(order);
                } catch (Exception e) {
                    logger.error("æ¢å¤è®¢å•çŠ¶æ€å¤±è´¥: orderId={}", order.getId(), e);
                }
            }
            
        } catch (Exception e) {
            logger.error("çŠ¶æ€æ¢å¤ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        }
    }
    
    private void recoverOrderState(Order order) {
        logger.info("å¼€å§‹æ¢å¤è®¢å•çŠ¶æ€: orderId={}, currentStatus={}", 
            order.getId(), order.getStatus());
        
        if (order.getSagaId() != null) {
            // æ£€æŸ¥SagaçŠ¶æ€
            SagaTransaction saga = sagaManager.getSaga(order.getSagaId());
            if (saga != null) {
                if (saga.isCompleted()) {
                    // Sagaå·²å®Œæˆï¼Œæ›´æ–°è®¢å•çŠ¶æ€
                    order.setStatus(OrderStatus.CONFIRMED);
                    orderRepository.save(order);
                } else if (saga.isFailed()) {
                    // Sagaå¤±è´¥ï¼Œå›æ»šè®¢å•çŠ¶æ€
                    order.setStatus(OrderStatus.CREATED);
                    order.setSagaId(null);
                    orderRepository.save(order);
                }
            } else {
                // Sagaä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿå¼‚å¸¸ï¼Œå›æ»šçŠ¶æ€
                order.setStatus(OrderStatus.CREATED);
                order.setSagaId(null);
                orderRepository.save(order);
            }
        }
    }
}

// åˆ†å¸ƒå¼é”æœåŠ¡
@Service
public class DistributedLockService {
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public DistributedLock acquireLock(String key, long timeout, TimeUnit unit) {
        String lockValue = UUID.randomUUID().toString();
        String lockKey = "lock:" + key;
        
        Boolean acquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, timeout, unit);
        
        if (Boolean.TRUE.equals(acquired)) {
            return new RedisDistributedLock(redisTemplate, lockKey, lockValue, timeout, unit);
        } else {
            return new DistributedLock() {
                @Override
                public boolean isLocked() { return false; }
                @Override
                public void close() {}
            };
        }
    }
}
```

##### 4.5.1.3 çŠ¶æ€æŒä¹…åŒ–æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. çŠ¶æ€å˜æ›´çš„æŒä¹…åŒ–æœºåˆ¶å®Œæ•´å¯é ã€‚
b. çŠ¶æ€å†å²è®°å½•çš„å®Œæ•´æ€§å’Œå¯è¿½æº¯æ€§ã€‚
c. çŠ¶æ€æ¢å¤æœºåˆ¶çš„æœ‰æ•ˆæ€§ã€‚
d. çŠ¶æ€æ•°æ®çš„å¤‡ä»½å’Œå½’æ¡£ç­–ç•¥ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æŒä¹…åŒ–æµ‹è¯•ï¼ˆéªŒè¯çŠ¶æ€å˜æ›´çš„æŒä¹…åŒ–ï¼‰ã€‚
2. å†å²è®°å½•å®¡æŸ¥ï¼ˆæ£€æŸ¥çŠ¶æ€å˜æ›´å†å²çš„å®Œæ•´æ€§ï¼‰ã€‚
3. æ¢å¤æµ‹è¯•ï¼ˆéªŒè¯çŠ¶æ€æ¢å¤æœºåˆ¶ï¼‰ã€‚
4. å¤‡ä»½ç­–ç•¥éªŒè¯ï¼ˆç¡®è®¤çŠ¶æ€æ•°æ®çš„å¤‡ä»½å®Œæ•´æ€§ï¼‰ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šçŠ¶æ€å˜æ›´æ²¡æœ‰æŒä¹…åŒ–å†å²
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    
    public void updateOrderStatus(Order order, OrderStatus newStatus) {
        // ç›´æ¥æ›´æ–°çŠ¶æ€ï¼Œæ²¡æœ‰è®°å½•å˜æ›´å†å²
        order.setStatus(newStatus);
        orderRepository.save(order);
        // æ— æ³•è¿½æº¯çŠ¶æ€å˜æ›´å†å²
    }
    
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰çŠ¶æ€æ¢å¤æœºåˆ¶
    public void processOrder(Order order) {
        try {
            order.setStatus(OrderStatus.PROCESSING);
            // å¦‚æœè¿™é‡Œå‘ç”Ÿå¼‚å¸¸ï¼ŒçŠ¶æ€å¯èƒ½å¤„äºä¸ä¸€è‡´çŠ¶æ€
            complexBusinessLogic(order);
            order.setStatus(OrderStatus.COMPLETED);
        } catch (Exception e) {
            // æ²¡æœ‰çŠ¶æ€æ¢å¤é€»è¾‘
            throw e;
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„çŠ¶æ€æŒä¹…åŒ–æœºåˆ¶
@Entity
public class OrderStatusHistory {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private Long orderId;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private OrderStatus fromStatus;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private OrderStatus toStatus;
    
    @Column(nullable = false)
    private LocalDateTime changedAt;
    
    @Column(nullable = false)
    private String changedBy;
    
    @Column(length = 500)
    private String reason;
    
    @Column(length = 1000)
    private String additionalInfo;
    
    // æ„é€ å‡½æ•°ã€getterã€setter
}

@Service
public class OrderStatusService {
    private static final Logger logger = LoggerFactory.getLogger(OrderStatusService.class);
    
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private OrderStatusHistoryRepository historyRepository;
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @Transactional
    public void updateOrderStatus(Order order, OrderStatus newStatus, String reason, String operator) {
        OrderStatus oldStatus = order.getStatus();
        
        if (oldStatus == newStatus) {
            logger.debug("è®¢å•çŠ¶æ€æœªå‘ç”Ÿå˜åŒ–: orderId={}, status={}", order.getId(), oldStatus);
            return;
        }
        
        try {
            // 1. æ›´æ–°è®¢å•çŠ¶æ€
            order.setStatus(newStatus);
            order.setLastUpdated(LocalDateTime.now());
            Order savedOrder = orderRepository.save(order);
            
            // 2. è®°å½•çŠ¶æ€å˜æ›´å†å²
            OrderStatusHistory history = OrderStatusHistory.builder()
                .orderId(order.getId())
                .fromStatus(oldStatus)
                .toStatus(newStatus)
                .changedAt(LocalDateTime.now())
                .changedBy(operator)
                .reason(reason)
                .additionalInfo(buildAdditionalInfo(order, oldStatus, newStatus))
                .build();
            
            historyRepository.save(history);
            
            // 3. å‘å¸ƒçŠ¶æ€å˜æ›´äº‹ä»¶
            OrderStatusChangedEvent event = new OrderStatusChangedEvent(
                order.getId(), oldStatus, newStatus, operator, reason);
            eventPublisher.publishEvent(event);
            
            logger.info("è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ: orderId={}, {} -> {}, operator={}, reason={}", 
                order.getId(), oldStatus, newStatus, operator, reason);
                
        } catch (Exception e) {
            logger.error("è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥: orderId={}, {} -> {}", 
                order.getId(), oldStatus, newStatus, e);
            throw new OrderStatusUpdateException("çŠ¶æ€æ›´æ–°å¤±è´¥", e);
        }
    }
    
    // è·å–è®¢å•çŠ¶æ€å˜æ›´å†å²
    public List<OrderStatusHistory> getOrderStatusHistory(Long orderId) {
        return historyRepository.findByOrderIdOrderByChangedAtDesc(orderId);
    }
    
    // çŠ¶æ€å›æ»šåŠŸèƒ½
    @Transactional
    public void rollbackOrderStatus(Long orderId, Long historyId, String reason, String operator) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
        
        OrderStatusHistory targetHistory = historyRepository.findById(historyId)
            .orElseThrow(() -> new HistoryNotFoundException("å†å²è®°å½•ä¸å­˜åœ¨: " + historyId));
        
        if (!targetHistory.getOrderId().equals(orderId)) {
            throw new IllegalArgumentException("å†å²è®°å½•ä¸è®¢å•ä¸åŒ¹é…");
        }
        
        // å›æ»šåˆ°æŒ‡å®šå†å²çŠ¶æ€
        OrderStatus rollbackStatus = targetHistory.getFromStatus();
        String rollbackReason = String.format("å›æ»šåˆ°å†å²çŠ¶æ€ï¼ŒåŸå› : %s", reason);
        
        updateOrderStatus(order, rollbackStatus, rollbackReason, operator);
        
        logger.info("è®¢å•çŠ¶æ€å›æ»šæˆåŠŸ: orderId={}, rollbackTo={}, historyId={}", 
            orderId, rollbackStatus, historyId);
    }
    
    // çŠ¶æ€æ¢å¤æœºåˆ¶
    @Transactional
    public void recoverOrderStatus(Long orderId) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨: " + orderId));
        
        // è·å–æœ€è¿‘çš„çŠ¶æ€å˜æ›´å†å²
        List<OrderStatusHistory> histories = historyRepository
            .findByOrderIdOrderByChangedAtDesc(orderId);
        
        if (histories.isEmpty()) {
            logger.warn("è®¢å•æ²¡æœ‰çŠ¶æ€å˜æ›´å†å²: orderId={}", orderId);
            return;
        }
        
        OrderStatusHistory lastHistory = histories.get(0);
        OrderStatus expectedStatus = lastHistory.getToStatus();
        OrderStatus currentStatus = order.getStatus();
        
        if (currentStatus != expectedStatus) {
            logger.warn("å‘ç°çŠ¶æ€ä¸ä¸€è‡´ï¼Œå¼€å§‹æ¢å¤: orderId={}, current={}, expected={}", 
                orderId, currentStatus, expectedStatus);
            
            // æ¢å¤åˆ°æœŸæœ›çŠ¶æ€
            order.setStatus(expectedStatus);
            orderRepository.save(order);
            
            // è®°å½•æ¢å¤æ“ä½œ
            OrderStatusHistory recoveryHistory = OrderStatusHistory.builder()
                .orderId(orderId)
                .fromStatus(currentStatus)
                .toStatus(expectedStatus)
                .changedAt(LocalDateTime.now())
                .changedBy("SYSTEM_RECOVERY")
                .reason("ç³»ç»Ÿè‡ªåŠ¨æ¢å¤çŠ¶æ€ä¸ä¸€è‡´")
                .additionalInfo("ä» " + currentStatus + " æ¢å¤åˆ° " + expectedStatus)
                .build();
            
            historyRepository.save(recoveryHistory);
            
            logger.info("è®¢å•çŠ¶æ€æ¢å¤å®Œæˆ: orderId={}, {} -> {}", 
                orderId, currentStatus, expectedStatus);
        }
    }
    
    // çŠ¶æ€æ•°æ®å¤‡ä»½
    @Scheduled(cron = "0 0 1 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
    public void backupStatusData() {
        logger.info("å¼€å§‹å¤‡ä»½è®¢å•çŠ¶æ€æ•°æ®");
        
        try {
            LocalDateTime cutoffTime = LocalDateTime.now().minusDays(30);
            
            // å¤‡ä»½30å¤©å‰çš„çŠ¶æ€å†å²æ•°æ®
            List<OrderStatusHistory> oldHistories = historyRepository
                .findByChangedAtBefore(cutoffTime);
            
            if (!oldHistories.isEmpty()) {
                // å¯¼å‡ºåˆ°å¤‡ä»½æ–‡ä»¶
                String backupFileName = String.format("order_status_backup_%s.json", 
                    LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd")));
                
                exportStatusHistoryToFile(oldHistories, backupFileName);
                
                // ä¸Šä¼ åˆ°äº‘å­˜å‚¨
                uploadBackupToCloud(backupFileName);
                
                // åˆ é™¤å·²å¤‡ä»½çš„æ•°æ®ï¼ˆå¯é€‰ï¼‰
                if (shouldDeleteAfterBackup()) {
                    historyRepository.deleteAll(oldHistories);
                    logger.info("å·²åˆ é™¤å¤‡ä»½çš„å†å²æ•°æ®: count={}", oldHistories.size());
                }
                
                logger.info("çŠ¶æ€æ•°æ®å¤‡ä»½å®Œæˆ: file={}, count={}", 
                    backupFileName, oldHistories.size());
            }
            
        } catch (Exception e) {
            logger.error("çŠ¶æ€æ•°æ®å¤‡ä»½å¤±è´¥", e);
        }
    }
    
    private String buildAdditionalInfo(Order order, OrderStatus oldStatus, OrderStatus newStatus) {
        Map<String, Object> info = new HashMap<>();
        info.put("orderId", order.getId());
        info.put("orderAmount", order.getTotalAmount());
        info.put("customerId", order.getCustomerId());
        info.put("transitionTime", LocalDateTime.now());
        info.put("systemVersion", getSystemVersion());
        
        try {
            return objectMapper.writeValueAsString(info);
        } catch (Exception e) {
            logger.warn("æ„å»ºé™„åŠ ä¿¡æ¯å¤±è´¥", e);
            return "{}";
        }
    }
}
```

### 4.6 ä¸šåŠ¡æ­£ç¡®æ€§æ£€æŸ¥

**ç¬¬äºŒåå…­æ¡** è¾“å…¥è¾¹ç•Œæ¡ä»¶æ£€æŸ¥ ğŸ”´ï¼š

##### 4.6.1 è¾“å…¥å‚æ•°éªŒè¯æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ‰€æœ‰å‡½æ•°çš„è¾“å…¥å‚æ•°éƒ½æœ‰å®Œæ•´çš„éªŒè¯é€»è¾‘
b. è¾¹ç•Œå€¼ï¼ˆæœ€å°å€¼ã€æœ€å¤§å€¼ã€ç©ºå€¼ç­‰ï¼‰å¤„ç†æœºåˆ¶æ˜ç¡®
c. è¾“å…¥éªŒè¯åœ¨å‡½æ•°å…¥å£å¤„è¿›è¡Œï¼Œé¿å…å¼‚å¸¸ä¼ æ’­
d. ç‰¹æ®Šè¾“å…¥ï¼ˆ0ã€è´Ÿæ•°ã€ç‰¹æ®Šå­—ç¬¦ç­‰ï¼‰éƒ½æœ‰å¯¹åº”å¤„ç†é€»è¾‘

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ¯ä¸ªå…¬å…±æ–¹æ³•çš„å‚æ•°éªŒè¯é€»è¾‘
b. å•å…ƒæµ‹è¯•ï¼šç¼–å†™è¾¹ç•Œå€¼å’Œå¼‚å¸¸è¾“å…¥çš„æµ‹è¯•ç”¨ä¾‹
c. é™æ€åˆ†æï¼šä½¿ç”¨å·¥å…·æ£€æŸ¥ç©ºæŒ‡é’ˆå’Œè¾¹ç•Œæ£€æŸ¥
d. é›†æˆæµ‹è¯•ï¼šéªŒè¯å‚æ•°éªŒè¯åœ¨å®Œæ•´æµç¨‹ä¸­çš„æœ‰æ•ˆæ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘è¾“å…¥å‚æ•°éªŒè¯
@Service
public class UserService {
    public User createUser(String username, String email, int age) {
        // æ²¡æœ‰éªŒè¯å‚æ•°çš„æœ‰æ•ˆæ€§
        User user = new User();
        user.setUsername(username); // usernameå¯èƒ½ä¸ºnullæˆ–ç©º
        user.setEmail(email); // emailå¯èƒ½æ ¼å¼ä¸æ­£ç¡®
        user.setAge(age); // ageå¯èƒ½ä¸ºè´Ÿæ•°
        return userRepository.save(user);
    }
    
    public List<User> getUsersByAge(int minAge, int maxAge) {
        // æ²¡æœ‰éªŒè¯å¹´é¾„èŒƒå›´çš„åˆç†æ€§
        return userRepository.findByAgeBetween(minAge, maxAge);
    }
}

// âŒ é”™è¯¯ï¼šè¾¹ç•Œæ¡ä»¶å¤„ç†ä¸å½“
public class MathUtils {
    public static double calculatePercentage(int part, int total) {
        // æ²¡æœ‰æ£€æŸ¥é™¤æ•°ä¸º0çš„æƒ…å†µ
        return (double) part / total * 100;
    }
    
    public static String substring(String str, int start, int length) {
        // æ²¡æœ‰æ£€æŸ¥å­—ç¬¦ä¸²å’Œç´¢å¼•çš„æœ‰æ•ˆæ€§
        return str.substring(start, start + length);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„è¾“å…¥å‚æ•°éªŒè¯
@Service
public class UserService {
    private static final int MIN_AGE = 0;
    private static final int MAX_AGE = 150;
    private static final int MAX_USERNAME_LENGTH = 50;
    
    public User createUser(String username, String email, int age) {
        // å‚æ•°éªŒè¯
        validateUsername(username);
        validateEmail(email);
        validateAge(age);
        
        User user = new User();
        user.setUsername(username.trim());
        user.setEmail(email.toLowerCase().trim());
        user.setAge(age);
        
        return userRepository.save(user);
    }
    
    public List<User> getUsersByAge(int minAge, int maxAge) {
        // éªŒè¯å¹´é¾„èŒƒå›´
        if (minAge < MIN_AGE || maxAge > MAX_AGE) {
            throw new IllegalArgumentException(
                String.format("å¹´é¾„èŒƒå›´æ— æ•ˆ: [%d, %d], æœ‰æ•ˆèŒƒå›´: [%d, %d]", 
                    minAge, maxAge, MIN_AGE, MAX_AGE));
        }
        
        if (minAge > maxAge) {
            throw new IllegalArgumentException(
                String.format("æœ€å°å¹´é¾„(%d)ä¸èƒ½å¤§äºæœ€å¤§å¹´é¾„(%d)", minAge, maxAge));
        }
        
        return userRepository.findByAgeBetween(minAge, maxAge);
    }
    
    private void validateUsername(String username) {
        if (StringUtils.isBlank(username)) {
            throw new IllegalArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
        
        if (username.length() > MAX_USERNAME_LENGTH) {
            throw new IllegalArgumentException(
                String.format("ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡%dä¸ªå­—ç¬¦", MAX_USERNAME_LENGTH));
        }
        
        if (!username.matches("^[a-zA-Z0-9_]+$")) {
            throw new IllegalArgumentException("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿");
        }
    }
    
    private void validateEmail(String email) {
        if (StringUtils.isBlank(email)) {
            throw new IllegalArgumentException("é‚®ç®±ä¸èƒ½ä¸ºç©º");
        }
        
        if (!EmailValidator.getInstance().isValid(email)) {
            throw new IllegalArgumentException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®: " + email);
        }
    }
    
    private void validateAge(int age) {
        if (age < MIN_AGE || age > MAX_AGE) {
            throw new IllegalArgumentException(
                String.format("å¹´é¾„å¿…é¡»åœ¨%dåˆ°%dä¹‹é—´", MIN_AGE, MAX_AGE));
        }
    }
}

// âœ… æ­£ç¡®ï¼šå®Œå–„çš„è¾¹ç•Œæ¡ä»¶å¤„ç†
public class MathUtils {
    public static double calculatePercentage(int part, int total) {
        if (total == 0) {
            throw new IllegalArgumentException("æ€»æ•°ä¸èƒ½ä¸º0");
        }
        
        if (part < 0 || total < 0) {
            throw new IllegalArgumentException("éƒ¨åˆ†å’Œæ€»æ•°éƒ½å¿…é¡»ä¸ºéè´Ÿæ•°");
        }
        
        if (part > total) {
            throw new IllegalArgumentException(
                String.format("éƒ¨åˆ†(%d)ä¸èƒ½å¤§äºæ€»æ•°(%d)", part, total));
        }
        
        return (double) part / total * 100;
    }
    
    public static String substring(String str, int start, int length) {
        Objects.requireNonNull(str, "å­—ç¬¦ä¸²ä¸èƒ½ä¸ºnull");
        
        if (start < 0) {
            throw new IllegalArgumentException("èµ·å§‹ä½ç½®ä¸èƒ½ä¸ºè´Ÿæ•°: " + start);
        }
        
        if (length < 0) {
            throw new IllegalArgumentException("é•¿åº¦ä¸èƒ½ä¸ºè´Ÿæ•°: " + length);
        }
        
        if (start >= str.length()) {
            throw new IllegalArgumentException(
                String.format("èµ·å§‹ä½ç½®(%d)è¶…å‡ºå­—ç¬¦ä¸²é•¿åº¦(%d)", start, str.length()));
        }
        
        int endIndex = Math.min(start + length, str.length());
        return str.substring(start, endIndex);
    }
}
```

**ç¬¬äºŒåä¸ƒæ¡** ä¸šåŠ¡è§„åˆ™éªŒè¯æ£€æŸ¥ ğŸ”´ï¼š

##### 4.6.2 ä¸šåŠ¡é€»è¾‘è§„åˆ™æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ä¸šåŠ¡è§„åˆ™åœ¨ä»£ç ä¸­å¾—åˆ°æ­£ç¡®å®ç°
b. å¤æ‚ä¸šåŠ¡é€»è¾‘æœ‰æ¸…æ™°çš„éªŒè¯æœºåˆ¶
c. ä¸šåŠ¡çº¦æŸæ¡ä»¶å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œ
d. ä¸šåŠ¡æµç¨‹çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§å¾—åˆ°ä¿è¯

**2. æ£€æµ‹æ–¹æ³•**

a. éœ€æ±‚å¯¹æ¯”ï¼šå°†ä»£ç å®ç°ä¸ä¸šåŠ¡éœ€æ±‚è¿›è¡Œå¯¹æ¯”
b. ä¸šåŠ¡æµ‹è¯•ï¼šç¼–å†™ä¸šåŠ¡åœºæ™¯æµ‹è¯•ç”¨ä¾‹
c. è§„åˆ™å¼•æ“ï¼šä½¿ç”¨è§„åˆ™å¼•æ“éªŒè¯å¤æ‚ä¸šåŠ¡é€»è¾‘
d. ä¸šåŠ¡ä¸“å®¶è¯„å®¡ï¼šé‚€è¯·ä¸šåŠ¡ä¸“å®¶å‚ä¸ä»£ç è¯„å®¡

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä¸šåŠ¡è§„åˆ™å®ç°ä¸å®Œæ•´
@Service
public class OrderService {
    public Order createOrder(OrderRequest request) {
        // ç¼ºå°‘ä¸šåŠ¡è§„åˆ™éªŒè¯
        Order order = new Order();
        order.setCustomerId(request.getCustomerId());
        order.setItems(request.getItems());
        order.setTotalAmount(calculateTotal(request.getItems()));
        
        // æ²¡æœ‰éªŒè¯ï¼š
        // 1. å®¢æˆ·æ˜¯å¦æœ‰æ•ˆ
        // 2. å•†å“åº“å­˜æ˜¯å¦å……è¶³
        // 3. è®¢å•é‡‘é¢æ˜¯å¦åˆç†
        // 4. å®¢æˆ·ä¿¡ç”¨é¢åº¦æ˜¯å¦è¶³å¤Ÿ
        
        return orderRepository.save(order);
    }
    
    public void processRefund(Long orderId, BigDecimal amount) {
        Order order = orderRepository.findById(orderId).orElseThrow();
        
        // ç¼ºå°‘é€€æ¬¾ä¸šåŠ¡è§„åˆ™éªŒè¯
        order.setStatus(OrderStatus.REFUNDED);
        order.setRefundAmount(amount);
        
        // æ²¡æœ‰éªŒè¯ï¼š
        // 1. è®¢å•æ˜¯å¦å¯ä»¥é€€æ¬¾
        // 2. é€€æ¬¾é‡‘é¢æ˜¯å¦åˆç†
        // 3. é€€æ¬¾æ—¶é—´é™åˆ¶
        
        orderRepository.save(order);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
@Service
public class OrderService {
    private static final BigDecimal MAX_ORDER_AMOUNT = new BigDecimal("100000");
    private static final int MAX_REFUND_DAYS = 30;
    
    @Autowired
    private CustomerService customerService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private CreditService creditService;
    
    @Transactional
    public Order createOrder(OrderRequest request) {
        // 1. éªŒè¯å®¢æˆ·æœ‰æ•ˆæ€§
        Customer customer = customerService.getActiveCustomer(request.getCustomerId());
        if (customer == null) {
            throw new BusinessException("å®¢æˆ·ä¸å­˜åœ¨æˆ–å·²åœç”¨: " + request.getCustomerId());
        }
        
        // 2. éªŒè¯å•†å“å’Œåº“å­˜
        validateOrderItems(request.getItems());
        
        // 3. è®¡ç®—è®¢å•é‡‘é¢
        BigDecimal totalAmount = calculateTotal(request.getItems());
        validateOrderAmount(totalAmount);
        
        // 4. éªŒè¯å®¢æˆ·ä¿¡ç”¨é¢åº¦
        if (!creditService.checkCreditLimit(customer.getId(), totalAmount)) {
            throw new BusinessException("å®¢æˆ·ä¿¡ç”¨é¢åº¦ä¸è¶³");
        }
        
        // 5. é¢„æ‰£åº“å­˜
        reserveInventory(request.getItems());
        
        try {
            // 6. åˆ›å»ºè®¢å•
            Order order = new Order();
            order.setCustomerId(request.getCustomerId());
            order.setItems(request.getItems());
            order.setTotalAmount(totalAmount);
            order.setStatus(OrderStatus.PENDING);
            order.setCreatedAt(LocalDateTime.now());
            
            Order savedOrder = orderRepository.save(order);
            
            // 7. è®°å½•ä¸šåŠ¡æ—¥å¿—
            logOrderCreation(savedOrder, customer);
            
            return savedOrder;
            
        } catch (Exception e) {
            // å›æ»šåº“å­˜é¢„æ‰£
            releaseInventory(request.getItems());
            throw new BusinessException("è®¢å•åˆ›å»ºå¤±è´¥", e);
        }
    }
    
    @Transactional
    public void processRefund(Long orderId, BigDecimal amount, String reason) {
        // 1. è·å–è®¢å•ä¿¡æ¯
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new BusinessException("è®¢å•ä¸å­˜åœ¨: " + orderId));
        
        // 2. éªŒè¯é€€æ¬¾ä¸šåŠ¡è§„åˆ™
        validateRefundEligibility(order);
        validateRefundAmount(order, amount);
        validateRefundTimeLimit(order);
        
        // 3. æ£€æŸ¥é‡å¤é€€æ¬¾
        if (order.getStatus() == OrderStatus.REFUNDED) {
            throw new BusinessException("è®¢å•å·²ç»é€€æ¬¾ï¼Œä¸èƒ½é‡å¤æ“ä½œ");
        }
        
        // 4. æ‰§è¡Œé€€æ¬¾é€»è¾‘
        try {
            // æ›´æ–°è®¢å•çŠ¶æ€
            order.setStatus(OrderStatus.REFUNDED);
            order.setRefundAmount(amount);
            order.setRefundReason(reason);
            order.setRefundAt(LocalDateTime.now());
            
            orderRepository.save(order);
            
            // æ¢å¤åº“å­˜
            restoreInventory(order.getItems());
            
            // æ¢å¤ä¿¡ç”¨é¢åº¦
            creditService.restoreCreditLimit(order.getCustomerId(), amount);
            
            // è®°å½•é€€æ¬¾æ—¥å¿—
            logRefundProcess(order, amount, reason);
            
        } catch (Exception e) {
            throw new BusinessException("é€€æ¬¾å¤„ç†å¤±è´¥", e);
        }
    }
    
    private void validateOrderItems(List<OrderItem> items) {
        if (items == null || items.isEmpty()) {
            throw new BusinessException("è®¢å•é¡¹ä¸èƒ½ä¸ºç©º");
        }
        
        for (OrderItem item : items) {
            // éªŒè¯å•†å“å­˜åœ¨æ€§
            if (!inventoryService.productExists(item.getProductId())) {
                throw new BusinessException("å•†å“ä¸å­˜åœ¨: " + item.getProductId());
            }
            
            // éªŒè¯åº“å­˜å……è¶³æ€§
            if (!inventoryService.hasEnoughStock(item.getProductId(), item.getQuantity())) {
                throw new BusinessException(
                    String.format("å•†å“åº“å­˜ä¸è¶³: productId=%s, required=%d", 
                        item.getProductId(), item.getQuantity()));
            }
            
            // éªŒè¯å•†å“çŠ¶æ€
            if (!inventoryService.isProductActive(item.getProductId())) {
                throw new BusinessException("å•†å“å·²ä¸‹æ¶: " + item.getProductId());
            }
        }
    }
    
    private void validateOrderAmount(BigDecimal amount) {
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new BusinessException("è®¢å•é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        if (amount.compareTo(MAX_ORDER_AMOUNT) > 0) {
            throw new BusinessException(
                String.format("è®¢å•é‡‘é¢ä¸èƒ½è¶…è¿‡%s", MAX_ORDER_AMOUNT));
        }
    }
    
    private void validateRefundEligibility(Order order) {
        if (order.getStatus() != OrderStatus.COMPLETED && 
            order.getStatus() != OrderStatus.DELIVERED) {
            throw new BusinessException(
                String.format("è®¢å•çŠ¶æ€ä¸º%sï¼Œä¸å…è®¸é€€æ¬¾", order.getStatus()));
        }
    }
    
    private void validateRefundAmount(Order order, BigDecimal refundAmount) {
        if (refundAmount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new BusinessException("é€€æ¬¾é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        if (refundAmount.compareTo(order.getTotalAmount()) > 0) {
            throw new BusinessException(
                String.format("é€€æ¬¾é‡‘é¢(%s)ä¸èƒ½è¶…è¿‡è®¢å•é‡‘é¢(%s)", 
                    refundAmount, order.getTotalAmount()));
        }
    }
    
    private void validateRefundTimeLimit(Order order) {
        LocalDateTime orderTime = order.getCreatedAt();
        LocalDateTime now = LocalDateTime.now();
        long daysBetween = ChronoUnit.DAYS.between(orderTime, now);
        
        if (daysBetween > MAX_REFUND_DAYS) {
            throw new BusinessException(
                String.format("è®¢å•åˆ›å»ºæ—¶é—´è¶…è¿‡%då¤©ï¼Œä¸å…è®¸é€€æ¬¾", MAX_REFUND_DAYS));
        }
    }
}
```

**ç¬¬äºŒåå…«æ¡** æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ ğŸ”´ï¼š

##### 4.6.3 ä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å…³è”æ•°æ®åœ¨ä¸šåŠ¡æ“ä½œä¸­ä¿æŒä¸€è‡´æ€§
b. æ•°æ®çŠ¶æ€å˜æ›´éµå¾ªä¸šåŠ¡è§„åˆ™
c. å¹¶å‘æ“ä½œä¸ä¼šç ´åæ•°æ®ä¸€è‡´æ€§
d. åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ•°æ®æœ€ç»ˆä¸€è‡´æ€§å¾—åˆ°ä¿è¯

**2. æ£€æµ‹æ–¹æ³•**

a. äº‹åŠ¡æµ‹è¯•ï¼šéªŒè¯äº‹åŠ¡è¾¹ç•Œå’Œå›æ»šæœºåˆ¶
b. å¹¶å‘æµ‹è¯•ï¼šæ¨¡æ‹Ÿå¹¶å‘æ“ä½œéªŒè¯æ•°æ®ä¸€è‡´æ€§
c. æ•°æ®æ ¡éªŒï¼šå®šæœŸæ£€æŸ¥æ•°æ®å®Œæ•´æ€§
d. åˆ†å¸ƒå¼æµ‹è¯•ï¼šéªŒè¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ•°æ®ä¸€è‡´æ€§å¤„ç†ä¸å½“
@Service
public class AccountService {
    public void transfer(Long fromAccountId, Long toAccountId, BigDecimal amount) {
        Account fromAccount = accountRepository.findById(fromAccountId).orElseThrow();
        Account toAccount = accountRepository.findById(toAccountId).orElseThrow();
        
        // æ²¡æœ‰äº‹åŠ¡ä¿æŠ¤ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
        fromAccount.setBalance(fromAccount.getBalance().subtract(amount));
        accountRepository.save(fromAccount);
        
        // å¦‚æœè¿™é‡Œå‘ç”Ÿå¼‚å¸¸ï¼ŒfromAccountå·²ç»æ‰£æ¬¾ä½†toAccountæ²¡æœ‰æ”¶åˆ°é’±
        toAccount.setBalance(toAccount.getBalance().add(amount));
        accountRepository.save(toAccount);
        
        // æ²¡æœ‰è®°å½•è½¬è´¦æµæ°´
    }
    
    public void updateUserProfile(Long userId, UserProfile profile) {
        User user = userRepository.findById(userId).orElseThrow();
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œä½†æ²¡æœ‰åŒæ­¥æ›´æ–°ç›¸å…³çš„ç¼“å­˜å’Œç´¢å¼•
        user.setName(profile.getName());
        user.setEmail(profile.getEmail());
        userRepository.save(user);
        
        // ç¼“å­˜å’Œæœç´¢ç´¢å¼•å¯èƒ½ä¸æ•°æ®åº“ä¸ä¸€è‡´
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
@Service
public class AccountService {
    
    @Autowired
    private AccountRepository accountRepository;
    
    @Autowired
    private TransactionLogRepository transactionLogRepository;
    
    @Autowired
    private UserCacheService userCacheService;
    
    @Autowired
    private SearchIndexService searchIndexService;
    
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public TransferResult transfer(Long fromAccountId, Long toAccountId, BigDecimal amount) {
        // 1. å‚æ•°éªŒè¯
        validateTransferParams(fromAccountId, toAccountId, amount);
        
        // 2. åŠ é”è·å–è´¦æˆ·ï¼ˆé˜²æ­¢å¹¶å‘é—®é¢˜ï¼‰
        Account fromAccount = accountRepository.findByIdForUpdate(fromAccountId)
            .orElseThrow(() -> new BusinessException("è½¬å‡ºè´¦æˆ·ä¸å­˜åœ¨"));
        Account toAccount = accountRepository.findByIdForUpdate(toAccountId)
            .orElseThrow(() -> new BusinessException("è½¬å…¥è´¦æˆ·ä¸å­˜åœ¨"));
        
        // 3. ä¸šåŠ¡è§„åˆ™éªŒè¯
        validateTransferBusiness(fromAccount, toAccount, amount);
        
        // 4. æ‰§è¡Œè½¬è´¦æ“ä½œ
        BigDecimal originalFromBalance = fromAccount.getBalance();
        BigDecimal originalToBalance = toAccount.getBalance();
        
        try {
            // æ‰£æ¬¾
            fromAccount.setBalance(originalFromBalance.subtract(amount));
            fromAccount.setLastUpdated(LocalDateTime.now());
            accountRepository.save(fromAccount);
            
            // å…¥è´¦
            toAccount.setBalance(originalToBalance.add(amount));
            toAccount.setLastUpdated(LocalDateTime.now());
            accountRepository.save(toAccount);
            
            // 5. è®°å½•äº¤æ˜“æµæ°´
            TransactionLog log = createTransactionLog(fromAccountId, toAccountId, amount);
            transactionLogRepository.save(log);
            
            // 6. å‘å¸ƒäº‹ä»¶ï¼ˆç”¨äºå¼‚æ­¥å¤„ç†é€šçŸ¥ç­‰ï¼‰
            publishTransferEvent(fromAccountId, toAccountId, amount, log.getId());
            
            return TransferResult.success(log.getId(), 
                fromAccount.getBalance(), toAccount.getBalance());
            
        } catch (Exception e) {
            // äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
            log.error("è½¬è´¦å¤±è´¥: from={}, to={}, amount={}", 
                fromAccountId, toAccountId, amount, e);
            throw new BusinessException("è½¬è´¦æ“ä½œå¤±è´¥", e);
        }
    }
    
    @Transactional
    public void updateUserProfile(Long userId, UserProfile profile) {
        // 1. è·å–ç”¨æˆ·ä¿¡æ¯
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        // 2. è®°å½•å˜æ›´å‰çš„çŠ¶æ€
        String oldName = user.getName();
        String oldEmail = user.getEmail();
        
        try {
            // 3. æ›´æ–°æ•°æ®åº“
            user.setName(profile.getName());
            user.setEmail(profile.getEmail());
            user.setLastUpdated(LocalDateTime.now());
            User savedUser = userRepository.save(user);
            
            // 4. åŒæ­¥æ›´æ–°ç¼“å­˜
            userCacheService.updateUserCache(savedUser);
            
            // 5. åŒæ­¥æ›´æ–°æœç´¢ç´¢å¼•
            searchIndexService.updateUserIndex(savedUser);
            
            // 6. è®°å½•å˜æ›´æ—¥å¿—
            logProfileChange(userId, oldName, oldEmail, profile);
            
        } catch (Exception e) {
            // å¦‚æœç¼“å­˜æˆ–ç´¢å¼•æ›´æ–°å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ä¸å½±å“ä¸»æµç¨‹
            log.error("ç”¨æˆ·èµ„æ–™æ›´æ–°åçš„åŒæ­¥æ“ä½œå¤±è´¥: userId={}", userId, e);
            
            // å¯ä»¥è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥é‡è¯•
            scheduleDataSyncRetry(userId);
            
            throw new BusinessException("ç”¨æˆ·èµ„æ–™æ›´æ–°å¤±è´¥", e);
        }
    }
    
    // æ•°æ®ä¸€è‡´æ€§æ ¡éªŒæ–¹æ³•
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void validateDataConsistency() {
        log.info("å¼€å§‹æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ");
        
        try {
            // 1. æ ¡éªŒè´¦æˆ·ä½™é¢ä¸äº¤æ˜“æµæ°´çš„ä¸€è‡´æ€§
            validateAccountBalanceConsistency();
            
            // 2. æ ¡éªŒç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§
            validateCacheConsistency();
            
            // 3. æ ¡éªŒæœç´¢ç´¢å¼•ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§
            validateSearchIndexConsistency();
            
            log.info("æ•°æ®ä¸€è‡´æ€§æ ¡éªŒå®Œæˆ");
            
        } catch (Exception e) {
            log.error("æ•°æ®ä¸€è‡´æ€§æ ¡éªŒå¤±è´¥", e);
            // å‘é€å‘Šè­¦é€šçŸ¥
            alertService.sendDataInconsistencyAlert(e.getMessage());
        }
    }
    
    private void validateTransferParams(Long fromAccountId, Long toAccountId, BigDecimal amount) {
        Objects.requireNonNull(fromAccountId, "è½¬å‡ºè´¦æˆ·IDä¸èƒ½ä¸ºç©º");
        Objects.requireNonNull(toAccountId, "è½¬å…¥è´¦æˆ·IDä¸èƒ½ä¸ºç©º");
        Objects.requireNonNull(amount, "è½¬è´¦é‡‘é¢ä¸èƒ½ä¸ºç©º");
        
        if (fromAccountId.equals(toAccountId)) {
            throw new BusinessException("ä¸èƒ½å‘è‡ªå·±è½¬è´¦");
        }
        
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new BusinessException("è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0");
        }
    }
    
    private void validateTransferBusiness(Account fromAccount, Account toAccount, BigDecimal amount) {
        // æ£€æŸ¥è´¦æˆ·çŠ¶æ€
        if (!fromAccount.isActive()) {
            throw new BusinessException("è½¬å‡ºè´¦æˆ·å·²è¢«å†»ç»“");
        }
        
        if (!toAccount.isActive()) {
            throw new BusinessException("è½¬å…¥è´¦æˆ·å·²è¢«å†»ç»“");
        }
        
        // æ£€æŸ¥ä½™é¢
        if (fromAccount.getBalance().compareTo(amount) < 0) {
            throw new BusinessException("è´¦æˆ·ä½™é¢ä¸è¶³");
        }
        
        // æ£€æŸ¥è½¬è´¦é™é¢
        if (amount.compareTo(fromAccount.getDailyTransferLimit()) > 0) {
            throw new BusinessException("è¶…è¿‡å•æ—¥è½¬è´¦é™é¢");
        }
    }
    
    private void validateAccountBalanceConsistency() {
        // å®ç°è´¦æˆ·ä½™é¢ä¸äº¤æ˜“æµæ°´çš„ä¸€è‡´æ€§æ ¡éªŒé€»è¾‘
        List<Account> accounts = accountRepository.findAll();
        
        for (Account account : accounts) {
            BigDecimal calculatedBalance = calculateBalanceFromTransactions(account.getId());
            BigDecimal actualBalance = account.getBalance();
            
            if (calculatedBalance.compareTo(actualBalance) != 0) {
                log.error("è´¦æˆ·ä½™é¢ä¸ä¸€è‡´: accountId={}, actual={}, calculated={}", 
                    account.getId(), actualBalance, calculatedBalance);
                
                // è®°å½•ä¸ä¸€è‡´é—®é¢˜
                recordInconsistencyIssue(account.getId(), "BALANCE_MISMATCH", 
                    String.format("å®é™…ä½™é¢: %s, è®¡ç®—ä½™é¢: %s", actualBalance, calculatedBalance));
            }
        }
    }
}
```

```java
// âŒ é”™è¯¯ï¼šå­˜åœ¨é€»è¾‘é”™è¯¯çš„ç®—æ³•
public class SortingUtils {
    // é”™è¯¯çš„å¿«é€Ÿæ’åºå®ç°
    public static void quickSort(int[] arr, int low, int high) {
        if (low < high) {
            int pivot = arr[high];
            int i = low - 1;
            
            for (int j = low; j < high; j++) {
                if (arr[j] <= pivot) {
                    i++;
                    // äº¤æ¢arr[i]å’Œarr[j]
                    int temp = arr[i];
                    arr[i] = arr[j];
                    arr[j] = temp;
                }
            }
            
            // é”™è¯¯ï¼šè¿™é‡Œç¼ºå°‘äº†å°†æ¢è½´æ”¾åˆ°æ­£ç¡®ä½ç½®çš„æ“ä½œ
            
            quickSort(arr, low, i - 1);
            quickSort(arr, i + 1, high);
        }
    }
    
    // é”™è¯¯çš„äºŒåˆ†æŸ¥æ‰¾å®ç°
    public static int binarySearch(int[] arr, int target) {
        int left = 0;
        int right = arr.length - 1;
        
        while (left <= right) {
            int mid = (left + right) / 2; // å¯èƒ½å¯¼è‡´æ•´æ•°æº¢å‡º
            
            if (arr[mid] == target) {
                return mid;
            }
            
            if (arr[mid] < target) {
                left = mid + 1;
            } else {
                right = mid - 1;
            }
        }
        
        return -1;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šé€»è¾‘å®Œå–„çš„ç®—æ³•å®ç°
public class SortingUtils {
    // æ­£ç¡®çš„å¿«é€Ÿæ’åºå®ç°
    public static void quickSort(int[] arr, int low, int high) {
        if (low < high) {
            int pivotIndex = partition(arr, low, high);
            quickSort(arr, low, pivotIndex - 1);
            quickSort(arr, pivotIndex + 1, high);
        }
    }
    
    private static int partition(int[] arr, int low, int high) {
        int pivot = arr[high];
        int i = low - 1;
        
        for (int j = low; j < high; j++) {
            if (arr[j] <= pivot) {
                i++;
                // äº¤æ¢arr[i]å’Œarr[j]
                swap(arr, i, j);
            }
        }
        
        // å°†æ¢è½´æ”¾åˆ°æ­£ç¡®ä½ç½®
        swap(arr, i + 1, high);
        return i + 1;
    }
    
    private static void swap(int[] arr, int i, int j) {
        int temp = arr[i];
        arr[i] = arr[j];
        arr[j] = temp;
    }
    
    // æ­£ç¡®çš„äºŒåˆ†æŸ¥æ‰¾å®ç°
    public static int binarySearch(int[] arr, int target) {
        if (arr == null || arr.length == 0) {
            return -1;
        }
        
        int left = 0;
        int right = arr.length - 1;
        
        while (left <= right) {
            // é˜²æ­¢æ•´æ•°æº¢å‡ºçš„è®¡ç®—æ–¹å¼
            int mid = left + (right - left) / 2;
            
            if (arr[mid] == target) {
                return mid;
            }
            
            if (arr[mid] < target) {
                left = mid + 1;
            } else {
                right = mid - 1;
            }
        }
        
        return -1;
    }
    
    // æ·»åŠ ç®—æ³•æµ‹è¯•æ–¹æ³•
    public static void testQuickSort() {
        int[] arr1 = {5, 3, 8, 4, 2};
        int[] expected = {2, 3, 4, 5, 8};
        quickSort(arr1, 0, arr1.length - 1);
        
        // éªŒè¯ç»“æœ
        for (int i = 0; i < arr1.length; i++) {
            if (arr1[i] != expected[i]) {
                throw new AssertionError("å¿«é€Ÿæ’åºç®—æ³•å®ç°æœ‰è¯¯");
            }
        }
    }
}
```

**ç¬¬äºŒåå…«æ¡** å¹¶å‘æ­£ç¡®æ€§æ£€æŸ¥ ğŸ”´ï¼š

##### 4.6.3 å¹¶å‘å®‰å…¨æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å…±äº«èµ„æºçš„è®¿é—®å¿…é¡»æ­£ç¡®åŒæ­¥
b. é¿å…æ­»é”ã€æ´»é”å’Œçº¿ç¨‹é¥¥é¥¿
c. çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„å’Œæ“ä½œ
d. æ­£ç¡®å¤„ç†çº¿ç¨‹ä¸­æ–­

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šè¯†åˆ«å…±äº«èµ„æºå’ŒåŒæ­¥æœºåˆ¶
b. é™æ€åˆ†æï¼šä½¿ç”¨å¹¶å‘é—®é¢˜æ£€æµ‹å·¥å…·
c. å¹¶å‘æµ‹è¯•ï¼šä½¿ç”¨å¤šçº¿ç¨‹æµ‹è¯•ç”¨ä¾‹
d. å‹åŠ›æµ‹è¯•ï¼šåœ¨é«˜å¹¶å‘ä¸‹éªŒè¯ç³»ç»Ÿç¨³å®šæ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šçº¿ç¨‹ä¸å®‰å…¨çš„å•ä¾‹æ¨¡å¼
public class Singleton {
    private static Singleton instance;
    
    private Singleton() {}
    
    public static Singleton getInstance() {
        if (instance == null) {
            // å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½åˆ›å»ºå¤šä¸ªå®ä¾‹
            instance = new Singleton();
        }
        return instance;
    }
}

// âŒ é”™è¯¯ï¼šå¯èƒ½å¯¼è‡´æ­»é”çš„ä»£ç 
public class DeadlockExample {
    private final Object lock1 = new Object();
    private final Object lock2 = new Object();
    
    public void method1() {
        synchronized (lock1) {
            // æŒæœ‰lock1ï¼Œç­‰å¾…lock2
            synchronized (lock2) {
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
    
    public void method2() {
        synchronized (lock2) {
            // æŒæœ‰lock2ï¼Œç­‰å¾…lock1
            synchronized (lock1) {
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šçº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼
public class Singleton {
    // volatileä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§
    private static volatile Singleton instance;
    
    private Singleton() {}
    
    // åŒé‡æ£€æŸ¥é”å®š
    public static Singleton getInstance() {
        if (instance == null) {
            synchronized (Singleton.class) {
                if (instance == null) {
                    instance = new Singleton();
                }
            }
        }
        return instance;
    }
    
    // æ›´å¥½çš„æ–¹å¼ï¼šä½¿ç”¨é™æ€å†…éƒ¨ç±»
    public static class BetterSingleton {
        private BetterSingleton() {}
        
        // é™æ€å†…éƒ¨ç±»åªåœ¨é¦–æ¬¡è®¿é—®æ—¶åŠ è½½
        private static class Holder {
            private static final BetterSingleton INSTANCE = new BetterSingleton();
        }
        
        public static BetterSingleton getInstance() {
            return Holder.INSTANCE;
        }
    }
}

// âœ… æ­£ç¡®ï¼šé¿å…æ­»é”çš„ä»£ç 
public class SafeConcurrencyExample {
    private final Object lock1 = new Object();
    private final Object lock2 = new Object();
    
    // ä¿æŒé”å®šé¡ºåºä¸€è‡´
    public void method1() {
        synchronized (lock1) {
            synchronized (lock2) {
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
    
    public void method2() {
        synchronized (lock1) {
            synchronized (lock2) {
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
    
    // ä½¿ç”¨å¹¶å‘å·¥å…·ç±»
    private final Lock readLock;
    private final Lock writeLock;
    
    public SafeConcurrencyExample() {
        ReadWriteLock rwLock = new ReentrantReadWriteLock();
        readLock = rwLock.readLock();
        writeLock = rwLock.writeLock();
    }
    
    public void readData() {
        readLock.lock();
        try {
            // è¯»å–æ“ä½œ
        } finally {
            readLock.unlock(); // ç¡®ä¿é”è¢«é‡Šæ”¾
        }
    }
    
    public void writeData() {
        writeLock.lock();
        try {
            // å†™å…¥æ“ä½œ
        } finally {
            writeLock.unlock(); // ç¡®ä¿é”è¢«é‡Šæ”¾
        }
    }
}
```

### 4.7 èµ„æºç®¡ç†æ£€æŸ¥

##### 4.7.1 å†…å­˜èµ„æºç®¡ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. é¿å…å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡º
b. åˆç†ä½¿ç”¨é›†åˆå’Œç¼“å­˜ï¼Œè®¾ç½®å¤§å°é™åˆ¶
c. åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡å’Œä¸´æ—¶å¯¹è±¡
d. æ­£ç¡®å¤„ç†é™æ€å˜é‡å’Œå•ä¾‹å¯¹è±¡
e. é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡

**2. æ£€æµ‹æ–¹æ³•**

a. é™æ€åˆ†æï¼šä½¿ç”¨ SpotBugsã€FindBugs æ£€æµ‹å†…å­˜æ³„æ¼
b. å†…å­˜åˆ†æï¼šä½¿ç”¨ JProfilerã€MAT åˆ†æå†…å­˜ä½¿ç”¨
c. å‹åŠ›æµ‹è¯•ï¼šé•¿æ—¶é—´è¿è¡ŒéªŒè¯å†…å­˜ç¨³å®šæ€§
d. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥é›†åˆä½¿ç”¨å’Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ— é™åˆ¶çš„ç¼“å­˜å¯¼è‡´å†…å­˜æ³„æ¼
public class UserCache {
    private static final Map<String, User> cache = new HashMap<>();
    
    public User getUser(String id) {
        if (!cache.containsKey(id)) {
            User user = userService.findById(id);
            cache.put(id, user); // æ— é™åˆ¶æ·»åŠ ï¼Œå¯èƒ½å¯¼è‡´OOM
        }
        return cache.get(id);
    }
}

// âŒ é”™è¯¯ï¼šé™æ€é›†åˆæŒæœ‰å¯¹è±¡å¼•ç”¨
public class EventManager {
    private static final List<EventListener> listeners = new ArrayList<>();
    
    public static void addListener(EventListener listener) {
        listeners.add(listener); // æ°¸è¿œä¸æ¸…ç†ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æœ‰é™åˆ¶çš„ç¼“å­˜
@Component
public class UserCache {
    private final Cache<String, User> cache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(30, TimeUnit.MINUTES)
        .build();
    
    public User getUser(String id) {
        return cache.get(id, key -> userService.findById(key));
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼
public class EventManager {
    private final Set<WeakReference<EventListener>> listeners = 
        Collections.synchronizedSet(new HashSet<>());
    
    public void addListener(EventListener listener) {
        listeners.add(new WeakReference<>(listener));
        cleanupStaleReferences();
    }
    
    private void cleanupStaleReferences() {
        listeners.removeIf(ref -> ref.get() == null);
    }
}
```

##### 4.7.2 æ–‡ä»¶èµ„æºç®¡ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ä½¿ç”¨ try-with-resources å¤„ç†æ–‡ä»¶èµ„æº
b. ç¡®ä¿æ–‡ä»¶æµã€Readerã€Writer æ­£ç¡®å…³é—­
c. é¿å…æ–‡ä»¶å¥æŸ„æ³„æ¼
d. æ­£ç¡®å¤„ç†æ–‡ä»¶æ“ä½œå¼‚å¸¸

**2. æ£€æµ‹æ–¹æ³•**

a. é™æ€åˆ†æï¼šæ£€æŸ¥èµ„æºæ˜¯å¦æ­£ç¡®å…³é—­
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶ I/O æ“ä½œ
c. è¿è¡Œæ—¶ç›‘æ§ï¼šç›‘æ§æ–‡ä»¶å¥æŸ„æ•°é‡
d. å•å…ƒæµ‹è¯•ï¼šéªŒè¯èµ„æºæ­£ç¡®é‡Šæ”¾

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨ç®¡ç†æ–‡ä»¶èµ„æºï¼Œå®¹æ˜“æ³„æ¼
public class FileProcessor {
    public String readFile(String path) {
        FileInputStream fis = null;
        BufferedReader reader = null;
        try {
            fis = new FileInputStream(path);
            reader = new BufferedReader(new InputStreamReader(fis));
            return reader.readLine();
        } catch (IOException e) {
            throw new RuntimeException(e);
        } finally {
            // âŒ å¤æ‚çš„æ‰‹åŠ¨å…³é—­é€»è¾‘ï¼Œå®¹æ˜“å‡ºé”™
            if (reader != null) {
                try {
                    reader.close();
                } catch (IOException e) {
                    // å¿½ç•¥å¼‚å¸¸
                }
            }
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ try-with-resources è‡ªåŠ¨ç®¡ç†èµ„æº
public class FileProcessor {
    public String readFile(String path) throws IOException {
        try (BufferedReader reader = Files.newBufferedReader(Paths.get(path))) {
            return reader.readLine();
        }
    }
    
    public void writeFile(String path, String content) throws IOException {
        try (BufferedWriter writer = Files.newBufferedWriter(Paths.get(path))) {
            writer.write(content);
        }
    }
    
    // å¤„ç†å¤šä¸ªèµ„æº
    public void copyFile(String source, String target) throws IOException {
        try (InputStream in = Files.newInputStream(Paths.get(source));
             OutputStream out = Files.newOutputStream(Paths.get(target))) {
            in.transferTo(out);
        }
    }
}
```

##### 4.7.3 ç½‘ç»œèµ„æºç®¡ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ­£ç¡®é…ç½®å’Œç®¡ç†è¿æ¥æ± 
b. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
c. åŠæ—¶é‡Šæ”¾ç½‘ç»œè¿æ¥
d. é¿å…è¿æ¥æ³„æ¼å’Œèµ„æºè€—å°½
e. å®ç°é‡è¯•å’Œç†”æ–­æœºåˆ¶

**2. æ£€æµ‹æ–¹æ³•**

a. é…ç½®å®¡æŸ¥ï¼šæ£€æŸ¥è¿æ¥æ± å’Œè¶…æ—¶é…ç½®
b. ç½‘ç»œç›‘æ§ï¼šç›‘æ§è¿æ¥æ•°å’Œå“åº”æ—¶é—´
c. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯é«˜å¹¶å‘ä¸‹çš„ç¨³å®šæ€§
d. æ—¥å¿—åˆ†æï¼šæ£€æŸ¥è¿æ¥å¼‚å¸¸å’Œè¶…æ—¶æ—¥å¿—

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ¯æ¬¡åˆ›å»ºæ–°è¿æ¥ï¼Œæ²¡æœ‰è¿æ¥æ± 
@Service
public class ApiService {
    public String callApi(String url) {
        RestTemplate restTemplate = new RestTemplate(); // æ¯æ¬¡æ–°å»º
        return restTemplate.getForObject(url, String.class);
    }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰è®¾ç½®è¶…æ—¶å’Œå¼‚å¸¸å¤„ç†
public class HttpClient {
    public String get(String url) throws IOException {
        URL urlObj = new URL(url);
        HttpURLConnection conn = (HttpURLConnection) urlObj.openConnection();
        // æ²¡æœ‰è®¾ç½®è¶…æ—¶
        try (InputStream in = conn.getInputStream()) {
            return new String(in.readAllBytes());
        }
        // æ²¡æœ‰å…³é—­è¿æ¥
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šé…ç½®è¿æ¥æ± å’Œè¶…æ—¶
@Configuration
public class HttpClientConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        
        // é…ç½®è¿æ¥æ± 
        PoolingHttpClientConnectionManager connectionManager = 
            new PoolingHttpClientConnectionManager();
        connectionManager.setMaxTotal(100);
        connectionManager.setDefaultMaxPerRoute(20);
        
        CloseableHttpClient httpClient = HttpClients.custom()
            .setConnectionManager(connectionManager)
            .setDefaultRequestConfig(RequestConfig.custom()
                .setConnectTimeout(5000)
                .setSocketTimeout(30000)
                .build())
            .build();
        
        factory.setHttpClient(httpClient);
        return new RestTemplate(factory);
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨è¿æ¥æ± å’Œå¼‚å¸¸å¤„ç†
@Service
public class ApiService {
    @Autowired
    private RestTemplate restTemplate;
    
    @Retryable(value = {ResourceAccessException.class}, maxAttempts = 3)
    public String callApi(String url) {
        try {
            return restTemplate.getForObject(url, String.class);
        } catch (ResourceAccessException e) {
            log.warn("APIè°ƒç”¨å¤±è´¥ï¼Œå°†é‡è¯•: {}", e.getMessage());
            throw e;
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ try-with-resources
public class FileProcessor {
    public String readFile(String path) {
        try (FileInputStream fis = new FileInputStream(path);
             BufferedReader reader = new BufferedReader(new InputStreamReader(fis))) {
            return reader.readLine();
        } catch (IOException e) {
            throw new RuntimeException("Failed to read file: " + path, e);
        }
    }
    
    // âœ… æ­£ç¡®ï¼šè‡ªå®šä¹‰èµ„æºå®ç° AutoCloseable
    public static class CustomResource implements AutoCloseable {
        private boolean closed = false;
        
        public void doSomething() {
            if (closed) {
                throw new IllegalStateException("Resource is closed");
            }
            // ä¸šåŠ¡é€»è¾‘
        }
        
        @Override
        public void close() {
            if (!closed) {
                // æ¸…ç†èµ„æº
                closed = true;
            }
        }
    }
}
```

**ç¬¬ä¸‰åäºŒæ¡** Redisè¿æ¥æ± æ£€æŸ¥ ğŸŸ¡ï¼š

##### 4.32.1 Redisè¿æ¥æ± é…ç½®ä¸æ“ä½œåˆç†æ€§

**1. æ£€æµ‹ç›®æ ‡**

a. æœ€å¤§è¿æ¥æ•°ï¼šæ ¹æ® Redis æœåŠ¡å™¨é…ç½®ï¼Œé€šå¸¸ 8-32
b. æœ€å¤§ç©ºé—²è¿æ¥ï¼šæœ€å¤§è¿æ¥æ•°çš„ 50%-80%
c. è¿æ¥è¶…æ—¶ï¼š3-10 ç§’
d. æ‰€æœ‰ key å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé™¤éä¸šåŠ¡ç¡®å®éœ€è¦æ°¸ä¹…å­˜å‚¨ï¼‰
e. ç¦æ­¢ä½¿ç”¨ KEYSã€FLUSHALL ç­‰å±é™©å‘½ä»¤
f. å¤§æ‰¹é‡æ“ä½œå¿…é¡»ä½¿ç”¨ pipeline æˆ– æ‰¹é‡å‘½ä»¤

**2. æ£€æµ‹æ–¹æ³•**

a. é…ç½®å®¡æŸ¥ï¼šæ£€æŸ¥ Redis è¿æ¥æ± é…ç½®
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥ Redis æ“ä½œä»£ç 
c. è¿è¡Œæ—¶ç›‘æ§ï¼šç›‘æ§ Redis è¿æ¥æ•°å’Œå‘½ä»¤æ‰§è¡Œ
d. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯ Redis æ“ä½œæ€§èƒ½

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´
@Service
public class CacheService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void cacheUser(String userId, User user) {
        redisTemplate.opsForValue().set("user:" + userId, user); // æ²¡æœ‰è¿‡æœŸæ—¶é—´
    }
    
    // âŒ é”™è¯¯ï¼šä½¿ç”¨å±é™©å‘½ä»¤
    public Set<String> getAllKeys() {
        return redisTemplate.keys("*"); // KEYS å‘½ä»¤ä¼šé˜»å¡ Redis
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´å’Œå®‰å…¨æ“ä½œ
@Service
public class CacheService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final Duration USER_CACHE_TTL = Duration.ofHours(1);
    
    public void cacheUser(String userId, User user) {
        redisTemplate.opsForValue().set(
            "user:" + userId, 
            user, 
            USER_CACHE_TTL
        );
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ SCAN ä»£æ›¿ KEYS
    public Set<String> scanKeys(String pattern) {
        Set<String> keys = new HashSet<>();
        ScanOptions options = ScanOptions.scanOptions()
            .match(pattern)
            .count(100)
            .build();
        
        Cursor<String> cursor = redisTemplate.scan(options);
        while (cursor.hasNext()) {
            keys.add(cursor.next());
        }
        return keys;
    }
}
```

### 4.8 å¼‚å¸¸å¤„ç†æ£€æŸ¥

##### 4.8.1 å¼‚å¸¸åˆ†ç±»ä¸è®¾è®¡æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸ï¼Œä½¿ç”¨ä¸åŒçš„å¼‚å¸¸ç±»å‹
b. è‡ªå®šä¹‰å¼‚å¸¸å¿…é¡»ç»§æ‰¿åˆé€‚çš„åŸºç±»
c. å¼‚å¸¸ä¿¡æ¯å¿…é¡»åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
d. ç¦æ­¢ä½¿ç”¨é€šç”¨å¼‚å¸¸ç±»å‹ï¼ˆå¦‚RuntimeExceptionï¼‰
e. å¼‚å¸¸ç±»å‘½åå¿…é¡»æ¸…æ™°è¡¨è¾¾å¼‚å¸¸å«ä¹‰

**2. æ£€æµ‹æ–¹æ³•**

a. é™æ€åˆ†æï¼šä½¿ç”¨ SonarQube æ£€æµ‹å¼‚å¸¸è®¾è®¡é—®é¢˜
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¼‚å¸¸ç±»å®šä¹‰å’Œç»§æ‰¿å…³ç³»
c. æ¶æ„å®¡æŸ¥ï¼šéªŒè¯å¼‚å¸¸åˆ†å±‚è®¾è®¡åˆç†æ€§
d. æ–‡æ¡£æ£€æŸ¥ï¼šç¡®è®¤å¼‚å¸¸ä½¿ç”¨è§„èŒƒæ–‡æ¡£å®Œæ•´

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨é€šç”¨å¼‚å¸¸ç±»å‹
public class UserService {
    public User createUser(UserRequest request) {
        if (request.getAge() < 0) {
            throw new RuntimeException("å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°"); // åº”è¯¥ä½¿ç”¨ä¸šåŠ¡å¼‚å¸¸
        }
        
        if (userRepository.existsByEmail(request.getEmail())) {
            throw new Exception("é‚®ç®±å·²å­˜åœ¨"); // ä¸åº”è¯¥ä½¿ç”¨Exception
        }
        
        return userRepository.save(new User(request));
    }
}

// âŒ é”™è¯¯ï¼šå¼‚å¸¸ä¿¡æ¯ä¸è¶³
public class OrderService {
    public void processOrder(Long orderId) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new RuntimeException("è®¢å•ä¸å­˜åœ¨")); // ç¼ºå°‘è®¢å•IDä¿¡æ¯
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ¸…æ™°çš„å¼‚å¸¸åˆ†ç±»è®¾è®¡
public abstract class BusinessException extends Exception {
    private final String errorCode;
    
    public BusinessException(String errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
    }
    
    public String getErrorCode() {
        return errorCode;
    }
}

public abstract class SystemException extends RuntimeException {
    private final String errorCode;
    
    public SystemException(String errorCode, String message, Throwable cause) {
        super(message, cause);
        this.errorCode = errorCode;
    }
    
    public String getErrorCode() {
        return errorCode;
    }
}

// âœ… æ­£ç¡®ï¼šå…·ä½“çš„ä¸šåŠ¡å¼‚å¸¸
public class UserValidationException extends BusinessException {
    public UserValidationException(String field, Object value, String reason) {
        super("USER_VALIDATION_ERROR", 
            String.format("ç”¨æˆ·éªŒè¯å¤±è´¥: å­—æ®µ[%s], å€¼[%s], åŸå› [%s]", field, value, reason));
    }
}

public class UserNotFoundException extends BusinessException {
    public UserNotFoundException(Long userId) {
        super("USER_NOT_FOUND", 
            String.format("ç”¨æˆ·ä¸å­˜åœ¨: userId=%d", userId));
    }
}

// âœ… æ­£ç¡®ï¼šå…·ä½“çš„ç³»ç»Ÿå¼‚å¸¸
public class DatabaseConnectionException extends SystemException {
    public DatabaseConnectionException(String operation, Throwable cause) {
        super("DATABASE_CONNECTION_ERROR", 
            String.format("æ•°æ®åº“è¿æ¥å¼‚å¸¸: æ“ä½œ[%s]", operation), cause);
    }
}
```

##### 4.8.2 å¼‚å¸¸æ•è·ä¸å¤„ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¦æ­¢æ•è·è¿‡äºå®½æ³›çš„å¼‚å¸¸ï¼ˆExceptionã€Throwableï¼‰
b. å¿…é¡»æ­£ç¡®å¤„ç†æˆ–é‡æ–°æŠ›å‡ºå¼‚å¸¸
c. ç¦æ­¢å¿½ç•¥å¼‚å¸¸ï¼ˆç©ºcatchå—ï¼‰
d. å¼‚å¸¸è½¬æ¢å¿…é¡»ä¿ç•™åŸå§‹å¼‚å¸¸ä¿¡æ¯
e. èµ„æºæ¸…ç†å¿…é¡»åœ¨finallyå—æˆ–try-with-resourcesä¸­è¿›è¡Œ

**2. æ£€æµ‹æ–¹æ³•**

a. é™æ€åˆ†æï¼šæ£€æµ‹catchå—çš„å¼‚å¸¸ç±»å‹å’Œå¤„ç†é€»è¾‘
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰try-catch-finallyç»“æ„
c. å•å…ƒæµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸å¤„ç†çš„æ­£ç¡®æ€§
d. é›†æˆæµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸åœ¨ç³»ç»Ÿä¸­çš„ä¼ æ’­

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ•è·è¿‡äºå®½æ³›çš„å¼‚å¸¸
@Service
public class PaymentService {
    public void processPayment(PaymentRequest request) {
        try {
            // æ”¯ä»˜é€»è¾‘
            paymentGateway.charge(request);
        } catch (Exception e) { // è¿‡äºå®½æ³›
            log.error("æ”¯ä»˜å¤±è´¥"); // ä¸¢å¤±å¼‚å¸¸ä¿¡æ¯
            throw new RuntimeException("æ”¯ä»˜å¤„ç†å¤±è´¥"); // ä¸¢å¤±åŸå§‹å¼‚å¸¸
        }
    }
}

// âŒ é”™è¯¯ï¼šå¿½ç•¥å¼‚å¸¸
public class FileService {
    public void saveFile(String content, String path) {
        try {
            Files.write(Paths.get(path), content.getBytes());
        } catch (IOException e) {
            // ç©ºcatchå—ï¼Œå¿½ç•¥å¼‚å¸¸
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šç²¾ç¡®çš„å¼‚å¸¸æ•è·å’Œå¤„ç†
@Service
public class PaymentService {
    private static final Logger log = LoggerFactory.getLogger(PaymentService.class);
    
    public PaymentResult processPayment(PaymentRequest request) throws PaymentException {
        try {
            validatePaymentRequest(request);
            return paymentGateway.charge(request);
        } catch (PaymentValidationException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œè®°å½•å¹¶é‡æ–°æŠ›å‡º
            log.warn("æ”¯ä»˜éªŒè¯å¤±è´¥: orderId={}, reason={}", 
                request.getOrderId(), e.getMessage());
            throw e;
        } catch (PaymentGatewayException e) {
            // ç¬¬ä¸‰æ–¹å¼‚å¸¸ï¼Œè½¬æ¢ä¸ºç³»ç»Ÿå¼‚å¸¸
            log.error("æ”¯ä»˜ç½‘å…³å¼‚å¸¸: orderId={}, gateway={}", 
                request.getOrderId(), e.getGatewayName(), e);
            throw new PaymentSystemException("æ”¯ä»˜ç½‘å…³å¤„ç†å¤±è´¥", e);
        } catch (NetworkException e) {
            // ç½‘ç»œå¼‚å¸¸ï¼Œå¯é‡è¯•
            log.error("æ”¯ä»˜ç½‘ç»œå¼‚å¸¸: orderId={}", request.getOrderId(), e);
            throw new PaymentRetryableException("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•", e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨try-with-resourcesç®¡ç†èµ„æº
public class FileService {
    private static final Logger log = LoggerFactory.getLogger(FileService.class);
    
    public void saveFile(String content, String path) throws FileOperationException {
        try (BufferedWriter writer = Files.newBufferedWriter(Paths.get(path))) {
            writer.write(content);
        } catch (IOException e) {
            log.error("æ–‡ä»¶ä¿å­˜å¤±è´¥: path={}", path, e);
            throw new FileOperationException("æ–‡ä»¶ä¿å­˜å¤±è´¥: " + path, e);
        }
    }
}
```

##### 4.8.3 å¼‚å¸¸æ—¥å¿—ä¸ç›‘æ§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. æ¯ä¸ªå¼‚å¸¸åªèƒ½åœ¨ä¸€ä¸ªåœ°æ–¹è®°å½•æ—¥å¿—ï¼Œé¿å…é‡å¤
b. ä¸šåŠ¡å¼‚å¸¸è®°å½•å…³é”®ä¿¡æ¯ï¼Œç³»ç»Ÿå¼‚å¸¸è®°å½•å®Œæ•´å †æ ˆ
c. å¼‚å¸¸æ—¥å¿—å¿…é¡»åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
d. ç³»ç»Ÿå¼‚å¸¸å¿…é¡»æœ‰ç›‘æ§å‘Šè­¦æœºåˆ¶
e. æ•æ„Ÿä¿¡æ¯ä¸èƒ½å‡ºç°åœ¨å¼‚å¸¸æ—¥å¿—ä¸­

**2. æ£€æµ‹æ–¹æ³•**

a. æ—¥å¿—åˆ†æï¼šæ£€æŸ¥å¼‚å¸¸æ—¥å¿—çš„å®Œæ•´æ€§å’Œé‡å¤æ€§
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¼‚å¸¸è®°å½•çš„ä½ç½®å’Œå†…å®¹
c. ç›‘æ§éªŒè¯ï¼šç¡®è®¤å¼‚å¸¸å‘Šè­¦æœºåˆ¶æœ‰æ•ˆ
d. å®‰å…¨å®¡æŸ¥ï¼šç¡®è®¤æ•æ„Ÿä¿¡æ¯ä¸ä¼šæ³„éœ²

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šé‡å¤è®°å½•å¼‚å¸¸æ—¥å¿—
@Service
public class OrderService {
    public void createOrder(OrderRequest request) {
        try {
            Order order = buildOrder(request);
            orderRepository.save(order);
        } catch (DataAccessException e) {
            log.error("ä¿å­˜è®¢å•å¤±è´¥", e); // ç¬¬ä¸€æ¬¡è®°å½•
            throw new OrderException("è®¢å•åˆ›å»ºå¤±è´¥", e);
        }
    }
}

@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(OrderException.class)
    public ResponseEntity<String> handleOrderException(OrderException e) {
        log.error("è®¢å•å¼‚å¸¸", e); // é‡å¤è®°å½•
        return ResponseEntity.status(500).body("è®¢å•å¤„ç†å¤±è´¥");
    }
}

// âŒ é”™è¯¯ï¼šæ—¥å¿—ä¿¡æ¯ä¸è¶³ï¼ŒåŒ…å«æ•æ„Ÿä¿¡æ¯
public class UserService {
    public void login(String username, String password) {
        try {
            authService.authenticate(username, password);
        } catch (AuthenticationException e) {
            log.error("ç™»å½•å¤±è´¥: username={}, password={}", username, password); // æ³„éœ²å¯†ç 
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šåˆç†çš„å¼‚å¸¸æ—¥å¿—è®°å½•
@Service
public class OrderService {
    private static final Logger log = LoggerFactory.getLogger(OrderService.class);
    
    public Order createOrder(OrderRequest request) throws OrderException {
        try {
            Order order = buildOrder(request);
            return orderRepository.save(order);
        } catch (DataAccessException e) {
            // åªåœ¨è¿™é‡Œè®°å½•ç³»ç»Ÿå¼‚å¸¸ï¼ŒåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
            log.error("è®¢å•ä¿å­˜å¤±è´¥: userId={}, productId={}, amount={}, traceId={}", 
                request.getUserId(), request.getProductId(), 
                request.getAmount(), MDC.get("traceId"), e);
            throw new OrderException("è®¢å•åˆ›å»ºå¤±è´¥", e);
        }
    }
}

@ControllerAdvice
public class GlobalExceptionHandler {
    private static final Logger log = LoggerFactory.getLogger(GlobalExceptionHandler.class);
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(BusinessException e) {
        // ä¸šåŠ¡å¼‚å¸¸åªè®°å½•å…³é”®ä¿¡æ¯ï¼Œä¸è®°å½•å †æ ˆ
        log.warn("ä¸šåŠ¡å¼‚å¸¸: code={}, message={}, traceId={}", 
            e.getErrorCode(), e.getMessage(), MDC.get("traceId"));
        
        return ResponseEntity.status(HttpStatus.BAD_REQUEST)
            .body(new ErrorResponse(e.getErrorCode(), e.getMessage()));
    }
    
    @ExceptionHandler(SystemException.class)
    public ResponseEntity<ErrorResponse> handleSystemException(SystemException e) {
        // ç³»ç»Ÿå¼‚å¸¸ä¸é‡å¤è®°å½•ï¼Œåªè®°å½•å¤„ç†ä¿¡æ¯
        log.info("ç³»ç»Ÿå¼‚å¸¸å·²å¤„ç†: code={}, traceId={}", 
            e.getErrorCode(), MDC.get("traceId"));
        
        // è§¦å‘ç›‘æ§å‘Šè­¦
        alertService.sendAlert("SYSTEM_EXCEPTION", e.getErrorCode(), e.getMessage());
        
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(new ErrorResponse("SYSTEM_ERROR", "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"));
    }
}

// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„æ—¥å¿—è®°å½•
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    public void login(String username, String password) throws AuthenticationException {
        try {
            authService.authenticate(username, password);
            log.info("ç”¨æˆ·ç™»å½•æˆåŠŸ: username={}, ip={}, traceId={}", 
                username, getClientIp(), MDC.get("traceId"));
        } catch (AuthenticationException e) {
            // ä¸è®°å½•å¯†ç ï¼Œåªè®°å½•å¿…è¦ä¿¡æ¯
            log.warn("ç”¨æˆ·ç™»å½•å¤±è´¥: username={}, reason={}, ip={}, traceId={}", 
                username, e.getMessage(), getClientIp(), MDC.get("traceId"));
            throw e;
        }
    }
}

**ç¬¬ä¸‰åäº”æ¡** é‡è¯•å’Œç†”æ–­æ£€æŸ¥ ğŸŸ¡ï¼š

##### 4.35.1 å®¹é”™æœºåˆ¶è®¾è®¡åˆç†æ€§

**1. æ£€æµ‹ç›®æ ‡**

a. å¤–éƒ¨æœåŠ¡è°ƒç”¨å¿…é¡»å®ç°é‡è¯•æœºåˆ¶
b. é‡è¯•æ¬¡æ•°ä¸è¶…è¿‡ 3 æ¬¡ï¼Œé—´éš”é‡‡ç”¨æŒ‡æ•°é€€é¿
c. å¿…é¡»å®ç°ç†”æ–­å™¨æ¨¡å¼ï¼Œé˜²æ­¢çº§è”å¤±è´¥
d. é‡è¯•å’Œç†”æ–­å‚æ•°å¿…é¡»å¯é…ç½®
e. åªå¯¹å¯é‡è¯•çš„å¼‚å¸¸è¿›è¡Œé‡è¯•ï¼ˆç½‘ç»œå¼‚å¸¸ã€è¶…æ—¶ç­‰ï¼‰

**2. æ£€æµ‹æ–¹æ³•**

a. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥å¤–éƒ¨è°ƒç”¨çš„å®¹é”™æœºåˆ¶
b. é…ç½®æ£€æŸ¥ï¼šéªŒè¯é‡è¯•å’Œç†”æ–­å‚æ•°é…ç½®
c. æ•…éšœæµ‹è¯•ï¼šæ¨¡æ‹Ÿå¤–éƒ¨æœåŠ¡æ•…éšœï¼ŒéªŒè¯å®¹é”™æ•ˆæœ
d. ç›‘æ§éªŒè¯ï¼šç¡®è®¤é‡è¯•å’Œç†”æ–­æŒ‡æ ‡æ­£å¸¸

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰é‡è¯•å’Œç†”æ–­æœºåˆ¶
@Service
public class PaymentService {
    @Autowired
    private RestTemplate restTemplate;
    
    public PaymentResult charge(PaymentRequest request) {
        // ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰å®¹é”™æœºåˆ¶
        return restTemplate.postForObject(
            "/api/charge", 
            request, 
            PaymentResult.class
        );
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Spring Retry å’Œ Resilience4j
@Service
public class PaymentService {
    private static final Logger log = LoggerFactory.getLogger(PaymentService.class);
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Retryable(
        value = {ResourceAccessException.class, HttpServerErrorException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    @CircuitBreaker(name = "payment-service", fallbackMethod = "chargeFailback")
    public PaymentResult charge(PaymentRequest request) {
        log.info("Attempting payment charge: requestId={}", request.getId());
        
        return restTemplate.postForObject(
            "/api/charge", 
            request, 
            PaymentResult.class
        );
    }
    
    @Recover
    public PaymentResult recover(Exception e, PaymentRequest request) {
        log.error("Payment charge failed after retries: requestId={}", 
            request.getId(), e);
        throw new PaymentServiceException("Payment service unavailable", e);
    }
    
    public PaymentResult chargeFailback(PaymentRequest request, Exception e) {
        log.warn("Payment service circuit breaker activated: requestId={}", 
            request.getId());
        return PaymentResult.failed("Payment service temporarily unavailable");
    }
}
```

### 4.9 æ—¥å¿—å’Œç›‘æ§æ£€æŸ¥

##### 4.9.1 æ—¥å¿—è§„èŒƒæ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»åˆç†ä½¿ç”¨æ—¥å¿—çº§åˆ«ï¼ˆERRORã€WARNã€INFOã€DEBUGï¼‰
b. æ—¥å¿—å¿…é¡»åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ä¿¡æ¯
c. ç¦æ­¢è®°å½•æ•æ„Ÿä¿¡æ¯
d. å¿…é¡»ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼å’Œç»“æ„åŒ–æ—¥å¿—
e. ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨System.out.printlnå’Œe.printStackTrace()

**2. æ£€æµ‹æ–¹æ³•**

a. é™æ€åˆ†æï¼šä½¿ç”¨SonarQubeæ£€æµ‹æ—¥å¿—ä½¿ç”¨é—®é¢˜
b. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰æ—¥å¿—è¾“å‡ºè¯­å¥
c. æ•æ„Ÿä¿¡æ¯æ‰«æï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹æ•æ„Ÿä¿¡æ¯
d. é…ç½®æ£€æŸ¥ï¼šéªŒè¯logbacké…ç½®æ–‡ä»¶æ­£ç¡®æ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨System.out.printlnå’Œè®°å½•æ•æ„Ÿä¿¡æ¯
@Service
public class UserService {
    public void login(String username, String password) {
        // é”™è¯¯ï¼šä½¿ç”¨System.out.println
        System.out.println("User login: " + username);
        
        // é”™è¯¯ï¼šè®°å½•æ•æ„Ÿä¿¡æ¯
        log.info("Login attempt: username={}, password={}", username, password);
        
        // é”™è¯¯ï¼šä½¿ç”¨printStackTrace
        try {
            authenticate(username, password);
        } catch (Exception e) {
            e.printStackTrace(); // é”™è¯¯çš„å¼‚å¸¸å¤„ç†
        }
    }
}

// âŒ é”™è¯¯ï¼šæ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸å½“
public class OrderService {
    public void processOrder(Order order) {
        log.error("Processing order: {}", order.getId()); // åº”è¯¥ç”¨INFO
        
        if (order.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            log.info("Invalid order amount"); // åº”è¯¥ç”¨WARN
        }
        
        log.debug("Critical system error occurred"); // åº”è¯¥ç”¨ERROR
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šè§„èŒƒçš„æ—¥å¿—ä½¿ç”¨
@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    public LoginResult login(String username, String password) {
        String traceId = MDC.get("traceId");
        
        // æ­£ç¡®ï¼šè®°å½•å…³é”®æ“ä½œï¼Œä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
        log.info("User login attempt: username={}, ip={}, traceId={}", 
            username, getClientIp(), traceId);
        
        try {
            User user = authenticate(username, password);
            
            // æ­£ç¡®ï¼šè®°å½•æˆåŠŸæ“ä½œ
            log.info("User login successful: userId={}, username={}, traceId={}", 
                user.getId(), username, traceId);
            
            return LoginResult.success(user);
            
        } catch (AuthenticationException e) {
            // æ­£ç¡®ï¼šä¸šåŠ¡å¼‚å¸¸ä½¿ç”¨WARNçº§åˆ«
            log.warn("User login failed: username={}, reason={}, traceId={}", 
                username, e.getMessage(), traceId);
            throw e;
            
        } catch (Exception e) {
            // æ­£ç¡®ï¼šç³»ç»Ÿå¼‚å¸¸ä½¿ç”¨ERRORçº§åˆ«ï¼Œè®°å½•å®Œæ•´å †æ ˆ
            log.error("System error during login: username={}, traceId={}", 
                username, traceId, e);
            throw new SystemException("Login system error", e);
        }
    }
}

// âœ… æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—é…ç½®
// logback-spring.xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/application.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>logs/application.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
            </rollingPolicy>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <logLevel/>
                    <loggerName/>
                    <mdc/>
                    <message/>
                    <stackTrace/>
                </providers>
            </encoder>
        </appender>
        
        <appender name="ASYNC" class="ch.qos.logback.classic.AsyncAppender">
            <appender-ref ref="FILE"/>
            <queueSize>1024</queueSize>
            <discardingThreshold>0</discardingThreshold>
        </appender>
        
        <root level="INFO">
            <appender-ref ref="ASYNC"/>
        </root>
    </springProfile>
</configuration>
```

##### 4.9.2 ç›‘æ§é›†æˆæ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»é›†æˆAPMå·¥å…·è¿›è¡Œé“¾è·¯è¿½è¸ª
b. å¿…é¡»æ”¶é›†å…³é”®ä¸šåŠ¡æŒ‡æ ‡å’ŒæŠ€æœ¯æŒ‡æ ‡
c. å¤–éƒ¨ä¾èµ–è°ƒç”¨å¿…é¡»æœ‰ç›‘æ§åŸ‹ç‚¹
d. å…³é”®æ¥å£å¿…é¡»æœ‰æ€§èƒ½ç›‘æ§
e. å¿…é¡»é…ç½®åˆç†çš„å‘Šè­¦è§„åˆ™å’Œé˜ˆå€¼

**2. æ£€æµ‹æ–¹æ³•**

a. é…ç½®æ£€æŸ¥ï¼šéªŒè¯ç›‘æ§ç»„ä»¶é…ç½®æ­£ç¡®
b. æŒ‡æ ‡éªŒè¯ï¼šç¡®è®¤å…³é”®æŒ‡æ ‡æ­£å¸¸æ”¶é›†
c. é“¾è·¯è¿½è¸ªï¼šæ£€æŸ¥åˆ†å¸ƒå¼è°ƒç”¨é“¾å®Œæ•´æ€§
d. å‘Šè­¦æµ‹è¯•ï¼šéªŒè¯å‘Šè­¦è§„åˆ™æœ‰æ•ˆæ€§

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç›‘æ§é›†æˆ
@RestController
public class OrderController {
    @PostMapping("/orders")
    public OrderResult createOrder(@RequestBody OrderRequest request) {
        // æ²¡æœ‰ä»»ä½•ç›‘æ§æŒ‡æ ‡æ”¶é›†
        return orderService.createOrder(request);
    }
}

// âŒ é”™è¯¯ï¼šå¤–éƒ¨è°ƒç”¨æ²¡æœ‰ç›‘æ§
@Service
public class PaymentService {
    public PaymentResult processPayment(PaymentRequest request) {
        // æ²¡æœ‰ç›‘æ§åŸ‹ç‚¹
        return paymentGateway.charge(request);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ç›‘æ§é›†æˆ
@RestController
public class OrderController {
    private final MeterRegistry meterRegistry;
    private final Counter orderCreateCounter;
    private final Timer orderCreateTimer;
    
    public OrderController(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.orderCreateCounter = Counter.builder("order.create.total")
            .description("Total order creation attempts")
            .register(meterRegistry);
        this.orderCreateTimer = Timer.builder("order.create.duration")
            .description("Order creation duration")
            .register(meterRegistry);
    }
    
    @PostMapping("/orders")
    @Timed(value = "order.create", description = "Order creation time")
    public OrderResult createOrder(@RequestBody OrderRequest request) {
        return Timer.Sample.start(meterRegistry)
            .stop(orderCreateTimer)
            .recordCallable(() -> {
                try {
                    OrderResult result = orderService.createOrder(request);
                    
                    // è®°å½•æˆåŠŸæŒ‡æ ‡
                    orderCreateCounter.increment(Tags.of("status", "success"));
                    meterRegistry.gauge("order.amount", result.getAmount().doubleValue());
                    
                    return result;
                    
                } catch (Exception e) {
                    // è®°å½•å¤±è´¥æŒ‡æ ‡
                    orderCreateCounter.increment(Tags.of(
                        "status", "error", 
                        "type", e.getClass().getSimpleName()
                    ));
                    throw e;
                }
            });
    }
}

// âœ… æ­£ç¡®ï¼šå¤–éƒ¨è°ƒç”¨ç›‘æ§
@Service
public class PaymentService {
    private final MeterRegistry meterRegistry;
    private final Timer paymentTimer;
    private final Counter paymentCounter;
    
    public PaymentService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.paymentTimer = Timer.builder("payment.gateway.duration")
            .description("Payment gateway call duration")
            .register(meterRegistry);
        this.paymentCounter = Counter.builder("payment.gateway.total")
            .description("Payment gateway call total")
            .register(meterRegistry);
    }
    
    @NewSpan("payment-process")
    public PaymentResult processPayment(PaymentRequest request) {
        return Timer.Sample.start(meterRegistry)
            .stop(paymentTimer)
            .recordCallable(() -> {
                try {
                    PaymentResult result = paymentGateway.charge(request);
                    
                    paymentCounter.increment(Tags.of(
                        "status", "success",
                        "gateway", request.getGateway()
                    ));
                    
                    return result;
                    
                } catch (Exception e) {
                    paymentCounter.increment(Tags.of(
                        "status", "error",
                        "gateway", request.getGateway(),
                        "error_type", e.getClass().getSimpleName()
                    ));
                    throw e;
                }
            });
    }
}
```

##### 4.9.3 æ€§èƒ½ç›‘æ§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. å¿…é¡»ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆå“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡ï¼‰
b. å¿…é¡»ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
c. å¿…é¡»ç›‘æ§æ•°æ®åº“è¿æ¥æ± å’Œç¼“å­˜æ€§èƒ½
d. å¿…é¡»è®¾ç½®åˆç†çš„æ€§èƒ½é˜ˆå€¼å’Œå‘Šè­¦
e. å¿…é¡»æ”¯æŒæ€§èƒ½æ•°æ®çš„å¯è§†åŒ–å±•ç¤º

**2. æ£€æµ‹æ–¹æ³•**

a. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯ç›‘æ§æŒ‡æ ‡å‡†ç¡®æ€§
b. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯é«˜è´Ÿè½½ä¸‹ç›‘æ§æœ‰æ•ˆæ€§
c. å‘Šè­¦æµ‹è¯•ï¼šéªŒè¯æ€§èƒ½å‘Šè­¦åŠæ—¶æ€§
d. å¯è§†åŒ–æ£€æŸ¥ï¼šç¡®è®¤ç›‘æ§æ•°æ®å¯è§†åŒ–å®Œæ•´

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ€§èƒ½ç›‘æ§
@Service
public class DataService {
    public List<Data> queryData(QueryRequest request) {
        // æ²¡æœ‰æ€§èƒ½ç›‘æ§
        return dataRepository.findByConditions(request);
    }
    
    public void batchProcess(List<Data> dataList) {
        // æ‰¹å¤„ç†æ²¡æœ‰ç›‘æ§
        for (Data data : dataList) {
            processData(data);
        }
    }
}

// âŒ é”™è¯¯ï¼šç¼ºå°‘èµ„æºç›‘æ§
@Component
public class CacheManager {
    private final Map<String, Object> cache = new ConcurrentHashMap<>();
    
    public void put(String key, Object value) {
        cache.put(key, value); // æ²¡æœ‰ç›‘æ§ç¼“å­˜å¤§å°
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æ€§èƒ½ç›‘æ§
@Service
public class DataService {
    private final MeterRegistry meterRegistry;
    private final Timer queryTimer;
    private final Counter queryCounter;
    private final Gauge cacheHitRatio;
    
    public DataService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.queryTimer = Timer.builder("data.query.duration")
            .description("Data query duration")
            .register(meterRegistry);
        this.queryCounter = Counter.builder("data.query.total")
            .description("Data query total count")
            .register(meterRegistry);
    }
    
    @Timed(value = "data.query", description = "Data query time")
    public List<Data> queryData(QueryRequest request) {
        return Timer.Sample.start(meterRegistry)
            .stop(queryTimer)
            .recordCallable(() -> {
                try {
                    List<Data> result = dataRepository.findByConditions(request);
                    
                    // è®°å½•æŸ¥è¯¢æŒ‡æ ‡
                    queryCounter.increment(Tags.of(
                        "status", "success",
                        "type", request.getType(),
                        "size", String.valueOf(result.size())
                    ));
                    
                    // ç›‘æ§æŸ¥è¯¢ç»“æœå¤§å°
                    meterRegistry.gauge("data.query.result.size", result.size());
                    
                    return result;
                    
                } catch (Exception e) {
                    queryCounter.increment(Tags.of(
                        "status", "error",
                        "type", request.getType(),
                        "error", e.getClass().getSimpleName()
                    ));
                    throw e;
                }
            });
    }
    
    @Async
    @Timed(value = "data.batch.process", description = "Batch process time")
    public CompletableFuture<Void> batchProcess(List<Data> dataList) {
        Timer.Sample sample = Timer.Sample.start(meterRegistry);
        
        try {
            int totalCount = dataList.size();
            int processedCount = 0;
            
            for (Data data : dataList) {
                processData(data);
                processedCount++;
                
                // æ›´æ–°å¤„ç†è¿›åº¦
                meterRegistry.gauge("data.batch.progress", 
                    (double) processedCount / totalCount * 100);
            }
            
            // è®°å½•æ‰¹å¤„ç†æˆåŠŸ
            meterRegistry.counter("data.batch.total", 
                "status", "success").increment();
            
            return CompletableFuture.completedFuture(null);
            
        } catch (Exception e) {
            meterRegistry.counter("data.batch.total", 
                "status", "error", 
                "error", e.getClass().getSimpleName()).increment();
            throw e;
            
        } finally {
            sample.stop(Timer.builder("data.batch.duration")
                .register(meterRegistry));
        }
    }
}

// âœ… æ­£ç¡®ï¼šèµ„æºç›‘æ§
@Component
public class CacheManager {
    private final Map<String, Object> cache = new ConcurrentHashMap<>();
    private final MeterRegistry meterRegistry;
    private final AtomicLong hitCount = new AtomicLong(0);
    private final AtomicLong missCount = new AtomicLong(0);
    
    public CacheManager(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // æ³¨å†Œç¼“å­˜ç›‘æ§æŒ‡æ ‡
        Gauge.builder("cache.size")
            .description("Cache size")
            .register(meterRegistry, this, c -> c.cache.size());
            
        Gauge.builder("cache.hit.ratio")
            .description("Cache hit ratio")
            .register(meterRegistry, this, c -> {
                long total = c.hitCount.get() + c.missCount.get();
                return total > 0 ? (double) c.hitCount.get() / total : 0.0;
            });
    }
    
    public Object get(String key) {
        Object value = cache.get(key);
        if (value != null) {
            hitCount.incrementAndGet();
            meterRegistry.counter("cache.access", "result", "hit").increment();
        } else {
            missCount.incrementAndGet();
            meterRegistry.counter("cache.access", "result", "miss").increment();
        }
        return value;
    }
    
    public void put(String key, Object value) {
        cache.put(key, value);
        meterRegistry.counter("cache.operations", "type", "put").increment();
        
        // ç›‘æ§ç¼“å­˜å¤§å°ï¼Œè¶…è¿‡é˜ˆå€¼å‘Šè­¦
        if (cache.size() > 10000) {
            meterRegistry.counter("cache.size.warning").increment();
        }
    }
}

**ç¬¬ä¸‰åå…«æ¡** å¥åº·æ£€æŸ¥æ£€æŸ¥ ğŸŸ¡ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿æœåŠ¡å¥åº·çŠ¶æ€å¯ç›‘æ§ï¼Œæ”¯æŒè‡ªåŠ¨åŒ–è¿ç»´

**æ£€æµ‹æ ‡å‡†ï¼š**
- å¿…é¡»æä¾› /actuator/health å¥åº·æ£€æŸ¥ç«¯ç‚¹
- å¿…é¡»æä¾› /actuator/ready å°±ç»ªæ£€æŸ¥ç«¯ç‚¹
- å¿…é¡»æ£€æŸ¥å…³é”®ä¾èµ–çš„å¥åº·çŠ¶æ€ï¼šæ•°æ®åº“ã€Redisã€å¤–éƒ¨æœåŠ¡
- å¥åº·æ£€æŸ¥å“åº”æ—¶é—´ä¸è¶…è¿‡ 3 ç§’
- å¥åº·æ£€æŸ¥å¤±è´¥æ—¶å¿…é¡»è¿”å›å…·ä½“çš„é”™è¯¯ä¿¡æ¯
- å¿…é¡»æ”¯æŒä¼˜é›…å…³é—­

**æ£€æµ‹æ–¹æ³•ï¼š**
- æ¥å£æµ‹è¯•ï¼šéªŒè¯å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- ä¾èµ–æµ‹è¯•ï¼šæ¨¡æ‹Ÿä¾èµ–æ•…éšœï¼ŒéªŒè¯å¥åº·æ£€æŸ¥å“åº”
- æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤å¥åº·æ£€æŸ¥å“åº”æ—¶é—´
- è¿ç»´éªŒè¯ï¼šç¡®è®¤ä¸è´Ÿè½½å‡è¡¡å™¨é›†æˆæ­£å¸¸

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç®€å•çš„å¥åº·æ£€æŸ¥ï¼Œæ²¡æœ‰ä¾èµ–æ£€æŸ¥
@RestController
public class HealthController {
    @GetMapping("/health")
    public String health() {
        return "OK"; // è¿‡äºç®€å•ï¼Œæ²¡æœ‰å®é™…æ£€æŸ¥
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„å¥åº·æ£€æŸ¥å®ç°
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    private final DataSource dataSource;
    
    public DatabaseHealthIndicator(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    
    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(3)) {
                return Health.up()
                    .withDetail("database", "Available")
                    .withDetail("validationQuery", "SELECT 1")
                    .build();
            } else {
                return Health.down()
                    .withDetail("database", "Connection validation failed")
                    .build();
            }
        } catch (Exception e) {
            return Health.down()
                .withDetail("database", "Connection failed")
                .withDetail("error", e.getMessage())
                .build();
        }
    }
}

// âœ… æ­£ç¡®ï¼šåº”ç”¨é…ç½®
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,ready,info,metrics
  endpoint:
    health:
      show-details: when-authorized
      probes:
        enabled: true
  health:
    db:
      enabled: true
    redis:
      enabled: true
```

### 4.10 å®‰å…¨æ€§æ£€æŸ¥

#### 4.10.1 è¾“å…¥éªŒè¯æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿æ‰€æœ‰å¤–éƒ¨è¾“å…¥å¾—åˆ°ä¸¥æ ¼éªŒè¯ï¼Œé˜²æ­¢æ³¨å…¥æ”»å‡»ã€‚
b. ç¦æ­¢SQLæ³¨å…¥ï¼Œå¿…é¡»ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ã€‚
c. é˜²æ­¢XSSæ”»å‡»ï¼Œè¾“å‡ºæ•°æ®å¿…é¡»è¿›è¡ŒHTMLç¼–ç ã€‚
d. å®ç°è¾“å…¥é•¿åº¦é™åˆ¶å’Œæ•°æ®ç±»å‹éªŒè¯ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€åˆ†æï¼šä½¿ç”¨SASTå·¥å…·æ£€æµ‹æ½œåœ¨çš„æ³¨å…¥æ¼æ´ã€‚
2. ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰å¤–éƒ¨è¾“å…¥å¤„ç†é€»è¾‘ã€‚
3. å®‰å…¨æµ‹è¯•ï¼šä½¿ç”¨OWASP ZAPç­‰å·¥å…·è¿›è¡Œæ¸—é€æµ‹è¯•ã€‚
4. å‚æ•°éªŒè¯ï¼šç¡®è®¤æ‰€æœ‰æ¥å£å‚æ•°éƒ½æœ‰éªŒè¯æ³¨è§£ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šSQLæ³¨å…¥é£é™©
@Service
public class UserService {
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public User findByUsername(String username) {
        // å±é™©ï¼šç›´æ¥æ‹¼æ¥SQLï¼Œå­˜åœ¨æ³¨å…¥é£é™©
        String sql = "SELECT * FROM users WHERE username = '" + username + "'";
        return jdbcTemplate.queryForObject(sql, User.class);
    }
    
    public List<User> searchUsers(String keyword) {
        // å±é™©ï¼šæœªéªŒè¯è¾“å…¥é•¿åº¦å’Œå†…å®¹
        String sql = "SELECT * FROM users WHERE name LIKE '%" + keyword + "%'";
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(User.class));
    }
}

// âŒ é”™è¯¯ï¼šXSSæ”»å‡»é£é™©
@RestController
public class MessageController {
    @PostMapping("/messages")
    public String createMessage(@RequestParam String content) {
        // å±é™©ï¼šç›´æ¥è¿”å›ç”¨æˆ·è¾“å…¥ï¼Œå­˜åœ¨XSSé£é™©
        return "<div>Message: " + content + "</div>";
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥é˜²æ­¢SQLæ³¨å…¥
@Service
public class UserService {
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public User findByUsername(@Valid @Size(min = 1, max = 50) String username) {
        // å®‰å…¨ï¼šä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
        String sql = "SELECT * FROM users WHERE username = ?";
        try {
            return jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(User.class), username);
        } catch (EmptyResultDataAccessException e) {
            return null;
        }
    }
    
    public List<User> searchUsers(@Valid @Size(min = 1, max = 100) String keyword) {
        // å®‰å…¨ï¼šå‚æ•°éªŒè¯ + é¢„ç¼–è¯‘è¯­å¥
        if (!isValidSearchKeyword(keyword)) {
            throw new IllegalArgumentException("Invalid search keyword");
        }
        
        String sql = "SELECT * FROM users WHERE name LIKE ? LIMIT 100";
        String searchPattern = "%" + keyword.replaceAll("[%_]", "\\\\$0") + "%";
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(User.class), searchPattern);
    }
    
    private boolean isValidSearchKeyword(String keyword) {
        // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ç©ºæ ¼å’Œå¸¸è§æ ‡ç‚¹
        return keyword.matches("^[a-zA-Z0-9\\s\\-_\\.@]+$");
    }
}

// âœ… æ­£ç¡®ï¼šé˜²æ­¢XSSæ”»å‡»
@RestController
public class MessageController {
    @PostMapping("/messages")
    public ResponseEntity<MessageResponse> createMessage(
            @Valid @RequestBody MessageRequest request) {
        
        // å®‰å…¨ï¼šHTMLç¼–ç é˜²æ­¢XSS
        String safeContent = HtmlUtils.htmlEscape(request.getContent());
        
        Message message = messageService.createMessage(safeContent);
        
        return ResponseEntity.ok(new MessageResponse(message.getId(), safeContent));
    }
}

// âœ… æ­£ç¡®ï¼šè¾“å…¥éªŒè¯æ³¨è§£
public class MessageRequest {
    @NotBlank(message = "Content cannot be blank")
    @Size(min = 1, max = 1000, message = "Content length must be between 1 and 1000 characters")
    @Pattern(regexp = "^[^<>\"'&]*$", message = "Content contains invalid characters")
    private String content;
    
    // getter/setter
}
```

#### 4.10.2 è®¤è¯æˆæƒæ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿èº«ä»½è®¤è¯å’Œæƒé™æ§åˆ¶æœºåˆ¶å®Œå–„ã€‚
b. å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ã€‚
c. æ•æ„Ÿæ“ä½œå¿…é¡»è¿›è¡Œæƒé™éªŒè¯ã€‚
d. å¯†ç å¿…é¡»è¿›è¡Œå®‰å…¨å­˜å‚¨å’Œä¼ è¾“ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æƒé™æµ‹è¯•ï¼šéªŒè¯ä¸åŒè§’è‰²çš„è®¿é—®æƒé™ã€‚
2. ä¼šè¯æµ‹è¯•ï¼šæ£€æŸ¥ä¼šè¯ç®¡ç†æœºåˆ¶ã€‚
3. è®¤è¯ç»•è¿‡æµ‹è¯•ï¼šå°è¯•ç»•è¿‡è®¤è¯æœºåˆ¶ã€‚
4. å¯†ç å®‰å…¨æ£€æŸ¥ï¼šéªŒè¯å¯†ç å­˜å‚¨å’Œä¼ è¾“å®‰å…¨ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæ˜æ–‡å­˜å‚¨å¯†ç ï¼Œç¼ºå°‘æƒé™æ§åˆ¶
@RestController
public class UserController {
    @PostMapping("/users")
    public User createUser(@RequestBody UserRequest request) {
        // å±é™©ï¼šæ˜æ–‡å­˜å‚¨å¯†ç 
        User user = new User();
        user.setUsername(request.getUsername());
        user.setPassword(request.getPassword()); // æ˜æ–‡å¯†ç 
        
        // å±é™©ï¼šæ²¡æœ‰æƒé™æ£€æŸ¥
        return userService.save(user);
    }
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        // å±é™©ï¼šæ²¡æœ‰è®¤è¯å’Œæˆæƒæ£€æŸ¥
        return userService.findById(id);
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œå–„çš„è®¤è¯å’Œæˆæƒæœºåˆ¶
@RestController
@RequestMapping("/api/users")
public class UserController {
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @PostMapping
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<UserResponse> createUser(
            @Valid @RequestBody UserRequest request,
            Authentication authentication) {
        
        // å®‰å…¨ï¼šå¯†ç åŠ å¯†å­˜å‚¨
        User user = new User();
        user.setUsername(request.getUsername());
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user.setCreatedBy(authentication.getName());
        
        User savedUser = userService.save(user);
        
        // å®‰å…¨ï¼šä¸è¿”å›æ•æ„Ÿä¿¡æ¯
        UserResponse response = new UserResponse();
        response.setId(savedUser.getId());
        response.setUsername(savedUser.getUsername());
        response.setCreatedAt(savedUser.getCreatedAt());
        
        return ResponseEntity.ok(response);
    }
    
    @GetMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or @userService.isOwner(#id, authentication.name)")
    public ResponseEntity<UserResponse> getUser(
            @PathVariable Long id,
            Authentication authentication) {
        
        User user = userService.findById(id);
        if (user == null) {
            return ResponseEntity.notFound().build();
        }
        
        UserResponse response = UserResponse.fromUser(user);
        return ResponseEntity.ok(response);
    }
}

// âœ… æ­£ç¡®ï¼šJWTé…ç½®
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12);
    }
    
    @Bean
    public JwtDecoder jwtDecoder() {
        return NimbusJwtDecoder.withJwkSetUri(jwkSetUri)
            .jwsAlgorithm(SignatureAlgorithm.RS256)
            .cache(Duration.ofMinutes(5))
            .build();
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
            .csrf(csrf -> csrf.disable())
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()))
            .build();
    }
}
```

**ç¬¬å››åä¸€æ¡** å¯†ç å­¦å®è·µæ£€æŸ¥ ğŸ”´ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿åŠ å¯†ç®—æ³•ä½¿ç”¨æ­£ç¡®ï¼Œå¯†é’¥ç®¡ç†å®‰å…¨

**æ£€æµ‹æ ‡å‡†ï¼š**
- å¿…é¡»ä½¿ç”¨å®‰å…¨çš„åŠ å¯†ç®—æ³•ï¼šAES-256ã€RSA-2048+ã€SHA-256+
- ç¦æ­¢ä½¿ç”¨å¼±åŠ å¯†ç®—æ³•ï¼šDESã€MD5ã€SHA-1
- å¯†é’¥å¿…é¡»å®‰å…¨å­˜å‚¨ï¼Œä¸èƒ½ç¡¬ç¼–ç 
- éšæœºæ•°ç”Ÿæˆå¿…é¡»ä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
- å¯†é’¥è½®æ¢æœºåˆ¶å¿…é¡»å®ç°
- æ”¯æŒå›½å¯†ç®—æ³•ï¼ˆSM2ã€SM3ã€SM4ï¼‰

**æ£€æµ‹æ–¹æ³•ï¼š**
- ä»£ç å®¡æŸ¥ï¼šæ£€æŸ¥åŠ å¯†ç®—æ³•ä½¿ç”¨
- å¯†é’¥ç®¡ç†æ£€æŸ¥ï¼šéªŒè¯å¯†é’¥å­˜å‚¨å’Œè½®æ¢
- åŠ å¯†å¼ºåº¦æµ‹è¯•ï¼šéªŒè¯åŠ å¯†ç®—æ³•å¼ºåº¦
- åˆè§„æ€§æ£€æŸ¥ï¼šç¡®è®¤ç¬¦åˆç›¸å…³å®‰å…¨æ ‡å‡†

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨å¼±åŠ å¯†ç®—æ³•å’Œç¡¬ç¼–ç å¯†é’¥
public class CryptoService {
    // å±é™©ï¼šç¡¬ç¼–ç å¯†é’¥
    private static final String SECRET_KEY = "mySecretKey123";
    
    public String encrypt(String data) {
        try {
            // å±é™©ï¼šä½¿ç”¨å¼±åŠ å¯†ç®—æ³•DES
            Cipher cipher = Cipher.getInstance("DES");
            SecretKeySpec keySpec = new SecretKeySpec(SECRET_KEY.getBytes(), "DES");
            cipher.init(Cipher.ENCRYPT_MODE, keySpec);
            
            byte[] encrypted = cipher.doFinal(data.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
        } catch (Exception e) {
            throw new RuntimeException("Encryption failed", e);
        }
    }
    
    public String hash(String data) {
        try {
            // å±é™©ï¼šä½¿ç”¨å¼±å“ˆå¸Œç®—æ³•MD5
            MessageDigest md = MessageDigest.getInstance("MD5");
            byte[] hash = md.digest(data.getBytes());
            return Base64.getEncoder().encodeToString(hash);
        } catch (Exception e) {
            throw new RuntimeException("Hashing failed", e);
        }
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å®‰å…¨çš„åŠ å¯†ç®—æ³•å’Œå¯†é’¥ç®¡ç†
@Service
public class CryptoService {
    private static final String AES_ALGORITHM = "AES/GCM/NoPadding";
    private static final String HASH_ALGORITHM = "SHA-256";
    private static final int GCM_IV_LENGTH = 12;
    private static final int GCM_TAG_LENGTH = 16;
    
    @Value("${app.encryption.key-alias}")
    private String keyAlias;
    
    @Autowired
    private KeyManagementService keyManagementService;
    
    public EncryptionResult encrypt(String data) {
        try {
            // å®‰å…¨ï¼šä»å¯†é’¥ç®¡ç†æœåŠ¡è·å–å¯†é’¥
            SecretKey secretKey = keyManagementService.getKey(keyAlias);
            
            // å®‰å…¨ï¼šä½¿ç”¨AES-GCMæ¨¡å¼
            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);
            
            // å®‰å…¨ï¼šç”ŸæˆéšæœºIV
            byte[] iv = generateSecureRandom(GCM_IV_LENGTH);
            GCMParameterSpec gcmSpec = new GCMParameterSpec(GCM_TAG_LENGTH * 8, iv);
            cipher.init(Cipher.ENCRYPT_MODE, secretKey, gcmSpec);
            
            byte[] encrypted = cipher.doFinal(data.getBytes(StandardCharsets.UTF_8));
            
            return new EncryptionResult(encrypted, iv);
        } catch (Exception e) {
            throw new CryptoException("Encryption failed", e);
        }
    }
    
    public String decrypt(EncryptionResult encryptionResult) {
        try {
            SecretKey secretKey = keyManagementService.getKey(keyAlias);
            
            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);
            GCMParameterSpec gcmSpec = new GCMParameterSpec(GCM_TAG_LENGTH * 8, encryptionResult.getIv());
            cipher.init(Cipher.DECRYPT_MODE, secretKey, gcmSpec);
            
            byte[] decrypted = cipher.doFinal(encryptionResult.getEncryptedData());
            return new String(decrypted, StandardCharsets.UTF_8);
        } catch (Exception e) {
            throw new CryptoException("Decryption failed", e);
        }
    }
    
    public String hash(String data, String salt) {
        try {
            // å®‰å…¨ï¼šä½¿ç”¨SHA-256å“ˆå¸Œç®—æ³•
            MessageDigest digest = MessageDigest.getInstance(HASH_ALGORITHM);
            digest.update(salt.getBytes(StandardCharsets.UTF_8));
            byte[] hash = digest.digest(data.getBytes(StandardCharsets.UTF_8));
            
            return Base64.getEncoder().encodeToString(hash);
        } catch (Exception e) {
            throw new CryptoException("Hashing failed", e);
        }
    }
    
    private byte[] generateSecureRandom(int length) {
        // å®‰å…¨ï¼šä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
        SecureRandom secureRandom = new SecureRandom();
        byte[] randomBytes = new byte[length];
        secureRandom.nextBytes(randomBytes);
        return randomBytes;
    }
}

// âœ… æ­£ç¡®ï¼šå¯†é’¥ç®¡ç†æœåŠ¡
@Service
public class KeyManagementService {
    @Value("${app.encryption.key-store-path}")
    private String keyStorePath;
    
    @Value("${app.encryption.key-store-password}")
    private String keyStorePassword;
    
    public SecretKey getKey(String alias) {
        try {
            // å®‰å…¨ï¼šä»å¯†é’¥åº“è·å–å¯†é’¥
            KeyStore keyStore = KeyStore.getInstance("JCEKS");
            keyStore.load(new FileInputStream(keyStorePath), keyStorePassword.toCharArray());
            
            return (SecretKey) keyStore.getKey(alias, keyStorePassword.toCharArray());
        } catch (Exception e) {
            throw new KeyManagementException("Failed to retrieve key: " + alias, e);
        }
    }
    
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void rotateKeys() {
        // å®‰å…¨ï¼šå®šæœŸè½®æ¢å¯†é’¥
        log.info("Starting key rotation process");
        // å®ç°å¯†é’¥è½®æ¢é€»è¾‘
    }
}
```

**ç¬¬å››åäºŒæ¡** é€šä¿¡å®‰å…¨æ£€æŸ¥ ğŸ”´ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿ç½‘ç»œé€šä¿¡å®‰å…¨ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²å’Œç¯¡æ”¹

**æ£€æµ‹æ ‡å‡†ï¼š**
- å¿…é¡»ä½¿ç”¨HTTPSè¿›è¡Œå¤–éƒ¨é€šä¿¡
- SSL/TLSè¯ä¹¦å¿…é¡»æœ‰æ•ˆä¸”æ­£ç¡®é…ç½®
- å¿…é¡»å®ç°CSRFé˜²æŠ¤æœºåˆ¶
- å¿…é¡»è®¾ç½®å®‰å…¨çš„HTTPå¤´éƒ¨
- æ•æ„Ÿæ•°æ®ä¼ è¾“å¿…é¡»åŠ å¯†
- APIæ¥å£å¿…é¡»å®ç°è®¿é—®é¢‘ç‡é™åˆ¶
- å¿…é¡»éªŒè¯SSLè¯ä¹¦é“¾

**æ£€æµ‹æ–¹æ³•ï¼š**
- SSLé…ç½®æ£€æŸ¥ï¼šéªŒè¯SSL/TLSé…ç½®
- å®‰å…¨å¤´éƒ¨æ£€æŸ¥ï¼šç¡®è®¤å®‰å…¨HTTPå¤´éƒ¨è®¾ç½®
- CSRFæµ‹è¯•ï¼šéªŒè¯CSRFé˜²æŠ¤æœºåˆ¶
- è¯ä¹¦éªŒè¯ï¼šæ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæ€§

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä¸å®‰å…¨çš„HTTPé€šä¿¡
@RestController
public class ApiController {
    @PostMapping("/api/transfer")
    public ResponseEntity<String> transfer(@RequestBody TransferRequest request) {
        // å±é™©ï¼šæ²¡æœ‰CSRFé˜²æŠ¤
        // å±é™©ï¼šæ•æ„Ÿæ“ä½œæ²¡æœ‰é¢å¤–éªŒè¯
        transferService.transfer(request.getFromAccount(), 
                               request.getToAccount(), 
                               request.getAmount());
        return ResponseEntity.ok("Transfer completed");
    }
}

// âŒ é”™è¯¯ï¼šä¸å®‰å…¨çš„HTTPå®¢æˆ·ç«¯é…ç½®
@Service
public class ExternalApiService {
    private final RestTemplate restTemplate;
    
    public ExternalApiService() {
        // å±é™©ï¼šç¦ç”¨SSLéªŒè¯
        TrustManager[] trustAllCerts = new TrustManager[] {
            new X509TrustManager() {
                public X509Certificate[] getAcceptedIssuers() { return null; }
                public void checkClientTrusted(X509Certificate[] certs, String authType) {}
                public void checkServerTrusted(X509Certificate[] certs, String authType) {}
            }
        };
        
        try {
            SSLContext sc = SSLContext.getInstance("SSL");
            sc.init(null, trustAllCerts, new java.security.SecureRandom());
            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());
            HttpsURLConnection.setDefaultHostnameVerifier((hostname, session) -> true);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
        
        this.restTemplate = new RestTemplate();
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„HTTPSé…ç½®
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
            .requiresChannel(channel -> 
                channel.requestMatchers(r -> r.getHeader("X-Forwarded-Proto") != null)
                       .requiresSecure())
            .headers(headers -> headers
                .frameOptions().deny()
                .contentTypeOptions().and()
                .httpStrictTransportSecurity(hstsConfig -> hstsConfig
                    .maxAgeInSeconds(31536000)
                    .includeSubdomains(true)
                    .preload(true))
                .and()
                .sessionManagement(session -> session
                    .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                    .maximumSessions(1)
                    .maxSessionsPreventsLogin(false))
            )
            .csrf(csrf -> csrf
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
                .ignoringRequestMatchers("/api/public/**")
            )
            .build();
    }
}

// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„APIæ§åˆ¶å™¨
@RestController
@RequestMapping("/api")
public class SecureApiController {
    
    @PostMapping("/transfer")
    @PreAuthorize("hasRole('USER')")
    @RateLimited(maxRequests = 10, timeWindow = "1m")
    public ResponseEntity<TransferResponse> transfer(
            @Valid @RequestBody TransferRequest request,
            @RequestHeader("X-CSRF-TOKEN") String csrfToken,
            Authentication authentication) {
        
        // å®‰å…¨ï¼šéªŒè¯CSRFä»¤ç‰Œ
        if (!csrfTokenService.isValidToken(csrfToken)) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).build();
        }
        
        // å®‰å…¨ï¼šéªŒè¯ç”¨æˆ·æƒé™
        if (!transferService.hasTransferPermission(authentication.getName(), 
                                                  request.getFromAccount())) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).build();
        }
        
        // å®‰å…¨ï¼šæ•æ„Ÿæ“ä½œå®¡è®¡æ—¥å¿—
        auditService.logTransferAttempt(authentication.getName(), request);
        
        TransferResult result = transferService.transfer(request);
        
        return ResponseEntity.ok(new TransferResponse(result.getTransactionId()));
    }
}

// âœ… æ­£ç¡®ï¼šå®‰å…¨çš„HTTPå®¢æˆ·ç«¯é…ç½®
@Configuration
public class HttpClientConfig {
    
    @Bean
    public RestTemplate secureRestTemplate() throws Exception {
        // å®‰å…¨ï¼šé…ç½®SSLä¸Šä¸‹æ–‡
        SSLContext sslContext = SSLContextBuilder.create()
            .loadTrustMaterial(null, (certificate, authType) -> false) // ä¸¥æ ¼éªŒè¯è¯ä¹¦
            .build();
        
        // å®‰å…¨ï¼šé…ç½®ä¸»æœºåéªŒè¯
        HostnameVerifier hostnameVerifier = new DefaultHostnameVerifier();
        
        SSLConnectionSocketFactory sslSocketFactory = new SSLConnectionSocketFactory(
            sslContext, hostnameVerifier);
        
        HttpClient httpClient = HttpClients.custom()
            .setSSLSocketFactory(sslSocketFactory)
            .setDefaultRequestConfig(RequestConfig.custom()
                .setConnectTimeout(5000)
                .setSocketTimeout(10000)
                .build())
            .build();
        
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory(httpClient);
        
        RestTemplate restTemplate = new RestTemplate(factory);
        
        // å®‰å…¨ï¼šæ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨è®°å½•æ—¥å¿—
        restTemplate.getInterceptors().add(new LoggingClientHttpRequestInterceptor());
        
        return restTemplate;
    }
}

// âœ… æ­£ç¡®ï¼šè®¿é—®é¢‘ç‡é™åˆ¶
@Component
public class RateLimitingInterceptor implements HandlerInterceptor {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        RateLimited rateLimited = getRateLimitedAnnotation(handler);
        if (rateLimited == null) {
            return true;
        }
        
        String clientId = getClientId(request);
        String key = "rate_limit:" + clientId + ":" + request.getRequestURI();
        
        String currentCount = redisTemplate.opsForValue().get(key);
        if (currentCount == null) {
            redisTemplate.opsForValue().set(key, "1", 
                Duration.parse("PT" + rateLimited.timeWindow()));
            return true;
        }
        
        int count = Integer.parseInt(currentCount);
        if (count >= rateLimited.maxRequests()) {
            response.setStatus(HttpStatus.TOO_MANY_REQUESTS.value());
            response.getWriter().write("Rate limit exceeded");
            return false;
        }
        
        redisTemplate.opsForValue().increment(key);
        return true;
    }
    
    private String getClientId(HttpServletRequest request) {
        // ä¼˜å…ˆä½¿ç”¨è®¤è¯ç”¨æˆ·IDï¼Œå¦åˆ™ä½¿ç”¨IPåœ°å€
        String userId = (String) request.getAttribute("userId");
        return userId != null ? userId : request.getRemoteAddr();
    }
}
```

### 4.11 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥

#### 4.11.1 æ•°æ®åº“æ€§èƒ½æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿æ•°æ®åº“æ“ä½œé«˜æ•ˆï¼Œé¿å…æ€§èƒ½ç“¶é¢ˆã€‚
b. æŸ¥è¯¢æ—¶é—´è¶…è¿‡100msçš„SQLå¿…é¡»ä¼˜åŒ–ã€‚
c. å¿…é¡»ä½¿ç”¨åˆé€‚çš„ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æã€‚
d. æ‰¹é‡æ“ä½œå¿…é¡»ä½¿ç”¨æ‰¹å¤„ç†ï¼Œå•æ¬¡å¤„ç†è®°å½•æ•°ä¸è¶…è¿‡1000æ¡ã€‚
e. å¤§æ•°æ®é‡æŸ¥è¯¢å¿…é¡»åˆ†é¡µï¼Œå•é¡µè®°å½•æ•°ä¸è¶…è¿‡100æ¡ã€‚
f. äº‹åŠ¡æ—¶é—´ä¸è¶…è¿‡5ç§’ï¼Œé¿å…é•¿äº‹åŠ¡ã€‚
g. å¿…é¡»é¿å…N+1æŸ¥è¯¢é—®é¢˜ã€‚
h. è¿æ¥æ± é…ç½®åˆç†ï¼šæœ€å°è¿æ¥æ•°5ï¼Œæœ€å¤§è¿æ¥æ•°20ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æï¼šç›‘æ§æ‰§è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼çš„SQLã€‚
2. æ‰§è¡Œè®¡åˆ’åˆ†æï¼šæ£€æŸ¥SQLæ‰§è¡Œè®¡åˆ’ï¼Œç¡®è®¤ç´¢å¼•ä½¿ç”¨ã€‚
3. æ€§èƒ½æµ‹è¯•ï¼šä½¿ç”¨JMeterç­‰å·¥å…·è¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚
4. æ•°æ®åº“ç›‘æ§ï¼šä½¿ç”¨APMå·¥å…·ç›‘æ§æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šN+1æŸ¥è¯¢é—®é¢˜
@Service
public class OrderService {
    public List<OrderDTO> getOrdersWithItems(Long userId) {
        List<Order> orders = orderRepository.findByUserId(userId);
        List<OrderDTO> result = new ArrayList<>();
        
        for (Order order : orders) {
            OrderDTO dto = new OrderDTO();
            dto.setId(order.getId());
            dto.setAmount(order.getAmount());
            
            // å±é™©ï¼šN+1æŸ¥è¯¢ï¼Œæ¯ä¸ªè®¢å•éƒ½æŸ¥è¯¢ä¸€æ¬¡å•†å“
            List<OrderItem> items = orderItemRepository.findByOrderId(order.getId());
            dto.setItems(items.stream().map(this::toDTO).collect(Collectors.toList()));
            
            result.add(dto);
        }
        return result;
    }
    
    // å±é™©ï¼šæ²¡æœ‰åˆ†é¡µçš„å¤§æ•°æ®é‡æŸ¥è¯¢
    public List<Order> getAllOrders() {
        return orderRepository.findAll(); // å¯èƒ½è¿”å›æ•°ç™¾ä¸‡æ¡è®°å½•
    }
    
    // å±é™©ï¼šé€æ¡æ’å…¥ï¼Œæ€§èƒ½ä½ä¸‹
    @Transactional
    public void batchInsertOrders(List<Order> orders) {
        for (Order order : orders) {
            orderRepository.save(order); // æ¯æ¬¡éƒ½æ‰§è¡Œä¸€æ¬¡SQL
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šä¼˜åŒ–çš„æ•°æ®åº“æ“ä½œ
@Service
public class OrderService {
    
    public List<OrderDTO> getOrdersWithItems(Long userId) {
        // æ­£ç¡®ï¼šä½¿ç”¨JOINæŸ¥è¯¢é¿å…N+1é—®é¢˜
        List<Order> orders = orderRepository.findByUserIdWithItems(userId);
        return orders.stream().map(this::toDTO).collect(Collectors.toList());
    }
    
    public Page<OrderDTO> getOrdersPaged(Long userId, Pageable pageable) {
        // æ­£ç¡®ï¼šåˆ†é¡µæŸ¥è¯¢
        Page<Order> orders = orderRepository.findByUserId(userId, pageable);
        return orders.map(this::toDTO);
    }
    
    @Transactional
    public void batchInsertOrders(List<Order> orders) {
        // æ­£ç¡®ï¼šæ‰¹é‡æ’å…¥ï¼Œæé«˜æ€§èƒ½
        int batchSize = 1000;
        for (int i = 0; i < orders.size(); i += batchSize) {
            int end = Math.min(i + batchSize, orders.size());
            List<Order> batch = orders.subList(i, end);
            orderRepository.saveAll(batch);
            orderRepository.flush(); // å¼ºåˆ¶æ‰§è¡ŒSQL
        }
    }
    
    @Cacheable(value = "orderStats", key = "#userId")
    public OrderStats getOrderStats(Long userId) {
        // æ­£ç¡®ï¼šç¼“å­˜è®¡ç®—ç»“æœ
        return orderRepository.calculateOrderStats(userId);
    }
}

// âœ… æ­£ç¡®ï¼šä¼˜åŒ–çš„Repository
@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    @Query("SELECT o FROM Order o JOIN FETCH o.items WHERE o.userId = :userId")
    List<Order> findByUserIdWithItems(@Param("userId") Long userId);
    
    @Query(value = "SELECT * FROM orders WHERE user_id = :userId ORDER BY created_at DESC",
           countQuery = "SELECT count(*) FROM orders WHERE user_id = :userId",
           nativeQuery = true)
    Page<Order> findByUserId(@Param("userId") Long userId, Pageable pageable);
    
    @Query("SELECT new com.example.dto.OrderStats(COUNT(o), SUM(o.amount), AVG(o.amount)) " +
           "FROM Order o WHERE o.userId = :userId")
    OrderStats calculateOrderStats(@Param("userId") Long userId);
}
```

#### 4.11.2 ç¼“å­˜ç­–ç•¥æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. åˆç†ä½¿ç”¨ç¼“å­˜æå‡ç³»ç»Ÿæ€§èƒ½ã€‚
b. çƒ­ç‚¹æ•°æ®å¿…é¡»ä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¸ä½äº80%ã€‚
c. ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®åˆç†ï¼šçƒ­ç‚¹æ•°æ®1å°æ—¶ï¼Œä¸€èˆ¬æ•°æ®30åˆ†é’Ÿã€‚
d. å¿…é¡»é˜²æ­¢ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ã€‚
e. ç¼“å­˜ä¸æ•°æ®åº“ä¸€è‡´æ€§ç­–ç•¥æ˜ç¡®ã€‚
f. ç¼“å­˜å¤§å°é…ç½®åˆç†ï¼Œå†…å­˜ä½¿ç”¨ç‡ä¸è¶…è¿‡80%ã€‚
g. å¿…é¡»æœ‰ç¼“å­˜ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§ï¼šç»Ÿè®¡ç¼“å­˜å‘½ä¸­ç‡æŒ‡æ ‡ã€‚
2. æ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼šå¯¹æ¯”ä½¿ç”¨ç¼“å­˜å‰åçš„æ€§èƒ½å·®å¼‚ã€‚
3. ä¸€è‡´æ€§æµ‹è¯•ï¼šéªŒè¯ç¼“å­˜ä¸æ•°æ®åº“æ•°æ®ä¸€è‡´æ€§ã€‚
4. å‹åŠ›æµ‹è¯•ï¼šéªŒè¯ç¼“å­˜åœ¨é«˜å¹¶å‘ä¸‹çš„è¡¨ç°ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç¼“å­˜ä½¿ç”¨ä¸å½“
@Service
public class ProductService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public Product getProduct(Long id) {
        String key = "product:" + id;
        Product product = (Product) redisTemplate.opsForValue().get(key);
        
        if (product == null) {
            // å±é™©ï¼šç¼“å­˜ç©¿é€ï¼Œæ²¡æœ‰é˜²æŠ¤æœºåˆ¶
            product = productRepository.findById(id).orElse(null);
            if (product != null) {
                // å±é™©ï¼šæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´
                redisTemplate.opsForValue().set(key, product);
            }
        }
        return product;
    }
    
    // å±é™©ï¼šç¼“å­˜é›ªå´©é£é™©ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸ
    public List<Product> getHotProducts() {
        String key = "hot_products";
        List<Product> products = (List<Product>) redisTemplate.opsForValue().get(key);
        
        if (products == null) {
            products = productRepository.findHotProducts();
            // å±é™©ï¼šå›ºå®šè¿‡æœŸæ—¶é—´ï¼Œå¯èƒ½å¯¼è‡´ç¼“å­˜é›ªå´©
            redisTemplate.opsForValue().set(key, products, Duration.ofHours(1));
        }
        return products;
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œå–„çš„ç¼“å­˜ç­–ç•¥
@Service
public class ProductService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private DistributedLock distributedLock;
    
    private static final String NULL_VALUE = "NULL";
    private static final Duration CACHE_TIMEOUT = Duration.ofMinutes(30);
    private static final Duration NULL_CACHE_TIMEOUT = Duration.ofMinutes(5);
    
    public Product getProduct(Long id) {
        String key = "product:" + id;
        Object cached = redisTemplate.opsForValue().get(key);
        
        // æ­£ç¡®ï¼šé˜²æ­¢ç¼“å­˜ç©¿é€
        if (NULL_VALUE.equals(cached)) {
            return null;
        }
        
        if (cached != null) {
            return (Product) cached;
        }
        
        // æ­£ç¡®ï¼šé˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼Œä½¿ç”¨åˆ†å¸ƒå¼é”
        String lockKey = "lock:product:" + id;
        if (distributedLock.tryLock(lockKey, Duration.ofSeconds(10))) {
            try {
                // åŒé‡æ£€æŸ¥
                cached = redisTemplate.opsForValue().get(key);
                if (cached != null) {
                    return NULL_VALUE.equals(cached) ? null : (Product) cached;
                }
                
                Product product = productRepository.findById(id).orElse(null);
                
                if (product != null) {
                    // æ­£ç¡®ï¼šè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´é˜²æ­¢ç¼“å­˜é›ªå´©
                    Duration timeout = CACHE_TIMEOUT.plusMinutes(ThreadLocalRandom.current().nextInt(10));
                    redisTemplate.opsForValue().set(key, product, timeout);
                } else {
                    // æ­£ç¡®ï¼šç¼“å­˜ç©ºå€¼é˜²æ­¢ç¼“å­˜ç©¿é€
                    redisTemplate.opsForValue().set(key, NULL_VALUE, NULL_CACHE_TIMEOUT);
                }
                
                return product;
            } finally {
                distributedLock.unlock(lockKey);
            }
        } else {
            // è·å–é”å¤±è´¥ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“
            return productRepository.findById(id).orElse(null);
        }
    }
    
    @CacheEvict(value = "products", allEntries = true)
    public Product updateProduct(Product product) {
        Product updated = productRepository.save(product);
        
        // æ­£ç¡®ï¼šæ›´æ–°ç¼“å­˜ä¿æŒä¸€è‡´æ€§
        String key = "product:" + product.getId();
        Duration timeout = CACHE_TIMEOUT.plusMinutes(ThreadLocalRandom.current().nextInt(10));
        redisTemplate.opsForValue().set(key, updated, timeout);
        
        return updated;
    }
    
    @Cacheable(value = "hotProducts", unless = "#result.isEmpty()")
    public List<Product> getHotProducts() {
        return productRepository.findHotProducts();
    }
}

// âœ… æ­£ç¡®ï¼šç¼“å­˜é…ç½®
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()))
            .disableCachingNullValues();
        
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(config)
            .transactionAware()
            .build();
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // æ­£ç¡®ï¼šé…ç½®åºåˆ—åŒ–å™¨
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        template.afterPropertiesSet();
        return template;
    }
}
```

### 4.12 å¾®æœåŠ¡ç›¸å…³æ£€æŸ¥

#### 4.12.1 æœåŠ¡æ‹†åˆ†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿å¾®æœåŠ¡æ¶æ„è®¾è®¡åˆç†ï¼ŒæœåŠ¡è¾¹ç•Œæ¸…æ™°ã€‚
b. å•ä¸ªæœåŠ¡ä»£ç é‡ä¸è¶…è¿‡10ä¸‡è¡Œï¼Œå›¢é˜Ÿè§„æ¨¡ä¸è¶…è¿‡8äººã€‚
c. æœåŠ¡èŒè´£å•ä¸€ï¼Œç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ã€‚
d. æœåŠ¡é—´è€¦åˆåº¦ä½ï¼Œå†…èšåº¦é«˜ã€‚
e. é¿å…åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¼˜å…ˆä½¿ç”¨Sagaæ¨¡å¼æˆ–æœ€ç»ˆä¸€è‡´æ€§ã€‚
f. æ•°æ®åº“æŒ‰æœåŠ¡æ‹†åˆ†ï¼Œé¿å…è·¨æœåŠ¡ç›´æ¥è®¿é—®æ•°æ®åº“ã€‚
g. APIè®¾è®¡éµå¾ªRESTfulè§„èŒƒã€‚
h. æœåŠ¡é—´é€šä¿¡å»¶è¿Ÿä¸è¶…è¿‡100msã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. ä»£ç é‡ç»Ÿè®¡ï¼šä½¿ç”¨SonarQubeç­‰å·¥å…·ç»Ÿè®¡ä»£ç è¡Œæ•°ã€‚
2. ä¾èµ–å…³ç³»åˆ†æï¼šæ£€æŸ¥æœåŠ¡é—´ä¾èµ–å…³ç³»å›¾ã€‚
3. æ•°æ®åº“è®¿é—®å®¡è®¡ï¼šç¡®è®¤æ•°æ®è®¿é—®è¾¹ç•Œã€‚
4. æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•æœåŠ¡é—´é€šä¿¡å»¶è¿Ÿã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæœåŠ¡èŒè´£ä¸æ¸…æ™°ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™
@RestController
@RequestMapping("/api")
public class MegaServiceController {
    
    @Autowired
    private UserService userService;
    @Autowired
    private OrderService orderService;
    @Autowired
    private PaymentService paymentService;
    @Autowired
    private InventoryService inventoryService;
    @Autowired
    private NotificationService notificationService;
    
    // å±é™©ï¼šä¸€ä¸ªæœåŠ¡å¤„ç†å¤šä¸ªä¸šåŠ¡åŸŸ
    @PostMapping("/process-order")
    public ResponseEntity<String> processOrder(@RequestBody OrderRequest request) {
        // ç”¨æˆ·ç®¡ç†
        User user = userService.validateUser(request.getUserId());
        
        // è®¢å•ç®¡ç†
        Order order = orderService.createOrder(request);
        
        // åº“å­˜ç®¡ç†
        inventoryService.reserveItems(request.getItems());
        
        // æ”¯ä»˜å¤„ç†
        Payment payment = paymentService.processPayment(request.getPaymentInfo());
        
        // é€šçŸ¥æœåŠ¡
        notificationService.sendOrderConfirmation(user.getEmail(), order);
        
        return ResponseEntity.ok("Order processed");
    }
    
    // å±é™©ï¼šç›´æ¥è®¿é—®å…¶ä»–æœåŠ¡çš„æ•°æ®åº“
    @GetMapping("/user-orders/{userId}")
    public List<Order> getUserOrders(@PathVariable Long userId) {
        // å±é™©ï¼šè·¨æœåŠ¡ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
        return jdbcTemplate.query(
            "SELECT * FROM order_service.orders WHERE user_id = ?",
            new Object[]{userId},
            new OrderRowMapper());
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šèŒè´£å•ä¸€çš„è®¢å•æœåŠ¡
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping
    public ResponseEntity<OrderResponse> createOrder(@Valid @RequestBody CreateOrderRequest request) {
        OrderResponse response = orderService.createOrder(request);
        return ResponseEntity.ok(response);
    }
    
    @GetMapping("/{orderId}")
    public ResponseEntity<OrderResponse> getOrder(@PathVariable Long orderId) {
        OrderResponse response = orderService.getOrder(orderId);
        return ResponseEntity.ok(response);
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨Sagaæ¨¡å¼å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡
@Service
public class OrderSagaService {
    
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private EventPublisher eventPublisher;
    
    public OrderResponse createOrder(CreateOrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        Order order = new Order(request);
        order.setStatus(OrderStatus.PENDING);
        order = orderRepository.save(order);
        
        // 2. å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶ï¼Œè§¦å‘åç»­æ­¥éª¤
        OrderCreatedEvent event = new OrderCreatedEvent(
            order.getId(),
            request.getUserId(),
            request.getItems(),
            request.getPaymentInfo()
        );
        eventPublisher.publish(event);
        
        return new OrderResponse(order);
    }
}
```

**ç¬¬äº”åäºŒæ¡** æœåŠ¡é€šä¿¡æ£€æŸ¥ ğŸŸ¡ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿æœåŠ¡é—´é€šä¿¡é«˜æ•ˆå¯é 

**æ£€æµ‹æ ‡å‡†ï¼š**
- åŒæ­¥è°ƒç”¨å“åº”æ—¶é—´ä¸è¶…è¿‡100msï¼Œè¶…æ—¶æ—¶é—´è®¾ç½®ä¸º3ç§’
- å¼‚æ­¥æ¶ˆæ¯å¤„ç†å»¶è¿Ÿä¸è¶…è¿‡1ç§’
- ä½¿ç”¨é«˜æ•ˆåºåˆ—åŒ–åè®®ï¼ˆå¦‚Protobufã€Avroï¼‰
- å®ç°åˆç†çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
- æœåŠ¡å‘ç°æ³¨å†Œæ—¶é—´ä¸è¶…è¿‡30ç§’
- é€šä¿¡å¤±è´¥é‡è¯•æ¬¡æ•°ä¸è¶…è¿‡3æ¬¡

**æ£€æµ‹æ–¹æ³•ï¼š**
- æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•æœåŠ¡é—´è°ƒç”¨å»¶è¿Ÿ
- åºåˆ—åŒ–æ€§èƒ½æµ‹è¯•ï¼šå¯¹æ¯”ä¸åŒåºåˆ—åŒ–æ–¹å¼çš„æ€§èƒ½
- è´Ÿè½½å‡è¡¡æµ‹è¯•ï¼šéªŒè¯è¯·æ±‚åˆ†å‘ç­–ç•¥
- æ•…éšœæ³¨å…¥æµ‹è¯•ï¼šæµ‹è¯•é€šä¿¡å¤±è´¥å¤„ç†

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä½æ•ˆçš„æœåŠ¡é€šä¿¡
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public OrderResponse createOrder(CreateOrderRequest request) {
        // å±é™©ï¼šåŒæ­¥è°ƒç”¨é“¾è¿‡é•¿ï¼Œå®¹æ˜“è¶…æ—¶
        UserResponse user = restTemplate.getForObject(
            "http://user-service/api/users/" + request.getUserId(),
            UserResponse.class);
        
        InventoryResponse inventory = restTemplate.postForObject(
            "http://inventory-service/api/inventory/reserve",
            request.getItems(),
            InventoryResponse.class);
        
        PaymentResponse payment = restTemplate.postForObject(
            "http://payment-service/api/payments",
            request.getPaymentInfo(),
            PaymentResponse.class);
        
        // å±é™©ï¼šæ²¡æœ‰é”™è¯¯å¤„ç†ï¼Œä»»ä½•ä¸€ä¸ªæœåŠ¡å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªæµç¨‹å¤±è´¥
        Order order = new Order(request, user, inventory, payment);
        return orderRepository.save(order);
    }
}

// âŒ é”™è¯¯ï¼šä½æ•ˆçš„åºåˆ—åŒ–
@RestController
public class ProductController {
    
    @GetMapping("/products")
    public ResponseEntity<String> getProducts() {
        List<Product> products = productService.getAllProducts();
        
        // å±é™©ï¼šä½¿ç”¨JavaåŸç”Ÿåºåˆ—åŒ–ï¼Œæ•ˆç‡ä½ä¸‹
        try {
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(baos);
            oos.writeObject(products);
            
            String result = Base64.getEncoder().encodeToString(baos.toByteArray());
            return ResponseEntity.ok(result);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„æœåŠ¡é€šä¿¡
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private EventPublisher eventPublisher;
    
    public OrderResponse createOrder(CreateOrderRequest request) {
        // æ­£ç¡®ï¼šå…ˆåˆ›å»ºè®¢å•ï¼Œå†å¼‚æ­¥å¤„ç†å…¶ä»–æ­¥éª¤
        Order order = new Order(request);
        order.setStatus(OrderStatus.PENDING);
        order = orderRepository.save(order);
        
        // å¼‚æ­¥å‘å¸ƒäº‹ä»¶
        OrderCreatedEvent event = new OrderCreatedEvent(order.getId(), request);
        eventPublisher.publishAsync(event);
        
        return new OrderResponse(order);
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨Feignå®¢æˆ·ç«¯è¿›è¡ŒæœåŠ¡è°ƒç”¨
@FeignClient(name = "user-service", 
             fallback = UserServiceFallback.class,
             configuration = FeignConfig.class)
public interface UserServiceClient {
    
    @GetMapping("/api/users/{userId}")
    UserResponse getUser(@PathVariable("userId") Long userId);
}

@Component
public class UserServiceFallback implements UserServiceClient {
    
    @Override
    public UserResponse getUser(Long userId) {
        // é™çº§å¤„ç†
        return UserResponse.builder()
            .id(userId)
            .name("Unknown User")
            .build();
    }
}

// âœ… æ­£ç¡®ï¼šé«˜æ•ˆçš„JSONåºåˆ—åŒ–é…ç½®
@Configuration
public class JacksonConfig {
    
    @Bean
    @Primary
    public ObjectMapper objectMapper() {
        return JsonMapper.builder()
            .addModule(new JavaTimeModule())
            .disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)
            .disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)
            .build();
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥é€šä¿¡
@Component
public class OrderEventHandler {
    
    @RabbitListener(queues = "order.created")
    public void handleOrderCreated(OrderCreatedEvent event) {
        // å¼‚æ­¥å¤„ç†è®¢å•åˆ›å»ºåçš„ä¸šåŠ¡é€»è¾‘
        inventoryService.reserveItems(event.getOrderId(), event.getItems());
    }
    
    @RabbitListener(queues = "inventory.reserved")
    public void handleInventoryReserved(InventoryReservedEvent event) {
        // åº“å­˜é¢„ç•™æˆåŠŸåå¤„ç†æ”¯ä»˜
        paymentService.processPayment(event.getOrderId(), event.getPaymentInfo());
    }
}
```

**ç¬¬äº”åä¸‰æ¡** åˆ†å¸ƒå¼äº‹åŠ¡æ£€æŸ¥ ğŸ”´ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ•°æ®ä¸€è‡´æ€§

**æ£€æµ‹æ ‡å‡†ï¼š**
- é¿å…ä½¿ç”¨2PCç­‰å¼ºä¸€è‡´æ€§äº‹åŠ¡ï¼Œä¼˜å…ˆä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§
- æ¯ä¸ªä¸šåŠ¡æ“ä½œå¿…é¡»å…·å¤‡å¹‚ç­‰æ€§
- è¡¥å¿æ“ä½œå¿…é¡»å¯é æ‰§è¡Œ
- äº‹åŠ¡çŠ¶æ€å¿…é¡»å¯è¿½è¸ªå’Œç›‘æ§
- Sagaäº‹åŠ¡æ­¥éª¤ä¸è¶…è¿‡10ä¸ª
- äº‹åŠ¡è¶…æ—¶æ—¶é—´ä¸è¶…è¿‡30ç§’

**æ£€æµ‹æ–¹æ³•ï¼š**
- å¹‚ç­‰æ€§æµ‹è¯•ï¼šé‡å¤æ‰§è¡Œæ“ä½œéªŒè¯ç»“æœä¸€è‡´æ€§
- è¡¥å¿æµ‹è¯•ï¼šæ¨¡æ‹Ÿå¤±è´¥åœºæ™¯éªŒè¯è¡¥å¿æœºåˆ¶
- ä¸€è‡´æ€§æµ‹è¯•ï¼šéªŒè¯æœ€ç»ˆæ•°æ®ä¸€è‡´æ€§
- æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ€§èƒ½

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡
@Service
@Transactional
public class OrderProcessService {
    
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    // å±é™©ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå®¹æ˜“å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
    public void processOrder(OrderRequest request) {
        // æœ¬åœ°äº‹åŠ¡
        Order order = new Order(request);
        orderRepository.save(order);
        
        try {
            // è¿œç¨‹è°ƒç”¨1
            paymentServiceClient.processPayment(request.getPaymentInfo());
            
            // è¿œç¨‹è°ƒç”¨2
            inventoryServiceClient.reserveItems(request.getItems());
            
        } catch (Exception e) {
            // å±é™©ï¼šå›æ»šå›°éš¾ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
            throw new RuntimeException("Order processing failed", e);
        }
    }
}

// âŒ é”™è¯¯ï¼šéå¹‚ç­‰æ“ä½œ
@Service
public class PaymentService {
    
    public PaymentResponse processPayment(PaymentRequest request) {
        // å±é™©ï¼šæ²¡æœ‰å¹‚ç­‰æ€§æ£€æŸ¥ï¼Œé‡å¤è°ƒç”¨ä¼šé‡å¤æ‰£æ¬¾
        Account account = accountRepository.findById(request.getAccountId());
        account.setBalance(account.getBalance().subtract(request.getAmount()));
        accountRepository.save(account);
        
        Payment payment = new Payment(request);
        return paymentRepository.save(payment);
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨Sagaæ¨¡å¼å®ç°åˆ†å¸ƒå¼äº‹åŠ¡
@Service
public class OrderSaga {
    
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private SagaManager sagaManager;
    
    public void processOrder(OrderRequest request) {
        // åˆ›å»ºSagaå®ä¾‹
        Saga saga = Saga.builder()
            .addStep("createOrder", this::createOrder, this::cancelOrder)
            .addStep("reserveInventory", this::reserveInventory, this::releaseInventory)
            .addStep("processPayment", this::processPayment, this::refundPayment)
            .addStep("confirmOrder", this::confirmOrder, this::rejectOrder)
            .build();
        
        sagaManager.execute(saga, request);
    }
    
    // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
    public OrderStepResult createOrder(OrderRequest request) {
        Order order = new Order(request);
        order.setStatus(OrderStatus.PENDING);
        order = orderRepository.save(order);
        
        return OrderStepResult.success(order.getId());
    }
    
    // è¡¥å¿1ï¼šå–æ¶ˆè®¢å•
    public void cancelOrder(Long orderId) {
        Order order = orderRepository.findById(orderId).orElse(null);
        if (order != null) {
            order.setStatus(OrderStatus.CANCELLED);
            orderRepository.save(order);
        }
    }
    
    // æ­¥éª¤2ï¼šé¢„ç•™åº“å­˜
    public OrderStepResult reserveInventory(OrderRequest request) {
        InventoryReservationRequest reservationRequest = 
            new InventoryReservationRequest(request.getOrderId(), request.getItems());
        
        InventoryReservationResponse response = 
            inventoryServiceClient.reserveItems(reservationRequest);
        
        return response.isSuccess() ? 
            OrderStepResult.success(response.getReservationId()) :
            OrderStepResult.failure(response.getErrorMessage());
    }
    
    // è¡¥å¿2ï¼šé‡Šæ”¾åº“å­˜
    public void releaseInventory(String reservationId) {
        inventoryServiceClient.releaseReservation(reservationId);
    }
}

// âœ… æ­£ç¡®ï¼šå¹‚ç­‰æ€§æ“ä½œ
@Service
public class PaymentService {
    
    @Autowired
    private PaymentRepository paymentRepository;
    @Autowired
    private AccountRepository accountRepository;
    
    public PaymentResponse processPayment(PaymentRequest request) {
        // æ­£ç¡®ï¼šå¹‚ç­‰æ€§æ£€æŸ¥
        String idempotencyKey = request.getIdempotencyKey();
        Payment existingPayment = paymentRepository.findByIdempotencyKey(idempotencyKey);
        
        if (existingPayment != null) {
            // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›ç»“æœ
            return new PaymentResponse(existingPayment);
        }
        
        // ä½¿ç”¨åˆ†å¸ƒå¼é”ç¡®ä¿å¹¶å‘å®‰å…¨
        String lockKey = "payment:" + request.getAccountId();
        return distributedLock.executeWithLock(lockKey, Duration.ofSeconds(10), () -> {
            
            Account account = accountRepository.findById(request.getAccountId())
                .orElseThrow(() -> new AccountNotFoundException(request.getAccountId()));
            
            if (account.getBalance().compareTo(request.getAmount()) < 0) {
                throw new InsufficientBalanceException();
            }
            
            // æ‰£æ¬¾
            account.setBalance(account.getBalance().subtract(request.getAmount()));
            accountRepository.save(account);
            
            // åˆ›å»ºæ”¯ä»˜è®°å½•
            Payment payment = Payment.builder()
                .idempotencyKey(idempotencyKey)
                .accountId(request.getAccountId())
                .amount(request.getAmount())
                .status(PaymentStatus.SUCCESS)
                .createdAt(Instant.now())
                .build();
            
            payment = paymentRepository.save(payment);
            
            return new PaymentResponse(payment);
        });
    }
}

// âœ… æ­£ç¡®ï¼šäº‹åŠ¡çŠ¶æ€è·Ÿè¸ª
@Entity
public class SagaTransaction {
    
    @Id
    private String sagaId;
    
    @Enumerated(EnumType.STRING)
    private SagaStatus status;
    
    @ElementCollection
    @CollectionTable(name = "saga_steps")
    private List<SagaStep> steps;
    
    private Instant createdAt;
    private Instant updatedAt;
    
    // getters and setters
}

@Embeddable
public class SagaStep {
    private String stepName;
    private SagaStepStatus status;
    private String compensationData;
    private Instant executedAt;
    
    // getters and setters
}
```

### 4.13 å®¹é”™å¤„ç†æ£€æŸ¥

#### 4.13.1 æ•…éšœå¤„ç†æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿ç³»ç»Ÿå…·å¤‡å®Œå–„çš„æ•…éšœå¤„ç†å’Œæ¢å¤èƒ½åŠ›ã€‚
b. æ‰€æœ‰å¤–éƒ¨è°ƒç”¨å¿…é¡»æœ‰è¶…æ—¶è®¾ç½®ï¼Œè¶…æ—¶æ—¶é—´ä¸è¶…è¿‡5ç§’ã€‚
c. å…³é”®ä¸šåŠ¡æµç¨‹å¿…é¡»æœ‰é™çº§æ–¹æ¡ˆã€‚
d. æ•…éšœæ¢å¤æ—¶é—´ä¸è¶…è¿‡30ç§’ã€‚
e. æ•…éšœæ£€æµ‹æ—¶é—´ä¸è¶…è¿‡10ç§’ã€‚
f. å¿…é¡»æœ‰å®Œæ•´çš„æ•…éšœç›‘æ§å’Œå‘Šè­¦æœºåˆ¶ã€‚
g. æ•…éšœæ—¥å¿—å¿…é¡»åŒ…å«å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ•…éšœæ³¨å…¥æµ‹è¯•ï¼šæ¨¡æ‹Ÿå„ç§æ•…éšœåœºæ™¯ã€‚
2. è¶…æ—¶æµ‹è¯•ï¼šéªŒè¯è¶…æ—¶è®¾ç½®çš„æœ‰æ•ˆæ€§ã€‚
3. æ¢å¤æµ‹è¯•ï¼šéªŒè¯æ•…éšœæ¢å¤æœºåˆ¶ã€‚
4. ç›‘æ§éªŒè¯ï¼šæ£€æŸ¥ç›‘æ§æŒ‡æ ‡çš„å®Œæ•´æ€§ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šç¼ºä¹æ•…éšœå¤„ç†æœºåˆ¶
@Service
public class OrderService {
    
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    public OrderResponse createOrder(OrderRequest request) {
        // å±é™©ï¼šæ²¡æœ‰è¶…æ—¶è®¾ç½®ï¼Œå¯èƒ½æ— é™ç­‰å¾…
        PaymentResponse payment = paymentServiceClient.processPayment(request.getPaymentInfo());
        
        // å±é™©ï¼šæ²¡æœ‰å¼‚å¸¸å¤„ç†ï¼Œä»»ä½•å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªæµç¨‹ä¸­æ–­
        InventoryResponse inventory = inventoryServiceClient.reserveItems(request.getItems());
        
        Order order = new Order(request, payment, inventory);
        return orderRepository.save(order);
    }
}

// âŒ é”™è¯¯ï¼šæ•…éšœå¤„ç†ä¸å½“
@Service
public class NotificationService {
    
    public void sendNotification(String userId, String message) {
        try {
            // å±é™©ï¼šå¤–éƒ¨æœåŠ¡è°ƒç”¨æ²¡æœ‰è¶…æ—¶æ§åˆ¶
            emailService.sendEmail(userId, message);
        } catch (Exception e) {
            // å±é™©ï¼šç®€å•å¿½ç•¥å¼‚å¸¸ï¼Œæ²¡æœ‰é™çº§å¤„ç†
            log.error("Failed to send email", e);
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå®Œå–„çš„æ•…éšœå¤„ç†æœºåˆ¶
@Service
public class OrderService {
    
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private CircuitBreaker circuitBreaker;
    
    public OrderResponse createOrder(OrderRequest request) {
        try {
            // æ­£ç¡®ï¼šä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤å¤–éƒ¨è°ƒç”¨
            PaymentResponse payment = circuitBreaker.executeSupplier(() -> {
                return paymentServiceClient.processPayment(request.getPaymentInfo());
            });
            
            InventoryResponse inventory = circuitBreaker.executeSupplier(() -> {
                return inventoryServiceClient.reserveItems(request.getItems());
            });
            
            Order order = new Order(request, payment, inventory);
            order.setStatus(OrderStatus.CONFIRMED);
            return new OrderResponse(orderRepository.save(order));
            
        } catch (CallNotPermittedException e) {
            // ç†”æ–­å™¨å¼€å¯æ—¶çš„é™çº§å¤„ç†
            return handleCircuitBreakerOpen(request);
        } catch (TimeoutException e) {
            // è¶…æ—¶å¤„ç†
            return handleTimeout(request);
        } catch (Exception e) {
            // å…¶ä»–å¼‚å¸¸å¤„ç†
            return handleGeneralError(request, e);
        }
    }
    
    private OrderResponse handleCircuitBreakerOpen(OrderRequest request) {
        // é™çº§ç­–ç•¥ï¼šåˆ›å»ºå¾…å¤„ç†è®¢å•
        Order order = new Order(request);
        order.setStatus(OrderStatus.PENDING_PAYMENT);
        order = orderRepository.save(order);
        
        // å‘é€å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œåç»­å¤„ç†
        eventPublisher.publishAsync(new OrderPendingEvent(order.getId()));
        
        return OrderResponse.builder()
            .orderId(order.getId())
            .status(OrderStatus.PENDING_PAYMENT)
            .message("è®¢å•å·²åˆ›å»ºï¼Œæ­£åœ¨å¤„ç†ä¸­")
            .build();
    }
}

// âœ… æ­£ç¡®ï¼šå¸¦æœ‰æ•…éšœæ¢å¤çš„é€šçŸ¥æœåŠ¡
@Service
public class NotificationService {
    
    @Autowired
    private EmailService emailService;
    @Autowired
    private SmsService smsService;
    @Autowired
    private RetryTemplate retryTemplate;
    
    public void sendNotification(String userId, String message) {
        NotificationRequest request = new NotificationRequest(userId, message);
        
        // æ­£ç¡®ï¼šä½¿ç”¨é‡è¯•æœºåˆ¶
        retryTemplate.execute(context -> {
            try {
                // ä¸»è¦é€šçŸ¥æ–¹å¼
                emailService.sendEmail(request);
                return true;
            } catch (EmailServiceException e) {
                // é™çº§åˆ°çŸ­ä¿¡é€šçŸ¥
                log.warn("Email service failed, falling back to SMS", e);
                smsService.sendSms(request);
                return true;
            }
        }, context -> {
            // æœ€ç»ˆå¤±è´¥å¤„ç†
            log.error("All notification methods failed for user: {}", userId);
            // è®°å½•åˆ°å¤±è´¥é˜Ÿåˆ—ï¼Œç¨åé‡è¯•
            failedNotificationQueue.add(request);
            return false;
        });
    }
}
```

**ç¬¬äº”åäº”æ¡** é‡è¯•æœºåˆ¶æ£€æŸ¥ ğŸŸ¡ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿é‡è¯•æœºåˆ¶åˆç†æœ‰æ•ˆ

**æ£€æµ‹æ ‡å‡†ï¼š**
- é‡è¯•æ¬¡æ•°ä¸è¶…è¿‡3æ¬¡ï¼Œé¿å…æ— é™é‡è¯•
- ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•ï¼Œåˆå§‹é—´éš”ä¸å°‘äº100ms
- é‡è¯•æ“ä½œå¿…é¡»å…·å¤‡å¹‚ç­‰æ€§
- å¿…é¡»åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•çš„å¼‚å¸¸
- é‡è¯•è¶…æ—¶æ€»æ—¶é—´ä¸è¶…è¿‡30ç§’
- å¿…é¡»æœ‰é‡è¯•æ¬¡æ•°å’ŒæˆåŠŸç‡çš„ç›‘æ§

**æ£€æµ‹æ–¹æ³•ï¼š**
- é‡è¯•æµ‹è¯•ï¼šéªŒè¯é‡è¯•é€»è¾‘çš„æ­£ç¡®æ€§
- å¹‚ç­‰æ€§æµ‹è¯•ï¼šç¡®ä¿é‡è¯•ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
- æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•é‡è¯•å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“
- å¼‚å¸¸åˆ†ç±»æµ‹è¯•ï¼šéªŒè¯å¼‚å¸¸å¤„ç†çš„å‡†ç¡®æ€§

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šä¸åˆç†çš„é‡è¯•æœºåˆ¶
@Service
public class PaymentService {
    
    public PaymentResponse processPayment(PaymentRequest request) {
        int retryCount = 0;
        while (retryCount < 10) { // å±é™©ï¼šé‡è¯•æ¬¡æ•°è¿‡å¤š
            try {
                return externalPaymentService.pay(request);
            } catch (Exception e) {
                retryCount++;
                // å±é™©ï¼šå›ºå®šé—´éš”é‡è¯•ï¼Œæ²¡æœ‰é€€é¿ç­–ç•¥
                Thread.sleep(1000);
                // å±é™©ï¼šä¸åŒºåˆ†å¼‚å¸¸ç±»å‹ï¼Œæ‰€æœ‰å¼‚å¸¸éƒ½é‡è¯•
            }
        }
        throw new PaymentException("Payment failed after retries");
    }
}

// âŒ é”™è¯¯ï¼šéå¹‚ç­‰çš„é‡è¯•æ“ä½œ
@Service
public class AccountService {
    
    @Retryable(value = Exception.class, maxAttempts = 3)
    public void transferMoney(String fromAccount, String toAccount, BigDecimal amount) {
        // å±é™©ï¼šéå¹‚ç­‰æ“ä½œï¼Œé‡è¯•ä¼šå¯¼è‡´é‡å¤è½¬è´¦
        Account from = accountRepository.findById(fromAccount);
        Account to = accountRepository.findById(toAccount);
        
        from.setBalance(from.getBalance().subtract(amount));
        to.setBalance(to.getBalance().add(amount));
        
        accountRepository.save(from);
        accountRepository.save(to);
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šåˆç†çš„é‡è¯•æœºåˆ¶
@Service
public class PaymentService {
    
    @Autowired
    private ExternalPaymentService externalPaymentService;
    
    @Retryable(
        value = {ConnectException.class, SocketTimeoutException.class},
        exclude = {PaymentValidationException.class, InsufficientFundsException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 100, multiplier = 2, maxDelay = 2000)
    )
    public PaymentResponse processPayment(PaymentRequest request) {
        try {
            return externalPaymentService.pay(request);
        } catch (PaymentValidationException | InsufficientFundsException e) {
            // ä¸å¯é‡è¯•çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
            throw e;
        } catch (Exception e) {
            // è®°å½•é‡è¯•æ—¥å¿—
            log.warn("Payment attempt failed, will retry. Request: {}", request.getId(), e);
            throw e;
        }
    }
    
    @Recover
    public PaymentResponse recover(Exception e, PaymentRequest request) {
        // é‡è¯•å¤±è´¥åçš„æ¢å¤å¤„ç†
        log.error("Payment failed after all retries. Request: {}", request.getId(), e);
        
        return PaymentResponse.builder()
            .requestId(request.getId())
            .status(PaymentStatus.FAILED)
            .errorMessage("æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•")
            .build();
    }
}

// âœ… æ­£ç¡®ï¼šå¹‚ç­‰çš„é‡è¯•æ“ä½œ
@Service
public class AccountService {
    
    @Autowired
    private TransactionRepository transactionRepository;
    @Autowired
    private AccountRepository accountRepository;
    
    @Retryable(
        value = {OptimisticLockingFailureException.class, DataAccessException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 50, multiplier = 1.5)
    )
    public TransferResponse transferMoney(TransferRequest request) {
        String idempotencyKey = request.getIdempotencyKey();
        
        // å¹‚ç­‰æ€§æ£€æŸ¥
        Transaction existingTransaction = transactionRepository.findByIdempotencyKey(idempotencyKey);
        if (existingTransaction != null) {
            return new TransferResponse(existingTransaction);
        }
        
        // ä½¿ç”¨åˆ†å¸ƒå¼é”ç¡®ä¿å¹¶å‘å®‰å…¨
        String lockKey = "transfer:" + request.getFromAccount() + ":" + request.getToAccount();
        return distributedLock.executeWithLock(lockKey, Duration.ofSeconds(5), () -> {
            
            Account fromAccount = accountRepository.findByIdForUpdate(request.getFromAccount());
            Account toAccount = accountRepository.findByIdForUpdate(request.getToAccount());
            
            if (fromAccount.getBalance().compareTo(request.getAmount()) < 0) {
                throw new InsufficientFundsException();
            }
            
            // æ‰§è¡Œè½¬è´¦
            fromAccount.setBalance(fromAccount.getBalance().subtract(request.getAmount()));
            toAccount.setBalance(toAccount.getBalance().add(request.getAmount()));
            
            accountRepository.save(fromAccount);
            accountRepository.save(toAccount);
            
            // è®°å½•äº‹åŠ¡
            Transaction transaction = Transaction.builder()
                .idempotencyKey(idempotencyKey)
                .fromAccount(request.getFromAccount())
                .toAccount(request.getToAccount())
                .amount(request.getAmount())
                .status(TransactionStatus.SUCCESS)
                .createdAt(Instant.now())
                .build();
            
            transaction = transactionRepository.save(transaction);
            
            return new TransferResponse(transaction);
        });
    }
}
```

**ç¬¬äº”åå…­æ¡** ç†”æ–­é™çº§æ£€æŸ¥ ğŸŸ¡ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿ç³»ç»Ÿå…·å¤‡ç†”æ–­ä¿æŠ¤å’Œä¼˜é›…é™çº§èƒ½åŠ›

**æ£€æµ‹æ ‡å‡†ï¼š**
- ç†”æ–­å™¨å¤±è´¥ç‡é˜ˆå€¼è®¾ç½®ä¸º50%ï¼Œæœ€å°è¯·æ±‚æ•°ä¸º10
- ç†”æ–­å™¨å¼€å¯åç­‰å¾…æ—¶é—´ä¸º60ç§’
- å¿…é¡»æœ‰åˆç†çš„é™çº§ç­–ç•¥ï¼Œä¸èƒ½ç®€å•è¿”å›é”™è¯¯
- é™çº§å“åº”æ—¶é—´ä¸è¶…è¿‡100ms
- å¿…é¡»æœ‰ç†”æ–­çŠ¶æ€çš„å®æ—¶ç›‘æ§
- å…³é”®ä¸šåŠ¡æµç¨‹å¿…é¡»æœ‰å¤šçº§é™çº§æ–¹æ¡ˆ

**æ£€æµ‹æ–¹æ³•ï¼š**
- ç†”æ–­æµ‹è¯•ï¼šæ¨¡æ‹Ÿé«˜å¤±è´¥ç‡è§¦å‘ç†”æ–­
- é™çº§æµ‹è¯•ï¼šéªŒè¯é™çº§ç­–ç•¥çš„æœ‰æ•ˆæ€§
- æ¢å¤æµ‹è¯•ï¼šéªŒè¯ç†”æ–­å™¨æ¢å¤æœºåˆ¶
- æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•é™çº§å¯¹æ€§èƒ½çš„å½±å“

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç¼ºä¹ç†”æ–­ä¿æŠ¤
@Service
public class RecommendationService {
    
    @Autowired
    private ExternalRecommendationService externalService;
    
    public List<Product> getRecommendations(String userId) {
        try {
            // å±é™©ï¼šæ²¡æœ‰ç†”æ–­ä¿æŠ¤ï¼Œå¤–éƒ¨æœåŠ¡æ•…éšœä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ
            return externalService.getRecommendations(userId);
        } catch (Exception e) {
            // å±é™©ï¼šç®€å•è¿”å›ç©ºåˆ—è¡¨ï¼Œç”¨æˆ·ä½“éªŒå·®
            log.error("Failed to get recommendations", e);
            return Collections.emptyList();
        }
    }
}

// âŒ é”™è¯¯ï¼šç†”æ–­é…ç½®ä¸å½“
@Component
public class UserServiceClient {
    
    // å±é™©ï¼šå¤±è´¥ç‡é˜ˆå€¼è¿‡é«˜ï¼Œæœ€å°è¯·æ±‚æ•°è¿‡å°‘
    @CircuitBreaker(name = "userService", 
                   fallbackMethod = "fallbackUser",
                   failureRateThreshold = 90,
                   minimumNumberOfCalls = 2)
    public User getUser(String userId) {
        return restTemplate.getForObject("/users/" + userId, User.class);
    }
    
    public User fallbackUser(String userId, Exception e) {
        // å±é™©ï¼šé™çº§ç­–ç•¥è¿‡äºç®€å•
        return new User(userId, "Unknown");
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®Œå–„çš„ç†”æ–­é™çº§æœºåˆ¶
@Service
public class RecommendationService {
    
    @Autowired
    private ExternalRecommendationService externalService;
    @Autowired
    private CacheManager cacheManager;
    @Autowired
    private DefaultRecommendationService defaultService;
    
    @CircuitBreaker(name = "recommendation", fallbackMethod = "fallbackRecommendations")
    @TimeLimiter(name = "recommendation")
    @Retry(name = "recommendation")
    public CompletableFuture<List<Product>> getRecommendations(String userId) {
        return CompletableFuture.supplyAsync(() -> {
            List<Product> recommendations = externalService.getRecommendations(userId);
            
            // ç¼“å­˜æˆåŠŸçš„ç»“æœ
            cacheManager.getCache("recommendations").put(userId, recommendations);
            
            return recommendations;
        });
    }
    
    public CompletableFuture<List<Product>> fallbackRecommendations(String userId, Exception e) {
        return CompletableFuture.supplyAsync(() -> {
            // å¤šçº§é™çº§ç­–ç•¥
            
            // 1. å°è¯•ä»ç¼“å­˜è·å–
            Cache.ValueWrapper cached = cacheManager.getCache("recommendations").get(userId);
            if (cached != null) {
                log.info("Using cached recommendations for user: {}", userId);
                return (List<Product>) cached.get();
            }
            
            // 2. ä½¿ç”¨é»˜è®¤æ¨èç®—æ³•
            List<Product> defaultRecommendations = defaultService.getDefaultRecommendations(userId);
            if (!defaultRecommendations.isEmpty()) {
                log.info("Using default recommendations for user: {}", userId);
                return defaultRecommendations;
            }
            
            // 3. è¿”å›çƒ­é—¨å•†å“
            log.info("Using popular products as fallback for user: {}", userId);
            return defaultService.getPopularProducts();
        });
    }
}

// âœ… æ­£ç¡®ï¼šåˆç†çš„ç†”æ–­å™¨é…ç½®
@Configuration
public class CircuitBreakerConfig {
    
    @Bean
    public CircuitBreakerConfigCustomizer circuitBreakerConfigCustomizer() {
        return CircuitBreakerConfigCustomizer.of("userService", builder -> {
            builder
                .failureRateThreshold(50) // å¤±è´¥ç‡é˜ˆå€¼50%
                .minimumNumberOfCalls(10) // æœ€å°è¯·æ±‚æ•°10
                .slidingWindowSize(20) // æ»‘åŠ¨çª—å£å¤§å°20
                .waitDurationInOpenState(Duration.ofSeconds(60)) // å¼€å¯çŠ¶æ€ç­‰å¾…60ç§’
                .permittedNumberOfCallsInHalfOpenState(5) // åŠå¼€çŠ¶æ€å…è®¸5ä¸ªè¯·æ±‚
                .slowCallRateThreshold(50) // æ…¢è°ƒç”¨ç‡é˜ˆå€¼50%
                .slowCallDurationThreshold(Duration.ofSeconds(2)) // æ…¢è°ƒç”¨æ—¶é—´é˜ˆå€¼2ç§’
                .recordExceptions(IOException.class, TimeoutException.class)
                .ignoreExceptions(ValidationException.class);
        });
    }
}

@Component
public class UserServiceClient {
    
    @Autowired
    private RestTemplate restTemplate;
    @Autowired
    private UserCacheService userCacheService;
    
    @CircuitBreaker(name = "userService", fallbackMethod = "fallbackGetUser")
    @TimeLimiter(name = "userService")
    public CompletableFuture<User> getUser(String userId) {
        return CompletableFuture.supplyAsync(() -> {
            User user = restTemplate.getForObject("/users/" + userId, User.class);
            // ç¼“å­˜æˆåŠŸè·å–çš„ç”¨æˆ·ä¿¡æ¯
            userCacheService.cacheUser(user);
            return user;
        });
    }
    
    public CompletableFuture<User> fallbackGetUser(String userId, Exception e) {
        return CompletableFuture.supplyAsync(() -> {
            log.warn("User service circuit breaker activated for user: {}", userId, e);
            
            // å°è¯•ä»ç¼“å­˜è·å–
            User cachedUser = userCacheService.getCachedUser(userId);
            if (cachedUser != null) {
                cachedUser.setFromCache(true);
                return cachedUser;
            }
            
            // è¿”å›åŸºæœ¬ç”¨æˆ·ä¿¡æ¯
            return User.builder()
                .id(userId)
                .name("ç”¨æˆ·" + userId)
                .status(UserStatus.UNKNOWN)
                .fromCache(false)
                .build();
        });
    }
}
```

**ç¬¬äº”åä¸ƒæ¡** é™æµæ§åˆ¶æ£€æŸ¥ ğŸŸ¡ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿ç³»ç»Ÿå…·å¤‡æœ‰æ•ˆçš„æµé‡æ§åˆ¶èƒ½åŠ›

**æ£€æµ‹æ ‡å‡†ï¼š**
- APIé™æµé˜ˆå€¼è®¾ç½®åˆç†ï¼Œä¸è¶…è¿‡ç³»ç»Ÿæ‰¿è½½èƒ½åŠ›çš„80%
- å¿…é¡»å®ç°å¤šå±‚æ¬¡é™æµï¼ˆå…¨å±€ã€ç”¨æˆ·ã€IPï¼‰
- é™æµç®—æ³•é€‰æ‹©åˆé€‚ï¼ˆä»¤ç‰Œæ¡¶ã€æ»‘åŠ¨çª—å£ç­‰ï¼‰
- é™æµè§¦å‘åæœ‰å‹å¥½çš„é”™è¯¯æç¤º
- é™æµçŠ¶æ€å¿…é¡»æœ‰å®æ—¶ç›‘æ§å’Œå‘Šè­¦
- å…³é”®æ¥å£å¿…é¡»æœ‰ç‹¬ç«‹çš„é™æµé…ç½®

**æ£€æµ‹æ–¹æ³•ï¼š**
- å‹åŠ›æµ‹è¯•ï¼šéªŒè¯é™æµé˜ˆå€¼çš„å‡†ç¡®æ€§
- é™æµæµ‹è¯•ï¼šæµ‹è¯•ä¸åŒé™æµç­–ç•¥çš„æ•ˆæœ
- æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•é™æµå¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“
- ç›‘æ§éªŒè¯ï¼šæ£€æŸ¥é™æµç›‘æ§çš„å®Œæ•´æ€§

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç¼ºä¹é™æµä¿æŠ¤
@RestController
public class OrderController {
    
    @PostMapping("/orders")
    public ResponseEntity<OrderResponse> createOrder(@RequestBody OrderRequest request) {
        // å±é™©ï¼šæ²¡æœ‰é™æµä¿æŠ¤ï¼Œå®¹æ˜“è¢«æ¶æ„è¯·æ±‚æ”»å‡»
        OrderResponse response = orderService.createOrder(request);
        return ResponseEntity.ok(response);
    }
    
    @GetMapping("/orders/export")
    public ResponseEntity<byte[]> exportOrders() {
        // å±é™©ï¼šå¯¼å‡ºæ“ä½œæ²¡æœ‰é™æµï¼Œå¯èƒ½æ¶ˆè€—å¤§é‡èµ„æº
        byte[] data = orderService.exportAllOrders();
        return ResponseEntity.ok(data);
    }
}

// âŒ é”™è¯¯ï¼šé™æµé…ç½®ä¸å½“
@Component
public class SimpleRateLimiter {
    
    private final Map<String, AtomicInteger> counters = new ConcurrentHashMap<>();
    
    public boolean isAllowed(String key) {
        // å±é™©ï¼šç®€å•è®¡æ•°å™¨ï¼Œæ²¡æœ‰æ—¶é—´çª—å£æ¦‚å¿µ
        AtomicInteger counter = counters.computeIfAbsent(key, k -> new AtomicInteger(0));
        return counter.incrementAndGet() <= 100;
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå¤šå±‚æ¬¡é™æµä¿æŠ¤
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping
    @RateLimiter(name = "createOrder", fallbackMethod = "createOrderFallback")
    public ResponseEntity<OrderResponse> createOrder(
            @RequestBody @Valid OrderRequest request,
            HttpServletRequest httpRequest) {
        
        String userId = getCurrentUserId();
        String clientIp = getClientIp(httpRequest);
        
        // å¤šå±‚é™æµæ£€æŸ¥
        rateLimitService.checkGlobalLimit();
        rateLimitService.checkUserLimit(userId);
        rateLimitService.checkIpLimit(clientIp);
        
        OrderResponse response = orderService.createOrder(request);
        return ResponseEntity.ok(response);
    }
    
    public ResponseEntity<OrderResponse> createOrderFallback(OrderRequest request, 
                                                            HttpServletRequest httpRequest,
                                                            Exception e) {
        log.warn("Order creation rate limited for user: {}", getCurrentUserId());
        
        return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)
            .body(OrderResponse.builder()
                .success(false)
                .message("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•")
                .retryAfter(60)
                .build());
    }
    
    @GetMapping("/export")
    @RateLimiter(name = "exportOrders", fallbackMethod = "exportOrdersFallback")
    public ResponseEntity<String> exportOrders() {
        // å¯¼å‡ºæ“ä½œçš„ä¸¥æ ¼é™æµ
        String taskId = orderService.createExportTask();
        
        return ResponseEntity.accepted()
            .body("å¯¼å‡ºä»»åŠ¡å·²åˆ›å»ºï¼Œä»»åŠ¡ID: " + taskId);
    }
    
    public ResponseEntity<String> exportOrdersFallback(Exception e) {
        return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)
            .body("å¯¼å‡ºåŠŸèƒ½ä½¿ç”¨é¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
    }
}

// âœ… æ­£ç¡®ï¼šå®Œå–„çš„é™æµæœåŠ¡
@Service
public class RateLimitService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // å…¨å±€é™æµï¼šä»¤ç‰Œæ¡¶ç®—æ³•
    public void checkGlobalLimit() {
        String key = "rate_limit:global";
        if (!isAllowedByTokenBucket(key, 1000, 100)) {
            throw new RateLimitExceededException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
    
    // ç”¨æˆ·é™æµï¼šæ»‘åŠ¨çª—å£ç®—æ³•
    public void checkUserLimit(String userId) {
        String key = "rate_limit:user:" + userId;
        if (!isAllowedBySlidingWindow(key, 60, 10)) {
            throw new RateLimitExceededException("æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
    
    // IPé™æµï¼šå›ºå®šçª—å£ç®—æ³•
    public void checkIpLimit(String ip) {
        String key = "rate_limit:ip:" + ip;
        if (!isAllowedByFixedWindow(key, 60, 100)) {
            throw new RateLimitExceededException("è¯¥IPè®¿é—®è¿‡äºé¢‘ç¹");
        }
    }
    
    private boolean isAllowedByTokenBucket(String key, int capacity, int refillRate) {
        String script = 
            "local key = KEYS[1]\n" +
            "local capacity = tonumber(ARGV[1])\n" +
            "local refillRate = tonumber(ARGV[2])\n" +
            "local requested = tonumber(ARGV[3])\n" +
            "local now = tonumber(ARGV[4])\n" +
            "\n" +
            "local bucket = redis.call('HMGET', key, 'tokens', 'lastRefill')\n" +
            "local tokens = tonumber(bucket[1]) or capacity\n" +
            "local lastRefill = tonumber(bucket[2]) or now\n" +
            "\n" +
            "local elapsed = now - lastRefill\n" +
            "tokens = math.min(capacity, tokens + elapsed * refillRate / 1000)\n" +
            "\n" +
            "if tokens >= requested then\n" +
            "    tokens = tokens - requested\n" +
            "    redis.call('HMSET', key, 'tokens', tokens, 'lastRefill', now)\n" +
            "    redis.call('EXPIRE', key, 3600)\n" +
            "    return 1\n" +
            "else\n" +
            "    redis.call('HMSET', key, 'tokens', tokens, 'lastRefill', now)\n" +
            "    redis.call('EXPIRE', key, 3600)\n" +
            "    return 0\n" +
            "end";
        
        Long result = redisTemplate.execute(
            RedisScript.of(script, Long.class),
            Collections.singletonList(key),
            String.valueOf(capacity),
            String.valueOf(refillRate),
            "1",
            String.valueOf(System.currentTimeMillis())
        );
        
        return result != null && result == 1;
    }
    
    private boolean isAllowedBySlidingWindow(String key, int windowSeconds, int maxRequests) {
        long now = System.currentTimeMillis();
        long windowStart = now - windowSeconds * 1000;
        
        String script =
            "local key = KEYS[1]\n" +
            "local windowStart = tonumber(ARGV[1])\n" +
            "local now = tonumber(ARGV[2])\n" +
            "local maxRequests = tonumber(ARGV[3])\n" +
            "\n" +
            "redis.call('ZREMRANGEBYSCORE', key, 0, windowStart)\n" +
            "local current = redis.call('ZCARD', key)\n" +
            "\n" +
            "if current < maxRequests then\n" +
            "    redis.call('ZADD', key, now, now)\n" +
            "    redis.call('EXPIRE', key, " + windowSeconds + ")\n" +
            "    return 1\n" +
            "else\n" +
            "    return 0\n" +
            "end";
        
        Long result = redisTemplate.execute(
            RedisScript.of(script, Long.class),
            Collections.singletonList(key),
            String.valueOf(windowStart),
            String.valueOf(now),
            String.valueOf(maxRequests)
        );
        
        return result != null && result == 1;
    }
}

// âœ… æ­£ç¡®ï¼šé™æµé…ç½®
@Configuration
public class RateLimiterConfig {
    
    @Bean
    public RateLimiterConfigCustomizer rateLimiterConfigCustomizer() {
        return RateLimiterConfigCustomizer.of("createOrder", builder -> {
            builder
                .limitForPeriod(10) // æ¯ä¸ªå‘¨æœŸå…è®¸10ä¸ªè¯·æ±‚
                .limitRefreshPeriod(Duration.ofSeconds(1)) // æ¯ç§’åˆ·æ–°
                .timeoutDuration(Duration.ofMillis(100)); // ç­‰å¾…è¶…æ—¶100ms
        }).and(RateLimiterConfigCustomizer.of("exportOrders", builder -> {
            builder
                .limitForPeriod(1) // æ¯ä¸ªå‘¨æœŸå…è®¸1ä¸ªè¯·æ±‚
                .limitRefreshPeriod(Duration.ofMinutes(1)) // æ¯åˆ†é’Ÿåˆ·æ–°
                .timeoutDuration(Duration.ofMillis(50));
        }));
    }
}
```

### 4.14 å¯æ‰©å±•æ€§æ£€æŸ¥

#### 4.14.1 æ°´å¹³æ‰©å±•æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿ç³»ç»Ÿæ”¯æŒæ°´å¹³æ‰©å±•ã€‚
b. æœåŠ¡å¿…é¡»è®¾è®¡ä¸ºæ— çŠ¶æ€ï¼Œä¸ä¾èµ–æœ¬åœ°å­˜å‚¨ã€‚
c. æ”¯æŒè´Ÿè½½å‡è¡¡ï¼Œå•ä¸ªå®ä¾‹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡ã€‚
d. æ•°æ®åº“æ”¯æŒè¯»å†™åˆ†ç¦»å’Œåˆ†ç‰‡ç­–ç•¥ã€‚
e. ç¼“å­˜æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚
f. ä¼šè¯ä¿¡æ¯å­˜å‚¨åœ¨å¤–éƒ¨å­˜å‚¨ä¸­ã€‚
g. æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ä½¿ç”¨å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. å¤šå®ä¾‹æµ‹è¯•ï¼šéƒ¨ç½²å¤šä¸ªå®ä¾‹éªŒè¯è´Ÿè½½å‡è¡¡ã€‚
2. æ•…éšœæµ‹è¯•ï¼šæ¨¡æ‹Ÿå•ä¸ªå®ä¾‹æ•…éšœã€‚
3. å‹åŠ›æµ‹è¯•ï¼šæµ‹è¯•æ°´å¹³æ‰©å±•çš„æ•ˆæœã€‚
4. çŠ¶æ€æ£€æŸ¥ï¼šéªŒè¯æœåŠ¡çš„æ— çŠ¶æ€ç‰¹æ€§ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šæœ‰çŠ¶æ€çš„æœåŠ¡è®¾è®¡
@RestController
public class OrderController {
    
    // å±é™©ï¼šä½¿ç”¨å®ä¾‹å˜é‡å­˜å‚¨çŠ¶æ€
    private Map<String, OrderContext> orderContexts = new HashMap<>();
    private AtomicLong orderCounter = new AtomicLong(0);
    
    @PostMapping("/orders")
    public ResponseEntity<OrderResponse> createOrder(@RequestBody OrderRequest request) {
        // å±é™©ï¼šä¾èµ–æœ¬åœ°çŠ¶æ€
        long orderId = orderCounter.incrementAndGet();
        OrderContext context = new OrderContext(request);
        orderContexts.put(String.valueOf(orderId), context);
        
        return ResponseEntity.ok(new OrderResponse(orderId));
    }
    
    @GetMapping("/orders/{orderId}/status")
    public ResponseEntity<OrderStatus> getOrderStatus(@PathVariable String orderId) {
        // å±é™©ï¼šä¾èµ–æœ¬åœ°å­˜å‚¨çš„çŠ¶æ€
        OrderContext context = orderContexts.get(orderId);
        if (context == null) {
            return ResponseEntity.notFound().build();
        }
        return ResponseEntity.ok(context.getStatus());
    }
}

// âŒ é”™è¯¯ï¼šæœ¬åœ°æ–‡ä»¶å­˜å‚¨
@Service
public class FileService {
    
    private static final String UPLOAD_DIR = "/tmp/uploads/";
    
    public String uploadFile(MultipartFile file) {
        // å±é™©ï¼šæ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œæ— æ³•æ°´å¹³æ‰©å±•
        String fileName = UUID.randomUUID().toString() + "_" + file.getOriginalFilename();
        String filePath = UPLOAD_DIR + fileName;
        
        try {
            file.transferTo(new File(filePath));
            return filePath;
        } catch (IOException e) {
            throw new FileUploadException("Failed to upload file", e);
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šæ— çŠ¶æ€çš„æœåŠ¡è®¾è®¡
@RestController
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @PostMapping("/orders")
    public ResponseEntity<OrderResponse> createOrder(@RequestBody OrderRequest request) {
        // æ­£ç¡®ï¼šä½¿ç”¨æ•°æ®åº“ç”ŸæˆIDï¼Œæ— æœ¬åœ°çŠ¶æ€
        Order order = orderService.createOrder(request);
        
        // æ­£ç¡®ï¼šå°†ä¸Šä¸‹æ–‡å­˜å‚¨åœ¨å¤–éƒ¨å­˜å‚¨ä¸­
        OrderContext context = new OrderContext(order);
        redisTemplate.opsForValue().set(
            "order_context:" + order.getId(), 
            context, 
            Duration.ofHours(24)
        );
        
        return ResponseEntity.ok(new OrderResponse(order));
    }
    
    @GetMapping("/orders/{orderId}/status")
    public ResponseEntity<OrderStatus> getOrderStatus(@PathVariable String orderId) {
        // æ­£ç¡®ï¼šä»å¤–éƒ¨å­˜å‚¨è·å–çŠ¶æ€
        OrderContext context = (OrderContext) redisTemplate.opsForValue()
            .get("order_context:" + orderId);
        
        if (context == null) {
            // ä»æ•°æ®åº“è·å–
            Order order = orderService.getOrder(orderId);
            if (order == null) {
                return ResponseEntity.notFound().build();
            }
            return ResponseEntity.ok(order.getStatus());
        }
        
        return ResponseEntity.ok(context.getStatus());
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¯¹è±¡å­˜å‚¨æœåŠ¡
@Service
public class FileService {
    
    @Autowired
    private AmazonS3 s3Client;
    
    @Value("${aws.s3.bucket.name}")
    private String bucketName;
    
    public String uploadFile(MultipartFile file) {
        try {
            // æ­£ç¡®ï¼šä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
            String fileName = generateUniqueFileName(file.getOriginalFilename());
            String key = "uploads/" + fileName;
            
            ObjectMetadata metadata = new ObjectMetadata();
            metadata.setContentLength(file.getSize());
            metadata.setContentType(file.getContentType());
            
            s3Client.putObject(new PutObjectRequest(
                bucketName, 
                key, 
                file.getInputStream(), 
                metadata
            ));
            
            // è¿”å›å¯å…¬å¼€è®¿é—®çš„URL
            return s3Client.getUrl(bucketName, key).toString();
            
        } catch (IOException e) {
            throw new FileUploadException("Failed to upload file", e);
        }
    }
    
    private String generateUniqueFileName(String originalFilename) {
        String timestamp = String.valueOf(System.currentTimeMillis());
        String uuid = UUID.randomUUID().toString().substring(0, 8);
        String extension = getFileExtension(originalFilename);
        return timestamp + "_" + uuid + extension;
    }
}

// âœ… æ­£ç¡®ï¼šæ”¯æŒè´Ÿè½½å‡è¡¡çš„é…ç½®
@Configuration
@EnableLoadBalancerClient
public class LoadBalancerConfig {
    
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
    
    @Bean
    public IRule loadBalancerRule() {
        // ä½¿ç”¨è½®è¯¢ç­–ç•¥
        return new RoundRobinRule();
    }
}

// âœ… æ­£ç¡®ï¼šåˆ†å¸ƒå¼ç¼“å­˜é…ç½®
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofHours(1))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(config)
            .build();
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        return template;
    }
}
```

**ç¬¬äº”åä¹æ¡** å‚ç›´æ‰©å±•æ£€æŸ¥ ğŸŸ¡ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿ç³»ç»Ÿèµ„æºåˆ©ç”¨åˆç†ï¼Œæ”¯æŒå‚ç›´æ‰©å±•

**æ£€æµ‹æ ‡å‡†ï¼š**
- CPUåˆ©ç”¨ç‡åœ¨æ­£å¸¸è´Ÿè½½ä¸‹ä¸è¶…è¿‡70%
- å†…å­˜åˆ©ç”¨ç‡ä¸è¶…è¿‡80%ï¼Œé¿å…é¢‘ç¹GC
- æ•°æ®åº“è¿æ¥æ± åˆ©ç”¨ç‡ä¸è¶…è¿‡80%
- çº¿ç¨‹æ± åˆ©ç”¨ç‡ä¸è¶…è¿‡75%
- å“åº”æ—¶é—´åœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆP99 < 500msï¼‰
- å¿…é¡»æœ‰æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

**æ£€æµ‹æ–¹æ³•ï¼š**
- æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•ä¸åŒè´Ÿè½½ä¸‹çš„èµ„æºåˆ©ç”¨ç‡
- å‹åŠ›æµ‹è¯•ï¼šæ‰¾å‡ºç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆ
- ç›‘æ§åˆ†æï¼šåˆ†æç”Ÿäº§ç¯å¢ƒçš„èµ„æºä½¿ç”¨æƒ…å†µ
- ä¼˜åŒ–éªŒè¯ï¼šéªŒè¯æ€§èƒ½ä¼˜åŒ–çš„æ•ˆæœ

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šèµ„æºåˆ©ç”¨ä¸å½“
@Service
public class DataProcessingService {
    
    public List<ProcessedData> processLargeDataset(List<RawData> rawDataList) {
        List<ProcessedData> results = new ArrayList<>();
        
        // å±é™©ï¼šåŒæ­¥å¤„ç†å¤§é‡æ•°æ®ï¼ŒCPUåˆ©ç”¨ç‡è¿‡é«˜
        for (RawData rawData : rawDataList) {
            // å±é™©ï¼šå¤æ‚è®¡ç®—æ²¡æœ‰ä¼˜åŒ–
            ProcessedData processed = performComplexCalculation(rawData);
            results.add(processed);
        }
        
        return results;
    }
    
    private ProcessedData performComplexCalculation(RawData rawData) {
        // å±é™©ï¼šä½æ•ˆçš„ç®—æ³•å®ç°
        double result = 0;
        for (int i = 0; i < 1000000; i++) {
            result += Math.pow(rawData.getValue(), 2) * Math.sin(i);
        }
        return new ProcessedData(result);
    }
}

// âŒ é”™è¯¯ï¼šå†…å­˜ä½¿ç”¨ä¸å½“
@Service
public class ReportService {
    
    public byte[] generateLargeReport() {
        // å±é™©ï¼šä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜
        List<ReportData> allData = reportRepository.findAll();
        
        StringBuilder report = new StringBuilder();
        // å±é™©ï¼šå­—ç¬¦ä¸²æ‹¼æ¥æ•ˆç‡ä½ï¼Œå†…å­˜å ç”¨é«˜
        for (ReportData data : allData) {
            report.append(data.toString()).append("\n");
        }
        
        return report.toString().getBytes();
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šåˆç†çš„èµ„æºåˆ©ç”¨
@Service
public class DataProcessingService {
    
    @Autowired
    private TaskExecutor taskExecutor;
    
    public CompletableFuture<List<ProcessedData>> processLargeDataset(List<RawData> rawDataList) {
        // æ­£ç¡®ï¼šåˆ†æ‰¹å¹¶è¡Œå¤„ç†ï¼Œæ§åˆ¶CPUåˆ©ç”¨ç‡
        int batchSize = 100;
        int coreCount = Runtime.getRuntime().availableProcessors();
        
        List<CompletableFuture<List<ProcessedData>>> futures = new ArrayList<>();
        
        for (int i = 0; i < rawDataList.size(); i += batchSize) {
            int endIndex = Math.min(i + batchSize, rawDataList.size());
            List<RawData> batch = rawDataList.subList(i, endIndex);
            
            CompletableFuture<List<ProcessedData>> future = CompletableFuture
                .supplyAsync(() -> processBatch(batch), taskExecutor);
            futures.add(future);
        }
        
        return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .thenApply(v -> futures.stream()
                .map(CompletableFuture::join)
                .flatMap(List::stream)
                .collect(Collectors.toList()));
    }
    
    private List<ProcessedData> processBatch(List<RawData> batch) {
        return batch.parallelStream()
            .map(this::performOptimizedCalculation)
            .collect(Collectors.toList());
    }
    
    private ProcessedData performOptimizedCalculation(RawData rawData) {
        // æ­£ç¡®ï¼šä¼˜åŒ–ç®—æ³•ï¼Œå‡å°‘è®¡ç®—å¤æ‚åº¦
        double value = rawData.getValue();
        double result = value * value * PRECOMPUTED_CONSTANT;
        return new ProcessedData(result);
    }
    
    private static final double PRECOMPUTED_CONSTANT = computeConstant();
    
    private static double computeConstant() {
        // é¢„è®¡ç®—å¸¸é‡ï¼Œé¿å…é‡å¤è®¡ç®—
        double sum = 0;
        for (int i = 0; i < 1000000; i++) {
            sum += Math.sin(i);
        }
        return sum;
    }
}

// âœ… æ­£ç¡®ï¼šå†…å­˜å‹å¥½çš„æŠ¥è¡¨ç”Ÿæˆ
@Service
public class ReportService {
    
    @Autowired
    private ReportRepository reportRepository;
    
    public void generateLargeReport(OutputStream outputStream) throws IOException {
        // æ­£ç¡®ï¼šæµå¼å¤„ç†ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨
        try (BufferedWriter writer = new BufferedWriter(
                new OutputStreamWriter(outputStream, StandardCharsets.UTF_8))) {
            
            // æ­£ç¡®ï¼šåˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
            int pageSize = 1000;
            int pageNumber = 0;
            Page<ReportData> page;
            
            do {
                Pageable pageable = PageRequest.of(pageNumber, pageSize);
                page = reportRepository.findAll(pageable);
                
                for (ReportData data : page.getContent()) {
                    writer.write(data.toString());
                    writer.newLine();
                }
                
                // å®šæœŸåˆ·æ–°ç¼“å†²åŒº
                if (pageNumber % 10 == 0) {
                    writer.flush();
                }
                
                pageNumber++;
            } while (page.hasNext());
        }
    }
}

// âœ… æ­£ç¡®ï¼šèµ„æºç›‘æ§é…ç½®
@Component
public class ResourceMonitor {
    
    private final MeterRegistry meterRegistry;
    private final MemoryMXBean memoryBean;
    private final ThreadMXBean threadBean;
    
    public ResourceMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.memoryBean = ManagementFactory.getMemoryMXBean();
        this.threadBean = ManagementFactory.getThreadMXBean();
        
        // æ³¨å†Œèµ„æºç›‘æ§æŒ‡æ ‡
        registerResourceMetrics();
    }
    
    private void registerResourceMetrics() {
        // CPUä½¿ç”¨ç‡ç›‘æ§
        Gauge.builder("system.cpu.usage")
            .register(meterRegistry, this, ResourceMonitor::getCpuUsage);
        
        // å†…å­˜ä½¿ç”¨ç‡ç›‘æ§
        Gauge.builder("jvm.memory.usage")
            .register(meterRegistry, this, ResourceMonitor::getMemoryUsage);
        
        // çº¿ç¨‹æ•°ç›‘æ§
        Gauge.builder("jvm.threads.count")
            .register(meterRegistry, this, ResourceMonitor::getThreadCount);
    }
    
    private double getCpuUsage(ResourceMonitor monitor) {
        OperatingSystemMXBean osBean = ManagementFactory.getOperatingSystemMXBean();
        if (osBean instanceof com.sun.management.OperatingSystemMXBean) {
            return ((com.sun.management.OperatingSystemMXBean) osBean).getProcessCpuLoad();
        }
        return 0.0;
    }
    
    private double getMemoryUsage(ResourceMonitor monitor) {
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        return (double) heapUsage.getUsed() / heapUsage.getMax();
    }
    
    private double getThreadCount(ResourceMonitor monitor) {
        return threadBean.getThreadCount();
    }
}

// âœ… æ­£ç¡®ï¼šçº¿ç¨‹æ± é…ç½®
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {
    
    @Override
    @Bean(name = "taskExecutor")
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        
        int corePoolSize = Runtime.getRuntime().availableProcessors();
        executor.setCorePoolSize(corePoolSize);
        executor.setMaxPoolSize(corePoolSize * 2);
        executor.setQueueCapacity(100);
        executor.setKeepAliveSeconds(60);
        executor.setThreadNamePrefix("async-task-");
        
        // æ‹’ç»ç­–ç•¥ï¼šè°ƒç”¨è€…è¿è¡Œ
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        
        executor.initialize();
        return executor;
    }
    
    @Override
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return (ex, method, params) -> {
            log.error("Async method execution failed: {}", method.getName(), ex);
        };
    }
}
```

### 4.15 å¯ç»´æŠ¤æ€§æ£€æŸ¥

#### 4.15.1 ä»£ç å¯è¯»æ€§æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿ä»£ç å…·æœ‰è‰¯å¥½çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
b. å‘½åå¿…é¡»å…·æœ‰æè¿°æ€§ï¼Œé¿å…ç¼©å†™å’Œæ— æ„ä¹‰åç§°ã€‚
c. æ–¹æ³•é•¿åº¦ä¸è¶…è¿‡50è¡Œï¼Œç±»é•¿åº¦ä¸è¶…è¿‡500è¡Œã€‚
d. åœˆå¤æ‚åº¦ä¸è¶…è¿‡10ã€‚
e. æ³¨é‡Šè¦†ç›–ç‡è¾¾åˆ°å…³é”®æ–¹æ³•çš„80%ã€‚
f. ä»£ç æ ¼å¼ç»Ÿä¸€ï¼Œéµå¾ªå›¢é˜Ÿç¼–ç è§„èŒƒã€‚
g. é¿å…æ·±å±‚åµŒå¥—ï¼ˆä¸è¶…è¿‡4å±‚ï¼‰ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. é™æ€ä»£ç åˆ†æï¼šä½¿ç”¨SonarQubeç­‰å·¥å…·æ£€æµ‹ã€‚
2. ä»£ç å®¡æŸ¥ï¼šäººå·¥å®¡æŸ¥ä»£ç å¯è¯»æ€§ã€‚
3. å¤æ‚åº¦åˆ†æï¼šæ£€æµ‹åœˆå¤æ‚åº¦å’Œè®¤çŸ¥å¤æ‚åº¦ã€‚
4. å‘½åæ£€æŸ¥ï¼šéªŒè¯å‘½åè§„èŒƒçš„éµå¾ªæƒ…å†µã€‚

**3. é”™è¯¯ç¤ºä¾‹**

```java
// âŒ é”™è¯¯ï¼šå¯è¯»æ€§å·®çš„ä»£ç 
public class DataProcessor {
    
    // å±é™©ï¼šæ— æ„ä¹‰çš„å˜é‡å
    private List<String> d;
    private Map<String, Object> m;
    private int c;
    
    // å±é™©ï¼šæ–¹æ³•è¿‡é•¿ï¼Œé€»è¾‘å¤æ‚
    public String processData(String input) {
        if (input != null) {
            if (input.length() > 0) {
                if (input.contains("special")) {
                    if (input.startsWith("prefix")) {
                        if (input.endsWith("suffix")) {
                            // å±é™©ï¼šæ·±å±‚åµŒå¥—ï¼Œéš¾ä»¥ç†è§£
                            String result = "";
                            for (int i = 0; i < input.length(); i++) {
                                char ch = input.charAt(i);
                                if (Character.isDigit(ch)) {
                                    result += ch;
                                } else if (Character.isLetter(ch)) {
                                    if (Character.isUpperCase(ch)) {
                                        result += Character.toLowerCase(ch);
                                    } else {
                                        result += Character.toUpperCase(ch);
                                    }
                                } else {
                                    result += "_";
                                }
                            }
                            return result;
                        }
                    }
                }
            }
        }
        return null;
    }
    
    // å±é™©ï¼šç¼©å†™å’Œæ— æ„ä¹‰çš„æ–¹æ³•å
    public void proc() {
        // å±é™©ï¼šæ²¡æœ‰æ³¨é‡Šï¼Œé€»è¾‘ä¸æ¸…æ™°
        c++;
        if (c > 100) {
            d.clear();
            m.clear();
            c = 0;
        }
    }
}
```

**4. æ­£ç¡®ç¤ºä¾‹**

```java
// âœ… æ­£ç¡®ï¼šå¯è¯»æ€§è‰¯å¥½çš„ä»£ç 
public class TextDataProcessor {
    
    private final List<String> processedData;
    private final Map<String, Object> configurationMap;
    private int processedCount;
    
    /**
     * å¤„ç†è¾“å…¥æ–‡æœ¬æ•°æ®ï¼Œåº”ç”¨ç‰¹å®šçš„è½¬æ¢è§„åˆ™
     * 
     * @param inputText å¾…å¤„ç†çš„è¾“å…¥æ–‡æœ¬
     * @return å¤„ç†åçš„æ–‡æœ¬ï¼Œå¦‚æœè¾“å…¥æ— æ•ˆåˆ™è¿”å›null
     */
    public String processTextData(String inputText) {
        if (!isValidInput(inputText)) {
            return null;
        }
        
        if (!hasSpecialMarkers(inputText)) {
            return inputText;
        }
        
        return transformText(inputText);
    }
    
    /**
     * éªŒè¯è¾“å…¥æ–‡æœ¬æ˜¯å¦æœ‰æ•ˆ
     */
    private boolean isValidInput(String inputText) {
        return inputText != null && 
               !inputText.trim().isEmpty();
    }
    
    /**
     * æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ç‰¹æ®Šæ ‡è®°
     */
    private boolean hasSpecialMarkers(String inputText) {
        return inputText.contains("special") && 
               inputText.startsWith("prefix") && 
               inputText.endsWith("suffix");
    }
    
    /**
     * åº”ç”¨æ–‡æœ¬è½¬æ¢è§„åˆ™
     */
    private String transformText(String inputText) {
        StringBuilder result = new StringBuilder();
        
        for (char character : inputText.toCharArray()) {
            String transformedChar = transformCharacter(character);
            result.append(transformedChar);
        }
        
        return result.toString();
    }
    
    /**
     * è½¬æ¢å•ä¸ªå­—ç¬¦
     */
    private String transformCharacter(char character) {
        if (Character.isDigit(character)) {
            return String.valueOf(character);
        }
        
        if (Character.isLetter(character)) {
            return Character.isUpperCase(character) ? 
                String.valueOf(Character.toLowerCase(character)) : 
                String.valueOf(Character.toUpperCase(character));
        }
        
        return "_";
    }
    
    /**
     * å¤„ç†æ•°æ®æ¸…ç†é€»è¾‘
     */
    public void performPeriodicCleanup() {
        processedCount++;
        
        if (shouldPerformCleanup()) {
            clearProcessedData();
            resetCounters();
        }
    }
    
    private boolean shouldPerformCleanup() {
        return processedCount > CLEANUP_THRESHOLD;
    }
    
    private void clearProcessedData() {
        processedData.clear();
        configurationMap.clear();
    }
    
    private void resetCounters() {
        processedCount = 0;
    }
    
    private static final int CLEANUP_THRESHOLD = 100;
}
```

**ç¬¬å…­åä¸€æ¡** æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥ ğŸŸ¡ï¼š

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿é¡¹ç›®æ–‡æ¡£å®Œæ•´ä¸”åŠæ—¶æ›´æ–°

**æ£€æµ‹æ ‡å‡†ï¼š**
- APIæ–‡æ¡£è¦†ç›–ç‡è¾¾åˆ°100%ï¼ŒåŒ…å«è¯·æ±‚/å“åº”ç¤ºä¾‹
- æ¶æ„è®¾è®¡æ–‡æ¡£æè¿°ç³»ç»Ÿæ•´ä½“è®¾è®¡
- éƒ¨ç½²æ–‡æ¡£åŒ…å«è¯¦ç»†çš„ç¯å¢ƒé…ç½®å’Œéƒ¨ç½²æ­¥éª¤
- READMEæ–‡æ¡£åŒ…å«é¡¹ç›®ä»‹ç»ã€å¿«é€Ÿå¼€å§‹æŒ‡å—
- å˜æ›´æ—¥å¿—è®°å½•é‡è¦åŠŸèƒ½å˜æ›´å’Œç‰ˆæœ¬ä¿¡æ¯
- æ•…éšœæ’æŸ¥æŒ‡å—åŒ…å«å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

**æ£€æµ‹æ–¹æ³•ï¼š**
- æ–‡æ¡£å®¡æŸ¥ï¼šæ£€æŸ¥æ–‡æ¡£çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
- APIæµ‹è¯•ï¼šéªŒè¯APIæ–‡æ¡£ä¸å®é™…æ¥å£çš„ä¸€è‡´æ€§
- éƒ¨ç½²éªŒè¯ï¼šæŒ‰ç…§éƒ¨ç½²æ–‡æ¡£è¿›è¡Œå®é™…éƒ¨ç½²æµ‹è¯•
- ç‰ˆæœ¬å¯¹æ¯”ï¼šæ£€æŸ¥æ–‡æ¡£ç‰ˆæœ¬ä¸ä»£ç ç‰ˆæœ¬çš„åŒæ­¥æ€§

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘æ–‡æ¡£çš„API
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // å±é™©ï¼šæ²¡æœ‰APIæ–‡æ¡£æ³¨è§£
    @PostMapping
    public ResponseEntity<User> createUser(@RequestBody UserRequest request) {
        // å±é™©ï¼šæ²¡æœ‰æ–¹æ³•æ³¨é‡Š
        User user = userService.createUser(request);
        return ResponseEntity.ok(user);
    }
    
    // å±é™©ï¼šå¤æ‚é€»è¾‘æ²¡æœ‰æ³¨é‡Š
    @GetMapping("/search")
    public ResponseEntity<List<User>> searchUsers(
            @RequestParam String keyword,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        
        List<User> users = userService.searchUsers(keyword, page, size);
        return ResponseEntity.ok(users);
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„APIæ–‡æ¡£
@RestController
@RequestMapping("/api/users")
@Api(tags = "ç”¨æˆ·ç®¡ç†", description = "ç”¨æˆ·ç›¸å…³æ“ä½œæ¥å£")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    /**
     * åˆ›å»ºæ–°ç”¨æˆ·
     * 
     * @param request ç”¨æˆ·åˆ›å»ºè¯·æ±‚
     * @return åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯
     */
    @PostMapping
    @ApiOperation(value = "åˆ›å»ºç”¨æˆ·", notes = "åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·è´¦æˆ·")
    @ApiResponses({
        @ApiResponse(code = 200, message = "åˆ›å»ºæˆåŠŸ"),
        @ApiResponse(code = 400, message = "è¯·æ±‚å‚æ•°é”™è¯¯"),
        @ApiResponse(code = 409, message = "ç”¨æˆ·å·²å­˜åœ¨")
    })
    public ResponseEntity<UserResponse> createUser(
            @ApiParam(value = "ç”¨æˆ·åˆ›å»ºè¯·æ±‚", required = true)
            @Valid @RequestBody CreateUserRequest request) {
        
        User user = userService.createUser(request);
        UserResponse response = UserResponse.from(user);
        
        return ResponseEntity.ok(response);
    }
    
    /**
     * æœç´¢ç”¨æˆ·
     * 
     * æ ¹æ®å…³é”®è¯æœç´¢ç”¨æˆ·ï¼Œæ”¯æŒæŒ‰ç”¨æˆ·åã€é‚®ç®±ç­‰å­—æ®µæ¨¡ç³ŠåŒ¹é…
     * 
     * @param keyword æœç´¢å…³é”®è¯
     * @param page é¡µç ï¼Œä»0å¼€å§‹
     * @param size æ¯é¡µå¤§å°ï¼Œé»˜è®¤10æ¡
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/search")
    @ApiOperation(value = "æœç´¢ç”¨æˆ·", notes = "æ ¹æ®å…³é”®è¯æœç´¢ç”¨æˆ·åˆ—è¡¨")
    public ResponseEntity<PageResponse<UserResponse>> searchUsers(
            @ApiParam(value = "æœç´¢å…³é”®è¯", required = true)
            @RequestParam String keyword,
            @ApiParam(value = "é¡µç ", defaultValue = "0")
            @RequestParam(defaultValue = "0") int page,
            @ApiParam(value = "æ¯é¡µå¤§å°", defaultValue = "10")
            @RequestParam(defaultValue = "10") int size) {
        
        // éªŒè¯åˆ†é¡µå‚æ•°
        if (page < 0 || size <= 0 || size > 100) {
            throw new InvalidParameterException("Invalid pagination parameters");
        }
        
        PageRequest pageRequest = PageRequest.of(page, size);
        Page<User> userPage = userService.searchUsers(keyword, pageRequest);
        
        PageResponse<UserResponse> response = PageResponse.from(
            userPage.map(UserResponse::from)
        );
        
        return ResponseEntity.ok(response);
    }
}
```

**æ¨èå·¥å…·ï¼š**
- **APIæ–‡æ¡£ï¼š** Swagger/OpenAPIã€Spring REST Docs
- **ä»£ç æ³¨é‡Šï¼š** Javadocã€IDEæ’ä»¶
- **æ–‡æ¡£ç”Ÿæˆï¼š** GitBookã€Confluenceã€Notion
- **ç‰ˆæœ¬ç®¡ç†ï¼š** Gitæ ‡ç­¾ã€CHANGELOG.md
- **é™æ€åˆ†æï¼š** SonarQubeã€Checkstyleã€PMD

### 4.16 DevOpsæ£€æŸ¥

#### 4.16.1 æŒç»­é›†æˆæ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿æŒç»­é›†æˆæµç¨‹å®Œæ•´å¯é ã€‚
b. æ„å»ºè„šæœ¬å¿…é¡»å¯é‡å¤æ‰§è¡Œï¼Œæ”¯æŒå¤šç¯å¢ƒã€‚
c. è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ç‡ä¸ä½äº80%ã€‚
d. ä»£ç è´¨é‡é—¨ç¦è®¾ç½®åˆç†é˜ˆå€¼ã€‚
e. æ„å»ºæ—¶é—´æ§åˆ¶åœ¨10åˆ†é’Ÿä»¥å†…ã€‚
f. æ„å»ºå¤±è´¥æ—¶æœ‰æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ã€‚
g. æ”¯æŒå¹¶è¡Œæ„å»ºå’Œç¼“å­˜ä¼˜åŒ–ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. æ„å»ºæµ‹è¯•ï¼šéªŒè¯æ„å»ºè„šæœ¬çš„å¯é‡å¤æ€§ã€‚
2. æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•æ„å»ºæ—¶é—´å’Œèµ„æºæ¶ˆè€—ã€‚
3. è´¨é‡æ£€æŸ¥ï¼šéªŒè¯ä»£ç è´¨é‡é—¨ç¦çš„æœ‰æ•ˆæ€§ã€‚
4. å¤±è´¥æ¨¡æ‹Ÿï¼šæµ‹è¯•æ„å»ºå¤±è´¥æ—¶çš„å¤„ç†æœºåˆ¶ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯ä¸å®Œæ•´çš„CIé…ç½®ç¤ºä¾‹ï¼š

```yaml
# âŒ é”™è¯¯ï¼šä¸å®Œæ•´çš„CIé…ç½®
name: Build
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    # å±é™©ï¼šæ²¡æœ‰æŒ‡å®šJavaç‰ˆæœ¬
    - name: Set up JDK
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'temurin'
    
    # å±é™©ï¼šæ²¡æœ‰ç¼“å­˜ä¾èµ–
    - name: Build with Maven
      run: mvn clean compile
    
    # å±é™©ï¼šæ²¡æœ‰è¿è¡Œæµ‹è¯•
    # å±é™©ï¼šæ²¡æœ‰ä»£ç è´¨é‡æ£€æŸ¥
    # å±é™©ï¼šæ²¡æœ‰æ„å»ºäº§ç‰©ä¸Šä¼ 
```

**é—®é¢˜åˆ†æï¼š**
- æ²¡æœ‰æŒ‡å®šæ˜ç¡®çš„Javaç‰ˆæœ¬å’Œå‘è¡Œç‰ˆ
- ç¼ºå°‘ä¾èµ–ç¼“å­˜ï¼Œå¯¼è‡´æ„å»ºæ—¶é—´è¿‡é•¿
- æ²¡æœ‰è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
- ç¼ºå°‘ä»£ç è´¨é‡æ£€æŸ¥æ­¥éª¤
- æ²¡æœ‰ä¸Šä¼ æ„å»ºäº§ç‰©

**4. æ­£ç¡®ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯å®Œæ•´çš„CIé…ç½®ç¤ºä¾‹ï¼š

```yaml
# âœ… æ­£ç¡®ï¼šå®Œæ•´çš„CIé…ç½®
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  MAVEN_OPTS: -Dmaven.repo.local=${{ github.workspace }}/.m2/repository

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºSonarQubeåˆ†æ
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: Run tests
      run: |
        mvn clean test \
          -Dspring.profiles.active=test \
          -Dspring.datasource.url=jdbc:mysql://localhost:3306/testdb \
          -Dspring.datasource.username=root \
          -Dspring.datasource.password=root
    
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
    
    - name: Code coverage
      run: mvn jacoco:report
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: target/site/jacoco/jacoco.xml
    
    - name: SonarQube analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        mvn sonar:sonar \
          -Dsonar.projectKey=my-project \
          -Dsonar.organization=my-org \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
    
    - name: Build application
      run: mvn clean package -DskipTests
    
    - name: Build Docker image
      run: |
        docker build -t my-app:${{ github.sha }} .
        docker tag my-app:${{ github.sha }} my-app:latest
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: jar-artifact
        path: target/*.jar
        retention-days: 30
```

**ä¼˜åŠ¿åˆ†æï¼š**
- æ˜ç¡®æŒ‡å®šJavaç‰ˆæœ¬å’Œå‘è¡Œç‰ˆ
- ä½¿ç”¨ä¾èµ–ç¼“å­˜æé«˜æ„å»ºæ•ˆç‡
- åŒ…å«å®Œæ•´çš„æµ‹è¯•å’Œä»£ç è¦†ç›–ç‡æ£€æŸ¥
- é›†æˆSonarQubeè¿›è¡Œä»£ç è´¨é‡åˆ†æ
- æ„å»ºDockeré•œåƒå¹¶ä¸Šä¼ æ„å»ºäº§ç‰©
- æ”¯æŒå¤šåˆ†æ”¯å’ŒPull Requestè§¦å‘

#### 4.16.2 éƒ¨ç½²ç­–ç•¥æ£€æŸ¥

**1. æ£€æµ‹ç›®æ ‡**

a. ç¡®ä¿éƒ¨ç½²ç­–ç•¥å®‰å…¨å¯é ã€‚
b. æ”¯æŒè“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°ç­–ç•¥ã€‚
c. éƒ¨ç½²è¿‡ç¨‹ä¸­æœåŠ¡å¯ç”¨æ€§ä¸ä½äº99%ã€‚
d. å…·å¤‡å¿«é€Ÿå›æ»šæœºåˆ¶ï¼ˆ5åˆ†é’Ÿå†…å®Œæˆï¼‰ã€‚
e. éƒ¨ç½²åè‡ªåŠ¨è¿›è¡Œå¥åº·æ£€æŸ¥ã€‚
f. æ”¯æŒé‡‘ä¸é›€å‘å¸ƒå’Œæµé‡æ§åˆ¶ã€‚
g. éƒ¨ç½²è¿‡ç¨‹æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•ã€‚

**2. æ£€æµ‹æ–¹æ³•**

1. éƒ¨ç½²æµ‹è¯•ï¼šéªŒè¯ä¸åŒéƒ¨ç½²ç­–ç•¥çš„æœ‰æ•ˆæ€§ã€‚
2. å¯ç”¨æ€§æµ‹è¯•ï¼šæµ‹è¯•éƒ¨ç½²è¿‡ç¨‹ä¸­çš„æœåŠ¡å¯ç”¨æ€§ã€‚
3. å›æ»šæµ‹è¯•ï¼šéªŒè¯å›æ»šæœºåˆ¶çš„é€Ÿåº¦å’Œå¯é æ€§ã€‚
4. å¥åº·æ£€æŸ¥ï¼šéªŒè¯éƒ¨ç½²åçš„å¥åº·æ£€æŸ¥æœºåˆ¶ã€‚

**3. é”™è¯¯ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯ç®€å•ç²—æš´çš„éƒ¨ç½²é…ç½®ç¤ºä¾‹ï¼š

```yaml
# âŒ é”™è¯¯ï¼šç®€å•ç²—æš´çš„éƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-app
        image: my-app:latest
        ports:
        - containerPort: 8080
        # å±é™©ï¼šæ²¡æœ‰å¥åº·æ£€æŸ¥
        # å±é™©ï¼šæ²¡æœ‰èµ„æºé™åˆ¶
        # å±é™©ï¼šæ²¡æœ‰ä¼˜é›…å…³é—­é…ç½®
  # å±é™©ï¼šæ²¡æœ‰éƒ¨ç½²ç­–ç•¥é…ç½®
```

**é—®é¢˜åˆ†æï¼š**
- ä½¿ç”¨latestæ ‡ç­¾ï¼Œæ— æ³•ç¡®ä¿ç‰ˆæœ¬ä¸€è‡´æ€§
- ç¼ºå°‘å¥åº·æ£€æŸ¥é…ç½®
- æ²¡æœ‰èµ„æºé™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´èµ„æºäº‰ç”¨
- ç¼ºå°‘ä¼˜é›…å…³é—­é…ç½®
- æ²¡æœ‰éƒ¨ç½²ç­–ç•¥ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­

**4. æ­£ç¡®ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯å®Œæ•´çš„éƒ¨ç½²é…ç½®ç¤ºä¾‹ï¼š

```yaml
# âœ… æ­£ç¡®ï¼šå®Œæ•´çš„éƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
  labels:
    app: my-app
    version: v1.0.0
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # ç¡®ä¿æœåŠ¡å¯ç”¨æ€§
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
        version: v1.0.0
    spec:
      containers:
      - name: my-app
        image: my-app:v1.0.0
        ports:
        - containerPort: 8080
          name: http
        
        # å¥åº·æ£€æŸ¥é…ç½®
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: JVM_OPTS
          value: "-Xms512m -Xmx1g -XX:+UseG1GC"
        
        # ä¼˜é›…å…³é—­
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]
      
      # ä¼˜é›…å…³é—­æ—¶é—´
      terminationGracePeriodSeconds: 30
      
      # é•œåƒæ‹‰å–ç­–ç•¥
      imagePullSecrets:
      - name: registry-secret

---
# æœåŠ¡é…ç½®
apiVersion: v1
kind: Service
metadata:
  name: my-app-service
spec:
  selector:
    app: my-app
  ports:
  - port: 80
    targetPort: 8080
    name: http
  type: ClusterIP

---
# HPAé…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: my-app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-app
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

**ä¼˜åŠ¿åˆ†æï¼š**
- ä½¿ç”¨æ˜ç¡®çš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œç¡®ä¿éƒ¨ç½²ä¸€è‡´æ€§
- é…ç½®å®Œæ•´çš„å¥åº·æ£€æŸ¥æœºåˆ¶
- è®¾ç½®åˆç†çš„èµ„æºé™åˆ¶å’Œè¯·æ±‚
- æ”¯æŒæ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼Œç¡®ä¿æœåŠ¡å¯ç”¨æ€§
- åŒ…å«HPAè‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®
- é…ç½®ä¼˜é›…å…³é—­æœºåˆ¶ï¼Œé¿å…è¯·æ±‚ä¸¢å¤±

#### 4.16.3 ç›‘æ§å‘Šè­¦æ£€æŸ¥

**æ£€æµ‹ç›®æ ‡ï¼š**
ç¡®ä¿ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦æœºåˆ¶å®Œå–„ï¼Œä¸šåŠ¡å…³é”®æŒ‡æ ‡ç›‘æ§è¦†ç›–ç‡è¾¾åˆ°100%ï¼Œç³»ç»Ÿèµ„æºç›‘æ§åŒ…å«CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰å…³é”®æŒ‡æ ‡ï¼Œå‘Šè­¦å“åº”æ—¶é—´ä¸è¶…è¿‡5åˆ†é’Ÿï¼Œæ—¥å¿—èšåˆå’Œåˆ†æç³»ç»Ÿå®Œæ•´ï¼Œç›‘æ§æ•°æ®ä¿ç•™æœŸä¸å°‘äº30å¤©ï¼Œå‘Šè­¦è§„åˆ™é¿å…è¯¯æŠ¥å’Œæ¼æŠ¥ã€‚

**æ£€æµ‹æ–¹æ³•ï¼š**
1. **ç›‘æ§æŒ‡æ ‡æ£€æŸ¥**ï¼šéªŒè¯ä¸šåŠ¡å…³é”®æŒ‡æ ‡å’Œç³»ç»Ÿèµ„æºæŒ‡æ ‡çš„ç›‘æ§è¦†ç›–ç‡
2. **å‘Šè­¦æœºåˆ¶æµ‹è¯•**ï¼šæ¨¡æ‹Ÿæ•…éšœåœºæ™¯éªŒè¯å‘Šè­¦è§¦å‘å’Œé€šçŸ¥æœºåˆ¶
3. **æ€§èƒ½å½±å“è¯„ä¼°**ï¼šæµ‹è¯•ç›‘æ§ç³»ç»Ÿå¯¹åº”ç”¨æ€§èƒ½çš„å½±å“ç¨‹åº¦
4. **æ—¥å¿—ç³»ç»ŸéªŒè¯**ï¼šæ£€æŸ¥æ—¥å¿—èšåˆã€å­˜å‚¨å’ŒæŸ¥è¯¢åŠŸèƒ½çš„å®Œæ•´æ€§
5. **æ•°æ®ä¿ç•™ç­–ç•¥**ï¼šç¡®è®¤ç›‘æ§æ•°æ®å’Œæ—¥å¿—çš„ä¿ç•™æœŸç¬¦åˆè¦æ±‚

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ é”™è¯¯ï¼šç¼ºå°‘ç›‘æ§çš„æœåŠ¡
@RestController
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping("/orders")
    public ResponseEntity<Order> createOrder(@RequestBody OrderRequest request) {
        // å±é™©ï¼šæ²¡æœ‰ç›‘æ§æŒ‡æ ‡
        // å±é™©ï¼šæ²¡æœ‰æ—¥å¿—è®°å½•
        Order order = orderService.createOrder(request);
        return ResponseEntity.ok(order);
    }
    
    @GetMapping("/orders/{id}")
    public ResponseEntity<Order> getOrder(@PathVariable String id) {
        // å±é™©ï¼šæ²¡æœ‰æ€§èƒ½ç›‘æ§
        // å±é™©ï¼šæ²¡æœ‰é”™è¯¯å¤„ç†ç›‘æ§
        Order order = orderService.getOrder(id);
        return ResponseEntity.ok(order);
    }
}
```

**é—®é¢˜åˆ†æï¼š**
1. **ç¼ºå°‘ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡**ï¼šæ— æ³•ç»Ÿè®¡è®¢å•åˆ›å»ºæˆåŠŸç‡ã€å“åº”æ—¶é—´ç­‰å…³é”®ä¸šåŠ¡æŒ‡æ ‡
2. **ç¼ºå°‘æ—¥å¿—è®°å½•**ï¼šæ— æ³•è¿½è¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹ï¼Œéš¾ä»¥æ’æŸ¥é—®é¢˜
3. **ç¼ºå°‘æ€§èƒ½ç›‘æ§**ï¼šæ— æ³•ç›‘æ§æ¥å£å“åº”æ—¶é—´å’Œååé‡
4. **ç¼ºå°‘é”™è¯¯ç›‘æ§**ï¼šå¼‚å¸¸æƒ…å†µæ— æ³•åŠæ—¶å‘ç°å’Œå‘Šè­¦
5. **ç¼ºå°‘é“¾è·¯è¿½è¸ª**ï¼šæ— æ³•è·Ÿè¸ªè¯·æ±‚åœ¨å¾®æœåŠ¡é—´çš„è°ƒç”¨é“¾è·¯

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ç›‘æ§é…ç½®
@RestController
@Slf4j
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    @Autowired
    private MeterRegistry meterRegistry;
    
    private final Counter orderCreatedCounter;
    private final Timer orderCreationTimer;
    private final Gauge activeOrdersGauge;
    
    public OrderController(MeterRegistry meterRegistry, OrderService orderService) {
        this.meterRegistry = meterRegistry;
        this.orderService = orderService;
        
        // åˆå§‹åŒ–ç›‘æ§æŒ‡æ ‡
        this.orderCreatedCounter = Counter.builder("orders.created")
            .description("Total number of orders created")
            .register(meterRegistry);
        
        this.orderCreationTimer = Timer.builder("orders.creation.time")
            .description("Time taken to create an order")
            .register(meterRegistry);
        
        this.activeOrdersGauge = Gauge.builder("orders.active")
            .description("Number of active orders")
            .register(meterRegistry, this, OrderController::getActiveOrderCount);
    }
    
    @PostMapping("/orders")
    @Timed(value = "orders.creation.time", description = "Time taken to create an order")
    public ResponseEntity<OrderResponse> createOrder(@RequestBody OrderRequest request) {
        String traceId = MDC.get("traceId");
        
        log.info("Creating order for user: {}, traceId: {}", request.getUserId(), traceId);
        
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            Order order = orderService.createOrder(request);
            
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            orderCreatedCounter.increment(
                Tags.of(
                    "status", "success",
                    "user_type", request.getUserType()
                )
            );
            
            log.info("Order created successfully: {}, traceId: {}", order.getId(), traceId);
            
            return ResponseEntity.ok(OrderResponse.from(order));
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥æŒ‡æ ‡
            orderCreatedCounter.increment(
                Tags.of(
                    "status", "error",
                    "error_type", e.getClass().getSimpleName()
                )
            );
            
            log.error("Failed to create order for user: {}, traceId: {}", 
                request.getUserId(), traceId, e);
            
            throw e;
        } finally {
            sample.stop(orderCreationTimer);
        }
    }
    
    @GetMapping("/orders/{id}")
    @Timed(value = "orders.retrieval.time", description = "Time taken to retrieve an order")
    public ResponseEntity<OrderResponse> getOrder(@PathVariable String id) {
        String traceId = MDC.get("traceId");
        
        log.debug("Retrieving order: {}, traceId: {}", id, traceId);
        
        try {
            Order order = orderService.getOrder(id);
            
            // è®°å½•ç¼“å­˜å‘½ä¸­ç‡
            meterRegistry.counter("orders.cache.hit").increment();
            
            return ResponseEntity.ok(OrderResponse.from(order));
            
        } catch (OrderNotFoundException e) {
            log.warn("Order not found: {}, traceId: {}", id, traceId);
            
            meterRegistry.counter("orders.not_found").increment();
            
            throw e;
        }
    }
    
    private double getActiveOrderCount() {
        return orderService.getActiveOrderCount();
    }
}

// âœ… æ­£ç¡®ï¼šç›‘æ§é…ç½®
@Configuration
@EnableConfigurationProperties(MonitoringProperties.class)
public class MonitoringConfig {
    
    @Bean
    public MeterRegistry meterRegistry() {
        return new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);
    }
    
    @Bean
    public TimedAspect timedAspect(MeterRegistry registry) {
        return new TimedAspect(registry);
    }
    
    @Bean
    public CountedAspect countedAspect(MeterRegistry registry) {
        return new CountedAspect(registry);
    }
}

// âœ… æ­£ç¡®ï¼šå‘Šè­¦è§„åˆ™é…ç½®
@Component
public class AlertingRules {
    
    @EventListener
    public void handleOrderCreationFailure(OrderCreationFailedEvent event) {
        // ä¸šåŠ¡å‘Šè­¦ï¼šè®¢å•åˆ›å»ºå¤±è´¥ç‡è¿‡é«˜
        if (event.getFailureRate() > 0.05) { // 5%
            alertService.sendAlert(
                AlertLevel.CRITICAL,
                "Order creation failure rate exceeded threshold",
                String.format("Current failure rate: %.2f%%", event.getFailureRate() * 100)
            );
        }
    }
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkSystemHealth() {
        // ç³»ç»Ÿèµ„æºå‘Šè­¦
        double cpuUsage = systemMetrics.getCpuUsage();
        double memoryUsage = systemMetrics.getMemoryUsage();
        
        if (cpuUsage > 0.8) {
            alertService.sendAlert(
                AlertLevel.WARNING,
                "High CPU usage detected",
                String.format("CPU usage: %.2f%%", cpuUsage * 100)
            );
        }
        
        if (memoryUsage > 0.85) {
            alertService.sendAlert(
                AlertLevel.CRITICAL,
                "High memory usage detected",
                String.format("Memory usage: %.2f%%", memoryUsage * 100)
            );
        }
    }
}
```

**ä¼˜åŠ¿åˆ†æï¼š**
1. **å…¨é¢çš„ç›‘æ§æŒ‡æ ‡**ï¼šåŒ…å«ä¸šåŠ¡æŒ‡æ ‡ï¼ˆè®¢å•åˆ›å»ºæ•°é‡ã€å“åº”æ—¶é—´ï¼‰å’Œç³»ç»ŸæŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ä½¿ç”¨ç‡ï¼‰
2. **å®Œæ•´çš„é“¾è·¯è¿½è¸ª**ï¼šé€šè¿‡traceIdå®ç°è¯·æ±‚å…¨é“¾è·¯è·Ÿè¸ªï¼Œä¾¿äºé—®é¢˜å®šä½
3. **è¯¦ç»†çš„æ—¥å¿—è®°å½•**ï¼šè®°å½•å…³é”®æ“ä½œçš„æˆåŠŸå’Œå¤±è´¥ä¿¡æ¯ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
4. **æ™ºèƒ½å‘Šè­¦æœºåˆ¶**ï¼šåŸºäºä¸šåŠ¡é˜ˆå€¼å’Œç³»ç»Ÿèµ„æºä½¿ç”¨ç‡è¿›è¡Œåˆ†çº§å‘Šè­¦
5. **æ ‡å‡†åŒ–é…ç½®**ï¼šä½¿ç”¨Spring Boot Actuatorå’ŒMicrometerå®ç°æ ‡å‡†åŒ–ç›‘æ§
6. **å¤šç»´åº¦æ ‡ç­¾**ï¼šé€šè¿‡Tagså®ç°ç›‘æ§æŒ‡æ ‡çš„å¤šç»´åº¦åˆ†æå’Œèšåˆ

**æ¨èå·¥å…·ï¼š**
- **CI/CDï¼š** Jenkinsã€GitLab CIã€GitHub Actions
- **å®¹å™¨åŒ–ï¼š** Dockerã€Kubernetesã€Helm
- **ç›‘æ§ï¼š** Prometheusã€Grafanaã€Micrometer
- **æ—¥å¿—ï¼š** ELK Stackã€Fluentdã€Loki
- **å‘Šè­¦ï¼š** AlertManagerã€PagerDutyã€Slack

### 4.17 æµ‹è¯•ç›¸å…³æ£€æŸ¥

#### 4.17.1 å•å…ƒæµ‹è¯•æ£€æŸ¥ ğŸŸ¡

**æ£€æµ‹ç›®æ ‡**ï¼šç¡®ä¿å•å…ƒæµ‹è¯•çš„è´¨é‡å’Œè¦†ç›–ç‡æ»¡è¶³é¡¹ç›®è¦æ±‚

**æ£€æµ‹æ ‡å‡†**ï¼š
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯•è¦†ç›–ç‡åº”è¾¾åˆ°80%ä»¥ä¸Š
- æµ‹è¯•ç”¨ä¾‹åº”è¦†ç›–æ­£å¸¸æµç¨‹ã€è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ
- æµ‹è¯•ä»£ç åº”æ˜“äºç»´æŠ¤å’Œç†è§£
- æµ‹è¯•ç”¨ä¾‹ä¹‹é—´åº”ç›¸äº’ç‹¬ç«‹ï¼Œä¸ä¾èµ–æ‰§è¡Œé¡ºåº

**æ£€æµ‹æ–¹æ³•**ï¼š
- ä½¿ç”¨JaCoCoç­‰å·¥å…·æ£€æŸ¥ä»£ç è¦†ç›–ç‡
- å®¡æŸ¥æµ‹è¯•ç”¨ä¾‹çš„å®Œæ•´æ€§å’Œè´¨é‡
- æ£€æŸ¥æµ‹è¯•ä»£ç çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§
- éªŒè¯æµ‹è¯•çš„ç‹¬ç«‹æ€§å’Œå¯é‡å¤æ€§

#### 4.17.2 é›†æˆæµ‹è¯•æ£€æŸ¥ ğŸŸ¡

**æ£€æµ‹ç›®æ ‡**ï¼šç¡®ä¿ç³»ç»Ÿå„ç»„ä»¶é—´çš„é›†æˆæµ‹è¯•è¦†ç›–å…³é”®ä¸šåŠ¡æµç¨‹

**æ£€æµ‹æ ‡å‡†**ï¼š
- å¤–éƒ¨æ¥å£åº”æœ‰å®Œæ•´çš„é›†æˆæµ‹è¯•
- æ•°æ®åº“æ“ä½œåº”æœ‰ç›¸åº”çš„æµ‹è¯•éªŒè¯
- å…³é”®ä¸šåŠ¡æµç¨‹åº”æœ‰ç«¯åˆ°ç«¯æµ‹è¯•
- æ€§èƒ½æ•æ„Ÿæ¨¡å—åº”æœ‰æ€§èƒ½æµ‹è¯•

**æ£€æµ‹æ–¹æ³•**ï¼š
- æ£€æŸ¥APIæ¥å£çš„é›†æˆæµ‹è¯•è¦†ç›–æƒ…å†µ
- éªŒè¯æ•°æ®åº“æ“ä½œçš„æµ‹è¯•å®Œæ•´æ€§
- å®¡æŸ¥ç«¯åˆ°ç«¯æµ‹è¯•çš„ä¸šåŠ¡åœºæ™¯è¦†ç›–
- è¯„ä¼°æ€§èƒ½æµ‹è¯•çš„å¿…è¦æ€§å’Œå……åˆ†æ€§

#### 4.17.3 æµ‹è¯•ç¯å¢ƒæ£€æŸ¥ ğŸŸ¡

**æ£€æµ‹ç›®æ ‡**ï¼šç¡®ä¿æµ‹è¯•ç¯å¢ƒçš„ä¸€è‡´æ€§å’Œæµ‹è¯•æ•°æ®çš„æœ‰æ•ˆæ€§

**æ£€æµ‹æ ‡å‡†**ï¼š
- æµ‹è¯•ç¯å¢ƒåº”ä¸ç”Ÿäº§ç¯å¢ƒä¿æŒä¸€è‡´
- æµ‹è¯•æ•°æ®åº”å……åˆ†ä¸”çœŸå®å¯é 
- æµ‹è¯•åº”ç›¸äº’éš”ç¦»ï¼Œé¿å…å¹²æ‰°
- æµ‹è¯•åº”æ”¯æŒè‡ªåŠ¨åŒ–æ‰§è¡Œ

**æ£€æµ‹æ–¹æ³•**ï¼š
- å¯¹æ¯”æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒçš„é…ç½®å·®å¼‚
- æ£€æŸ¥æµ‹è¯•æ•°æ®çš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§
- éªŒè¯æµ‹è¯•éš”ç¦»æœºåˆ¶çš„æœ‰æ•ˆæ€§
- è¯„ä¼°æµ‹è¯•è‡ªåŠ¨åŒ–çš„å®ç°ç¨‹åº¦

### 4.18 å½±å“åˆ†ææ£€æŸ¥

#### 4.18.1 å˜æ›´å½±å“æœ€å°åŒ– ğŸ”´

**æ£€æµ‹ç›®æ ‡**ï¼šç¡®ä¿ä»£ç å˜æ›´å¯¹ç³»ç»Ÿçš„å½±å“èŒƒå›´å¯æ§ä¸”æœ€å°åŒ–

**æ£€æµ‹æ ‡å‡†**ï¼š
- å˜æ›´åº”è¯¥éµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œé¿å…å¤§èŒƒå›´ä¿®æ”¹
- ä¿®æ”¹åº”è¯¥å‘åå…¼å®¹ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½
- æ¥å£å˜æ›´åº”è¯¥æœ‰ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥
- æ•°æ®åº“å˜æ›´åº”è¯¥æœ‰è¿ç§»è„šæœ¬å’Œå›æ»šæ–¹æ¡ˆ

**æ£€æµ‹æ–¹æ³•**ï¼š
- åˆ†æå˜æ›´çš„ä»£ç èŒƒå›´å’Œä¾èµ–å…³ç³»
- æ£€æŸ¥æ˜¯å¦æœ‰ç ´åæ€§å˜æ›´
- è¯„ä¼°å¯¹ä¸‹æ¸¸ç³»ç»Ÿçš„å½±å“
- ç¡®è®¤å˜æ›´çš„å¿…è¦æ€§å’Œåˆç†æ€§

**é”™è¯¯ç¤ºä¾‹**ï¼š
```java
// âŒ å¤§èŒƒå›´ä¿®æ”¹ï¼Œå½±å“é¢è¿‡å¤§
public class UserService {
    // åŒæ—¶ä¿®æ”¹å¤šä¸ªä¸ç›¸å…³çš„æ–¹æ³•
    public void createUser() { /* ä¿®æ”¹1 */ }
    public void updateUser() { /* ä¿®æ”¹2 */ }
    public void deleteUser() { /* ä¿®æ”¹3 */ }
    public void sendEmail() { /* ä¿®æ”¹4 */ }
    public void generateReport() { /* ä¿®æ”¹5 */ }
}

// âŒ ç ´åæ€§æ¥å£å˜æ›´
@RestController
public class UserController {
    // ç›´æ¥åˆ é™¤åŸæœ‰æ¥å£ï¼Œç ´åå‘åå…¼å®¹æ€§
    // @GetMapping("/users/{id}")
    // public User getUser(@PathVariable Long id) { ... }
    
    @GetMapping("/users/{userId}")
    public UserDto getUserInfo(@PathVariable Long userId) {
        // å®Œå…¨ä¸åŒçš„è¿”å›ç»“æ„
    }
}
```

**æ­£ç¡®ç¤ºä¾‹**ï¼š
```java
// âœ… å°èŒƒå›´ã€å•ä¸€èŒè´£çš„å˜æ›´
public class UserService {
    // åªä¿®æ”¹ç‰¹å®šåŠŸèƒ½
    public User createUser(CreateUserRequest request) {
        // æ–°å¢åŠŸèƒ½ï¼Œä¸å½±å“ç°æœ‰ä»£ç 
        validateUserRequest(request);
        return userRepository.save(convertToUser(request));
    }
}

// âœ… å‘åå…¼å®¹çš„æ¥å£è®¾è®¡
@RestController
public class UserController {
    // ä¿ç•™åŸæœ‰æ¥å£
    @GetMapping("/users/{id}")
    @Deprecated
    public User getUser(@PathVariable Long id) {
        return getUserV2(id).toUser();
    }
    
    // æ–°ç‰ˆæœ¬æ¥å£
    @GetMapping("/v2/users/{id}")
    public UserDto getUserV2(@PathVariable Long id) {
        return userService.findUserById(id);
    }
}
```

**ä¼˜åŠ¿åˆ†æ**ï¼š
- éµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œå˜æ›´èŒƒå›´å¯æ§ä¸”æ˜“äºæµ‹è¯•
- å‘åå…¼å®¹è®¾è®¡ä¿æŠ¤ç°æœ‰å®¢æˆ·ç«¯ä¸å—å½±å“
- ç‰ˆæœ¬åŒ–æ¥å£æä¾›å¹³æ»‘çš„è¿ç§»è·¯å¾„
- æ˜ç¡®çš„åºŸå¼ƒæ ‡è®°ç»™ç”¨æˆ·å……åˆ†çš„è¿ç§»æ—¶é—´

#### 4.18.2 å¤‡ä»½å’Œå›æ»šæ–¹æ¡ˆ ğŸ”´

**æ£€æµ‹ç›®æ ‡**ï¼šç¡®ä¿å˜æ›´å…·æœ‰å®Œå–„çš„å¤‡ä»½å’Œå›æ»šæœºåˆ¶

**æ£€æµ‹æ ‡å‡†**ï¼š
- æ•°æ®åº“å˜æ›´å¿…é¡»æœ‰å›æ»šè„šæœ¬
- é…ç½®å˜æ›´å¿…é¡»æœ‰å¤‡ä»½å’Œæ¢å¤æ–¹æ¡ˆ
- éƒ¨ç½²å¿…é¡»æ”¯æŒå¿«é€Ÿå›æ»š
- å…³é”®æ•°æ®å˜æ›´å‰å¿…é¡»å¤‡ä»½

**æ£€æµ‹æ–¹æ³•**ï¼š
- æ£€æŸ¥æ˜¯å¦æä¾›äº†å›æ»šè„šæœ¬
- éªŒè¯å›æ»šæ–¹æ¡ˆçš„å¯è¡Œæ€§
- ç¡®è®¤å¤‡ä»½ç­–ç•¥çš„å®Œæ•´æ€§
- æµ‹è¯•å›æ»šæµç¨‹çš„æœ‰æ•ˆæ€§

**é”™è¯¯ç¤ºä¾‹**ï¼š
```sql
-- âŒ æ²¡æœ‰å›æ»šæ–¹æ¡ˆçš„æ•°æ®åº“å˜æ›´
ALTER TABLE users DROP COLUMN old_field;
ALTER TABLE users ADD COLUMN new_field VARCHAR(255);
-- ç¼ºå°‘å›æ»šè„šæœ¬
```

**é—®é¢˜åˆ†æ**ï¼š
- åˆ é™¤å­—æ®µæ“ä½œä¸å¯é€†ï¼Œæ•°æ®æ°¸ä¹…ä¸¢å¤±
- ç¼ºå°‘å›æ»šè„šæœ¬ï¼Œå‡ºç°é—®é¢˜æ—¶æ— æ³•å¿«é€Ÿæ¢å¤
- æ²¡æœ‰æ•°æ®å¤‡ä»½ï¼Œæ— æ³•ä¿éšœæ•°æ®å®‰å…¨
- å˜æ›´é£é™©é«˜ï¼Œå½±å“ç³»ç»Ÿç¨³å®šæ€§

**æ­£ç¡®ç¤ºä¾‹**ï¼š
```sql
-- âœ… å®Œæ•´çš„æ•°æ®åº“å˜æ›´æ–¹æ¡ˆ
-- å‡çº§è„šæœ¬ (V1.1__add_user_profile.sql)
ALTER TABLE users ADD COLUMN profile_data JSON;
UPDATE users SET profile_data = '{}' WHERE profile_data IS NULL;

-- å›æ»šè„šæœ¬ (V1.1__add_user_profile_rollback.sql)
ALTER TABLE users DROP COLUMN profile_data;
```

```java
// âœ… æ”¯æŒå›æ»šçš„é…ç½®å˜æ›´
@Component
public class ConfigurationManager {
    
    public void updateConfiguration(String key, String newValue) {
        // å¤‡ä»½åŸé…ç½®
        String oldValue = configRepository.findByKey(key);
        configBackupService.backup(key, oldValue);
        
        try {
            configRepository.updateValue(key, newValue);
            log.info("é…ç½®æ›´æ–°æˆåŠŸ: {} = {}", key, newValue);
        } catch (Exception e) {
            // è‡ªåŠ¨å›æ»š
            rollbackConfiguration(key);
            throw new ConfigurationUpdateException("é…ç½®æ›´æ–°å¤±è´¥", e);
        }
    }
    
    public void rollbackConfiguration(String key) {
        String backupValue = configBackupService.getBackup(key);
        configRepository.updateValue(key, backupValue);
        log.info("é…ç½®å·²å›æ»š: {} = {}", key, backupValue);
    }
}
```

**ä¼˜åŠ¿åˆ†æ**ï¼š
- å®Œæ•´çš„å¤‡ä»½å’Œå›æ»šæœºåˆ¶ä¿éšœæ•°æ®å®‰å…¨
- è‡ªåŠ¨å›æ»šåŠŸèƒ½å‡å°‘äººå·¥å¹²é¢„å’Œé”™è¯¯
- ç‰ˆæœ¬åŒ–è„šæœ¬ç®¡ç†ä¾¿äºè¿½è¸ªå’Œç»´æŠ¤
- è¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºé—®é¢˜æ’æŸ¥å’Œå®¡è®¡

**ä¼˜åŠ¿åˆ†æ**ï¼š
- å®Œæ•´çš„å¤‡ä»½å’Œå›æ»šæœºåˆ¶ä¿éšœæ•°æ®å®‰å…¨
- è‡ªåŠ¨å›æ»šåŠŸèƒ½å‡å°‘äººå·¥å¹²é¢„å’Œé”™è¯¯
- ç‰ˆæœ¬åŒ–è„šæœ¬ç®¡ç†ä¾¿äºè¿½è¸ªå’Œç»´æŠ¤
- è¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºé—®é¢˜æ’æŸ¥å’Œå®¡è®¡

#### 4.18.3 ç°åº¦æµ‹è¯•æœºåˆ¶ ğŸ”´

**æ£€æµ‹ç›®æ ‡**ï¼šç¡®ä¿å˜æ›´é€šè¿‡åˆç†çš„å¼€å…³å’Œç°åº¦æœºåˆ¶é€æ­¥å‘å¸ƒ

**æ£€æµ‹æ ‡å‡†**ï¼š
- æ–°åŠŸèƒ½åº”è¯¥æœ‰åŠŸèƒ½å¼€å…³æ§åˆ¶
- é‡è¦å˜æ›´åº”è¯¥æ”¯æŒç°åº¦å‘å¸ƒ
- åº”è¯¥æœ‰ç›‘æ§å’Œå¿«é€Ÿæ­¢æŸæœºåˆ¶
- ç°åº¦ç­–ç•¥åº”è¯¥åˆç†ä¸”å¯æ§

**æ£€æµ‹æ–¹æ³•**ï¼š
- æ£€æŸ¥æ˜¯å¦å®ç°äº†åŠŸèƒ½å¼€å…³
- éªŒè¯ç°åº¦å‘å¸ƒç­–ç•¥
- ç¡®è®¤ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
- æµ‹è¯•å¿«é€Ÿå›æ»šèƒ½åŠ›

**é”™è¯¯ç¤ºä¾‹**ï¼š
```java
// âŒ æ²¡æœ‰å¼€å…³æ§åˆ¶çš„æ–°åŠŸèƒ½
@Service
public class PaymentService {
    public void processPayment(PaymentRequest request) {
        // ç›´æ¥ä½¿ç”¨æ–°çš„æ”¯ä»˜é€»è¾‘ï¼Œæ— æ³•æ§åˆ¶
        newPaymentProcessor.process(request);
    }
}
```

**é—®é¢˜åˆ†æ**ï¼š
- ç¼ºå°‘åŠŸèƒ½å¼€å…³ï¼Œæ— æ³•æ§åˆ¶æ–°åŠŸèƒ½çš„å¯ç”¨å’Œå…³é—­
- æ²¡æœ‰ç°åº¦å‘å¸ƒæœºåˆ¶ï¼Œé£é™©å…¨é‡æš´éœ²
- ç¼ºå°‘å¼‚å¸¸å¤„ç†å’Œå›é€€æœºåˆ¶ï¼Œå®¹é”™æ€§å·®
- æ— æ³•å¿«é€Ÿæ­¢æŸï¼Œå½±å“ç³»ç»Ÿç¨³å®šæ€§

**æ­£ç¡®ç¤ºä¾‹**ï¼š
```java
// âœ… å¸¦åŠŸèƒ½å¼€å…³çš„ç°åº¦å‘å¸ƒ
@Service
public class PaymentService {
    
    @Value("${feature.new-payment-processor.enabled:false}")
    private boolean newPaymentProcessorEnabled;
    
    @Value("${feature.new-payment-processor.rollout-percentage:0}")
    private int rolloutPercentage;
    
    public void processPayment(PaymentRequest request) {
        if (shouldUseNewProcessor(request)) {
            try {
                newPaymentProcessor.process(request);
                metricsService.incrementCounter("payment.new_processor.success");
            } catch (Exception e) {
                log.error("æ–°æ”¯ä»˜å¤„ç†å™¨å¤±è´¥ï¼Œå›é€€åˆ°æ—§å¤„ç†å™¨", e);
                metricsService.incrementCounter("payment.new_processor.fallback");
                oldPaymentProcessor.process(request);
            }
        } else {
            oldPaymentProcessor.process(request);
        }
    }
    
    private boolean shouldUseNewProcessor(PaymentRequest request) {
        if (!newPaymentProcessorEnabled) {
            return false;
        }
        
        // åŸºäºç”¨æˆ·IDçš„ç°åº¦ç­–ç•¥
        int userHash = Math.abs(request.getUserId().hashCode() % 100);
        return userHash < rolloutPercentage;
    }
}
```

**ä¼˜åŠ¿åˆ†æ**ï¼š
- åŠŸèƒ½å¼€å…³æä¾›å®Œå…¨çš„æ§åˆ¶èƒ½åŠ›ï¼Œå¯éšæ—¶å¯ç”¨æˆ–å…³é—­æ–°åŠŸèƒ½
- åŸºäºç™¾åˆ†æ¯”çš„ç°åº¦ç­–ç•¥å®ç°æ¸è¿›å¼å‘å¸ƒï¼Œé™ä½é£é™©
- å¼‚å¸¸å¤„ç†å’Œè‡ªåŠ¨å›é€€æœºåˆ¶ä¿éšœç³»ç»Ÿç¨³å®šæ€§
- è¯¦ç»†çš„ç›‘æ§æŒ‡æ ‡ä¾¿äºè§‚å¯Ÿæ–°åŠŸèƒ½çš„è¡¨ç°å’Œå½±å“
- å¼‚å¸¸å¤„ç†å’Œè‡ªåŠ¨å›é€€æœºåˆ¶ä¿éšœç³»ç»Ÿç¨³å®šæ€§
- è¯¦ç»†çš„ç›‘æ§æŒ‡æ ‡ä¾¿äºè§‚å¯Ÿæ–°åŠŸèƒ½è¡¨ç°

**æ¨èå·¥å…·**ï¼š
- **åŠŸèƒ½å¼€å…³**ï¼šLaunchDarklyã€Unleashã€Spring Cloud Config
- **ç°åº¦å‘å¸ƒ**ï¼šIstioã€Linkerdã€Kong
- **ç›‘æ§å‘Šè­¦**ï¼šPrometheus + Grafanaã€DataDogã€New Relic
- **å›æ»šå·¥å…·**ï¼šKubernetesã€Docker Swarmã€Jenkins

### 4.19 è®¾è®¡ä¸éœ€æ±‚åŒ¹é…æ£€æŸ¥

**ç¬¬å…­åä¹æ¡** è®¾è®¡ä¸éœ€æ±‚åŒ¹é…æ£€æŸ¥ ğŸ”´ï¼š

#### 4.19.1 æ–¹æ¡ˆæœ€ä¼˜æ€§è¯„ä¼°

**æ£€æŸ¥ç›®æ ‡**ï¼šç¡®ä¿è®¾è®¡æ–¹æ¡ˆåœ¨éœ€æ±‚åŒ¹é…ã€æˆæœ¬å’Œå¯è¡Œæ€§æ–¹é¢è¾¾åˆ°ç›¸å¯¹æœ€ä½³

**æ£€æµ‹æ ‡å‡†ï¼š**
- è®¾è®¡æ–¹æ¡ˆå®Œå…¨æ»¡è¶³åŠŸèƒ½éœ€æ±‚
- éåŠŸèƒ½éœ€æ±‚ï¼ˆæ€§èƒ½ã€å®‰å…¨ã€å¯ç”¨æ€§ï¼‰å¾—åˆ°å……åˆ†è€ƒè™‘
- æŠ€æœ¯é€‰å‹åˆç†ï¼Œç¬¦åˆå›¢é˜ŸæŠ€æœ¯æ ˆ
- å¼€å‘æˆæœ¬å’Œç»´æŠ¤æˆæœ¬åœ¨å¯æ¥å—èŒƒå›´å†…
- æ–¹æ¡ˆå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§

**æ£€æµ‹æ–¹æ³•ï¼š**
- éœ€æ±‚è¦†ç›–åº¦åˆ†æ
- æŠ€æœ¯æ–¹æ¡ˆè¯„å®¡
- æˆæœ¬æ•ˆç›Šåˆ†æ
- é£é™©è¯„ä¼°
- å¯è¡Œæ€§éªŒè¯

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ è¿‡åº¦è®¾è®¡ï¼Œä¸ç¬¦åˆå®é™…éœ€æ±‚
public class SimpleUserService {
    // éœ€æ±‚åªæ˜¯ç®€å•çš„CRUDï¼Œå´å¼•å…¥äº†å¤æ‚çš„è®¾è®¡æ¨¡å¼
    private final UserFactory userFactory;
    private final UserBuilder userBuilder;
    private final UserValidator userValidator;
    private final UserTransformer userTransformer;
    private final UserEventPublisher userEventPublisher;
    private final UserCacheManager userCacheManager;
    
    // å¤æ‚çš„å·¥å‚æ¨¡å¼ï¼Œå®é™…ä¸éœ€è¦
    public User createUser(CreateUserRequest request) {
        UserCreationContext context = UserCreationContext.builder()
            .withRequest(request)
            .withValidationRules(getValidationRules())
            .withTransformationRules(getTransformationRules())
            .build();
            
        return userFactory.createUser(context);
    }
}

// âŒ æŠ€æœ¯é€‰å‹ä¸å½“
@Entity
public class User {
    // ç®€å•çš„ç”¨æˆ·è¡¨å´ä½¿ç”¨äº†å¤æ‚çš„ç»§æ‰¿ç»“æ„
    @Inheritance(strategy = InheritanceType.JOINED)
    @DiscriminatorColumn(name = "user_type")
    private Long id;
    // ...
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… ç®€æ´åˆç†çš„è®¾è®¡ï¼Œæ»¡è¶³éœ€æ±‚
@Service
public class UserService {
    private final UserRepository userRepository;
    private final UserValidator userValidator;
    
    public User createUser(CreateUserRequest request) {
        // ç®€å•ç›´æ¥çš„å®ç°ï¼Œæ»¡è¶³CRUDéœ€æ±‚
        userValidator.validate(request);
        User user = User.builder()
            .username(request.getUsername())
            .email(request.getEmail())
            .build();
        return userRepository.save(user);
    }
    
    public User updateUser(Long id, UpdateUserRequest request) {
        User user = findUserById(id);
        user.updateEmail(request.getEmail());
        return userRepository.save(user);
    }
}

// âœ… åˆç†çš„æŠ€æœ¯é€‰å‹
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String username;
    
    @Column(nullable = false)
    private String email;
    
    // ç®€å•çš„å®ä½“è®¾è®¡ï¼Œç¬¦åˆä¸šåŠ¡éœ€æ±‚
}
```

#### 4.19.2 æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

**æ£€æŸ¥ç›®æ ‡**ï¼šç¡®ä¿å·²è€ƒè™‘å¹¶å¯¹æ¯”äº†å¯èƒ½çš„æ›¿ä»£æ–¹æ¡ˆ

**æ£€æµ‹æ ‡å‡†ï¼š**
- è‡³å°‘è€ƒè™‘äº†2-3ç§å¯è¡Œæ–¹æ¡ˆ
- å¯¹æ¯”äº†å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹
- é€‰æ‹©ç†ç”±å……åˆ†ä¸”æœ‰è¯´æœåŠ›
- è€ƒè™‘äº†é•¿æœŸç»´æŠ¤å’Œæ¼”è¿›

**æ£€æµ‹æ–¹æ³•**ï¼š
- æ–¹æ¡ˆå¯¹æ¯”æ–‡æ¡£å®¡æŸ¥
- æŠ€æœ¯è°ƒç ”æŠ¥å‘Šè¯„ä¼°
- åŸå‹éªŒè¯ç»“æœåˆ†æ
- ä¸“å®¶è¯„å®¡æ„è§æ”¶é›†

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… ç¼“å­˜æ–¹æ¡ˆå¯¹æ¯”åˆ†æ
/**
 * ç¼“å­˜æ–¹æ¡ˆé€‰æ‹©åˆ†æï¼š
 * 
 * æ–¹æ¡ˆ1ï¼šæœ¬åœ°ç¼“å­˜ (Caffeine)
 * ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€é«˜ï¼Œæ— ç½‘ç»œå¼€é”€
 * ç¼ºç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå†…å­˜å ç”¨
 * é€‚ç”¨åœºæ™¯ï¼šè¯»å¤šå†™å°‘ï¼Œæ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜
 * 
 * æ–¹æ¡ˆ2ï¼šåˆ†å¸ƒå¼ç¼“å­˜ (Redis)
 * ä¼˜ç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§å¥½ï¼Œæ”¯æŒé›†ç¾¤
 * ç¼ºç‚¹ï¼šç½‘ç»œå¼€é”€ï¼Œè¿ç»´å¤æ‚åº¦
 * é€‚ç”¨åœºæ™¯ï¼šå¤šå®ä¾‹éƒ¨ç½²ï¼Œæ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜
 * 
 * æ–¹æ¡ˆ3ï¼šæ··åˆç¼“å­˜ (æœ¬åœ°+åˆ†å¸ƒå¼)
 * ä¼˜ç‚¹ï¼šå…¼é¡¾æ€§èƒ½å’Œä¸€è‡´æ€§
 * ç¼ºç‚¹ï¼šå®ç°å¤æ‚åº¦é«˜
 * é€‚ç”¨åœºæ™¯ï¼šé«˜å¹¶å‘ï¼Œå¯¹æ€§èƒ½å’Œä¸€è‡´æ€§éƒ½æœ‰è¦æ±‚
 * 
 * é€‰æ‹©ï¼šåŸºäºå½“å‰QPSå’Œä¸€è‡´æ€§è¦æ±‚ï¼Œé€‰æ‹©æ–¹æ¡ˆ2
 */
@Service
public class ProductService {
    
    @Cacheable(value = "products", key = "#id")
    public Product findById(Long id) {
        return productRepository.findById(id)
            .orElseThrow(() -> new ProductNotFoundException(id));
    }
}
```

#### 4.19.3 éœ€æ±‚ä¸€è‡´æ€§æ£€æŸ¥

**æ£€æŸ¥ç›®æ ‡ï¼š** ç¡®ä¿ä»£ç å®ç°ä¸éœ€æ±‚å£°æ˜å®Œå…¨ä¸€è‡´

**æ£€æµ‹æ ‡å‡†ï¼š**
- æ‰€æœ‰éœ€æ±‚åŠŸèƒ½ç‚¹éƒ½æœ‰å¯¹åº”å®ç°
- å®ç°çš„åŠŸèƒ½ä¸è¶…å‡ºéœ€æ±‚èŒƒå›´
- ä¸šåŠ¡è§„åˆ™å®ç°æ­£ç¡®
- å¼‚å¸¸å¤„ç†ç¬¦åˆéœ€æ±‚å®šä¹‰

**æ£€æµ‹æ–¹æ³•ï¼š**
- éœ€æ±‚è¿½æº¯çŸ©é˜µæ£€æŸ¥
- åŠŸèƒ½ç‚¹é€ä¸€éªŒè¯
- ä¸šåŠ¡è§„åˆ™æµ‹è¯•
- ç”¨æˆ·éªŒæ”¶æµ‹è¯•

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ å®ç°è¶…å‡ºéœ€æ±‚èŒƒå›´
// éœ€æ±‚ï¼šç”¨æˆ·æ³¨å†Œæ—¶éªŒè¯é‚®ç®±æ ¼å¼
public class UserRegistrationService {
    public User registerUser(RegisterRequest request) {
        validateEmail(request.getEmail());
        
        // âŒ éœ€æ±‚ä¸­æ²¡æœ‰è¦æ±‚å‘é€æ¬¢è¿é‚®ä»¶
        sendWelcomeEmail(request.getEmail());
        
        // âŒ éœ€æ±‚ä¸­æ²¡æœ‰è¦æ±‚åˆ›å»ºé»˜è®¤é…ç½®
        createDefaultUserSettings(user);
        
        return userRepository.save(user);
    }
}

// âŒ ä¸šåŠ¡è§„åˆ™å®ç°é”™è¯¯
// éœ€æ±‚ï¼šè®¢å•é‡‘é¢è¶…è¿‡1000å…ƒå…è¿è´¹
public class OrderService {
    public Order calculateOrder(OrderRequest request) {
        BigDecimal total = calculateTotal(request.getItems());
        
        // âŒ é”™è¯¯çš„å…è¿è´¹æ¡ä»¶ï¼ˆåº”è¯¥æ˜¯>=1000ï¼‰
        if (total.compareTo(new BigDecimal("999")) > 0) {
            order.setShippingFee(BigDecimal.ZERO);
        }
        
        return order;
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… ä¸¥æ ¼æŒ‰éœ€æ±‚å®ç°
// éœ€æ±‚ï¼šç”¨æˆ·æ³¨å†Œæ—¶éªŒè¯é‚®ç®±æ ¼å¼ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯
public class UserRegistrationService {
    public User registerUser(RegisterRequest request) {
        // æŒ‰éœ€æ±‚éªŒè¯é‚®ç®±
        validateEmail(request.getEmail());
        
        // æŒ‰éœ€æ±‚ä¿å­˜ç”¨æˆ·
        User user = User.builder()
            .username(request.getUsername())
            .email(request.getEmail())
            .build();
            
        return userRepository.save(user);
    }
    
    private void validateEmail(String email) {
        if (!EmailValidator.isValid(email)) {
            throw new InvalidEmailException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
        }
    }
}

// âœ… æ­£ç¡®çš„ä¸šåŠ¡è§„åˆ™å®ç°
// éœ€æ±‚ï¼šè®¢å•é‡‘é¢æ»¡1000å…ƒå…è¿è´¹
public class OrderService {
    private static final BigDecimal FREE_SHIPPING_THRESHOLD = new BigDecimal("1000");
    
    public Order calculateOrder(OrderRequest request) {
        BigDecimal total = calculateTotal(request.getItems());
        
        // æ­£ç¡®çš„å…è¿è´¹æ¡ä»¶
        if (total.compareTo(FREE_SHIPPING_THRESHOLD) >= 0) {
            order.setShippingFee(BigDecimal.ZERO);
        } else {
            order.setShippingFee(calculateShippingFee(request));
        }
        
        return order;
    }
}
```

**æ¨èå·¥å…·**ï¼š
- **éœ€æ±‚ç®¡ç†**ï¼šJiraã€Azure DevOpsã€Confluence
- **æ–¹æ¡ˆè®¾è®¡**ï¼šDraw.ioã€Lucidchartã€PlantUML
- **åŸå‹å·¥å…·**ï¼šFigmaã€Axureã€Mockplus
- **æ–‡æ¡£ç®¡ç†**ï¼šGitBookã€Notionã€Wiki

### 4.20 æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥

**ç¬¬ä¸ƒåæ¡** æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥ ğŸŸ¡ï¼š

#### 4.20.1 æ–‡æ¡£è§„èŒƒä¸€è‡´æ€§

**æ£€æŸ¥ç›®æ ‡**ï¼šç¡®ä¿å„ç±»æ–‡æ¡£è§„èŒƒç»Ÿä¸€ï¼Œå†…å®¹ä¸€è‡´

**æ£€æµ‹æ ‡å‡†ï¼š**
- APIæ–‡æ¡£ä¸å®é™…æ¥å£å®ç°ä¸€è‡´
- éœ€æ±‚æ–‡æ¡£ä¸ä»£ç å®ç°åŒ¹é…
- å˜æ›´æ–‡æ¡£è®°å½•å®Œæ•´å‡†ç¡®
- ç”¨æˆ·æŒ‡å—ä¸ç³»ç»ŸåŠŸèƒ½å¯¹åº”
- æ¶æ„æ–‡æ¡£åæ˜ çœŸå®æ¶æ„

**æ£€æµ‹æ–¹æ³•ï¼š**
- æ–‡æ¡£ä¸ä»£ç å¯¹æ¯”æ£€æŸ¥
- æ¥å£æ–‡æ¡£è‡ªåŠ¨åŒ–éªŒè¯
- æ–‡æ¡£ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
- äº¤å‰å¼•ç”¨å®Œæ•´æ€§éªŒè¯

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ APIå®ç°ä¸æ–‡æ¡£ä¸ä¸€è‡´
/**
 * è·å–ç”¨æˆ·ä¿¡æ¯
 * @param id ç”¨æˆ·ID
 * @return ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
 * @deprecated è¯¥æ¥å£å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ /v2/users/{id}
 */
@GetMapping("/users/{id}")
public ResponseEntity<User> getUser(@PathVariable Long id) {
    // æ–‡æ¡£è¯´å·²åºŸå¼ƒï¼Œä½†å®ç°ä¸­æ²¡æœ‰åºŸå¼ƒæ ‡è®°
    User user = userService.findById(id);
    return ResponseEntity.ok(user);
}

// âŒ å‚æ•°æ–‡æ¡£ä¸å®ç°ä¸åŒ¹é…
/**
 * åˆ›å»ºç”¨æˆ·
 * @param request ç”¨æˆ·åˆ›å»ºè¯·æ±‚ï¼ŒåŒ…å«usernameå’Œemail
 * @return åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯
 */
@PostMapping("/users")
public ResponseEntity<User> createUser(@RequestBody CreateUserRequest request) {
    // å®é™…è¿˜éœ€è¦phoneå­—æ®µï¼Œä½†æ–‡æ¡£ä¸­æ²¡æœ‰è¯´æ˜
    if (request.getPhone() == null) {
        throw new ValidationException("æ‰‹æœºå·ä¸èƒ½ä¸ºç©º");
    }
    return ResponseEntity.ok(userService.createUser(request));
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… APIæ–‡æ¡£ä¸å®ç°å®Œå…¨ä¸€è‡´
/**
 * è·å–ç”¨æˆ·ä¿¡æ¯
 * 
 * @param id ç”¨æˆ·IDï¼Œå¿…é¡»ä¸ºæ­£æ•´æ•°
 * @return ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…å«idã€usernameã€emailã€createdAt
 * @throws UserNotFoundException å½“ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡º
 * @since 1.0.0
 * @author å¼€å‘å›¢é˜Ÿ
 */
@GetMapping("/users/{id}")
@Operation(summary = "è·å–ç”¨æˆ·ä¿¡æ¯", description = "æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯")
@ApiResponses({
    @ApiResponse(responseCode = "200", description = "æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯"),
    @ApiResponse(responseCode = "404", description = "ç”¨æˆ·ä¸å­˜åœ¨")
})
public ResponseEntity<UserResponse> getUser(
    @Parameter(description = "ç”¨æˆ·ID", required = true, example = "1")
    @PathVariable Long id) {
    
    User user = userService.findById(id);
    return ResponseEntity.ok(UserResponse.from(user));
}

// âœ… å®Œæ•´çš„è¯·æ±‚å‚æ•°æ–‡æ¡£
/**
 * åˆ›å»ºç”¨æˆ·
 * 
 * @param request ç”¨æˆ·åˆ›å»ºè¯·æ±‚
 * @return åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯
 * @throws ValidationException å½“è¯·æ±‚å‚æ•°ä¸åˆæ³•æ—¶æŠ›å‡º
 */
@PostMapping("/users")
@Operation(summary = "åˆ›å»ºç”¨æˆ·", description = "åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ·")
public ResponseEntity<UserResponse> createUser(
    @Parameter(description = "ç”¨æˆ·åˆ›å»ºè¯·æ±‚", required = true)
    @Valid @RequestBody CreateUserRequest request) {
    
    User user = userService.createUser(request);
    return ResponseEntity.status(HttpStatus.CREATED)
        .body(UserResponse.from(user));
}

// è¯·æ±‚å¯¹è±¡æ–‡æ¡£
@Schema(description = "ç”¨æˆ·åˆ›å»ºè¯·æ±‚")
public class CreateUserRequest {
    
    @Schema(description = "ç”¨æˆ·å", example = "john_doe", required = true)
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;
    
    @Schema(description = "é‚®ç®±åœ°å€", example = "john@example.com", required = true)
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
    
    @Schema(description = "æ‰‹æœºå·", example = "13800138000", required = true)
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    private String phone;
}
```

#### 4.20.2 æ–‡æ¡£å®Œæ•´æ€§è¦†ç›–

**æ£€æŸ¥ç›®æ ‡**ï¼šç¡®ä¿æ‰€æœ‰å¿…è¦çš„æ–‡æ¡£éƒ½å·²åˆ›å»ºå¹¶ä¿æŒæ›´æ–°

**æ£€æµ‹æ ‡å‡†ï¼š**
- æ¯ä¸ªå…¬å…±APIéƒ½æœ‰å®Œæ•´æ–‡æ¡£
- å¤æ‚ä¸šåŠ¡é€»è¾‘æœ‰è®¾è®¡æ–‡æ¡£
- é…ç½®å˜æ›´æœ‰å˜æ›´è®°å½•
- éƒ¨ç½²æµç¨‹æœ‰æ“ä½œæ‰‹å†Œ
- æ•…éšœå¤„ç†æœ‰åº”æ€¥é¢„æ¡ˆ

**æ£€æµ‹æ–¹æ³•ï¼š**
- æ–‡æ¡£æ¸…å•æ£€æŸ¥
- æ–‡æ¡£è¦†ç›–ç‡ç»Ÿè®¡
- æ–‡æ¡£æ›´æ–°æ—¶æ•ˆæ€§æ£€æŸ¥
- æ–‡æ¡£å¯ç”¨æ€§éªŒè¯

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… å®Œæ•´çš„æœåŠ¡æ–‡æ¡£
/**
 * è®¢å•æœåŠ¡
 * 
 * è´Ÿè´£å¤„ç†è®¢å•ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬ï¼š
 * - è®¢å•åˆ›å»ºå’Œä¿®æ”¹
 * - è®¢å•çŠ¶æ€ç®¡ç†
 * - è®¢å•æ”¯ä»˜å¤„ç†
 * - è®¢å•å‘è´§è·Ÿè¸ª
 * 
 * ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. è®¢å•åˆ›å»ºå30åˆ†é’Ÿå†…æœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ
 * 2. è®¢å•é‡‘é¢æ»¡1000å…ƒå…è¿è´¹
 * 3. æ”¯æŒçš„æ”¯ä»˜æ–¹å¼ï¼šæ”¯ä»˜å®ã€å¾®ä¿¡ã€é“¶è¡Œå¡
 * 
 * ä¾èµ–æœåŠ¡ï¼š
 * - ç”¨æˆ·æœåŠ¡ï¼šéªŒè¯ç”¨æˆ·ä¿¡æ¯
 * - å•†å“æœåŠ¡ï¼šè·å–å•†å“ä¿¡æ¯å’Œåº“å­˜
 * - æ”¯ä»˜æœåŠ¡ï¼šå¤„ç†æ”¯ä»˜è¯·æ±‚
 * - ç‰©æµæœåŠ¡ï¼šå®‰æ’å‘è´§
 * 
 * é…ç½®å‚æ•°ï¼š
 * - order.auto-cancel-minutes: è‡ªåŠ¨å–æ¶ˆæ—¶é—´ï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰
 * - order.free-shipping-threshold: å…è¿è´¹é—¨æ§›ï¼ˆé»˜è®¤1000å…ƒï¼‰
 * 
 * ç›‘æ§æŒ‡æ ‡ï¼š
 * - order.created.count: è®¢å•åˆ›å»ºæ•°é‡
 * - order.payment.success.rate: æ”¯ä»˜æˆåŠŸç‡
 * - order.processing.time: è®¢å•å¤„ç†æ—¶é—´
 * 
 * @author è®¢å•å›¢é˜Ÿ
 * @version 2.1.0
 * @since 1.0.0
 */
@Service
@Slf4j
public class OrderService {
    
    /**
     * åˆ›å»ºè®¢å•
     * 
     * ä¸šåŠ¡æµç¨‹ï¼š
     * 1. éªŒè¯ç”¨æˆ·ä¿¡æ¯
     * 2. æ£€æŸ¥å•†å“åº“å­˜
     * 3. è®¡ç®—è®¢å•é‡‘é¢
     * 4. åˆ›å»ºè®¢å•è®°å½•
     * 5. å‘é€è®¢å•ç¡®è®¤é€šçŸ¥
     * 
     * @param request è®¢å•åˆ›å»ºè¯·æ±‚
     * @return åˆ›å»ºçš„è®¢å•ä¿¡æ¯
     * @throws UserNotFoundException ç”¨æˆ·ä¸å­˜åœ¨
     * @throws ProductNotFoundException å•†å“ä¸å­˜åœ¨
     * @throws InsufficientStockException åº“å­˜ä¸è¶³
     */
    @Transactional
    public Order createOrder(CreateOrderRequest request) {
        // å®ç°é€»è¾‘...
    }
}
```

**æ¨èå·¥å…·**ï¼š
- **APIæ–‡æ¡£**ï¼šSwagger/OpenAPIã€Postmanã€Insomnia
- **ä»£ç æ–‡æ¡£**ï¼šJavaDocã€GitBookã€Confluence
- **æ¶æ„æ–‡æ¡£**ï¼šPlantUMLã€Draw.ioã€Mermaid
- **å˜æ›´ç®¡ç†**ï¼šGitã€Jiraã€Confluence

### 4.21 é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥

**ç¬¬ä¸ƒåä¸€æ¡** é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥ ğŸ”´ï¼š

#### 4.21.1 ä¸šåŠ¡æµç¨‹è¦†ç›–æ€§

**æ£€æŸ¥ç›®æ ‡**ï¼šç¡®ä¿ä¸šåŠ¡é€»è¾‘è¦†ç›–æ‰€æœ‰æ­£å¸¸æµç¨‹å’Œå¼‚å¸¸æƒ…å†µ

**æ£€æµ‹æ ‡å‡†ï¼š**
- æ‰€æœ‰ä¸šåŠ¡åˆ†æ”¯éƒ½æœ‰å¯¹åº”çš„å¤„ç†é€»è¾‘
- å¼‚å¸¸æƒ…å†µæœ‰æ˜ç¡®çš„å¤„ç†ç­–ç•¥
- è¾¹ç•Œæ¡ä»¶å¾—åˆ°å……åˆ†è€ƒè™‘
- å¹¶å‘åœºæ™¯æœ‰ç›¸åº”çš„ä¿æŠ¤æœºåˆ¶

**æ£€æµ‹æ–¹æ³•ï¼š**
- ä¸šåŠ¡æµç¨‹å›¾åˆ†æ
- ä»£ç è·¯å¾„è¦†ç›–æ£€æŸ¥
- å¼‚å¸¸åœºæ™¯æµ‹è¯•
- è¾¹ç•Œå€¼æµ‹è¯•

**é”™è¯¯ç¤ºä¾‹ï¼š**
```java
// âŒ ç¼ºå°‘å¼‚å¸¸åˆ†æ”¯å¤„ç†
public class PaymentService {
    
    public PaymentResult processPayment(PaymentRequest request) {
        // åªè€ƒè™‘äº†æˆåŠŸæƒ…å†µï¼Œç¼ºå°‘å¼‚å¸¸å¤„ç†
        PaymentResponse response = paymentGateway.pay(request);
        
        if ("SUCCESS".equals(response.getStatus())) {
            return PaymentResult.success(response.getTransactionId());
        }
        
        // âŒ æ²¡æœ‰å¤„ç†å…¶ä»–çŠ¶æ€ï¼šFAILED, PENDING, TIMEOUTç­‰
        return null; // è¿”å›nullæ˜¯å±é™©çš„
    }
}

// âŒ ç¼ºå°‘è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
public class DiscountService {
    
    public BigDecimal calculateDiscount(BigDecimal amount, String userLevel) {
        // âŒ æ²¡æœ‰æ£€æŸ¥amountæ˜¯å¦ä¸ºnullæˆ–è´Ÿæ•°
        // âŒ æ²¡æœ‰æ£€æŸ¥userLevelæ˜¯å¦ä¸ºnullæˆ–æ— æ•ˆå€¼
        
        if ("VIP".equals(userLevel)) {
            return amount.multiply(new BigDecimal("0.8")); // 8æŠ˜
        } else if ("GOLD".equals(userLevel)) {
            return amount.multiply(new BigDecimal("0.9")); // 9æŠ˜
        }
        
        // âŒ æ²¡æœ‰å¤„ç†æœªçŸ¥ç”¨æˆ·ç­‰çº§çš„æƒ…å†µ
        return amount;
    }
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```java
// âœ… å®Œæ•´çš„ä¸šåŠ¡æµç¨‹å¤„ç†
@Service
public class PaymentService {
    
    public PaymentResult processPayment(PaymentRequest request) {
        try {
            // å‚æ•°éªŒè¯
            validatePaymentRequest(request);
            
            // è°ƒç”¨æ”¯ä»˜ç½‘å…³
            PaymentResponse response = paymentGateway.pay(request);
            
            // å¤„ç†æ‰€æœ‰å¯èƒ½çš„å“åº”çŠ¶æ€
            switch (response.getStatus()) {
                case "SUCCESS":
                    recordSuccessfulPayment(request, response);
                    return PaymentResult.success(response.getTransactionId());
                    
                case "FAILED":
                    recordFailedPayment(request, response);
                    return PaymentResult.failed(response.getErrorCode(), response.getErrorMessage());
                    
                case "PENDING":
                    recordPendingPayment(request, response);
                    return PaymentResult.pending(response.getTransactionId());
                    
                case "TIMEOUT":
                    recordTimeoutPayment(request, response);
                    return PaymentResult.timeout("æ”¯ä»˜è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥è¯¢ç»“æœ");
                    
                default:
                    log.warn("æœªçŸ¥çš„æ”¯ä»˜çŠ¶æ€: {}", response.getStatus());
                    return PaymentResult.unknown("æ”¯ä»˜çŠ¶æ€æœªçŸ¥ï¼Œè¯·è”ç³»å®¢æœ");
            }
            
        } catch (PaymentGatewayException e) {
            log.error("æ”¯ä»˜ç½‘å…³å¼‚å¸¸", e);
            return PaymentResult.systemError("æ”¯ä»˜ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨");
        } catch (ValidationException e) {
            log.warn("æ”¯ä»˜å‚æ•°éªŒè¯å¤±è´¥: {}", e.getMessage());
            return PaymentResult.validationError(e.getMessage());
        } catch (Exception e) {
            log.error("æ”¯ä»˜å¤„ç†å¼‚å¸¸", e);
            return PaymentResult.systemError("æ”¯ä»˜å¤„ç†å¤±è´¥");
        }
    }
    
    private void validatePaymentRequest(PaymentRequest request) {
        if (request == null) {
            throw new ValidationException("æ”¯ä»˜è¯·æ±‚ä¸èƒ½ä¸ºç©º");
        }
        if (request.getAmount() == null || request.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            throw new ValidationException("æ”¯ä»˜é‡‘é¢å¿…é¡»å¤§äº0");
        }
        if (StringUtils.isBlank(request.getOrderId())) {
            throw new ValidationException("è®¢å•IDä¸èƒ½ä¸ºç©º");
        }
        // æ›´å¤šéªŒè¯é€»è¾‘...
    }
}

// âœ… å®Œæ•´çš„è¾¹ç•Œæ¡ä»¶å¤„ç†
@Service
public class DiscountService {
    
    private static final Map<String, BigDecimal> DISCOUNT_RATES = Map.of(
        "VIP", new BigDecimal("0.8"),
        "GOLD", new BigDecimal("0.9"),
        "SILVER", new BigDecimal("0.95"),
        "NORMAL", new BigDecimal("1.0")
    );
    
    public BigDecimal calculateDiscount(BigDecimal amount, String userLevel) {
        // å‚æ•°éªŒè¯
        if (amount == null) {
            throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºç©º");
        }
        if (amount.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        if (StringUtils.isBlank(userLevel)) {
            log.warn("ç”¨æˆ·ç­‰çº§ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤ç­‰çº§");
            userLevel = "NORMAL";
        }
        
        // è·å–æŠ˜æ‰£ç‡
        BigDecimal discountRate = DISCOUNT_RATES.get(userLevel.toUpperCase());
        if (discountRate == null) {
            log.warn("æœªçŸ¥çš„ç”¨æˆ·ç­‰çº§: {}ï¼Œä½¿ç”¨é»˜è®¤ç­‰çº§", userLevel);
            discountRate = DISCOUNT_RATES.get("NORMAL");
        }
        
        // è®¡ç®—æŠ˜æ‰£åé‡‘é¢
        BigDecimal discountedAmount = amount.multiply(discountRate);
        
        // ç¡®ä¿æŠ˜æ‰£åé‡‘é¢ä¸ä¸ºè´Ÿæ•°ï¼ˆç†è®ºä¸Šä¸ä¼šï¼Œä½†ä¿é™©èµ·è§ï¼‰
        return discountedAmount.max(BigDecimal.ZERO);
    }
}

// âœ… å¹¶å‘å®‰å…¨çš„ä¸šåŠ¡é€»è¾‘
@Service
public class InventoryService {
    
    @Transactional
    public boolean reserveStock(Long productId, Integer quantity) {
        // ä½¿ç”¨æ‚²è§‚é”é˜²æ­¢å¹¶å‘é—®é¢˜
        Product product = productRepository.findByIdForUpdate(productId)
            .orElseThrow(() -> new ProductNotFoundException(productId));
        
        // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
        if (product.getStock() < quantity) {
            log.warn("åº“å­˜ä¸è¶³: productId={}, éœ€è¦={}, å¯ç”¨={}", 
                productId, quantity, product.getStock());
            return false;
        }
        
        // æ‰£å‡åº“å­˜
        product.setStock(product.getStock() - quantity);
        productRepository.save(product);
        
        // è®°å½•åº“å­˜å˜æ›´æ—¥å¿—
        inventoryLogService.recordStockReservation(productId, quantity);
        
        log.info("åº“å­˜é¢„ç•™æˆåŠŸ: productId={}, quantity={}, å‰©ä½™={}", 
            productId, quantity, product.getStock());
        
        return true;
    }
}
```

#### 4.21.2 å¼‚å¸¸å¤„ç†å®Œæ•´æ€§

**æ£€æŸ¥ç›®æ ‡**ï¼šç¡®ä¿æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸æƒ…å†µéƒ½æœ‰é€‚å½“çš„å¤„ç†æœºåˆ¶

**æ£€æµ‹æ ‡å‡†ï¼š**
- æ‰€æœ‰å¤–éƒ¨è°ƒç”¨éƒ½æœ‰å¼‚å¸¸å¤„ç†
- ä¸šåŠ¡å¼‚å¸¸æœ‰æ˜ç¡®çš„é”™è¯¯ç å’Œæ¶ˆæ¯
- ç³»ç»Ÿå¼‚å¸¸æœ‰é€‚å½“çš„é™çº§ç­–ç•¥
- å¼‚å¸¸ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿæ•°æ®

**æ£€æµ‹æ–¹æ³•**ï¼š
- å¼‚å¸¸è·¯å¾„åˆ†æ
- é”™è¯¯å¤„ç†æµ‹è¯•
- å¼‚å¸¸ä¿¡æ¯å®‰å…¨æ£€æŸ¥
- é™çº§æœºåˆ¶éªŒè¯

**æ­£ç¡®ç¤ºä¾‹**ï¼š
```java
// âœ… å®Œæ•´çš„å¼‚å¸¸å¤„ç†ä½“ç³»
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
        ErrorResponse error = ErrorResponse.builder()
            .code(e.getErrorCode())
            .message(e.getMessage())
            .timestamp(Instant.now())
            .build();
        return ResponseEntity.badRequest().body(error);
    }
    
    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(ValidationException e) {
        log.warn("å‚æ•°éªŒè¯å¤±è´¥: {}", e.getMessage());
        ErrorResponse error = ErrorResponse.builder()
            .code("VALIDATION_ERROR")
            .message("è¯·æ±‚å‚æ•°ä¸æ­£ç¡®")
            .details(e.getFieldErrors())
            .timestamp(Instant.now())
            .build();
        return ResponseEntity.badRequest().body(error);
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGenericException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        ErrorResponse error = ErrorResponse.builder()
            .code("SYSTEM_ERROR")
            .message("ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•")
            .timestamp(Instant.now())
            .build();
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
    }
}

// âœ… å¸¦é™çº§ç­–ç•¥çš„æœåŠ¡è°ƒç”¨
@Service
public class RecommendationService {
    
    @CircuitBreaker(name = "recommendation", fallbackMethod = "getDefaultRecommendations")
    @TimeLimiter(name = "recommendation")
    @Retry(name = "recommendation")
    public List<Product> getRecommendations(Long userId) {
        try {
            return recommendationClient.getRecommendations(userId);
        } catch (Exception e) {
            log.warn("æ¨èæœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é™çº§ç­–ç•¥: userId={}", userId, e);
            return getDefaultRecommendations(userId, e);
        }
    }
    
    // é™çº§æ–¹æ³•
    public List<Product> getDefaultRecommendations(Long userId, Exception ex) {
        log.info("ä½¿ç”¨é»˜è®¤æ¨èç­–ç•¥: userId={}", userId);
        // è¿”å›çƒ­é—¨å•†å“æˆ–ç”¨æˆ·å†å²æµè§ˆå•†å“
        return productService.getPopularProducts(10);
    }
}
```

**æ¨èå·¥å…·**ï¼š
- **ä»£ç è¦†ç›–ç‡**ï¼šJaCoCoã€Coberturaã€SonarQube
- **å¼‚å¸¸ç›‘æ§**ï¼šSentryã€Rollbarã€Bugsnag
- **ç†”æ–­å™¨**ï¼šResilience4jã€Hystrixã€Sentinel
- **æµ‹è¯•å·¥å…·**ï¼šJUnitã€TestNGã€Mockito

## ç¬¬äº”ç«  è€ƒæ ¸ä¸æ”¹è¿›

**ç¬¬ä¸‰åä¸ƒæ¡** ä»£ç å®¡æŸ¥è€ƒæ ¸é‡‡å–æœˆåº¦ç›‘ç£å’Œå­£åº¦è€ƒæ ¸æœºåˆ¶ï¼Œè€ƒæ ¸ç»“æœçº³å…¥ä¸ªäººå’Œå›¢é˜Ÿç»©æ•ˆè€ƒæ ¸ã€‚

**ç¬¬ä¸‰åå…«æ¡** è€ƒæ ¸æŒ‡æ ‡åŒ…æ‹¬ï¼š
ï¼ˆä¸€ï¼‰ä»£ç å®¡æŸ¥åŠæ—¶æ€§ï¼šå®¡æŸ¥å“åº”æ—¶é—´å’Œå®Œæˆæ—¶é—´
ï¼ˆäºŒï¼‰ä»£ç è´¨é‡æŒ‡æ ‡ï¼šCriticalã€Majorã€Minoré—®é¢˜å‘ç°ç‡
ï¼ˆä¸‰ï¼‰é—®é¢˜ä¿®å¤æ•ˆç‡ï¼šé—®é¢˜ä¿®å¤æ—¶é—´å’Œè´¨é‡
ï¼ˆå››ï¼‰å®¡æŸ¥è¦†ç›–ç‡ï¼šä»£ç å®¡æŸ¥è¦†ç›–çš„ä»£ç æ¯”ä¾‹
ï¼ˆäº”ï¼‰çº¿ä¸Šé—®é¢˜å…³è”ï¼šå®¡æŸ¥é€šè¿‡ä»£ç çš„çº¿ä¸Šé—®é¢˜ç‡

**ç¬¬ä¸‰åä¹æ¡** å­˜åœ¨ä»¥ä¸‹è¿è§„è¡Œä¸ºçš„ï¼ŒæŒ‰ä»¥ä¸‹è§„å®šå¤„ç†ï¼š
ï¼ˆä¸€ï¼‰**æœªç»å®¡æŸ¥ç›´æ¥å‘å¸ƒ**ï¼šæœªç»ä»£ç å®¡æŸ¥ç›´æ¥å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒï¼Œå¯¹è´£ä»»äººå¤„ä»¥æœˆåº¦ç»©æ•ˆæ‰£å‡å¤„ç†
ï¼ˆäºŒï¼‰**Criticalé—®é¢˜æœªä¿®å¤å‘å¸ƒ**ï¼šå­˜åœ¨Criticalçº§åˆ«é—®é¢˜æœªä¿®å¤å³å‘å¸ƒï¼Œå¯¹å¼€å‘äººå‘˜å’Œå®¡æŸ¥äººå‘˜å¤„ä»¥æœˆåº¦ç»©æ•ˆæ‰£å‡å¤„ç†
ï¼ˆä¸‰ï¼‰**å®¡æŸ¥æµäºå½¢å¼**ï¼šå®¡æŸ¥äººå‘˜æœªè®¤çœŸæ‰§è¡Œå®¡æŸ¥å·¥ä½œï¼Œå¯¼è‡´æ˜æ˜¾é—®é¢˜é—æ¼ï¼Œå¯¹å®¡æŸ¥äººå‘˜å¤„ä»¥æœˆåº¦ç»©æ•ˆæ‰£å‡å¤„ç†
ï¼ˆå››ï¼‰**æ‹’ç»é…åˆå®¡æŸ¥**ï¼šå¼€å‘äººå‘˜æ‹’ç»é…åˆä»£ç å®¡æŸ¥æˆ–ä¸åŠæ—¶ä¿®å¤é—®é¢˜ï¼Œå¯¹è´£ä»»äººå¤„ä»¥æœˆåº¦ç»©æ•ˆæ‰£å‡å¤„ç†

**ç¬¬å››åæ¡** æŒç»­æ”¹è¿›æœºåˆ¶ï¼š
ï¼ˆä¸€ï¼‰æ¯æœˆå¬å¼€ä»£ç å®¡æŸ¥æ€»ç»“ä¼šè®®ï¼Œåˆ†æé—®é¢˜è¶‹åŠ¿
ï¼ˆäºŒï¼‰æ¯å­£åº¦æ›´æ–°ä»£ç å®¡æŸ¥æ ‡å‡†ï¼Œé€‚åº”æŠ€æœ¯å‘å±•
ï¼ˆä¸‰ï¼‰å»ºç«‹æœ€ä½³å®è·µçŸ¥è¯†åº“ï¼Œä¿ƒè¿›ç»éªŒåˆ†äº«
ï¼ˆå››ï¼‰å®šæœŸç»„ç»‡ä»£ç å®¡æŸ¥åŸ¹è®­ï¼Œæå‡å›¢é˜Ÿèƒ½åŠ›

## ç¬¬å…­ç«  é™„åˆ™

**ç¬¬å››åä¸€æ¡** æœ¬ç®¡ç†åŠæ³•é€‚ç”¨äºå…¬å¸æ‰€æœ‰Javaå¼€å‘å›¢é˜Ÿã€‚

**ç¬¬å››åäºŒæ¡** æœ¬ç®¡ç†åŠæ³•ç»æŠ€æœ¯å§”å‘˜ä¼šæ‰¹å‡†åå‘å¸ƒï¼Œè‡ªå‘å¸ƒä¹‹æ—¥èµ·æ–½è¡Œã€‚

**ç¬¬å››åä¸‰æ¡** æœ¬ç®¡ç†åŠæ³•ç”±è´¨é‡ç®¡ç†éƒ¨è´Ÿè´£è§£é‡Šå’Œä¿®è®¢ã€‚

**ç¬¬å››åå››æ¡** å„é¡¹ç›®å›¢é˜Ÿå¯æ ¹æ®é¡¹ç›®ç‰¹ç‚¹ï¼Œåœ¨ä¸è¿èƒŒæœ¬åŠæ³•åŸºæœ¬åŸåˆ™çš„å‰æä¸‹ï¼Œåˆ¶å®šæ›´å…·ä½“çš„å®æ–½ç»†åˆ™ã€‚

---

## é™„å½•ï¼šä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•

### Criticalçº§åˆ«æ£€æŸ¥é¡¹ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
- [ ] çº¿ç¨‹æ± é…ç½®åˆç†ï¼Œé¿å…æ— ç•Œçº¿ç¨‹æ± 
- [ ] å…±äº«å˜é‡çº¿ç¨‹å®‰å…¨
- [ ] è¿æ¥æ± é…ç½®å’Œè¶…æ—¶è®¾ç½®
- [ ] èµ„æºæ­£ç¡®é‡Šæ”¾
- [ ] å¼‚å¸¸å¤„ç†æœºåˆ¶å®Œå–„
- [ ] è¾“å…¥éªŒè¯å’Œå®‰å…¨æ£€æŸ¥
- [ ] æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- [ ] ç†”æ–­å™¨å’Œå®¹é”™æœºåˆ¶
- [ ] ç¯å¢ƒé…ç½®éš”ç¦»

### Majorçº§åˆ«æ£€æŸ¥é¡¹ï¼ˆå»ºè®®ä¿®å¤ï¼‰
- [ ] ä»£ç ç»“æ„å’ŒèŒè´£åˆ†ç¦»
- [ ] é”çš„æ­£ç¡®ä½¿ç”¨
- [ ] æ•°æ®åº“æ“ä½œä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥åˆç†
- [ ] å†…å­˜ç®¡ç†ä¼˜åŒ–
- [ ] æ—¥å¿—å’Œç›‘æ§é›†æˆ
- [ ] é‡è¯•å’Œé™æµæœºåˆ¶
- [ ] RESTful APIè®¾è®¡
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] å®¹å™¨åŒ–æœ€ä½³å®è·µ

### Minorçº§åˆ«æ£€æŸ¥é¡¹ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
- [ ] å‘½åè§„èŒƒ
- [ ] ä»£ç é£æ ¼ä¸€è‡´æ€§
- [ ] æ–‡æ¡£å®Œæ•´æ€§
- [ ] æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚

---

## æŠ€æœ¯æ ‡å‡†ç¤ºä¾‹

### å‘½åè§„èŒƒç¤ºä¾‹

```java
// âœ… æ­£ç¡®ç¤ºä¾‹
public class UserService {
    private static final String DEFAULT_ENCODING = "UTF-8";
    private final UserRepository userRepository;
    
    public User findUserById(Long userId) {
        return userRepository.findById(userId);
    }
}

// âŒ é”™è¯¯ç¤ºä¾‹
public class userservice {
    private static final String default_encoding = "UTF-8";
    private final UserRepository UserRepository;
    
    public User FindUserById(Long user_id) {
        return UserRepository.findById(user_id);
    }
}
```

### çº¿ç¨‹æ± é…ç½®ç¤ºä¾‹

```java
// âœ… æ­£ç¡®çš„çº¿ç¨‹æ± é…ç½®
@Configuration
public class ThreadPoolConfig {
    @Bean
    public ThreadPoolTaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);                    // æ ¸å¿ƒçº¿ç¨‹æ•°
        executor.setMaxPoolSize(20);                     // æœ€å¤§çº¿ç¨‹æ•°
        executor.setQueueCapacity(200);                  // é˜Ÿåˆ—å®¹é‡
        executor.setKeepAliveSeconds(60);                // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
        executor.setThreadNamePrefix("async-task-");     // çº¿ç¨‹åå‰ç¼€
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}

// âŒ é”™è¯¯ç¤ºä¾‹
Executors.newCachedThreadPool(); // æ— ç•Œçº¿ç¨‹æ± ï¼Œå¯èƒ½å¯¼è‡´OOM
```

### çº¿ç¨‹å®‰å…¨ç¤ºä¾‹

```java
// âŒ çº¿ç¨‹ä¸å®‰å…¨
@Service
public class CounterService {
    private int count = 0; // å…±äº«å¯å˜çŠ¶æ€
    
    public void increment() {
        count++; // éåŸå­æ“ä½œ
    }
}

// âœ… çº¿ç¨‹å®‰å…¨
@Service
public class CounterService {
    private final AtomicInteger count = new AtomicInteger(0);
    
    public void increment() {
        count.incrementAndGet();
    }
}
```

### è¿æ¥æ± é…ç½®ç¤ºä¾‹

```java
// âœ… æ•°æ®åº“è¿æ¥æ± é…ç½®
@Configuration
public class DataSourceConfig {
    @Bean
    @ConfigurationProperties("spring.datasource.hikari")
    public HikariDataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setMaximumPoolSize(20);              // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);                   // æœ€å°ç©ºé—²è¿æ¥æ•°
        config.setConnectionTimeout(30000);         // è¿æ¥è¶…æ—¶30ç§’
        config.setIdleTimeout(600000);              // ç©ºé—²è¶…æ—¶10åˆ†é’Ÿ
        config.setMaxLifetime(1800000);             // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ30åˆ†é’Ÿ
        config.setLeakDetectionThreshold(60000);    // è¿æ¥æ³„æ¼æ£€æµ‹é˜ˆå€¼1åˆ†é’Ÿ
        return new HikariDataSource(config);
    }
}
```

### è¶…æ—¶é…ç½®ç¤ºä¾‹

```java
// âœ… HTTPå®¢æˆ·ç«¯è¶…æ—¶é…ç½®
@Configuration
public class HttpClientConfig {
    @Bean
    public RestTemplate restTemplate() {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(5000);    // è¿æ¥è¶…æ—¶5ç§’
        factory.setReadTimeout(10000);      // è¯»å–è¶…æ—¶10ç§’
        return new RestTemplate(factory);
    }
}
```

### èµ„æºé‡Šæ”¾ç¤ºä¾‹

```java
// âœ… æ­£ç¡®çš„èµ„æºç®¡ç†
public void processFile(String fileName) {
    try (FileInputStream fis = new FileInputStream(fileName);
         BufferedReader reader = new BufferedReader(new InputStreamReader(fis))) {
        // å¤„ç†æ–‡ä»¶
        String line;
        while ((line = reader.readLine()) != null) {
            // å¤„ç†æ¯ä¸€è¡Œ
        }
    } catch (IOException e) {
        log.error("æ–‡ä»¶å¤„ç†å¤±è´¥: {}", fileName, e);
        throw new FileProcessException("æ–‡ä»¶å¤„ç†å¤±è´¥", e);
    }
}
```

### å¼‚å¸¸å¤„ç†ç¤ºä¾‹

```java
// âœ… è‰¯å¥½çš„å¼‚å¸¸è®¾è®¡
public class BusinessException extends RuntimeException {
    private final String errorCode;
    private final Object[] args;
    
    public BusinessException(String errorCode, String message, Object... args) {
        super(message);
        this.errorCode = errorCode;
        this.args = args;
    }
}

// âœ… å…¨å±€å¼‚å¸¸å¤„ç†
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
        ErrorResponse error = new ErrorResponse(e.getErrorCode(), e.getMessage());
        return ResponseEntity.badRequest().body(error);
    }
}
```

### å®‰å…¨æ£€æŸ¥ç¤ºä¾‹

```java
// âœ… è¾“å…¥éªŒè¯
public class CreateUserRequest {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 20, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;
    
    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
}

// âœ… æƒé™æ§åˆ¶
@RestController
@RequestMapping("/api/admin")
@PreAuthorize("hasRole('ADMIN')")
public class AdminController {
    
    @GetMapping("/users")
    @PreAuthorize("hasAuthority('USER_READ')")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
}
```

### ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹

```java
// âœ… ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹
@Service
public class UserService {
    
    @Cacheable(value = "users", key = "#id")
    public User findById(Long id) {
        return userRepository.findById(id)
            .orElseThrow(() -> new UserNotFoundException("User not found: " + id));
    }
    
    @CacheEvict(value = "users", key = "#user.id")
    public User updateUser(User user) {
        return userRepository.save(user);
    }
}
```

### å†…å­˜ç®¡ç†ç¤ºä¾‹

```java
// âœ… ä½¿ç”¨æœ‰ç•Œé›†åˆ
public class EventListener {
    private final Queue<String> events = new LinkedBlockingQueue<>(1000); // æœ‰ç•Œé˜Ÿåˆ—
    
    public void addEvent(String event) {
        if (!events.offer(event)) {
            events.poll(); // ç§»é™¤æœ€è€çš„äº‹ä»¶
            events.offer(event);
        }
    }
}
```

### é…ç½®å¤–éƒ¨åŒ–ç¤ºä¾‹

```yaml
# âœ… æ­£ç¡®çš„é…ç½®å¤–éƒ¨åŒ–
app:
  database:
    url: ${DB_URL:jdbc:mysql://localhost:3306/mydb}
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:}
  external-service:
    url: ${EXTERNAL_SERVICE_URL:http://localhost:8080}
    timeout: ${EXTERNAL_SERVICE_TIMEOUT:5000}
```

### RESTful APIè®¾è®¡ç¤ºä¾‹

```java
// âœ… RESTful APIè®¾è®¡
@RestController
@RequestMapping("/api/v1/users")
public class UserController {
    
    @GetMapping
    public ResponseEntity<PagedResponse<User>> getUsers(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        Page<User> users = userService.findAll(PageRequest.of(page, size));
        return ResponseEntity.ok(new PagedResponse<>(users));
    }
    
    @PostMapping
    public ResponseEntity<User> createUser(@Valid @RequestBody CreateUserRequest request) {
        User user = userService.createUser(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(user);
    }
}
```

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```java
// âœ… è‰¯å¥½çš„å•å…ƒæµ‹è¯•
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void shouldReturnUserWhenFound() {
        // Given
        Long userId = 1L;
        User expectedUser = new User(userId, "John", "john@example.com");
        when(userRepository.findById(userId)).thenReturn(Optional.of(expectedUser));
        
        // When
        User actualUser = userService.findById(userId);
        
        // Then
        assertThat(actualUser).isEqualTo(expectedUser);
        verify(userRepository).findById(userId);
    }
}
```

### å®¹å™¨åŒ–ç¤ºä¾‹

```dockerfile
# âœ… è‰¯å¥½çš„Dockerfile
FROM openjdk:17-jre-slim

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY target/app.jar app.jar

# æ›´æ”¹æ–‡ä»¶æ‰€æœ‰è€…
RUN chown appuser:appuser app.jar

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", "-jar", "app.jar"]
```

---

## æ£€æŸ¥æ¸…å•æ€»ç»“

### Criticalçº§åˆ«æ£€æŸ¥é¡¹ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
- [ ] çº¿ç¨‹æ± é…ç½®åˆç†ï¼Œé¿å…æ— ç•Œçº¿ç¨‹æ± 
- [ ] å…±äº«å˜é‡çº¿ç¨‹å®‰å…¨
- [ ] è¿æ¥æ± é…ç½®å’Œè¶…æ—¶è®¾ç½®
- [ ] èµ„æºæ­£ç¡®é‡Šæ”¾
- [ ] å¼‚å¸¸å¤„ç†æœºåˆ¶å®Œå–„
- [ ] è¾“å…¥éªŒè¯å’Œå®‰å…¨æ£€æŸ¥
- [ ] æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- [ ] ç†”æ–­å™¨å’Œå®¹é”™æœºåˆ¶
- [ ] ç¯å¢ƒé…ç½®éš”ç¦»
- [ ] ä¼˜é›…å…³é—­æœºåˆ¶

### Majorçº§åˆ«æ£€æŸ¥é¡¹ï¼ˆå»ºè®®ä¿®å¤ï¼‰
- [ ] ä»£ç ç»“æ„å’ŒèŒè´£åˆ†ç¦»
- [ ] é”çš„æ­£ç¡®ä½¿ç”¨
- [ ] æ•°æ®åº“æ“ä½œä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥åˆç†
- [ ] å†…å­˜ç®¡ç†ä¼˜åŒ–
- [ ] æ—¥å¿—å’Œç›‘æ§é›†æˆ
- [ ] é‡è¯•å’Œé™æµæœºåˆ¶
- [ ] é…ç½®å¤–éƒ¨åŒ–
- [ ] RESTful APIè®¾è®¡
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- [ ] å®¹å™¨åŒ–æœ€ä½³å®è·µ

### Minorçº§åˆ«æ£€æŸ¥é¡¹ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
- [ ] å‘½åè§„èŒƒ
- [ ] ä»£ç é£æ ¼ä¸€è‡´æ€§
- [ ] æ–‡æ¡£å®Œæ•´æ€§
- [ ] æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚

---

## å‚è€ƒèµ„æº

- [Oracle Javaç¼–ç è§„èŒƒ](https://www.oracle.com/java/technologies/javase/codeconventions-contents.html)
- [Spring Bootæœ€ä½³å®è·µ](https://spring.io/guides)
- [å¾®æœåŠ¡è®¾è®¡æ¨¡å¼](https://microservices.io/patterns/)
- [Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜](https://jcip.net/)
- [Effective Java](https://www.oreilly.com/library/view/effective-java-3rd/9780134686097/)

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”å®šæœŸæ›´æ–°ï¼Œåæ˜ æœ€æ–°çš„æŠ€æœ¯æ ˆå’Œæœ€ä½³å®è·µã€‚å»ºè®®æ¯å­£åº¦è¿›è¡Œä¸€æ¬¡å®¡æŸ¥å’Œæ›´æ–°ã€‚